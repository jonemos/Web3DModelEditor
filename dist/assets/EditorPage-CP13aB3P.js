const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/editor-wWXi1HIm.js","assets/react-vendor-BqTC8Pos.js","assets/three-CPLCFrMS.js","assets/three-stdlib-CLJV8NWX.js","assets/state-CIc2iLdp.js","assets/editor-CgyRVMAb.css"])))=>i.map(i=>d[i]);
import{u as e,a as t,M as a,P as n,V as r,E as s,_ as i,i as o}from"./editor-wWXi1HIm.js";import{r as l,j as c}from"./react-vendor-BqTC8Pos.js";import{C as d,Z as u,e as p,j as m,V as g,Q as f}from"./three-CPLCFrMS.js";import{u as v}from"./router-B4rd2QAw.js";import"./three-stdlib-CLJV8NWX.js";import"./state-CIc2iLdp.js";let w=null;async function b(){if(!w){const e=await i(()=>import("./editor-wWXi1HIm.js").then(e=>e.G),__vite__mapDeps([0,1,2,3,4,5]));w=e.getGLBMeshManager()}return w}const y="새 맵을 만들면 현재 작업이 사라집니다. 계속하시겠습니까?",h="익스포트 기능은 준비 중입니다.",S="에디터를 종료하시겠습니까?",j="실행 취소 기능은 준비 중입니다.",x="다시 실행 기능은 준비 중입니다.",O="전체 선택 기능은 준비 중입니다.",E="선택 해제 기능은 준비 중입니다.",M="뷰포트 리셋 기능은 준비 중입니다.",k="카메라 리셋: 키패드 0번을 누르세요.",C="통계 표시 기능은 준비 중입니다.",A="단축키 정보:\nW/E/R: 기즈모 모드\nF: 오브젝트 포커스\nESC: 선택 해제\n키패드 0: 카메라 리셋\n키패드 5: 카메라 모드 토글\n키패드 1/3/7/9: 뷰 변경",D="도움말:\n• 좌클릭: 오브젝트 선택\n• Shift+좌클릭: 다중 선택\n• 중간클릭: 팬 이동\n• Alt+중간클릭: 카메라 회전\n• 마우스 휠: 줌",P="ThirdPersonTreeJS Editor\nVersion 1.0.0\n3D 에디터 프로그램";function R(){const i=v(),{clearMap:w,saveMap:R,loadMap:_,addObject:L,setSelectedObject:z,addCustomMesh:I,selectedObject:G,selectedIds:T,toggleGridVisible:$,scene:N,hdriSettings:W,sunLightRef:F,setSunLightRef:V,saveHDRISettings:q,objects:B,setSelectedIds:H,setParent:K,reorderSiblings:U,copyObject:Z,pasteObject:J,deleteSelectedObject:Q,hasClipboardData:X}=e(),[Y,ee]=l.useState(null),[te,ae]=l.useState([]),[ne,re]=l.useState(!1),[se,ie]=l.useState(""),[oe,le]=l.useState(""),{showToast:ce}=t(),[de,ue]=l.useState(!0),pe=l.useRef(null),[me,ge]=l.useState(null),fe=l.useRef(null),ve=l.useRef(null),we=l.useRef(new Set);l.useEffect(()=>{let t=!1;return(async()=>{try{ve.current||(ve.current=await b());const a=await ve.current.getCustomMeshes();if(!t&&0===(e.getState().customMeshes||[]).length){const t=a.map(e=>"string"==typeof e.thumbnail&&e.thumbnail.startsWith("blob:")?e.thumbnail:null).filter(Boolean);we.current=new Set(t),e.getState().loadCustomMeshes(a)}}catch{}})(),()=>{t=!0;for(const e of we.current)try{URL.revokeObjectURL(e)}catch{}we.current.clear()}},[]),l.useEffect(()=>{N&&W.sunLightEnabled&&!F?be():N&&!W.sunLightEnabled&&F&&ye()},[N,W.sunLightEnabled,F]),l.useEffect(()=>{if(!N||!F||!W.sunLightEnabled)return;if(!(()=>{let e=!1;return N.traverse(t=>{t===F&&(e=!0)}),e})())try{N.add(F)}catch{}},[N,F,W.sunLightEnabled]),l.useEffect(()=>{N&&W.currentHDRI&&"none"===W.currentHDRI.type&&(N.background=new d(2763306),N.environment=null)},[N,W.currentHDRI]),l.useEffect(()=>{const e=e=>{if(null==e?void 0:e.defaultPrevented)return;const t=null==e?void 0:e.target,a=null==t?void 0:t.tagName;if("INPUT"!==a&&"TEXTAREA"!==a&&"SELECT"!==a&&!(null==t?void 0:t.isContentEditable)&&!(null==e?void 0:e.repeat)){if("i"!==e.key&&"I"!==e.key||e.ctrlKey||e.altKey||e.shiftKey||(e.preventDefault(),ue(e=>!e)),e.ctrlKey&&("c"===e.key||"C"===e.key)){if(e.preventDefault(),!G)return void ce("복사할 객체를 먼저 선택해주세요","warning",2e3);requestAnimationFrame(()=>{var e;try{let t=null;if(pe.current){const a=G.id||G;t=pe.current.findObjectById(a)||(null==(e=pe.current.selectedObjects)?void 0:e[0])||null}t?(Z(t),ce(`"${t.name}"이(가) 복사되었습니다`,"success",2e3)):(Z(G),ce(`"${G.name}"이(가) 복사되었습니다`,"success",2e3))}finally{}})}!e.ctrlKey||"v"!==e.key&&"V"!==e.key||(e.preventDefault(),requestAnimationFrame(()=>{try{if(X()){const e=J();e?ce(`"${e.name}"이(가) 붙여넣기되었습니다`,"success",2e3):ce("붙여넣기에 실패했습니다","error",2e3)}else ce("붙여넣을 객체가 클립보드에 없습니다","warning",2e3)}finally{}}))}};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[G,B,Z,J,Q,X,ce]);const be=()=>{if(!N)return;const e=new u(W.sunColor,W.sunIntensity),t=W.sunAzimuth*Math.PI/180,a=W.sunElevation*Math.PI/180,n=Math.sin(t)*Math.cos(a)*100,r=100*Math.sin(a),s=Math.cos(t)*Math.cos(a)*100;e.position.set(n,r,s),e.lookAt(0,0,0),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=500,e.shadow.camera.left=-50,e.shadow.camera.right=50,e.shadow.camera.top=50,e.shadow.camera.bottom=-50,e.name="sunLight",e.userData=e.userData||{},e.userData.isSystemObject=!0,V(e),N.add(e)},ye=()=>{N&&F&&(N.remove(F),F.dispose&&F.dispose(),V(null))};l.useEffect(()=>{N&&setTimeout(()=>q(),100)},[W,N,q]);const he=t=>{var a,n,r,s,i;if(t&&"object"==typeof t)try{const o=pe.current,l=window.__blenderControls;if(t.camera){const e=(null==(a=null==o?void 0:o.getCamera)?void 0:a.call(o))||(null==l?void 0:l.camera);e&&(Array.isArray(t.camera.position)&&e.position.fromArray(t.camera.position),Array.isArray(t.camera.up)&&e.up.fromArray(t.camera.up),"number"==typeof t.camera.fov&&(e.fov=t.camera.fov),"number"==typeof t.camera.near&&(e.near=t.camera.near),"number"==typeof t.camera.far&&(e.far=t.camera.far),null==(n=e.updateProjectionMatrix)||n.call(e),l&&Array.isArray(t.camera.target)?l.target.fromArray(t.camera.target):o&&Array.isArray(t.camera.target)&&(null==(r=o.setCameraTarget)||r.call(o,(new g).fromArray(t.camera.target))))}if(t.viewOptions){const a=e.getState();if("boolean"==typeof t.viewOptions.isWireframe&&a.isWireframe!==t.viewOptions.isWireframe&&e.getState().toggleWireframe(),"boolean"==typeof t.viewOptions.isGridSnap&&a.isGridSnap!==t.viewOptions.isGridSnap&&e.getState().toggleGridSnap(),"boolean"==typeof t.viewOptions.isGridVisible&&a.isGridVisible!==t.viewOptions.isGridVisible&&e.getState().toggleGridVisible(),t.viewOptions.gizmoSpace&&a.gizmoSpace!==t.viewOptions.gizmoSpace&&e.getState().toggleGizmoSpace(),Number.isFinite(t.viewOptions.gizmoSize)&&e.getState().setGizmoSize(t.viewOptions.gizmoSize),Number.isFinite(t.viewOptions.snapMove)&&e.getState().setSnapMove(t.viewOptions.snapMove),Number.isFinite(t.viewOptions.snapRotateDeg)&&e.getState().setSnapRotateDeg(t.viewOptions.snapRotateDeg),Number.isFinite(t.viewOptions.snapScale)&&e.getState().setSnapScale(t.viewOptions.snapScale),Number.isFinite(t.viewOptions.cameraPanSpeed)&&e.getState().setCameraPanSpeed(t.viewOptions.cameraPanSpeed),Number.isFinite(t.viewOptions.cameraOrbitSpeed)&&e.getState().setCameraOrbitSpeed(t.viewOptions.cameraOrbitSpeed),Number.isFinite(t.viewOptions.cameraZoomSpeed)&&e.getState().setCameraZoomSpeed(t.viewOptions.cameraZoomSpeed),"boolean"==typeof t.viewOptions.isPostProcessingEnabled){e.getState().isPostProcessingEnabled!==t.viewOptions.isPostProcessingEnabled&&e.getState().togglePostProcessingEnabled()}null==(s=null==o?void 0:o.applyInitialViewState)||s.call(o),l&&(null==(i=l.update)||i.call(l))}}catch{}},Se=async()=>{var t,a,n,r;if("save"===Y&&oe.trim()){const t=(()=>{var t,a,n,r;const s={};try{const i=pe.current,o=window.__blenderControls,l=(null==(t=null==i?void 0:i.getCamera)?void 0:t.call(i))||(null==o?void 0:o.camera);l&&(s.camera={position:l.position?l.position.toArray():null,target:o&&o.target?o.target.toArray():(null==(r=null==(n=null==(a=null==i?void 0:i.getCameraTarget)?void 0:a.call(i))?void 0:n.toArray)?void 0:r.call(n))||[0,0,0],up:l.up?l.up.toArray():null,fov:l.fov,near:l.near,far:l.far});const c=e.getState();s.viewOptions={isWireframe:c.isWireframe,isGridSnap:c.isGridSnap,isGridVisible:c.isGridVisible,gizmoSpace:c.gizmoSpace,gizmoSize:c.gizmoSize,snapMove:c.snapMove,snapRotateDeg:c.snapRotateDeg,snapScale:c.snapScale,cameraPanSpeed:c.cameraPanSpeed,cameraOrbitSpeed:c.cameraOrbitSpeed,cameraZoomSpeed:c.cameraZoomSpeed,isPostProcessingEnabled:c.isPostProcessingEnabled}}catch{}return s})();await R(oe.trim(),t),alert(`맵이 "${oe.trim()}"으로 저장되었습니다.`)}else if("load"===Y&&oe.trim()){if(await(null==(a=(t=e.getState()).loadMap)?void 0:a.call(t,oe.trim()))){try{const t=await(null==(r=(n=e.getState()).getMapData)?void 0:r.call(n,oe.trim()));t&&t.viewState&&he(t.viewState)}catch{}try{window.__requestRender&&window.__requestRender()}catch{}alert(`맵 "${oe.trim()}"을 불러왔습니다.`)}else alert(`맵 "${oe.trim()}"을 찾을 수 없습니다.`)}ee(null),le("")},je=()=>{ee(null),le("")},xe=async()=>{var t,a;try{re(!0);const n=await(null==(a=(t=e.getState()).listMaps)?void 0:a.call(t));ae(Array.isArray(n)?n:[])}catch{ae([])}finally{re(!1)}};l.useEffect(()=>{"load"===Y&&xe()},[Y]);l.useEffect(()=>{const e=e=>{const t=(null==e?void 0:e.detail)||{};"customMeshMissing"===(null==t?void 0:t.type)&&ce(`일부 커스텀 메쉬를 찾지 못했습니다. (id=${t.id})`,"warning",2500)};return window.addEventListener("mapLoadWarning",e),()=>window.removeEventListener("mapLoadWarning",e)},[]);return c.jsxs("div",{className:"editor-page",children:[c.jsx(a,{onMenuAction:t=>{var a,n,r,s;switch(t){case"new-map":if(confirm(y)){w();try{null==(n=null==(a=pe.current)?void 0:a.resetCamera)||n.call(a)}catch{}try{window.__blenderControls&&(window.__blenderControls.target.set(0,0,0),null==(s=(r=window.__blenderControls).update)||s.call(r))}catch{}}break;case"load-map":ee("load");break;case"save-map":ee("save");break;case"import":(()=>{const e=document.createElement("input");e.type="file",e.accept=".glb,.gltf",e.multiple=!1,e.onchange=e=>{const t=e.target.files[0];if(!t)return;const a=URL.createObjectURL(t),n=t.name.replace(/\.[^/.]+$/,""),r={id:Date.now(),type:"glb",file:a,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:n};L(r),setTimeout(()=>{z(r.id)},100)},e.click()})();break;case"export":alert(h);break;case"exit":confirm(S)&&i("/");break;case"undo":alert(j);break;case"redo":alert(x);break;case"copy":if(G){const e=B.find(e=>e.id===G);e?(Z(e),ce(`"${e.name}"이(가) 복사되었습니다`,"success",2e3)):ce("복사할 객체를 찾을 수 없습니다","error",2e3)}else ce("복사할 객체를 먼저 선택해주세요","warning",2e3);break;case"paste":if(X()){const e=J();e?ce(`"${e.name}"이(가) 붙여넣기되었습니다`,"success",2e3):ce("붙여넣기에 실패했습니다","error",2e3)}else ce("붙여넣을 객체가 클립보드에 없습니다","warning",2e3);break;case"delete":if(G){const e=B.find(e=>e.id===G);if(e){const t=e.name;Q(),ce(`"${t}"이(가) 삭제되었습니다`,"success",2e3)}else ce("삭제할 객체를 찾을 수 없습니다","error",2e3)}else ce("삭제할 객체를 먼저 선택해주세요","warning",2e3);break;case"select-all":alert(O);break;case"deselect-all":alert(E);break;case"reset-viewport":alert(M);break;case"reset-camera":alert(k);break;case"toggle-grid":$();const t=e.getState().isGridVisible;pe.current&&pe.current.toggleGrid(),ce(`그리드가 ${t?"표시":"숨김"} 되었습니다`,"info",2e3);break;case"toggle-stats":alert(C);break;case"toggle-inspector":ue(e=>!e),ce(`인스펙터가 ${de?"숨김":"표시"} 되었습니다`,"info",2e3);break;case"fullscreen":document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();break;case"show-shortcuts":alert(A);break;case"show-help":alert(D);break;case"about":alert(P)}}}),c.jsxs("div",{className:"editor-container",children:[c.jsx(n,{onEditorControlsReady:e=>{pe.current=e,ge(e)},onPostProcessingReady:e=>{fe.current=e},onContextMenu:e=>{const t=new CustomEvent("editorContextMenu",{detail:{originalEvent:e}});window.dispatchEvent(t)}}),c.jsx(r,{editorControls:me}),c.jsx(s,{editorControls:me,postProcessingManager:fe.current,onAddToLibrary:async t=>{var a,n,r,s,i;try{ve.current||(ve.current=await b());const l=prompt("메쉬 이름을 입력하세요:",t.name||"커스텀 메쉬");if(!l)return;const c=!0;ce("라이브러리에 추가 중...","info",1500);const d=pe.current;let u=null;const v=(null==d?void 0:d.selectedObjects)&&d.selectedObjects.length>0?[...d.selectedObjects]:[];if(v.length>1){const e=new p;e.name=l,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1),e.updateMatrixWorld(!0),v.forEach(t=>{try{t.updateMatrixWorld(!0);const a=t.clone(!0),n=(new m).copy(t.matrixWorld),r=new g,s=new f,i=new g(1,1,1);n.decompose(r,s,i),a.position.copy(r),a.quaternion.copy(s),a.scale.copy(i),a.updateMatrix(),a.updateMatrixWorld(!0),e.add(a)}catch{}}),e.updateMatrixWorld(!0),u=e}else{const e=t&&"object"==typeof t&&null!=(r=null!=(n=t.id)?n:null==(a=t.userData)?void 0:a.ownerId)?r:t;u=t&&"object"==typeof t&&t.isObject3D?t:d&&((null==(s=d.findObjectById)?void 0:s.call(d,e))||(null==(i=d.selectedObjects)?void 0:i[0]))||null}if(!u)return void ce("내보낼 Three.js 객체를 찾지 못했습니다.","error",4e3);const w=await ve.current.addCustomMesh(u,l,{preserveTransform:c,compressToSingleMesh:!0});try{ve.current.downloadCustomMesh(w)}catch{}if((e.getState().customMeshes||[]).some(e=>e.id===w.id)){if(!confirm("동일 ID의 커스텀 메쉬가 이미 있습니다.\n\n- 기존 항목을 덮어쓸까요?"))return void ce("추가가 취소되었습니다(중복 ID).","warning",2500);await o(w);const t=(e.getState().customMeshes||[]).map(e=>e.id===w.id?w:e);e.getState().loadCustomMeshes(t)}else await I(w);window.dispatchEvent(new CustomEvent("customMeshAdded",{detail:w})),ce(`"${l}" GLB가 내보내지고 라이브러리에 추가되었습니다! (그룹 피벗 항등/자식 월드 변환 유지)`,"success",5e3)}catch(l){const e=l&&"NO_MESH_FOUND"===l.message?"선택한 오브젝트에서 내보낼 메시를 찾지 못했습니다. (스키닝/인스턴스/비메시 제외)":"라이브러리 추가에 실패했습니다.";ce(e,"error",5e3)}},showInspector:de,onToggleInspector:ue})]}),Y&&c.jsx("div",{className:"dialog-overlay",children:c.jsxs("div",{className:"dialog",children:[c.jsx("h3",{children:"save"===Y?"맵 저장":"맵 불러오기"}),c.jsx("input",{type:"text",value:oe,onChange:e=>le(e.target.value),placeholder:"맵 이름을 입력하세요",autoFocus:!0,onKeyDown:e=>{"Enter"===e.key&&Se(),"Escape"===e.key&&je()}}),c.jsxs("div",{className:"dialog-buttons",children:[c.jsx("button",{type:"button",onClick:Se,disabled:!!se,children:"확인"}),c.jsx("button",{type:"button",onClick:je,disabled:!!se,children:"취소"})]}),"load"===Y&&c.jsxs("div",{style:{marginTop:12,maxHeight:260,overflow:"auto",borderTop:"1px solid #444",paddingTop:10},children:[c.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[c.jsx("strong",{children:"저장된 맵 목록"}),c.jsx("button",{onClick:xe,disabled:ne,style:{padding:"4px 8px"},children:ne?"새로고침…":"새로고침"})]}),0===te.length&&c.jsx("div",{style:{opacity:.7},children:"저장된 맵이 없습니다."}),te.map(t=>c.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0",borderBottom:"1px solid #333"},children:[c.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[c.jsx("span",{style:{fontWeight:600},children:t.name}),c.jsxs("span",{style:{fontSize:12,opacity:.8},children:["업데이트: ",t.updated_at?new Date(t.updated_at).toLocaleString():"-"]})]}),c.jsxs("div",{style:{display:"flex",gap:6},children:[c.jsx("button",{type:"button",onClick:()=>(async t=>{var a,n,r,s;if(t)try{if(ie(t),ce(`"${t}" 불러오는 중…`,"info",1800),await(null==(n=(a=e.getState()).loadMap)?void 0:n.call(a,t))){try{const a=await(null==(s=(r=e.getState()).getMapData)?void 0:s.call(r,t));(null==a?void 0:a.viewState)&&he(a.viewState)}catch{}try{window.__requestRender&&window.__requestRender()}catch{}ee(null),le(""),ce(`맵 "${t}"을 불러왔습니다.`,"success",1800)}else ce(`맵 "${t}"을 찾을 수 없습니다.`,"error",1800)}catch(i){ce("불러오기 중 오류가 발생했습니다.","error",1800)}finally{ie("")}})(t.name),disabled:!!se,style:{padding:"4px 8px"},children:se===t.name?"불러오는 중…":"불러오기"}),c.jsx("button",{type:"button",onClick:()=>(async t=>{var a,n;if(!t)return;if(!window.confirm(`정말 "${t}" 맵을 삭제하시겠습니까?`))return;await(null==(n=(a=e.getState()).deleteMap)?void 0:n.call(a,t))?(await xe(),ce(`맵 "${t}"이(가) 삭제되었습니다.`,"success",1500)):ce("삭제에 실패했습니다.","error",1500)})(t.name),disabled:!!se,style:{padding:"4px 8px",background:"#a33",color:"#fff"},children:"삭제"})]})]},t.name))]})]})})]})}export{R as default};
