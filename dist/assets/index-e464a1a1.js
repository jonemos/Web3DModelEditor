import{r as e,a as t,b as s}from"./react-vendor-51280515.js";import{u as n,B as i,R as r,a as o}from"./router-8c6fd0ae.js";import{S as a,C as c,P as l,W as h,a as d,A as u,D as m,b as p,M as g,c as f,B as b,d as y,T as v,e as w,f as x,L as S,g as j,F as E,h as O,i as A,j as M,k as T,l as R,m as C,V as _,n as N,o as D,I,p as L,O as P,q as k,r as B,s as H,t as z,u as F,v as U,R as G,N as V,w as X,x as K,y as Y,z as W,E as Z,G as Q,H as q,J as $,K as J,Q as ee,U as te,X as se,Y as ne,Z as ie,_ as re,$ as oe,a0 as ae,a1 as ce,a2 as le,a3 as he,a4 as de,a5 as ue,a6 as me,a7 as pe,a8 as ge,a9 as fe,aa as be,ab as ye,ac as ve,ad as we,ae as xe,af as Se,ag as je,ah as Ee,ai as Oe,aj as Ae,ak as Me,al as Te,am as Re,an as Ce,ao as _e,ap as Ne,aq as De,ar as Ie,as as Le,at as Pe,au as ke,av as Be}from"./three-df80fafc.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var He={exports:{}},ze={},Fe=e,Ue=Symbol.for("react.element"),Ge=Symbol.for("react.fragment"),Ve=Object.prototype.hasOwnProperty,Xe=Fe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ke={key:!0,ref:!0,__self:!0,__source:!0};function Ye(e,t,s){var n,i={},r=null,o=null;for(n in void 0!==s&&(r=""+s),void 0!==t.key&&(r=""+t.key),void 0!==t.ref&&(o=t.ref),t)Ve.call(t,n)&&!Ke.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:Ue,type:e,key:r,ref:o,props:i,_owner:Xe.current}}ze.Fragment=Ge,ze.jsx=Ye,ze.jsxs=Ye,He.exports=ze;var We=He.exports,Ze={},Qe=t;Ze.createRoot=Qe.createRoot,Ze.hydrateRoot=Qe.hydrateRoot;function qe(){const t=n(),[s,i]=e.useState(null),[r,o]=e.useState(!1);e.useEffect(()=>{const e=e=>{e.preventDefault(),i(e),o(!0)};return window.addEventListener("beforeinstallprompt",e),()=>{window.removeEventListener("beforeinstallprompt",e)}},[]);return We.jsxs("div",{className:"home-page",children:[We.jsxs("div",{className:"start-menu fade-in",children:[We.jsxs("h1",{children:["🎮",We.jsx("br",{}),"ThirdPerson TreeJS Game"]}),We.jsxs("div",{className:"menu-buttons",children:[We.jsx("button",{className:"menu-btn start-game-btn",onClick:()=>t("/game"),children:"게임 시작"}),We.jsx("button",{className:"menu-btn editor-btn",onClick:()=>t("/editor"),children:"에디터"})]})]}),r&&We.jsxs("div",{className:"install-prompt",children:[We.jsx("p",{children:"이 게임을 홈 화면에 추가하시겠습니까?"}),We.jsx("button",{onClick:async()=>{if(s){s.prompt();(await s.userChoice).outcome,i(null)}o(!1)},className:"install-btn",children:"설치"}),We.jsx("button",{onClick:()=>{o(!1)},className:"dismiss-btn",children:"나중에"})]})]})}const $e=e.createContext(null);function Je({children:e,container:t}){return We.jsx($e.Provider,{value:t,children:e})}function et(){const t=e.useContext($e);if(!t)throw new Error("useDI must be used within a DIProvider");return{resolve:e=>t.resolve(e),container:t}}function tt(){const{resolve:e}=et();return e("GameService")}function st(){const{resolve:e}=et();return e("EventBus")}function nt(){const t=e.useRef(null);return e.useEffect(()=>{if(!t.current)return;const e=new a;e.background=new c(8900331);const s=new l(75,window.innerWidth/window.innerHeight,.1,1e3);s.position.set(0,5,10),s.lookAt(0,0,0);const n=new h({antialias:!0});n.setSize(window.innerWidth,window.innerHeight),n.shadowMap.enabled=!0,n.shadowMap.type=d,t.current.appendChild(n.domElement);const i=new u(4210752,.6);e.add(i);const r=new m(16777215,.8);r.position.set(10,10,5),r.castShadow=!0,e.add(r);const o=new p(20,20),v=new g({color:65280}),w=new f(o,v);w.rotation.x=-Math.PI/2,w.receiveShadow=!0,e.add(w);const x=new b(2,2,2),S=new g({color:16711680}),j=new f(x,S);j.position.set(0,1,0),j.castShadow=!0,e.add(j);const E=new y(1,32,32),O=new g({color:255}),A=new f(E,O);A.position.set(3,1,0),A.castShadow=!0,e.add(A);const M=()=>{requestAnimationFrame(M),j.rotation.x+=.01,j.rotation.y+=.01,A.rotation.y+=.02,n.render(e,s)};M();const T=()=>{s.aspect=window.innerWidth/window.innerHeight,s.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight)};return window.addEventListener("resize",T),()=>{window.removeEventListener("resize",T),t.current&&n.domElement&&t.current.removeChild(n.domElement),n.dispose()}},[]),We.jsx("div",{ref:t,style:{width:"100vw",height:"100vh",position:"absolute",top:0,left:0,zIndex:1}})}function it(){const t=tt(),s=st(),[n,i]=e.useState(()=>t.getState());e.useEffect(()=>{const e=()=>{i(t.getState())},n=s.subscribe("GAME_PAUSED",e),r=s.subscribe("GAME_RESUMED",e),o=s.subscribe("GAME_RESTARTED",e);return()=>{n(),r(),o()}},[t,s]);const{isPaused:r,playerPosition:o}=n,a=t.getCameraState(),[c,l]=e.useState(!1),[h,d]=e.useState(10);return We.jsxs(We.Fragment,{children:[We.jsx("div",{className:"crosshair"}),We.jsx("div",{className:"game-message"}),r&&We.jsxs("div",{className:"pause-overlay",children:[We.jsx("h2",{children:"게임 일시정지"}),We.jsx("button",{onClick:()=>t.resume(),className:"resume-btn",children:"계속하기"}),We.jsx("button",{onClick:()=>t.restart(),className:"restart-btn",children:"재시작"})]}),We.jsxs("div",{className:"controls-info",children:[We.jsx("div",{children:"WASD: 이동"}),We.jsx("div",{children:"마우스: 카메라 회전"}),We.jsx("div",{children:"스크롤: 줌"}),We.jsx("div",{children:"ESC: 일시정지"}),We.jsxs("div",{children:["위치: (",Math.round(o.x),", ",Math.round(o.z),")"]})]}),We.jsx("button",{className:"sidebar-toggle-btn",onClick:()=>l(!c),children:"⚙️"}),We.jsxs("div",{className:"sidebar "+(c?"open":""),children:[We.jsxs("div",{className:"sidebar-header",children:[We.jsx("h3",{children:"게임 설정"}),We.jsx("button",{className:"close-btn",onClick:()=>l(!1),children:"✕"})]}),We.jsxs("div",{className:"sidebar-content",children:[We.jsxs("div",{className:"section",children:[We.jsx("h4",{children:"플레이어 모델"}),We.jsx("input",{type:"file",accept:".glb,.gltf",onChange:e=>{e.target.files[0]},style:{display:"none"},id:"model-file-input"}),We.jsx("button",{className:"upload-btn",onClick:()=>document.getElementById("model-file-input").click(),children:"모델 업로드"}),We.jsx("button",{className:"reset-btn",onClick:()=>{window.confirm("캐릭터를 기본 모델로 되돌리시겠습니까?")},children:"기본 모델로 리셋"}),We.jsx("div",{className:"model-info",children:"기본 모델 사용 중"})]}),We.jsxs("div",{className:"section",children:[We.jsxs("h4",{children:["나무 개수: ",h]}),We.jsx("input",{type:"range",min:"0",max:"20",value:h,onChange:e=>{const t=parseInt(e.target.value,10);d(t)},className:"slider"})]}),We.jsxs("div",{className:"section",children:[We.jsx("h4",{children:"카메라"}),We.jsx("button",{className:"camera-btn "+(a.followMode?"active":""),onClick:()=>t.toggleCameraFollowMode(),children:a.followMode?"따라가기 모드":"고정 모드"})]}),We.jsxs("div",{className:"section",children:[We.jsx("h4",{children:"맵 선택"}),We.jsx("select",{className:"map-select",children:We.jsx("option",{value:"default",children:"기본 맵"})}),We.jsx("button",{className:"apply-map-btn",children:"맵 적용"})]})]})]})]})}function rt(){const t=n(),s=tt(),i=st(),[r,o]=e.useState(()=>s.getState()),[a,c]=e.useState("게임 로딩 중...");e.useEffect(()=>{const e=()=>{o(s.getState())},t=i.subscribe("GAME_STARTED",e),n=i.subscribe("GAME_PAUSED",e),r=i.subscribe("GAME_RESTARTED",e);return()=>{t(),n(),r()}},[s,i]);const{isLoading:l}=r;return e.useEffect(()=>{(async()=>{try{c("게임 엔진 초기화 중..."),await new Promise(e=>setTimeout(e,1e3)),c("게임 준비 완료!"),setTimeout(()=>{s.setLoading(!1)},500)}catch(e){c(`❌ 게임 로딩 실패: ${e.message}`)}})()},[s]),e.useEffect(()=>{const e=e=>{"Escape"===e.code&&s.pause(),"KeyR"===e.code&&s.restart(),"KeyH"===e.code&&t("/")};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},[s,t]),e.useEffect(()=>{const e=document.querySelector("canvas");e&&e.addEventListener("click",()=>{e.requestPointerLock()})},[l]),We.jsxs("div",{className:"game-page",children:[l&&We.jsxs("div",{className:"loading-screen",children:[We.jsx("div",{className:"loader"}),We.jsx("p",{className:"loading-status",children:a})]}),!l&&We.jsxs(We.Fragment,{children:[We.jsx(nt,{}),We.jsx(it,{}),We.jsx("button",{className:"home-btn",onClick:()=>t("/"),title:"홈으로 돌아가기 (H)",children:"🏠"})]})]})}function ot(e,t){if(t===v)return e;if(t===w||t===x){let s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,i=[];if(t===w)for(let e=1;e<=n;e++)i.push(s.getX(0)),i.push(s.getX(e)),i.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(i.push(s.getX(e)),i.push(s.getX(e+1)),i.push(s.getX(e+2))):(i.push(s.getX(e+2)),i.push(s.getX(e+1)),i.push(s.getX(e)));i.length;const r=e.clone();return r.setIndex(i),r.clearGroups(),r}return e}class at extends S{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new mt(e)}),this.register(function(e){return new pt(e)}),this.register(function(e){return new jt(e)}),this.register(function(e){return new Et(e)}),this.register(function(e){return new Ot(e)}),this.register(function(e){return new ft(e)}),this.register(function(e){return new bt(e)}),this.register(function(e){return new yt(e)}),this.register(function(e){return new vt(e)}),this.register(function(e){return new ut(e)}),this.register(function(e){return new wt(e)}),this.register(function(e){return new gt(e)}),this.register(function(e){return new St(e)}),this.register(function(e){return new xt(e)}),this.register(function(e){return new ht(e)}),this.register(function(e){return new At(e)}),this.register(function(e){return new Mt(e)})}load(e,t,s,n){const i=this;let r;if(""!==this.resourcePath)r=this.resourcePath;else if(""!==this.path){const t=j.extractUrlBase(e);r=j.resolveURL(t,this.path)}else r=j.extractUrlBase(e);this.manager.itemStart(e);const o=function(t){n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)},a=new E(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(s){try{i.parse(s,r,function(s){t(s),i.manager.itemEnd(e)},o)}catch(n){o(n)}},s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let i;const r={},o={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer){if(a.decode(new Uint8Array(e,0,4))===Tt){try{r[lt.KHR_BINARY_GLTF]=new _t(e)}catch(l){return void(n&&n(l))}i=JSON.parse(r[lt.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e))}else i=e;if(void 0===i.asset||i.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const c=new ns(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const e=this.pluginCallbacks[h](c);e.name,o[e.name]=e,r[e.name]=!0}if(i.extensionsUsed)for(let h=0;h<i.extensionsUsed.length;++h){const e=i.extensionsUsed[h],t=i.extensionsRequired||[];switch(e){case lt.KHR_MATERIALS_UNLIT:r[e]=new dt;break;case lt.KHR_DRACO_MESH_COMPRESSION:r[e]=new Nt(i,this.dracoLoader);break;case lt.KHR_TEXTURE_TRANSFORM:r[e]=new Dt;break;case lt.KHR_MESH_QUANTIZATION:r[e]=new It;break;default:t.indexOf(e)>=0&&o[e]}}c.setExtensions(r),c.setPlugins(o),c.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,i){s.parse(e,t,n,i)})}}function ct(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const lt={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ht{constructor(e){this.parser=e,this.name=lt.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const i=t.json,r=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let o;const a=new c(16777215);void 0!==r.color&&a.setRGB(r.color[0],r.color[1],r.color[2],O);const l=void 0!==r.range?r.range:0;switch(r.type){case"directional":o=new m(a),o.target.position.set(0,0,-1),o.add(o.target);break;case"point":o=new M(a),o.distance=l;break;case"spot":o=new A(a),o.distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,o.angle=r.spot.outerConeAngle,o.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return o.position.set(0,0,0),o.decay=2,qt(o,r),void 0!==r.intensity&&(o.intensity=r.intensity),o.name=t.createUniqueName(r.name||"light_"+e),n=Promise.resolve(o),t.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],i=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return s._getNodeRef(t.cache,i,e)})}}class dt{constructor(){this.name=lt.KHR_MATERIALS_UNLIT}getMaterialType(){return T}extendParams(e,t,s){const n=[];e.color=new c(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],O),e.opacity=t[3]}void 0!==i.baseColorTexture&&n.push(s.assignTexture(e,"map",i.baseColorTexture,R))}return Promise.all(n)}}class ut{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}}class mt{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new _(e,e)}return Promise.all(i)}}class pt{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.dispersion=void 0!==n.dispersion?n.dispersion:0,Promise.resolve()}}class gt{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return void 0!==r.iridescenceFactor&&(t.iridescence=r.iridescenceFactor),void 0!==r.iridescenceTexture&&i.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),void 0!==r.iridescenceIor&&(t.iridescenceIOR=r.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==r.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),void 0!==r.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),void 0!==r.iridescenceThicknessTexture&&i.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(i)}}class ft{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new c(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=n.extensions[this.name];if(void 0!==r.sheenColorFactor){const e=r.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],O)}return void 0!==r.sheenRoughnessFactor&&(t.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&i.push(s.assignTexture(t,"sheenColorMap",r.sheenColorTexture,R)),void 0!==r.sheenRoughnessTexture&&i.push(s.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(i)}}class bt{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(i)}}class yt{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];t.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&i.push(s.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const o=r.attenuationColor||[1,1,1];return t.attenuationColor=(new c).setRGB(o[0],o[1],o[2],O),Promise.all(i)}}class vt{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class wt{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];t.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&i.push(s.assignTexture(t,"specularIntensityMap",r.specularTexture));const o=r.specularColorFactor||[1,1,1];return t.specularColor=(new c).setRGB(o[0],o[1],o[2],O),void 0!==r.specularColorTexture&&i.push(s.assignTexture(t,"specularColorMap",r.specularColorTexture,R)),Promise.all(i)}}class xt{constructor(e){this.parser=e,this.name=lt.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return t.bumpScale=void 0!==r.bumpFactor?r.bumpFactor:1,void 0!==r.bumpTexture&&i.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(i)}}class St{constructor(e){this.parser=e,this.name=lt.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?C:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return void 0!==r.anisotropyStrength&&(t.anisotropy=r.anisotropyStrength),void 0!==r.anisotropyRotation&&(t.anisotropyRotation=r.anisotropyRotation),void 0!==r.anisotropyTexture&&i.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(i)}}class jt{constructor(e){this.parser=e,this.name=lt.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,r)}}class Et{constructor(e){this.parser=e,this.name=lt.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],o=n.images[r.source];let a=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(a=e)}return this.detectSupport().then(function(i){if(i)return s.loadTextureImage(e,r.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class Ot{constructor(e){this.parser=e,this.name=lt.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],o=n.images[r.source];let a=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(a=e)}return this.detectSupport().then(function(i){if(i)return s.loadTextureImage(e,r.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class At{constructor(e){this.name=lt.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(t){const s=e.byteOffset||0,n=e.byteLength||0,r=e.count,o=e.byteStride,a=new Uint8Array(t,s,n);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(r,o,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){const t=new ArrayBuffer(r*o);return i.decodeGltfBuffer(new Uint8Array(t),r,o,a,e.mode,e.filter),t})})}return null}}class Mt{constructor(e){this.name=lt.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const n=t.meshes[s.mesh];for(const a of n.primitives)if(a.mode!==Bt.TRIANGLES&&a.mode!==Bt.TRIANGLE_STRIP&&a.mode!==Bt.TRIANGLE_FAN&&void 0!==a.mode)return null;const i=s.extensions[this.name].attributes,r=[],o={};for(const a in i)r.push(this.parser.getDependency("accessor",i[a]).then(e=>(o[a]=e,o[a])));return r.length<1?null:(r.push(this.parser.createNodeMesh(e)),Promise.all(r).then(e=>{const t=e.pop(),s=t.isGroup?t.children:[t],n=e[0].count,i=[];for(const r of s){const e=new N,t=new D,s=new de,a=new D(1,1,1),c=new I(r.geometry,r.material,n);for(let i=0;i<n;i++)o.TRANSLATION&&t.fromBufferAttribute(o.TRANSLATION,i),o.ROTATION&&s.fromBufferAttribute(o.ROTATION,i),o.SCALE&&a.fromBufferAttribute(o.SCALE,i),c.setMatrixAt(i,e.compose(t,s,a));for(const n in o)if("_COLOR_0"===n){const e=o[n];c.instanceColor=new L(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==n&&"ROTATION"!==n&&"SCALE"!==n&&r.geometry.setAttribute(n,o[n]);P.prototype.copy.call(c,r),this.parser.assignFinalMaterial(c),i.push(c)}return t.isGroup?(t.clear(),t.add(...i),t):i[0]}))}}const Tt="glTF",Rt=1313821514,Ct=5130562;class _t{constructor(e){this.name=lt.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Tt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,i=new DataView(e,12);let r=0;for(;r<n;){const t=i.getUint32(r,!0);r+=4;const n=i.getUint32(r,!0);if(r+=4,n===Rt){const n=new Uint8Array(e,12+r,t);this.content=s.decode(n)}else if(n===Ct){const s=12+r;this.body=e.slice(s,s+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Nt{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=lt.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,o={},a={},c={};for(const l in r){const e=Gt[l]||l.toLowerCase();o[e]=r[l]}for(const l in e.attributes){const t=Gt[l]||l.toLowerCase();if(void 0!==r[l]){const n=s.accessors[e.attributes[l]],i=Ht[n.componentType];c[t]=i.name,a[t]=!0===n.normalized}}return t.getDependency("bufferView",i).then(function(e){return new Promise(function(t,s){n.decodeDracoFile(e,function(e){for(const t in e.attributes){const s=e.attributes[t],n=a[t];void 0!==n&&(s.normalized=n)}t(e)},o,c,O,s)})})}}class Dt{constructor(){this.name=lt.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class It{constructor(){this.name=lt.KHR_MESH_QUANTIZATION}}class Lt extends Ae{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let r=0;r!==n;r++)t[r]=s[i+r];return t}interpolate_(e,t,s,n){const i=this.resultBuffer,r=this.sampleValues,o=this.valueSize,a=2*o,c=3*o,l=n-t,h=(s-t)/l,d=h*h,u=d*h,m=e*c,p=m-c,g=-2*u+3*d,f=u-d,b=1-g,y=f-d+h;for(let v=0;v!==o;v++){const e=r[p+v+o],t=r[p+v+a]*l,s=r[m+v+o],n=r[m+v]*l;i[v]=b*e+y*t+g*s+f*n}return i}}const Pt=new de;class kt extends Lt{interpolate_(e,t,s,n){const i=super.interpolate_(e,t,s,n);return Pt.fromArray(i).normalize().toArray(i),i}}const Bt={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Ht={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},zt={9728:V,9729:F,9984:ue,9985:me,9986:pe,9987:U},Ft={33071:ge,33648:fe,10497:G},Ut={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Gt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Vt={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Xt={CUBICSPLINE:void 0,LINEAR:le,STEP:be},Kt="OPAQUE",Yt="MASK",Wt="BLEND";function Zt(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new W({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ye})),e.DefaultMaterial}function Qt(e,t,s){for(const n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function qt(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function $t(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}}}function Jt(e){let t;const s=e.extensions&&e.extensions[lt.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+es(s.attributes):e.indices+":"+es(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+es(e.targets[n]);return t}function es(e){let t="";const s=Object.keys(e).sort();for(let n=0,i=s.length;n<i;n++)t+=s[n]+":"+e[s[n]]+";";return t}function ts(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const ss=new N;class ns{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ct,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,i=!1,r=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;s=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);n=s&&t?parseInt(t[1],10):-1,i=e.indexOf("Firefox")>-1,r=i?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||s&&n<17||i&&r<98?this.textureLoader=new k(this.options.manager):this.textureLoader=new B(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new E(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){const r={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};return Qt(i,r,n),qt(r,n),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(r)})).then(function(){for(const e of r.scenes)e.updateMatrixWorld();e(r)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const s=t[n].joints;for(let t=0,n=s.length;t<n;t++)e[s[t]].isBone=!0}for(let n=0,i=e.length;n<i;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),i=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[n,r]of e.children.entries())i(r,t.children[n])};return i(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const i=e(t[n]);i&&s.push(i)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":n=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[lt.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(e,i){s.load(j.resolveURL(t.uri,n.path),e,void 0,function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=Ut[n.type],t=Ht[n.componentType],s=!0===n.normalized,i=new t(n.count*e);return Promise.resolve(new H(i,e,s))}const i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(e){const i=e[0],r=Ut[n.type],o=Ht[n.componentType],a=o.BYTES_PER_ELEMENT,c=a*r,l=n.byteOffset||0,h=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;let u,m;if(h&&h!==c){const e=Math.floor(l/h),s="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let c=t.cache.get(s);c||(u=new o(i,e*h,n.count*h/a),c=new z(u,h/a),t.cache.add(s,c)),m=new ve(c,r,l%h/a,d)}else u=null===i?new o(n.count*r):new o(i,l,n.count*r),m=new H(u,r,d);if(void 0!==n.sparse){const t=Ut.SCALAR,s=Ht[n.sparse.indices.componentType],a=n.sparse.indices.byteOffset||0,c=n.sparse.values.byteOffset||0,l=new s(e[1],a,n.sparse.count*t),h=new o(e[2],c,n.sparse.count*r);null!==i&&(m=new H(m.array.slice(),m.itemSize,m.normalized)),m.normalized=!1;for(let e=0,n=l.length;e<n;e++){const t=l[e];if(m.setX(t,h[e*r]),r>=2&&m.setY(t,h[e*r+1]),r>=3&&m.setZ(t,h[e*r+2]),r>=4&&m.setW(t,h[e*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}m.normalized=d}return m})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,i=t.images[n];let r=this.textureLoader;if(i.uri){const e=s.manager.getHandler(i.uri);null!==e&&(r=e)}return this.loadTextureImage(e,n,r)}loadTextureImage(e,t,s){const n=this,i=this.json,r=i.textures[e],o=i.images[t],a=(o.uri||o.bufferView)+":"+r.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=r.name||o.name||"",""===t.name&&"string"==typeof o.uri&&!1===o.uri.startsWith("data:image/")&&(t.name=o.uri);const s=(i.samplers||{})[r.sampler]||{};return t.magFilter=zt[s.magFilter]||F,t.minFilter=zt[s.minFilter]||U,t.wrapS=Ft[s.wrapS]||G,t.wrapT=Ft[s.wrapT]||G,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==V&&t.minFilter!==F,n.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[a]=c,c}loadImageSource(e,t){const s=this,n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const r=n.images[e],o=self.URL||self.webkitURL;let a=r.uri||"",c=!1;if(void 0!==r.bufferView)a=s.getDependency("bufferView",r.bufferView).then(function(e){c=!0;const t=new Blob([e],{type:r.mimeType});return a=o.createObjectURL(t),a});else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then(function(e){return new Promise(function(s,n){let r=s;!0===t.isImageBitmapLoader&&(r=function(e){const t=new we(e);t.needsUpdate=!0,s(t)}),t.load(j.resolveURL(e,i.path),r,void 0,n)})}).then(function(e){var t;return!0===c&&o.revokeObjectURL(a),qt(e,r),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw e});return this.sourceCache[e]=l,l}assignTexture(e,t,s,n){const i=this;return this.getDependency("texture",s.index).then(function(r){if(!r)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((r=r.clone()).channel=s.texCoord),i.extensions[lt.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[lt.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(r);r=i.extensions[lt.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),i.associations.set(r,t)}}return void 0!==n&&(r.colorSpace=n),e[t]=r,r})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=void 0===t.attributes.tangent,i=void 0!==t.attributes.color,r=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new X,K.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Y,K.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(n||i||r){let e="ClonedMaterial:"+s.uuid+":";n&&(e+="derivative-tangents:"),i&&(e+="vertex-colors:"),r&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),i&&(t.vertexColors=!0),r&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return W}loadMaterial(e){const t=this,s=this.json,n=this.extensions,i=s.materials[e];let r;const o={},a=[];if((i.extensions||{})[lt.KHR_MATERIALS_UNLIT]){const e=n[lt.KHR_MATERIALS_UNLIT];r=e.getMaterialType(),a.push(e.extendParams(o,i,t))}else{const s=i.pbrMetallicRoughness||{};if(o.color=new c(1,1,1),o.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;o.color.setRGB(e[0],e[1],e[2],O),o.opacity=e[3]}void 0!==s.baseColorTexture&&a.push(t.assignTexture(o,"map",s.baseColorTexture,R)),o.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,o.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(a.push(t.assignTexture(o,"metalnessMap",s.metallicRoughnessTexture)),a.push(t.assignTexture(o,"roughnessMap",s.metallicRoughnessTexture))),r=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),a.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)})))}!0===i.doubleSided&&(o.side=Z);const l=i.alphaMode||Kt;if(l===Wt?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,l===Yt&&(o.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&r!==T&&(a.push(t.assignTexture(o,"normalMap",i.normalTexture)),o.normalScale=new _(1,1),void 0!==i.normalTexture.scale)){const e=i.normalTexture.scale;o.normalScale.set(e,e)}if(void 0!==i.occlusionTexture&&r!==T&&(a.push(t.assignTexture(o,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(o.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&r!==T){const e=i.emissiveFactor;o.emissive=(new c).setRGB(e[0],e[1],e[2],O)}return void 0!==i.emissiveTexture&&r!==T&&a.push(t.assignTexture(o,"emissiveMap",i.emissiveTexture,R)),Promise.all(a).then(function(){const s=new r(o);return i.name&&(s.name=i.name),qt(s,i),t.associations.set(s,{materials:e}),i.extensions&&Qt(n,s,i),s})}createUniqueName(e){const t=Q.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function i(e){return s[lt.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return is(s,e,t)})}const r=[];for(let o=0,a=e.length;o<a;o++){const s=e[o],a=Jt(s),c=n[a];if(c)r.push(c.promise);else{let e;e=s.extensions&&s.extensions[lt.KHR_DRACO_MESH_COMPRESSION]?i(s):is(new q,s,t),n[a]={primitive:s,promise:e},r.push(e)}}return Promise.all(r)}loadMesh(e){const t=this,s=this.json,n=this.extensions,i=s.meshes[e],r=i.primitives,o=[];for(let a=0,c=r.length;a<c;a++){const e=void 0===r[a].material?Zt(this.cache):this.getDependency("material",r[a].material);o.push(e)}return o.push(t.loadGeometries(r)),Promise.all(o).then(function(s){const o=s.slice(0,s.length-1),a=s[s.length-1],c=[];for(let h=0,d=a.length;h<d;h++){const s=a[h],l=r[h];let d;const u=o[h];if(l.mode===Bt.TRIANGLES||l.mode===Bt.TRIANGLE_STRIP||l.mode===Bt.TRIANGLE_FAN||void 0===l.mode)d=!0===i.isSkinnedMesh?new $(s,u):new f(s,u),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),l.mode===Bt.TRIANGLE_STRIP?d.geometry=ot(d.geometry,x):l.mode===Bt.TRIANGLE_FAN&&(d.geometry=ot(d.geometry,w));else if(l.mode===Bt.LINES)d=new J(s,u);else if(l.mode===Bt.LINE_STRIP)d=new ee(s,u);else if(l.mode===Bt.LINE_LOOP)d=new te(s,u);else{if(l.mode!==Bt.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+l.mode);d=new se(s,u)}Object.keys(d.geometry.morphAttributes).length>0&&$t(d,i),d.name=t.createUniqueName(i.name||"mesh_"+e),qt(d,i),l.extensions&&Qt(n,d,l),t.assignFinalMaterial(d),c.push(d)}for(let n=0,i=c.length;n<i;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return i.extensions&&Qt(n,c[0],i),c[0];const l=new ne;i.extensions&&Qt(n,l,i),t.associations.set(l,{meshes:e});for(let e=0,t=c.length;e<t;e++)l.add(c[e]);return l})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new l(ie.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new re(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),qt(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,i=t.joints.length;n<i;n++)s.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){const t=e.pop(),s=e,n=[],i=[];for(let r=0,o=s.length;r<o;r++){const e=s[r];if(e){n.push(e);const s=new N;null!==t&&s.fromArray(t.array,16*r),i.push(s)}}return new oe(n,i)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],i=n.name?n.name:"animation_"+e,r=[],o=[],a=[],c=[],l=[];for(let h=0,d=n.channels.length;h<d;h++){const e=n.channels[h],t=n.samplers[e.sampler],s=e.target,i=s.node,d=void 0!==n.parameters?n.parameters[t.input]:t.input,u=void 0!==n.parameters?n.parameters[t.output]:t.output;void 0!==s.node&&(r.push(this.getDependency("node",i)),o.push(this.getDependency("accessor",d)),a.push(this.getDependency("accessor",u)),c.push(t),l.push(s))}return Promise.all([Promise.all(r),Promise.all(o),Promise.all(a),Promise.all(c),Promise.all(l)]).then(function(e){const t=e[0],n=e[1],r=e[2],o=e[3],a=e[4],c=[];for(let i=0,l=t.length;i<l;i++){const e=t[i],l=n[i],h=r[i],d=o[i],u=a[i];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const m=s._createAnimationTracks(e,l,h,d,u);if(m)for(let t=0;t<m.length;t++)c.push(m[t])}return new ae(i,void 0,c)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]}),t})}loadNode(e){const t=this,s=this.json.nodes[e],n=t._loadNodeShallow(e),i=[],r=s.children||[];for(let a=0,c=r.length;a<c;a++)i.push(t.getDependency("node",r[a]));const o=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([n,Promise.all(i),o]).then(function(e){const t=e[0],s=e[1],n=e[2];null!==n&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(n,ss)});for(let i=0,r=s.length;i<r;i++)t.add(s[i]);return t})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const i=t.nodes[e],r=i.name?n.createUniqueName(i.name):"",o=[],a=n._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return a&&o.push(a),void 0!==i.camera&&o.push(n.getDependency("camera",i.camera).then(function(e){return n._getNodeRef(n.cameraCache,i.camera,e)})),n._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){o.push(e)}),this.nodeCache[e]=Promise.all(o).then(function(t){let o;if(o=!0===i.isBone?new ce:t.length>1?new ne:1===t.length?t[0]:new P,o!==t[0])for(let e=0,s=t.length;e<s;e++)o.add(t[e]);if(i.name&&(o.userData.name=i.name,o.name=r),qt(o,i),i.extensions&&Qt(s,o,i),void 0!==i.matrix){const e=new N;e.fromArray(i.matrix),o.applyMatrix4(e)}else void 0!==i.translation&&o.position.fromArray(i.translation),void 0!==i.rotation&&o.quaternion.fromArray(i.rotation),void 0!==i.scale&&o.scale.fromArray(i.scale);return n.associations.has(o)||n.associations.set(o,{}),n.associations.get(o).nodes=e,o}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,i=new ne;s.name&&(i.name=n.createUniqueName(s.name)),qt(i,s),s.extensions&&Qt(t,i,s);const r=s.nodes||[],o=[];for(let a=0,c=r.length;a<c;a++)o.push(n.getDependency("node",r[a]));return Promise.all(o).then(function(e){for(let t=0,s=e.length;t<s;t++)i.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[s,i]of n.associations)(s instanceof K||s instanceof we)&&t.set(s,i);return e.traverse(e=>{const s=n.associations.get(e);null!=s&&t.set(e,s)}),t})(i),i})}_createAnimationTracks(e,t,s,n,i){const r=[],o=e.name?e.name:e.uuid,a=[];let c;switch(Vt[i.path]===Vt.weights?e.traverse(function(e){e.morphTargetInfluences&&a.push(e.name?e.name:e.uuid)}):a.push(o),Vt[i.path]){case Vt.weights:c=Se;break;case Vt.rotation:c=je;break;case Vt.position:case Vt.scale:c=xe;break;default:if(1===s.itemSize)c=Se;else c=xe}const l=void 0!==n.interpolation?Xt[n.interpolation]:le,h=this._getArrayFromAccessor(s);for(let d=0,u=a.length;d<u;d++){const e=new c(a[d]+"."+Vt[i.path],t.array,h,l);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(e),r.push(e)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=ts(t.constructor),s=new Float32Array(t.length);for(let n=0,i=t.length;n<i;n++)s[n]=t[n]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof je?kt:Lt)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function is(e,t,s){const n=t.attributes,i=[];function r(t,n){return s.getDependency("accessor",t).then(function(t){e.setAttribute(n,t)})}for(const o in n){const t=Gt[o]||o.toLowerCase();t in e.attributes||i.push(r(n[o],t))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});i.push(n)}return he.workingColorSpace,qt(e,t),function(e,t,s){const n=t.attributes,i=new Ee;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],t=e.min,r=e.max;if(void 0===t||void 0===r)return;if(i.set(new D(t[0],t[1],t[2]),new D(r[0],r[1],r[2])),e.normalized){const t=ts(Ht[e.componentType]);i.min.multiplyScalar(t),i.max.multiplyScalar(t)}}const r=t.targets;if(void 0!==r){const e=new D,t=new D;for(let n=0,i=r.length;n<i;n++){const i=r[n];if(void 0!==i.POSITION){const n=s.json.accessors[i.POSITION],r=n.min,o=n.max;if(void 0!==r&&void 0!==o){if(t.setX(Math.max(Math.abs(r[0]),Math.abs(o[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(o[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(o[2]))),n.normalized){const e=ts(Ht[n.componentType]);t.multiplyScalar(e)}e.max(t)}}}i.expandByVector(e)}e.boundingBox=i;const o=new Oe;i.getCenter(o.center),o.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=o}(e,t,s),Promise.all(i).then(function(){return void 0!==t.targets?function(e,t,s){let n=!1,i=!1,r=!1;for(let l=0,h=t.length;l<h;l++){const e=t[l];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(i=!0),void 0!==e.COLOR_0&&(r=!0),n&&i&&r)break}if(!n&&!i&&!r)return Promise.resolve(e);const o=[],a=[],c=[];for(let l=0,h=t.length;l<h;l++){const h=t[l];if(n){const t=void 0!==h.POSITION?s.getDependency("accessor",h.POSITION):e.attributes.position;o.push(t)}if(i){const t=void 0!==h.NORMAL?s.getDependency("accessor",h.NORMAL):e.attributes.normal;a.push(t)}if(r){const t=void 0!==h.COLOR_0?s.getDependency("accessor",h.COLOR_0):e.attributes.color;c.push(t)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(c)]).then(function(t){const s=t[0],o=t[1],a=t[2];return n&&(e.morphAttributes.position=s),i&&(e.morphAttributes.normal=o),r&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,s):e})}function rs(){const{resolve:e}=et();return e("EditorService")}class os{constructor(e,t,s=null){this.camera=e,this.renderer=t,this.onCameraChange=s,this.initialPosition=e.position.clone(),this.initialTarget=new D(0,0,0),this.cameraTarget=new D(0,0,0),this.spherical=new Me,this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget)),this._tempVector1=new D,this._tempVector2=new D,this._tempVector3=new D}resetCamera(){this.camera.position.copy(this.initialPosition),this.cameraTarget.copy(this.initialTarget),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}toggleProjection(){const e=this.camera,t=e.position.clone(),s=this.cameraTarget.clone();if(e.isPerspectiveCamera){const e=t.distanceTo(s),n=window.innerWidth/window.innerHeight,i=.5*e,r=new re(i*n/-2,i*n/2,i/2,i/-2,.1,1e3);r.position.copy(t),r.lookAt(s),r.updateMatrixWorld(),this.camera=r}else{const e=new l(75,window.innerWidth/window.innerHeight,.1,1e3);e.position.copy(t),e.lookAt(s),e.updateMatrixWorld(),this.camera=e}return this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget)),this.onCameraChange&&this.onCameraChange(this.camera),this.camera}setView(e){const t=this.camera.position.distanceTo(this.cameraTarget),s=this.cameraTarget.clone();let n=new D;switch(e){case"front":n.set(s.x,s.y,s.z+t);break;case"side":n.set(s.x+t,s.y,s.z);break;case"top":n.set(s.x,s.y+t,s.z);break;case"bottom":n.set(s.x,s.y-t,s.z);break;default:return}this.camera.position.copy(n),this.camera.lookAt(s),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}pan(e,t){const s=new D,n=new D;s.setFromMatrixColumn(this.camera.matrix,0),n.setFromMatrixColumn(this.camera.matrix,1);const i=this.camera.position.distanceTo(this.cameraTarget)/50*50,r=new D;r.add(s.clone().multiplyScalar(-e*i)),r.add(n.clone().multiplyScalar(-t*i)),this.camera.position.add(r),this.cameraTarget.add(r),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}updateRotationCenterAfterPan(e,t=[]){const s=new Te,n=new _(0,0);s.setFromCamera(n,this.camera);const i=s.intersectObjects(t,!0);if(i.length>0){const e=i[0].point;this.cameraTarget.copy(e)}else{const e=new D;e.setFromMatrixColumn(this.camera.matrix,2).negate();const t=this.camera.position.clone().add(e.multiplyScalar(50));this.cameraTarget.copy(t)}this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}orbit(e,t){this.spherical.theta-=100*e*.01,this.spherical.phi+=100*t*.01,this.spherical.phi=Math.max(.1,Math.min(Math.PI-.1,this.spherical.phi));const s=new D;s.setFromSpherical(this.spherical),s.add(this.cameraTarget),this.camera.position.copy(s),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld()}zoom(e){const t=e>0?1.2:1/1.2;if(this.camera.isPerspectiveCamera){this.spherical.radius*=t,this.spherical.radius=Math.max(1,Math.min(1e3,this.spherical.radius));const e=new D;e.setFromSpherical(this.spherical),e.add(this.cameraTarget),this.camera.position.copy(e),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld()}else if(this.camera.isOrthographicCamera){const e=(this.camera.right-this.camera.left)*t,s=(this.camera.top-this.camera.bottom)*t,n=2e3,i=.1,r=Math.max(i,Math.min(n,e)),o=Math.max(i,Math.min(n,s));this.camera.left=-r/2,this.camera.right=r/2,this.camera.top=o/2,this.camera.bottom=-o/2,this.camera.updateProjectionMatrix()}}focusOnObject(e){if(!e)return;const t=(new Ee).setFromObject(e),s=t.getCenter(new D),n=t.getSize(new D),i=Math.max(n.x,n.y,n.z);let r;if(this.camera.isPerspectiveCamera){const e=this.camera.fov*(Math.PI/180);r=1.5*Math.abs(i/Math.sin(e/2))}else r=2*i;this.cameraTarget.copy(s);const o=new D;o.subVectors(this.camera.position,this.cameraTarget).normalize(),this.camera.position.copy(s).add(o.multiplyScalar(r)),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}handleResize(){if(this.camera.isPerspectiveCamera)this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix();else if(this.camera.isOrthographicCamera){const e=window.innerWidth/window.innerHeight,t=(this.camera.top-this.camera.bottom)*e;this.camera.left=-t/2,this.camera.right=t/2,this.camera.updateProjectionMatrix()}}setTarget(e){this.cameraTarget.copy(e),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}getCamera(){return this.camera}getTarget(){return this.cameraTarget.clone()}}const as=new Te,cs=new D,ls=new D,hs=new de,ds={X:new D(1,0,0),Y:new D(0,1,0),Z:new D(0,0,1)},us={type:"change"},ms={type:"mouseDown",mode:null},ps={type:"mouseUp",mode:null},gs={type:"objectChange"};class fs extends Re{constructor(e,t=null){super(void 0,t);const s=new ks(this);this._root=s;const n=new Bs;this._gizmo=n,s.add(n);const i=new Hs;this._plane=i,s.add(i);const r=this;function o(e,t){let s=t;Object.defineProperty(r,e,{get:function(){return void 0!==s?s:t},set:function(t){s!==t&&(s=t,i[e]=t,n[e]=t,r.dispatchEvent({type:e+"-changed",value:t}),r.dispatchEvent(us))}}),r[e]=t,i[e]=t,n[e]=t}o("camera",e),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0),o("minX",-1/0),o("maxX",1/0),o("minY",-1/0),o("maxY",1/0),o("minZ",-1/0),o("maxZ",1/0);const a=new D,c=new D,l=new de,h=new de,d=new D,u=new de,m=new D,p=new D,g=new D,f=new D;o("worldPosition",a),o("worldPositionStart",c),o("worldQuaternion",l),o("worldQuaternionStart",h),o("cameraPosition",d),o("cameraQuaternion",u),o("pointStart",m),o("pointEnd",p),o("rotationAxis",g),o("rotationAngle",0),o("eye",f),this._offset=new D,this._startNorm=new D,this._endNorm=new D,this._cameraScale=new D,this._parentPosition=new D,this._parentQuaternion=new de,this._parentQuaternionInv=new de,this._parentScale=new D,this._worldScaleStart=new D,this._worldQuaternionInv=new de,this._worldScale=new D,this._positionStart=new D,this._quaternionStart=new de,this._scaleStart=new D,this._getPointer=bs.bind(this),this._onPointerDown=vs.bind(this),this._onPointerHover=ys.bind(this),this._onPointerMove=ws.bind(this),this._onPointerUp=xs.bind(this),null!==t&&this.connect()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(e){if(void 0===this.object||!0===this.dragging)return;null!==e&&as.setFromCamera(e,this.camera);const t=Ss(this._gizmo.picker[this.mode],as);this.axis=t?t.object.name:null}pointerDown(e){if(void 0!==this.object&&!0!==this.dragging&&(null==e||0===e.button)&&null!==this.axis){null!==e&&as.setFromCamera(e,this.camera);const t=Ss(this._plane,as,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,ms.mode=this.mode,this.dispatchEvent(ms)}}pointerMove(e){const t=this.axis,s=this.mode,n=this.object;let i=this.space;if("scale"===s?i="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(i="world"),void 0===n||null===t||!1===this.dragging||null!==e&&-1!==e.button)return;null!==e&&as.setFromCamera(e,this.camera);const r=Ss(this._plane,as,!0);if(r){if(this.pointEnd.copy(r.point).sub(this.worldPositionStart),"translate"===s)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===i&&"XYZ"!==t&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===t.indexOf("X")&&(this._offset.x=0),-1===t.indexOf("Y")&&(this._offset.y=0),-1===t.indexOf("Z")&&(this._offset.z=0),"local"===i&&"XYZ"!==t?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),n.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===i&&(n.position.applyQuaternion(hs.copy(this._quaternionStart).invert()),-1!==t.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.position.applyQuaternion(this._quaternionStart)),"world"===i&&(n.parent&&n.position.add(cs.setFromMatrixPosition(n.parent.matrixWorld)),-1!==t.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.parent&&n.position.sub(cs.setFromMatrixPosition(n.parent.matrixWorld)))),n.position.x=Math.max(this.minX,Math.min(this.maxX,n.position.x)),n.position.y=Math.max(this.minY,Math.min(this.maxY,n.position.y)),n.position.z=Math.max(this.minZ,Math.min(this.maxZ,n.position.z));else if("scale"===s){if(-1!==t.search("XYZ")){let e=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(e*=-1),ls.set(e,e,e)}else cs.copy(this.pointStart),ls.copy(this.pointEnd),cs.applyQuaternion(this._worldQuaternionInv),ls.applyQuaternion(this._worldQuaternionInv),ls.divide(cs),-1===t.search("X")&&(ls.x=1),-1===t.search("Y")&&(ls.y=1),-1===t.search("Z")&&(ls.z=1);n.scale.copy(this._scaleStart).multiply(ls),this.scaleSnap&&(-1!==t.search("X")&&(n.scale.x=Math.round(n.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(n.scale.y=Math.round(n.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(n.scale.z=Math.round(n.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===s){this._offset.copy(this.pointEnd).sub(this.pointStart);const e=20/this.worldPosition.distanceTo(cs.setFromMatrixPosition(this.camera.matrixWorld));let s=!1;"XYZE"===t?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(cs.copy(this.rotationAxis).cross(this.eye))*e):"X"!==t&&"Y"!==t&&"Z"!==t||(this.rotationAxis.copy(ds[t]),cs.copy(ds[t]),"local"===i&&cs.applyQuaternion(this.worldQuaternion),cs.cross(this.eye),0===cs.length()?s=!0:this.rotationAngle=this._offset.dot(cs.normalize())*e),("E"===t||s)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===i&&"E"!==t&&"XYZE"!==t?(n.quaternion.copy(this._quaternionStart),n.quaternion.multiply(hs.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),n.quaternion.copy(hs.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),n.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(us),this.dispatchEvent(gs)}}pointerUp(e){null!==e&&0!==e.button||(this.dragging&&null!==this.axis&&(ps.mode=this.mode,this.dispatchEvent(ps)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(e){return this.object=e,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(us),this.dispatchEvent(gs),this.pointStart.copy(this.pointEnd))}getRaycaster(){return as}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function bs(e){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};{const t=this.domElement.getBoundingClientRect();return{x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,button:e.button}}}function ys(e){if(this.enabled)switch(e.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(e))}}function vs(e){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(e)),this.pointerDown(this._getPointer(e)))}function ws(e){this.enabled&&this.pointerMove(this._getPointer(e))}function xs(e){this.enabled&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(e)))}function Ss(e,t,s){const n=t.intersectObject(e,!0);for(let i=0;i<n.length;i++)if(n[i].object.visible||s)return n[i];return!1}const js=new Ie,Es=new D(0,1,0),Os=new D(0,0,0),As=new N,Ms=new de,Ts=new de,Rs=new D,Cs=new N,_s=new D(1,0,0),Ns=new D(0,1,0),Ds=new D(0,0,1),Is=new D,Ls=new D,Ps=new D;class ks extends P{constructor(e){super(),this.isTransformControlsRoot=!0,this.controls=e,this.visible=!1}updateMatrixWorld(e){const t=this.controls;void 0!==t.object&&(t.object.updateMatrixWorld(),null===t.object.parent||t.object.parent.matrixWorld.decompose(t._parentPosition,t._parentQuaternion,t._parentScale),t.object.matrixWorld.decompose(t.worldPosition,t.worldQuaternion,t._worldScale),t._parentQuaternionInv.copy(t._parentQuaternion).invert(),t._worldQuaternionInv.copy(t.worldQuaternion).invert()),t.camera.updateMatrixWorld(),t.camera.matrixWorld.decompose(t.cameraPosition,t.cameraQuaternion,t._cameraScale),t.camera.isOrthographicCamera?t.camera.getWorldDirection(t.eye).negate():t.eye.copy(t.cameraPosition).sub(t.worldPosition).normalize(),super.updateMatrixWorld(e)}dispose(){this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}}class Bs extends P{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new T({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new Y({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),s=e.clone();s.opacity=.15;const n=t.clone();n.opacity=.5;const i=e.clone();i.color.setHex(16711680);const r=e.clone();r.color.setHex(65280);const o=e.clone();o.color.setHex(255);const a=e.clone();a.color.setHex(16711680),a.opacity=.5;const c=e.clone();c.color.setHex(65280),c.opacity=.5;const l=e.clone();l.color.setHex(255),l.opacity=.5;const h=e.clone();h.opacity=.25;const d=e.clone();d.color.setHex(16776960),d.opacity=.25;e.clone().color.setHex(16776960);const u=e.clone();u.color.setHex(7895160);const m=new Ce(0,.04,.1,12);m.translate(0,.05,0);const p=new b(.08,.08,.08);p.translate(0,.04,0);const g=new q;g.setAttribute("position",new _e([0,0,0,1,0,0],3));const v=new Ce(.0075,.0075,.5,3);function w(e,t){const s=new De(e,.0075,3,64,t*Math.PI*2);return s.rotateY(Math.PI/2),s.rotateX(Math.PI/2),s}v.translate(0,.25,0);const x={X:[[new f(m,i),[.5,0,0],[0,0,-Math.PI/2]],[new f(m,i),[-.5,0,0],[0,0,Math.PI/2]],[new f(v,i),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new f(m,r),[0,.5,0]],[new f(m,r),[0,-.5,0],[Math.PI,0,0]],[new f(v,r)]],Z:[[new f(m,o),[0,0,.5],[Math.PI/2,0,0]],[new f(m,o),[0,0,-.5],[-Math.PI/2,0,0]],[new f(v,o),null,[Math.PI/2,0,0]]],XYZ:[[new f(new Ne(.1,0),h.clone()),[0,0,0]]],XY:[[new f(new b(.15,.15,.01),l.clone()),[.15,.15,0]]],YZ:[[new f(new b(.15,.15,.01),a.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new f(new b(.15,.15,.01),c.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},S={X:[[new f(new Ce(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new f(new Ce(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new f(new Ce(.2,0,.6,4),s),[0,.3,0]],[new f(new Ce(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new f(new Ce(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new f(new Ce(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new f(new Ne(.2,0),s)]],XY:[[new f(new b(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new f(new b(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new f(new b(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]]},j={START:[[new f(new Ne(.01,2),n),null,null,null,"helper"]],END:[[new f(new Ne(.01,2),n),null,null,null,"helper"]],DELTA:[[new ee(function(){const e=new q;return e.setAttribute("position",new _e([0,0,0,1,1,1],3)),e}(),n),null,null,null,"helper"]],X:[[new ee(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new ee(g,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new ee(g,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},E={XYZE:[[new f(w(.5,1),u),null,[0,Math.PI/2,0]]],X:[[new f(w(.5,.5),i)]],Y:[[new f(w(.5,.5),r),null,[0,0,-Math.PI/2]]],Z:[[new f(w(.5,.5),o),null,[0,Math.PI/2,0]]],E:[[new f(w(.75,1),d),null,[0,Math.PI/2,0]]]},O={AXIS:[[new ee(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},A={XYZE:[[new f(new y(.25,10,8),s)]],X:[[new f(new De(.5,.1,4,24),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new f(new De(.5,.1,4,24),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new f(new De(.5,.1,4,24),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new f(new De(.75,.1,2,24),s)]]},M={X:[[new f(p,i),[.5,0,0],[0,0,-Math.PI/2]],[new f(v,i),[0,0,0],[0,0,-Math.PI/2]],[new f(p,i),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new f(p,r),[0,.5,0]],[new f(v,r)],[new f(p,r),[0,-.5,0],[0,0,Math.PI]]],Z:[[new f(p,o),[0,0,.5],[Math.PI/2,0,0]],[new f(v,o),[0,0,0],[Math.PI/2,0,0]],[new f(p,o),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new f(new b(.15,.15,.01),l),[.15,.15,0]]],YZ:[[new f(new b(.15,.15,.01),a),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new f(new b(.15,.15,.01),c),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new f(new b(.1,.1,.1),h.clone())]]},R={X:[[new f(new Ce(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new f(new Ce(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new f(new Ce(.2,0,.6,4),s),[0,.3,0]],[new f(new Ce(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new f(new Ce(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new f(new Ce(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new f(new b(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new f(new b(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new f(new b(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new f(new b(.2,.2,.2),s),[0,0,0]]]},C={X:[[new ee(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new ee(g,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new ee(g,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function _(e){const t=new P;for(const s in e)for(let n=e[s].length;n--;){const i=e[s][n][0].clone(),r=e[s][n][1],o=e[s][n][2],a=e[s][n][3],c=e[s][n][4];i.name=s,i.tag=c,r&&i.position.set(r[0],r[1],r[2]),o&&i.rotation.set(o[0],o[1],o[2]),a&&i.scale.set(a[0],a[1],a[2]),i.updateMatrix();const l=i.geometry.clone();l.applyMatrix4(i.matrix),i.geometry=l,i.renderOrder=1/0,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=_(x)),this.add(this.gizmo.rotate=_(E)),this.add(this.gizmo.scale=_(M)),this.add(this.picker.translate=_(S)),this.add(this.picker.rotate=_(A)),this.add(this.picker.scale=_(R)),this.add(this.helper.translate=_(j)),this.add(this.helper.rotate=_(O)),this.add(this.helper.scale=_(C)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const t="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:Ts;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let n=0;n<s.length;n++){const e=s[n];let i;if(e.visible=!0,e.rotation.set(0,0,0),e.position.copy(this.worldPosition),i=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),e.scale.set(1,1,1).multiplyScalar(i*this.size/4),"helper"!==e.tag){if(e.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){const s=.99,n=.2;"X"===e.name&&Math.abs(Es.copy(_s).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"Y"===e.name&&Math.abs(Es.copy(Ns).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"Z"===e.name&&Math.abs(Es.copy(Ds).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"XY"===e.name&&Math.abs(Es.copy(Ds).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"YZ"===e.name&&Math.abs(Es.copy(_s).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"XZ"===e.name&&Math.abs(Es.copy(Ns).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1)}else"rotate"===this.mode&&(Ms.copy(t),Es.copy(this.eye).applyQuaternion(hs.copy(t).invert()),-1!==e.name.search("E")&&e.quaternion.setFromRotationMatrix(As.lookAt(this.eye,Os,Ns)),"X"===e.name&&(hs.setFromAxisAngle(_s,Math.atan2(-Es.y,Es.z)),hs.multiplyQuaternions(Ms,hs),e.quaternion.copy(hs)),"Y"===e.name&&(hs.setFromAxisAngle(Ns,Math.atan2(Es.x,Es.z)),hs.multiplyQuaternions(Ms,hs),e.quaternion.copy(hs)),"Z"===e.name&&(hs.setFromAxisAngle(Ds,Math.atan2(Es.y,Es.x)),hs.multiplyQuaternions(Ms,hs),e.quaternion.copy(hs)));e.visible=e.visible&&(-1===e.name.indexOf("X")||this.showX),e.visible=e.visible&&(-1===e.name.indexOf("Y")||this.showY),e.visible=e.visible&&(-1===e.name.indexOf("Z")||this.showZ),e.visible=e.visible&&(-1===e.name.indexOf("E")||this.showX&&this.showY&&this.showZ),e.material._color=e.material._color||e.material.color.clone(),e.material._opacity=e.material._opacity||e.material.opacity,e.material.color.copy(e.material._color),e.material.opacity=e.material._opacity,this.enabled&&this.axis&&(e.name===this.axis||this.axis.split("").some(function(t){return e.name===t}))&&(e.material.color.setHex(16776960),e.material.opacity=1)}else e.visible=!1,"AXIS"===e.name?(e.visible=!!this.axis,"X"===this.axis&&(hs.setFromEuler(js.set(0,0,0)),e.quaternion.copy(t).multiply(hs),Math.abs(Es.copy(_s).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"Y"===this.axis&&(hs.setFromEuler(js.set(0,0,Math.PI/2)),e.quaternion.copy(t).multiply(hs),Math.abs(Es.copy(Ns).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"Z"===this.axis&&(hs.setFromEuler(js.set(0,Math.PI/2,0)),e.quaternion.copy(t).multiply(hs),Math.abs(Es.copy(Ds).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"XYZE"===this.axis&&(hs.setFromEuler(js.set(0,Math.PI/2,0)),Es.copy(this.rotationAxis),e.quaternion.setFromRotationMatrix(As.lookAt(Os,Es,Ns)),e.quaternion.multiply(hs),e.visible=this.dragging),"E"===this.axis&&(e.visible=!1)):"START"===e.name?(e.position.copy(this.worldPositionStart),e.visible=this.dragging):"END"===e.name?(e.position.copy(this.worldPosition),e.visible=this.dragging):"DELTA"===e.name?(e.position.copy(this.worldPositionStart),e.quaternion.copy(this.worldQuaternionStart),cs.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),cs.applyQuaternion(this.worldQuaternionStart.clone().invert()),e.scale.copy(cs),e.visible=this.dragging):(e.quaternion.copy(t),this.dragging?e.position.copy(this.worldPositionStart):e.position.copy(this.worldPosition),this.axis&&(e.visible=-1!==this.axis.search(e.name)))}super.updateMatrixWorld(e)}}class Hs extends f{constructor(){super(new p(1e5,1e5,2,2),new T({visible:!1,wireframe:!0,side:Z,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(t="local"),Is.copy(_s).applyQuaternion("local"===t?this.worldQuaternion:Ts),Ls.copy(Ns).applyQuaternion("local"===t?this.worldQuaternion:Ts),Ps.copy(Ds).applyQuaternion("local"===t?this.worldQuaternion:Ts),Es.copy(Ls),this.mode){case"translate":case"scale":switch(this.axis){case"X":Es.copy(this.eye).cross(Is),Rs.copy(Is).cross(Es);break;case"Y":Es.copy(this.eye).cross(Ls),Rs.copy(Ls).cross(Es);break;case"Z":Es.copy(this.eye).cross(Ps),Rs.copy(Ps).cross(Es);break;case"XY":Rs.copy(Ps);break;case"YZ":Rs.copy(Is);break;case"XZ":Es.copy(Ps),Rs.copy(Ls);break;case"XYZ":case"E":Rs.set(0,0,0)}break;default:Rs.set(0,0,0)}0===Rs.length()?this.quaternion.copy(this.cameraQuaternion):(Cs.lookAt(cs.set(0,0,0),Rs,Es),this.quaternion.setFromRotationMatrix(Cs)),super.updateMatrixWorld(e)}}class zs{constructor(e,t,s,n){this.scene=e,this.camera=t,this.renderer=s,this.editorStore=n,this.selectedObjects=[],this.lastSelectedObject=null,this.selectableObjects=[],this.raycaster=new Te,this.selectionBox=null,this.createSelectionBox(),this.transformControls=null,this.gizmoMode="translate",this.isDragging=!1,this.initialTransformStates=new Map,this.initializeTransformControls()}saveInitialTransformStates(){this.initialTransformStates.clear();for(const e of this.selectedObjects)e&&e.position&&e.rotation&&e.scale&&this.initialTransformStates.set(e,{position:e.position.clone(),rotation:e.rotation.clone(),scale:e.scale.clone()})}applyTransformToSelectedObjects(){if(!this.lastSelectedObject||!this.transformControls.object||this.selectedObjects.length<=1)return void(this.lastSelectedObject&&this.updateSelectionOutline(this.lastSelectedObject));const e=this.lastSelectedObject,t=this.initialTransformStates.get(e);if(t){for(const s of this.selectedObjects)if(s&&s!==e){const n=this.initialTransformStates.get(s);n&&this.applyRelativeTransform(s,e,t,n)}for(const e of this.selectedObjects)e&&this.updateSelectionOutline(e)}}applyRelativeTransform(e,t,s,n){switch(this.transformControls.getMode()){case"translate":const i=(new D).subVectors(t.position,s.position);e.position.copy(n.position).add(i);break;case"rotate":const r=new Ie(t.rotation.x-s.rotation.x,t.rotation.y-s.rotation.y,t.rotation.z-s.rotation.z);e.rotation.copy(n.rotation),e.rotation.x+=r.x,e.rotation.y+=r.y,e.rotation.z+=r.z;break;case"scale":const o=new D(t.scale.x/s.scale.x,t.scale.y/s.scale.y,t.scale.z/s.scale.z);e.scale.copy(n.scale).multiply(o)}}initializeTransformControls(){try{this.transformControls=new fs(this.camera,this.renderer.domElement),this.transformControls.addEventListener("dragging-changed",e=>{this.isDragging=e.value,e.value?this.saveInitialTransformStates():this.initialTransformStates.clear()}),this.transformControls.addEventListener("change",()=>{this.applyTransformToSelectedObjects()}),this.transformControls.setSize(1);const e=this.transformControls.getHelper();e instanceof P&&(e.renderOrder=999,this.scene.add(e))}catch(e){this.transformControls=null}}createSelectionBox(){this.selectionBox=document.createElement("div"),this.selectionBox.style.position="absolute",this.selectionBox.style.border="2px dashed #007acc",this.selectionBox.style.backgroundColor="rgba(0, 122, 204, 0.1)",this.selectionBox.style.pointerEvents="none",this.selectionBox.style.display="none",this.selectionBox.style.zIndex="1000",document.body.appendChild(this.selectionBox)}isObjectValidForSelection(e){return e&&(e.isMesh||e.isGroup)&&e.userData&&e.visible}selectSingleObject(e){if(e&&this.isObjectValidForSelection(e)){if(this.cleanupSelectedObjects(),this.deselectAllObjects(),this.selectedObjects=[e],this.lastSelectedObject=e,this.editorStore.getState().setSelectedObject(e),this.transformControls&&e.parent){let t=!1,s=e;for(;s.parent;)if(s=s.parent,s===this.scene){t=!0;break}t&&(this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}this.addSelectionOutline(e)}}selectMultipleObjects(e,t=!1){if(e&&Array.isArray(e)){t||this.deselectAllObjects();for(const t of e)t&&!this.selectedObjects.includes(t)&&(this.selectedObjects.push(t),this.lastSelectedObject=t,this.addSelectionOutline(t));this.lastSelectedObject&&this.transformControls&&(this.editorStore.getState().setSelectedObject(this.lastSelectedObject),this.transformControls.attach(this.lastSelectedObject),this.setGizmoMode(this.gizmoMode))}}toggleObjectSelection(e){if(!e)return;const t=this.selectedObjects.indexOf(e);if(t>-1)if(this.selectedObjects.splice(t,1),this.removeSelectionOutline(e),this.lastSelectedObject===e&&(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null),this.selectedObjects.length>0&&this.transformControls){const e=this.lastSelectedObject||this.selectedObjects[0];this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode)}else this.editorStore.getState().setSelectedObject(null),this.lastSelectedObject=null,this.transformControls&&this.transformControls.detach();else this.selectedObjects.push(e),this.lastSelectedObject=e,this.addSelectionOutline(e),this.transformControls&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}deselectAllObjects(){if(this.transformControls)try{this.transformControls.detach()}catch(e){}this.cleanupSelectedObjects();for(const t of this.selectedObjects)if(t)try{this.removeSelectionOutline(t)}catch(e){}this.selectedObjects=[],this.lastSelectedObject=null,this.editorStore.getState().setSelectedObject(null)}cleanupSelectedObjects(){this.selectedObjects=this.selectedObjects.filter(e=>{const t=this.isObjectValidForSelection(e);if(!t)try{this.removeSelectionOutline(e)}catch(s){}return t}),this.lastSelectedObject&&!this.isObjectValidForSelection(this.lastSelectedObject)&&(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null)}handleObjectSelection(e,t=!1){if(this.transformControls&&this.transformControls.dragging)return;this.raycaster.setFromCamera(e,this.camera);const s=this.raycaster.intersectObjects(this.selectableObjects,!0);if(s.length>0){let e=s[0].object;for(;e.parent&&!this.selectableObjects.includes(e);)e=e.parent;if(!e||!this.selectableObjects.includes(e)||!this.isObjectValidForSelection(e))return;t?this.toggleObjectSelection(e):this.selectSingleObject(e)}else t||this.deselectAllObjects()}getObjectsInArea(e,t){const s=[],n=Math.min(e.x,t.x),i=Math.max(e.x,t.x),r=Math.min(e.y,t.y),o=Math.max(e.y,t.y);for(const a of this.selectableObjects){const e=new D;a.getWorldPosition(e),e.project(this.camera),e.x>=n&&e.x<=i&&e.y>=r&&e.y<=o&&s.push(a)}return s}addSelectionOutline(e){if(e)if(e.isGroup||e.children&&e.children.length>0)this.addSelectionOutlineToGroup(e);else if(e.isMesh){this.removeSelectionOutline(e),e.userData.originalMaterial||(e.userData.originalMaterial=e.material);try{const t=e.geometry.clone(),s=new T({color:43775,side:Le,transparent:!0,opacity:.6,depthWrite:!1}),n=new f(t,s);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),n.scale.multiplyScalar(1.03),n.renderOrder=e.renderOrder-1,e.parent?e.parent.add(n):this.scene.add(n),e.userData.outlineObject=n,e.material&&void 0!==e.material.emissive&&(e.userData.originalEmissive=e.material.emissive.clone(),e.userData.originalEmissiveIntensity=e.material.emissiveIntensity||0,e.material.emissive.setHex(4386),e.material.emissiveIntensity=.1)}catch(t){}}}addSelectionOutlineToGroup(e){if(e&&e.traverse){try{e.traverse(t=>{t&&t.isMesh&&t!==e&&this.addSelectionOutlineToSingleMesh(t)})}catch(t){}e.userData&&(e.userData.outlineChildren||(e.userData.outlineChildren=[]))}}addSelectionOutlineToSingleMesh(e){if(e.isMesh){this.removeSelectionOutlineFromMesh(e),e.userData.originalMaterial||(e.userData.originalMaterial=e.material);try{const t=e.geometry.clone(),s=new T({color:43775,side:Le,transparent:!0,opacity:.6,depthWrite:!1}),n=new f(t,s);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),n.scale.multiplyScalar(1.03),n.renderOrder=e.renderOrder-1,e.parent&&e.parent.add(n),e.userData.outlineObject=n,e.material&&void 0!==e.material.emissive&&(e.userData.originalEmissive=e.material.emissive.clone(),e.userData.originalEmissiveIntensity=e.material.emissiveIntensity||0,e.material.emissive.setHex(4386),e.material.emissiveIntensity=.1)}catch(t){}}}removeSelectionOutline(e){e&&(e.isGroup||e.children&&e.children.length>0?this.removeSelectionOutlineFromGroup(e):this.removeSelectionOutlineFromMesh(e))}removeSelectionOutlineFromGroup(e){if(e&&e.traverse){try{e.traverse(t=>{t&&t.isMesh&&t!==e&&this.removeSelectionOutlineFromMesh(t)})}catch(t){}e.userData&&delete e.userData.outlineChildren}}removeSelectionOutlineFromMesh(e){e&&e.userData&&(e.userData.outlineObject&&(e.userData.outlineObject.parent&&e.userData.outlineObject.parent.remove(e.userData.outlineObject),e.userData.outlineObject.geometry&&e.userData.outlineObject.geometry.dispose(),e.userData.outlineObject.material&&e.userData.outlineObject.material.dispose(),delete e.userData.outlineObject),e.material&&void 0!==e.userData.originalEmissive&&(e.material.emissive.copy(e.userData.originalEmissive),e.material.emissiveIntensity=e.userData.originalEmissiveIntensity,delete e.userData.originalEmissive,delete e.userData.originalEmissiveIntensity))}updateSelectionOutline(e){e&&(e.isGroup||e.children&&e.children.length>0?this.updateSelectionOutlineForGroup(e):this.updateSelectionOutlineForMesh(e))}updateSelectionOutlineForGroup(e){if(e&&e.traverse)try{e.traverse(t=>{t&&t.isMesh&&t!==e&&this.updateSelectionOutlineForMesh(t)})}catch(t){}}updateSelectionOutlineForMesh(e){if(!e||!e.userData||!e.userData.outlineObject)return;const t=e.userData.outlineObject;t.position.copy(e.position),t.rotation.copy(e.rotation),t.scale.copy(e.scale),t.scale.multiplyScalar(1.03)}updateAllSelectionOutlines(){this.cleanupSelectedObjects();for(const e of this.selectedObjects)e&&this.updateSelectionOutline(e)}cleanupSelectedObjects(){const e=this.selectedObjects.length;this.selectedObjects=this.selectedObjects.filter(e=>null!=e),this.selectedObjects.length!==e&&(this.selectedObjects.includes(this.lastSelectedObject)||(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null))}setGizmoMode(e){if(!this.transformControls)return;this.gizmoMode=e,this.transformControls.setMode(e);const t=this.editorStore.getState();t.setTransformMode&&t.setTransformMode(e);const s=this.editorStore.getState().selectedObject;s&&!this.transformControls.object&&this.transformControls.attach(s)}updateCamera(e){this.camera=e,this.transformControls&&(this.transformControls.camera=e)}addSelectableObject(e){this.selectableObjects.includes(e)||this.selectableObjects.push(e)}removeSelectableObject(e){const t=this.selectableObjects.indexOf(e);t>-1&&this.selectableObjects.splice(t,1)}updateSelectableObjects(e){this.selectableObjects=[...e]}showSelectionBox(e,t,s,n){this.selectionBox.style.display="block",this.selectionBox.style.left=e+"px",this.selectionBox.style.top=t+"px",this.selectionBox.style.width=s+"px",this.selectionBox.style.height=n+"px"}hideSelectionBox(){this.selectionBox.style.display="none"}getSelectedObjects(){return[...this.selectedObjects]}getSelectableObjects(){return[...this.selectableObjects]}getTransformControls(){return this.transformControls}isDraggingGizmo(){return this.isDragging}dispose(){this.transformControls&&(this.transformControls.dispose(),this.scene.remove(this.transformControls)),this.selectionBox&&this.selectionBox.parentNode&&this.selectionBox.parentNode.removeChild(this.selectionBox)}}class Fs{constructor(e,t,s,n,i=null){this.scene=e,this.renderer=s,this.editorStore=n,this.cameraController=new os(t,s,i),this.objectSelector=new zs(e,t,s,n),this.isMouseDown=!1,this.isPanning=!1,this.isOrbiting=!1,this.isDragSelecting=!1,this.mousePosition=new _,this.previousMousePosition=new _,this.dragStartPosition=new _,this.setupEventListeners()}get camera(){return this.cameraController.getCamera()}set camera(e){this.cameraController.camera=e,this.objectSelector.updateCamera(e)}setupEventListeners(){const e=this.renderer.domElement;this.boundOnMouseDown=this.onMouseDown.bind(this),this.boundOnMouseMove=this.onMouseMove.bind(this),this.boundOnMouseUp=this.onMouseUp.bind(this),this.boundOnWheel=this.onWheel.bind(this),this.boundOnKeyDown=this.onKeyDown.bind(this),this.boundOnKeyUp=this.onKeyUp.bind(this),this.boundOnWindowResize=this.onWindowResize.bind(this),e.addEventListener("mousedown",this.boundOnMouseDown),document.addEventListener("mousemove",this.boundOnMouseMove),document.addEventListener("mouseup",this.boundOnMouseUp),e.addEventListener("wheel",this.boundOnWheel),e.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("keydown",this.boundOnKeyDown),document.addEventListener("keyup",this.boundOnKeyUp),window.addEventListener("resize",this.boundOnWindowResize)}onMouseDown(e){if(this.isMouseDown=!0,this.updateMousePosition(e),this.previousMousePosition.copy(this.mousePosition),this.dragStartPosition.copy(this.mousePosition),0===e.button){if(this.objectSelector.isDraggingGizmo())return;const t=e.ctrlKey||e.metaKey||e.shiftKey;this.isDragSelecting=!0,this.objectSelector.handleObjectSelection(this.mousePosition,t)}else 1===e.button&&(e.preventDefault(),this.isPanning=!0,e.altKey&&(this.isOrbiting=!0,this.isPanning=!1))}onMouseMove(e){if(!this.isMouseDown||this.objectSelector.isDraggingGizmo())return;this.updateMousePosition(e);const t=this.mousePosition.x-this.previousMousePosition.x,s=this.mousePosition.y-this.previousMousePosition.y;this.isDragSelecting&&0===e.button?this.updateSelectionBox(e):this.isPanning?this.cameraController.pan(t,s):this.isOrbiting&&this.cameraController.orbit(t,s),this.previousMousePosition.copy(this.mousePosition)}onMouseUp(e){this.isDragSelecting&&0===e.button&&this.finishDragSelection(e),this.isPanning&&1===e.button&&this.cameraController.updateRotationCenterAfterPan(this.scene,this.objectSelector.getSelectableObjects()),this.isMouseDown=!1,this.isPanning=!1,this.isOrbiting=!1,this.isDragSelecting=!1,this.objectSelector.hideSelectionBox()}onWheel(e){if(e.preventDefault(),this.objectSelector.isDraggingGizmo())return;const t=e.deltaY>0?1:-1;this.cameraController.zoom(.3*t)}onKeyDown(e){const t=this.editorStore.getState().selectedObject;switch(e.code){case"KeyW":this.objectSelector.setGizmoMode("translate");break;case"KeyE":this.objectSelector.setGizmoMode("rotate");break;case"KeyR":this.objectSelector.setGizmoMode("scale");break;case"KeyF":t&&this.cameraController.focusOnObject(t);break;case"Escape":this.objectSelector.deselectAllObjects();break;case"Numpad5":const e=this.cameraController.toggleProjection();this.objectSelector.updateCamera(e);break;case"Numpad1":this.cameraController.setView("front");break;case"Numpad3":this.cameraController.setView("side");break;case"Numpad7":this.cameraController.setView("top");break;case"Numpad9":this.cameraController.setView("bottom");break;case"Numpad0":this.cameraController.resetCamera()}}onKeyUp(e){}onWindowResize(){this.cameraController.handleResize(),this.renderer.setSize(window.innerWidth,window.innerHeight)}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mousePosition.x=(e.clientX-t.left)/t.width*2-1,this.mousePosition.y=-(e.clientY-t.top)/t.height*2+1}updateSelectionBox(e){const t=this.renderer.domElement.getBoundingClientRect(),s=(this.dragStartPosition.x+1)*t.width/2+t.left,n=(1-this.dragStartPosition.y)*t.height/2+t.top,i=e.clientX,r=e.clientY,o=Math.min(s,i),a=Math.min(n,r),c=Math.abs(i-s),l=Math.abs(r-n);(c>5||l>5)&&this.objectSelector.showSelectionBox(o,a,c,l)}finishDragSelection(e){const t=this.renderer.domElement.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*2-1,n=-(e.clientY-t.top)/t.height*2+1,i=(this.dragStartPosition.x+1)*t.width/2,r=(1-this.dragStartPosition.y)*t.height/2,o=(s+1)*t.width/2,a=(1-n)*t.height/2;if(Math.sqrt(Math.pow(o-i,2)+Math.pow(a-r,2))<5)return;const c=this.objectSelector.getObjectsInArea(this.dragStartPosition,{x:s,y:n}),l=e.ctrlKey||e.metaKey||e.shiftKey;c.length>0?this.objectSelector.selectMultipleObjects(c,l):l||this.objectSelector.deselectAllObjects()}addSelectableObject(e){this.objectSelector.addSelectableObject(e)}removeSelectableObject(e){this.objectSelector.removeSelectableObject(e)}updateSelectableObjects(e){this.objectSelector.updateSelectableObjects(e)}getSelectedObjects(){return this.objectSelector.getSelectedObjects()}getSelectableObjects(){return this.objectSelector.getSelectableObjects()}selectObject(e){this.objectSelector.selectSingleObject(e)}findObjectById(e){let t=null;return this.scene.traverse(s=>{s.userData&&s.userData.id===e&&(t=s)}),t}deselectAllObjects(){this.objectSelector.deselectAllObjects()}setGizmoMode(e){this.objectSelector.setGizmoMode(e)}focusOnObject(e){this.cameraController.focusOnObject(e)}updateSelectedOutlines(){this.objectSelector.updateAllSelectionOutlines()}setCameraView(e){this.cameraController.setView(e)}toggleCameraProjection(){const e=this.cameraController.toggleProjection();return this.objectSelector.updateCamera(e),e}getCameraTarget(){return this.cameraController.getTarget()}setCameraTarget(e){this.cameraController.setTarget(e)}resetCamera(){this.cameraController.resetCamera()}get transformControls(){return this.objectSelector.getTransformControls()}get selectedObjects(){return this.objectSelector.getSelectedObjects()}get isDragging(){return this.objectSelector.isDraggingGizmo()}dispose(){const e=this.renderer.domElement;e.removeEventListener("mousedown",this.boundOnMouseDown),document.removeEventListener("mousemove",this.boundOnMouseMove),document.removeEventListener("mouseup",this.boundOnMouseUp),e.removeEventListener("wheel",this.boundOnWheel),document.removeEventListener("keydown",this.boundOnKeyDown),document.removeEventListener("keyup",this.boundOnKeyUp),window.removeEventListener("resize",this.boundOnWindowResize),this.objectSelector.dispose()}}function Us({onEditorControlsReady:t}){const s=e.useRef(null),n=e.useRef(null),i=e.useRef(null),r=e.useRef(new Map);rs(),st();const o=[],v=[],w=()=>{};return e.useEffect(()=>{if(!s.current)return;const e=new a;e.background=new c(3355443);const o=new l(75,window.innerWidth/window.innerHeight,.1,1e3);o.position.set(20,30,20),o.lookAt(0,0,0);const g=new h({antialias:!0});g.setSize(window.innerWidth,window.innerHeight),g.shadowMap.enabled=!0,g.shadowMap.type=d,g.sortObjects=!1,g.autoClear=!1,s.current.appendChild(g.domElement),i.current=e;const v=new Fs(e,o,g,useEditorStore,e=>{});n.current=v,t&&t(v);const w=new u(4210752,.6);e.add(w);const x=new m(16777215,.8);x.position.set(50,50,50),x.castShadow=!0,x.shadow.mapSize.width=1024,x.shadow.mapSize.height=1024,e.add(x);const S=new p(10,10),j=new W({color:8947848}),E=new f(S,j);E.rotation.x=-Math.PI/2,E.receiveShadow=!0,e.add(E);const O=new Pe(10,10);O.position.y=.01,O.material.color.setHex(6710886),e.add(O);const A=new b(2,2,2),M=new W({color:16711680}),T=new f(A,M);T.position.set(0,1,0),T.castShadow=!0,T.userData.name="Test Cube",T.userData.id="test_cube",e.add(T);const R=new Ce(.5,.5,3),C=new W({color:9127187}),N=new f(R,C);N.position.set(5,1.5,0),N.castShadow=!0,N.userData.name="Tree Trunk",N.userData.id="tree_trunk",e.add(N);const I=new y(2),L=new W({color:2263842}),P=new f(I,L);P.position.set(5,4,0),P.castShadow=!0,P.userData.name="Tree Leaves",P.userData.id="tree_leaves",e.add(P),r.current.set("test_cube",T),r.current.set("tree_trunk",N),r.current.set("tree_leaves",P),v.addSelectableObject(T),v.addSelectableObject(N),v.addSelectableObject(P);const k=()=>{requestAnimationFrame(k),T.rotation.y+=.005,n.current&&n.current.updateSelectedOutlines(),g.clear();const t=n.current?n.current.camera:o;g.render(e,t)};k();const B=g.domElement;B.addEventListener("dragover",e=>{e.preventDefault()}),B.addEventListener("drop",t=>{t.preventDefault();try{const s=t.dataTransfer.getData("text/plain");if(s){const n=JSON.parse(s),i=B.getBoundingClientRect(),a=new _;a.x=(t.clientX-i.left)/i.width*2-1,a.y=-(t.clientY-i.top)/i.height*2+1;const c=new Te;c.setFromCamera(a,o);const l=new ke(new D(0,1,0),0),h=new D;c.ray.intersectPlane(l,h);const d=new W({color:5025616,roughness:.3,metalness:.1});let u,m;switch(n.geometry){case"BoxGeometry":u=new b(...n.params);break;case"SphereGeometry":u=new y(...n.params);break;case"CylinderGeometry":u=new Ce(...n.params);break;case"ConeGeometry":u=new Be(...n.params);break;case"PlaneGeometry":u=new p(...n.params);break;case"TorusGeometry":u=new De(...n.params);break;case"CustomGeometry":if(n.glbData){const t=new Uint8Array(n.glbData),s=new Blob([t],{type:"application/octet-stream"}),i=URL.createObjectURL(s);return void(new at).load(i,t=>{const s=t.scene;s.position.copy(h);const o=`${n.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;s.name=o,s.userData={id:o,name:n.name,type:n.type||"custom",originalName:n.name},s.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),e.add(s),v.addSelectableObject(s),r.current.set(o,s);(0,useEditorStore.getState().addObject)({id:o,name:n.name,type:"mesh",position:[h.x,h.y,h.z],rotation:[s.rotation.x,s.rotation.y,s.rotation.z],scale:[1,1,1],visible:!0,userData:s.userData}),URL.revokeObjectURL(i)},void 0,e=>{URL.revokeObjectURL(i)})}u=n.originalObject&&n.originalObject.geometry?n.originalObject.geometry.clone():new b(1,1,1);break;default:u=new b(1,1,1)}m=new f(u,d),m.position.copy(h),"PlaneGeometry"===n.geometry&&(m.rotation.x=-Math.PI/2),m.castShadow=!0,m.receiveShadow=!0;const g=`${n.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;m.name=g,m.userData={id:g,name:n.name,type:n.type||"basic",originalName:n.name},e.add(m),v.addSelectableObject(m),r.current.set(g,m);(0,useEditorStore.getState().addObject)({id:g,name:n.name,type:"mesh",position:[h.x,h.y,h.z],rotation:[m.rotation.x,m.rotation.y,m.rotation.z],scale:[1,1,1],visible:!0,userData:m.userData})}}catch(s){}});const H=()=>{n.current?n.current.onWindowResize():(o.aspect=window.innerWidth/window.innerHeight,o.updateProjectionMatrix(),g.setSize(window.innerWidth,window.innerHeight))};return window.addEventListener("resize",H),()=>{window.removeEventListener("resize",H),n.current&&n.current.dispose(),s.current&&g.domElement&&s.current.removeChild(g.domElement),g.dispose()}},[10,10,()=>{}]),e.useEffect(()=>{if(!i.current||!n.current)return;const e=i.current,t=new at;o.forEach(s=>{if(!r.current.has(s.id))if("glb"===s.type&&s.file)t.load(s.file,t=>{const i=t.scene,o=(new Ee).setFromObject(i),a=o.getSize(new D),c=o.getCenter(new D),l=Math.max(a.x,a.y,a.z);let h=1;l>10?h=5/l:l<.1&&(h=1/l),i.position.sub(c),i.position.set(s.position.x,s.position.y,s.position.z),i.rotation.set(s.rotation.x,s.rotation.y,s.rotation.z),i.scale.set(s.scale.x*h,s.scale.y*h,s.scale.z*h),i.name=s.name,i.userData={id:s.id,type:s.type},i.visible=!1!==s.visible,i.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),e.add(i),n.current.addSelectableObject(i),r.current.set(s.id,i),s.id},e=>{},e=>{});else if("cube"===s.type){const t=new b(s.size.x,s.size.y,s.size.z),i=new g({color:s.material.color}),o=new f(t,i);o.position.set(s.position.x,s.position.y,s.position.z),o.rotation.set(s.rotation.x,s.rotation.y,s.rotation.z),o.name=s.name,o.userData={id:s.id,type:s.type},o.castShadow=!0,o.receiveShadow=!0,e.add(o),n.current.addSelectableObject(o),r.current.set(s.id,o)}});const s=new Set(o.map(e=>e.id));for(const[i,o]of r.current)s.has(i)||(e.remove(o),n.current.removeSelectableObject(o),r.current.delete(i))},[o,w]),e.useEffect(()=>{i.current&&(o.forEach(e=>{const t=r.current.get(e.id);t&&(t.visible=!1!==e.visible)}),v.forEach(e=>{const t=r.current.get(e.id);t&&(t.visible=!1!==e.visible)}))},[o,v]),We.jsx("div",{ref:s,style:{width:"100%",height:"100vh",position:"relative"}})}function Gs({floorWidth:e,floorDepth:t,onFloorSizeChange:s}){return We.jsxs("div",{className:"panel-section floor-size-section",children:[We.jsx("h3",{children:"바닥 크기"}),We.jsxs("div",{className:"floor-size-inputs",children:[We.jsxs("div",{className:"input-group",children:[We.jsx("label",{children:"폭"}),We.jsx("input",{type:"number",min:"1",max:"200",value:e,onChange:e=>{const n=Math.max(1,Math.min(200,Number(e.target.value)||1));s(n,t)},className:"size-input"}),We.jsx("span",{className:"unit",children:"m"})]}),We.jsxs("div",{className:"input-group",children:[We.jsx("label",{children:"깊이"}),We.jsx("input",{type:"number",min:"1",max:"200",value:t,onChange:t=>{const n=Math.max(1,Math.min(200,Number(t.target.value)||1));s(e,n)},className:"size-input"}),We.jsx("span",{className:"unit",children:"m"})]})]})]})}const Vs=e.memo(function({objects:t,walls:s,selectedObject:n,onObjectVisibilityToggle:i,onObjectSelect:r,onObjectRemove:o,onObjectFocus:a,onObjectRename:c,onContextMenu:l,editorControls:h}){const[d,u]=e.useState(null),[m,p]=e.useState(""),g=e.useRef(null),f=e=>{if(h){const t=h.findObjectById(e.id);t&&h.selectObject(t)}else r(e)},b=e=>{if(h){const t=h.findObjectById(e.id);t&&(h.selectObject(t),h.focusOnObject&&h.focusOnObject(t))}else a(e)},y=e=>{m.trim()&&m!==e.name&&c(e,m.trim()),u(null),p("")},v=(e,t)=>{"Enter"===e.key?y(t):"Escape"===e.key?(u(null),p("")):"F2"!==e.key||d||(e.preventDefault(),(e=>{u(e.id),p(e.name),setTimeout(()=>{g.current&&(g.current.focus(),g.current.select())},0)})(t))},w=e=>{const t=`"${e.name||"이름 없음"}"을(를) 삭제하시겠습니까?`;window.confirm(t)&&o(e)};return We.jsxs("div",{className:"panel-section hierarchy-section expanded-section",children:[We.jsxs("h3",{children:["씬 오브젝트 (",t.length+s.length,")"]}),We.jsxs("div",{className:"hierarchy-list",children:[t.length>0&&We.jsxs("div",{className:"hierarchy-category",children:[We.jsxs("div",{className:"category-header",children:[We.jsx("span",{className:"category-icon",children:"📦"}),We.jsxs("span",{children:["모델 (",t.length,")"]})]}),t.map((e,t)=>We.jsxs("div",{className:"hierarchy-item",onKeyDown:t=>v(t,e),onContextMenu:t=>l&&l(t,e),tabIndex:0,children:[We.jsx("button",{className:"visibility-btn",onClick:()=>i(e),title:!1!==e.visible?"숨기기":"보이기",children:!1!==e.visible?"👁️":"🙈"}),d===e.id?We.jsx("input",{ref:g,type:"text",value:m,onChange:e=>p(e.target.value),onBlur:()=>y(e),onKeyDown:t=>v(t,e),className:"object-name-input"}):We.jsx("span",{className:"object-name "+((null==n?void 0:n.id)===e.id?"selected":""),onClick:()=>f(e),onDoubleClick:()=>b(e),title:`모델: ${e.name} (더블클릭: 포커스, F2: 이름변경)`,children:e.name}),We.jsx("button",{className:"delete-btn",onClick:()=>w(e),title:"삭제",children:"🗑️"})]},e.id||t))]}),s.length>0&&We.jsxs("div",{className:"hierarchy-category",children:[We.jsxs("div",{className:"category-header",children:[We.jsx("span",{className:"category-icon",children:"🧱"}),We.jsxs("span",{children:["벽 (",s.length,")"]})]}),s.map((e,t)=>We.jsxs("div",{className:"hierarchy-item",onKeyDown:t=>v(t,e),onContextMenu:t=>l&&l(t,e),tabIndex:0,children:[We.jsx("button",{className:"visibility-btn",onClick:()=>i(e),title:!1!==e.visible?"숨기기":"보이기",children:!1!==e.visible?"👁️":"🙈"}),d===e.id?We.jsx("input",{ref:g,type:"text",value:m,onChange:e=>p(e.target.value),onBlur:()=>y(e),onKeyDown:t=>v(t,e),className:"object-name-input"}):We.jsx("span",{className:"object-name "+((null==n?void 0:n.id)===e.id?"selected":""),onClick:()=>f(e),onDoubleClick:()=>b(e),title:`벽: ${e.name} (더블클릭: 포커스, F2: 이름변경)`,children:e.name}),We.jsx("button",{className:"delete-btn",onClick:()=>w(e),title:"삭제",children:"🗑️"})]},e.id||t))]}),0===t.length&&0===s.length&&We.jsxs("div",{className:"empty-hierarchy",children:[We.jsx("p",{children:"씬에 오브젝트가 없습니다"}),We.jsx("small",{children:"메뉴에서 오브젝트를 추가하세요"})]})]})]})}),Xs=e.memo(function({selectedObject:t}){var s,n;const[i,r]=e.useState({diffuse:null,normal:null,roughness:null}),[o,a]=e.useState(0),[c,l]=e.useState([]);e.useEffect(()=>{if(t&&"function"==typeof t.traverse){const e=[];t.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach((s,n)=>{e.push({material:s,name:s.name||`Material ${e.length}`,meshName:t.name||"Unnamed Mesh",materialIndex:n})}):e.push({material:t.material,name:t.material.name||`Material ${e.length}`,meshName:t.name||"Unnamed Mesh",materialIndex:0}))}),l(e),a(0)}else l([]),a(0)},[t]);const h=(e,s,n)=>{if(!t||"function"!=typeof t.traverse)return;const i=parseFloat(n);isNaN(i)||(t[e]||(t[e]={x:0,y:0,z:0}),"position"===e?t.position[s]=i:"rotation"===e?t.rotation[s]=i*Math.PI/180:"scale"===e&&(t.scale[s]=i))},d=(e,s)=>t&&"function"==typeof t.traverse&&t[e]?void 0===t[e][s]?0:"rotation"===e?(180*t[e][s]/Math.PI).toFixed(1):t[e][s].toFixed(2):0,u=(e,s)=>{if(!s||!t||"function"!=typeof t.traverse||0===c.length)return;const n=URL.createObjectURL(s),i=c[o];if(!i)return;(new k).load(n,t=>{t.wrapS=G,t.wrapT=G,t.flipY=!1;const s=i.material;switch(s.isMeshStandardMaterial,e){case"diffuse":s.map=t;break;case"normal":s.normalMap=t;break;case"roughness":s.roughnessMap=t}s.needsUpdate=!0,r(t=>({...t,[e]:n}))})},m=(e,s)=>{if(!t||"function"!=typeof t.traverse||0===c.length)return;const n=c[o];if(!n)return;const i=n.material;switch(i.isMeshStandardMaterial,e){case"metalness":void 0!==i.metalness&&(i.metalness=parseFloat(s));break;case"roughness":void 0!==i.roughness&&(i.roughness=parseFloat(s));break;case"color":i.color&&i.color.setHex(s.replace("#","0x"))}i.needsUpdate=!0},p=e=>{if(!t||"function"!=typeof t.traverse||0===c.length)return"color"===e?"#ffffff":0;const s=c[o];if(!s)return"color"===e?"#ffffff":0;const n=s.material;switch(e){case"metalness":return n.metalness||0;case"roughness":return n.roughness||.8;case"color":return n.color?"#"+n.color.getHexString():"#ffffff";default:return 0}};return t?We.jsxs("div",{className:"panel-section properties-section",children:[We.jsx("h3",{children:"속성"}),We.jsxs("div",{className:"properties-container",children:[We.jsxs("div",{className:"property-group",children:[We.jsx("h4",{children:"위치 (Position)"}),We.jsxs("div",{className:"vector-inputs",children:[We.jsxs("label",{children:["X:",We.jsx("input",{type:"number",step:"0.1",value:d("position","x"),onChange:e=>h("position","x",e.target.value),className:"vector-input"})]}),We.jsxs("label",{children:["Y:",We.jsx("input",{type:"number",step:"0.1",value:d("position","y"),onChange:e=>h("position","y",e.target.value),className:"vector-input"})]}),We.jsxs("label",{children:["Z:",We.jsx("input",{type:"number",step:"0.1",value:d("position","z"),onChange:e=>h("position","z",e.target.value),className:"vector-input"})]})]})]}),We.jsxs("div",{className:"property-group",children:[We.jsx("h4",{children:"회전 (Rotation)"}),We.jsxs("div",{className:"vector-inputs",children:[We.jsxs("label",{children:["X:",We.jsx("input",{type:"number",step:"1",value:d("rotation","x"),onChange:e=>h("rotation","x",e.target.value),className:"vector-input"}),"°"]}),We.jsxs("label",{children:["Y:",We.jsx("input",{type:"number",step:"1",value:d("rotation","y"),onChange:e=>h("rotation","y",e.target.value),className:"vector-input"}),"°"]}),We.jsxs("label",{children:["Z:",We.jsx("input",{type:"number",step:"1",value:d("rotation","z"),onChange:e=>h("rotation","z",e.target.value),className:"vector-input"}),"°"]})]})]}),We.jsxs("div",{className:"property-group",children:[We.jsx("h4",{children:"크기 (Scale)"}),We.jsxs("div",{className:"vector-inputs",children:[We.jsxs("label",{children:["X:",We.jsx("input",{type:"number",step:"0.1",min:"0.1",value:d("scale","x"),onChange:e=>h("scale","x",e.target.value),className:"vector-input"})]}),We.jsxs("label",{children:["Y:",We.jsx("input",{type:"number",step:"0.1",min:"0.1",value:d("scale","y"),onChange:e=>h("scale","y",e.target.value),className:"vector-input"})]}),We.jsxs("label",{children:["Z:",We.jsx("input",{type:"number",step:"0.1",min:"0.1",value:d("scale","z"),onChange:e=>h("scale","z",e.target.value),className:"vector-input"})]})]})]}),We.jsxs("div",{className:"property-group material-group",children:[We.jsx("h4",{children:"메터리얼 (Material)"}),c.length>1&&We.jsxs("div",{className:"material-selector",children:[We.jsxs("label",{className:"material-select-label",children:["메터리얼 선택:",We.jsx("select",{value:o,onChange:e=>a(Number(e.target.value)),className:"material-select",children:c.map((e,t)=>We.jsxs("option",{value:t,children:[e.name," (",e.meshName,")"]},t))})]}),We.jsxs("div",{className:"material-info",children:["현재: ",null==(s=c[o])?void 0:s.name,(null==(n=c[o])?void 0:n.material.isMeshStandardMaterial)?" (PBR)":" (Basic)"]})]}),0===c.length&&We.jsx("div",{className:"no-material",children:"메터리얼이 없습니다"}),c.length>0&&We.jsxs("div",{className:"material-properties",children:[We.jsxs("label",{className:"material-property",children:["색상:",We.jsx("input",{type:"color",value:p("color"),onChange:e=>m("color",e.target.value),className:"color-input"})]}),We.jsxs("label",{className:"material-property",children:["메탈릭: ",p("metalness"),We.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:p("metalness"),onChange:e=>m("metalness",e.target.value),className:"material-slider"})]}),We.jsxs("label",{className:"material-property",children:["러프니스: ",p("roughness"),We.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:p("roughness"),onChange:e=>m("roughness",e.target.value),className:"material-slider"})]})]}),c.length>0&&We.jsxs("div",{className:"texture-uploads",children:[We.jsxs("div",{className:"texture-upload-group",children:[We.jsxs("label",{className:"texture-label",children:["디퓨즈 텍스처:",We.jsx("input",{type:"file",accept:"image/*",onChange:e=>u("diffuse",e.target.files[0]),className:"texture-input"})]}),i.diffuse&&We.jsx("div",{className:"texture-preview",children:We.jsx("img",{src:i.diffuse,alt:"Diffuse"})})]}),We.jsxs("div",{className:"texture-upload-group",children:[We.jsxs("label",{className:"texture-label",children:["노멀 맵:",We.jsx("input",{type:"file",accept:"image/*",onChange:e=>u("normal",e.target.files[0]),className:"texture-input"})]}),i.normal&&We.jsx("div",{className:"texture-preview",children:We.jsx("img",{src:i.normal,alt:"Normal"})})]}),We.jsxs("div",{className:"texture-upload-group",children:[We.jsxs("label",{className:"texture-label",children:["러프니스 맵:",We.jsx("input",{type:"file",accept:"image/*",onChange:e=>u("roughness",e.target.files[0]),className:"texture-input"})]}),i.roughness&&We.jsx("div",{className:"texture-preview",children:We.jsx("img",{src:i.roughness,alt:"Roughness"})})]})]})]})]})]}):null}),Ks=({onObjectDrop:t,onClose:s,forceRefresh:n=0})=>{const[i,r]=e.useState(!1),[o,a]=e.useState([]),c=e.useRef(null);e.useEffect(()=>{(()=>{const e=JSON.parse(localStorage.getItem("customLibraryObjects")||"[]");a(e)})()},[n]);const l=(e,t)=>{r(!0),c.current=t;const s=document.createElement("canvas");s.width=50,s.height=50;const n=s.getContext("2d");n.fillStyle="rgba(100, 150, 255, 0.8)",n.fillRect(0,0,50,50),n.fillStyle="white",n.font="12px Arial",n.textAlign="center",n.fillText(t.name,25,30),e.dataTransfer.setDragImage(s,25,25),e.dataTransfer.setData("text/plain",JSON.stringify(t))},h=()=>{r(!1),c.current=null},d=e=>{t&&t(e,{x:0,y:0,z:0})};return We.jsxs("div",{className:"library-panel",children:[We.jsx("div",{className:"library-header",children:We.jsx("button",{className:"close-btn",onClick:s,children:We.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:We.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})}),We.jsx("div",{className:"library-content",children:We.jsx("div",{className:"category-section",children:We.jsxs("div",{className:"object-grid",children:[[{id:"cube",name:"정육면체",type:"basic",geometry:"BoxGeometry",params:[1,1,1]},{id:"sphere",name:"구체",type:"basic",geometry:"SphereGeometry",params:[.5,32,16]},{id:"cylinder",name:"원기둥",type:"basic",geometry:"CylinderGeometry",params:[.5,.5,1,32]},{id:"cone",name:"원뿔",type:"basic",geometry:"ConeGeometry",params:[.5,1,32]},{id:"plane",name:"평면",type:"basic",geometry:"PlaneGeometry",params:[1,1]},{id:"torus",name:"도넛",type:"basic",geometry:"TorusGeometry",params:[.5,.2,16,100]}].map(e=>We.jsx("div",{className:"object-item",draggable:!0,onDragStart:t=>l(t,e),onDragEnd:h,onClick:()=>d(e),title:e.name,children:We.jsx("div",{className:"object-thumbnail",children:We.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:["cube"===e.id&&We.jsx("path",{d:"M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L6.04,7.5L12,10.85L17.96,7.5L12,4.15M5,15.91L11,19.29V12.58L5,9.21V15.91M19,15.91V9.21L13,12.58V19.29L19,15.91Z"}),"sphere"===e.id&&We.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"}),"cylinder"===e.id&&We.jsx("path",{d:"M12,2C8.14,2 5,3.79 5,6V18C5,20.21 8.14,22 12,22C15.86,22 19,20.21 19,18V6C19,3.79 15.86,2 12,2M12,4C14.67,4 17,4.9 17,6C17,7.1 14.67,8 12,8C9.33,8 7,7.1 7,6C7,4.9 9.33,4 12,4M7,9.5C8.21,10.72 9.86,11.26 12,11.26C14.14,11.26 15.79,10.72 17,9.5V18C17,19.1 14.67,20 12,20C9.33,20 7,19.1 7,18V9.5Z"}),"cone"===e.id&&We.jsx("path",{d:"M12,2L1,21H23L12,2M12,6L19.53,19H4.47L12,6Z"}),"plane"===e.id&&We.jsx("path",{d:"M3,3V21H21V3H3M19,19H5V5H19V19Z"}),"torus"===e.id&&We.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"})]})})},e.id)),o.map(e=>We.jsxs("div",{className:"object-item custom-object",draggable:!0,onDragStart:t=>l(t,e),onDragEnd:h,onClick:()=>d(e),title:`${e.name} (사용자 정의)`,children:[We.jsx("div",{className:"object-thumbnail",children:e.thumbnail?We.jsx("img",{src:e.thumbnail,alt:e.name,style:{width:"24px",height:"24px",objectFit:"cover",borderRadius:"2px"}}):We.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:We.jsx("path",{d:"M12,2L13.09,8.26L22,9L14.74,14.74L17.18,22L12,18.5L6.82,22L9.26,14.74L2,9L10.91,8.26L12,2Z"})})}),We.jsx("button",{className:"delete-btn",onClick:t=>((e,t)=>{if(t.stopPropagation(),window.confirm(`"${e.name}"을(를) 라이브러리에서 삭제하시겠습니까?`)){e.glbUrl&&URL.revokeObjectURL(e.glbUrl);const t=JSON.parse(localStorage.getItem("customLibraryObjects")||"[]").filter(t=>t.id!==e.id);localStorage.setItem("customLibraryObjects",JSON.stringify(t)),a(t)}})(e,t),title:"삭제",children:We.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:We.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]},e.id))]})})})]})},Ys=({x:t,y:s,isVisible:n,onClose:i,onDelete:r,selectedObject:o})=>{const a=e.useRef(null);if(e.useEffect(()=>{const e=e=>{a.current&&!a.current.contains(e.target)&&i()},t=e=>{"Escape"===e.key&&i()};if(n)return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[n,i]),!n)return null;const c=Math.min(t,window.innerWidth-200),l=Math.min(s,window.innerHeight-150);return We.jsxs("div",{ref:a,className:"context-menu",style:{left:c,top:l},children:[We.jsx("div",{className:"context-menu-header",children:We.jsx("span",{children:"메쉬 옵션"})}),We.jsxs("div",{className:"context-menu-items",children:[We.jsxs("button",{className:"context-menu-item disabled",disabled:!0,children:[We.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:We.jsx("path",{d:"M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"})}),We.jsx("span",{children:"복제 (곧 제공)"})]}),We.jsxs("button",{className:"context-menu-item delete-item",onClick:()=>{o&&r?window.confirm(`"${o.name||"이름 없음"}"을(를) 삭제하시겠습니까?`)&&r(o):alert("선택된 객체가 없습니다. 3D 뷰에서 객체를 클릭하여 선택해주세요."),i()},disabled:!o,children:[We.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:We.jsx("path",{d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})}),We.jsx("span",{children:"삭제"})]})]}),o&&We.jsx("div",{className:"context-menu-info",children:We.jsx("span",{className:"selected-object-name",children:o.name||"이름 없음"})})]})},Ws=({message:t,type:s="info",isVisible:n,onClose:i})=>{if(e.useEffect(()=>{if(n){const e=setTimeout(()=>{i()},3e3);return()=>clearTimeout(e)}},[n,i]),!n)return null;return We.jsxs("div",{className:`toast toast-${s} ${n?"toast-visible":""}`,children:[We.jsx("div",{className:"toast-icon",children:(()=>{switch(s){case"success":return"✓";case"error":return"✕";case"warning":return"⚠";default:return"ℹ"}})()}),We.jsx("div",{className:"toast-message",children:t}),We.jsx("button",{className:"toast-close",onClick:i,children:"×"})]})};function Zs({editorControls:t}){const s=rs(),n=st(),[i,r]=e.useState(()=>s.getState());e.useState(""),e.useState("");const[o,a]=e.useState(!1),[c,l]=e.useState({isVisible:!1,x:0,y:0}),[h,d]=e.useState(0),[u,m]=e.useState({message:"",type:"info",isVisible:!1});e.useEffect(()=>{const e=()=>{r(s.getState())},t=n.subscribe("OBJECT_ADDED",e),i=n.subscribe("OBJECT_DELETED",e),o=n.subscribe("OBJECT_SELECTED",e),a=n.subscribe("OBJECT_UPDATED",e),c=n.subscribe("SCENE_CHANGED",e);return()=>{t(),i(),o(),a(),c()}},[s,n]);const{selectedObjects:p=[],transformMode:g="translate",floorWidth:f=10,floorDepth:b=10,objects:y=[],walls:v=[]}=i,w=p.length>0?p[0]:null;e.useEffect(()=>{const e=e=>{"f"!==e.key&&"F"!==e.key||(e.preventDefault(),(null==w?void 0:w.id)&&S(w))},t=e=>{w&&(e.preventDefault(),l({isVisible:!0,x:e.clientX,y:e.clientY}))};return window.addEventListener("keydown",e),window.addEventListener("contextmenu",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("contextmenu",t)}},[w]);const x=e=>{if(!e)return t&&t.deselectAllObjects(),void s.selectObject(null);if(t){const s=t.findObjectById(e.id);s&&t.selectObject(s)}s.selectObject(e.id)},S=e=>{if(x(e),t){const s=t.findObjectById(e.id);s&&t.focusOnObject(s)}},j=e=>{try{s.removeObject(e.id),w&&w.id===e.id&&s.selectObject(null)}catch(t){}};return We.jsxs("div",{className:"editor-ui",children:[We.jsx("div",{className:"tool-panel",children:We.jsx("div",{className:"tool-section",children:We.jsx("button",{className:"tool-btn library-btn "+(o?"active":""),onClick:()=>{a(!o)},title:"라이브러리",children:We.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:We.jsx("path",{d:"M4,6H20V8H4V6M4,11H20V13H4V11M4,16H20V18H4V16Z"})})})})}),o&&We.jsx(Ks,{onObjectDrop:(e,t)=>{const n={id:Date.now(),type:"glb",file:e.file,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:e.name};s.addObject(n),setTimeout(()=>{s.selectObject(n.id)},100)},onClose:()=>a(!1),forceRefresh:h}),We.jsx(Ws,{message:u.message,type:u.type,isVisible:u.isVisible,onClose:()=>{m(e=>({...e,isVisible:!1}))}}),We.jsx(Ys,{x:c.x,y:c.y,isVisible:c.isVisible,onClose:()=>{l({isVisible:!1,x:0,y:0})},onDelete:j,selectedObject:w}),We.jsxs("div",{className:"right-panel",children:[We.jsx(Gs,{floorWidth:f,floorDepth:b,onFloorSizeChange:(e,t)=>{s.setFloorSize(e,t)}}),We.jsx(Vs,{objects:y,walls:v,selectedObject:w,onObjectVisibilityToggle:e=>{s.toggleObjectVisibility(e.id)},onObjectSelect:x,onObjectRemove:j,onObjectFocus:S,onObjectRename:(e,t)=>{try{e.name;if(s.renameObject(e.id,t),(null==w?void 0:w.id)===e.id){const e={...w,name:t};s.selectObject(e.id)}}catch(n){}},onContextMenu:(e,t)=>{e.preventDefault(),x(t),l({isVisible:!0,x:e.clientX,y:e.clientY})},editorControls:t}),We.jsx(Xs,{selectedObject:w})]})]})}const Qs=({onMenuAction:t,historyState:n={}})=>{const[i,r]=e.useState(null),o=e=>{e.target.closest(".menu-bar")||r(null)};return s.useEffect(()=>(document.addEventListener("click",o),()=>{document.removeEventListener("click",o)}),[]),We.jsx("div",{className:"menu-bar",children:We.jsx("div",{className:"menu-items",children:[{title:"파일",items:[{label:"새 맵",action:"new-map",shortcut:"Ctrl+N"},{label:"불러오기",action:"load-map",shortcut:"Ctrl+O"},{label:"저장하기",action:"save-map",shortcut:"Ctrl+S"},{type:"separator"},{label:"임포트",action:"import"},{label:"익스포트",action:"export"},{type:"separator"},{label:"나가기",action:"exit",shortcut:"Alt+F4"}]},{title:"에디터",items:[{label:"실행 취소",action:"undo",shortcut:"Ctrl+Z"},{label:"다시 실행",action:"redo",shortcut:"Ctrl+Y"},{type:"separator"},{label:"복사",action:"copy",shortcut:"Ctrl+C"},{label:"붙여넣기",action:"paste",shortcut:"Ctrl+V"},{label:"삭제",action:"delete",shortcut:"Delete"},{type:"separator"},{label:"전체 선택",action:"select-all",shortcut:"Ctrl+A"},{label:"선택 해제",action:"deselect-all",shortcut:"Ctrl+D"}]},{title:"윈도우",items:[{label:"뷰포트 리셋",action:"reset-viewport"},{label:"카메라 리셋",action:"reset-camera"},{type:"separator"},{label:"그리드 토글",action:"toggle-grid"},{label:"통계 표시",action:"toggle-stats"},{type:"separator"},{label:"전체화면",action:"fullscreen",shortcut:"F11"}]},{title:"정보",items:[{label:"단축키",action:"show-shortcuts"},{label:"도움말",action:"show-help",shortcut:"F1"},{type:"separator"},{label:"프로그램 정보",action:"about"}]}].map((e,s)=>We.jsxs("div",{className:"menu-item "+(i===s?"active":""),onClick:()=>{var e;r(i===(e=s)?null:e)},children:[We.jsx("span",{className:"menu-title",children:e.title}),i===s&&We.jsx("div",{className:"dropdown-menu",children:e.items.map((e,s)=>"separator"===e.type?We.jsx("div",{className:"menu-separator"},s):We.jsxs("div",{className:"dropdown-item "+("undo"===e.action&&!n.canUndo||"redo"===e.action&&!n.canRedo?"disabled":""),onClick:s=>{var i;(s.stopPropagation(),"undo"===e.action&&!n.canUndo||"redo"===e.action&&!n.canRedo)||(i=e.action,r(null),t&&t(i))},children:[We.jsxs("span",{className:"item-label",children:[e.label,"undo"===e.action&&n.undoDescription&&` (${n.undoDescription})`,"redo"===e.action&&n.redoDescription&&` (${n.redoDescription})`]}),e.shortcut&&We.jsx("span",{className:"item-shortcut",children:e.shortcut})]},s))})]},s))})})},qs={SCENE_CREATED:"scene:created",SCENE_LOADED:"scene:loaded",SCENE_SAVED:"scene:saved",SCENE_CHANGED:"scene:changed",OBJECT_CREATED:"object:created",OBJECT_SELECTED:"object:selected",OBJECT_DESELECTED:"object:deselected",OBJECT_MOVED:"object:moved",OBJECT_ROTATED:"object:rotated",OBJECT_SCALED:"object:scaled",OBJECT_DELETED:"object:deleted",OBJECT_PROPERTIES_CHANGED:"object:properties_changed",EDITOR_MODE_CHANGED:"editor:mode_changed",EDITOR_TOOL_CHANGED:"editor:tool_changed",EDITOR_CAMERA_CHANGED:"editor:camera_changed",EDITOR_GRID_TOGGLED:"editor:grid_toggled",UI_PANEL_OPENED:"ui:panel_opened",UI_PANEL_CLOSED:"ui:panel_closed",UI_NOTIFICATION:"ui:notification",UI_LOADING_START:"ui:loading_start",UI_LOADING_END:"ui:loading_end",RENDER_FRAME:"render:frame",RENDER_QUALITY_CHANGED:"render:quality_changed",RENDER_SHADOWS_TOGGLED:"render:shadows_toggled",PERFORMANCE_UPDATE:"performance:update",PERFORMANCE_WARNING:"performance:warning",HISTORY_UNDO:"history:undo",HISTORY_REDO:"history:redo",HISTORY_CLEARED:"history:cleared",ERROR_OCCURRED:"error:occurred",WARNING_OCCURRED:"warning:occurred"};const $s=new class{constructor(){this.listeners=new Map,this.onceListeners=new Map,this.debugMode=!1,this.eventHistory=[],this.maxHistorySize=1e3}subscribe(e,t,s=null){if("function"!=typeof t)throw new Error("Event handler must be a function");this.listeners.has(e)||this.listeners.set(e,[]);const n={handler:s?t.bind(s):t,originalHandler:t,context:s};return this.listeners.get(e).push(n),this.debugMode,()=>this.unsubscribe(e,t,s)}subscribeOnce(e,t,s=null){if("function"!=typeof t)throw new Error("Event handler must be a function");this.onceListeners.has(e)||this.onceListeners.set(e,[]);const n={handler:s?t.bind(s):t,originalHandler:t,context:s};return this.onceListeners.get(e).push(n),this.debugMode,()=>this.unsubscribeOnce(e,t,s)}unsubscribe(e,t,s=null){const n=this.listeners.get(e);if(!n)return!1;const i=n.findIndex(e=>e.originalHandler===t&&e.context===s);return-1!==i&&(n.splice(i,1),0===n.length&&this.listeners.delete(e),this.debugMode,!0)}unsubscribeOnce(e,t,s=null){const n=this.onceListeners.get(e);if(!n)return!1;const i=n.findIndex(e=>e.originalHandler===t&&e.context===s);return-1!==i&&(n.splice(i,1),0===n.length&&this.onceListeners.delete(e),this.debugMode,!0)}publish(e,t=null,s={}){const n=Date.now(),i={type:e,data:t,timestamp:n,options:s};this.addToHistory(i),this.debugMode;const r=this.listeners.get(e);r&&r.forEach(t=>{try{t.handler(i)}catch(s){e!==qs.ERROR_OCCURRED&&this.publish(qs.ERROR_OCCURRED,{source:"EventBus",originalEvent:e,error:s.message,stack:s.stack})}});const o=this.onceListeners.get(e);return o&&(o.forEach(e=>{try{e.handler(i)}catch(t){}}),this.onceListeners.delete(e)),i}clear(){this.listeners.clear(),this.onceListeners.clear(),this.eventHistory=[],this.debugMode}clearEventType(e){this.listeners.delete(e),this.onceListeners.delete(e),this.debugMode}addToHistory(e){this.eventHistory.push(e),this.eventHistory.length>this.maxHistorySize&&this.eventHistory.shift()}getHistory(e=null,t=100){let s=this.eventHistory;return e&&(s=s.filter(t=>t.type===e)),s.slice(-t)}setDebugMode(e){this.debugMode=e}getListenerCount(e){var t,s;return((null==(t=this.listeners.get(e))?void 0:t.length)||0)+((null==(s=this.onceListeners.get(e))?void 0:s.length)||0)}getStats(){const e={totalEventTypes:new Set([...this.listeners.keys(),...this.onceListeners.keys()]).size,totalListeners:0,eventTypes:{}};for(const[t,s]of this.listeners)e.eventTypes[t]=(e.eventTypes[t]||0)+s.length,e.totalListeners+=s.length;for(const[t,s]of this.onceListeners)e.eventTypes[t]=(e.eventTypes[t]||0)+s.length,e.totalListeners+=s.length;return e.historySize=this.eventHistory.length,e.debugMode=this.debugMode,e}},Js="새 맵을 만들면 현재 작업이 사라집니다. 계속하시겠습니까?",en="익스포트 기능은 준비 중입니다.",tn="에디터를 종료하시겠습니까?",sn="복사 기능은 준비 중입니다.",nn="붙여넣기 기능은 준비 중입니다.",rn="삭제 기능은 준비 중입니다.",on="전체 선택 기능은 준비 중입니다.",an="선택 해제 기능은 준비 중입니다.",cn="뷰포트 리셋 기능은 준비 중입니다.",ln="카메라 리셋: 키패드 0번을 누르세요.",hn="그리드 토글 기능은 준비 중입니다.",dn="통계 표시 기능은 준비 중입니다.",un="단축키 정보:\nW/E/R: 기즈모 모드\nF: 오브젝트 포커스\nESC: 선택 해제\n키패드 0: 카메라 리셋\n키패드 5: 카메라 모드 토글\n키패드 1/3/7/9: 뷰 변경",mn="도움말:\n• 좌클릭: 오브젝트 선택\n• Shift+좌클릭: 다중 선택\n• 중간클릭: 팬 이동\n• Alt+중간클릭: 카메라 회전\n• 마우스 휠: 줌",pn="ThirdPersonTreeJS Editor\nVersion 1.0.0\n3D 에디터 프로그램";function gn(){const t=n(),s=rs(),{subscribe:i,publish:r}=st(),[o,a]=e.useState(null),[c,l]=e.useState(""),[h,d]=e.useState({canUndo:!1,canRedo:!1,undoDescription:null,redoDescription:null}),u=e.useRef(null);e.useEffect(()=>{const e=i(qs.HISTORY_UNDO,()=>{d(e=>({...e,canUndo:s.historyManager.canUndo()}))}),t=i(qs.HISTORY_REDO,()=>{d(e=>({...e,canRedo:s.historyManager.canRedo()}))});return()=>{e(),t()}},[i,s]);e.useEffect(()=>{const e=e=>{if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.ctrlKey||e.metaKey))switch(e.key.toLowerCase()){case"z":e.shiftKey?(e.preventDefault(),h.canRedo&&s.redo()):(e.preventDefault(),h.canUndo&&s.undo());break;case"y":e.preventDefault(),h.canRedo&&s.redo()}};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},[h,undo,redo]);const m=()=>{if("save"===o&&c.trim())s.saveMap(c.trim()),alert(`맵이 "${c.trim()}"으로 저장되었습니다.`);else if("load"===o&&c.trim()){s.loadMap(c.trim())?alert(`맵 "${c.trim()}"을 불러왔습니다.`):alert(`맵 "${c.trim()}"을 찾을 수 없습니다.`)}a(null),l("")},p=()=>{a(null),l("")};return We.jsxs("div",{className:"editor-page",children:[We.jsx(Qs,{onMenuAction:e=>{switch(e){case"new-map":confirm(Js)&&s.clearMap();break;case"load-map":a("load");break;case"save-map":a("save");break;case"import":(()=>{const e=document.createElement("input");e.type="file",e.accept=".glb,.gltf",e.multiple=!1,e.onchange=e=>{const t=e.target.files[0];if(!t)return;const n=URL.createObjectURL(t),i=t.name.replace(/\.[^/.]+$/,""),r={id:Date.now(),type:"glb",file:n,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:i};s.addObject(r),setTimeout(()=>{s.selectObject(r.id)},100)},e.click()})();break;case"export":alert(en);break;case"exit":confirm(tn)&&t("/");break;case"undo":h.canUndo&&s.undo();break;case"redo":h.canRedo&&s.redo();break;case"copy":alert(sn);break;case"paste":alert(nn);break;case"delete":alert(rn);break;case"select-all":alert(on);break;case"deselect-all":alert(an);break;case"reset-viewport":alert(cn);break;case"reset-camera":alert(ln);break;case"toggle-grid":alert(hn);break;case"toggle-stats":alert(dn);break;case"fullscreen":document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();break;case"show-shortcuts":alert(un);break;case"show-help":alert(mn);break;case"about":alert(pn)}},historyState:h}),We.jsxs("div",{className:"editor-container",children:[We.jsx(Us,{onEditorControlsReady:e=>{u.current=e}}),We.jsx(Zs,{editorControls:u.current})]}),o&&We.jsx("div",{className:"dialog-overlay",children:We.jsxs("div",{className:"dialog",children:[We.jsx("h3",{children:"save"===o?"맵 저장":"맵 불러오기"}),We.jsx("input",{type:"text",value:c,onChange:e=>l(e.target.value),placeholder:"맵 이름을 입력하세요",autoFocus:!0,onKeyDown:e=>{"Enter"===e.key&&m(),"Escape"===e.key&&p()}}),We.jsxs("div",{className:"dialog-buttons",children:[We.jsx("button",{onClick:m,children:"확인"}),We.jsx("button",{onClick:p,children:"취소"})]})]})})]})}const fn="singleton",bn="transient",yn="scoped",vn="EventBus",wn="SceneManager",xn="ObjectFactory",Sn="SelectionManager",jn="HistoryManager",En="RenderManager",On="PerformanceMonitor",An="StorageRepository",Mn="AssetLoader",Tn="ConfigManager",Rn="NotificationService",Cn="ThemeService";class _n{constructor(e,t,s=fn,n=[]){this.token=e,this.factory=t,this.lifecycle=s,this.dependencies=n,this.instance=null,this.creating=!1}}class Nn{constructor(e){this.container=e,this.operations=[]}register(e,t,s,n){return this.operations.push(()=>this.container.register(e,t,s,n)),this}registerClass(e,t,s,n){return this.operations.push(()=>this.container.registerClass(e,t,s,n)),this}registerInstance(e,t){return this.operations.push(()=>this.container.registerInstance(e,t)),this}execute(){return this.operations.forEach(e=>e()),this.container}}const Dn=new class{constructor(){this.services=new Map,this.scopedInstances=new Map,this.debugMode=!1,this.metrics={resolutions:0,creations:0,circularDetections:0}}register(e,t,s=fn,n=[]){if("function"!=typeof t)throw new Error(`Factory for ${e} must be a function`);const i=new _n(e,t,s,n);return this.services.set(e,i),this.debugMode,this}registerClass(e,t,s=fn,n=[]){return this.register(e,e=>{const s=n.map(t=>e.resolve(t));return new t(...s)},s,n)}registerInstance(e,t){const s=new _n(e,()=>t,fn,[]);return s.instance=t,this.services.set(e,s),this.debugMode,this}resolve(e){this.metrics.resolutions++;const t=this.services.get(e);if(!t)throw new Error(`Service ${e} is not registered`);if(t.creating)throw this.metrics.circularDetections++,new Error(`Circular dependency detected while creating ${e}`);switch(t.lifecycle){case fn:return this.resolveSingleton(t);case bn:return this.resolveTransient(t);case yn:return this.resolveScoped(t);default:throw new Error(`Unknown lifecycle: ${t.lifecycle}`)}}resolveSingleton(e){if(null===e.instance){e.creating=!0;try{e.instance=e.factory(this),this.metrics.creations++,this.debugMode}finally{e.creating=!1}}return e.instance}resolveTransient(e){e.creating=!0;try{const t=e.factory(this);return this.metrics.creations++,this.debugMode,t}finally{e.creating=!1}}resolveScoped(e){const t=this.getCurrentScope(),s=this.scopedInstances.get(t)||new Map;if(!s.has(e.token)){e.creating=!0;try{const n=e.factory(this);s.set(e.token,n),this.scopedInstances.set(t,s),this.metrics.creations++,this.debugMode}finally{e.creating=!1}}return s.get(e.token)}getCurrentScope(){return"default"}isRegistered(e){return this.services.has(e)}unregister(e){const t=this.services.get(e);return!!t&&(t.instance&&"function"==typeof t.instance.dispose&&t.instance.dispose(),this.services.delete(e),this.debugMode,!0)}clear(){for(const t of this.services.values())if(t.instance&&"function"==typeof t.instance.dispose)try{t.instance.dispose()}catch(e){}for(const t of this.scopedInstances.values())for(const s of t.values())if("function"==typeof s.dispose)try{s.dispose()}catch(e){}this.services.clear(),this.scopedInstances.clear(),this.debugMode}clearScope(e=null){const t=e||this.getCurrentScope(),s=this.scopedInstances.get(t);if(s){for(const e of s.values())if("function"==typeof e.dispose)try{e.dispose()}catch(n){}this.scopedInstances.delete(t),this.debugMode}}getStats(){const e={totalServices:this.services.size,singletonInstances:0,scopedInstances:0,lifecycleBreakdown:{singleton:0,transient:0,scoped:0},metrics:{...this.metrics}};for(const t of this.services.values())e.lifecycleBreakdown[t.lifecycle]++,t.lifecycle===fn&&t.instance&&e.singletonInstances++;for(const t of this.scopedInstances.values())e.scopedInstances+=t.size;return e}getDependencyGraph(){const e={nodes:[],edges:[]};for(const[t,s]of this.services){e.nodes.push({id:t,lifecycle:s.lifecycle,hasInstance:null!==s.instance});for(const n of s.dependencies)e.edges.push({from:n,to:t})}return e}setDebugMode(e){this.debugMode=e}batch(){return new Nn(this)}};class In extends ISceneManager{constructor(e,t){super(),this.eventBus=e,this.storageRepository=t,this.currentScene=null,this.sceneHistory=[],this.maxHistorySize=10}async createScene(e="New Scene"){try{const t=new EditorSceneEntity(e);this.setCurrentScene(t);const s=new Object3DEntity("ground","Ground","plane");return s.setScale(20,1,20),s.setPosition(0,0,0),t.addObject(s),this.eventBus.publish(qs.SCENE_CREATED,{scene:t}),t}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"SceneManagerService.createScene",error:t.message}),t}}async loadScene(e){try{const t=await this.storageRepository.load(`scene_${e}`);if(!t)throw new Error(`Scene ${e} not found`);const s=EditorSceneEntity.fromJSON(t);return this.setCurrentScene(s),s}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"SceneManagerService.loadScene",error:t.message,sceneId:e}),t}}async saveScene(e){try{if(e||(e=this.currentScene),!e)throw new Error("No scene to save");const t=e.toJSON();return await this.storageRepository.save(`scene_${e.id}`,t),await this.updateSceneMetadata(e),e.id}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"SceneManagerService.saveScene",error:t.message}),t}}async deleteScene(e){try{await this.storageRepository.delete(`scene_${e}`);const t=await this.getSceneMetadata();return delete t[e],await this.storageRepository.save("scene_metadata",t),!0}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"SceneManagerService.deleteScene",error:t.message,sceneId:e}),t}}getCurrentScene(){return this.currentScene}setCurrentScene(e){this.currentScene!==e&&(this.currentScene&&this.addToHistory(this.currentScene),this.currentScene=e)}addToHistory(e){this.sceneHistory.unshift(e),this.sceneHistory.length>this.maxHistorySize&&(this.sceneHistory=this.sceneHistory.slice(0,this.maxHistorySize))}async getSceneList(){try{const e=await this.getSceneMetadata();return Object.values(e)}catch(e){return[]}}async getSceneMetadata(){try{return await this.storageRepository.load("scene_metadata")||{}}catch(e){return{}}}async updateSceneMetadata(e){const t=await this.getSceneMetadata();t[e.id]={id:e.id,name:e.name,createdAt:e.createdAt,updatedAt:e.updatedAt,objectCount:e.getAllObjects().length,thumbnail:null},await this.storageRepository.save("scene_metadata",t)}}class Ln extends IObjectFactory{constructor(e,t){super(),this.eventBus=e,this.assetLoader=t,this.objectCreators=new Map,this.templates=new Map,this.initializeDefaultCreators()}initializeDefaultCreators(){this.registerCreator("cube",this.createCube.bind(this)),this.registerCreator("sphere",this.createSphere.bind(this)),this.registerCreator("plane",this.createPlane.bind(this)),this.registerCreator("cylinder",this.createCylinder.bind(this)),this.registerCreator("directional-light",this.createDirectionalLight.bind(this)),this.registerCreator("point-light",this.createPointLight.bind(this)),this.registerCreator("ambient-light",this.createAmbientLight.bind(this)),this.registerCreator("gltf-model",this.createGLTFModel.bind(this))}registerCreator(e,t){if("function"!=typeof t)throw new Error("Creator must be a function");this.objectCreators.set(e,t)}async createObject(e,t={}){try{const s=this.objectCreators.get(e);if(!s)throw new Error(`Unknown object type: ${e}`);const n=await s(t);return n.setMetadata("createdBy","ObjectFactory"),n.setMetadata("createdAt",(new Date).toISOString()),n}catch(s){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"ObjectFactoryService.createObject",error:s.message,type:e,config:t}),s}}async cloneObject(e,t){try{const s=t.getCurrentScene();if(!s)throw new Error("No current scene");const n=s.getObject(e);if(!n)throw new Error(`Object ${e} not found`);const i=n.clone();return i.setMetadata("clonedFrom",e),i.setMetadata("clonedAt",(new Date).toISOString()),i}catch(s){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"ObjectFactoryService.cloneObject",error:s.message,objectId:e}),s}}getSupportedTypes(){return Array.from(this.objectCreators.keys())}async createCube(e){const{name:t="Cube",size:s=1}=e,n=new Object3DEntity(`cube_${Date.now()}`,t,"cube");return n.setMetadata("geometry",{type:"box",size:s}),n}async createSphere(e){const{name:t="Sphere",radius:s=1}=e,n=new Object3DEntity(`sphere_${Date.now()}`,t,"sphere");return n.setMetadata("geometry",{type:"sphere",radius:s}),n}async createPlane(e){const{name:t="Plane",width:s=1,height:n=1}=e,i=new Object3DEntity(`plane_${Date.now()}`,t,"plane");return i.setMetadata("geometry",{type:"plane",width:s,height:n}),i}async createCylinder(e){const{name:t="Cylinder",radius:s=1,height:n=2}=e,i=new Object3DEntity(`cylinder_${Date.now()}`,t,"cylinder");return i.setMetadata("geometry",{type:"cylinder",radius:s,height:n}),i}async createDirectionalLight(e){const{name:t="Directional Light",intensity:s=1,color:n="#ffffff"}=e,i=new Object3DEntity(`dir_light_${Date.now()}`,t,"directional-light");return i.setMetadata("light",{type:"directional",intensity:s,color:n}),i.setPosition(10,10,5),i}async createPointLight(e){const{name:t="Point Light",intensity:s=1,color:n="#ffffff",distance:i=0}=e,r=new Object3DEntity(`point_light_${Date.now()}`,t,"point-light");return r.setMetadata("light",{type:"point",intensity:s,color:n,distance:i}),r.setPosition(0,5,0),r}async createAmbientLight(e){const{name:t="Ambient Light",intensity:s=.5,color:n="#404040"}=e,i=new Object3DEntity(`ambient_light_${Date.now()}`,t,"ambient-light");return i.setMetadata("light",{type:"ambient",intensity:s,color:n}),i}async createGLTFModel(e){const{name:t="Model",url:s,scale:n=1}=e;if(!s)throw new Error("GLTF model URL is required");const i=await this.assetLoader.loadModel(s),r=new Object3DEntity(`gltf_${Date.now()}`,t,"gltf-model");return r.setMetadata("model",{url:s,originalData:i}),r.setScale(n,n,n),r}}class Pn{constructor(e,t,s,n,i,r){this.eventBus=e,this.sceneManager=t,this.objectFactory=s,this.selectionManager=n,this.historyManager=i,this.renderManager=r,this.editorMode="select",this.gridVisible=!0,this.snapToGrid=!1,this.gridSize=1,this.setupEventHandlers()}setupEventHandlers(){this.eventBus.subscribe(qs.OBJECT_SELECTED,e=>{this.renderManager.highlightObject(e.data.objectId)}),this.eventBus.subscribe(qs.OBJECT_MOVED,e=>{this.renderManager.updateObject(e.data.objectId)})}async startNewProject(e="New Project"){try{const t=await this.sceneManager.createScene(e);return await this.renderManager.initializeScene(t),this.historyManager.clear(),this.eventBus.publish(qs.EDITOR_MODE_CHANGED,{mode:"project_started",projectName:e}),t}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.startNewProject",error:t.message}),t}}async addObject(e,t={}){try{const s=this.sceneManager.getCurrentScene();if(!s)throw new Error("No active scene");const n=await this.objectFactory.createObject(e,t);return s.addObject(n),await this.renderManager.addObject(n),this.selectionManager.selectObject(n.id),this.historyManager.execute({type:"ADD_OBJECT",objectId:n.id,execute:()=>s.addObject(n),undo:()=>s.removeObject(n.id)}),n}catch(s){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.addObject",error:s.message,type:e,config:t}),s}}async deleteObject(e){try{const t=this.sceneManager.getCurrentScene();if(!t)throw new Error("No active scene");const s=t.getObject(e);if(!s)throw new Error(`Object ${e} not found`);return this.selectionManager.deselectObject(e),t.removeObject(e),this.renderManager.removeObject(e),this.historyManager.execute({type:"DELETE_OBJECT",objectId:e,objectData:s.toJSON(),execute:()=>t.removeObject(e),undo:()=>{const e=Object3DEntity.fromJSON(this.objectData);t.addObject(e),this.renderManager.addObject(e)}}),this.eventBus.publish(qs.OBJECT_DELETED,{objectId:e}),!0}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.deleteObject",error:t.message,objectId:e}),t}}setEditorMode(e){this.editorMode!==e&&(this.editorMode=e,this.eventBus.publish(qs.EDITOR_MODE_CHANGED,{mode:e}))}toggleGrid(){this.gridVisible=!this.gridVisible,this.renderManager.setGridVisible(this.gridVisible),this.eventBus.publish(qs.EDITOR_GRID_TOGGLED,{visible:this.gridVisible})}undo(){this.historyManager.canUndo()&&(this.historyManager.undo(),this.eventBus.publish(qs.HISTORY_UNDO,{}))}redo(){this.historyManager.canRedo()&&(this.historyManager.redo(),this.eventBus.publish(qs.HISTORY_REDO,{}))}clearMap(){try{const e=this.sceneManager.getCurrentScene();e&&(e.clear(),this.selectionManager.clearSelection(),this.historyManager.clear(),this.eventBus.publish(qs.SCENE_CLEARED,{sceneId:e.id}))}catch(e){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.clearMap",error:e.message}),e}}async saveMap(e){try{const t=this.sceneManager.getCurrentScene();if(!t)throw new Error("No active scene to save");return t.name=e,await this.sceneManager.saveScene(t),!0}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.saveMap",error:t.message,mapName:e}),t}}async loadMap(e){try{const t=await this.sceneManager.loadScene(e);return await this.renderManager.initializeScene(t),this.historyManager.clear(),!0}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.loadMap",error:t.message,mapName:e}),t}}getState(){var e;return{editorMode:this.editorMode,gridVisible:this.gridVisible,snapToGrid:this.snapToGrid,gridSize:this.gridSize,currentScene:(null==(e=this.sceneManager.getCurrentScene())?void 0:e.id)||null,selectedObjects:this.selectionManager.getSelectedObjects(),canUndo:this.historyManager.canUndo(),canRedo:this.historyManager.canRedo()}}selectObject(e){this.selectionManager.selectObject(e)}getSelectedObjects(){return this.selectionManager.getSelectedObjects()}getSelectedObject(){const e=this.selectionManager.getSelectedObjects();return e.length>0?e[0]:null}addWall(e){try{const t={id:e.id||Date.now(),type:"wall",position:e.position||[0,2.5,0],scale:e.scale||[1,1,1],name:e.name||`wall_${Date.now()}`,visible:!0,createdAt:(new Date).toISOString()};return this.sceneManager.addObject(t),this.historyManager.recordAction({type:"ADD_WALL",objectId:t.id,objectData:e}),this.eventBus.publish(qs.OBJECT_ADDED,{object:t}),t}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.addWall",error:t.message}),t}}setFloorSize(e,t){try{return this.floorWidth=e,this.floorDepth=t,this.historyManager.recordAction({type:"SET_FLOOR_SIZE",oldSize:{width:this.floorWidth,depth:this.floorDepth},newSize:{width:e,depth:t}}),this.eventBus.publish(qs.SCENE_CHANGED,{floorSize:{width:e,depth:t}}),!0}catch(s){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.setFloorSize",error:s.message}),s}}getFloorSize(){return{width:this.floorWidth,depth:this.floorDepth}}toggleObjectVisibility(e){try{const t=this.sceneManager.getObject(e);if(!t)throw new Error(`Object with id ${e} not found`);return t.visible=!t.visible,this.historyManager.recordAction({type:"TOGGLE_VISIBILITY",objectId:e,visible:t.visible}),this.eventBus.publish(qs.OBJECT_UPDATED,{object:t}),t.visible}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.toggleObjectVisibility",error:t.message}),t}}renameObject(e,t){try{const s=this.sceneManager.getObject(e);if(!s)throw new Error(`Object with id ${e} not found`);const n=s.name;return s.name=t,this.historyManager.recordAction({type:"RENAME_OBJECT",objectId:e,oldName:n,newName:t}),this.eventBus.publish(qs.OBJECT_UPDATED,{object:s}),s}catch(s){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.renameObject",error:s.message}),s}}removeObject(e){try{const t=this.sceneManager.getObject(e);if(!t)throw new Error(`Object with id ${e} not found`);return this.sceneManager.removeObject(e),this.selectionManager.getSelectedObjects().some(t=>t.id===e)&&this.selectionManager.deselectObject(e),this.historyManager.recordAction({type:"REMOVE_OBJECT",objectId:e,objectData:t}),this.eventBus.publish(qs.OBJECT_DELETED,{objectId:e}),!0}catch(t){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.removeObject",error:t.message}),t}}addAsset(e,t){try{return this.assets||(this.assets=new Map),this.assets.set(e,{name:e,url:t,addedAt:(new Date).toISOString()}),this.eventBus.publish(qs.ASSET_ADDED,{name:e,url:t}),!0}catch(s){throw this.eventBus.publish(qs.ERROR_OCCURRED,{source:"EditorService.addAsset",error:s.message}),s}}getAssets(){return this.assets?Array.from(this.assets.values()):[]}}class kn{async save(e,t){localStorage.setItem(e,JSON.stringify(t))}async load(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}async delete(e){return localStorage.removeItem(e),!0}async exists(e){return null!==localStorage.getItem(e)}async list(){return Object.keys(localStorage)}async clear(){localStorage.clear()}}class Bn{constructor(e){this.eventBus=e}async loadModel(e){return{url:e,loaded:!0}}async loadTexture(e){return{url:e,loaded:!0}}getProgress(){return{loaded:1,total:1}}}class Hn{constructor(e){this.eventBus=e,this.selectedObjects=new Set}selectObject(e){this.selectedObjects.add(e),this.eventBus.publish("object:selected",{objectId:e})}deselectObject(e){this.selectedObjects.delete(e),this.eventBus.publish("object:deselected",{objectId:e})}getSelectedObjects(){return Array.from(this.selectedObjects)}isSelected(e){return this.selectedObjects.has(e)}clearSelection(){this.selectedObjects.clear()}}class zn{constructor(e){this.eventBus=e,this.undoStack=[],this.redoStack=[]}execute(e){e.execute(),this.undoStack.push(e),this.redoStack=[]}undo(){if(this.canUndo()){const e=this.undoStack.pop();return e.undo(),this.redoStack.push(e),!0}return!1}redo(){if(this.canRedo()){const e=this.redoStack.pop();return e.execute(),this.undoStack.push(e),!0}return!1}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}clear(){this.undoStack=[],this.redoStack=[]}}class Fn{constructor(e){this.eventBus=e}async initializeScene(e){}async addObject(e){}removeObject(e){}highlightObject(e){}updateObject(e){}setGridVisible(e){}}class Un{constructor(e){this.eventBus=e}start(){}getStats(){return{fps:60,memory:50}}}class Gn{constructor(){this.config={rendering:{antialias:!0,shadows:!0,shadowMapSize:2048,pixelRatio:Math.min(window.devicePixelRatio,2)},editor:{gridSize:1,snapToGrid:!1,autoSave:!0,autoSaveInterval:3e4},performance:{targetFPS:60,enableMonitoring:!0,warningThreshold:50},ui:{theme:"dark",panelSizes:{},shortcuts:{}}}}async load(){try{const e=localStorage.getItem("app_config");if(e){const t=JSON.parse(e);this.config={...this.config,...t}}}catch(e){}}async save(){try{localStorage.setItem("app_config",JSON.stringify(this.config))}catch(e){}}get(e,t=null){const s=e.split(".");let n=this.config;for(const i of s){if(!n||"object"!=typeof n||!(i in n))return t;n=n[i]}return n}set(e,t){const s=e.split("."),n=s.pop();let i=this.config;for(const r of s)r in i&&"object"==typeof i[r]||(i[r]={}),i=i[r];i[n]=t,this.save()}}class Vn{constructor(e){this.eventBus=e}showError(e,t=5e3){this.eventBus.publish("ui:notification",{type:"error",message:e,duration:t})}showWarning(e,t=3e3){this.eventBus.publish("ui:notification",{type:"warning",message:e,duration:t})}showSuccess(e,t=2e3){this.eventBus.publish("ui:notification",{type:"success",message:e,duration:t})}showInfo(e,t=3e3){this.eventBus.publish("ui:notification",{type:"info",message:e,duration:t})}}class Xn{constructor(e){this.configManager=e,this.themes={light:{background:"#f5f5f5",surface:"#ffffff",primary:"#1976d2",text:"#333333"},dark:{background:"#121212",surface:"#1e1e1e",primary:"#90caf9",text:"#ffffff"}}}applyCurrentTheme(){const e=this.configManager.get("ui.theme","dark");this.applyTheme(e)}applyTheme(e){const t=this.themes[e];if(!t)return;const s=document.documentElement;Object.entries(t).forEach(([e,t])=>{s.style.setProperty(`--color-${e}`,t)}),this.configManager.set("ui.theme",e)}getAvailableThemes(){return Object.keys(this.themes)}}const Kn=new class{constructor(){this.isInitialized=!1,this.container=Dn,this.eventBus=$s}async initialize(){if(!this.isInitialized)try{this.registerInfrastructureServices(),this.registerDomainServices(),this.registerApplicationServices(),await this.initializeServices(),this.setupGlobalEventHandlers(),this.isInitialized=!0,this.eventBus.publish("app:initialized",{timestamp:new Date,services:this.container.getStats()})}catch(e){throw e}}registerInfrastructureServices(){this.container.registerInstance(vn,this.eventBus),this.container.register(An,()=>new kn,fn),this.container.register(Mn,e=>new Bn(e.resolve(vn)),fn),this.container.register(Sn,e=>new Hn(e.resolve(vn)),fn),this.container.register(jn,e=>new zn(e.resolve(vn)),fn),this.container.register(En,e=>new Fn(e.resolve(vn)),fn),this.container.register(On,e=>new Un(e.resolve(vn)),fn)}registerDomainServices(){this.container.registerClass(wn,In,fn,[vn,An]),this.container.registerClass(xn,Ln,fn,[vn,Mn]),this.container.register("EditorService",e=>new Pn(e.resolve(vn),e.resolve(wn),e.resolve(xn),e.resolve(Sn),e.resolve(jn),e.resolve(En)),fn)}registerApplicationServices(){this.container.register(Tn,()=>new Gn,fn),this.container.register(Rn,e=>new Vn(e.resolve(vn)),fn),this.container.register(Cn,e=>new Xn(e.resolve(Tn)),fn)}async initializeServices(){this.container.resolve(On).start();const e=this.container.resolve(Tn);await e.load();this.container.resolve(Cn).applyCurrentTheme()}setupGlobalEventHandlers(){this.eventBus.subscribe("error:occurred",e=>{this.container.resolve(Rn).showError(e.data.error||"An error occurred")}),this.eventBus.subscribe("performance:warning",e=>{this.container.resolve(Rn).showWarning(`Performance issue: ${e.data.message}`)}),window.addEventListener("beforeunload",()=>{this.dispose()})}dispose(){if(this.isInitialized)try{this.container.clear(),this.eventBus.clear(),this.isInitialized=!1}catch(e){}}getService(e){if(!this.isInitialized)throw new Error("Application not initialized");return this.container.resolve(e)}getStatus(){return{isInitialized:this.isInitialized,services:this.container.getStats(),events:this.eventBus.getStats()}}};function Yn(){return We.jsx(Je,{container:Kn.container,children:We.jsx(i,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:We.jsx("div",{className:"App",children:We.jsxs(r,{children:[We.jsx(o,{path:"/",element:We.jsx(qe,{})}),We.jsx(o,{path:"/game",element:We.jsx(rt,{})}),We.jsx(o,{path:"/editor",element:We.jsx(gn,{})})]})})})})}!async function(){try{await Kn.initialize(),Ze.createRoot(document.getElementById("root")).render(We.jsx(s.StrictMode,{children:We.jsx(Yn,{})}))}catch(e){document.getElementById("root").innerHTML="<h1>Application failed to load</h1>"}}();
