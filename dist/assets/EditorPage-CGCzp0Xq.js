const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/editor-D3I3U6u0.js","assets/react-vendor-C18QMWF4.js","assets/three-CPLCFrMS.js","assets/three-stdlib-CLJV8NWX.js","assets/state-MC_ymbCc.js","assets/editor-DVAFzBh3.css"])))=>i.map(i=>d[i]);
import{u as e,M as t,P as a,V as s,E as n,T as i,_ as r,i as o}from"./editor-D3I3U6u0.js";import{r as l,j as c}from"./react-vendor-C18QMWF4.js";import{C as d,Z as u,e as m,j as p,V as g,Q as y}from"./three-CPLCFrMS.js";import{u as f}from"./router-CBy-A1a3.js";import"./three-stdlib-CLJV8NWX.js";import"./state-MC_ymbCc.js";let v=null;async function w(){if(!v){const e=await r(()=>import("./editor-D3I3U6u0.js").then(e=>e.G),__vite__mapDeps([0,1,2,3,4,5]));v=e.getGLBMeshManager()}return v}const b="새 맵을 만들면 현재 작업이 사라집니다. 계속하시겠습니까?",h="익스포트 기능은 준비 중입니다.",S="에디터를 종료하시겠습니까?",j="실행 취소 기능은 준비 중입니다.",x="다시 실행 기능은 준비 중입니다.",E="전체 선택 기능은 준비 중입니다.",O="선택 해제 기능은 준비 중입니다.",M="뷰포트 리셋 기능은 준비 중입니다.",T="카메라 리셋: 키패드 0번을 누르세요.",C="통계 표시 기능은 준비 중입니다.",k="단축키 정보:\nW/E/R: 기즈모 모드\nF: 오브젝트 포커스\nESC: 선택 해제\n키패드 0: 카메라 리셋\n키패드 5: 카메라 모드 토글\n키패드 1/3/7/9: 뷰 변경",A="도움말:\n• 좌클릭: 오브젝트 선택\n• Shift+좌클릭: 다중 선택\n• 중간클릭: 팬 이동\n• Alt+중간클릭: 카메라 회전\n• 마우스 휠: 줌",D="ThirdPersonTreeJS Editor\nVersion 1.0.0\n3D 에디터 프로그램";function P(){const r=f(),{clearMap:v,saveMap:P,loadMap:R,addObject:_,setSelectedObject:L,addCustomMesh:z,selectedObject:I,selectedIds:G,toggleGridVisible:$,scene:N,hdriSettings:W,sunLightRef:F,setSunLightRef:V,saveHDRISettings:q,objects:B,setSelectedIds:H,setParent:K,reorderSiblings:U,copyObject:Z,pasteObject:J,deleteSelectedObject:Q,hasClipboardData:X}=e(),[Y,ee]=l.useState(null),[te,ae]=l.useState([]),[se,ne]=l.useState(!1),[ie,re]=l.useState(""),[oe,le]=l.useState(""),[ce,de]=l.useState(null),[ue,me]=l.useState(!0),pe=l.useRef(null),[ge,ye]=l.useState(null),fe=l.useRef(null),ve=l.useRef(null),we=l.useRef(new Set);l.useEffect(()=>{let t=!1;return(async()=>{try{ve.current||(ve.current=await w());const a=await ve.current.getCustomMeshes();if(!t&&0===(e.getState().customMeshes||[]).length){const t=a.map(e=>"string"==typeof e.thumbnail&&e.thumbnail.startsWith("blob:")?e.thumbnail:null).filter(Boolean);we.current=new Set(t),e.getState().loadCustomMeshes(a)}}catch{}})(),()=>{t=!0;for(const e of we.current)try{URL.revokeObjectURL(e)}catch{}we.current.clear()}},[]),l.useEffect(()=>{const e=e=>{const{message:t,type:a="info",duration:s=3e3}=e.detail||{};t&&(de({message:t,type:a}),s>0&&setTimeout(()=>de(null),s))};return window.addEventListener("appToast",e),()=>window.removeEventListener("appToast",e)},[]),l.useEffect(()=>{N&&W.sunLightEnabled&&!F?be():N&&!W.sunLightEnabled&&F&&he()},[N,W.sunLightEnabled,F]),l.useEffect(()=>{if(!N||!F||!W.sunLightEnabled)return;if(!(()=>{let e=!1;return N.traverse(t=>{t===F&&(e=!0)}),e})())try{N.add(F)}catch{}},[N,F,W.sunLightEnabled]),l.useEffect(()=>{N&&W.currentHDRI&&"none"===W.currentHDRI.type&&(N.background=new d(2763306),N.environment=null)},[N,W.currentHDRI]),l.useEffect(()=>{const e=e=>{if(null==e?void 0:e.defaultPrevented)return;const t=null==e?void 0:e.target,a=null==t?void 0:t.tagName;if("INPUT"!==a&&"TEXTAREA"!==a&&"SELECT"!==a&&!(null==t?void 0:t.isContentEditable)&&!(null==e?void 0:e.repeat)){if("i"!==e.key&&"I"!==e.key||e.ctrlKey||e.altKey||e.shiftKey||(e.preventDefault(),me(e=>!e)),e.ctrlKey&&("c"===e.key||"C"===e.key)){if(e.preventDefault(),!I)return de({message:"복사할 객체를 먼저 선택해주세요",type:"warning"}),void setTimeout(()=>de(null),2e3);requestAnimationFrame(()=>{var e;try{let t=null;if(pe.current){const a=I.id||I;t=pe.current.findObjectById(a)||(null==(e=pe.current.selectedObjects)?void 0:e[0])||null}t?(Z(t),de({message:`"${t.name}"이(가) 복사되었습니다`,type:"success"})):(Z(I),de({message:`"${I.name}"이(가) 복사되었습니다`,type:"success"}))}finally{setTimeout(()=>de(null),2e3)}})}!e.ctrlKey||"v"!==e.key&&"V"!==e.key||(e.preventDefault(),requestAnimationFrame(()=>{try{if(X()){const e=J();de(e?{message:`"${e.name}"이(가) 붙여넣기되었습니다`,type:"success"}:{message:"붙여넣기에 실패했습니다",type:"error"})}else de({message:"붙여넣을 객체가 클립보드에 없습니다",type:"warning"})}finally{setTimeout(()=>de(null),2e3)}}))}};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[I,B,Z,J,Q,X,de]);const be=()=>{if(!N)return;const e=new u(W.sunColor,W.sunIntensity),t=W.sunAzimuth*Math.PI/180,a=W.sunElevation*Math.PI/180,s=Math.sin(t)*Math.cos(a)*100,n=100*Math.sin(a),i=Math.cos(t)*Math.cos(a)*100;e.position.set(s,n,i),e.lookAt(0,0,0),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=500,e.shadow.camera.left=-50,e.shadow.camera.right=50,e.shadow.camera.top=50,e.shadow.camera.bottom=-50,e.name="sunLight",e.userData=e.userData||{},e.userData.isSystemObject=!0,V(e),N.add(e)},he=()=>{N&&F&&(N.remove(F),F.dispose&&F.dispose(),V(null))};l.useEffect(()=>{N&&setTimeout(()=>q(),100)},[W,N,q]);const Se=t=>{var a,s,n,i,r;if(t&&"object"==typeof t)try{const o=pe.current,l=window.__blenderControls;if(t.camera){const e=(null==(a=null==o?void 0:o.getCamera)?void 0:a.call(o))||(null==l?void 0:l.camera);e&&(Array.isArray(t.camera.position)&&e.position.fromArray(t.camera.position),Array.isArray(t.camera.up)&&e.up.fromArray(t.camera.up),"number"==typeof t.camera.fov&&(e.fov=t.camera.fov),"number"==typeof t.camera.near&&(e.near=t.camera.near),"number"==typeof t.camera.far&&(e.far=t.camera.far),null==(s=e.updateProjectionMatrix)||s.call(e),l&&Array.isArray(t.camera.target)?l.target.fromArray(t.camera.target):o&&Array.isArray(t.camera.target)&&(null==(n=o.setCameraTarget)||n.call(o,(new g).fromArray(t.camera.target))))}if(t.viewOptions){const a=e.getState();if("boolean"==typeof t.viewOptions.isWireframe&&a.isWireframe!==t.viewOptions.isWireframe&&e.getState().toggleWireframe(),"boolean"==typeof t.viewOptions.isGridSnap&&a.isGridSnap!==t.viewOptions.isGridSnap&&e.getState().toggleGridSnap(),"boolean"==typeof t.viewOptions.isGridVisible&&a.isGridVisible!==t.viewOptions.isGridVisible&&e.getState().toggleGridVisible(),t.viewOptions.gizmoSpace&&a.gizmoSpace!==t.viewOptions.gizmoSpace&&e.getState().toggleGizmoSpace(),Number.isFinite(t.viewOptions.gizmoSize)&&e.getState().setGizmoSize(t.viewOptions.gizmoSize),Number.isFinite(t.viewOptions.snapMove)&&e.getState().setSnapMove(t.viewOptions.snapMove),Number.isFinite(t.viewOptions.snapRotateDeg)&&e.getState().setSnapRotateDeg(t.viewOptions.snapRotateDeg),Number.isFinite(t.viewOptions.snapScale)&&e.getState().setSnapScale(t.viewOptions.snapScale),Number.isFinite(t.viewOptions.cameraPanSpeed)&&e.getState().setCameraPanSpeed(t.viewOptions.cameraPanSpeed),Number.isFinite(t.viewOptions.cameraOrbitSpeed)&&e.getState().setCameraOrbitSpeed(t.viewOptions.cameraOrbitSpeed),Number.isFinite(t.viewOptions.cameraZoomSpeed)&&e.getState().setCameraZoomSpeed(t.viewOptions.cameraZoomSpeed),"boolean"==typeof t.viewOptions.isPostProcessingEnabled){e.getState().isPostProcessingEnabled!==t.viewOptions.isPostProcessingEnabled&&e.getState().togglePostProcessingEnabled()}null==(i=null==o?void 0:o.applyInitialViewState)||i.call(o),l&&(null==(r=l.update)||r.call(l))}}catch{}},je=async()=>{var t,a,s,n;if("save"===Y&&oe.trim()){const t=(()=>{var t,a,s,n;const i={};try{const r=pe.current,o=window.__blenderControls,l=(null==(t=null==r?void 0:r.getCamera)?void 0:t.call(r))||(null==o?void 0:o.camera);l&&(i.camera={position:l.position?l.position.toArray():null,target:o&&o.target?o.target.toArray():(null==(n=null==(s=null==(a=null==r?void 0:r.getCameraTarget)?void 0:a.call(r))?void 0:s.toArray)?void 0:n.call(s))||[0,0,0],up:l.up?l.up.toArray():null,fov:l.fov,near:l.near,far:l.far});const c=e.getState();i.viewOptions={isWireframe:c.isWireframe,isGridSnap:c.isGridSnap,isGridVisible:c.isGridVisible,gizmoSpace:c.gizmoSpace,gizmoSize:c.gizmoSize,snapMove:c.snapMove,snapRotateDeg:c.snapRotateDeg,snapScale:c.snapScale,cameraPanSpeed:c.cameraPanSpeed,cameraOrbitSpeed:c.cameraOrbitSpeed,cameraZoomSpeed:c.cameraZoomSpeed,isPostProcessingEnabled:c.isPostProcessingEnabled}}catch{}return i})();await P(oe.trim(),t),alert(`맵이 "${oe.trim()}"으로 저장되었습니다.`)}else if("load"===Y&&oe.trim()){if(await(null==(a=(t=e.getState()).loadMap)?void 0:a.call(t,oe.trim()))){try{const t=await(null==(n=(s=e.getState()).getMapData)?void 0:n.call(s,oe.trim()));t&&t.viewState&&Se(t.viewState)}catch{}try{window.__requestRender&&window.__requestRender()}catch{}alert(`맵 "${oe.trim()}"을 불러왔습니다.`)}else alert(`맵 "${oe.trim()}"을 찾을 수 없습니다.`)}ee(null),le("")},xe=()=>{ee(null),le("")},Ee=async()=>{var t,a;try{ne(!0);const s=await(null==(a=(t=e.getState()).listMaps)?void 0:a.call(t));ae(Array.isArray(s)?s:[])}catch{ae([])}finally{ne(!1)}};l.useEffect(()=>{"load"===Y&&Ee()},[Y]);l.useEffect(()=>{const e=e=>{const t=(null==e?void 0:e.detail)||{};"customMeshMissing"===(null==t?void 0:t.type)&&(de({message:`일부 커스텀 메쉬를 찾지 못했습니다. (id=${t.id})`,type:"warning"}),setTimeout(()=>de(null),2500))};return window.addEventListener("mapLoadWarning",e),()=>window.removeEventListener("mapLoadWarning",e)},[]);return c.jsxs("div",{className:"editor-page",children:[c.jsx(t,{onMenuAction:t=>{var a,s,n,i;switch(t){case"new-map":if(confirm(b)){v();try{null==(s=null==(a=pe.current)?void 0:a.resetCamera)||s.call(a)}catch{}try{window.__blenderControls&&(window.__blenderControls.target.set(0,0,0),null==(i=(n=window.__blenderControls).update)||i.call(n))}catch{}}break;case"load-map":ee("load");break;case"save-map":ee("save");break;case"import":(()=>{const e=document.createElement("input");e.type="file",e.accept=".glb,.gltf",e.multiple=!1,e.onchange=e=>{const t=e.target.files[0];if(!t)return;const a=URL.createObjectURL(t),s=t.name.replace(/\.[^/.]+$/,""),n={id:Date.now(),type:"glb",file:a,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:s};_(n),setTimeout(()=>{L(n.id)},100)},e.click()})();break;case"export":alert(h);break;case"exit":confirm(S)&&r("/");break;case"undo":alert(j);break;case"redo":alert(x);break;case"copy":if(I){const e=B.find(e=>e.id===I);e?(Z(e),de({message:`"${e.name}"이(가) 복사되었습니다`,type:"success"}),setTimeout(()=>de(null),2e3)):(de({message:"복사할 객체를 찾을 수 없습니다",type:"error"}),setTimeout(()=>de(null),2e3))}else de({message:"복사할 객체를 먼저 선택해주세요",type:"warning"}),setTimeout(()=>de(null),2e3);break;case"paste":if(X()){const e=J();e?(de({message:`"${e.name}"이(가) 붙여넣기되었습니다`,type:"success"}),setTimeout(()=>de(null),2e3)):(de({message:"붙여넣기에 실패했습니다",type:"error"}),setTimeout(()=>de(null),2e3))}else de({message:"붙여넣을 객체가 클립보드에 없습니다",type:"warning"}),setTimeout(()=>de(null),2e3);break;case"delete":if(I){const e=B.find(e=>e.id===I);if(e){const t=e.name;Q(),de({message:`"${t}"이(가) 삭제되었습니다`,type:"success"}),setTimeout(()=>de(null),2e3)}else de({message:"삭제할 객체를 찾을 수 없습니다",type:"error"}),setTimeout(()=>de(null),2e3)}else de({message:"삭제할 객체를 먼저 선택해주세요",type:"warning"}),setTimeout(()=>de(null),2e3);break;case"select-all":alert(E);break;case"deselect-all":alert(O);break;case"reset-viewport":alert(M);break;case"reset-camera":alert(T);break;case"toggle-grid":$();const t=e.getState().isGridVisible;pe.current&&pe.current.toggleGrid(),de({message:`그리드가 ${t?"표시":"숨김"} 되었습니다`,type:"info"}),setTimeout(()=>de(null),2e3);break;case"toggle-stats":alert(C);break;case"toggle-inspector":me(e=>!e),de({message:`인스펙터가 ${ue?"숨김":"표시"} 되었습니다`,type:"info"}),setTimeout(()=>de(null),2e3);break;case"fullscreen":document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();break;case"show-shortcuts":alert(k);break;case"show-help":alert(A);break;case"about":alert(D)}}}),c.jsxs("div",{className:"editor-container",children:[c.jsx(a,{onEditorControlsReady:e=>{pe.current=e,ye(e)},onPostProcessingReady:e=>{fe.current=e},onContextMenu:e=>{const t=new CustomEvent("editorContextMenu",{detail:{originalEvent:e}});window.dispatchEvent(t)}}),c.jsx(s,{editorControls:ge}),c.jsx(n,{editorControls:ge,postProcessingManager:fe.current,onAddToLibrary:async t=>{var a,s,n,i,r;try{ve.current||(ve.current=await w());const l=prompt("메쉬 이름을 입력하세요:",t.name||"커스텀 메쉬");if(!l)return;const c=!0;de({message:"라이브러리에 추가 중...",type:"info"});const d=pe.current;let u=null;const f=(null==d?void 0:d.selectedObjects)&&d.selectedObjects.length>0?[...d.selectedObjects]:[];if(f.length>1){const e=new m;e.name=l,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1),e.updateMatrixWorld(!0),f.forEach(t=>{try{t.updateMatrixWorld(!0);const a=t.clone(!0),s=(new p).copy(t.matrixWorld),n=new g,i=new y,r=new g(1,1,1);s.decompose(n,i,r),a.position.copy(n),a.quaternion.copy(i),a.scale.copy(r),a.updateMatrix(),a.updateMatrixWorld(!0),e.add(a)}catch{}}),e.updateMatrixWorld(!0),u=e}else{const e=t&&"object"==typeof t&&null!=(n=null!=(s=t.id)?s:null==(a=t.userData)?void 0:a.ownerId)?n:t;u=t&&"object"==typeof t&&t.isObject3D?t:d&&((null==(i=d.findObjectById)?void 0:i.call(d,e))||(null==(r=d.selectedObjects)?void 0:r[0]))||null}if(!u)return de({message:"내보낼 Three.js 객체를 찾지 못했습니다.",type:"error"}),void setTimeout(()=>de(null),4e3);const v=await ve.current.addCustomMesh(u,l,{preserveTransform:c,compressToSingleMesh:!0});try{ve.current.downloadCustomMesh(v)}catch{}if((e.getState().customMeshes||[]).some(e=>e.id===v.id)){if(!confirm("동일 ID의 커스텀 메쉬가 이미 있습니다.\n\n- 기존 항목을 덮어쓸까요?"))return de({message:"추가가 취소되었습니다(중복 ID).",type:"warning"}),void setTimeout(()=>de(null),2500);await o(v);const t=(e.getState().customMeshes||[]).map(e=>e.id===v.id?v:e);e.getState().loadCustomMeshes(t)}else await z(v);window.dispatchEvent(new CustomEvent("customMeshAdded",{detail:v})),de({message:`"${l}" GLB가 내보내지고 라이브러리에 추가되었습니다! (그룹 피벗 항등/자식 월드 변환 유지)`,type:"success"}),setTimeout(()=>de(null),5e3)}catch(l){const e=l&&"NO_MESH_FOUND"===l.message?"선택한 오브젝트에서 내보낼 메시를 찾지 못했습니다. (스키닝/인스턴스/비메시 제외)":"라이브러리 추가에 실패했습니다.";de({message:e,type:"error"}),setTimeout(()=>de(null),5e3)}},showInspector:ue,onToggleInspector:me})]}),Y&&c.jsx("div",{className:"dialog-overlay",children:c.jsxs("div",{className:"dialog",children:[c.jsx("h3",{children:"save"===Y?"맵 저장":"맵 불러오기"}),c.jsx("input",{type:"text",value:oe,onChange:e=>le(e.target.value),placeholder:"맵 이름을 입력하세요",autoFocus:!0,onKeyDown:e=>{"Enter"===e.key&&je(),"Escape"===e.key&&xe()}}),c.jsxs("div",{className:"dialog-buttons",children:[c.jsx("button",{type:"button",onClick:je,disabled:!!ie,children:"확인"}),c.jsx("button",{type:"button",onClick:xe,disabled:!!ie,children:"취소"})]}),"load"===Y&&c.jsxs("div",{style:{marginTop:12,maxHeight:260,overflow:"auto",borderTop:"1px solid #444",paddingTop:10},children:[c.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[c.jsx("strong",{children:"저장된 맵 목록"}),c.jsx("button",{onClick:Ee,disabled:se,style:{padding:"4px 8px"},children:se?"새로고침…":"새로고침"})]}),0===te.length&&c.jsx("div",{style:{opacity:.7},children:"저장된 맵이 없습니다."}),te.map(t=>c.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8,padding:"6px 0",borderBottom:"1px solid #333"},children:[c.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[c.jsx("span",{style:{fontWeight:600},children:t.name}),c.jsxs("span",{style:{fontSize:12,opacity:.8},children:["업데이트: ",t.updated_at?new Date(t.updated_at).toLocaleString():"-"]})]}),c.jsxs("div",{style:{display:"flex",gap:6},children:[c.jsx("button",{type:"button",onClick:()=>(async t=>{var a,s,n,i;if(t)try{if(re(t),de({message:`"${t}" 불러오는 중…`,type:"info"}),await(null==(s=(a=e.getState()).loadMap)?void 0:s.call(a,t))){try{const a=await(null==(i=(n=e.getState()).getMapData)?void 0:i.call(n,t));(null==a?void 0:a.viewState)&&Se(a.viewState)}catch{}try{window.__requestRender&&window.__requestRender()}catch{}ee(null),le(""),de({message:`맵 "${t}"을 불러왔습니다.`,type:"success"}),setTimeout(()=>de(null),1800)}else de({message:`맵 "${t}"을 찾을 수 없습니다.`,type:"error"}),setTimeout(()=>de(null),1800)}catch(r){de({message:"불러오기 중 오류가 발생했습니다.",type:"error"}),setTimeout(()=>de(null),1800)}finally{re("")}})(t.name),disabled:!!ie,style:{padding:"4px 8px"},children:ie===t.name?"불러오는 중…":"불러오기"}),c.jsx("button",{type:"button",onClick:()=>(async t=>{var a,s;if(!t)return;if(!window.confirm(`정말 "${t}" 맵을 삭제하시겠습니까?`))return;await(null==(s=(a=e.getState()).deleteMap)?void 0:s.call(a,t))?(await Ee(),de({message:`맵 "${t}"이(가) 삭제되었습니다.`,type:"success"}),setTimeout(()=>de(null),1500)):(de({message:"삭제에 실패했습니다.",type:"error"}),setTimeout(()=>de(null),1500))})(t.name),disabled:!!ie,style:{padding:"4px 8px",background:"#a33",color:"#fff"},children:"삭제"})]})]},t.name))]})]})}),ce&&c.jsx(i,{message:ce.message,type:ce.type,onClose:()=>de(null)})]})}export{P as default};
