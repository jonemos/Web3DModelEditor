import{r as e,b as t,a as s}from"./react-vendor-340b36b2.js";import{u as n,B as i,R as o,a}from"./router-276f05ba.js";import{c as r}from"./state-b6f0ffd6.js";import{C as l,S as c,a as h,P as d,W as u,b as m,A as p,D as f,c as g,M as b,d as x,B as w,e as v,T as y,f as j,g as S,L as A,h as M,F as T,i as O,j as E,k as _,l as C,m as R,n as P,V as N,o as I,p as L,I as k,q as D,O as H,r as F,s as z,t as B,u as X,v as U,w as V,R as K,N as G,x as W,y as Y,z as Z,E as Q,G as q,H as $,J,K as ee,Q as te,U as se,X as ne,Y as ie,Z as oe,_ as ae,$ as re,a0 as le,a1 as ce,a2 as he,a3 as de,a4 as ue,a5 as me,a6 as pe,a7 as fe,a8 as ge,a9 as be,aa as xe,ab as we,ac as ve,ad as ye,ae as je,af as Se,ag as Ae,ah as Me,ai as Te,aj as Oe,ak as Ee,al as _e,am as Ce,an as Re,ao as Pe,ap as Ne,aq as Ie,ar as Le,as as ke,at as De,au as He}from"./three-c67e2e48.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var Fe={exports:{}},ze={},Be=e,Xe=Symbol.for("react.element"),Ue=Symbol.for("react.fragment"),Ve=Object.prototype.hasOwnProperty,Ke=Be.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ge={key:!0,ref:!0,__self:!0,__source:!0};function We(e,t,s){var n,i={},o=null,a=null;for(n in void 0!==s&&(o=""+s),void 0!==t.key&&(o=""+t.key),void 0!==t.ref&&(a=t.ref),t)Ve.call(t,n)&&!Ge.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:Xe,type:e,key:o,ref:a,props:i,_owner:Ke.current}}ze.Fragment=Ue,ze.jsx=We,ze.jsxs=We,Fe.exports=ze;var Ye=Fe.exports,Ze={},Qe=t;Ze.createRoot=Qe.createRoot,Ze.hydrateRoot=Qe.hydrateRoot;function qe(){const t=n(),[s,i]=e.useState(null),[o,a]=e.useState(!1);e.useEffect(()=>{const e=e=>{e.preventDefault(),i(e),a(!0)};return window.addEventListener("beforeinstallprompt",e),()=>{window.removeEventListener("beforeinstallprompt",e)}},[]);return Ye.jsxs("div",{className:"home-page",children:[Ye.jsxs("div",{className:"start-menu fade-in",children:[Ye.jsxs("h1",{children:["🎮",Ye.jsx("br",{}),"ThirdPerson TreeJS Game"]}),Ye.jsxs("div",{className:"menu-buttons",children:[Ye.jsx("button",{className:"menu-btn start-game-btn",onClick:()=>t("/game"),children:"게임 시작"}),Ye.jsx("button",{className:"menu-btn editor-btn",onClick:()=>t("/editor"),children:"에디터"})]})]}),o&&Ye.jsxs("div",{className:"install-prompt",children:[Ye.jsx("p",{children:"이 게임을 홈 화면에 추가하시겠습니까?"}),Ye.jsx("button",{onClick:async()=>{if(s){s.prompt();(await s.userChoice).outcome,i(null)}a(!1)},className:"install-btn",children:"설치"}),Ye.jsx("button",{onClick:()=>{a(!1)},className:"dismiss-btn",children:"나중에"})]})]})}const $e=r((e,t)=>({isPlaying:!0,isPaused:!1,isLoading:!0,scene:null,camera:null,renderer:null,player:null,mixer:null,clock:new l,playerPosition:{x:0,y:1,z:0},playerRotation:0,cameraState:{distance:10,height:5,followMode:!0,rotationSpeed:.002,zoomSpeed:1,minDistance:3,maxDistance:50,phi:Math.PI/4,theta:0},keys:{},mouseState:{isMouseDown:!1,prevMousePos:{x:0,y:0},sensitivity:.002},trees:[],items:[],walls:[],setLoading:t=>e({isLoading:t}),setScene:(t,s,n)=>e({scene:t,camera:s,renderer:n}),setPlayer:t=>e({player:t}),updatePlayerPosition:t=>e({playerPosition:t}),updatePlayerRotation:t=>e({playerRotation:t}),setKey:(t,s)=>e(e=>({keys:{...e.keys,[t]:s}})),pause:()=>e({isPaused:!0}),resume:()=>e({isPaused:!1}),restart:()=>e({isPlaying:!0,isPaused:!1,playerPosition:{x:0,y:1,z:0},playerRotation:0}),toggleCameraFollowMode:()=>e(e=>({cameraState:{...e.cameraState,followMode:!e.cameraState.followMode}})),updateCameraDistance:t=>e(e=>({cameraState:{...e.cameraState,distance:Math.max(e.cameraState.minDistance,Math.min(e.cameraState.maxDistance,t))}})),updateCameraAngles:(t,s)=>e(e=>({cameraState:{...e.cameraState,phi:Math.max(.1,Math.min(Math.PI-.1,t)),theta:s}})),setMouseDown:(t,s)=>e(e=>({mouseState:{...e.mouseState,isMouseDown:t,prevMousePos:s||e.mouseState.prevMousePos}})),addItem:t=>e(e=>({items:[...e.items,t]})),removeItem:t=>e(e=>({items:e.items.filter(e=>e.id!==t)})),setTrees:t=>e({trees:t}),addWall:t=>e(e=>({walls:[...e.walls,t]})),clearWalls:()=>e({walls:[]}),setMixer:t=>e({mixer:t})}));function Je(){const t=e.useRef(null);return e.useEffect(()=>{if(!t.current)return;const e=new c;e.background=new h(8900331);const s=new d(75,window.innerWidth/window.innerHeight,.1,1e3);s.position.set(0,5,10),s.lookAt(0,0,0);const n=new u({antialias:!0});n.setSize(window.innerWidth,window.innerHeight),n.shadowMap.enabled=!0,n.shadowMap.type=m,t.current.appendChild(n.domElement);const i=new p(4210752,.6);e.add(i);const o=new f(16777215,.8);o.position.set(10,10,5),o.castShadow=!0,e.add(o);const a=new g(20,20),r=new b({color:65280}),l=new x(a,r);l.rotation.x=-Math.PI/2,l.receiveShadow=!0,e.add(l);const y=new w(2,2,2),j=new b({color:16711680}),S=new x(y,j);S.position.set(0,1,0),S.castShadow=!0,e.add(S);const A=new v(1,32,32),M=new b({color:255}),T=new x(A,M);T.position.set(3,1,0),T.castShadow=!0,e.add(T);const O=()=>{requestAnimationFrame(O),S.rotation.x+=.01,S.rotation.y+=.01,T.rotation.y+=.02,n.render(e,s)};O();const E=()=>{s.aspect=window.innerWidth/window.innerHeight,s.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight)};return window.addEventListener("resize",E),()=>{window.removeEventListener("resize",E),t.current&&n.domElement&&t.current.removeChild(n.domElement),n.dispose()}},[]),Ye.jsx("div",{ref:t,style:{width:"100vw",height:"100vh",position:"absolute",top:0,left:0,zIndex:1}})}function et(){const{isPaused:t,pause:s,resume:n,restart:i,toggleCameraFollowMode:o,cameraState:a,playerPosition:r}=$e(),[l,c]=e.useState(!1),[h,d]=e.useState(10);return Ye.jsxs(Ye.Fragment,{children:[Ye.jsx("div",{className:"crosshair"}),Ye.jsx("div",{className:"game-message"}),t&&Ye.jsxs("div",{className:"pause-overlay",children:[Ye.jsx("h2",{children:"게임 일시정지"}),Ye.jsx("button",{onClick:n,className:"resume-btn",children:"계속하기"}),Ye.jsx("button",{onClick:i,className:"restart-btn",children:"재시작"})]}),Ye.jsxs("div",{className:"controls-info",children:[Ye.jsx("div",{children:"WASD: 이동"}),Ye.jsx("div",{children:"마우스: 카메라 회전"}),Ye.jsx("div",{children:"스크롤: 줌"}),Ye.jsx("div",{children:"ESC: 일시정지"}),Ye.jsxs("div",{children:["위치: (",Math.round(r.x),", ",Math.round(r.z),")"]})]}),Ye.jsx("button",{className:"sidebar-toggle-btn",onClick:()=>c(!l),children:"⚙️"}),Ye.jsxs("div",{className:"sidebar "+(l?"open":""),children:[Ye.jsxs("div",{className:"sidebar-header",children:[Ye.jsx("h3",{children:"게임 설정"}),Ye.jsx("button",{className:"close-btn",onClick:()=>c(!1),children:"✕"})]}),Ye.jsxs("div",{className:"sidebar-content",children:[Ye.jsxs("div",{className:"section",children:[Ye.jsx("h4",{children:"플레이어 모델"}),Ye.jsx("input",{type:"file",accept:".glb,.gltf",onChange:e=>{e.target.files[0]},style:{display:"none"},id:"model-file-input"}),Ye.jsx("button",{className:"upload-btn",onClick:()=>document.getElementById("model-file-input").click(),children:"모델 업로드"}),Ye.jsx("button",{className:"reset-btn",onClick:()=>{window.confirm("캐릭터를 기본 모델로 되돌리시겠습니까?")},children:"기본 모델로 리셋"}),Ye.jsx("div",{className:"model-info",children:"기본 모델 사용 중"})]}),Ye.jsxs("div",{className:"section",children:[Ye.jsxs("h4",{children:["나무 개수: ",h]}),Ye.jsx("input",{type:"range",min:"0",max:"20",value:h,onChange:e=>{const t=parseInt(e.target.value,10);d(t)},className:"slider"})]}),Ye.jsxs("div",{className:"section",children:[Ye.jsx("h4",{children:"카메라"}),Ye.jsx("button",{className:"camera-btn "+(a.followMode?"active":""),onClick:o,children:a.followMode?"따라가기 모드":"고정 모드"})]}),Ye.jsxs("div",{className:"section",children:[Ye.jsx("h4",{children:"맵 선택"}),Ye.jsx("select",{className:"map-select",children:Ye.jsx("option",{value:"default",children:"기본 맵"})}),Ye.jsx("button",{className:"apply-map-btn",children:"맵 적용"})]})]})]})]})}function tt(){const t=n(),{isLoading:s,setLoading:i,pause:o,restart:a,setKey:r}=$e(),[l,c]=e.useState("게임 로딩 중...");return e.useEffect(()=>{(async()=>{try{c("게임 엔진 초기화 중..."),await new Promise(e=>setTimeout(e,1e3)),c("게임 준비 완료!"),setTimeout(()=>{i(!1)},500)}catch(e){c(`❌ 게임 로딩 실패: ${e.message}`)}})()},[i]),e.useEffect(()=>{const e=e=>{"Escape"===e.code&&o(),"KeyR"===e.code&&a(),"KeyH"===e.code&&t("/")};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},[o,a,t]),e.useEffect(()=>{const e=document.querySelector("canvas");e&&e.addEventListener("click",()=>{e.requestPointerLock()})},[s]),Ye.jsxs("div",{className:"game-page",children:[s&&Ye.jsxs("div",{className:"loading-screen",children:[Ye.jsx("div",{className:"loader"}),Ye.jsx("p",{className:"loading-status",children:l})]}),!s&&Ye.jsxs(Ye.Fragment,{children:[Ye.jsx(Je,{}),Ye.jsx(et,{}),Ye.jsx("button",{className:"home-btn",onClick:()=>t("/"),title:"홈으로 돌아가기 (H)",children:"🏠"})]})]})}function st(e,t){if(t===y)return e;if(t===j||t===S){let s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,i=[];if(t===j)for(let e=1;e<=n;e++)i.push(s.getX(0)),i.push(s.getX(e)),i.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(i.push(s.getX(e)),i.push(s.getX(e+1)),i.push(s.getX(e+2))):(i.push(s.getX(e+2)),i.push(s.getX(e+1)),i.push(s.getX(e)));i.length;const o=e.clone();return o.setIndex(i),o.clearGroups(),o}return e}class nt extends A{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new ct(e)}),this.register(function(e){return new ht(e)}),this.register(function(e){return new wt(e)}),this.register(function(e){return new vt(e)}),this.register(function(e){return new yt(e)}),this.register(function(e){return new ut(e)}),this.register(function(e){return new mt(e)}),this.register(function(e){return new pt(e)}),this.register(function(e){return new ft(e)}),this.register(function(e){return new lt(e)}),this.register(function(e){return new gt(e)}),this.register(function(e){return new dt(e)}),this.register(function(e){return new xt(e)}),this.register(function(e){return new bt(e)}),this.register(function(e){return new at(e)}),this.register(function(e){return new jt(e)}),this.register(function(e){return new St(e)})}load(e,t,s,n){const i=this;let o;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){const t=M.extractUrlBase(e);o=M.resolveURL(t,this.path)}else o=M.extractUrlBase(e);this.manager.itemStart(e);const a=function(t){n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)},r=new T(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,function(s){try{i.parse(s,o,function(s){t(s),i.manager.itemEnd(e)},a)}catch(n){a(n)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let i;const o={},a={},r=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer){if(r.decode(new Uint8Array(e,0,4))===At){try{o[ot.KHR_BINARY_GLTF]=new Ot(e)}catch(c){return void(n&&n(c))}i=JSON.parse(o[ot.KHR_BINARY_GLTF].content)}else i=JSON.parse(r.decode(e))}else i=e;if(void 0===i.asset||i.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Jt(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const e=this.pluginCallbacks[h](l);e.name,a[e.name]=e,o[e.name]=!0}if(i.extensionsUsed)for(let h=0;h<i.extensionsUsed.length;++h){const e=i.extensionsUsed[h],t=i.extensionsRequired||[];switch(e){case ot.KHR_MATERIALS_UNLIT:o[e]=new rt;break;case ot.KHR_DRACO_MESH_COMPRESSION:o[e]=new Et(i,this.dracoLoader);break;case ot.KHR_TEXTURE_TRANSFORM:o[e]=new _t;break;case ot.KHR_MESH_QUANTIZATION:o[e]=new Ct;break;default:t.indexOf(e)>=0&&a[e]}}l.setExtensions(o),l.setPlugins(a),l.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,i){s.parse(e,t,n,i)})}}function it(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const ot={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class at{constructor(e){this.parser=e,this.name=ot.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const i=t.json,o=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let a;const r=new h(16777215);void 0!==o.color&&r.setRGB(o.color[0],o.color[1],o.color[2],O);const l=void 0!==o.range?o.range:0;switch(o.type){case"directional":a=new f(r),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new _(r),a.distance=l;break;case"spot":a=new E(r),a.distance=l,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,a.angle=o.spot.outerConeAngle,a.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return a.position.set(0,0,0),a.decay=2,Wt(a,o),void 0!==o.intensity&&(a.intensity=o.intensity),a.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(a),t.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],i=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return s._getNodeRef(t.cache,i,e)})}}class rt{constructor(){this.name=ot.KHR_MATERIALS_UNLIT}getMaterialType(){return C}extendParams(e,t,s){const n=[];e.color=new h(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],O),e.opacity=t[3]}void 0!==i.baseColorTexture&&n.push(s.assignTexture(e,"map",i.baseColorTexture,R))}return Promise.all(n)}}class lt{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}}class ct{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new N(e,e)}return Promise.all(i)}}class ht{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.dispersion=void 0!==n.dispersion?n.dispersion:0,Promise.resolve()}}class dt{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(s.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(s.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class ut{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new h(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(void 0!==o.sheenColorFactor){const e=o.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],O)}return void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&i.push(s.assignTexture(t,"sheenColorMap",o.sheenColorTexture,R)),void 0!==o.sheenRoughnessTexture&&i.push(s.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(i)}}class mt{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class pt{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&i.push(s.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=(new h).setRGB(a[0],a[1],a[2],O),Promise.all(i)}}class ft{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class gt{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&i.push(s.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=(new h).setRGB(a[0],a[1],a[2],O),void 0!==o.specularColorTexture&&i.push(s.assignTexture(t,"specularColorMap",o.specularColorTexture,R)),Promise.all(i)}}class bt{constructor(e){this.parser=e,this.name=ot.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&i.push(s.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class xt{constructor(e){this.parser=e,this.name=ot.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?P:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],o=n.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(s.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class wt{constructor(e){this.parser=e,this.name=ot.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,o)}}class vt{constructor(e){this.parser=e,this.name=ot.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],a=n.images[o.source];let r=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(r=e)}return this.detectSupport().then(function(i){if(i)return s.loadTextureImage(e,o.source,r);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class yt{constructor(e){this.parser=e,this.name=ot.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],a=n.images[o.source];let r=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(r=e)}return this.detectSupport().then(function(i){if(i)return s.loadTextureImage(e,o.source,r);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class jt{constructor(e){this.name=ot.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(t){const s=e.byteOffset||0,n=e.byteLength||0,o=e.count,a=e.byteStride,r=new Uint8Array(t,s,n);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,a,r,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){const t=new ArrayBuffer(o*a);return i.decodeGltfBuffer(new Uint8Array(t),o,a,r,e.mode,e.filter),t})})}return null}}class St{constructor(e){this.name=ot.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const n=t.meshes[s.mesh];for(const r of n.primitives)if(r.mode!==It.TRIANGLES&&r.mode!==It.TRIANGLE_STRIP&&r.mode!==It.TRIANGLE_FAN&&void 0!==r.mode)return null;const i=s.extensions[this.name].attributes,o=[],a={};for(const r in i)o.push(this.parser.getDependency("accessor",i[r]).then(e=>(a[r]=e,a[r])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{const t=e.pop(),s=t.isGroup?t.children:[t],n=e[0].count,i=[];for(const o of s){const e=new I,t=new L,s=new me,r=new L(1,1,1),l=new k(o.geometry,o.material,n);for(let i=0;i<n;i++)a.TRANSLATION&&t.fromBufferAttribute(a.TRANSLATION,i),a.ROTATION&&s.fromBufferAttribute(a.ROTATION,i),a.SCALE&&r.fromBufferAttribute(a.SCALE,i),l.setMatrixAt(i,e.compose(t,s,r));for(const n in a)if("_COLOR_0"===n){const e=a[n];l.instanceColor=new D(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==n&&"ROTATION"!==n&&"SCALE"!==n&&o.geometry.setAttribute(n,a[n]);H.prototype.copy.call(l,o),this.parser.assignFinalMaterial(l),i.push(l)}return t.isGroup?(t.clear(),t.add(...i),t):i[0]}))}}const At="glTF",Mt=1313821514,Tt=5130562;class Ot{constructor(e){this.name=ot.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==At)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<n;){const t=i.getUint32(o,!0);o+=4;const n=i.getUint32(o,!0);if(o+=4,n===Mt){const n=new Uint8Array(e,12+o,t);this.content=s.decode(n)}else if(n===Tt){const s=12+o;this.body=e.slice(s,s+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Et{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=ot.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},r={},l={};for(const c in o){const e=Ft[c]||c.toLowerCase();a[e]=o[c]}for(const c in e.attributes){const t=Ft[c]||c.toLowerCase();if(void 0!==o[c]){const n=s.accessors[e.attributes[c]],i=Lt[n.componentType];l[t]=i.name,r[t]=!0===n.normalized}}return t.getDependency("bufferView",i).then(function(e){return new Promise(function(t,s){n.decodeDracoFile(e,function(e){for(const t in e.attributes){const s=e.attributes[t],n=r[t];void 0!==n&&(s.normalized=n)}t(e)},a,l,O,s)})})}}class _t{constructor(){this.name=ot.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Ct{constructor(){this.name=ot.KHR_MESH_QUANTIZATION}}class Rt extends Ee{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let o=0;o!==n;o++)t[o]=s[i+o];return t}interpolate_(e,t,s,n){const i=this.resultBuffer,o=this.sampleValues,a=this.valueSize,r=2*a,l=3*a,c=n-t,h=(s-t)/c,d=h*h,u=d*h,m=e*l,p=m-l,f=-2*u+3*d,g=u-d,b=1-f,x=g-d+h;for(let w=0;w!==a;w++){const e=o[p+w+a],t=o[p+w+r]*c,s=o[m+w+a],n=o[m+w]*c;i[w]=b*e+x*t+f*s+g*n}return i}}const Pt=new me;class Nt extends Rt{interpolate_(e,t,s,n){const i=super.interpolate_(e,t,s,n);return Pt.fromArray(i).normalize().toArray(i),i}}const It={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Lt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},kt={9728:G,9729:U,9984:pe,9985:fe,9986:ge,9987:V},Dt={33071:be,33648:xe,10497:K},Ht={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Ft={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},zt={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Bt={CUBICSPLINE:void 0,LINEAR:de,STEP:we},Xt="OPAQUE",Ut="MASK",Vt="BLEND";function Kt(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new Q({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ve})),e.DefaultMaterial}function Gt(e,t,s){for(const n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function Wt(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function Yt(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}}}function Zt(e){let t;const s=e.extensions&&e.extensions[ot.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+Qt(s.attributes):e.indices+":"+Qt(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+Qt(e.targets[n]);return t}function Qt(e){let t="";const s=Object.keys(e).sort();for(let n=0,i=s.length;n<i;n++)t+=s[n]+":"+e[s[n]]+";";return t}function qt(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const $t=new I;class Jt{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new it,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,i=!1,o=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;s=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);n=s&&t?parseInt(t[1],10):-1,i=e.indexOf("Firefox")>-1,o=i?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||s&&n<17||i&&o<98?this.textureLoader=new F(this.options.manager):this.textureLoader=new z(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new T(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){const o={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};return Gt(i,o,n),Wt(o,n),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(const e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const s=t[n].joints;for(let t=0,n=s.length;t<n;t++)e[s[t]].isBone=!0}for(let n=0,i=e.length;n<i;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),i=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[n,o]of e.children.entries())i(o,t.children[n])};return i(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const i=e(t[n]);i&&s.push(i)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":n=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[ot.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(e,i){s.load(M.resolveURL(t.uri,n.path),e,void 0,function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=Ht[n.type],t=Lt[n.componentType],s=!0===n.normalized,i=new t(n.count*e);return Promise.resolve(new B(i,e,s))}const i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(e){const i=e[0],o=Ht[n.type],a=Lt[n.componentType],r=a.BYTES_PER_ELEMENT,l=r*o,c=n.byteOffset||0,h=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;let u,m;if(h&&h!==l){const e=Math.floor(c/h),s="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let l=t.cache.get(s);l||(u=new a(i,e*h,n.count*h/r),l=new X(u,h/r),t.cache.add(s,l)),m=new ye(l,o,c%h/r,d)}else u=null===i?new a(n.count*o):new a(i,c,n.count*o),m=new B(u,o,d);if(void 0!==n.sparse){const t=Ht.SCALAR,s=Lt[n.sparse.indices.componentType],r=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,c=new s(e[1],r,n.sparse.count*t),h=new a(e[2],l,n.sparse.count*o);null!==i&&(m=new B(m.array.slice(),m.itemSize,m.normalized)),m.normalized=!1;for(let e=0,n=c.length;e<n;e++){const t=c[e];if(m.setX(t,h[e*o]),o>=2&&m.setY(t,h[e*o+1]),o>=3&&m.setZ(t,h[e*o+2]),o>=4&&m.setW(t,h[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}m.normalized=d}return m})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,i=t.images[n];let o=this.textureLoader;if(i.uri){const e=s.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,n,o)}loadTextureImage(e,t,s){const n=this,i=this.json,o=i.textures[e],a=i.images[t],r=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[r])return this.textureCache[r];const l=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=o.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);const s=(i.samplers||{})[o.sampler]||{};return t.magFilter=kt[s.magFilter]||U,t.minFilter=kt[s.minFilter]||V,t.wrapS=Dt[s.wrapS]||K,t.wrapT=Dt[s.wrapT]||K,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==G&&t.minFilter!==U,n.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[r]=l,l}loadImageSource(e,t){const s=this,n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const o=n.images[e],a=self.URL||self.webkitURL;let r=o.uri||"",l=!1;if(void 0!==o.bufferView)r=s.getDependency("bufferView",o.bufferView).then(function(e){l=!0;const t=new Blob([e],{type:o.mimeType});return r=a.createObjectURL(t),r});else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(r).then(function(e){return new Promise(function(s,n){let o=s;!0===t.isImageBitmapLoader&&(o=function(e){const t=new je(e);t.needsUpdate=!0,s(t)}),t.load(M.resolveURL(e,i.path),o,void 0,n)})}).then(function(e){var t;return!0===l&&a.revokeObjectURL(r),Wt(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw e});return this.sourceCache[e]=c,c}assignTexture(e,t,s,n){const i=this;return this.getDependency("texture",s.index).then(function(o){if(!o)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((o=o.clone()).channel=s.texCoord),i.extensions[ot.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[ot.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(o);o=i.extensions[ot.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==n&&(o.colorSpace=n),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=void 0===t.attributes.tangent,i=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new W,Y.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Z,Y.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(n||i||o){let e="ClonedMaterial:"+s.uuid+":";n&&(e+="derivative-tangents:"),i&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),i&&(t.vertexColors=!0),o&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return Q}loadMaterial(e){const t=this,s=this.json,n=this.extensions,i=s.materials[e];let o;const a={},r=[];if((i.extensions||{})[ot.KHR_MATERIALS_UNLIT]){const e=n[ot.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),r.push(e.extendParams(a,i,t))}else{const s=i.pbrMetallicRoughness||{};if(a.color=new h(1,1,1),a.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],O),a.opacity=e[3]}void 0!==s.baseColorTexture&&r.push(t.assignTexture(a,"map",s.baseColorTexture,R)),a.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,a.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(r.push(t.assignTexture(a,"metalnessMap",s.metallicRoughnessTexture)),r.push(t.assignTexture(a,"roughnessMap",s.metallicRoughnessTexture))),o=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),r.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===i.doubleSided&&(a.side=q);const l=i.alphaMode||Xt;if(l===Vt?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,l===Ut&&(a.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&o!==C&&(r.push(t.assignTexture(a,"normalMap",i.normalTexture)),a.normalScale=new N(1,1),void 0!==i.normalTexture.scale)){const e=i.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==i.occlusionTexture&&o!==C&&(r.push(t.assignTexture(a,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(a.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&o!==C){const e=i.emissiveFactor;a.emissive=(new h).setRGB(e[0],e[1],e[2],O)}return void 0!==i.emissiveTexture&&o!==C&&r.push(t.assignTexture(a,"emissiveMap",i.emissiveTexture,R)),Promise.all(r).then(function(){const s=new o(a);return i.name&&(s.name=i.name),Wt(s,i),t.associations.set(s,{materials:e}),i.extensions&&Gt(n,s,i),s})}createUniqueName(e){const t=$.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function i(e){return s[ot.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return es(s,e,t)})}const o=[];for(let a=0,r=e.length;a<r;a++){const s=e[a],r=Zt(s),l=n[r];if(l)o.push(l.promise);else{let e;e=s.extensions&&s.extensions[ot.KHR_DRACO_MESH_COMPRESSION]?i(s):es(new J,s,t),n[r]={primitive:s,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,s=this.json,n=this.extensions,i=s.meshes[e],o=i.primitives,a=[];for(let r=0,l=o.length;r<l;r++){const e=void 0===o[r].material?Kt(this.cache):this.getDependency("material",o[r].material);a.push(e)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(s){const a=s.slice(0,s.length-1),r=s[s.length-1],l=[];for(let h=0,d=r.length;h<d;h++){const s=r[h],c=o[h];let d;const u=a[h];if(c.mode===It.TRIANGLES||c.mode===It.TRIANGLE_STRIP||c.mode===It.TRIANGLE_FAN||void 0===c.mode)d=!0===i.isSkinnedMesh?new ee(s,u):new x(s,u),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),c.mode===It.TRIANGLE_STRIP?d.geometry=st(d.geometry,S):c.mode===It.TRIANGLE_FAN&&(d.geometry=st(d.geometry,j));else if(c.mode===It.LINES)d=new te(s,u);else if(c.mode===It.LINE_STRIP)d=new se(s,u);else if(c.mode===It.LINE_LOOP)d=new ne(s,u);else{if(c.mode!==It.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);d=new ie(s,u)}Object.keys(d.geometry.morphAttributes).length>0&&Yt(d,i),d.name=t.createUniqueName(i.name||"mesh_"+e),Wt(d,i),c.extensions&&Gt(n,d,c),t.assignFinalMaterial(d),l.push(d)}for(let n=0,i=l.length;n<i;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return i.extensions&&Gt(n,l[0],i),l[0];const c=new oe;i.extensions&&Gt(n,c,i),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new d(ae.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new re(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),Wt(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,i=t.joints.length;n<i;n++)s.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){const t=e.pop(),s=e,n=[],i=[];for(let o=0,a=s.length;o<a;o++){const e=s[o];if(e){n.push(e);const s=new I;null!==t&&s.fromArray(t.array,16*o),i.push(s)}}return new le(n,i)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],i=n.name?n.name:"animation_"+e,o=[],a=[],r=[],l=[],c=[];for(let h=0,d=n.channels.length;h<d;h++){const e=n.channels[h],t=n.samplers[e.sampler],s=e.target,i=s.node,d=void 0!==n.parameters?n.parameters[t.input]:t.input,u=void 0!==n.parameters?n.parameters[t.output]:t.output;void 0!==s.node&&(o.push(this.getDependency("node",i)),a.push(this.getDependency("accessor",d)),r.push(this.getDependency("accessor",u)),l.push(t),c.push(s))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(r),Promise.all(l),Promise.all(c)]).then(function(e){const t=e[0],n=e[1],o=e[2],a=e[3],r=e[4],l=[];for(let i=0,c=t.length;i<c;i++){const e=t[i],c=n[i],h=o[i],d=a[i],u=r[i];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const m=s._createAnimationTracks(e,c,h,d,u);if(m)for(let t=0;t<m.length;t++)l.push(m[t])}return new ce(i,void 0,l)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]}),t})}loadNode(e){const t=this,s=this.json.nodes[e],n=t._loadNodeShallow(e),i=[],o=s.children||[];for(let r=0,l=o.length;r<l;r++)i.push(t.getDependency("node",o[r]));const a=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([n,Promise.all(i),a]).then(function(e){const t=e[0],s=e[1],n=e[2];null!==n&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(n,$t)});for(let i=0,o=s.length;i<o;i++)t.add(s[i]);return t})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const i=t.nodes[e],o=i.name?n.createUniqueName(i.name):"",a=[],r=n._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return r&&a.push(r),void 0!==i.camera&&a.push(n.getDependency("camera",i.camera).then(function(e){return n._getNodeRef(n.cameraCache,i.camera,e)})),n._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if(a=!0===i.isBone?new he:t.length>1?new oe:1===t.length?t[0]:new H,a!==t[0])for(let e=0,s=t.length;e<s;e++)a.add(t[e]);if(i.name&&(a.userData.name=i.name,a.name=o),Wt(a,i),i.extensions&&Gt(s,a,i),void 0!==i.matrix){const e=new I;e.fromArray(i.matrix),a.applyMatrix4(e)}else void 0!==i.translation&&a.position.fromArray(i.translation),void 0!==i.rotation&&a.quaternion.fromArray(i.rotation),void 0!==i.scale&&a.scale.fromArray(i.scale);return n.associations.has(a)||n.associations.set(a,{}),n.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,i=new oe;s.name&&(i.name=n.createUniqueName(s.name)),Wt(i,s),s.extensions&&Gt(t,i,s);const o=s.nodes||[],a=[];for(let r=0,l=o.length;r<l;r++)a.push(n.getDependency("node",o[r]));return Promise.all(a).then(function(e){for(let t=0,s=e.length;t<s;t++)i.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[s,i]of n.associations)(s instanceof Y||s instanceof je)&&t.set(s,i);return e.traverse(e=>{const s=n.associations.get(e);null!=s&&t.set(e,s)}),t})(i),i})}_createAnimationTracks(e,t,s,n,i){const o=[],a=e.name?e.name:e.uuid,r=[];let l;switch(zt[i.path]===zt.weights?e.traverse(function(e){e.morphTargetInfluences&&r.push(e.name?e.name:e.uuid)}):r.push(a),zt[i.path]){case zt.weights:l=Ae;break;case zt.rotation:l=Me;break;case zt.position:case zt.scale:l=Se;break;default:if(1===s.itemSize)l=Ae;else l=Se}const c=void 0!==n.interpolation?Bt[n.interpolation]:de,h=this._getArrayFromAccessor(s);for(let d=0,u=r.length;d<u;d++){const e=new l(r[d]+"."+zt[i.path],t.array,h,c);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(e),o.push(e)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=qt(t.constructor),s=new Float32Array(t.length);for(let n=0,i=t.length;n<i;n++)s[n]=t[n]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof Me?Nt:Rt)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function es(e,t,s){const n=t.attributes,i=[];function o(t,n){return s.getDependency("accessor",t).then(function(t){e.setAttribute(n,t)})}for(const a in n){const t=Ft[a]||a.toLowerCase();t in e.attributes||i.push(o(n[a],t))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});i.push(n)}return ue.workingColorSpace,Wt(e,t),function(e,t,s){const n=t.attributes,i=new Te;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return;if(i.set(new L(t[0],t[1],t[2]),new L(o[0],o[1],o[2])),e.normalized){const t=qt(Lt[e.componentType]);i.min.multiplyScalar(t),i.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new L,t=new L;for(let n=0,i=o.length;n<i;n++){const i=o[n];if(void 0!==i.POSITION){const n=s.json.accessors[i.POSITION],o=n.min,a=n.max;if(void 0!==o&&void 0!==a){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(a[2]))),n.normalized){const e=qt(Lt[n.componentType]);t.multiplyScalar(e)}e.max(t)}}}i.expandByVector(e)}e.boundingBox=i;const a=new Oe;i.getCenter(a.center),a.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=a}(e,t,s),Promise.all(i).then(function(){return void 0!==t.targets?function(e,t,s){let n=!1,i=!1,o=!1;for(let c=0,h=t.length;c<h;c++){const e=t[c];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(i=!0),void 0!==e.COLOR_0&&(o=!0),n&&i&&o)break}if(!n&&!i&&!o)return Promise.resolve(e);const a=[],r=[],l=[];for(let c=0,h=t.length;c<h;c++){const h=t[c];if(n){const t=void 0!==h.POSITION?s.getDependency("accessor",h.POSITION):e.attributes.position;a.push(t)}if(i){const t=void 0!==h.NORMAL?s.getDependency("accessor",h.NORMAL):e.attributes.normal;r.push(t)}if(o){const t=void 0!==h.COLOR_0?s.getDependency("accessor",h.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(r),Promise.all(l)]).then(function(t){const s=t[0],a=t[1],r=t[2];return n&&(e.morphAttributes.position=s),i&&(e.morphAttributes.normal=a),o&&(e.morphAttributes.color=r),e.morphTargetsRelative=!0,e})}(e,t.targets,s):e})}const ts=r((e,t)=>({scene:null,camera:null,renderer:null,selectedObject:null,transformMode:"translate",floorWidth:50,floorDepth:50,savedObjects:new Map,objects:[{id:"test_cube",name:"Test Cube",position:[0,1,0],rotation:[0,0,0],scale:[1,1,1],type:"test",visible:!0},{id:"tree_trunk",name:"Tree Trunk",position:[5,1.5,0],rotation:[0,0,0],scale:[1,1,1],type:"test",visible:!0},{id:"tree_leaves",name:"Tree Leaves",position:[5,4,0],rotation:[0,0,0],scale:[1,1,1],type:"test",visible:!0}],walls:[],setSelectedObject:t=>e({selectedObject:t}),setTransformMode:t=>e({transformMode:t}),setFloorSize:(t,s)=>e({floorWidth:t,floorDepth:s}),addAsset:(t,s)=>e(e=>{const n=new Map(e.savedObjects);return n.set(t,s),{savedObjects:n}}),addObject:t=>e(e=>({objects:[...e.objects,t]})),removeObject:t=>e(e=>({objects:e.objects.filter(e=>e!==t),selectedObject:e.selectedObject===t?null:e.selectedObject})),addWall:t=>e(e=>({walls:[...e.walls,t]})),removeWall:t=>e(e=>({walls:e.walls.filter(e=>e.id!==t)})),updateObject:(t,s)=>e(e=>({objects:e.objects.map(e=>e.id===t?{...e,...s}:e)})),updateWall:(t,s)=>e(e=>({walls:e.walls.map(e=>e.id===t?{...e,...s}:e)})),toggleObjectVisibility:t=>e(e=>{const s=!1===t.visible;return{objects:e.objects.map(e=>e.id===t.id?{...e,visible:s}:e),walls:e.walls.map(e=>e.id===t.id?{...e,visible:s}:e)}}),renameObject:(t,s)=>e(e=>({objects:e.objects.map(e=>e.id===t?{...e,name:s}:e),walls:e.walls.map(e=>e.id===t?{...e,name:s}:e)})),saveMap:e=>{const s=t(),n={floor:{width:s.floorWidth,depth:s.floorDepth},walls:s.walls,objects:s.objects};localStorage.setItem(`map_${e}`,JSON.stringify(n))},loadMap:t=>{const s=localStorage.getItem(`map_${t}`);if(s){const t=JSON.parse(s);return e({floorWidth:t.floor.width,floorDepth:t.floor.depth,walls:t.walls||[],objects:t.objects||[]}),!0}return!1},clearMap:()=>e({objects:[],walls:[],selectedObject:null}),setScene:(t,s,n)=>e({scene:t,camera:s,renderer:n})}));class ss{constructor(e,t,s=null){this.camera=e,this.renderer=t,this.onCameraChange=s,this.initialPosition=e.position.clone(),this.initialTarget=new L(0,0,0),this.cameraTarget=new L(0,0,0),this.spherical=new _e,this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget)),this._tempVector1=new L,this._tempVector2=new L,this._tempVector3=new L}resetCamera(){this.camera.position.copy(this.initialPosition),this.cameraTarget.copy(this.initialTarget),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}toggleProjection(){const e=this.camera,t=e.position.clone(),s=this.cameraTarget.clone();if(e.isPerspectiveCamera){const e=t.distanceTo(s),n=window.innerWidth/window.innerHeight,i=.5*e,o=new re(i*n/-2,i*n/2,i/2,i/-2,.1,1e3);o.position.copy(t),o.lookAt(s),o.updateMatrixWorld(),this.camera=o}else{const e=new d(75,window.innerWidth/window.innerHeight,.1,1e3);e.position.copy(t),e.lookAt(s),e.updateMatrixWorld(),this.camera=e}return this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget)),this.onCameraChange&&this.onCameraChange(this.camera),this.camera}setView(e){const t=this.camera.position.distanceTo(this.cameraTarget),s=this.cameraTarget.clone();let n=new L;switch(e){case"front":n.set(s.x,s.y,s.z+t);break;case"side":n.set(s.x+t,s.y,s.z);break;case"top":n.set(s.x,s.y+t,s.z);break;case"bottom":n.set(s.x,s.y-t,s.z);break;default:return}this.camera.position.copy(n),this.camera.lookAt(s),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}pan(e,t){const s=new L,n=new L;s.setFromMatrixColumn(this.camera.matrix,0),n.setFromMatrixColumn(this.camera.matrix,1);const i=this.camera.position.distanceTo(this.cameraTarget)/50*50,o=new L;o.add(s.clone().multiplyScalar(-e*i)),o.add(n.clone().multiplyScalar(-t*i)),this.camera.position.add(o),this.cameraTarget.add(o),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}updateRotationCenterAfterPan(e,t=[]){const s=new Ce,n=new N(0,0);s.setFromCamera(n,this.camera);const i=s.intersectObjects(t,!0);if(i.length>0){const e=i[0].point;this.cameraTarget.copy(e)}else{const e=new L;e.setFromMatrixColumn(this.camera.matrix,2).negate();const t=this.camera.position.clone().add(e.multiplyScalar(50));this.cameraTarget.copy(t)}this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}orbit(e,t){this.spherical.theta-=100*e*.01,this.spherical.phi+=100*t*.01,this.spherical.phi=Math.max(.1,Math.min(Math.PI-.1,this.spherical.phi));const s=new L;s.setFromSpherical(this.spherical),s.add(this.cameraTarget),this.camera.position.copy(s),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld()}zoom(e){const t=e>0?1.2:1/1.2;if(this.camera.isPerspectiveCamera){this.spherical.radius*=t,this.spherical.radius=Math.max(1,Math.min(1e3,this.spherical.radius));const e=new L;e.setFromSpherical(this.spherical),e.add(this.cameraTarget),this.camera.position.copy(e),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld()}else if(this.camera.isOrthographicCamera){const e=(this.camera.right-this.camera.left)*t,s=(this.camera.top-this.camera.bottom)*t,n=2e3,i=.1,o=Math.max(i,Math.min(n,e)),a=Math.max(i,Math.min(n,s));this.camera.left=-o/2,this.camera.right=o/2,this.camera.top=a/2,this.camera.bottom=-a/2,this.camera.updateProjectionMatrix()}}focusOnObject(e){if(!e)return;const t=(new Te).setFromObject(e),s=t.getCenter(new L),n=t.getSize(new L),i=Math.max(n.x,n.y,n.z);let o;if(this.camera.isPerspectiveCamera){const e=this.camera.fov*(Math.PI/180);o=1.5*Math.abs(i/Math.sin(e/2))}else o=2*i;this.cameraTarget.copy(s);const a=new L;a.subVectors(this.camera.position,this.cameraTarget).normalize(),this.camera.position.copy(s).add(a.multiplyScalar(o)),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}handleResize(){if(this.camera.isPerspectiveCamera)this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix();else if(this.camera.isOrthographicCamera){const e=window.innerWidth/window.innerHeight,t=(this.camera.top-this.camera.bottom)*e;this.camera.left=-t/2,this.camera.right=t/2,this.camera.updateProjectionMatrix()}}setTarget(e){this.cameraTarget.copy(e),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}getCamera(){return this.camera}getTarget(){return this.cameraTarget.clone()}}const ns=new Ce,is=new L,os=new L,as=new me,rs={X:new L(1,0,0),Y:new L(0,1,0),Z:new L(0,0,1)},ls={type:"change"},cs={type:"mouseDown",mode:null},hs={type:"mouseUp",mode:null},ds={type:"objectChange"};class us extends Re{constructor(e,t=null){super(void 0,t);const s=new Ns(this);this._root=s;const n=new Is;this._gizmo=n,s.add(n);const i=new Ls;this._plane=i,s.add(i);const o=this;function a(e,t){let s=t;Object.defineProperty(o,e,{get:function(){return void 0!==s?s:t},set:function(t){s!==t&&(s=t,i[e]=t,n[e]=t,o.dispatchEvent({type:e+"-changed",value:t}),o.dispatchEvent(ls))}}),o[e]=t,i[e]=t,n[e]=t}a("camera",e),a("object",void 0),a("enabled",!0),a("axis",null),a("mode","translate"),a("translationSnap",null),a("rotationSnap",null),a("scaleSnap",null),a("space","world"),a("size",1),a("dragging",!1),a("showX",!0),a("showY",!0),a("showZ",!0),a("minX",-1/0),a("maxX",1/0),a("minY",-1/0),a("maxY",1/0),a("minZ",-1/0),a("maxZ",1/0);const r=new L,l=new L,c=new me,h=new me,d=new L,u=new me,m=new L,p=new L,f=new L,g=new L;a("worldPosition",r),a("worldPositionStart",l),a("worldQuaternion",c),a("worldQuaternionStart",h),a("cameraPosition",d),a("cameraQuaternion",u),a("pointStart",m),a("pointEnd",p),a("rotationAxis",f),a("rotationAngle",0),a("eye",g),this._offset=new L,this._startNorm=new L,this._endNorm=new L,this._cameraScale=new L,this._parentPosition=new L,this._parentQuaternion=new me,this._parentQuaternionInv=new me,this._parentScale=new L,this._worldScaleStart=new L,this._worldQuaternionInv=new me,this._worldScale=new L,this._positionStart=new L,this._quaternionStart=new me,this._scaleStart=new L,this._getPointer=ms.bind(this),this._onPointerDown=fs.bind(this),this._onPointerHover=ps.bind(this),this._onPointerMove=gs.bind(this),this._onPointerUp=bs.bind(this),null!==t&&this.connect()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(e){if(void 0===this.object||!0===this.dragging)return;null!==e&&ns.setFromCamera(e,this.camera);const t=xs(this._gizmo.picker[this.mode],ns);this.axis=t?t.object.name:null}pointerDown(e){if(void 0!==this.object&&!0!==this.dragging&&(null==e||0===e.button)&&null!==this.axis){null!==e&&ns.setFromCamera(e,this.camera);const t=xs(this._plane,ns,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,cs.mode=this.mode,this.dispatchEvent(cs)}}pointerMove(e){const t=this.axis,s=this.mode,n=this.object;let i=this.space;if("scale"===s?i="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(i="world"),void 0===n||null===t||!1===this.dragging||null!==e&&-1!==e.button)return;null!==e&&ns.setFromCamera(e,this.camera);const o=xs(this._plane,ns,!0);if(o){if(this.pointEnd.copy(o.point).sub(this.worldPositionStart),"translate"===s)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===i&&"XYZ"!==t&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===t.indexOf("X")&&(this._offset.x=0),-1===t.indexOf("Y")&&(this._offset.y=0),-1===t.indexOf("Z")&&(this._offset.z=0),"local"===i&&"XYZ"!==t?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),n.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===i&&(n.position.applyQuaternion(as.copy(this._quaternionStart).invert()),-1!==t.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.position.applyQuaternion(this._quaternionStart)),"world"===i&&(n.parent&&n.position.add(is.setFromMatrixPosition(n.parent.matrixWorld)),-1!==t.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.parent&&n.position.sub(is.setFromMatrixPosition(n.parent.matrixWorld)))),n.position.x=Math.max(this.minX,Math.min(this.maxX,n.position.x)),n.position.y=Math.max(this.minY,Math.min(this.maxY,n.position.y)),n.position.z=Math.max(this.minZ,Math.min(this.maxZ,n.position.z));else if("scale"===s){if(-1!==t.search("XYZ")){let e=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(e*=-1),os.set(e,e,e)}else is.copy(this.pointStart),os.copy(this.pointEnd),is.applyQuaternion(this._worldQuaternionInv),os.applyQuaternion(this._worldQuaternionInv),os.divide(is),-1===t.search("X")&&(os.x=1),-1===t.search("Y")&&(os.y=1),-1===t.search("Z")&&(os.z=1);n.scale.copy(this._scaleStart).multiply(os),this.scaleSnap&&(-1!==t.search("X")&&(n.scale.x=Math.round(n.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(n.scale.y=Math.round(n.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(n.scale.z=Math.round(n.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===s){this._offset.copy(this.pointEnd).sub(this.pointStart);const e=20/this.worldPosition.distanceTo(is.setFromMatrixPosition(this.camera.matrixWorld));let s=!1;"XYZE"===t?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(is.copy(this.rotationAxis).cross(this.eye))*e):"X"!==t&&"Y"!==t&&"Z"!==t||(this.rotationAxis.copy(rs[t]),is.copy(rs[t]),"local"===i&&is.applyQuaternion(this.worldQuaternion),is.cross(this.eye),0===is.length()?s=!0:this.rotationAngle=this._offset.dot(is.normalize())*e),("E"===t||s)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===i&&"E"!==t&&"XYZE"!==t?(n.quaternion.copy(this._quaternionStart),n.quaternion.multiply(as.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),n.quaternion.copy(as.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),n.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(ls),this.dispatchEvent(ds)}}pointerUp(e){null!==e&&0!==e.button||(this.dragging&&null!==this.axis&&(hs.mode=this.mode,this.dispatchEvent(hs)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(e){return this.object=e,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(ls),this.dispatchEvent(ds),this.pointStart.copy(this.pointEnd))}getRaycaster(){return ns}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function ms(e){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};{const t=this.domElement.getBoundingClientRect();return{x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,button:e.button}}}function ps(e){if(this.enabled)switch(e.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(e))}}function fs(e){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(e)),this.pointerDown(this._getPointer(e)))}function gs(e){this.enabled&&this.pointerMove(this._getPointer(e))}function bs(e){this.enabled&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(e)))}function xs(e,t,s){const n=t.intersectObject(e,!0);for(let i=0;i<n.length;i++)if(n[i].object.visible||s)return n[i];return!1}const ws=new ke,vs=new L(0,1,0),ys=new L(0,0,0),js=new I,Ss=new me,As=new me,Ms=new L,Ts=new I,Os=new L(1,0,0),Es=new L(0,1,0),_s=new L(0,0,1),Cs=new L,Rs=new L,Ps=new L;class Ns extends H{constructor(e){super(),this.isTransformControlsRoot=!0,this.controls=e,this.visible=!1}updateMatrixWorld(e){const t=this.controls;void 0!==t.object&&(t.object.updateMatrixWorld(),null===t.object.parent||t.object.parent.matrixWorld.decompose(t._parentPosition,t._parentQuaternion,t._parentScale),t.object.matrixWorld.decompose(t.worldPosition,t.worldQuaternion,t._worldScale),t._parentQuaternionInv.copy(t._parentQuaternion).invert(),t._worldQuaternionInv.copy(t.worldQuaternion).invert()),t.camera.updateMatrixWorld(),t.camera.matrixWorld.decompose(t.cameraPosition,t.cameraQuaternion,t._cameraScale),t.camera.isOrthographicCamera?t.camera.getWorldDirection(t.eye).negate():t.eye.copy(t.cameraPosition).sub(t.worldPosition).normalize(),super.updateMatrixWorld(e)}dispose(){this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}}class Is extends H{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new C({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new Z({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),s=e.clone();s.opacity=.15;const n=t.clone();n.opacity=.5;const i=e.clone();i.color.setHex(16711680);const o=e.clone();o.color.setHex(65280);const a=e.clone();a.color.setHex(255);const r=e.clone();r.color.setHex(16711680),r.opacity=.5;const l=e.clone();l.color.setHex(65280),l.opacity=.5;const c=e.clone();c.color.setHex(255),c.opacity=.5;const h=e.clone();h.opacity=.25;const d=e.clone();d.color.setHex(16776960),d.opacity=.25;e.clone().color.setHex(16776960);const u=e.clone();u.color.setHex(7895160);const m=new Pe(0,.04,.1,12);m.translate(0,.05,0);const p=new w(.08,.08,.08);p.translate(0,.04,0);const f=new J;f.setAttribute("position",new Ne([0,0,0,1,0,0],3));const g=new Pe(.0075,.0075,.5,3);function b(e,t){const s=new Le(e,.0075,3,64,t*Math.PI*2);return s.rotateY(Math.PI/2),s.rotateX(Math.PI/2),s}g.translate(0,.25,0);const y={X:[[new x(m,i),[.5,0,0],[0,0,-Math.PI/2]],[new x(m,i),[-.5,0,0],[0,0,Math.PI/2]],[new x(g,i),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new x(m,o),[0,.5,0]],[new x(m,o),[0,-.5,0],[Math.PI,0,0]],[new x(g,o)]],Z:[[new x(m,a),[0,0,.5],[Math.PI/2,0,0]],[new x(m,a),[0,0,-.5],[-Math.PI/2,0,0]],[new x(g,a),null,[Math.PI/2,0,0]]],XYZ:[[new x(new Ie(.1,0),h.clone()),[0,0,0]]],XY:[[new x(new w(.15,.15,.01),c.clone()),[.15,.15,0]]],YZ:[[new x(new w(.15,.15,.01),r.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new x(new w(.15,.15,.01),l.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},j={X:[[new x(new Pe(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new x(new Pe(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new x(new Pe(.2,0,.6,4),s),[0,.3,0]],[new x(new Pe(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new x(new Pe(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new x(new Pe(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new x(new Ie(.2,0),s)]],XY:[[new x(new w(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new x(new w(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new x(new w(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]]},S={START:[[new x(new Ie(.01,2),n),null,null,null,"helper"]],END:[[new x(new Ie(.01,2),n),null,null,null,"helper"]],DELTA:[[new se(function(){const e=new J;return e.setAttribute("position",new Ne([0,0,0,1,1,1],3)),e}(),n),null,null,null,"helper"]],X:[[new se(f,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new se(f,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new se(f,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},A={XYZE:[[new x(b(.5,1),u),null,[0,Math.PI/2,0]]],X:[[new x(b(.5,.5),i)]],Y:[[new x(b(.5,.5),o),null,[0,0,-Math.PI/2]]],Z:[[new x(b(.5,.5),a),null,[0,Math.PI/2,0]]],E:[[new x(b(.75,1),d),null,[0,Math.PI/2,0]]]},M={AXIS:[[new se(f,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},T={XYZE:[[new x(new v(.25,10,8),s)]],X:[[new x(new Le(.5,.1,4,24),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new x(new Le(.5,.1,4,24),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new x(new Le(.5,.1,4,24),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new x(new Le(.75,.1,2,24),s)]]},O={X:[[new x(p,i),[.5,0,0],[0,0,-Math.PI/2]],[new x(g,i),[0,0,0],[0,0,-Math.PI/2]],[new x(p,i),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new x(p,o),[0,.5,0]],[new x(g,o)],[new x(p,o),[0,-.5,0],[0,0,Math.PI]]],Z:[[new x(p,a),[0,0,.5],[Math.PI/2,0,0]],[new x(g,a),[0,0,0],[Math.PI/2,0,0]],[new x(p,a),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new x(new w(.15,.15,.01),c),[.15,.15,0]]],YZ:[[new x(new w(.15,.15,.01),r),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new x(new w(.15,.15,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new x(new w(.1,.1,.1),h.clone())]]},E={X:[[new x(new Pe(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new x(new Pe(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new x(new Pe(.2,0,.6,4),s),[0,.3,0]],[new x(new Pe(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new x(new Pe(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new x(new Pe(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new x(new w(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new x(new w(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new x(new w(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new x(new w(.2,.2,.2),s),[0,0,0]]]},_={X:[[new se(f,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new se(f,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new se(f,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function R(e){const t=new H;for(const s in e)for(let n=e[s].length;n--;){const i=e[s][n][0].clone(),o=e[s][n][1],a=e[s][n][2],r=e[s][n][3],l=e[s][n][4];i.name=s,i.tag=l,o&&i.position.set(o[0],o[1],o[2]),a&&i.rotation.set(a[0],a[1],a[2]),r&&i.scale.set(r[0],r[1],r[2]),i.updateMatrix();const c=i.geometry.clone();c.applyMatrix4(i.matrix),i.geometry=c,i.renderOrder=1/0,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=R(y)),this.add(this.gizmo.rotate=R(A)),this.add(this.gizmo.scale=R(O)),this.add(this.picker.translate=R(j)),this.add(this.picker.rotate=R(T)),this.add(this.picker.scale=R(E)),this.add(this.helper.translate=R(S)),this.add(this.helper.rotate=R(M)),this.add(this.helper.scale=R(_)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const t="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:As;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let n=0;n<s.length;n++){const e=s[n];let i;if(e.visible=!0,e.rotation.set(0,0,0),e.position.copy(this.worldPosition),i=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),e.scale.set(1,1,1).multiplyScalar(i*this.size/4),"helper"!==e.tag){if(e.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){const s=.99,n=.2;"X"===e.name&&Math.abs(vs.copy(Os).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"Y"===e.name&&Math.abs(vs.copy(Es).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"Z"===e.name&&Math.abs(vs.copy(_s).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"XY"===e.name&&Math.abs(vs.copy(_s).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"YZ"===e.name&&Math.abs(vs.copy(Os).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"XZ"===e.name&&Math.abs(vs.copy(Es).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1)}else"rotate"===this.mode&&(Ss.copy(t),vs.copy(this.eye).applyQuaternion(as.copy(t).invert()),-1!==e.name.search("E")&&e.quaternion.setFromRotationMatrix(js.lookAt(this.eye,ys,Es)),"X"===e.name&&(as.setFromAxisAngle(Os,Math.atan2(-vs.y,vs.z)),as.multiplyQuaternions(Ss,as),e.quaternion.copy(as)),"Y"===e.name&&(as.setFromAxisAngle(Es,Math.atan2(vs.x,vs.z)),as.multiplyQuaternions(Ss,as),e.quaternion.copy(as)),"Z"===e.name&&(as.setFromAxisAngle(_s,Math.atan2(vs.y,vs.x)),as.multiplyQuaternions(Ss,as),e.quaternion.copy(as)));e.visible=e.visible&&(-1===e.name.indexOf("X")||this.showX),e.visible=e.visible&&(-1===e.name.indexOf("Y")||this.showY),e.visible=e.visible&&(-1===e.name.indexOf("Z")||this.showZ),e.visible=e.visible&&(-1===e.name.indexOf("E")||this.showX&&this.showY&&this.showZ),e.material._color=e.material._color||e.material.color.clone(),e.material._opacity=e.material._opacity||e.material.opacity,e.material.color.copy(e.material._color),e.material.opacity=e.material._opacity,this.enabled&&this.axis&&(e.name===this.axis||this.axis.split("").some(function(t){return e.name===t}))&&(e.material.color.setHex(16776960),e.material.opacity=1)}else e.visible=!1,"AXIS"===e.name?(e.visible=!!this.axis,"X"===this.axis&&(as.setFromEuler(ws.set(0,0,0)),e.quaternion.copy(t).multiply(as),Math.abs(vs.copy(Os).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"Y"===this.axis&&(as.setFromEuler(ws.set(0,0,Math.PI/2)),e.quaternion.copy(t).multiply(as),Math.abs(vs.copy(Es).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"Z"===this.axis&&(as.setFromEuler(ws.set(0,Math.PI/2,0)),e.quaternion.copy(t).multiply(as),Math.abs(vs.copy(_s).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"XYZE"===this.axis&&(as.setFromEuler(ws.set(0,Math.PI/2,0)),vs.copy(this.rotationAxis),e.quaternion.setFromRotationMatrix(js.lookAt(ys,vs,Es)),e.quaternion.multiply(as),e.visible=this.dragging),"E"===this.axis&&(e.visible=!1)):"START"===e.name?(e.position.copy(this.worldPositionStart),e.visible=this.dragging):"END"===e.name?(e.position.copy(this.worldPosition),e.visible=this.dragging):"DELTA"===e.name?(e.position.copy(this.worldPositionStart),e.quaternion.copy(this.worldQuaternionStart),is.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),is.applyQuaternion(this.worldQuaternionStart.clone().invert()),e.scale.copy(is),e.visible=this.dragging):(e.quaternion.copy(t),this.dragging?e.position.copy(this.worldPositionStart):e.position.copy(this.worldPosition),this.axis&&(e.visible=-1!==this.axis.search(e.name)))}super.updateMatrixWorld(e)}}class Ls extends x{constructor(){super(new g(1e5,1e5,2,2),new C({visible:!1,wireframe:!0,side:q,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(t="local"),Cs.copy(Os).applyQuaternion("local"===t?this.worldQuaternion:As),Rs.copy(Es).applyQuaternion("local"===t?this.worldQuaternion:As),Ps.copy(_s).applyQuaternion("local"===t?this.worldQuaternion:As),vs.copy(Rs),this.mode){case"translate":case"scale":switch(this.axis){case"X":vs.copy(this.eye).cross(Cs),Ms.copy(Cs).cross(vs);break;case"Y":vs.copy(this.eye).cross(Rs),Ms.copy(Rs).cross(vs);break;case"Z":vs.copy(this.eye).cross(Ps),Ms.copy(Ps).cross(vs);break;case"XY":Ms.copy(Ps);break;case"YZ":Ms.copy(Cs);break;case"XZ":vs.copy(Ps),Ms.copy(Rs);break;case"XYZ":case"E":Ms.set(0,0,0)}break;default:Ms.set(0,0,0)}0===Ms.length()?this.quaternion.copy(this.cameraQuaternion):(Ts.lookAt(is.set(0,0,0),Ms,vs),this.quaternion.setFromRotationMatrix(Ts)),super.updateMatrixWorld(e)}}class ks{constructor(e,t,s,n){this.scene=e,this.camera=t,this.renderer=s,this.editorStore=n,this.selectedObjects=[],this.lastSelectedObject=null,this.selectableObjects=[],this.raycaster=new Ce,this.selectionBox=null,this.createSelectionBox(),this.transformControls=null,this.gizmoMode="translate",this.isDragging=!1,this.initialTransformStates=new Map,this.initializeTransformControls()}saveInitialTransformStates(){this.initialTransformStates.clear();for(const e of this.selectedObjects)e&&e.position&&e.rotation&&e.scale&&this.initialTransformStates.set(e,{position:e.position.clone(),rotation:e.rotation.clone(),scale:e.scale.clone()})}applyTransformToSelectedObjects(){if(!this.lastSelectedObject||!this.transformControls.object||this.selectedObjects.length<=1)return void(this.lastSelectedObject&&this.updateSelectionOutline(this.lastSelectedObject));const e=this.lastSelectedObject,t=this.initialTransformStates.get(e);if(t){for(const s of this.selectedObjects)if(s&&s!==e){const n=this.initialTransformStates.get(s);n&&this.applyRelativeTransform(s,e,t,n)}for(const e of this.selectedObjects)e&&this.updateSelectionOutline(e)}}applyRelativeTransform(e,t,s,n){switch(this.transformControls.getMode()){case"translate":const i=(new L).subVectors(t.position,s.position);e.position.copy(n.position).add(i);break;case"rotate":const o=new ke(t.rotation.x-s.rotation.x,t.rotation.y-s.rotation.y,t.rotation.z-s.rotation.z);e.rotation.copy(n.rotation),e.rotation.x+=o.x,e.rotation.y+=o.y,e.rotation.z+=o.z;break;case"scale":const a=new L(t.scale.x/s.scale.x,t.scale.y/s.scale.y,t.scale.z/s.scale.z);e.scale.copy(n.scale).multiply(a)}}initializeTransformControls(){try{this.transformControls=new us(this.camera,this.renderer.domElement),this.transformControls.addEventListener("dragging-changed",e=>{this.isDragging=e.value,e.value?this.saveInitialTransformStates():this.initialTransformStates.clear()}),this.transformControls.addEventListener("change",()=>{this.applyTransformToSelectedObjects()}),this.transformControls.setSize(1);const e=this.transformControls.getHelper();e instanceof H&&(e.renderOrder=999,this.scene.add(e))}catch(e){this.transformControls=null}}createSelectionBox(){this.selectionBox=document.createElement("div"),this.selectionBox.style.position="absolute",this.selectionBox.style.border="2px dashed #007acc",this.selectionBox.style.backgroundColor="rgba(0, 122, 204, 0.1)",this.selectionBox.style.pointerEvents="none",this.selectionBox.style.display="none",this.selectionBox.style.zIndex="1000",document.body.appendChild(this.selectionBox)}isObjectValidForSelection(e){return e&&(e.isMesh||e.isGroup)&&e.userData&&e.visible}selectSingleObject(e){if(e&&this.isObjectValidForSelection(e)){if(this.cleanupSelectedObjects(),this.deselectAllObjects(),this.selectedObjects=[e],this.lastSelectedObject=e,this.editorStore.getState().setSelectedObject(e),this.transformControls&&e.parent){let t=!1,s=e;for(;s.parent;)if(s=s.parent,s===this.scene){t=!0;break}t&&(this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}this.addSelectionOutline(e)}}selectMultipleObjects(e,t=!1){if(e&&Array.isArray(e)){t||this.deselectAllObjects();for(const t of e)t&&!this.selectedObjects.includes(t)&&(this.selectedObjects.push(t),this.lastSelectedObject=t,this.addSelectionOutline(t));this.lastSelectedObject&&this.transformControls&&(this.editorStore.getState().setSelectedObject(this.lastSelectedObject),this.transformControls.attach(this.lastSelectedObject),this.setGizmoMode(this.gizmoMode))}}toggleObjectSelection(e){if(!e)return;const t=this.selectedObjects.indexOf(e);if(t>-1)if(this.selectedObjects.splice(t,1),this.removeSelectionOutline(e),this.lastSelectedObject===e&&(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null),this.selectedObjects.length>0&&this.transformControls){const e=this.lastSelectedObject||this.selectedObjects[0];this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode)}else this.editorStore.getState().setSelectedObject(null),this.lastSelectedObject=null,this.transformControls&&this.transformControls.detach();else this.selectedObjects.push(e),this.lastSelectedObject=e,this.addSelectionOutline(e),this.transformControls&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}deselectAllObjects(){if(this.transformControls)try{this.transformControls.detach()}catch(e){}this.cleanupSelectedObjects();for(const t of this.selectedObjects)if(t)try{this.removeSelectionOutline(t)}catch(e){}this.selectedObjects=[],this.lastSelectedObject=null,this.editorStore.getState().setSelectedObject(null)}cleanupSelectedObjects(){this.selectedObjects=this.selectedObjects.filter(e=>{const t=this.isObjectValidForSelection(e);if(!t)try{this.removeSelectionOutline(e)}catch(s){}return t}),this.lastSelectedObject&&!this.isObjectValidForSelection(this.lastSelectedObject)&&(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null)}handleObjectSelection(e,t=!1){if(this.transformControls&&this.transformControls.dragging)return;this.raycaster.setFromCamera(e,this.camera);const s=this.raycaster.intersectObjects(this.selectableObjects,!0);if(s.length>0){let e=s[0].object;for(;e.parent&&!this.selectableObjects.includes(e);)e=e.parent;if(!e||!this.selectableObjects.includes(e)||!this.isObjectValidForSelection(e))return;t?this.toggleObjectSelection(e):this.selectSingleObject(e)}else t||this.deselectAllObjects()}getObjectsInArea(e,t){const s=[],n=Math.min(e.x,t.x),i=Math.max(e.x,t.x),o=Math.min(e.y,t.y),a=Math.max(e.y,t.y);for(const r of this.selectableObjects){const e=new L;r.getWorldPosition(e),e.project(this.camera),e.x>=n&&e.x<=i&&e.y>=o&&e.y<=a&&s.push(r)}return s}addSelectionOutline(e){if(e)if(e.isGroup||e.children&&e.children.length>0)this.addSelectionOutlineToGroup(e);else if(e.isMesh){this.removeSelectionOutline(e),e.userData.originalMaterial||(e.userData.originalMaterial=e.material);try{const t=e.geometry.clone(),s=new C({color:43775,side:De,transparent:!0,opacity:.6,depthWrite:!1}),n=new x(t,s);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),n.scale.multiplyScalar(1.03),n.renderOrder=e.renderOrder-1,e.parent?e.parent.add(n):this.scene.add(n),e.userData.outlineObject=n,e.material&&void 0!==e.material.emissive&&(e.userData.originalEmissive=e.material.emissive.clone(),e.userData.originalEmissiveIntensity=e.material.emissiveIntensity||0,e.material.emissive.setHex(4386),e.material.emissiveIntensity=.1)}catch(t){}}}addSelectionOutlineToGroup(e){if(e&&e.traverse){try{e.traverse(t=>{t&&t.isMesh&&t!==e&&this.addSelectionOutlineToSingleMesh(t)})}catch(t){}e.userData&&(e.userData.outlineChildren||(e.userData.outlineChildren=[]))}}addSelectionOutlineToSingleMesh(e){if(e.isMesh){this.removeSelectionOutlineFromMesh(e),e.userData.originalMaterial||(e.userData.originalMaterial=e.material);try{const t=e.geometry.clone(),s=new C({color:43775,side:De,transparent:!0,opacity:.6,depthWrite:!1}),n=new x(t,s);n.position.copy(e.position),n.rotation.copy(e.rotation),n.scale.copy(e.scale),n.scale.multiplyScalar(1.03),n.renderOrder=e.renderOrder-1,e.parent&&e.parent.add(n),e.userData.outlineObject=n,e.material&&void 0!==e.material.emissive&&(e.userData.originalEmissive=e.material.emissive.clone(),e.userData.originalEmissiveIntensity=e.material.emissiveIntensity||0,e.material.emissive.setHex(4386),e.material.emissiveIntensity=.1)}catch(t){}}}removeSelectionOutline(e){e&&(e.isGroup||e.children&&e.children.length>0?this.removeSelectionOutlineFromGroup(e):this.removeSelectionOutlineFromMesh(e))}removeSelectionOutlineFromGroup(e){if(e&&e.traverse){try{e.traverse(t=>{t&&t.isMesh&&t!==e&&this.removeSelectionOutlineFromMesh(t)})}catch(t){}e.userData&&delete e.userData.outlineChildren}}removeSelectionOutlineFromMesh(e){e&&e.userData&&(e.userData.outlineObject&&(e.userData.outlineObject.parent&&e.userData.outlineObject.parent.remove(e.userData.outlineObject),e.userData.outlineObject.geometry&&e.userData.outlineObject.geometry.dispose(),e.userData.outlineObject.material&&e.userData.outlineObject.material.dispose(),delete e.userData.outlineObject),e.material&&void 0!==e.userData.originalEmissive&&(e.material.emissive.copy(e.userData.originalEmissive),e.material.emissiveIntensity=e.userData.originalEmissiveIntensity,delete e.userData.originalEmissive,delete e.userData.originalEmissiveIntensity))}updateSelectionOutline(e){e&&(e.isGroup||e.children&&e.children.length>0?this.updateSelectionOutlineForGroup(e):this.updateSelectionOutlineForMesh(e))}updateSelectionOutlineForGroup(e){if(e&&e.traverse)try{e.traverse(t=>{t&&t.isMesh&&t!==e&&this.updateSelectionOutlineForMesh(t)})}catch(t){}}updateSelectionOutlineForMesh(e){if(!e||!e.userData||!e.userData.outlineObject)return;const t=e.userData.outlineObject;t.position.copy(e.position),t.rotation.copy(e.rotation),t.scale.copy(e.scale),t.scale.multiplyScalar(1.03)}updateAllSelectionOutlines(){this.cleanupSelectedObjects();for(const e of this.selectedObjects)e&&this.updateSelectionOutline(e)}cleanupSelectedObjects(){const e=this.selectedObjects.length;this.selectedObjects=this.selectedObjects.filter(e=>null!=e),this.selectedObjects.length!==e&&(this.selectedObjects.includes(this.lastSelectedObject)||(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null))}setGizmoMode(e){if(!this.transformControls)return;this.gizmoMode=e,this.transformControls.setMode(e);const t=this.editorStore.getState();t.setTransformMode&&t.setTransformMode(e);const s=this.editorStore.getState().selectedObject;s&&!this.transformControls.object&&this.transformControls.attach(s)}updateCamera(e){this.camera=e,this.transformControls&&(this.transformControls.camera=e)}addSelectableObject(e){this.selectableObjects.includes(e)||this.selectableObjects.push(e)}removeSelectableObject(e){const t=this.selectableObjects.indexOf(e);t>-1&&this.selectableObjects.splice(t,1)}updateSelectableObjects(e){this.selectableObjects=[...e]}showSelectionBox(e,t,s,n){this.selectionBox.style.display="block",this.selectionBox.style.left=e+"px",this.selectionBox.style.top=t+"px",this.selectionBox.style.width=s+"px",this.selectionBox.style.height=n+"px"}hideSelectionBox(){this.selectionBox.style.display="none"}getSelectedObjects(){return[...this.selectedObjects]}getSelectableObjects(){return[...this.selectableObjects]}getTransformControls(){return this.transformControls}isDraggingGizmo(){return this.isDragging}dispose(){this.transformControls&&(this.transformControls.dispose(),this.scene.remove(this.transformControls)),this.selectionBox&&this.selectionBox.parentNode&&this.selectionBox.parentNode.removeChild(this.selectionBox)}}class Ds{constructor(e,t,s,n,i=null){this.scene=e,this.renderer=s,this.editorStore=n,this.cameraController=new ss(t,s,i),this.objectSelector=new ks(e,t,s,n),this.isMouseDown=!1,this.isPanning=!1,this.isOrbiting=!1,this.isDragSelecting=!1,this.mousePosition=new N,this.previousMousePosition=new N,this.dragStartPosition=new N,this.setupEventListeners()}get camera(){return this.cameraController.getCamera()}set camera(e){this.cameraController.camera=e,this.objectSelector.updateCamera(e)}setupEventListeners(){const e=this.renderer.domElement;this.boundOnMouseDown=this.onMouseDown.bind(this),this.boundOnMouseMove=this.onMouseMove.bind(this),this.boundOnMouseUp=this.onMouseUp.bind(this),this.boundOnWheel=this.onWheel.bind(this),this.boundOnKeyDown=this.onKeyDown.bind(this),this.boundOnKeyUp=this.onKeyUp.bind(this),this.boundOnWindowResize=this.onWindowResize.bind(this),e.addEventListener("mousedown",this.boundOnMouseDown),document.addEventListener("mousemove",this.boundOnMouseMove),document.addEventListener("mouseup",this.boundOnMouseUp),e.addEventListener("wheel",this.boundOnWheel),e.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("keydown",this.boundOnKeyDown),document.addEventListener("keyup",this.boundOnKeyUp),window.addEventListener("resize",this.boundOnWindowResize)}onMouseDown(e){if(this.isMouseDown=!0,this.updateMousePosition(e),this.previousMousePosition.copy(this.mousePosition),this.dragStartPosition.copy(this.mousePosition),0===e.button){if(this.objectSelector.isDraggingGizmo())return;const t=e.ctrlKey||e.metaKey||e.shiftKey;this.isDragSelecting=!0,this.objectSelector.handleObjectSelection(this.mousePosition,t)}else 1===e.button&&(e.preventDefault(),this.isPanning=!0,e.altKey&&(this.isOrbiting=!0,this.isPanning=!1))}onMouseMove(e){if(!this.isMouseDown||this.objectSelector.isDraggingGizmo())return;this.updateMousePosition(e);const t=this.mousePosition.x-this.previousMousePosition.x,s=this.mousePosition.y-this.previousMousePosition.y;this.isDragSelecting&&0===e.button?this.updateSelectionBox(e):this.isPanning?this.cameraController.pan(t,s):this.isOrbiting&&this.cameraController.orbit(t,s),this.previousMousePosition.copy(this.mousePosition)}onMouseUp(e){this.isDragSelecting&&0===e.button&&this.finishDragSelection(e),this.isPanning&&1===e.button&&this.cameraController.updateRotationCenterAfterPan(this.scene,this.objectSelector.getSelectableObjects()),this.isMouseDown=!1,this.isPanning=!1,this.isOrbiting=!1,this.isDragSelecting=!1,this.objectSelector.hideSelectionBox()}onWheel(e){if(e.preventDefault(),this.objectSelector.isDraggingGizmo())return;const t=e.deltaY>0?1:-1;this.cameraController.zoom(.3*t)}onKeyDown(e){const t=this.editorStore.getState().selectedObject;switch(e.code){case"KeyW":this.objectSelector.setGizmoMode("translate");break;case"KeyE":this.objectSelector.setGizmoMode("rotate");break;case"KeyR":this.objectSelector.setGizmoMode("scale");break;case"KeyF":t&&this.cameraController.focusOnObject(t);break;case"Escape":this.objectSelector.deselectAllObjects();break;case"Numpad5":const e=this.cameraController.toggleProjection();this.objectSelector.updateCamera(e);break;case"Numpad1":this.cameraController.setView("front");break;case"Numpad3":this.cameraController.setView("side");break;case"Numpad7":this.cameraController.setView("top");break;case"Numpad9":this.cameraController.setView("bottom");break;case"Numpad0":this.cameraController.resetCamera()}}onKeyUp(e){}onWindowResize(){this.cameraController.handleResize(),this.renderer.setSize(window.innerWidth,window.innerHeight)}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mousePosition.x=(e.clientX-t.left)/t.width*2-1,this.mousePosition.y=-(e.clientY-t.top)/t.height*2+1}updateSelectionBox(e){const t=this.renderer.domElement.getBoundingClientRect(),s=(this.dragStartPosition.x+1)*t.width/2+t.left,n=(1-this.dragStartPosition.y)*t.height/2+t.top,i=e.clientX,o=e.clientY,a=Math.min(s,i),r=Math.min(n,o),l=Math.abs(i-s),c=Math.abs(o-n);(l>5||c>5)&&this.objectSelector.showSelectionBox(a,r,l,c)}finishDragSelection(e){const t=this.renderer.domElement.getBoundingClientRect(),s=(e.clientX-t.left)/t.width*2-1,n=-(e.clientY-t.top)/t.height*2+1,i=(this.dragStartPosition.x+1)*t.width/2,o=(1-this.dragStartPosition.y)*t.height/2,a=(s+1)*t.width/2,r=(1-n)*t.height/2;if(Math.sqrt(Math.pow(a-i,2)+Math.pow(r-o,2))<5)return;const l=this.objectSelector.getObjectsInArea(this.dragStartPosition,{x:s,y:n}),c=e.ctrlKey||e.metaKey||e.shiftKey;l.length>0?this.objectSelector.selectMultipleObjects(l,c):c||this.objectSelector.deselectAllObjects()}addSelectableObject(e){this.objectSelector.addSelectableObject(e)}removeSelectableObject(e){this.objectSelector.removeSelectableObject(e)}updateSelectableObjects(e){this.objectSelector.updateSelectableObjects(e)}getSelectedObjects(){return this.objectSelector.getSelectedObjects()}getSelectableObjects(){return this.objectSelector.getSelectableObjects()}selectObject(e){this.objectSelector.selectSingleObject(e)}findObjectById(e){let t=null;return this.scene.traverse(s=>{s.userData&&s.userData.id===e&&(t=s)}),t}deselectAllObjects(){this.objectSelector.deselectAllObjects()}setGizmoMode(e){this.objectSelector.setGizmoMode(e)}focusOnObject(e){this.cameraController.focusOnObject(e)}updateSelectedOutlines(){this.objectSelector.updateAllSelectionOutlines()}setCameraView(e){this.cameraController.setView(e)}toggleCameraProjection(){const e=this.cameraController.toggleProjection();return this.objectSelector.updateCamera(e),e}getCameraTarget(){return this.cameraController.getTarget()}setCameraTarget(e){this.cameraController.setTarget(e)}resetCamera(){this.cameraController.resetCamera()}get transformControls(){return this.objectSelector.getTransformControls()}get selectedObjects(){return this.objectSelector.getSelectedObjects()}get isDragging(){return this.objectSelector.isDraggingGizmo()}dispose(){const e=this.renderer.domElement;e.removeEventListener("mousedown",this.boundOnMouseDown),document.removeEventListener("mousemove",this.boundOnMouseMove),document.removeEventListener("mouseup",this.boundOnMouseUp),e.removeEventListener("wheel",this.boundOnWheel),document.removeEventListener("keydown",this.boundOnKeyDown),document.removeEventListener("keyup",this.boundOnKeyUp),window.removeEventListener("resize",this.boundOnWindowResize),this.objectSelector.dispose()}}function Hs({onEditorControlsReady:t}){const s=e.useRef(null),n=e.useRef(null),i=e.useRef(null),o=e.useRef(new Map),{floorWidth:a,floorDepth:r,objects:l,walls:y,setScene:j,setSelectedObject:S}=ts();return e.useEffect(()=>{if(!s.current)return;const e=new c;e.background=new h(3355443);const l=new d(75,window.innerWidth/window.innerHeight,.1,1e3);l.position.set(20,30,20),l.lookAt(0,0,0);const b=new u({antialias:!0});b.setSize(window.innerWidth,window.innerHeight),b.shadowMap.enabled=!0,b.shadowMap.type=m,b.sortObjects=!1,b.autoClear=!1,s.current.appendChild(b.domElement),i.current=e,j(e,l,b);const y=new Ds(e,l,b,ts,t=>{j(e,t,b)});n.current=y,t&&t(y);const S=new p(4210752,.6);e.add(S);const A=new f(16777215,.8);A.position.set(50,50,50),A.castShadow=!0,A.shadow.mapSize.width=1024,A.shadow.mapSize.height=1024,e.add(A);const M=new g(a,r),T=new Q({color:8947848}),O=new x(M,T);O.rotation.x=-Math.PI/2,O.receiveShadow=!0,e.add(O);const E=new He(a,a);E.position.y=.01,E.material.color.setHex(6710886),e.add(E);const _=new w(2,2,2),C=new Q({color:16711680}),R=new x(_,C);R.position.set(0,1,0),R.castShadow=!0,R.userData.name="Test Cube",R.userData.id="test_cube",e.add(R);const P=new Pe(.5,.5,3),N=new Q({color:9127187}),I=new x(P,N);I.position.set(5,1.5,0),I.castShadow=!0,I.userData.name="Tree Trunk",I.userData.id="tree_trunk",e.add(I);const L=new v(2),k=new Q({color:2263842}),D=new x(L,k);D.position.set(5,4,0),D.castShadow=!0,D.userData.name="Tree Leaves",D.userData.id="tree_leaves",e.add(D),o.current.set("test_cube",R),o.current.set("tree_trunk",I),o.current.set("tree_leaves",D),y.addSelectableObject(R),y.addSelectableObject(I),y.addSelectableObject(D);const H=()=>{requestAnimationFrame(H),R.rotation.y+=.005,n.current&&n.current.updateSelectedOutlines(),b.clear();const t=n.current?n.current.camera:l;b.render(e,t)};H();const F=()=>{n.current?n.current.onWindowResize():(l.aspect=window.innerWidth/window.innerHeight,l.updateProjectionMatrix(),b.setSize(window.innerWidth,window.innerHeight))};return window.addEventListener("resize",F),()=>{window.removeEventListener("resize",F),n.current&&n.current.dispose(),s.current&&b.domElement&&s.current.removeChild(b.domElement),b.dispose()}},[a,r,j]),e.useEffect(()=>{if(!i.current||!n.current)return;const e=i.current,t=new nt;l.forEach(s=>{if(!o.current.has(s.id))if("glb"===s.type&&s.file)t.load(s.file,t=>{const i=t.scene,a=(new Te).setFromObject(i),r=a.getSize(new L),l=a.getCenter(new L),c=Math.max(r.x,r.y,r.z);let h=1;c>10?h=5/c:c<.1&&(h=1/c),i.position.sub(l),i.position.set(s.position.x,s.position.y,s.position.z),i.rotation.set(s.rotation.x,s.rotation.y,s.rotation.z),i.scale.set(s.scale.x*h,s.scale.y*h,s.scale.z*h),i.name=s.name,i.userData={id:s.id,type:s.type},i.visible=!1!==s.visible,i.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),e.add(i),n.current.addSelectableObject(i),o.current.set(s.id,i),S(s.id)},e=>{},e=>{});else if("cube"===s.type){const t=new w(s.size.x,s.size.y,s.size.z),i=new b({color:s.material.color}),a=new x(t,i);a.position.set(s.position.x,s.position.y,s.position.z),a.rotation.set(s.rotation.x,s.rotation.y,s.rotation.z),a.name=s.name,a.userData={id:s.id,type:s.type},a.castShadow=!0,a.receiveShadow=!0,e.add(a),n.current.addSelectableObject(a),o.current.set(s.id,a)}});const s=new Set(l.map(e=>e.id));for(const[i,a]of o.current)s.has(i)||(e.remove(a),n.current.removeSelectableObject(a),o.current.delete(i))},[l,S]),e.useEffect(()=>{i.current&&(l.forEach(e=>{const t=o.current.get(e.id);t&&(t.visible=!1!==e.visible)}),y.forEach(e=>{const t=o.current.get(e.id);t&&(t.visible=!1!==e.visible)}))},[l,y]),Ye.jsx("div",{ref:s,style:{width:"100%",height:"100vh",position:"relative"}})}function Fs({floorWidth:e,floorDepth:t,onFloorSizeChange:s}){return Ye.jsxs("div",{className:"panel-section floor-size-section",children:[Ye.jsx("h3",{children:"바닥 크기"}),Ye.jsxs("div",{className:"floor-size-inputs",children:[Ye.jsxs("div",{className:"input-group",children:[Ye.jsx("label",{children:"폭"}),Ye.jsx("input",{type:"number",min:"1",max:"200",value:e,onChange:e=>{const n=Math.max(1,Math.min(200,Number(e.target.value)||1));s(n,t)},className:"size-input"}),Ye.jsx("span",{className:"unit",children:"m"})]}),Ye.jsxs("div",{className:"input-group",children:[Ye.jsx("label",{children:"깊이"}),Ye.jsx("input",{type:"number",min:"1",max:"200",value:t,onChange:t=>{const n=Math.max(1,Math.min(200,Number(t.target.value)||1));s(e,n)},className:"size-input"}),Ye.jsx("span",{className:"unit",children:"m"})]})]})]})}const zs=e.memo(function({objects:t,walls:s,selectedObject:n,onObjectVisibilityToggle:i,onObjectSelect:o,onObjectRemove:a,onObjectFocus:r,onObjectRename:l,editorControls:c}){const[h,d]=e.useState(null),[u,m]=e.useState(""),p=e.useRef(null),f=e=>{if(c){const t=c.findObjectById(e.id);t&&c.selectObject(t)}else o(e)},g=e=>{if(c){const t=c.findObjectById(e.id);t&&(c.selectObject(t),c.focusOnObject&&c.focusOnObject(t))}else r(e)},b=e=>{u.trim()&&u!==e.name&&l(e,u.trim()),d(null),m("")},x=(e,t)=>{"Enter"===e.key?b(t):"Escape"===e.key?(d(null),m("")):"F2"!==e.key||h||(e.preventDefault(),(e=>{d(e.id),m(e.name),setTimeout(()=>{p.current&&(p.current.focus(),p.current.select())},0)})(t))},w=e=>{a(e)};return Ye.jsxs("div",{className:"panel-section hierarchy-section expanded-section",children:[Ye.jsxs("h3",{children:["씬 오브젝트 (",t.length+s.length,")"]}),Ye.jsxs("div",{className:"hierarchy-list",children:[t.length>0&&Ye.jsxs("div",{className:"hierarchy-category",children:[Ye.jsxs("div",{className:"category-header",children:[Ye.jsx("span",{className:"category-icon",children:"📦"}),Ye.jsxs("span",{children:["모델 (",t.length,")"]})]}),t.map((e,t)=>Ye.jsxs("div",{className:"hierarchy-item",onKeyDown:t=>x(t,e),tabIndex:0,children:[Ye.jsx("button",{className:"visibility-btn",onClick:()=>i(e),title:!1!==e.visible?"숨기기":"보이기",children:!1!==e.visible?"👁️":"🙈"}),h===e.id?Ye.jsx("input",{ref:p,type:"text",value:u,onChange:e=>m(e.target.value),onBlur:()=>b(e),onKeyDown:t=>x(t,e),className:"object-name-input"}):Ye.jsx("span",{className:"object-name "+((null==n?void 0:n.id)===e.id?"selected":""),onClick:()=>f(e),onDoubleClick:()=>g(e),title:`모델: ${e.name} (더블클릭: 포커스, F2: 이름변경)`,children:e.name}),Ye.jsx("button",{className:"delete-btn",onClick:()=>w(e),title:"삭제",children:"🗑️"})]},e.id||t))]}),s.length>0&&Ye.jsxs("div",{className:"hierarchy-category",children:[Ye.jsxs("div",{className:"category-header",children:[Ye.jsx("span",{className:"category-icon",children:"🧱"}),Ye.jsxs("span",{children:["벽 (",s.length,")"]})]}),s.map((e,t)=>Ye.jsxs("div",{className:"hierarchy-item",onKeyDown:t=>x(t,e),tabIndex:0,children:[Ye.jsx("button",{className:"visibility-btn",onClick:()=>i(e),title:!1!==e.visible?"숨기기":"보이기",children:!1!==e.visible?"👁️":"🙈"}),h===e.id?Ye.jsx("input",{ref:p,type:"text",value:u,onChange:e=>m(e.target.value),onBlur:()=>b(e),onKeyDown:t=>x(t,e),className:"object-name-input"}):Ye.jsx("span",{className:"object-name "+((null==n?void 0:n.id)===e.id?"selected":""),onClick:()=>f(e),onDoubleClick:()=>g(e),title:`벽: ${e.name} (더블클릭: 포커스, F2: 이름변경)`,children:e.name}),Ye.jsx("button",{className:"delete-btn",onClick:()=>w(e),title:"삭제",children:"🗑️"})]},e.id||t))]}),0===t.length&&0===s.length&&Ye.jsxs("div",{className:"empty-hierarchy",children:[Ye.jsx("p",{children:"씬에 오브젝트가 없습니다"}),Ye.jsx("small",{children:"메뉴에서 오브젝트를 추가하세요"})]})]})]})}),Bs=e.memo(function({selectedObject:t}){var s,n;const[i,o]=e.useState({diffuse:null,normal:null,roughness:null}),[a,r]=e.useState(0),[l,c]=e.useState([]);e.useEffect(()=>{if(t&&"function"==typeof t.traverse){const e=[];t.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach((s,n)=>{e.push({material:s,name:s.name||`Material ${e.length}`,meshName:t.name||"Unnamed Mesh",materialIndex:n})}):e.push({material:t.material,name:t.material.name||`Material ${e.length}`,meshName:t.name||"Unnamed Mesh",materialIndex:0}))}),c(e),r(0)}else c([]),r(0)},[t]);const h=(e,s,n)=>{if(!t||"function"!=typeof t.traverse)return;const i=parseFloat(n);isNaN(i)||(t[e]||(t[e]={x:0,y:0,z:0}),"position"===e?t.position[s]=i:"rotation"===e?t.rotation[s]=i*Math.PI/180:"scale"===e&&(t.scale[s]=i))},d=(e,s)=>t&&"function"==typeof t.traverse&&t[e]?void 0===t[e][s]?0:"rotation"===e?(180*t[e][s]/Math.PI).toFixed(1):t[e][s].toFixed(2):0,u=(e,s)=>{if(!s||!t||"function"!=typeof t.traverse||0===l.length)return;const n=URL.createObjectURL(s),i=l[a];if(!i)return;(new F).load(n,t=>{t.wrapS=K,t.wrapT=K,t.flipY=!1;const s=i.material;switch(s.isMeshStandardMaterial,e){case"diffuse":s.map=t;break;case"normal":s.normalMap=t;break;case"roughness":s.roughnessMap=t}s.needsUpdate=!0,o(t=>({...t,[e]:n}))})},m=(e,s)=>{if(!t||"function"!=typeof t.traverse||0===l.length)return;const n=l[a];if(!n)return;const i=n.material;switch(i.isMeshStandardMaterial,e){case"metalness":void 0!==i.metalness&&(i.metalness=parseFloat(s));break;case"roughness":void 0!==i.roughness&&(i.roughness=parseFloat(s));break;case"color":i.color&&i.color.setHex(s.replace("#","0x"))}i.needsUpdate=!0},p=e=>{if(!t||"function"!=typeof t.traverse||0===l.length)return"color"===e?"#ffffff":0;const s=l[a];if(!s)return"color"===e?"#ffffff":0;const n=s.material;switch(e){case"metalness":return n.metalness||0;case"roughness":return n.roughness||.8;case"color":return n.color?"#"+n.color.getHexString():"#ffffff";default:return 0}};return t?Ye.jsxs("div",{className:"panel-section properties-section",children:[Ye.jsx("h3",{children:"속성"}),Ye.jsxs("div",{className:"properties-container",children:[Ye.jsxs("div",{className:"property-group",children:[Ye.jsx("h4",{children:"위치 (Position)"}),Ye.jsxs("div",{className:"vector-inputs",children:[Ye.jsxs("label",{children:["X:",Ye.jsx("input",{type:"number",step:"0.1",value:d("position","x"),onChange:e=>h("position","x",e.target.value),className:"vector-input"})]}),Ye.jsxs("label",{children:["Y:",Ye.jsx("input",{type:"number",step:"0.1",value:d("position","y"),onChange:e=>h("position","y",e.target.value),className:"vector-input"})]}),Ye.jsxs("label",{children:["Z:",Ye.jsx("input",{type:"number",step:"0.1",value:d("position","z"),onChange:e=>h("position","z",e.target.value),className:"vector-input"})]})]})]}),Ye.jsxs("div",{className:"property-group",children:[Ye.jsx("h4",{children:"회전 (Rotation)"}),Ye.jsxs("div",{className:"vector-inputs",children:[Ye.jsxs("label",{children:["X:",Ye.jsx("input",{type:"number",step:"1",value:d("rotation","x"),onChange:e=>h("rotation","x",e.target.value),className:"vector-input"}),"°"]}),Ye.jsxs("label",{children:["Y:",Ye.jsx("input",{type:"number",step:"1",value:d("rotation","y"),onChange:e=>h("rotation","y",e.target.value),className:"vector-input"}),"°"]}),Ye.jsxs("label",{children:["Z:",Ye.jsx("input",{type:"number",step:"1",value:d("rotation","z"),onChange:e=>h("rotation","z",e.target.value),className:"vector-input"}),"°"]})]})]}),Ye.jsxs("div",{className:"property-group",children:[Ye.jsx("h4",{children:"크기 (Scale)"}),Ye.jsxs("div",{className:"vector-inputs",children:[Ye.jsxs("label",{children:["X:",Ye.jsx("input",{type:"number",step:"0.1",min:"0.1",value:d("scale","x"),onChange:e=>h("scale","x",e.target.value),className:"vector-input"})]}),Ye.jsxs("label",{children:["Y:",Ye.jsx("input",{type:"number",step:"0.1",min:"0.1",value:d("scale","y"),onChange:e=>h("scale","y",e.target.value),className:"vector-input"})]}),Ye.jsxs("label",{children:["Z:",Ye.jsx("input",{type:"number",step:"0.1",min:"0.1",value:d("scale","z"),onChange:e=>h("scale","z",e.target.value),className:"vector-input"})]})]})]}),Ye.jsxs("div",{className:"property-group material-group",children:[Ye.jsx("h4",{children:"메터리얼 (Material)"}),l.length>1&&Ye.jsxs("div",{className:"material-selector",children:[Ye.jsxs("label",{className:"material-select-label",children:["메터리얼 선택:",Ye.jsx("select",{value:a,onChange:e=>r(Number(e.target.value)),className:"material-select",children:l.map((e,t)=>Ye.jsxs("option",{value:t,children:[e.name," (",e.meshName,")"]},t))})]}),Ye.jsxs("div",{className:"material-info",children:["현재: ",null==(s=l[a])?void 0:s.name,(null==(n=l[a])?void 0:n.material.isMeshStandardMaterial)?" (PBR)":" (Basic)"]})]}),0===l.length&&Ye.jsx("div",{className:"no-material",children:"메터리얼이 없습니다"}),l.length>0&&Ye.jsxs("div",{className:"material-properties",children:[Ye.jsxs("label",{className:"material-property",children:["색상:",Ye.jsx("input",{type:"color",value:p("color"),onChange:e=>m("color",e.target.value),className:"color-input"})]}),Ye.jsxs("label",{className:"material-property",children:["메탈릭: ",p("metalness"),Ye.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:p("metalness"),onChange:e=>m("metalness",e.target.value),className:"material-slider"})]}),Ye.jsxs("label",{className:"material-property",children:["러프니스: ",p("roughness"),Ye.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:p("roughness"),onChange:e=>m("roughness",e.target.value),className:"material-slider"})]})]}),l.length>0&&Ye.jsxs("div",{className:"texture-uploads",children:[Ye.jsxs("div",{className:"texture-upload-group",children:[Ye.jsxs("label",{className:"texture-label",children:["디퓨즈 텍스처:",Ye.jsx("input",{type:"file",accept:"image/*",onChange:e=>u("diffuse",e.target.files[0]),className:"texture-input"})]}),i.diffuse&&Ye.jsx("div",{className:"texture-preview",children:Ye.jsx("img",{src:i.diffuse,alt:"Diffuse"})})]}),Ye.jsxs("div",{className:"texture-upload-group",children:[Ye.jsxs("label",{className:"texture-label",children:["노멀 맵:",Ye.jsx("input",{type:"file",accept:"image/*",onChange:e=>u("normal",e.target.files[0]),className:"texture-input"})]}),i.normal&&Ye.jsx("div",{className:"texture-preview",children:Ye.jsx("img",{src:i.normal,alt:"Normal"})})]}),Ye.jsxs("div",{className:"texture-upload-group",children:[Ye.jsxs("label",{className:"texture-label",children:["러프니스 맵:",Ye.jsx("input",{type:"file",accept:"image/*",onChange:e=>u("roughness",e.target.files[0]),className:"texture-input"})]}),i.roughness&&Ye.jsx("div",{className:"texture-preview",children:Ye.jsx("img",{src:i.roughness,alt:"Roughness"})})]})]})]})]})]}):null});function Xs({editorControls:t}){const{selectedObject:s,transformMode:n,floorWidth:i,floorDepth:o,objects:a,walls:r,savedObjects:l,setTransformMode:c,setFloorSize:h,addWall:d,addObject:u,removeObject:m,addAsset:p,saveMap:f,loadMap:g,clearMap:b,toggleObjectVisibility:x,renameObject:w,setSelectedObject:v}=ts();e.useState(""),e.useState(""),e.useEffect(()=>{const e=e=>{"f"!==e.key&&"F"!==e.key||(e.preventDefault(),(null==s?void 0:s.id)&&j(s))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[s]);const y=e=>{if(!e)return t&&t.deselectAllObjects(),void v(null);if(t){const s=t.findObjectById(e.id);s&&t.selectObject(s)}v(e)},j=e=>{if(y(e),t){const s=t.findObjectById(e.id);s&&t.focusOnObject(s)}};return Ye.jsxs("div",{className:"editor-ui",children:[Ye.jsx("div",{className:"tool-panel",children:Ye.jsxs("div",{className:"tool-section",children:[Ye.jsx("button",{className:"tool-btn "+("translate"===n?"active":""),onClick:()=>c("translate"),title:"?�택/?�동 (W)",children:Ye.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:Ye.jsx("path",{d:"M13,20H11V8L5.5,13.5L4.08,12.08L12,4.16L19.92,12.08L18.5,13.5L13,8V20Z"})})}),Ye.jsx("button",{className:"tool-btn "+("rotate"===n?"active":""),onClick:()=>c("rotate"),title:"?�전 (E)",children:Ye.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:Ye.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M18,11H13L14.5,9.5C13.58,8.58 12.34,8 11,8C8.79,8 7,9.79 7,12C7,14.21 8.79,16 11,16C12.48,16 13.77,15.19 14.38,14H16.5C15.83,16.33 13.61,18 11,18C7.69,18 5,15.31 5,12C5,8.69 7.69,6 11,6C12.8,6 14.4,6.86 15.5,8.17L17,6.5V11H18Z"})})}),Ye.jsx("button",{className:"tool-btn "+("scale"===n?"active":""),onClick:()=>c("scale"),title:"?�기 (R)",children:Ye.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:Ye.jsx("path",{d:"M21,16H19V14.5H17.5V19H22V17.5H21V16M14.5,19H16V17.5H14.5V16H13V22H14.5V19M16,5H14.5V2H13V7H16V5M21,8V5H22V2H17.5V3.5H19V5H17.5V8H21M9,11H15V9H9V11M11,15H13V13H11V15M9,7H15V5H9V7Z"})})}),Ye.jsx("div",{className:"tool-divider"}),Ye.jsx("button",{className:"tool-btn",onClick:()=>c("select"),title:"?�택 ?�구",children:Ye.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:Ye.jsx("path",{d:"M13.64,21.97C13.14,22.21 12.54,22 12.31,21.5L10.13,16.76L7.62,18.78C7.45,18.92 7.24,19 7,19A1,1 0 0,1 6,18V3A1,1 0 0,1 7,2C7.24,2 7.47,2.09 7.64,2.23L7.65,2.22L19.14,11.86C19.57,12.22 19.62,12.85 19.27,13.27C19.12,13.45 18.91,13.57 18.7,13.61L15.54,14.23L17.74,18.96C18,19.46 17.76,20.05 17.26,20.28L13.64,21.97Z"})})})]})}),Ye.jsxs("div",{className:"right-panel",children:[Ye.jsx(Fs,{floorWidth:i,floorDepth:o,onFloorSizeChange:(e,t)=>{h(e,t)}}),Ye.jsx(zs,{objects:a,walls:r,selectedObject:s,onObjectVisibilityToggle:e=>{x(e)},onObjectSelect:y,onObjectRemove:e=>{if(t&&t.objectSelector){if(t.objectSelector.transformControls)try{t.objectSelector.transformControls.detach()}catch(n){}try{const s=t.findObjectById(e.id);s&&t.objectSelector.removeSelectionOutline(s)}catch(n){}}if(s&&s.id===e.id){if(t)try{t.deselectAllObjects()}catch(n){}v(null)}setTimeout(()=>{try{m(e)}catch(n){}},50)},onObjectFocus:j,onObjectRename:(e,t)=>{if(w(e.id,t),(null==s?void 0:s.id)===e.id){const e={...s,name:t};v(e)}},editorControls:t}),Ye.jsx(Bs,{selectedObject:s})]})]})}const Us=({onMenuAction:t})=>{const[n,i]=e.useState(null),o=e=>{e.target.closest(".menu-bar")||i(null)};return s.useEffect(()=>(document.addEventListener("click",o),()=>{document.removeEventListener("click",o)}),[]),Ye.jsx("div",{className:"menu-bar",children:Ye.jsx("div",{className:"menu-items",children:[{title:"파일",items:[{label:"새 맵",action:"new-map",shortcut:"Ctrl+N"},{label:"불러오기",action:"load-map",shortcut:"Ctrl+O"},{label:"저장하기",action:"save-map",shortcut:"Ctrl+S"},{type:"separator"},{label:"임포트",action:"import"},{label:"익스포트",action:"export"},{type:"separator"},{label:"나가기",action:"exit",shortcut:"Alt+F4"}]},{title:"에디터",items:[{label:"실행 취소",action:"undo",shortcut:"Ctrl+Z"},{label:"다시 실행",action:"redo",shortcut:"Ctrl+Y"},{type:"separator"},{label:"복사",action:"copy",shortcut:"Ctrl+C"},{label:"붙여넣기",action:"paste",shortcut:"Ctrl+V"},{label:"삭제",action:"delete",shortcut:"Delete"},{type:"separator"},{label:"전체 선택",action:"select-all",shortcut:"Ctrl+A"},{label:"선택 해제",action:"deselect-all",shortcut:"Ctrl+D"}]},{title:"윈도우",items:[{label:"뷰포트 리셋",action:"reset-viewport"},{label:"카메라 리셋",action:"reset-camera"},{type:"separator"},{label:"그리드 토글",action:"toggle-grid"},{label:"통계 표시",action:"toggle-stats"},{type:"separator"},{label:"전체화면",action:"fullscreen",shortcut:"F11"}]},{title:"정보",items:[{label:"단축키",action:"show-shortcuts"},{label:"도움말",action:"show-help",shortcut:"F1"},{type:"separator"},{label:"프로그램 정보",action:"about"}]}].map((e,s)=>Ye.jsxs("div",{className:"menu-item "+(n===s?"active":""),onClick:()=>{var e;i(n===(e=s)?null:e)},children:[Ye.jsx("span",{className:"menu-title",children:e.title}),n===s&&Ye.jsx("div",{className:"dropdown-menu",children:e.items.map((e,s)=>"separator"===e.type?Ye.jsx("div",{className:"menu-separator"},s):Ye.jsxs("div",{className:"dropdown-item",onClick:s=>{var n;s.stopPropagation(),n=e.action,i(null),t&&t(n)},children:[Ye.jsx("span",{className:"item-label",children:e.label}),e.shortcut&&Ye.jsx("span",{className:"item-shortcut",children:e.shortcut})]},s))})]},s))})})},Vs="새 맵을 만들면 현재 작업이 사라집니다. 계속하시겠습니까?",Ks="익스포트 기능은 준비 중입니다.",Gs="에디터를 종료하시겠습니까?",Ws="실행 취소 기능은 준비 중입니다.",Ys="다시 실행 기능은 준비 중입니다.",Zs="복사 기능은 준비 중입니다.",Qs="붙여넣기 기능은 준비 중입니다.",qs="삭제 기능은 준비 중입니다.",$s="전체 선택 기능은 준비 중입니다.",Js="선택 해제 기능은 준비 중입니다.",en="뷰포트 리셋 기능은 준비 중입니다.",tn="카메라 리셋: 키패드 0번을 누르세요.",sn="그리드 토글 기능은 준비 중입니다.",nn="통계 표시 기능은 준비 중입니다.",on="단축키 정보:\nW/E/R: 기즈모 모드\nF: 오브젝트 포커스\nESC: 선택 해제\n키패드 0: 카메라 리셋\n키패드 5: 카메라 모드 토글\n키패드 1/3/7/9: 뷰 변경",an="도움말:\n• 좌클릭: 오브젝트 선택\n• Shift+좌클릭: 다중 선택\n• 중간클릭: 팬 이동\n• Alt+중간클릭: 카메라 회전\n• 마우스 휠: 줌",rn="ThirdPersonTreeJS Editor\nVersion 1.0.0\n3D 에디터 프로그램";function ln(){const t=n(),{clearMap:s,saveMap:i,loadMap:o,addObject:a,setSelectedObject:r}=ts(),[l,c]=e.useState(null),[h,d]=e.useState(""),u=e.useRef(null),m=()=>{if("save"===l&&h.trim())i(h.trim()),alert(`맵이 "${h.trim()}"으로 저장되었습니다.`);else if("load"===l&&h.trim()){o(h.trim())?alert(`맵 "${h.trim()}"을 불러왔습니다.`):alert(`맵 "${h.trim()}"을 찾을 수 없습니다.`)}c(null),d("")},p=()=>{c(null),d("")};return Ye.jsxs("div",{className:"editor-page",children:[Ye.jsx(Us,{onMenuAction:e=>{switch(e){case"new-map":confirm(Vs)&&s();break;case"load-map":c("load");break;case"save-map":c("save");break;case"import":(()=>{const e=document.createElement("input");e.type="file",e.accept=".glb,.gltf",e.multiple=!1,e.onchange=e=>{const t=e.target.files[0];if(!t)return;const s=URL.createObjectURL(t),n=t.name.replace(/\.[^/.]+$/,""),i={id:Date.now(),type:"glb",file:s,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:n};a(i),setTimeout(()=>{r(i.id)},100)},e.click()})();break;case"export":alert(Ks);break;case"exit":confirm(Gs)&&t("/");break;case"undo":alert(Ws);break;case"redo":alert(Ys);break;case"copy":alert(Zs);break;case"paste":alert(Qs);break;case"delete":alert(qs);break;case"select-all":alert($s);break;case"deselect-all":alert(Js);break;case"reset-viewport":alert(en);break;case"reset-camera":alert(tn);break;case"toggle-grid":alert(sn);break;case"toggle-stats":alert(nn);break;case"fullscreen":document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();break;case"show-shortcuts":alert(on);break;case"show-help":alert(an);break;case"about":alert(rn)}}}),Ye.jsxs("div",{className:"editor-container",children:[Ye.jsx(Hs,{onEditorControlsReady:e=>{u.current=e}}),Ye.jsx(Xs,{editorControls:u.current})]}),l&&Ye.jsx("div",{className:"dialog-overlay",children:Ye.jsxs("div",{className:"dialog",children:[Ye.jsx("h3",{children:"save"===l?"맵 저장":"맵 불러오기"}),Ye.jsx("input",{type:"text",value:h,onChange:e=>d(e.target.value),placeholder:"맵 이름을 입력하세요",autoFocus:!0,onKeyDown:e=>{"Enter"===e.key&&m(),"Escape"===e.key&&p()}}),Ye.jsxs("div",{className:"dialog-buttons",children:[Ye.jsx("button",{onClick:m,children:"확인"}),Ye.jsx("button",{onClick:p,children:"취소"})]})]})})]})}function cn(){return Ye.jsx(i,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:Ye.jsx("div",{className:"App",children:Ye.jsxs(o,{children:[Ye.jsx(a,{path:"/",element:Ye.jsx(qe,{})}),Ye.jsx(a,{path:"/game",element:Ye.jsx(tt,{})}),Ye.jsx(a,{path:"/editor",element:Ye.jsx(ln,{})})]})})})}Ze.createRoot(document.getElementById("root")).render(Ye.jsx(s.StrictMode,{children:Ye.jsx(cn,{})}));
