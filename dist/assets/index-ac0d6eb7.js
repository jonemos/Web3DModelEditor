import{r as e,b as t,a as s}from"./react-vendor-340b36b2.js";import{u as n,B as i,R as r,a}from"./router-276f05ba.js";import{c as o}from"./state-b6f0ffd6.js";import{C as l,S as c,a as h,P as d,W as u,b as p,A as m,D as g,c as f,M as v,d as x,B as b,e as y,T as w,f as S,g as j,L as M,h as T,F as C,i as A,j as E,k as O,l as R,m as D,n as _,V as N,o as P,p as k,I as L,q as I,O as z,r as F,s as B,t as U,u as H,v as G,w as V,R as K,N as X,x as Q,y as Z,z as W,E as Y,G as q,H as $,J,K as ee,Q as te,U as se,X as ne,Y as ie,Z as re,_ as ae,$ as oe,a0 as le,a1 as ce,a2 as he,a3 as de,a4 as ue,a5 as pe,a6 as me,a7 as ge,a8 as fe,a9 as ve,aa as xe,ab as be,ac as ye,ad as we,ae as Se,af as je,ag as Me,ah as Te,ai as Ce,aj as Ae,ak as Ee,al as Oe,am as Re,an as De,ao as _e,ap as Ne,aq as Pe,ar as ke,as as Le,at as Ie,au as ze,av as Fe,aw as Be,ax as Ue,ay as He,az as Ge,aA as Ve,aB as Ke,aC as Xe,aD as Qe,aE as Ze,aF as We,aG as Ye,aH as qe,aI as $e,aJ as Je,aK as et,aL as tt,aM as st,aN as nt,aO as it,aP as rt,aQ as at,aR as ot,aS as lt,aT as ct,aU as ht,aV as dt,aW as ut,aX as pt,aY as mt,aZ as gt,a_ as ft,a$ as vt,b0 as xt,b1 as bt,b2 as yt,b3 as wt,b4 as St,b5 as jt,b6 as Mt,b7 as Tt,b8 as Ct}from"./three-2c995608.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var At={exports:{}},Et={},Ot=e,Rt=Symbol.for("react.element"),Dt=Symbol.for("react.fragment"),_t=Object.prototype.hasOwnProperty,Nt=Ot.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Pt={key:!0,ref:!0,__self:!0,__source:!0};function kt(e,t,s){var n,i={},r=null,a=null;for(n in void 0!==s&&(r=""+s),void 0!==t.key&&(r=""+t.key),void 0!==t.ref&&(a=t.ref),t)_t.call(t,n)&&!Pt.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:Rt,type:e,key:r,ref:a,props:i,_owner:Nt.current}}Et.Fragment=Dt,Et.jsx=kt,Et.jsxs=kt,At.exports=Et;var Lt=At.exports,It={},zt=t;It.createRoot=zt.createRoot,It.hydrateRoot=zt.hydrateRoot;function Ft(){const t=n(),[s,i]=e.useState(null),[r,a]=e.useState(!1);e.useEffect(()=>{const e=e=>{e.preventDefault(),i(e),a(!0)};return window.addEventListener("beforeinstallprompt",e),()=>{window.removeEventListener("beforeinstallprompt",e)}},[]);return Lt.jsxs("div",{className:"home-page",children:[Lt.jsxs("div",{className:"start-menu fade-in",children:[Lt.jsxs("h1",{children:["🎮",Lt.jsx("br",{}),"ThirdPerson TreeJS Game"]}),Lt.jsxs("div",{className:"menu-buttons",children:[Lt.jsx("button",{className:"menu-btn start-game-btn",onClick:()=>t("/game"),children:"게임 시작"}),Lt.jsx("button",{className:"menu-btn editor-btn",onClick:()=>t("/editor"),children:"에디터"})]})]}),r&&Lt.jsxs("div",{className:"install-prompt",children:[Lt.jsx("p",{children:"이 게임을 홈 화면에 추가하시겠습니까?"}),Lt.jsx("button",{onClick:async()=>{if(s){s.prompt();(await s.userChoice).outcome,i(null)}a(!1)},className:"install-btn",children:"설치"}),Lt.jsx("button",{onClick:()=>{a(!1)},className:"dismiss-btn",children:"나중에"})]})]})}const Bt=o((e,t)=>({isPlaying:!0,isPaused:!1,isLoading:!0,scene:null,camera:null,renderer:null,player:null,mixer:null,clock:new l,playerPosition:{x:0,y:1,z:0},playerRotation:0,cameraState:{distance:10,height:5,followMode:!0,rotationSpeed:.002,zoomSpeed:1,minDistance:3,maxDistance:50,phi:Math.PI/4,theta:0},keys:{},mouseState:{isMouseDown:!1,prevMousePos:{x:0,y:0},sensitivity:.002},trees:[],items:[],walls:[],setLoading:t=>e({isLoading:t}),setScene:(t,s,n)=>e({scene:t,camera:s,renderer:n}),setPlayer:t=>e({player:t}),updatePlayerPosition:t=>e({playerPosition:t}),updatePlayerRotation:t=>e({playerRotation:t}),setKey:(t,s)=>e(e=>({keys:{...e.keys,[t]:s}})),pause:()=>e({isPaused:!0}),resume:()=>e({isPaused:!1}),restart:()=>e({isPlaying:!0,isPaused:!1,playerPosition:{x:0,y:1,z:0},playerRotation:0}),toggleCameraFollowMode:()=>e(e=>({cameraState:{...e.cameraState,followMode:!e.cameraState.followMode}})),updateCameraDistance:t=>e(e=>({cameraState:{...e.cameraState,distance:Math.max(e.cameraState.minDistance,Math.min(e.cameraState.maxDistance,t))}})),updateCameraAngles:(t,s)=>e(e=>({cameraState:{...e.cameraState,phi:Math.max(.1,Math.min(Math.PI-.1,t)),theta:s}})),setMouseDown:(t,s)=>e(e=>({mouseState:{...e.mouseState,isMouseDown:t,prevMousePos:s||e.mouseState.prevMousePos}})),addItem:t=>e(e=>({items:[...e.items,t]})),removeItem:t=>e(e=>({items:e.items.filter(e=>e.id!==t)})),setTrees:t=>e({trees:t}),addWall:t=>e(e=>({walls:[...e.walls,t]})),clearWalls:()=>e({walls:[]}),setMixer:t=>e({mixer:t})}));function Ut(){const t=e.useRef(null);return e.useEffect(()=>{if(!t.current)return;const e=new c;e.background=new h(8900331);const s=new d(75,window.innerWidth/window.innerHeight,.1,1e3);s.position.set(0,5,10),s.lookAt(0,0,0);const n=new u({antialias:!0});n.setSize(window.innerWidth,window.innerHeight),n.shadowMap.enabled=!0,n.shadowMap.type=p,t.current.appendChild(n.domElement);const i=new m(4210752,.6);e.add(i);const r=new g(16777215,.8);r.position.set(10,10,5),r.castShadow=!0,e.add(r);const a=new f(20,20),o=new v({color:65280}),l=new x(a,o);l.rotation.x=-Math.PI/2,l.receiveShadow=!0,e.add(l);const w=new b(2,2,2),S=new v({color:16711680}),j=new x(w,S);j.position.set(0,1,0),j.castShadow=!0,e.add(j);const M=new y(1,32,32),T=new v({color:255}),C=new x(M,T);C.position.set(3,1,0),C.castShadow=!0,e.add(C);const A=()=>{requestAnimationFrame(A),j.rotation.x+=.01,j.rotation.y+=.01,C.rotation.y+=.02,n.render(e,s)};A();const E=()=>{s.aspect=window.innerWidth/window.innerHeight,s.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight)};return window.addEventListener("resize",E),()=>{window.removeEventListener("resize",E),t.current&&n.domElement&&t.current.removeChild(n.domElement),n.dispose()}},[]),Lt.jsx("div",{ref:t,style:{width:"100vw",height:"100vh",position:"absolute",top:0,left:0,zIndex:1}})}function Ht(){const{isPaused:t,pause:s,resume:n,restart:i,toggleCameraFollowMode:r,cameraState:a,playerPosition:o}=Bt(),[l,c]=e.useState(!1),[h,d]=e.useState(10);return Lt.jsxs(Lt.Fragment,{children:[Lt.jsx("div",{className:"crosshair"}),Lt.jsx("div",{className:"game-message"}),t&&Lt.jsxs("div",{className:"pause-overlay",children:[Lt.jsx("h2",{children:"게임 일시정지"}),Lt.jsx("button",{onClick:n,className:"resume-btn",children:"계속하기"}),Lt.jsx("button",{onClick:i,className:"restart-btn",children:"재시작"})]}),Lt.jsxs("div",{className:"controls-info",children:[Lt.jsx("div",{children:"WASD: 이동"}),Lt.jsx("div",{children:"마우스: 카메라 회전"}),Lt.jsx("div",{children:"스크롤: 줌"}),Lt.jsx("div",{children:"ESC: 일시정지"}),Lt.jsxs("div",{children:["위치: (",Math.round(o.x),", ",Math.round(o.z),")"]})]}),Lt.jsx("button",{className:"sidebar-toggle-btn",onClick:()=>c(!l),children:"⚙️"}),Lt.jsxs("div",{className:"sidebar "+(l?"open":""),children:[Lt.jsxs("div",{className:"sidebar-header",children:[Lt.jsx("h3",{children:"게임 설정"}),Lt.jsx("button",{className:"close-btn",onClick:()=>c(!1),children:"✕"})]}),Lt.jsxs("div",{className:"sidebar-content",children:[Lt.jsxs("div",{className:"section",children:[Lt.jsx("h4",{children:"플레이어 모델"}),Lt.jsx("input",{type:"file",accept:".glb,.gltf",onChange:e=>{e.target.files[0]},style:{display:"none"},id:"model-file-input"}),Lt.jsx("button",{className:"upload-btn",onClick:()=>document.getElementById("model-file-input").click(),children:"모델 업로드"}),Lt.jsx("button",{className:"reset-btn",onClick:()=>{window.confirm("캐릭터를 기본 모델로 되돌리시겠습니까?")},children:"기본 모델로 리셋"}),Lt.jsx("div",{className:"model-info",children:"기본 모델 사용 중"})]}),Lt.jsxs("div",{className:"section",children:[Lt.jsxs("h4",{children:["나무 개수: ",h]}),Lt.jsx("input",{type:"range",min:"0",max:"20",value:h,onChange:e=>{const t=parseInt(e.target.value,10);d(t)},className:"slider"})]}),Lt.jsxs("div",{className:"section",children:[Lt.jsx("h4",{children:"카메라"}),Lt.jsx("button",{className:"camera-btn "+(a.followMode?"active":""),onClick:r,children:a.followMode?"따라가기 모드":"고정 모드"})]}),Lt.jsxs("div",{className:"section",children:[Lt.jsx("h4",{children:"맵 선택"}),Lt.jsx("select",{className:"map-select",children:Lt.jsx("option",{value:"default",children:"기본 맵"})}),Lt.jsx("button",{className:"apply-map-btn",children:"맵 적용"})]})]})]})]})}function Gt(){const t=n(),{isLoading:s,setLoading:i,pause:r,restart:a,setKey:o}=Bt(),[l,c]=e.useState("게임 로딩 중...");return e.useEffect(()=>{(async()=>{try{c("게임 엔진 초기화 중..."),await new Promise(e=>setTimeout(e,1e3)),c("게임 준비 완료!"),setTimeout(()=>{i(!1)},500)}catch(e){c(`❌ 게임 로딩 실패: ${e.message}`)}})()},[i]),e.useEffect(()=>{const e=e=>{"Escape"===e.code&&r(),"KeyR"===e.code&&a(),"KeyH"===e.code&&t("/")};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},[r,a,t]),e.useEffect(()=>{const e=document.querySelector("canvas");e&&e.addEventListener("click",()=>{e.requestPointerLock()})},[s]),Lt.jsxs("div",{className:"game-page",children:[s&&Lt.jsxs("div",{className:"loading-screen",children:[Lt.jsx("div",{className:"loader"}),Lt.jsx("p",{className:"loading-status",children:l})]}),!s&&Lt.jsxs(Lt.Fragment,{children:[Lt.jsx(Ut,{}),Lt.jsx(Ht,{}),Lt.jsx("button",{className:"home-btn",onClick:()=>t("/"),title:"홈으로 돌아가기 (H)",children:"🏠"})]})]})}function Vt(e,t){if(t===w)return e;if(t===S||t===j){let s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,i=[];if(t===S)for(let e=1;e<=n;e++)i.push(s.getX(0)),i.push(s.getX(e)),i.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(i.push(s.getX(e)),i.push(s.getX(e+1)),i.push(s.getX(e+2))):(i.push(s.getX(e+2)),i.push(s.getX(e+1)),i.push(s.getX(e)));i.length;const r=e.clone();return r.setIndex(i),r.clearGroups(),r}return e}class Kt extends M{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new qt(e)}),this.register(function(e){return new $t(e)}),this.register(function(e){return new os(e)}),this.register(function(e){return new ls(e)}),this.register(function(e){return new cs(e)}),this.register(function(e){return new es(e)}),this.register(function(e){return new ts(e)}),this.register(function(e){return new ss(e)}),this.register(function(e){return new ns(e)}),this.register(function(e){return new Yt(e)}),this.register(function(e){return new is(e)}),this.register(function(e){return new Jt(e)}),this.register(function(e){return new as(e)}),this.register(function(e){return new rs(e)}),this.register(function(e){return new Zt(e)}),this.register(function(e){return new hs(e)}),this.register(function(e){return new ds(e)})}load(e,t,s,n){const i=this;let r;if(""!==this.resourcePath)r=this.resourcePath;else if(""!==this.path){const t=T.extractUrlBase(e);r=T.resolveURL(t,this.path)}else r=T.extractUrlBase(e);this.manager.itemStart(e);const a=function(t){n&&n(t),i.manager.itemError(e),i.manager.itemEnd(e)},o=new C(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(s){try{i.parse(s,r,function(s){t(s),i.manager.itemEnd(e)},a)}catch(n){a(n)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let i;const r={},a={},o=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===us){try{r[Qt.KHR_BINARY_GLTF]=new gs(e)}catch(c){return void(n&&n(c))}i=JSON.parse(r[Qt.KHR_BINARY_GLTF].content)}else i=JSON.parse(o.decode(e))}else i=e;if(void 0===i.asset||i.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Us(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const e=this.pluginCallbacks[h](l);e.name,a[e.name]=e,r[e.name]=!0}if(i.extensionsUsed)for(let h=0;h<i.extensionsUsed.length;++h){const e=i.extensionsUsed[h],t=i.extensionsRequired||[];switch(e){case Qt.KHR_MATERIALS_UNLIT:r[e]=new Wt;break;case Qt.KHR_DRACO_MESH_COMPRESSION:r[e]=new fs(i,this.dracoLoader);break;case Qt.KHR_TEXTURE_TRANSFORM:r[e]=new vs;break;case Qt.KHR_MESH_QUANTIZATION:r[e]=new xs;break;default:t.indexOf(e)>=0&&a[e]}}l.setExtensions(r),l.setPlugins(a),l.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,i){s.parse(e,t,n,i)})}}function Xt(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Qt={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Zt{constructor(e){this.parser=e,this.name=Qt.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const i=t.json,r=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let a;const o=new h(16777215);void 0!==r.color&&o.setRGB(r.color[0],r.color[1],r.color[2],A);const l=void 0!==r.range?r.range:0;switch(r.type){case"directional":a=new g(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new O(o),a.distance=l;break;case"spot":a=new E(o),a.distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,a.angle=r.spot.outerConeAngle,a.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return a.position.set(0,0,0),a.decay=2,ks(a,r),void 0!==r.intensity&&(a.intensity=r.intensity),a.name=t.createUniqueName(r.name||"light_"+e),n=Promise.resolve(a),t.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],i=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return s._getNodeRef(t.cache,i,e)})}}let Wt=class{constructor(){this.name=Qt.KHR_MATERIALS_UNLIT}getMaterialType(){return R}extendParams(e,t,s){const n=[];e.color=new h(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],A),e.opacity=t[3]}void 0!==i.baseColorTexture&&n.push(s.assignTexture(e,"map",i.baseColorTexture,D))}return Promise.all(n)}},Yt=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}},qt=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new N(e,e)}return Promise.all(i)}},$t=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.dispersion=void 0!==n.dispersion?n.dispersion:0,Promise.resolve()}},Jt=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return void 0!==r.iridescenceFactor&&(t.iridescence=r.iridescenceFactor),void 0!==r.iridescenceTexture&&i.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),void 0!==r.iridescenceIor&&(t.iridescenceIOR=r.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==r.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),void 0!==r.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),void 0!==r.iridescenceThicknessTexture&&i.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(i)}},es=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new h(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=n.extensions[this.name];if(void 0!==r.sheenColorFactor){const e=r.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],A)}return void 0!==r.sheenRoughnessFactor&&(t.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&i.push(s.assignTexture(t,"sheenColorMap",r.sheenColorTexture,D)),void 0!==r.sheenRoughnessTexture&&i.push(s.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(i)}},ts=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(i)}},ss=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];t.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&i.push(s.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const a=r.attenuationColor||[1,1,1];return t.attenuationColor=(new h).setRGB(a[0],a[1],a[2],A),Promise.all(i)}},ns=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}},is=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];t.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&i.push(s.assignTexture(t,"specularIntensityMap",r.specularTexture));const a=r.specularColorFactor||[1,1,1];return t.specularColor=(new h).setRGB(a[0],a[1],a[2],A),void 0!==r.specularColorTexture&&i.push(s.assignTexture(t,"specularColorMap",r.specularColorTexture,D)),Promise.all(i)}},rs=class{constructor(e){this.parser=e,this.name=Qt.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return t.bumpScale=void 0!==r.bumpFactor?r.bumpFactor:1,void 0!==r.bumpTexture&&i.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(i)}},as=class{constructor(e){this.parser=e,this.name=Qt.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?_:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return void 0!==r.anisotropyStrength&&(t.anisotropy=r.anisotropyStrength),void 0!==r.anisotropyRotation&&(t.anisotropyRotation=r.anisotropyRotation),void 0!==r.anisotropyTexture&&i.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(i)}};class os{constructor(e){this.parser=e,this.name=Qt.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,r)}}class ls{constructor(e){this.parser=e,this.name=Qt.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],a=n.images[r.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then(function(i){if(i)return s.loadTextureImage(e,r.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class cs{constructor(e){this.parser=e,this.name=Qt.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],a=n.images[r.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then(function(i){if(i)return s.loadTextureImage(e,r.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class hs{constructor(e){this.name=Qt.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(t){const s=e.byteOffset||0,n=e.byteLength||0,r=e.count,a=e.byteStride,o=new Uint8Array(t,s,n);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(r,a,o,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){const t=new ArrayBuffer(r*a);return i.decodeGltfBuffer(new Uint8Array(t),r,a,o,e.mode,e.filter),t})})}return null}}let ds=class{constructor(e){this.name=Qt.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const n=t.meshes[s.mesh];for(const o of n.primitives)if(o.mode!==Ss.TRIANGLES&&o.mode!==Ss.TRIANGLE_STRIP&&o.mode!==Ss.TRIANGLE_FAN&&void 0!==o.mode)return null;const i=s.extensions[this.name].attributes,r=[],a={};for(const o in i)r.push(this.parser.getDependency("accessor",i[o]).then(e=>(a[o]=e,a[o])));return r.length<1?null:(r.push(this.parser.createNodeMesh(e)),Promise.all(r).then(e=>{const t=e.pop(),s=t.isGroup?t.children:[t],n=e[0].count,i=[];for(const r of s){const e=new P,t=new k,s=new pe,o=new k(1,1,1),l=new L(r.geometry,r.material,n);for(let i=0;i<n;i++)a.TRANSLATION&&t.fromBufferAttribute(a.TRANSLATION,i),a.ROTATION&&s.fromBufferAttribute(a.ROTATION,i),a.SCALE&&o.fromBufferAttribute(a.SCALE,i),l.setMatrixAt(i,e.compose(t,s,o));for(const n in a)if("_COLOR_0"===n){const e=a[n];l.instanceColor=new I(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==n&&"ROTATION"!==n&&"SCALE"!==n&&r.geometry.setAttribute(n,a[n]);z.prototype.copy.call(l,r),this.parser.assignFinalMaterial(l),i.push(l)}return t.isGroup?(t.clear(),t.add(...i),t):i[0]}))}};const us="glTF",ps=1313821514,ms=5130562;class gs{constructor(e){this.name=Qt.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==us)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,i=new DataView(e,12);let r=0;for(;r<n;){const t=i.getUint32(r,!0);r+=4;const n=i.getUint32(r,!0);if(r+=4,n===ps){const n=new Uint8Array(e,12+r,t);this.content=s.decode(n)}else if(n===ms){const s=12+r;this.body=e.slice(s,s+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class fs{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Qt.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,a={},o={},l={};for(const c in r){const e=As[c]||c.toLowerCase();a[e]=r[c]}for(const c in e.attributes){const t=As[c]||c.toLowerCase();if(void 0!==r[c]){const n=s.accessors[e.attributes[c]],i=js[n.componentType];l[t]=i.name,o[t]=!0===n.normalized}}return t.getDependency("bufferView",i).then(function(e){return new Promise(function(t,s){n.decodeDracoFile(e,function(e){for(const t in e.attributes){const s=e.attributes[t],n=o[t];void 0!==n&&(s.normalized=n)}t(e)},a,l,A,s)})})}}class vs{constructor(){this.name=Qt.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class xs{constructor(){this.name=Qt.KHR_MESH_QUANTIZATION}}class bs extends Ee{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let r=0;r!==n;r++)t[r]=s[i+r];return t}interpolate_(e,t,s,n){const i=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,c=n-t,h=(s-t)/c,d=h*h,u=d*h,p=e*l,m=p-l,g=-2*u+3*d,f=u-d,v=1-g,x=f-d+h;for(let b=0;b!==a;b++){const e=r[m+b+a],t=r[m+b+o]*c,s=r[p+b+a],n=r[p+b]*c;i[b]=v*e+x*t+g*s+f*n}return i}}const ys=new pe;class ws extends bs{interpolate_(e,t,s,n){const i=super.interpolate_(e,t,s,n);return ys.fromArray(i).normalize().toArray(i),i}}const Ss={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},js={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ms={9728:X,9729:G,9984:me,9985:ge,9986:fe,9987:V},Ts={33071:ve,33648:xe,10497:K},Cs={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},As={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Es={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Os={CUBICSPLINE:void 0,LINEAR:de,STEP:be},Rs="OPAQUE",Ds="MASK",_s="BLEND";function Ns(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new Y({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ye})),e.DefaultMaterial}function Ps(e,t,s){for(const n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function ks(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function Ls(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}}}function Is(e){let t;const s=e.extensions&&e.extensions[Qt.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+zs(s.attributes):e.indices+":"+zs(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+zs(e.targets[n]);return t}function zs(e){let t="";const s=Object.keys(e).sort();for(let n=0,i=s.length;n<i;n++)t+=s[n]+":"+e[s[n]]+";";return t}function Fs(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const Bs=new P;class Us{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Xt,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,i=!1,r=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;s=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);n=s&&t?parseInt(t[1],10):-1,i=e.indexOf("Firefox")>-1,r=i?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||s&&n<17||i&&r<98?this.textureLoader=new F(this.options.manager):this.textureLoader=new B(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new C(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){const r={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};return Ps(i,r,n),ks(r,n),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(r)})).then(function(){for(const e of r.scenes)e.updateMatrixWorld();e(r)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const s=t[n].joints;for(let t=0,n=s.length;t<n;t++)e[s[t]].isBone=!0}for(let n=0,i=e.length;n<i;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),i=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[n,r]of e.children.entries())i(r,t.children[n])};return i(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const i=e(t[n]);i&&s.push(i)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":n=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Qt.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(e,i){s.load(T.resolveURL(t.uri,n.path),e,void 0,function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=Cs[n.type],t=js[n.componentType],s=!0===n.normalized,i=new t(n.count*e);return Promise.resolve(new U(i,e,s))}const i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(e){const i=e[0],r=Cs[n.type],a=js[n.componentType],o=a.BYTES_PER_ELEMENT,l=o*r,c=n.byteOffset||0,h=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;let u,p;if(h&&h!==l){const e=Math.floor(c/h),s="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let l=t.cache.get(s);l||(u=new a(i,e*h,n.count*h/o),l=new H(u,h/o),t.cache.add(s,l)),p=new we(l,r,c%h/o,d)}else u=null===i?new a(n.count*r):new a(i,c,n.count*r),p=new U(u,r,d);if(void 0!==n.sparse){const t=Cs.SCALAR,s=js[n.sparse.indices.componentType],o=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,c=new s(e[1],o,n.sparse.count*t),h=new a(e[2],l,n.sparse.count*r);null!==i&&(p=new U(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let e=0,n=c.length;e<n;e++){const t=c[e];if(p.setX(t,h[e*r]),r>=2&&p.setY(t,h[e*r+1]),r>=3&&p.setZ(t,h[e*r+2]),r>=4&&p.setW(t,h[e*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=d}return p})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,i=t.images[n];let r=this.textureLoader;if(i.uri){const e=s.manager.getHandler(i.uri);null!==e&&(r=e)}return this.loadTextureImage(e,n,r)}loadTextureImage(e,t,s){const n=this,i=this.json,r=i.textures[e],a=i.images[t],o=(a.uri||a.bufferView)+":"+r.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=r.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);const s=(i.samplers||{})[r.sampler]||{};return t.magFilter=Ms[s.magFilter]||G,t.minFilter=Ms[s.minFilter]||V,t.wrapS=Ts[s.wrapS]||K,t.wrapT=Ts[s.wrapT]||K,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==X&&t.minFilter!==G,n.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=l,l}loadImageSource(e,t){const s=this,n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const r=n.images[e],a=self.URL||self.webkitURL;let o=r.uri||"",l=!1;if(void 0!==r.bufferView)o=s.getDependency("bufferView",r.bufferView).then(function(e){l=!0;const t=new Blob([e],{type:r.mimeType});return o=a.createObjectURL(t),o});else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(o).then(function(e){return new Promise(function(s,n){let r=s;!0===t.isImageBitmapLoader&&(r=function(e){const t=new Se(e);t.needsUpdate=!0,s(t)}),t.load(T.resolveURL(e,i.path),r,void 0,n)})}).then(function(e){var t;return!0===l&&a.revokeObjectURL(o),ks(e,r),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw e});return this.sourceCache[e]=c,c}assignTexture(e,t,s,n){const i=this;return this.getDependency("texture",s.index).then(function(r){if(!r)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((r=r.clone()).channel=s.texCoord),i.extensions[Qt.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[Qt.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(r);r=i.extensions[Qt.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),i.associations.set(r,t)}}return void 0!==n&&(r.colorSpace=n),e[t]=r,r})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=void 0===t.attributes.tangent,i=void 0!==t.attributes.color,r=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Q,Z.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new W,Z.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(n||i||r){let e="ClonedMaterial:"+s.uuid+":";n&&(e+="derivative-tangents:"),i&&(e+="vertex-colors:"),r&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),i&&(t.vertexColors=!0),r&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return Y}loadMaterial(e){const t=this,s=this.json,n=this.extensions,i=s.materials[e];let r;const a={},o=[];if((i.extensions||{})[Qt.KHR_MATERIALS_UNLIT]){const e=n[Qt.KHR_MATERIALS_UNLIT];r=e.getMaterialType(),o.push(e.extendParams(a,i,t))}else{const s=i.pbrMetallicRoughness||{};if(a.color=new h(1,1,1),a.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],A),a.opacity=e[3]}void 0!==s.baseColorTexture&&o.push(t.assignTexture(a,"map",s.baseColorTexture,D)),a.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,a.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(o.push(t.assignTexture(a,"metalnessMap",s.metallicRoughnessTexture)),o.push(t.assignTexture(a,"roughnessMap",s.metallicRoughnessTexture))),r=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),o.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===i.doubleSided&&(a.side=q);const l=i.alphaMode||Rs;if(l===_s?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,l===Ds&&(a.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&r!==R&&(o.push(t.assignTexture(a,"normalMap",i.normalTexture)),a.normalScale=new N(1,1),void 0!==i.normalTexture.scale)){const e=i.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==i.occlusionTexture&&r!==R&&(o.push(t.assignTexture(a,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(a.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&r!==R){const e=i.emissiveFactor;a.emissive=(new h).setRGB(e[0],e[1],e[2],A)}return void 0!==i.emissiveTexture&&r!==R&&o.push(t.assignTexture(a,"emissiveMap",i.emissiveTexture,D)),Promise.all(o).then(function(){const s=new r(a);return i.name&&(s.name=i.name),ks(s,i),t.associations.set(s,{materials:e}),i.extensions&&Ps(n,s,i),s})}createUniqueName(e){const t=$.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function i(e){return s[Qt.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return Hs(s,e,t)})}const r=[];for(let a=0,o=e.length;a<o;a++){const s=e[a],o=Is(s),l=n[o];if(l)r.push(l.promise);else{let e;e=s.extensions&&s.extensions[Qt.KHR_DRACO_MESH_COMPRESSION]?i(s):Hs(new J,s,t),n[o]={primitive:s,promise:e},r.push(e)}}return Promise.all(r)}loadMesh(e){const t=this,s=this.json,n=this.extensions,i=s.meshes[e],r=i.primitives,a=[];for(let o=0,l=r.length;o<l;o++){const e=void 0===r[o].material?Ns(this.cache):this.getDependency("material",r[o].material);a.push(e)}return a.push(t.loadGeometries(r)),Promise.all(a).then(function(s){const a=s.slice(0,s.length-1),o=s[s.length-1],l=[];for(let h=0,d=o.length;h<d;h++){const s=o[h],c=r[h];let d;const u=a[h];if(c.mode===Ss.TRIANGLES||c.mode===Ss.TRIANGLE_STRIP||c.mode===Ss.TRIANGLE_FAN||void 0===c.mode)d=!0===i.isSkinnedMesh?new ee(s,u):new x(s,u),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),c.mode===Ss.TRIANGLE_STRIP?d.geometry=Vt(d.geometry,j):c.mode===Ss.TRIANGLE_FAN&&(d.geometry=Vt(d.geometry,S));else if(c.mode===Ss.LINES)d=new te(s,u);else if(c.mode===Ss.LINE_STRIP)d=new se(s,u);else if(c.mode===Ss.LINE_LOOP)d=new ne(s,u);else{if(c.mode!==Ss.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);d=new ie(s,u)}Object.keys(d.geometry.morphAttributes).length>0&&Ls(d,i),d.name=t.createUniqueName(i.name||"mesh_"+e),ks(d,i),c.extensions&&Ps(n,d,c),t.assignFinalMaterial(d),l.push(d)}for(let n=0,i=l.length;n<i;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return i.extensions&&Ps(n,l[0],i),l[0];const c=new re;i.extensions&&Ps(n,c,i),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new d(ae.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new oe(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),ks(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,i=t.joints.length;n<i;n++)s.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){const t=e.pop(),s=e,n=[],i=[];for(let r=0,a=s.length;r<a;r++){const e=s[r];if(e){n.push(e);const s=new P;null!==t&&s.fromArray(t.array,16*r),i.push(s)}}return new le(n,i)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],i=n.name?n.name:"animation_"+e,r=[],a=[],o=[],l=[],c=[];for(let h=0,d=n.channels.length;h<d;h++){const e=n.channels[h],t=n.samplers[e.sampler],s=e.target,i=s.node,d=void 0!==n.parameters?n.parameters[t.input]:t.input,u=void 0!==n.parameters?n.parameters[t.output]:t.output;void 0!==s.node&&(r.push(this.getDependency("node",i)),a.push(this.getDependency("accessor",d)),o.push(this.getDependency("accessor",u)),l.push(t),c.push(s))}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(o),Promise.all(l),Promise.all(c)]).then(function(e){const t=e[0],n=e[1],r=e[2],a=e[3],o=e[4],l=[];for(let i=0,c=t.length;i<c;i++){const e=t[i],c=n[i],h=r[i],d=a[i],u=o[i];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const p=s._createAnimationTracks(e,c,h,d,u);if(p)for(let t=0;t<p.length;t++)l.push(p[t])}return new ce(i,void 0,l)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]}),t})}loadNode(e){const t=this,s=this.json.nodes[e],n=t._loadNodeShallow(e),i=[],r=s.children||[];for(let o=0,l=r.length;o<l;o++)i.push(t.getDependency("node",r[o]));const a=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([n,Promise.all(i),a]).then(function(e){const t=e[0],s=e[1],n=e[2];null!==n&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(n,Bs)});for(let i=0,r=s.length;i<r;i++)t.add(s[i]);return t})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const i=t.nodes[e],r=i.name?n.createUniqueName(i.name):"",a=[],o=n._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return o&&a.push(o),void 0!==i.camera&&a.push(n.getDependency("camera",i.camera).then(function(e){return n._getNodeRef(n.cameraCache,i.camera,e)})),n._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if(a=!0===i.isBone?new he:t.length>1?new re:1===t.length?t[0]:new z,a!==t[0])for(let e=0,s=t.length;e<s;e++)a.add(t[e]);if(i.name&&(a.userData.name=i.name,a.name=r),ks(a,i),i.extensions&&Ps(s,a,i),void 0!==i.matrix){const e=new P;e.fromArray(i.matrix),a.applyMatrix4(e)}else void 0!==i.translation&&a.position.fromArray(i.translation),void 0!==i.rotation&&a.quaternion.fromArray(i.rotation),void 0!==i.scale&&a.scale.fromArray(i.scale);return n.associations.has(a)||n.associations.set(a,{}),n.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,i=new re;s.name&&(i.name=n.createUniqueName(s.name)),ks(i,s),s.extensions&&Ps(t,i,s);const r=s.nodes||[],a=[];for(let o=0,l=r.length;o<l;o++)a.push(n.getDependency("node",r[o]));return Promise.all(a).then(function(e){for(let t=0,s=e.length;t<s;t++)i.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[s,i]of n.associations)(s instanceof Z||s instanceof Se)&&t.set(s,i);return e.traverse(e=>{const s=n.associations.get(e);null!=s&&t.set(e,s)}),t})(i),i})}_createAnimationTracks(e,t,s,n,i){const r=[],a=e.name?e.name:e.uuid,o=[];let l;switch(Es[i.path]===Es.weights?e.traverse(function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)}):o.push(a),Es[i.path]){case Es.weights:l=Me;break;case Es.rotation:l=Te;break;case Es.position:case Es.scale:l=je;break;default:if(1===s.itemSize)l=Me;else l=je}const c=void 0!==n.interpolation?Os[n.interpolation]:de,h=this._getArrayFromAccessor(s);for(let d=0,u=o.length;d<u;d++){const e=new l(o[d]+"."+Es[i.path],t.array,h,c);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(e),r.push(e)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=Fs(t.constructor),s=new Float32Array(t.length);for(let n=0,i=t.length;n<i;n++)s[n]=t[n]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof Te?ws:bs)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Hs(e,t,s){const n=t.attributes,i=[];function r(t,n){return s.getDependency("accessor",t).then(function(t){e.setAttribute(n,t)})}for(const a in n){const t=As[a]||a.toLowerCase();t in e.attributes||i.push(r(n[a],t))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});i.push(n)}return ue.workingColorSpace,ks(e,t),function(e,t,s){const n=t.attributes,i=new Ce;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],t=e.min,r=e.max;if(void 0===t||void 0===r)return;if(i.set(new k(t[0],t[1],t[2]),new k(r[0],r[1],r[2])),e.normalized){const t=Fs(js[e.componentType]);i.min.multiplyScalar(t),i.max.multiplyScalar(t)}}const r=t.targets;if(void 0!==r){const e=new k,t=new k;for(let n=0,i=r.length;n<i;n++){const i=r[n];if(void 0!==i.POSITION){const n=s.json.accessors[i.POSITION],r=n.min,a=n.max;if(void 0!==r&&void 0!==a){if(t.setX(Math.max(Math.abs(r[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(a[2]))),n.normalized){const e=Fs(js[n.componentType]);t.multiplyScalar(e)}e.max(t)}}}i.expandByVector(e)}e.boundingBox=i;const a=new Ae;i.getCenter(a.center),a.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=a}(e,t,s),Promise.all(i).then(function(){return void 0!==t.targets?function(e,t,s){let n=!1,i=!1,r=!1;for(let c=0,h=t.length;c<h;c++){const e=t[c];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(i=!0),void 0!==e.COLOR_0&&(r=!0),n&&i&&r)break}if(!n&&!i&&!r)return Promise.resolve(e);const a=[],o=[],l=[];for(let c=0,h=t.length;c<h;c++){const h=t[c];if(n){const t=void 0!==h.POSITION?s.getDependency("accessor",h.POSITION):e.attributes.position;a.push(t)}if(i){const t=void 0!==h.NORMAL?s.getDependency("accessor",h.NORMAL):e.attributes.normal;o.push(t)}if(r){const t=void 0!==h.COLOR_0?s.getDependency("accessor",h.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then(function(t){const s=t[0],a=t[1],o=t[2];return n&&(e.morphAttributes.position=s),i&&(e.morphAttributes.normal=a),r&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}(e,t.targets,s):e})}const Gs=(()=>{try{const e=localStorage.getItem("hdriSettings");if(e){return JSON.parse(e)}}catch(e){}return null})(),Vs=o((e,t)=>({scene:null,camera:null,renderer:null,selectedObject:null,transformMode:"translate",isWireframe:!1,isGridSnap:!1,isGridVisible:!0,gridSize:1,gizmoSpace:"world",isMagnetEnabled:!1,showMagnetRays:!1,hdriSettings:{currentHDRI:{name:"기본 배경",type:"none"},hdriIntensity:1,hdriRotation:0,sunLightEnabled:!0,sunIntensity:1,timeOfDay:12,sunAzimuth:0,sunElevation:45,sunColor:"#ffffff",...Gs},sunLightRef:null,savedObjects:new Map,customMeshes:(()=>{try{const e=localStorage.getItem("customMeshes");return e?JSON.parse(e):[]}catch(e){return[]}})(),objects:[],walls:[],clipboard:null,setSelectedObject:t=>e({selectedObject:t}),setTransformMode:t=>e({transformMode:t}),toggleWireframe:()=>e(e=>({isWireframe:!e.isWireframe})),toggleGridSnap:()=>e(e=>({isGridSnap:!e.isGridSnap})),toggleGridVisible:()=>e(e=>({isGridVisible:!e.isGridVisible})),setGridSize:t=>e({gridSize:t}),toggleGizmoSpace:()=>e(e=>({gizmoSpace:"world"===e.gizmoSpace?"local":"world"})),toggleMagnet:()=>e(e=>({isMagnetEnabled:!e.isMagnetEnabled})),toggleMagnetRays:()=>e(e=>({showMagnetRays:!e.showMagnetRays})),updateHDRISettings:t=>e(e=>({hdriSettings:{...e.hdriSettings,...t}})),setSunLightRef:t=>e({sunLightRef:t}),initializeHDRISettings:()=>{try{const t=localStorage.getItem("hdriSettings");if(t){const s=JSON.parse(t);return e(e=>({hdriSettings:{...e.hdriSettings,...s}})),!0}}catch(t){}return!1},saveHDRISettings:()=>{const{hdriSettings:e}=t();try{localStorage.setItem("hdriSettings",JSON.stringify(e))}catch(s){}},addAsset:(t,s)=>e(e=>{const n=new Map(e.savedObjects);return n.set(t,s),{savedObjects:n}}),addCustomMesh:t=>e(e=>({customMeshes:[...e.customMeshes,t]})),deleteCustomMesh:t=>e(e=>({customMeshes:e.customMeshes.filter(e=>e.id!==t)})),loadCustomMeshes:t=>e(e=>({customMeshes:t})),updateObjectTransform:(t,s)=>e(e=>({objects:e.objects.map(e=>e.id===t?{...e,...s}:e)})),addObject:t=>e(e=>({objects:[...e.objects,t]})),removeObject:t=>e(e=>t.isSystemObject?e:{objects:e.objects.filter(e=>e!==t),selectedObject:e.selectedObject===t?null:e.selectedObject}),addWall:t=>e(e=>({walls:[...e.walls,t]})),removeWall:t=>e(e=>({walls:e.walls.filter(e=>e.id!==t)})),updateObject:(t,s)=>e(e=>({objects:e.objects.map(e=>e.id===t?{...e,...s}:e)})),copyObject:s=>{var n,i,r,a,o;if(!s)return;if(s.isObject3D){t();const l=null==(n=s.userData)?void 0:n.id;if(l){const{updateObjectTransform:e}=t();e(l,{position:{x:s.position.x,y:s.position.y,z:s.position.z},rotation:{x:s.rotation.x,y:s.rotation.y,z:s.rotation.z},scale:{x:s.scale.x,y:s.scale.y,z:s.scale.z}})}const c=t().objects.find(e=>e.id===l),h={name:`${s.name}_copy`,type:(null==c?void 0:c.type)||(null==(i=s.userData)?void 0:i.type)||"basic",geometry:(null==c?void 0:c.geometry)||(null==(r=s.userData)?void 0:r.geometry)||"BoxGeometry",params:(null==c?void 0:c.params)||(null==(a=s.userData)?void 0:a.params)||[1,1,1],uuid:s.uuid,..."glb"===(null==c?void 0:c.type)&&{url:c.url,glbData:c.glbData,file:c.file},position:{x:s.position.x,y:s.position.y,z:s.position.z},rotation:{x:s.rotation.x,y:s.rotation.y,z:s.rotation.z},scale:{x:s.scale.x,y:s.scale.y,z:s.scale.z},visible:s.visible,material:(null==c?void 0:c.material)||(null==(o=s.userData)?void 0:o.material)||{type:"MeshStandardMaterial",color:16711680},originalObject:s};return void e({clipboard:h})}if(s.isSystemObject)return;const l={...s,id:void 0,name:`${s.name}_copy`};e({clipboard:l})},pasteObject:()=>{var s,n,i,r,a,o,l,c,h;const d=t();if(!d.clipboard)return null;const u={...d.clipboard,id:Date.now(),position:{x:(null==(s=d.clipboard.position)?void 0:s.x)||0,y:(null==(n=d.clipboard.position)?void 0:n.y)||0,z:(null==(i=d.clipboard.position)?void 0:i.z)||0},rotation:{x:(null==(r=d.clipboard.rotation)?void 0:r.x)||0,y:(null==(a=d.clipboard.rotation)?void 0:a.y)||0,z:(null==(o=d.clipboard.rotation)?void 0:o.z)||0},scale:{x:(null==(l=d.clipboard.scale)?void 0:l.x)||1,y:(null==(c=d.clipboard.scale)?void 0:c.y)||1,z:(null==(h=d.clipboard.scale)?void 0:h.z)||1}},p=[...d.objects,u];return e({objects:p,selectedObject:u.id}),u},hasClipboardData:()=>null!==t().clipboard,clearClipboard:()=>{e({clipboard:null})},deleteSelectedObject:()=>{const s=t();if(!s.selectedObject)return;const n=s.objects.find(e=>e.id===s.selectedObject);if(!n)return;if(n.isSystemObject)return;const i=s.objects.filter(e=>e.id!==s.selectedObject);e({objects:i,selectedObject:null})},updateWall:(t,s)=>e(e=>({walls:e.walls.map(e=>e.id===t?{...e,...s}:e)})),toggleObjectVisibility:t=>e(e=>{const s=!1===t.visible;return{objects:e.objects.map(e=>e.id===t.id?{...e,visible:s}:e),walls:e.walls.map(e=>e.id===t.id?{...e,visible:s}:e)}}),toggleObjectFreeze:t=>e(e=>{const s=!0!==t.frozen;return{objects:e.objects.map(e=>e.id===t.id?{...e,frozen:s}:e),walls:e.walls.map(e=>e.id===t.id?{...e,frozen:s}:e)}}),renameObject:(t,s)=>e(e=>({objects:e.objects.map(e=>e.id===t?{...e,name:s}:e),walls:e.walls.map(e=>e.id===t?{...e,name:s}:e)})),saveMap:e=>{const s=t(),n={walls:s.walls,objects:s.objects};localStorage.setItem(`map_${e}`,JSON.stringify(n))},loadMap:t=>{const s=localStorage.getItem(`map_${t}`);if(s){const t=JSON.parse(s);return e(e=>({walls:t.walls||[],objects:t.objects||[]})),!0}return!1},clearMap:()=>e(e=>({objects:e.objects.filter(e=>e.isSystemObject),walls:[],selectedObject:null})),setScene:(t,s,n)=>e({scene:t,camera:s,renderer:n})}));class Ks{constructor(e,t,s=null){this.camera=e,this.renderer=t,this.onCameraChange=s,this.initialPosition=e.position.clone(),this.initialTarget=new k(0,0,0),this.cameraTarget=new k(0,0,0),this.spherical=new Oe,this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget)),this._tempVector1=new k,this._tempVector2=new k,this._tempVector3=new k}resetCamera(){this.camera.position.copy(this.initialPosition),this.cameraTarget.copy(this.initialTarget),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}toggleProjection(){const e=this.camera,t=e.position.clone(),s=this.cameraTarget.clone();if(e.isPerspectiveCamera){const e=t.distanceTo(s),n=window.innerWidth/window.innerHeight,i=.5*e,r=new oe(i*n/-2,i*n/2,i/2,i/-2,.1,1e3);r.position.copy(t),r.lookAt(s),r.updateMatrixWorld(),this.camera=r}else{const e=new d(75,window.innerWidth/window.innerHeight,.1,1e3);e.position.copy(t),e.lookAt(s),e.updateMatrixWorld(),this.camera=e}return this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget)),this.onCameraChange&&this.onCameraChange(this.camera),this.camera}setView(e){const t=this.camera.position.distanceTo(this.cameraTarget),s=this.cameraTarget.clone();let n=new k;switch(e){case"front":n.set(s.x,s.y,s.z+t);break;case"side":n.set(s.x+t,s.y,s.z);break;case"top":n.set(s.x,s.y+t,s.z);break;case"bottom":n.set(s.x,s.y-t,s.z);break;default:return}this.camera.position.copy(n),this.camera.lookAt(s),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}pan(e,t){const s=new k,n=new k;s.setFromMatrixColumn(this.camera.matrix,0),n.setFromMatrixColumn(this.camera.matrix,1);const i=this.camera.position.distanceTo(this.cameraTarget)/50*50,r=new k;r.add(s.clone().multiplyScalar(-e*i)),r.add(n.clone().multiplyScalar(-t*i)),this.camera.position.add(r),this.cameraTarget.add(r),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}updateRotationCenterAfterPan(e,t=[]){const s=new Re,n=new N(0,0);s.setFromCamera(n,this.camera);const i=s.intersectObjects(t,!0);if(i.length>0){const e=i[0].point;this.cameraTarget.copy(e)}else{const e=new k;e.setFromMatrixColumn(this.camera.matrix,2).negate();const t=this.camera.position.clone().add(e.multiplyScalar(50));this.cameraTarget.copy(t)}this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}orbit(e,t){this.spherical.theta-=100*e*.01,this.spherical.phi+=100*t*.01,this.spherical.phi=Math.max(.1,Math.min(Math.PI-.1,this.spherical.phi));const s=new k;s.setFromSpherical(this.spherical),s.add(this.cameraTarget),this.camera.position.copy(s),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld()}zoom(e){const t=e>0?1.2:1/1.2;if(this.camera.isPerspectiveCamera){this.spherical.radius*=t,this.spherical.radius=Math.max(1,Math.min(1e3,this.spherical.radius));const e=new k;e.setFromSpherical(this.spherical),e.add(this.cameraTarget),this.camera.position.copy(e),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld()}else if(this.camera.isOrthographicCamera){const e=(this.camera.right-this.camera.left)*t,s=(this.camera.top-this.camera.bottom)*t,n=2e3,i=.1,r=Math.max(i,Math.min(n,e)),a=Math.max(i,Math.min(n,s));this.camera.left=-r/2,this.camera.right=r/2,this.camera.top=a/2,this.camera.bottom=-a/2,this.camera.updateProjectionMatrix()}}focusOnObject(e){if(!e)return;e.updateWorldMatrix(!0,!0);const t=(new Ce).setFromObject(e),s=t.getCenter(new k),n=t.getSize(new k),i=Math.max(n.x,n.y,n.z);let r;if(this.camera.isPerspectiveCamera){const e=this.camera.fov*(Math.PI/180);r=1.5*Math.abs(i/Math.sin(e/2))}else r=2*i;this.cameraTarget.copy(s);const a=new k;a.subVectors(this.camera.position,this.cameraTarget).normalize(),this.camera.position.copy(s).add(a.multiplyScalar(r)),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}handleResize(){if(this.camera.isPerspectiveCamera)this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix();else if(this.camera.isOrthographicCamera){const e=window.innerWidth/window.innerHeight,t=(this.camera.top-this.camera.bottom)*e;this.camera.left=-t/2,this.camera.right=t/2,this.camera.updateProjectionMatrix()}}setTarget(e){this.cameraTarget.copy(e),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}getCamera(){return this.camera}getTarget(){return this.cameraTarget.clone()}}const Xs=new Re,Qs=new k,Zs=new k,Ws=new pe,Ys={X:new k(1,0,0),Y:new k(0,1,0),Z:new k(0,0,1)},qs={type:"change"},$s={type:"mouseDown",mode:null},Js={type:"mouseUp",mode:null},en={type:"objectChange"};class tn extends De{constructor(e,t=null){super(void 0,t);const s=new jn(this);this._root=s;const n=new Mn;this._gizmo=n,s.add(n);const i=new Tn;this._plane=i,s.add(i);const r=this;function a(e,t){let s=t;Object.defineProperty(r,e,{get:function(){return void 0!==s?s:t},set:function(t){s!==t&&(s=t,i[e]=t,n[e]=t,r.dispatchEvent({type:e+"-changed",value:t}),r.dispatchEvent(qs))}}),r[e]=t,i[e]=t,n[e]=t}a("camera",e),a("object",void 0),a("enabled",!0),a("axis",null),a("mode","translate"),a("translationSnap",null),a("rotationSnap",null),a("scaleSnap",null),a("space","world"),a("size",1),a("dragging",!1),a("showX",!0),a("showY",!0),a("showZ",!0),a("minX",-1/0),a("maxX",1/0),a("minY",-1/0),a("maxY",1/0),a("minZ",-1/0),a("maxZ",1/0);const o=new k,l=new k,c=new pe,h=new pe,d=new k,u=new pe,p=new k,m=new k,g=new k,f=new k;a("worldPosition",o),a("worldPositionStart",l),a("worldQuaternion",c),a("worldQuaternionStart",h),a("cameraPosition",d),a("cameraQuaternion",u),a("pointStart",p),a("pointEnd",m),a("rotationAxis",g),a("rotationAngle",0),a("eye",f),this._offset=new k,this._startNorm=new k,this._endNorm=new k,this._cameraScale=new k,this._parentPosition=new k,this._parentQuaternion=new pe,this._parentQuaternionInv=new pe,this._parentScale=new k,this._worldScaleStart=new k,this._worldQuaternionInv=new pe,this._worldScale=new k,this._positionStart=new k,this._quaternionStart=new pe,this._scaleStart=new k,this._getPointer=sn.bind(this),this._onPointerDown=rn.bind(this),this._onPointerHover=nn.bind(this),this._onPointerMove=an.bind(this),this._onPointerUp=on.bind(this),null!==t&&this.connect()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(e){if(void 0===this.object||!0===this.dragging)return;null!==e&&Xs.setFromCamera(e,this.camera);const t=ln(this._gizmo.picker[this.mode],Xs);this.axis=t?t.object.name:null}pointerDown(e){if(void 0!==this.object&&!0!==this.dragging&&(null==e||0===e.button)&&null!==this.axis){null!==e&&Xs.setFromCamera(e,this.camera);const t=ln(this._plane,Xs,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,$s.mode=this.mode,this.dispatchEvent($s)}}pointerMove(e){const t=this.axis,s=this.mode,n=this.object;let i=this.space;if("scale"===s?i="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(i="world"),void 0===n||null===t||!1===this.dragging||null!==e&&-1!==e.button)return;null!==e&&Xs.setFromCamera(e,this.camera);const r=ln(this._plane,Xs,!0);if(r){if(this.pointEnd.copy(r.point).sub(this.worldPositionStart),"translate"===s)this._offset.copy(this.pointEnd).sub(this.pointStart),"local"===i&&"XYZ"!==t&&this._offset.applyQuaternion(this._worldQuaternionInv),-1===t.indexOf("X")&&(this._offset.x=0),-1===t.indexOf("Y")&&(this._offset.y=0),-1===t.indexOf("Z")&&(this._offset.z=0),"local"===i&&"XYZ"!==t?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),n.position.copy(this._offset).add(this._positionStart),this.translationSnap&&("local"===i&&(n.position.applyQuaternion(Ws.copy(this._quaternionStart).invert()),-1!==t.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.position.applyQuaternion(this._quaternionStart)),"world"===i&&(n.parent&&n.position.add(Qs.setFromMatrixPosition(n.parent.matrixWorld)),-1!==t.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.parent&&n.position.sub(Qs.setFromMatrixPosition(n.parent.matrixWorld)))),n.position.x=Math.max(this.minX,Math.min(this.maxX,n.position.x)),n.position.y=Math.max(this.minY,Math.min(this.maxY,n.position.y)),n.position.z=Math.max(this.minZ,Math.min(this.maxZ,n.position.z));else if("scale"===s){if(-1!==t.search("XYZ")){let e=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(e*=-1),Zs.set(e,e,e)}else Qs.copy(this.pointStart),Zs.copy(this.pointEnd),Qs.applyQuaternion(this._worldQuaternionInv),Zs.applyQuaternion(this._worldQuaternionInv),Zs.divide(Qs),-1===t.search("X")&&(Zs.x=1),-1===t.search("Y")&&(Zs.y=1),-1===t.search("Z")&&(Zs.z=1);n.scale.copy(this._scaleStart).multiply(Zs),this.scaleSnap&&(-1!==t.search("X")&&(n.scale.x=Math.round(n.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Y")&&(n.scale.y=Math.round(n.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),-1!==t.search("Z")&&(n.scale.z=Math.round(n.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if("rotate"===s){this._offset.copy(this.pointEnd).sub(this.pointStart);const e=20/this.worldPosition.distanceTo(Qs.setFromMatrixPosition(this.camera.matrixWorld));let s=!1;"XYZE"===t?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(Qs.copy(this.rotationAxis).cross(this.eye))*e):"X"!==t&&"Y"!==t&&"Z"!==t||(this.rotationAxis.copy(Ys[t]),Qs.copy(Ys[t]),"local"===i&&Qs.applyQuaternion(this.worldQuaternion),Qs.cross(this.eye),0===Qs.length()?s=!0:this.rotationAngle=this._offset.dot(Qs.normalize())*e),("E"===t||s)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),"local"===i&&"E"!==t&&"XYZE"!==t?(n.quaternion.copy(this._quaternionStart),n.quaternion.multiply(Ws.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),n.quaternion.copy(Ws.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),n.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(qs),this.dispatchEvent(en)}}pointerUp(e){null!==e&&0!==e.button||(this.dragging&&null!==this.axis&&(Js.mode=this.mode,this.dispatchEvent(Js)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(e){return this.object=e,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(qs),this.dispatchEvent(en),this.pointStart.copy(this.pointEnd))}getRaycaster(){return Xs}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function sn(e){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};{const t=this.domElement.getBoundingClientRect();return{x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,button:e.button}}}function nn(e){if(this.enabled)switch(e.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(e))}}function rn(e){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(e)),this.pointerDown(this._getPointer(e)))}function an(e){this.enabled&&this.pointerMove(this._getPointer(e))}function on(e){this.enabled&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(e)))}function ln(e,t,s){const n=t.intersectObject(e,!0);for(let i=0;i<n.length;i++)if(n[i].object.visible||s)return n[i];return!1}const cn=new Le,hn=new k(0,1,0),dn=new k(0,0,0),un=new P,pn=new pe,mn=new pe,gn=new k,fn=new P,vn=new k(1,0,0),xn=new k(0,1,0),bn=new k(0,0,1),yn=new k,wn=new k,Sn=new k;class jn extends z{constructor(e){super(),this.isTransformControlsRoot=!0,this.controls=e,this.visible=!1}updateMatrixWorld(e){const t=this.controls;void 0!==t.object&&(t.object.updateMatrixWorld(),null===t.object.parent||t.object.parent.matrixWorld.decompose(t._parentPosition,t._parentQuaternion,t._parentScale),t.object.matrixWorld.decompose(t.worldPosition,t.worldQuaternion,t._worldScale),t._parentQuaternionInv.copy(t._parentQuaternion).invert(),t._worldQuaternionInv.copy(t.worldQuaternion).invert()),t.camera.updateMatrixWorld(),t.camera.matrixWorld.decompose(t.cameraPosition,t.cameraQuaternion,t._cameraScale),t.camera.isOrthographicCamera?t.camera.getWorldDirection(t.eye).negate():t.eye.copy(t.cameraPosition).sub(t.worldPosition).normalize(),super.updateMatrixWorld(e)}dispose(){this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}}class Mn extends z{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new R({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new W({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),s=e.clone();s.opacity=.15;const n=t.clone();n.opacity=.5;const i=e.clone();i.color.setHex(16711680);const r=e.clone();r.color.setHex(65280);const a=e.clone();a.color.setHex(255);const o=e.clone();o.color.setHex(16711680),o.opacity=.5;const l=e.clone();l.color.setHex(65280),l.opacity=.5;const c=e.clone();c.color.setHex(255),c.opacity=.5;const h=e.clone();h.opacity=.25;const d=e.clone();d.color.setHex(16776960),d.opacity=.25;e.clone().color.setHex(16776960);const u=e.clone();u.color.setHex(7895160);const p=new _e(0,.04,.1,12);p.translate(0,.05,0);const m=new b(.08,.08,.08);m.translate(0,.04,0);const g=new J;g.setAttribute("position",new Ne([0,0,0,1,0,0],3));const f=new _e(.0075,.0075,.5,3);function v(e,t){const s=new ke(e,.0075,3,64,t*Math.PI*2);return s.rotateY(Math.PI/2),s.rotateX(Math.PI/2),s}f.translate(0,.25,0);const w={X:[[new x(p,i),[.5,0,0],[0,0,-Math.PI/2]],[new x(p,i),[-.5,0,0],[0,0,Math.PI/2]],[new x(f,i),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new x(p,r),[0,.5,0]],[new x(p,r),[0,-.5,0],[Math.PI,0,0]],[new x(f,r)]],Z:[[new x(p,a),[0,0,.5],[Math.PI/2,0,0]],[new x(p,a),[0,0,-.5],[-Math.PI/2,0,0]],[new x(f,a),null,[Math.PI/2,0,0]]],XYZ:[[new x(new Pe(.1,0),h.clone()),[0,0,0]]],XY:[[new x(new b(.15,.15,.01),c.clone()),[.15,.15,0]]],YZ:[[new x(new b(.15,.15,.01),o.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new x(new b(.15,.15,.01),l.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},S={X:[[new x(new _e(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new x(new _e(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new x(new _e(.2,0,.6,4),s),[0,.3,0]],[new x(new _e(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new x(new _e(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new x(new _e(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new x(new Pe(.2,0),s)]],XY:[[new x(new b(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new x(new b(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new x(new b(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]]},j={START:[[new x(new Pe(.01,2),n),null,null,null,"helper"]],END:[[new x(new Pe(.01,2),n),null,null,null,"helper"]],DELTA:[[new se(function(){const e=new J;return e.setAttribute("position",new Ne([0,0,0,1,1,1],3)),e}(),n),null,null,null,"helper"]],X:[[new se(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new se(g,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new se(g,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},M={XYZE:[[new x(v(.5,1),u),null,[0,Math.PI/2,0]]],X:[[new x(v(.5,.5),i)]],Y:[[new x(v(.5,.5),r),null,[0,0,-Math.PI/2]]],Z:[[new x(v(.5,.5),a),null,[0,Math.PI/2,0]]],E:[[new x(v(.75,1),d),null,[0,Math.PI/2,0]]]},T={AXIS:[[new se(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},C={XYZE:[[new x(new y(.25,10,8),s)]],X:[[new x(new ke(.5,.1,4,24),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new x(new ke(.5,.1,4,24),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new x(new ke(.5,.1,4,24),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new x(new ke(.75,.1,2,24),s)]]},A={X:[[new x(m,i),[.5,0,0],[0,0,-Math.PI/2]],[new x(f,i),[0,0,0],[0,0,-Math.PI/2]],[new x(m,i),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new x(m,r),[0,.5,0]],[new x(f,r)],[new x(m,r),[0,-.5,0],[0,0,Math.PI]]],Z:[[new x(m,a),[0,0,.5],[Math.PI/2,0,0]],[new x(f,a),[0,0,0],[Math.PI/2,0,0]],[new x(m,a),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new x(new b(.15,.15,.01),c),[.15,.15,0]]],YZ:[[new x(new b(.15,.15,.01),o),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new x(new b(.15,.15,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new x(new b(.1,.1,.1),h.clone())]]},E={X:[[new x(new _e(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new x(new _e(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new x(new _e(.2,0,.6,4),s),[0,.3,0]],[new x(new _e(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new x(new _e(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new x(new _e(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new x(new b(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new x(new b(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new x(new b(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new x(new b(.2,.2,.2),s),[0,0,0]]]},O={X:[[new se(g,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new se(g,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new se(g,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function D(e){const t=new z;for(const s in e)for(let n=e[s].length;n--;){const i=e[s][n][0].clone(),r=e[s][n][1],a=e[s][n][2],o=e[s][n][3],l=e[s][n][4];i.name=s,i.tag=l,r&&i.position.set(r[0],r[1],r[2]),a&&i.rotation.set(a[0],a[1],a[2]),o&&i.scale.set(o[0],o[1],o[2]),i.updateMatrix();const c=i.geometry.clone();c.applyMatrix4(i.matrix),i.geometry=c,i.renderOrder=1/0,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=D(w)),this.add(this.gizmo.rotate=D(M)),this.add(this.gizmo.scale=D(A)),this.add(this.picker.translate=D(S)),this.add(this.picker.rotate=D(C)),this.add(this.picker.scale=D(E)),this.add(this.helper.translate=D(j)),this.add(this.helper.rotate=D(T)),this.add(this.helper.scale=D(O)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const t="local"===("scale"===this.mode?"local":this.space)?this.worldQuaternion:mn;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let n=0;n<s.length;n++){const e=s[n];let i;if(e.visible=!0,e.rotation.set(0,0,0),e.position.copy(this.worldPosition),i=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),e.scale.set(1,1,1).multiplyScalar(i*this.size/4),"helper"!==e.tag){if(e.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){const s=.99,n=.2;"X"===e.name&&Math.abs(hn.copy(vn).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"Y"===e.name&&Math.abs(hn.copy(xn).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"Z"===e.name&&Math.abs(hn.copy(bn).applyQuaternion(t).dot(this.eye))>s&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"XY"===e.name&&Math.abs(hn.copy(bn).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"YZ"===e.name&&Math.abs(hn.copy(vn).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),"XZ"===e.name&&Math.abs(hn.copy(xn).applyQuaternion(t).dot(this.eye))<n&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1)}else"rotate"===this.mode&&(pn.copy(t),hn.copy(this.eye).applyQuaternion(Ws.copy(t).invert()),-1!==e.name.search("E")&&e.quaternion.setFromRotationMatrix(un.lookAt(this.eye,dn,xn)),"X"===e.name&&(Ws.setFromAxisAngle(vn,Math.atan2(-hn.y,hn.z)),Ws.multiplyQuaternions(pn,Ws),e.quaternion.copy(Ws)),"Y"===e.name&&(Ws.setFromAxisAngle(xn,Math.atan2(hn.x,hn.z)),Ws.multiplyQuaternions(pn,Ws),e.quaternion.copy(Ws)),"Z"===e.name&&(Ws.setFromAxisAngle(bn,Math.atan2(hn.y,hn.x)),Ws.multiplyQuaternions(pn,Ws),e.quaternion.copy(Ws)));e.visible=e.visible&&(-1===e.name.indexOf("X")||this.showX),e.visible=e.visible&&(-1===e.name.indexOf("Y")||this.showY),e.visible=e.visible&&(-1===e.name.indexOf("Z")||this.showZ),e.visible=e.visible&&(-1===e.name.indexOf("E")||this.showX&&this.showY&&this.showZ),e.material._color=e.material._color||e.material.color.clone(),e.material._opacity=e.material._opacity||e.material.opacity,e.material.color.copy(e.material._color),e.material.opacity=e.material._opacity,this.enabled&&this.axis&&(e.name===this.axis||this.axis.split("").some(function(t){return e.name===t}))&&(e.material.color.setHex(16776960),e.material.opacity=1)}else e.visible=!1,"AXIS"===e.name?(e.visible=!!this.axis,"X"===this.axis&&(Ws.setFromEuler(cn.set(0,0,0)),e.quaternion.copy(t).multiply(Ws),Math.abs(hn.copy(vn).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"Y"===this.axis&&(Ws.setFromEuler(cn.set(0,0,Math.PI/2)),e.quaternion.copy(t).multiply(Ws),Math.abs(hn.copy(xn).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"Z"===this.axis&&(Ws.setFromEuler(cn.set(0,Math.PI/2,0)),e.quaternion.copy(t).multiply(Ws),Math.abs(hn.copy(bn).applyQuaternion(t).dot(this.eye))>.9&&(e.visible=!1)),"XYZE"===this.axis&&(Ws.setFromEuler(cn.set(0,Math.PI/2,0)),hn.copy(this.rotationAxis),e.quaternion.setFromRotationMatrix(un.lookAt(dn,hn,xn)),e.quaternion.multiply(Ws),e.visible=this.dragging),"E"===this.axis&&(e.visible=!1)):"START"===e.name?(e.position.copy(this.worldPositionStart),e.visible=this.dragging):"END"===e.name?(e.position.copy(this.worldPosition),e.visible=this.dragging):"DELTA"===e.name?(e.position.copy(this.worldPositionStart),e.quaternion.copy(this.worldQuaternionStart),Qs.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),Qs.applyQuaternion(this.worldQuaternionStart.clone().invert()),e.scale.copy(Qs),e.visible=this.dragging):(e.quaternion.copy(t),this.dragging?e.position.copy(this.worldPositionStart):e.position.copy(this.worldPosition),this.axis&&(e.visible=-1!==this.axis.search(e.name)))}super.updateMatrixWorld(e)}}class Tn extends x{constructor(){super(new f(1e5,1e5,2,2),new R({visible:!1,wireframe:!0,side:q,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(t="local"),yn.copy(vn).applyQuaternion("local"===t?this.worldQuaternion:mn),wn.copy(xn).applyQuaternion("local"===t?this.worldQuaternion:mn),Sn.copy(bn).applyQuaternion("local"===t?this.worldQuaternion:mn),hn.copy(wn),this.mode){case"translate":case"scale":switch(this.axis){case"X":hn.copy(this.eye).cross(yn),gn.copy(yn).cross(hn);break;case"Y":hn.copy(this.eye).cross(wn),gn.copy(wn).cross(hn);break;case"Z":hn.copy(this.eye).cross(Sn),gn.copy(Sn).cross(hn);break;case"XY":gn.copy(Sn);break;case"YZ":gn.copy(yn);break;case"XZ":hn.copy(Sn),gn.copy(wn);break;case"XYZ":case"E":gn.set(0,0,0)}break;default:gn.set(0,0,0)}0===gn.length()?this.quaternion.copy(this.cameraQuaternion):(fn.lookAt(Qs.set(0,0,0),gn,hn),this.quaternion.setFromRotationMatrix(fn)),super.updateMatrixWorld(e)}}class Cn{constructor(e,t,s,n){this.scene=e,this.camera=t,this.renderer=s,this.editorStore=n,this.selectedObjects=[],this.lastSelectedObject=null,this.selectableObjects=[],this.raycaster=new Re,this.selectionBox=null,this.createSelectionBox(),this.transformControls=null,this.gizmoMode="translate",this.isDragging=!1,this.snapEnabled=!1,this.gridSize=1,this.tempGroup=null,this.tempGroupCenter=new k,this.isMagnetEnabled=!1,this.showMagnetRays=!1,this.rayHelpers=[],this.initialTransformStates=new Map,this.initializeTransformControls()}createTempGroup(){return this.selectedObjects.length<=1?(this.clearTempGroup(),null):(this.clearTempGroup(),this.tempGroup=new re,this.tempGroup.name="TempSelectionGroup",this.tempGroup.userData.isTempGroup=!0,this.calculateGroupCenter(),this.tempGroup.position.copy(this.tempGroupCenter),this.scene.add(this.tempGroup),this.tempGroup)}calculateGroupCenter(){if(0===this.selectedObjects.length)return void this.tempGroupCenter.set(0,0,0);const e=new Ce;this.selectedObjects.forEach(t=>{if(t){const s=(new Ce).setFromObject(t);e.union(s)}}),e.getCenter(this.tempGroupCenter)}clearTempGroup(){this.tempGroup&&(this.scene.remove(this.tempGroup),this.tempGroup=null)}saveInitialTransformStates(){this.initialTransformStates.clear();for(const e of this.selectedObjects)e&&e.position&&e.rotation&&e.scale&&this.initialTransformStates.set(e,{position:e.position.clone(),rotation:e.rotation.clone(),scale:e.scale.clone()});this.tempGroup&&this.selectedObjects.length>1&&this.initialTransformStates.set(this.tempGroup,{position:this.tempGroup.position.clone(),rotation:this.tempGroup.rotation.clone(),scale:this.tempGroup.scale.clone()})}applyTransformToSelectedObjects(){if(!this.tempGroup||!this.transformControls.object||this.selectedObjects.length<=1)return;const e={position:this.tempGroup.position.clone(),rotation:this.tempGroup.rotation.clone(),scale:this.tempGroup.scale.clone()},t=this.initialTransformStates.get(this.tempGroup);if(t)for(const s of this.selectedObjects)if(s){const n=this.initialTransformStates.get(s);n&&this.applyRelativeTransformFromGroup(s,e,t,n)}}applyRelativeTransformFromGroup(e,t,s,n){switch(this.transformControls.getMode()){case"translate":const i=(new k).subVectors(t.position,s.position);e.position.copy(n.position).add(i);break;case"rotate":const r=(new pe).setFromEuler(new Le(s.rotation.x,s.rotation.y,s.rotation.z)),a=(new pe).setFromEuler(new Le(t.rotation.x,t.rotation.y,t.rotation.z)),o=(new pe).multiplyQuaternions(a,r.invert()),l=(new k).subVectors(n.position,s.position);l.applyQuaternion(o),e.position.copy(t.position).add(l);const c=(new pe).setFromEuler(new Le(n.rotation.x,n.rotation.y,n.rotation.z));e.quaternion.multiplyQuaternions(o,c);break;case"scale":const h=new k(t.scale.x/s.scale.x,t.scale.y/s.scale.y,t.scale.z/s.scale.z),d=(new k).subVectors(n.position,s.position);d.multiply(h),e.position.copy(t.position).add(d),e.scale.copy(n.scale).multiply(h)}}applyRelativeTransform(e,t,s,n){switch(this.transformControls.getMode()){case"translate":const i=(new k).subVectors(t.position,s.position);e.position.copy(n.position).add(i);break;case"rotate":const r=new Le(t.rotation.x-s.rotation.x,t.rotation.y-s.rotation.y,t.rotation.z-s.rotation.z);e.rotation.copy(n.rotation),e.rotation.x+=r.x,e.rotation.y+=r.y,e.rotation.z+=r.z;break;case"scale":const a=new k(t.scale.x/s.scale.x,t.scale.y/s.scale.y,t.scale.z/s.scale.z);e.scale.copy(n.scale).multiply(a)}}initializeTransformControls(){try{this.transformControls=new tn(this.camera,this.renderer.domElement),this.transformControls.addEventListener("dragging-changed",e=>{if(this.isDragging=e.value,e.value)this.saveInitialTransformStates();else{if("translate"===this.transformControls.getMode())if(this.selectedObjects.length>1)this.applyMagnetToSelectedObjects();else if(this.lastSelectedObject){const e=this.lastSelectedObject.position.clone(),t=this.snapToMeshSurface(this.lastSelectedObject,e);this.lastSelectedObject.position.copy(t)}this.initialTransformStates.clear()}}),this.transformControls.addEventListener("change",()=>{this.applyTransformToSelectedObjects()}),this.transformControls.setSize(1);const e=this.transformControls.getHelper();e instanceof z&&(e.renderOrder=999,this.scene.add(e))}catch(e){this.transformControls=null}}createSelectionBox(){this.selectionBox=document.createElement("div"),this.selectionBox.style.position="absolute",this.selectionBox.style.border="2px dashed #007acc",this.selectionBox.style.backgroundColor="rgba(0, 122, 204, 0.1)",this.selectionBox.style.pointerEvents="none",this.selectionBox.style.display="none",this.selectionBox.style.zIndex="1000",document.body.appendChild(this.selectionBox)}isObjectValidForSelection(e){if(!e||!e.isMesh&&!e.isGroup||!e.userData||!e.visible)return!1;const t=this.editorStore.getState(),s=t.objects.find(t=>t.id===e.userData.id)||t.walls.find(t=>t.id===e.userData.id);return!s||!s.frozen}selectSingleObject(e){if(e&&this.isObjectValidForSelection(e)){if(this.cleanupSelectedObjects(),this.deselectAllObjects(),this.selectedObjects=[e],this.lastSelectedObject=e,this.editorStore.getState().setSelectedObject(e),this.clearTempGroup(),this.transformControls&&e.parent){let t=!1,s=e;for(;s.parent;)if(s=s.parent,s===this.scene){t=!0;break}t&&(this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}this.addSelectionOutline(e)}}selectMultipleObjects(e,t=!1){if(e&&Array.isArray(e)){t||this.deselectAllObjects();for(const t of e)t&&!this.selectedObjects.includes(t)&&(this.selectedObjects.push(t),this.lastSelectedObject=t);if(this.selectedObjects.length>1){const e=this.createTempGroup();e&&this.transformControls&&e.parent===this.scene&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}else if(1===this.selectedObjects.length){this.clearTempGroup();const e=this.selectedObjects[0];e&&this.transformControls&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}}}toggleObjectSelection(e){if(!e)return;const t=this.selectedObjects.indexOf(e);if(t>-1)if(this.selectedObjects.splice(t,1),this.removeSelectionOutline(e),this.lastSelectedObject===e&&(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null),this.selectedObjects.length>1){const e=this.createTempGroup();e&&this.transformControls&&e.parent===this.scene&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}else if(1===this.selectedObjects.length){this.clearTempGroup();const e=this.selectedObjects[0];e&&this.transformControls&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}else this.clearTempGroup(),this.editorStore.getState().setSelectedObject(null),this.lastSelectedObject=null,this.transformControls&&this.transformControls.detach();else if(this.selectedObjects.push(e),this.lastSelectedObject=e,this.selectedObjects.length>1){const e=this.createTempGroup();e&&this.transformControls&&e.parent===this.scene&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}else this.clearTempGroup(),this.transformControls&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}deselectAllObjects(){if(this.transformControls)try{this.transformControls.detach()}catch(e){}this.clearTempGroup(),this.cleanupSelectedObjects();for(const t of this.selectedObjects)if(t)try{this.removeSelectionOutline(t)}catch(e){}this.selectedObjects=[],this.lastSelectedObject=null,this.editorStore.getState().setSelectedObject(null)}cleanupSelectedObjects(){this.selectedObjects=this.selectedObjects.filter(e=>{const t=this.isObjectValidForSelection(e);if(!t)try{this.removeSelectionOutline(e)}catch(s){}return t}),this.lastSelectedObject&&!this.isObjectValidForSelection(this.lastSelectedObject)&&(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null)}handleObjectSelection(e,t=!1){if(this.transformControls&&this.transformControls.dragging)return;this.raycaster.setFromCamera(e,this.camera);const s=this.raycaster.intersectObjects(this.selectableObjects,!0);if(s.length>0){let e=s[0].object;for(;e.parent&&!this.selectableObjects.includes(e);)e=e.parent;if(!e||!this.selectableObjects.includes(e)||!this.isObjectValidForSelection(e))return;t?this.toggleObjectSelection(e):this.selectSingleObject(e)}else t||this.deselectAllObjects()}getObjectsInArea(e,t){const s=[],n=Math.min(e.x,t.x),i=Math.max(e.x,t.x),r=Math.min(e.y,t.y),a=Math.max(e.y,t.y);for(const o of this.selectableObjects){if(!this.isObjectValidForSelection(o))continue;const e=new k;o.getWorldPosition(e),e.project(this.camera),e.x>=n&&e.x<=i&&e.y>=r&&e.y<=a&&s.push(o)}return s}addSelectionOutline(e){}addSelectionOutlineToGroup(e){}addSelectionOutlineToSingleMesh(e){}removeSelectionOutline(e){e&&(e.isGroup||e.children&&e.children.length>0?this.removeSelectionOutlineFromGroup(e):this.removeSelectionOutlineFromMesh(e))}removeSelectionOutlineFromGroup(e){if(e&&e.traverse){try{e.traverse(t=>{t&&t.isMesh&&t!==e&&this.removeSelectionOutlineFromMesh(t)})}catch(t){}e.userData&&delete e.userData.outlineChildren}}removeSelectionOutlineFromMesh(e){e&&e.userData&&(e.userData.outlineObject&&(e.userData.outlineObject.parent&&e.userData.outlineObject.parent.remove(e.userData.outlineObject),e.userData.outlineObject.geometry&&e.userData.outlineObject.geometry.dispose(),e.userData.outlineObject.material&&e.userData.outlineObject.material.dispose(),delete e.userData.outlineObject),e.material&&void 0!==e.userData.originalEmissive&&(e.material.emissive.copy(e.userData.originalEmissive),e.material.emissiveIntensity=e.userData.originalEmissiveIntensity,delete e.userData.originalEmissive,delete e.userData.originalEmissiveIntensity))}updateSelectionOutline(e){}updateSelectionOutlineForGroup(e){}updateSelectionOutlineForMesh(e){}updateAllSelectionOutlines(){this.cleanupSelectedObjects()}cleanupSelectedObjects(){const e=this.selectedObjects.length;this.selectedObjects=this.selectedObjects.filter(e=>null!=e),this.selectedObjects.length!==e&&(this.selectedObjects.includes(this.lastSelectedObject)||(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null))}setGizmoMode(e){if(!this.transformControls)return;this.gizmoMode=e,this.transformControls.setMode(e);const t=this.editorStore.getState();t.setTransformMode&&t.setTransformMode(e);const s=this.editorStore.getState().selectedObject;s&&!this.transformControls.object&&this.transformControls.attach(s)}setGridSnap(e,t=1){this.transformControls&&(e?(this.transformControls.setTranslationSnap(t),this.transformControls.setRotationSnap(ae.degToRad(15)),this.transformControls.setScaleSnap(.1)):(this.transformControls.setTranslationSnap(null),this.transformControls.setRotationSnap(null),this.transformControls.setScaleSnap(null)))}updateGridSnap(){const e=this.editorStore.getState();this.setGridSnap(e.isGridSnap,e.gridSize)}updateGizmoSpace(){const e=this.editorStore.getState();this.transformControls&&this.transformControls.setSpace(e.gizmoSpace)}updateMagnet(){const e=this.editorStore.getState();this.isMagnetEnabled=e.isMagnetEnabled}updateMagnetRays(){const e=this.editorStore.getState();this.showMagnetRays=e.showMagnetRays,this.showMagnetRays||this.clearRayHelpers()}createRayHelper(e,t,s,n=16711680){const i=(new J).setFromPoints([e,e.clone().add(t.clone().multiplyScalar(s))]),r=new W({color:n}),a=new se(i,r);return a.userData.isRayHelper=!0,a}clearRayHelpers(){this.rayHelpers.forEach(e=>{this.scene.remove(e),e.geometry.dispose(),e.material.dispose()}),this.rayHelpers=[]}isChildOf(e,t){let s=e.parent;for(;s;){if(s===t)return!0;s=s.parent}return!1}snapToMeshSurface(e,t){if(!this.isMagnetEnabled||!e)return t;this.showMagnetRays&&this.clearRayHelpers();const s=new Re,n=new k(0,-1,0),i=(new Ce).setFromObject(e);i.max.y,i.min.y;const r=i.min.y,a=e.position.y-r,o=[];if(this.scene.traverse(t=>{if(t.isMesh&&t.visible&&!t.userData.isRayHelper){if(t===e)return;let s=!1;for(const e of this.selectedObjects)if(t===e||t.parent===e||this.isChildOf(t,e)||this.isChildOf(e,t)){s=!0;break}this.lastSelectedObject&&(t===this.lastSelectedObject||t.parent===this.lastSelectedObject||this.isChildOf(t,this.lastSelectedObject)||this.isChildOf(this.lastSelectedObject,t))&&(s=!0),s||o.push(t)}}),0===o.length)return t;const l=[new k(0,0,0),new k(.5,0,0),new k(-.5,0,0),new k(0,0,.5),new k(0,0,-.5)];let c=null,h=1/0;for(let d=0;d<l.length;d++){const e=l[d],i=new k(t.x+e.x,t.y-a+2,t.z+e.z);s.set(i,n);const r=s.intersectObjects(o,!0);if(this.showMagnetRays){const e=r.length>0?i.distanceTo(r[0].point):10,t=r.length>0?0===d?65280:255:16711680,s=this.createRayHelper(i,n,e,t);if(this.scene.add(s),this.rayHelpers.push(s),r.length>0){const e=new y(.1,8,8),t=new R({color:16776960}),s=new x(e,t);s.position.copy(r[0].point),s.userData.isRayHelper=!0,this.scene.add(s),this.rayHelpers.push(s)}}if(r.length>0){const e=r[0],t=i.distanceTo(e.point);t<h&&(h=t,c=e)}}if(c){return Math.abs(c.point.y-(t.y-a))>20?t:new k(t.x,c.point.y+a,t.z)}return t}applyMagnetToSelectedObjects(){if(this.isMagnetEnabled){if(this.lastSelectedObject){const e=this.lastSelectedObject.position.clone(),t=this.snapToMeshSurface(this.lastSelectedObject,e);this.lastSelectedObject.position.copy(t)}for(const e of this.selectedObjects)if(e&&e!==this.lastSelectedObject){const t=e.position.clone(),s=this.snapToMeshSurface(e,t);e.position.copy(s)}}}updateCamera(e){this.camera=e,this.transformControls&&(this.transformControls.camera=e)}addSelectableObject(e){this.selectableObjects.includes(e)||this.selectableObjects.push(e)}removeSelectableObject(e){const t=this.selectableObjects.indexOf(e);t>-1&&this.selectableObjects.splice(t,1)}updateSelectableObjects(e){this.selectableObjects=[...e]}showSelectionBox(e,t,s,n){this.selectionBox.style.display="block",this.selectionBox.style.left=e+"px",this.selectionBox.style.top=t+"px",this.selectionBox.style.width=s+"px",this.selectionBox.style.height=n+"px"}hideSelectionBox(){this.selectionBox.style.display="none"}getSelectedObjects(){return[...this.selectedObjects]}getSelectableObjects(){return[...this.selectableObjects]}getTransformControls(){return this.transformControls}isDraggingGizmo(){return this.isDragging}dispose(){this.clearRayHelpers(),this.clearTempGroup(),this.transformControls&&(this.transformControls.dispose(),this.scene.remove(this.transformControls)),this.selectionBox&&this.selectionBox.parentNode&&this.selectionBox.parentNode.removeChild(this.selectionBox)}}class An{constructor(e,t,s){this.objectSelector=e,this.editorStore=t,this.keyboardController=s,this.state={mode:"translate",space:"world",snapEnabled:!1,gridSize:1,magnetEnabled:!1,magnetRaysVisible:!1},this.registerKeyboardActions(),this.applyInitialSettings()}registerKeyboardActions(){this.keyboardController&&(this.keyboardController.registerTransformActions({setMode:e=>this.setTransformMode(e),toggleSpace:()=>this.toggleSpace(),toggleSnap:()=>this.toggleGridSnap(),toggleMagnet:()=>this.toggleMagnet(),toggleMagnetRays:()=>this.toggleMagnetRays()}),this.keyboardController.registerRotationActions({rotateX:e=>this.rotateSelectedX(e),rotateY:e=>this.rotateSelectedY(e),rotateZ:e=>this.rotateSelectedZ(e),resetRotation:()=>this.resetSelectedRotation()}),this.keyboardController.registerSelectionActions({deselectAll:()=>this.deselectAll(),selectAll:()=>this.selectAll()}),this.keyboardController.registerObjectActions({deleteSelected:()=>this.deleteSelected(),duplicateSelected:()=>this.duplicateSelected(),groupSelected:()=>this.groupSelected(),ungroupSelected:()=>this.ungroupSelected()}),this.keyboardController.registerSystemActions({undo:()=>this.undo(),redo:()=>this.redo()}))}setTransformMode(e){var t;if(!this.isValidMode(e)||!this.objectSelector)return!1;const s=this.state.mode;return this.state.mode=e,this.objectSelector.setGizmoMode(e),"rotate"===e&&this.setupQuaternionRotation(),(null==(t=this.editorStore)?void 0:t.getState().setTransformMode)&&this.editorStore.getState().setTransformMode(e),this.logStateChange("Transform mode",s,e),!0}toggleSpace(){var e;if(!(null==(e=this.objectSelector)?void 0:e.transformControls))return!1;const t=this.state.space;return this.state.space="world"===this.state.space?"local":"world",this.objectSelector.transformControls.setSpace(this.state.space),this.logStateChange("Coordinate space",t,this.state.space),!0}toggleGridSnap(){return!!this.objectSelector&&(this.state.snapEnabled=!this.state.snapEnabled,this.objectSelector.setGridSnap(this.state.snapEnabled,this.state.gridSize),this.logStateChange("Grid snap",!this.state.snapEnabled,this.state.snapEnabled),!0)}setGridSize(e){if(!this.objectSelector||!this.isValidGridSize(e))return!1;const t=this.state.gridSize;return this.state.gridSize=e,this.state.snapEnabled&&this.objectSelector.setGridSnap(this.state.snapEnabled,this.state.gridSize),this.logStateChange("Grid size",t,e),!0}toggleMagnet(){return!!this.objectSelector&&(this.state.magnetEnabled=!this.state.magnetEnabled,this.objectSelector.isMagnetEnabled=this.state.magnetEnabled,this.logStateChange("Magnet",!this.state.magnetEnabled,this.state.magnetEnabled),!0)}toggleMagnetRays(){return!!this.objectSelector&&(this.state.magnetRaysVisible=!this.state.magnetRaysVisible,this.objectSelector.showMagnetRays=this.state.magnetRaysVisible,!this.state.magnetRaysVisible&&this.objectSelector.clearRayHelpers&&this.objectSelector.clearRayHelpers(),this.logStateChange("Magnet rays",!this.state.magnetRaysVisible,this.state.magnetRaysVisible),!0)}deselectAll(){var e;return!!this.objectSelector&&(null==(e=this.objectSelector.selectedObjects)||e.length,this.objectSelector.deselectAllObjects(),!0)}selectAll(){if(!this.objectSelector)return!1;const e=this.objectSelector.getSelectableObjects();return!!(e&&e.length>0)&&(this.objectSelector.selectMultipleObjects(e),!0)}deleteSelected(){if(!this.objectSelector||!this.hasSelectedObjects())return!1;const e=[...this.objectSelector.selectedObjects];return this.deselectAll(),e.forEach(e=>{this.removeObjectFromScene(e)}),!0}duplicateSelected(){if(!this.objectSelector||!this.hasSelectedObjects())return!1;const e=[...this.objectSelector.selectedObjects],t=[];return e.forEach(e=>{const s=this.cloneObject(e);s&&t.push(s)}),t.length>0&&this.selectObjects(t),t}groupSelected(){var e;if(!this.objectSelector||(null==(e=this.objectSelector.selectedObjects)?void 0:e.length)<2)return!1;const t=[...this.objectSelector.selectedObjects],s=this.createGroup(t);return!!s&&(this.selectObjects([s]),s)}ungroupSelected(){var e;if(!this.objectSelector||1!==(null==(e=this.objectSelector.selectedObjects)?void 0:e.length))return!1;const t=this.objectSelector.selectedObjects[0];if(!this.isGroup(t))return!1;const s=this.ungroupObject(t);return s.length>0&&(this.selectObjects(s),s)}applyInitialSettings(){this.objectSelector&&(this.objectSelector.setGizmoMode(this.state.mode),this.objectSelector.setGridSnap(this.state.snapEnabled,this.state.gridSize),this.objectSelector.isMagnetEnabled=this.state.magnetEnabled,this.objectSelector.showMagnetRays=this.state.magnetRaysVisible,this.objectSelector.transformControls&&(this.objectSelector.transformControls.setSpace(this.state.space),this.setupQuaternionRotation()))}setupQuaternionRotation(){var e;if(!(null==(e=this.objectSelector)?void 0:e.transformControls))return;const t=this.objectSelector.transformControls;"rotate"===this.state.mode&&(t.rotationSnap=Math.PI/12,this.setupRotationEventListeners())}setupRotationEventListeners(){var e;if(!(null==(e=this.objectSelector)?void 0:e.transformControls))return;const t=this.objectSelector.transformControls;t.addEventListener("objectChange",()=>{"rotate"===t.getMode()&&this.hasSelectedObjects()&&this.onQuaternionRotationChange()})}onQuaternionRotationChange(){const e=this.objectSelector.selectedObjects;if(e.forEach((e,t)=>{e.quaternion.normalize(),e.updateMatrix(),e.updateMatrixWorld()}),e.length>0){this.getSelectedObjectRotation(e[0])}}updateObjectSelector(e){this.objectSelector=e,this.applyInitialSettings()}getState(){var e,t;return{...this.state,selectedObjectsCount:(null==(t=null==(e=this.objectSelector)?void 0:e.selectedObjects)?void 0:t.length)||0,hasSelection:this.hasSelectedObjects()}}applySettings(e){e.mode&&e.mode!==this.state.mode&&this.setTransformMode(e.mode),e.space&&e.space!==this.state.space&&this.toggleSpace(),void 0!==e.snapEnabled&&e.snapEnabled!==this.state.snapEnabled&&this.toggleGridSnap(),e.gridSize&&e.gridSize!==this.state.gridSize&&this.setGridSize(e.gridSize),void 0!==e.magnetEnabled&&e.magnetEnabled!==this.state.magnetEnabled&&this.toggleMagnet(),void 0!==e.magnetRaysVisible&&e.magnetRaysVisible!==this.state.magnetRaysVisible&&this.toggleMagnetRays()}rotateSelectedObjects(e){if(!this.hasSelectedObjects())return!1;return this.objectSelector.selectedObjects.forEach(t=>{this.applyQuaternionRotation(t,e)}),!0}applyQuaternionRotation(e,t){e&&(e.quaternion.multiplyQuaternions(t,e.quaternion),e.updateMatrix())}rotateSelectedX(e){const t=ae.degToRad(e),s=(new pe).setFromAxisAngle(new k(1,0,0),t);return this.rotateSelectedObjects(s)}rotateSelectedY(e){const t=ae.degToRad(e),s=(new pe).setFromAxisAngle(new k(0,1,0),t);return this.rotateSelectedObjects(s)}rotateSelectedZ(e){const t=ae.degToRad(e),s=(new pe).setFromAxisAngle(new k(0,0,1),t);return this.rotateSelectedObjects(s)}rotateSelectedAroundAxis(e,t){if(!e||0===e.length())return!1;const s=e.clone().normalize(),n=ae.degToRad(t),i=(new pe).setFromAxisAngle(s,n);return this.rotateSelectedObjects(i)}rotateSelectedByEuler(e,t,s,n="XYZ"){const i=new Le(ae.degToRad(e),ae.degToRad(t),ae.degToRad(s),n),r=(new pe).setFromEuler(i);return this.rotateSelectedObjects(r)}rotateSelectedToLookAt(e){if(!this.hasSelectedObjects()||!e)return!1;return this.objectSelector.selectedObjects.forEach(t=>{(new k).subVectors(e,t.position).normalize();const s=new P;s.lookAt(t.position,e,new k(0,1,0));const n=(new pe).setFromRotationMatrix(s);t.quaternion.copy(n),t.updateMatrix()}),!0}resetSelectedRotation(){if(!this.hasSelectedObjects())return!1;return this.objectSelector.selectedObjects.forEach(e=>{e.quaternion.set(0,0,0,1),e.updateMatrix()}),!0}getSelectedObjectRotation(e=null){const t=e||this.objectSelector.selectedObjects[0];if(!t)return null;const s=(new Le).setFromQuaternion(t.quaternion,"XYZ");return{x:ae.radToDeg(s.x),y:ae.radToDeg(s.y),z:ae.radToDeg(s.z),quaternion:t.quaternion.clone()}}rotateSelectedInWorldSpace(e){if(!this.hasSelectedObjects())return!1;return this.objectSelector.selectedObjects.forEach(t=>{const s=new pe;if(t.getWorldQuaternion(s),s.premultiply(e),t.parent){const e=new pe;t.parent.getWorldQuaternion(e),e.invert(),t.quaternion.multiplyQuaternions(e,s)}else t.quaternion.copy(s);t.updateMatrix()}),!0}rotateSelectedAroundPoint(e,t){if(!this.hasSelectedObjects()||!e)return!1;return this.objectSelector.selectedObjects.forEach(s=>{const n=s.position.clone().sub(e);n.applyQuaternion(t),s.position.copy(e).add(n),s.quaternion.multiplyQuaternions(t,s.quaternion),s.updateMatrix()}),!0}isValidMode(e){return["translate","rotate","scale"].includes(e)}isValidGridSize(e){return"number"==typeof e&&e>0&&e<=100}hasSelectedObjects(){var e,t;return(null==(t=null==(e=this.objectSelector)?void 0:e.selectedObjects)?void 0:t.length)>0}isGroup(e){var t;return!0===(null==(t=null==e?void 0:e.userData)?void 0:t.isGroup)||"Group"===(null==e?void 0:e.type)}removeObjectFromScene(e){e&&e.parent&&(e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))}cloneObject(e){if(!e)return null;const t=e.clone();return t.position.x+=1,t.position.z+=1,t.userData={...e.userData,id:`${e.userData.id}_copy_${Date.now()}`},e.parent.add(t),this.objectSelector.addSelectableObject&&this.objectSelector.addSelectableObject(t),t}createGroup(e){if(!e||e.length<2)return null;const t=new re;t.name=`Group_${Date.now()}`,t.userData={id:`group_${Date.now()}`,type:"group",isGroup:!0};return e[0].parent.add(t),e.forEach(e=>{if(e&&e.parent){const s=e.matrixWorld.clone();t.add(e),e.matrix.copy(s),e.matrix.premultiply(t.matrixWorld.clone().invert()),e.matrix.decompose(e.position,e.quaternion,e.scale)}}),this.objectSelector.addSelectableObject&&this.objectSelector.addSelectableObject(t),t}ungroupObject(e){if(!this.isGroup(e))return[];const t=[...e.children],s=e.parent;return t.forEach(e=>{if(e){const t=e.matrixWorld.clone();s.add(e),e.matrix.copy(t),e.matrix.premultiply(s.matrixWorld.clone().invert()),e.matrix.decompose(e.position,e.quaternion,e.scale),this.objectSelector.addSelectableObject&&this.objectSelector.addSelectableObject(e)}}),this.objectSelector.removeSelectableObject&&this.objectSelector.removeSelectableObject(e),s.remove(e),t}selectObjects(e){this.objectSelector&&e&&0!==e.length&&(this.objectSelector.deselectAllObjects(),1===e.length?this.objectSelector.selectSingleObject(e[0]):this.objectSelector.selectMultipleObjects(e))}logStateChange(e,t,s){}undo(){}redo(){}dispose(){this.objectSelector=null,this.editorStore=null,this.keyboardController=null}}class En{constructor(){this.isEnabled=!0,this.pressedKeys=new Set,this.mouseState={isDown:!1,button:-1,position:{x:0,y:0},previousPosition:{x:0,y:0},dragStart:{x:0,y:0}},this.handlers={keyboard:new Map,mouse:new Map,wheel:null,contextMenu:null,resize:null},this.modifierKeys={ctrl:!1,shift:!1,alt:!1,meta:!1},this.boundHandlers={keyDown:this.handleKeyDown.bind(this),keyUp:this.handleKeyUp.bind(this),mouseDown:this.handleMouseDown.bind(this),mouseMove:this.handleMouseMove.bind(this),mouseUp:this.handleMouseUp.bind(this),wheel:this.handleWheel.bind(this),contextMenu:this.handleContextMenu.bind(this),resize:this.handleResize.bind(this)},this.setupEventListeners()}setupEventListeners(){document.addEventListener("keydown",this.boundHandlers.keyDown),document.addEventListener("keyup",this.boundHandlers.keyUp),window.addEventListener("resize",this.boundHandlers.resize)}setupMouseEvents(e){this.canvas=e,e.addEventListener("mousedown",this.boundHandlers.mouseDown),document.addEventListener("mousemove",this.boundHandlers.mouseMove),document.addEventListener("mouseup",this.boundHandlers.mouseUp),e.addEventListener("wheel",this.boundHandlers.wheel),e.addEventListener("contextmenu",this.boundHandlers.contextMenu)}handleKeyDown(e){if(!this.isEnabled||this.isInputFieldActive(e.target))return;this.updateModifierKeys(e),this.pressedKeys.add(e.code);const t={code:e.code,key:e.key,ctrl:this.modifierKeys.ctrl,shift:this.modifierKeys.shift,alt:this.modifierKeys.alt,meta:this.modifierKeys.meta,originalEvent:e};this.modifierKeys.ctrl||this.modifierKeys.meta?this.executeHandler("keyboard","ctrl",t):this.executeHandler("keyboard",e.code,t)}handleKeyUp(e){if(!this.isEnabled)return;this.updateModifierKeys(e),this.pressedKeys.delete(e.code);const t={code:e.code,key:e.key,ctrl:this.modifierKeys.ctrl,shift:this.modifierKeys.shift,alt:this.modifierKeys.alt,meta:this.modifierKeys.meta,originalEvent:e};this.executeHandler("keyboard","keyup",t)}handleMouseDown(e){if(!this.isEnabled)return;this.mouseState.isDown=!0,this.mouseState.button=e.button,this.updateMousePosition(e),this.mouseState.previousPosition={...this.mouseState.position},this.mouseState.dragStart={...this.mouseState.position};const t={button:e.button,position:{...this.mouseState.position},ctrl:e.ctrlKey,shift:e.shiftKey,alt:e.altKey,meta:e.metaKey,originalEvent:e};this.executeHandler("mouse","mousedown",t)}handleMouseMove(e){if(!this.isEnabled)return;this.mouseState.previousPosition={...this.mouseState.position},this.updateMousePosition(e);const t={position:{...this.mouseState.position},previousPosition:{...this.mouseState.previousPosition},dragStart:{...this.mouseState.dragStart},isDown:this.mouseState.isDown,button:this.mouseState.button,delta:{x:this.mouseState.position.x-this.mouseState.previousPosition.x,y:this.mouseState.position.y-this.mouseState.previousPosition.y},originalEvent:e};this.executeHandler("mouse","mousemove",t)}handleMouseUp(e){if(!this.isEnabled)return;const t={button:e.button,position:{...this.mouseState.position},dragStart:{...this.mouseState.dragStart},originalEvent:e};this.executeHandler("mouse","mouseup",t),this.mouseState.isDown=!1,this.mouseState.button=-1}handleWheel(e){if(!this.isEnabled)return;e.preventDefault();const t={delta:e.deltaY,position:{...this.mouseState.position},ctrl:e.ctrlKey,shift:e.shiftKey,alt:e.altKey,originalEvent:e};this.handlers.wheel&&this.handlers.wheel(t)}handleContextMenu(e){e.preventDefault(),this.handlers.contextMenu&&this.handlers.contextMenu(e)}handleResize(e){this.handlers.resize&&this.handlers.resize(e)}updateMousePosition(e){if(!this.canvas)return;const t=this.canvas.getBoundingClientRect();this.mouseState.position={x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,screenX:e.clientX,screenY:e.clientY}}updateModifierKeys(e){this.modifierKeys.ctrl=e.ctrlKey,this.modifierKeys.shift=e.shiftKey,this.modifierKeys.alt=e.altKey,this.modifierKeys.meta=e.metaKey}executeHandler(e,t,s){var n;if("keyboard"===e){const e=this.handlers.keyboard.get("default");if(e)try{e(s)}catch(i){}}else{const r=null==(n=this.handlers[e])?void 0:n.get(t);if(r)try{r(s)}catch(i){}}}isInputFieldActive(e){return["INPUT","TEXTAREA","SELECT"].includes(e.tagName)||"true"===e.contentEditable}registerKeyHandler(e,t){this.handlers.keyboard.has(e)||this.handlers.keyboard.set(e,t)}registerMouseHandler(e,t){this.handlers.mouse.has(e)||this.handlers.mouse.set(e,t)}registerWheelHandler(e){this.handlers.wheel=e}registerContextMenuHandler(e){this.handlers.contextMenu=e}registerResizeHandler(e){this.handlers.resize=e}unregisterHandler(e,t){var s;"wheel"===e?this.handlers.wheel=null:"contextMenu"===e?this.handlers.contextMenu=null:null==(s=this.handlers[e])||s.delete(t)}clearAllHandlers(){this.handlers.keyboard.clear(),this.handlers.mouse.clear(),this.handlers.wheel=null,this.handlers.contextMenu=null}setEnabled(e){this.isEnabled=e}isKeyPressed(e){return this.pressedKeys.has(e)}getModifierKeys(){return{...this.modifierKeys}}getMouseState(){return{...this.mouseState}}getInputState(){return{enabled:this.isEnabled,pressedKeys:Array.from(this.pressedKeys),modifierKeys:this.getModifierKeys(),mouseState:this.getMouseState()}}dispose(){document.removeEventListener("keydown",this.boundHandlers.keyDown),document.removeEventListener("keyup",this.boundHandlers.keyUp),this.canvas&&(this.canvas.removeEventListener("mousedown",this.boundHandlers.mouseDown),this.canvas.removeEventListener("wheel",this.boundHandlers.wheel),this.canvas.removeEventListener("contextmenu",this.boundHandlers.contextMenu)),document.removeEventListener("mousemove",this.boundHandlers.mouseMove),document.removeEventListener("mouseup",this.boundHandlers.mouseUp),window.removeEventListener("resize",this.boundHandlers.resize),this.clearAllHandlers(),this.canvas=null,this.boundHandlers=null,this.pressedKeys.clear()}}class On{constructor(e){this.inputManager=e,this.actions={transform:new Map,rotation:new Map,selection:new Map,viewport:new Map,object:new Map,system:new Map},this.setupDefaultKeyMappings(),this.registerInputHandlers()}setupDefaultKeyMappings(){this.actions.transform.set("KeyW",{name:"Move Mode",description:"이동 모드",action:null,category:"transform"}),this.actions.transform.set("KeyE",{name:"Rotate Mode",description:"회전 모드",action:null,category:"transform"}),this.actions.transform.set("KeyR",{name:"Scale Mode",description:"크기 모드",action:null,category:"transform"}),this.actions.transform.set("KeyQ",{name:"Toggle Space",description:"좌표계 전환",action:null,category:"transform"}),this.actions.transform.set("KeyX",{name:"Toggle Snap",description:"그리드 스냅 토글",action:null,category:"transform"}),this.actions.transform.set("KeyV",{name:"Toggle Magnet",description:"자석 기능 토글",action:null,category:"transform"}),this.actions.transform.set("KeyC",{name:"Toggle Magnet Rays",description:"자석 레이 표시",action:null,category:"transform"}),this.actions.rotation.set("KeyJ",{name:"Rotate X+",description:"X축 양의 방향 15도 회전",action:null,category:"rotation"}),this.actions.rotation.set("KeyL",{name:"Rotate X-",description:"X축 음의 방향 15도 회전",action:null,category:"rotation"}),this.actions.rotation.set("KeyI",{name:"Rotate Y+",description:"Y축 양의 방향 15도 회전",action:null,category:"rotation"}),this.actions.rotation.set("KeyK",{name:"Rotate Y-",description:"Y축 음의 방향 15도 회전",action:null,category:"rotation"}),this.actions.rotation.set("KeyU",{name:"Rotate Z+",description:"Z축 양의 방향 15도 회전",action:null,category:"rotation"}),this.actions.rotation.set("KeyO",{name:"Rotate Z-",description:"Z축 음의 방향 15도 회전",action:null,category:"rotation"}),this.actions.rotation.set("KeyP",{name:"Reset Rotation",description:"회전 초기화",action:null,category:"rotation"}),this.actions.selection.set("Escape",{name:"Deselect All",description:"모든 선택 해제",action:null,category:"selection"}),this.actions.selection.set("KeyA",{name:"Select All",description:"전체 선택",action:null,category:"selection",requiresCtrl:!0}),this.actions.object.set("Delete",{name:"Delete Objects",description:"선택된 오브젝트 삭제",action:null,category:"object"}),this.actions.object.set("Backspace",{name:"Delete Objects",description:"선택된 오브젝트 삭제",action:null,category:"object"}),this.actions.object.set("KeyD",{name:"Duplicate Objects",description:"오브젝트 복제",action:null,category:"object",requiresCtrl:!0}),this.actions.object.set("KeyG",{name:"Group Objects",description:"오브젝트 그룹화",action:null,category:"object",requiresCtrl:!0}),this.actions.viewport.set("KeyF",{name:"Focus on Object",description:"선택된 오브젝트로 포커스",action:null,category:"viewport"}),this.actions.viewport.set("Numpad5",{name:"Toggle Projection",description:"투영 모드 전환",action:null,category:"viewport"}),this.actions.viewport.set("Numpad1",{name:"Front View",description:"정면 뷰",action:null,category:"viewport"}),this.actions.viewport.set("Numpad3",{name:"Side View",description:"측면 뷰",action:null,category:"viewport"}),this.actions.viewport.set("Numpad7",{name:"Top View",description:"상단 뷰",action:null,category:"viewport"}),this.actions.viewport.set("Numpad0",{name:"Reset Camera",description:"카메라 리셋",action:null,category:"viewport"}),this.actions.system.set("KeyZ",{name:"Undo",description:"실행 취소",action:null,category:"system",requiresCtrl:!0}),this.actions.system.set("KeyS",{name:"Save",description:"저장",action:null,category:"system",requiresCtrl:!0})}registerInputHandlers(){this.inputManager.registerKeyHandler("default",this.handleKeyInput.bind(this))}handleKeyInput(e){const{code:t,ctrl:s,shift:n,originalEvent:i}=e;s?this.handleCtrlKeyPress(e):this.handleKeyPress(e)}handleKeyPress(e){const{code:t,ctrl:s,shift:n,originalEvent:i}=e;if(s)return;const r=this.findAction(t);r&&r.action&&!r.requiresCtrl&&(i.preventDefault(),this.executeAction(r,e))}handleCtrlKeyPress(e){const{code:t,shift:s,originalEvent:n}=e,i=this.findAction(t);i&&i.action&&i.requiresCtrl&&(n.preventDefault(),s&&"KeyG"===t?this.executeSpecialAction("ungroupObjects",e):s&&"KeyZ"===t?this.executeSpecialAction("redo",e):this.executeAction(i,e))}findAction(e){for(const[t,s]of Object.entries(this.actions))if(s.has(e))return s.get(e);return null}executeAction(e,t){if("function"==typeof e.action)try{e.action(t)}catch(s){}}executeSpecialAction(e,t){var s,n;const i={ungroupObjects:null==(s=this.actions.object.get("KeyG"))?void 0:s.ungroupAction,redo:null==(n=this.actions.system.get("KeyZ"))?void 0:n.redoAction}[e];if("function"==typeof i)try{i(t)}catch(r){}}registerTransformActions(e){e.setMode&&(this.actions.transform.get("KeyW").action=()=>e.setMode("translate"),this.actions.transform.get("KeyE").action=()=>e.setMode("rotate"),this.actions.transform.get("KeyR").action=()=>e.setMode("scale")),e.toggleSpace&&(this.actions.transform.get("KeyQ").action=e.toggleSpace),e.toggleSnap&&(this.actions.transform.get("KeyX").action=e.toggleSnap),e.toggleMagnet&&(this.actions.transform.get("KeyV").action=e.toggleMagnet),e.toggleMagnetRays&&(this.actions.transform.get("KeyC").action=e.toggleMagnetRays)}registerRotationActions(e){e.rotateX&&(this.actions.rotation.get("KeyJ").action=()=>e.rotateX(15),this.actions.rotation.get("KeyL").action=()=>e.rotateX(-15)),e.rotateY&&(this.actions.rotation.get("KeyI").action=()=>e.rotateY(15),this.actions.rotation.get("KeyK").action=()=>e.rotateY(-15)),e.rotateZ&&(this.actions.rotation.get("KeyU").action=()=>e.rotateZ(15),this.actions.rotation.get("KeyO").action=()=>e.rotateZ(-15)),e.resetRotation&&(this.actions.rotation.get("KeyP").action=e.resetRotation)}registerSelectionActions(e){e.deselectAll&&(this.actions.selection.get("Escape").action=e.deselectAll),e.selectAll&&(this.actions.selection.get("KeyA").action=e.selectAll)}registerObjectActions(e){e.deleteSelected&&(this.actions.object.get("Delete").action=e.deleteSelected,this.actions.object.get("Backspace").action=e.deleteSelected),e.duplicateSelected&&(this.actions.object.get("KeyD").action=e.duplicateSelected),e.groupSelected&&(this.actions.object.get("KeyG").action=e.groupSelected),e.ungroupSelected&&(this.actions.object.get("KeyG").ungroupAction=e.ungroupSelected)}registerViewportActions(e){e.focusOnSelected&&(this.actions.viewport.get("KeyF").action=e.focusOnSelected),e.toggleProjection&&(this.actions.viewport.get("Numpad5").action=e.toggleProjection),e.setView&&(this.actions.viewport.get("Numpad1").action=()=>e.setView("front"),this.actions.viewport.get("Numpad3").action=()=>e.setView("side"),this.actions.viewport.get("Numpad7").action=()=>e.setView("top")),e.resetCamera&&(this.actions.viewport.get("Numpad0").action=e.resetCamera)}registerSystemActions(e){e.undo&&(this.actions.system.get("KeyZ").action=e.undo),e.redo&&(this.actions.system.get("KeyZ").redoAction=e.redo),e.save&&(this.actions.system.get("KeyS").action=e.save)}registerCustomKey(e,t,s,n,i="custom",r=!1){this.actions[i]||(this.actions[i]=new Map),this.actions[i].set(e,{name:t,description:s,action:n,category:i,requiresCtrl:r})}unregisterKey(e,t=null){if(t&&this.actions[t])this.actions[t].delete(e);else for(const s of Object.values(this.actions))if(s.has(e)){s.delete(e);break}}getKeyMappings(){const e={};for(const[t,s]of Object.entries(this.actions)){e[t]={};for(const[n,i]of s.entries())e[t][n]={name:i.name,description:i.description,requiresCtrl:i.requiresCtrl||!1}}return e}checkKeyConflicts(){const e=new Map,t=[];for(const[s,n]of Object.entries(this.actions))for(const[i,r]of n.entries()){const n=`${i}${r.requiresCtrl?"+Ctrl":""}`;e.has(n)?t.push({key:n,conflicting:[e.get(n),`${s}:${r.name}`]}):e.set(n,`${s}:${r.name}`)}return t.length,t}generateHelpText(){let e="Keyboard Shortcuts:\n\n";for(const[t,s]of Object.entries(this.actions))if(0!==s.size){e+=`${t.toUpperCase()}:\n`;for(const[t,n]of s.entries()){e+=`  ${this.formatKeyName(t,n.requiresCtrl).padEnd(20)} - ${n.description}\n`}e+="\n"}return e}formatKeyName(e,t=!1){const s={KeyW:"W",KeyE:"E",KeyR:"R",KeyQ:"Q",KeyX:"X",KeyV:"V",KeyC:"C",KeyA:"A",KeyD:"D",KeyG:"G",KeyF:"F",KeyZ:"Z",KeyS:"S",Escape:"ESC",Delete:"DEL",Backspace:"BACKSPACE",Numpad1:"NUM1",Numpad3:"NUM3",Numpad5:"NUM5",Numpad7:"NUM7",Numpad0:"NUM0"}[e]||e;return t?`Ctrl+${s}`:s}setEnabled(e){this.inputManager.setEnabled(e)}dispose(){for(const e of Object.values(this.actions))e.clear()}}class Rn{constructor(e){this.inputManager=e,this.transformControls=null,this.objectSelector=null,this.state={isDragging:!1,dragButton:-1,dragThreshold:5,isSelecting:!1,isPanning:!1,isOrbiting:!1,isGizmoInteracting:!1},this.handlers={leftClick:null,rightClick:null,middleClick:null,leftDrag:null,rightDrag:null,middleDrag:null,dragSelect:null,wheel:null,hover:null},this.selectionBox={element:null,startX:0,startY:0,isVisible:!1},this.registerInputHandlers()}registerInputHandlers(){this.inputManager.registerMouseHandler("mousedown",this.handleMouseDown.bind(this)),this.inputManager.registerMouseHandler("mousemove",this.handleMouseMove.bind(this)),this.inputManager.registerMouseHandler("mouseup",this.handleMouseUp.bind(this)),this.inputManager.registerWheelHandler(this.handleWheel.bind(this))}setTransformControls(e){this.transformControls=e,this.setupGizmoEventListeners()}setObjectSelector(e){this.objectSelector=e,e&&e.transformControls&&this.setTransformControls(e.transformControls)}setupGizmoEventListeners(){this.transformControls&&this.transformControls.addEventListener("dragging-changed",e=>{this.state.isGizmoInteracting=e.value})}isGizmoInteracting(){return this.state.isGizmoInteracting||this.transformControls&&this.transformControls.dragging}handleMouseDown(e){const{button:t,position:s,ctrl:n,shift:i,alt:r,originalEvent:a}=e;if(!this.isGizmoInteracting())switch(this.state.dragButton=t,t){case 0:this.handleLeftMouseDown(e);break;case 1:this.handleMiddleMouseDown(e);break;case 2:this.handleRightMouseDown(e)}}handleLeftMouseDown(e){const{position:t,ctrl:s,shift:n}=e,i=s||n;this.state.isSelecting=!0,this.selectionBox.startX=t.screenX,this.selectionBox.startY=t.screenY,this.handlers.leftClick&&this.handlers.leftClick({position:t,isMultiSelect:i,originalEvent:e.originalEvent})}handleMiddleMouseDown(e){const{alt:t,originalEvent:s}=e;s.preventDefault(),t?this.state.isOrbiting=!0:this.state.isPanning=!0,this.handlers.middleClick&&this.handlers.middleClick({isOrbiting:this.state.isOrbiting,isPanning:this.state.isPanning,originalEvent:s})}handleRightMouseDown(e){this.handlers.rightClick&&this.handlers.rightClick(e)}handleMouseMove(e){const{position:t,isDown:s,button:n,delta:i}=e;if((!this.isGizmoInteracting()||!s)&&(!s&&this.handlers.hover&&this.handlers.hover({position:t}),s)){if(!this.state.isDragging){this.calculateDragDistance(e)>this.state.dragThreshold&&(this.state.isDragging=!0,this.onDragStart(e))}this.state.isDragging&&this.handleDragMove(e),this.state.isSelecting&&0===n&&this.updateSelectionBox(e)}}onDragStart(e){}handleDragMove(e){const{button:t,delta:s}=e;switch(t){case 0:this.handlers.leftDrag&&this.handlers.leftDrag({delta:s,mouseInfo:e});break;case 1:this.state.isPanning&&this.handlers.middleDrag?this.handlers.middleDrag({type:"pan",delta:s,mouseInfo:e}):this.state.isOrbiting&&this.handlers.middleDrag&&this.handlers.middleDrag({type:"orbit",delta:s,mouseInfo:e});break;case 2:this.handlers.rightDrag&&this.handlers.rightDrag({delta:s,mouseInfo:e})}}handleMouseUp(e){const{button:t,position:s}=e;this.isGizmoInteracting()||(this.state.isSelecting&&0===t&&this.finishDragSelection(e),this.state.isDragging?this.handleDragEnd(e):this.handleClick(e)),this.resetMouseState()}handleClick(e){}handleDragEnd(e){this.state.isPanning&&this.handlers.dragEnd&&this.handlers.dragEnd({type:"pan",mouseInfo:e})}handleWheel(e){this.handlers.wheel&&this.handlers.wheel(e)}calculateDragDistance(e){const{position:t,dragStart:s}=e,n=t.screenX-s.screenX,i=t.screenY-s.screenY;return Math.sqrt(n*n+i*i)}updateSelectionBox(e){const{position:t}=e,s=t.screenX,n=t.screenY,i=Math.min(this.selectionBox.startX,s),r=Math.min(this.selectionBox.startY,n),a=Math.abs(s-this.selectionBox.startX),o=Math.abs(n-this.selectionBox.startY);(a>this.state.dragThreshold||o>this.state.dragThreshold)&&(this.showSelectionBox(i,r,a,o),this.handlers.dragSelect&&this.handlers.dragSelect({startX:this.selectionBox.startX,startY:this.selectionBox.startY,currentX:s,currentY:n,left:i,top:r,width:a,height:o}))}finishDragSelection(e){const{position:t,ctrl:s,shift:n}=e,i=this.calculateDragDistance(e),r=s||n;this.hideSelectionBox(),i<this.state.dragThreshold||this.handlers.dragSelectEnd&&this.handlers.dragSelectEnd({startX:this.selectionBox.startX,startY:this.selectionBox.startY,endX:t.screenX,endY:t.screenY,isMultiSelect:r})}showSelectionBox(e,t,s,n){this.selectionBox.element||this.createSelectionBoxElement();const i=this.selectionBox.element;i.style.left=`${e}px`,i.style.top=`${t}px`,i.style.width=`${s}px`,i.style.height=`${n}px`,i.style.display="block",this.selectionBox.isVisible=!0}hideSelectionBox(){this.selectionBox.element&&(this.selectionBox.element.style.display="none"),this.selectionBox.isVisible=!1}createSelectionBoxElement(){const e=document.createElement("div");e.style.position="fixed",e.style.border="1px dashed #007acc",e.style.backgroundColor="rgba(0, 122, 204, 0.1)",e.style.pointerEvents="none",e.style.zIndex="10000",e.style.display="none",document.body.appendChild(e),this.selectionBox.element=e}resetMouseState(){this.state.isDragging=!1,this.state.dragButton=-1,this.state.isSelecting=!1,this.state.isPanning=!1,this.state.isOrbiting=!1}onLeftClick(e){this.handlers.leftClick=e}onRightClick(e){this.handlers.rightClick=e}onMiddleClick(e){this.handlers.middleClick=e}onLeftDrag(e){this.handlers.leftDrag=e}onMiddleDrag(e){this.handlers.middleDrag=e}onRightDrag(e){this.handlers.rightDrag=e}onDragSelect(e){this.handlers.dragSelect=e}onDragSelectEnd(e){this.handlers.dragSelectEnd=e}onWheel(e){this.handlers.wheel=e}onHover(e){this.handlers.hover=e}onDragEnd(e){this.handlers.dragEnd=e}setDragThreshold(e){this.state.dragThreshold=Math.max(1,e)}getMouseState(){return{...this.state}}getSelectionBoxState(){return{...this.selectionBox}}removeHandler(e){this.handlers.hasOwnProperty(e)&&(this.handlers[e]=null)}removeAllHandlers(){for(const e in this.handlers)this.handlers[e]=null}dispose(){this.selectionBox.element&&(document.body.removeChild(this.selectionBox.element),this.selectionBox.element=null),this.removeAllHandlers(),this.resetMouseState(),this.transformControls=null,this.objectSelector=null}}class Dn{constructor(e,t,s,n,i=null){this.scene=e,this.renderer=s,this.editorStore=n,this.inputManager=new En,this.keyboardController=new On(this.inputManager),this.mouseController=new Rn(this.inputManager),this.cameraController=new Ks(t,s,i),this.objectSelector=new Cn(e,t,s,n),this.mouseController.setObjectSelector(this.objectSelector),this.transformManager=new An(this.objectSelector,n,this.keyboardController),this.initializeGrid(),this.inputManager.setupMouseEvents(s.domElement),this.inputManager.registerResizeHandler(this.onWindowResize.bind(this)),this.setupMouseHandlers(),this.setupViewportActions(),this.isMouseDown=!1,this.isPanning=!1,this.isOrbiting=!1,this.isDragSelecting=!1,this.mousePosition=new N,this.previousMousePosition=new N,this.dragStartPosition=new N}setupMouseHandlers(){this.mouseController.onLeftClick(e=>{const{position:t,isMultiSelect:s}=e;this.updateMousePosition(t),this.objectSelector.isDraggingGizmo()||this.objectSelector.handleObjectSelection(this.mousePosition,s)}),this.mouseController.onMiddleClick(e=>{const{isOrbiting:t,isPanning:s}=e;this.isOrbiting=t,this.isPanning=s}),this.mouseController.onMiddleDrag(e=>{const{type:t,delta:s}=e;"pan"===t?this.cameraController.pan(s.x,s.y):"orbit"===t&&this.cameraController.orbit(s.x,s.y)}),this.mouseController.onDragSelect(e=>{const{left:t,top:s,width:n,height:i}=e;this.objectSelector.showSelectionBox(t,s,n,i)}),this.mouseController.onDragSelectEnd(e=>{const{startX:t,startY:s,endX:n,endY:i,isMultiSelect:r}=e;this.finishDragSelection(t,s,n,i,r)}),this.mouseController.onWheel(e=>{if(this.objectSelector.isDraggingGizmo())return;const t=e.delta>0?1:-1;this.cameraController.zoom(.3*t)}),this.mouseController.onDragEnd(e=>{"pan"===e.type&&this.cameraController.updateRotationCenterAfterPan(this.scene,this.objectSelector.getSelectableObjects()),this.isMouseDown=!1,this.isPanning=!1,this.isOrbiting=!1,this.isDragSelecting=!1,this.objectSelector.hideSelectionBox()})}setupViewportActions(){this.keyboardController.registerViewportActions({focusOnSelected:()=>{const e=this.editorStore.getState().selectedObject;if(e)if(e.isObject3D)this.cameraController.focusOnObject(e);else{let t=null;"string"!=typeof e&&"number"!=typeof e||this.scene.traverse(s=>{s.userData.id===e&&(t=s)}),t&&this.cameraController.focusOnObject(t)}},toggleProjection:()=>{const e=this.cameraController.toggleProjection();return this.objectSelector.updateCamera(e),e},setView:e=>{this.cameraController.setView(e)},resetCamera:()=>{this.cameraController.resetCamera()}})}updateMousePosition(e){void 0!==e.x&&void 0!==e.y&&(this.mousePosition.x=e.x,this.mousePosition.y=e.y)}finishDragSelection(e,t,s,n,i){const r=this.renderer.domElement.getBoundingClientRect(),a={x:(e-r.left)/r.width*2-1,y:-(t-r.top)/r.height*2+1},o={x:(s-r.left)/r.width*2-1,y:-(n-r.top)/r.height*2+1},l=this.objectSelector.getObjectsInArea(a,o);l.length>0?this.objectSelector.selectMultipleObjects(l,i):i||this.objectSelector.deselectAllObjects(),this.objectSelector.hideSelectionBox()}get camera(){return this.cameraController.getCamera()}set camera(e){this.cameraController.camera=e,this.objectSelector.updateCamera(e)}onWindowResize(){this.cameraController.handleResize(),this.renderer.setSize(window.innerWidth,window.innerHeight)}addSelectableObject(e){this.objectSelector.addSelectableObject(e)}removeSelectableObject(e){this.objectSelector.removeSelectableObject(e)}updateSelectableObjects(e){this.objectSelector.updateSelectableObjects(e)}getSelectedObjects(){return this.objectSelector.getSelectedObjects()}getSelectableObjects(){return this.objectSelector.getSelectableObjects()}selectObject(e){this.objectSelector.selectSingleObject(e)}findObjectById(e){let t=null;return this.scene.traverse(s=>{s.userData&&s.userData.id===e&&(t=s)}),t}deselectAllObjects(){this.objectSelector.deselectAllObjects()}setGizmoMode(e){this.objectSelector.setGizmoMode(e)}getTransformState(){return this.transformManager.getState()}setTransformMode(e){return this.transformManager.setTransformMode(e)}toggleTransformSpace(){return this.transformManager.toggleSpace()}toggleGridSnap(){return this.transformManager.toggleGridSnap()}setGridSize(e){return this.transformManager.setGridSize(e)}toggleMagnet(){return this.transformManager.toggleMagnet()}duplicateSelectedObjects(){return this.transformManager.duplicateSelected()}deleteSelectedObjects(){return this.transformManager.deleteSelected()}groupSelectedObjects(){return this.transformManager.groupSelected()}ungroupSelectedObjects(){return this.transformManager.ungroupSelected()}focusOnObject(e){this.cameraController.focusOnObject(e)}updateSelectedOutlines(){this.objectSelector.updateAllSelectionOutlines()}setCameraView(e){this.cameraController.setView(e)}toggleCameraProjection(){const e=this.cameraController.toggleProjection();return this.objectSelector.updateCamera(e),e}getCameraTarget(){return this.cameraController.getTarget()}setCameraTarget(e){this.cameraController.setTarget(e)}resetCamera(){this.cameraController.resetCamera()}get transformControls(){return this.objectSelector.getTransformControls()}get selectedObjects(){return this.objectSelector.getSelectedObjects()}get isDragging(){return this.objectSelector.isDraggingGizmo()}dispose(){this.inputManager.dispose(),this.keyboardController.dispose(),this.mouseController.dispose(),this.objectSelector.dispose(),this.transformManager.dispose(),this.gridHelper&&(this.scene.remove(this.gridHelper),this.gridHelper.dispose(),this.gridHelper=null)}updateGridSnap(){this.objectSelector.updateGridSnap()}updateWireframe(){const e=this.editorStore.getState();e.scene&&e.scene.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach(t=>{t.wireframe=e.isWireframe}):t.material.wireframe=e.isWireframe)})}updateGizmoSpace(){this.objectSelector.updateGizmoSpace()}updateMagnet(){this.objectSelector.updateMagnet()}updateMagnetRays(){this.objectSelector.updateMagnetRays()}initializeGrid(){this.gridHelper=new Ie(20,20,8947848,4473924),this.gridHelper.name="EditorGrid",this.gridHelper.position.y=0,this.gridHelper.material.opacity=.8,this.gridHelper.material.transparent=!0,this.gridHelper.material.depthWrite=!1;const e=this.editorStore.getState().isGridVisible;this.gridHelper.visible=e,this.scene.add(this.gridHelper)}toggleGrid(){if(!this.gridHelper)return!1;const e=this.editorStore.getState().isGridVisible;return this.gridHelper.visible=e,this.gridHelper.updateMatrixWorld(!0),e}isGridShown(){return this.editorStore.getState().isGridVisible}setGridSize(e,t=20){if(!this.gridHelper)return;this.scene.remove(this.gridHelper),this.gridHelper.dispose();const s=this.editorStore.getState().isGridVisible;this.gridHelper=new Ie(e,t,8947848,4473924),this.gridHelper.name="EditorGrid",this.gridHelper.position.y=0,this.gridHelper.visible=s,this.gridHelper.material.opacity=.8,this.gridHelper.material.transparent=!0,this.gridHelper.material.depthWrite=!1,this.scene.add(this.gridHelper)}}const _n={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}"};class Nn{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){}dispose(){}}const Pn=new oe(-1,1,1,-1,0,1);const kn=new class extends J{constructor(){super(),this.setAttribute("position",new Ne([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Ne([0,2,0,0,2,0],2))}};class Ln{constructor(e){this._mesh=new x(kn,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,Pn)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class In extends Nn{constructor(e,t){super(),this.textureID=void 0!==t?t:"tDiffuse",e instanceof ze?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=Fe.clone(e.uniforms),this.material=new ze({name:void 0!==e.name?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new Ln(this.material)}render(e,t,s){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=s.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class zn extends Nn{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,s){const n=e.getContext(),i=e.state;let r,a;i.buffers.color.setMask(!1),i.buffers.depth.setMask(!1),i.buffers.color.setLocked(!0),i.buffers.depth.setLocked(!0),this.inverse?(r=0,a=1):(r=1,a=0),i.buffers.stencil.setTest(!0),i.buffers.stencil.setOp(n.REPLACE,n.REPLACE,n.REPLACE),i.buffers.stencil.setFunc(n.ALWAYS,r,4294967295),i.buffers.stencil.setClear(a),i.buffers.stencil.setLocked(!0),e.setRenderTarget(s),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),i.buffers.color.setLocked(!1),i.buffers.depth.setLocked(!1),i.buffers.color.setMask(!0),i.buffers.depth.setMask(!0),i.buffers.stencil.setLocked(!1),i.buffers.stencil.setFunc(n.EQUAL,1,4294967295),i.buffers.stencil.setOp(n.KEEP,n.KEEP,n.KEEP),i.buffers.stencil.setLocked(!0)}}class Fn extends Nn{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class Bn{constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),void 0===t){const s=e.getSize(new N);this._width=s.width,this._height=s.height,(t=new Be(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Ue})).texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new In(_n),this.copyPass.material.blending=He,this.clock=new l}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let s=!1;for(let n=0,i=this.passes.length;n<i;n++){const t=this.passes[n];if(!1!==t.enabled){if(t.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(n),t.render(this.renderer,this.writeBuffer,this.readBuffer,e,s),t.needsSwap){if(s){const t=this.renderer.getContext(),s=this.renderer.state.buffers.stencil;s.setFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),s.setFunc(t.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==zn&&(t instanceof zn?s=!0:t instanceof Fn&&(s=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(void 0===e){const t=this.renderer.getSize(new N);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,(e=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const s=this._width*this._pixelRatio,n=this._height*this._pixelRatio;this.renderTarget1.setSize(s,n),this.renderTarget2.setSize(s,n);for(let i=0;i<this.passes.length;i++)this.passes[i].setSize(s,n)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class Un extends Nn{constructor(e,t,s=null,n=null,i=null){super(),this.scene=e,this.camera=t,this.overrideMaterial=s,this.clearColor=n,this.clearAlpha=i,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new h}render(e,t,s){const n=e.autoClear;let i,r;e.autoClear=!1,null!==this.overrideMaterial&&(r=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),null!==this.clearColor&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor,e.getClearAlpha())),null!==this.clearAlpha&&(i=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),1==this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:s),!0===this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),null!==this.clearColor&&e.setClearColor(this._oldClearColor),null!==this.clearAlpha&&e.setClearAlpha(i),null!==this.overrideMaterial&&(this.scene.overrideMaterial=r),e.autoClear=n}}const Hn={name:"OutputShader",uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:"\n\t\tprecision highp float;\n\n\t\tuniform mat4 modelViewMatrix;\n\t\tuniform mat4 projectionMatrix;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\t\n\t\tprecision highp float;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\t#include <tonemapping_pars_fragment>\n\t\t#include <colorspace_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\n\t\t\t// tone mapping\n\n\t\t\t#ifdef LINEAR_TONE_MAPPING\n\n\t\t\t\tgl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( REINHARD_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( CINEON_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = CineonToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( ACES_FILMIC_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( AGX_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( NEUTRAL_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );\n\n\t\t\t#endif\n\n\t\t\t// color space\n\n\t\t\t#ifdef SRGB_TRANSFER\n\n\t\t\t\tgl_FragColor = sRGBTransferOETF( gl_FragColor );\n\n\t\t\t#endif\n\n\t\t}"};class Gn extends Nn{constructor(){super();const e=Hn;this.uniforms=Fe.clone(e.uniforms),this.material=new Ge({name:e.name,uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader}),this.fsQuad=new Ln(this.material),this._outputColorSpace=null,this._toneMapping=null}render(e,t,s){this.uniforms.tDiffuse.value=s.texture,this.uniforms.toneMappingExposure.value=e.toneMappingExposure,this._outputColorSpace===e.outputColorSpace&&this._toneMapping===e.toneMapping||(this._outputColorSpace=e.outputColorSpace,this._toneMapping=e.toneMapping,this.material.defines={},ue.getTransfer(this._outputColorSpace)===Ve&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===Ke?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===Xe?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===Qe?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===Ze?this.material.defines.ACES_FILMIC_TONE_MAPPING="":this._toneMapping===We?this.material.defines.AGX_TONE_MAPPING="":this._toneMapping===Ye&&(this.material.defines.NEUTRAL_TONE_MAPPING=""),this.material.needsUpdate=!0),!0===this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}const Vn={name:"LuminosityHighPassShader",shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new h(0)},defaultOpacity:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec3 defaultColor;\n\t\tuniform float defaultOpacity;\n\t\tuniform float luminosityThreshold;\n\t\tuniform float smoothWidth;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\n\t\t\tfloat v = luminance( texel.xyz );\n\n\t\t\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n\n\t\t\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n\n\t\t\tgl_FragColor = mix( outputColor, texel, alpha );\n\n\t\t}"};class Kn extends Nn{constructor(e,t,s,n){super(),this.strength=void 0!==t?t:1,this.radius=s,this.threshold=n,this.resolution=void 0!==e?new N(e.x,e.y):new N(256,256),this.clearColor=new h(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let i=Math.round(this.resolution.x/2),r=Math.round(this.resolution.y/2);this.renderTargetBright=new Be(i,r,{type:Ue}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let c=0;c<this.nMips;c++){const e=new Be(i,r,{type:Ue});e.texture.name="UnrealBloomPass.h"+c,e.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(e);const t=new Be(i,r,{type:Ue});t.texture.name="UnrealBloomPass.v"+c,t.texture.generateMipmaps=!1,this.renderTargetsVertical.push(t),i=Math.round(i/2),r=Math.round(r/2)}const a=Vn;this.highPassUniforms=Fe.clone(a.uniforms),this.highPassUniforms.luminosityThreshold.value=n,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new ze({uniforms:this.highPassUniforms,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader}),this.separableBlurMaterials=[];const o=[3,5,7,9,11];i=Math.round(this.resolution.x/2),r=Math.round(this.resolution.y/2);for(let c=0;c<this.nMips;c++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(o[c])),this.separableBlurMaterials[c].uniforms.invSize.value=new N(1/i,1/r),i=Math.round(i/2),r=Math.round(r/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new k(1,1,1),new k(1,1,1),new k(1,1,1),new k(1,1,1),new k(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const l=_n;this.copyUniforms=Fe.clone(l.uniforms),this.blendMaterial=new ze({uniforms:this.copyUniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,blending:qe,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new h,this.oldClearAlpha=1,this.basic=new R,this.fsQuad=new Ln(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(e,t){let s=Math.round(e/2),n=Math.round(t/2);this.renderTargetBright.setSize(s,n);for(let i=0;i<this.nMips;i++)this.renderTargetsHorizontal[i].setSize(s,n),this.renderTargetsVertical[i].setSize(s,n),this.separableBlurMaterials[i].uniforms.invSize.value=new N(1/s,1/n),s=Math.round(s/2),n=Math.round(n/2)}render(e,t,s,n,i){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();const r=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),i&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=s.texture,e.setRenderTarget(null),e.clear(),this.fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=s.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this.fsQuad.render(e);let a=this.renderTargetBright;for(let o=0;o<this.nMips;o++)this.fsQuad.material=this.separableBlurMaterials[o],this.separableBlurMaterials[o].uniforms.colorTexture.value=a.texture,this.separableBlurMaterials[o].uniforms.direction.value=Kn.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[o]),e.clear(),this.fsQuad.render(e),this.separableBlurMaterials[o].uniforms.colorTexture.value=this.renderTargetsHorizontal[o].texture,this.separableBlurMaterials[o].uniforms.direction.value=Kn.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[o]),e.clear(),this.fsQuad.render(e),a=this.renderTargetsVertical[o];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,i&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(s),this.fsQuad.render(e)),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=r}getSeperableBlurMaterial(e){const t=[];for(let s=0;s<e;s++)t.push(.39894*Math.exp(-.5*s*s/(e*e))/e);return new ze({defines:{KERNEL_RADIUS:e},uniforms:{colorTexture:{value:null},invSize:{value:new N(.5,.5)},direction:{value:new N(.5,.5)},gaussianCoefficients:{value:t}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 invSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float gaussianCoefficients[KERNEL_RADIUS];\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat weightSum = gaussianCoefficients[0];\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianCoefficients[i];\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;\n\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;\n\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})}getCompositeMaterial(e){return new ze({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D blurTexture1;\n\t\t\t\tuniform sampler2D blurTexture2;\n\t\t\t\tuniform sampler2D blurTexture3;\n\t\t\t\tuniform sampler2D blurTexture4;\n\t\t\t\tuniform sampler2D blurTexture5;\n\t\t\t\tuniform float bloomStrength;\n\t\t\t\tuniform float bloomRadius;\n\t\t\t\tuniform float bloomFactors[NUM_MIPS];\n\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\n\n\t\t\t\tfloat lerpBloomFactor(const in float factor) {\n\t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\n\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\n\t\t\t\t}"})}}Kn.BlurDirectionX=new N(1,0),Kn.BlurDirectionY=new N(0,1);const Xn={name:"FilmShader",uniforms:{tDiffuse:{value:null},time:{value:0},intensity:{value:.5},grayscale:{value:!1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\t#include <common>\n\n\t\tuniform float intensity;\n\t\tuniform bool grayscale;\n\t\tuniform float time;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 base = texture2D( tDiffuse, vUv );\n\n\t\t\tfloat noise = rand( fract( vUv + time ) );\n\n\t\t\tvec3 color = base.rgb + base.rgb * clamp( 0.1 + noise, 0.0, 1.0 );\n\n\t\t\tcolor = mix( base.rgb, color, intensity );\n\n\t\t\tif ( grayscale ) {\n\n\t\t\t\tcolor = vec3( luminance( color ) ); // assuming linear-srgb\n\n\t\t\t}\n\n\t\t\tgl_FragColor = vec4( color, base.a );\n\n\t\t}"};class Qn extends Nn{constructor(e=.5,t=!1){super();const s=Xn;this.uniforms=Fe.clone(s.uniforms),this.material=new ze({name:s.name,uniforms:this.uniforms,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader}),this.uniforms.intensity.value=e,this.uniforms.grayscale.value=t,this.fsQuad=new Ln(this.material)}render(e,t,s,n){this.uniforms.tDiffuse.value=s.texture,this.uniforms.time.value+=n,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}const Zn={name:"DotScreenShader",uniforms:{tDiffuse:{value:null},tSize:{value:new N(256,256)},center:{value:new N(.5,.5)},angle:{value:1.57},scale:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform vec2 center;\n\t\tuniform float angle;\n\t\tuniform float scale;\n\t\tuniform vec2 tSize;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tfloat pattern() {\n\n\t\t\tfloat s = sin( angle ), c = cos( angle );\n\n\t\t\tvec2 tex = vUv * tSize - center;\n\t\t\tvec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;\n\n\t\t\treturn ( sin( point.x ) * sin( point.y ) ) * 4.0;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvec4 color = texture2D( tDiffuse, vUv );\n\n\t\t\tfloat average = ( color.r + color.g + color.b ) / 3.0;\n\n\t\t\tgl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );\n\n\t\t}"};class Wn extends Nn{constructor(e,t,s){super();const n=Zn;this.uniforms=Fe.clone(n.uniforms),void 0!==e&&this.uniforms.center.value.copy(e),void 0!==t&&(this.uniforms.angle.value=t),void 0!==s&&(this.uniforms.scale.value=s),this.material=new ze({name:n.name,uniforms:this.uniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader}),this.fsQuad=new Ln(this.material)}render(e,t,s){this.uniforms.tDiffuse.value=s.texture,this.uniforms.tSize.value.set(s.width,s.height),this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(),this.fsQuad.render(e))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}const Yn={uniforms:{tDiffuse:{value:null},tDisp:{value:null},byp:{value:0},amount:{value:.08},angle:{value:.02},seed:{value:.02},seed_x:{value:.02},seed_y:{value:.02},distortion_x:{value:.5},distortion_y:{value:.6},col_s:{value:.05}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\n\t\tuniform int byp; //should we apply the glitch ?\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform sampler2D tDisp;\n\n\t\tuniform float amount;\n\t\tuniform float angle;\n\t\tuniform float seed;\n\t\tuniform float seed_x;\n\t\tuniform float seed_y;\n\t\tuniform float distortion_x;\n\t\tuniform float distortion_y;\n\t\tuniform float col_s;\n\n\t\tvarying vec2 vUv;\n\n\n\t\tfloat rand(vec2 co){\n\t\t\treturn fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n\t\t}\n\n\t\tvoid main() {\n\t\t\tif(byp<1) {\n\t\t\t\tvec2 p = vUv;\n\t\t\t\tfloat xs = floor(gl_FragCoord.x / 0.5);\n\t\t\t\tfloat ys = floor(gl_FragCoord.y / 0.5);\n\t\t\t\t//based on staffantans glitch shader for unity https://github.com/staffantan/unityglitch\n\t\t\t\tfloat disp = texture2D(tDisp, p*seed*seed).r;\n\t\t\t\tif(p.y<distortion_x+col_s && p.y>distortion_x-col_s*seed) {\n\t\t\t\t\tif(seed_x>0.){\n\t\t\t\t\t\tp.y = 1. - (p.y + distortion_y);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp.y = distortion_y;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(p.x<distortion_y+col_s && p.x>distortion_y-col_s*seed) {\n\t\t\t\t\tif(seed_y>0.){\n\t\t\t\t\t\tp.x=distortion_x;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp.x = 1. - (p.x + distortion_x);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tp.x+=disp*seed_x*(seed/5.);\n\t\t\t\tp.y+=disp*seed_y*(seed/5.);\n\t\t\t\t//base from RGB shift shader\n\t\t\t\tvec2 offset = amount * vec2( cos(angle), sin(angle));\n\t\t\t\tvec4 cr = texture2D(tDiffuse, p + offset);\n\t\t\t\tvec4 cga = texture2D(tDiffuse, p);\n\t\t\t\tvec4 cb = texture2D(tDiffuse, p - offset);\n\t\t\t\tgl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);\n\t\t\t\t//add noise\n\t\t\t\tvec4 snow = 200.*amount*vec4(rand(vec2(xs * seed,ys * seed*50.))*0.2);\n\t\t\t\tgl_FragColor = gl_FragColor+ snow;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tgl_FragColor=texture2D (tDiffuse, vUv);\n\t\t\t}\n\t\t}"};class qn extends Nn{constructor(e=64){super();const t=Yn;this.uniforms=Fe.clone(t.uniforms),this.heightMap=this.generateHeightmap(e),this.uniforms.tDisp.value=this.heightMap,this.material=new ze({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.fsQuad=new Ln(this.material),this.goWild=!1,this.curF=0,this.generateTrigger()}render(e,t,s){this.uniforms.tDiffuse.value=s.texture,this.uniforms.seed.value=Math.random(),this.uniforms.byp.value=0,this.curF%this.randX==0||1==this.goWild?(this.uniforms.amount.value=Math.random()/30,this.uniforms.angle.value=ae.randFloat(-Math.PI,Math.PI),this.uniforms.seed_x.value=ae.randFloat(-1,1),this.uniforms.seed_y.value=ae.randFloat(-1,1),this.uniforms.distortion_x.value=ae.randFloat(0,1),this.uniforms.distortion_y.value=ae.randFloat(0,1),this.curF=0,this.generateTrigger()):this.curF%this.randX<this.randX/5?(this.uniforms.amount.value=Math.random()/90,this.uniforms.angle.value=ae.randFloat(-Math.PI,Math.PI),this.uniforms.distortion_x.value=ae.randFloat(0,1),this.uniforms.distortion_y.value=ae.randFloat(0,1),this.uniforms.seed_x.value=ae.randFloat(-.3,.3),this.uniforms.seed_y.value=ae.randFloat(-.3,.3)):0==this.goWild&&(this.uniforms.byp.value=1),this.curF++,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(),this.fsQuad.render(e))}generateTrigger(){this.randX=ae.randInt(120,240)}generateHeightmap(e){const t=new Float32Array(e*e),s=e*e;for(let i=0;i<s;i++){const e=ae.randFloat(0,1);t[i]=e}const n=new $e(t,e,e,Je,et);return n.needsUpdate=!0,n}dispose(){this.material.dispose(),this.heightMap.dispose(),this.fsQuad.dispose()}}class $n extends Nn{constructor(e,t,s,n={}){super(),this.pixelSize=e,this.resolution=new N,this.renderResolution=new N,this.pixelatedMaterial=this.createPixelatedMaterial(),this.normalMaterial=new tt,this.fsQuad=new Ln(this.pixelatedMaterial),this.scene=t,this.camera=s,this.normalEdgeStrength=n.normalEdgeStrength||.3,this.depthEdgeStrength=n.depthEdgeStrength||.4,this.beautyRenderTarget=new Be,this.beautyRenderTarget.texture.minFilter=X,this.beautyRenderTarget.texture.magFilter=X,this.beautyRenderTarget.texture.type=Ue,this.beautyRenderTarget.depthTexture=new st,this.normalRenderTarget=new Be,this.normalRenderTarget.texture.minFilter=X,this.normalRenderTarget.texture.magFilter=X,this.normalRenderTarget.texture.type=Ue}dispose(){this.beautyRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.pixelatedMaterial.dispose(),this.normalMaterial.dispose(),this.fsQuad.dispose()}setSize(e,t){this.resolution.set(e,t),this.renderResolution.set(e/this.pixelSize|0,t/this.pixelSize|0);const{x:s,y:n}=this.renderResolution;this.beautyRenderTarget.setSize(s,n),this.normalRenderTarget.setSize(s,n),this.fsQuad.material.uniforms.resolution.value.set(s,n,1/s,1/n)}setPixelSize(e){this.pixelSize=e,this.setSize(this.resolution.x,this.resolution.y)}render(e,t){const s=this.fsQuad.material.uniforms;s.normalEdgeStrength.value=this.normalEdgeStrength,s.depthEdgeStrength.value=this.depthEdgeStrength,e.setRenderTarget(this.beautyRenderTarget),e.render(this.scene,this.camera);const n=this.scene.overrideMaterial;e.setRenderTarget(this.normalRenderTarget),this.scene.overrideMaterial=this.normalMaterial,e.render(this.scene,this.camera),this.scene.overrideMaterial=n,s.tDiffuse.value=this.beautyRenderTarget.texture,s.tDepth.value=this.beautyRenderTarget.depthTexture,s.tNormal.value=this.normalRenderTarget.texture,this.renderToScreen?e.setRenderTarget(null):(e.setRenderTarget(t),this.clear&&e.clear()),this.fsQuad.render(e)}createPixelatedMaterial(){return new ze({uniforms:{tDiffuse:{value:null},tDepth:{value:null},tNormal:{value:null},resolution:{value:new nt(this.renderResolution.x,this.renderResolution.y,1/this.renderResolution.x,1/this.renderResolution.y)},normalEdgeStrength:{value:0},depthEdgeStrength:{value:0}},vertexShader:"\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tuniform sampler2D tDiffuse;\n\t\t\t\tuniform sampler2D tDepth;\n\t\t\t\tuniform sampler2D tNormal;\n\t\t\t\tuniform vec4 resolution;\n\t\t\t\tuniform float normalEdgeStrength;\n\t\t\t\tuniform float depthEdgeStrength;\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\tfloat getDepth(int x, int y) {\n\n\t\t\t\t\treturn texture2D( tDepth, vUv + vec2(x, y) * resolution.zw ).r;\n\n\t\t\t\t}\n\n\t\t\t\tvec3 getNormal(int x, int y) {\n\n\t\t\t\t\treturn texture2D( tNormal, vUv + vec2(x, y) * resolution.zw ).rgb * 2.0 - 1.0;\n\n\t\t\t\t}\n\n\t\t\t\tfloat depthEdgeIndicator(float depth, vec3 normal) {\n\n\t\t\t\t\tfloat diff = 0.0;\n\t\t\t\t\tdiff += clamp(getDepth(1, 0) - depth, 0.0, 1.0);\n\t\t\t\t\tdiff += clamp(getDepth(-1, 0) - depth, 0.0, 1.0);\n\t\t\t\t\tdiff += clamp(getDepth(0, 1) - depth, 0.0, 1.0);\n\t\t\t\t\tdiff += clamp(getDepth(0, -1) - depth, 0.0, 1.0);\n\t\t\t\t\treturn floor(smoothstep(0.01, 0.02, diff) * 2.) / 2.;\n\n\t\t\t\t}\n\n\t\t\t\tfloat neighborNormalEdgeIndicator(int x, int y, float depth, vec3 normal) {\n\n\t\t\t\t\tfloat depthDiff = getDepth(x, y) - depth;\n\t\t\t\t\tvec3 neighborNormal = getNormal(x, y);\n\n\t\t\t\t\t// Edge pixels should yield to faces who's normals are closer to the bias normal.\n\t\t\t\t\tvec3 normalEdgeBias = vec3(1., 1., 1.); // This should probably be a parameter.\n\t\t\t\t\tfloat normalDiff = dot(normal - neighborNormal, normalEdgeBias);\n\t\t\t\t\tfloat normalIndicator = clamp(smoothstep(-.01, .01, normalDiff), 0.0, 1.0);\n\n\t\t\t\t\t// Only the shallower pixel should detect the normal edge.\n\t\t\t\t\tfloat depthIndicator = clamp(sign(depthDiff * .25 + .0025), 0.0, 1.0);\n\n\t\t\t\t\treturn (1.0 - dot(normal, neighborNormal)) * depthIndicator * normalIndicator;\n\n\t\t\t\t}\n\n\t\t\t\tfloat normalEdgeIndicator(float depth, vec3 normal) {\n\n\t\t\t\t\tfloat indicator = 0.0;\n\n\t\t\t\t\tindicator += neighborNormalEdgeIndicator(0, -1, depth, normal);\n\t\t\t\t\tindicator += neighborNormalEdgeIndicator(0, 1, depth, normal);\n\t\t\t\t\tindicator += neighborNormalEdgeIndicator(-1, 0, depth, normal);\n\t\t\t\t\tindicator += neighborNormalEdgeIndicator(1, 0, depth, normal);\n\n\t\t\t\t\treturn step(0.1, indicator);\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\n\t\t\t\t\tfloat depth = 0.0;\n\t\t\t\t\tvec3 normal = vec3(0.0);\n\n\t\t\t\t\tif (depthEdgeStrength > 0.0 || normalEdgeStrength > 0.0) {\n\n\t\t\t\t\t\tdepth = getDepth(0, 0);\n\t\t\t\t\t\tnormal = getNormal(0, 0);\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat dei = 0.0;\n\t\t\t\t\tif (depthEdgeStrength > 0.0)\n\t\t\t\t\t\tdei = depthEdgeIndicator(depth, normal);\n\n\t\t\t\t\tfloat nei = 0.0;\n\t\t\t\t\tif (normalEdgeStrength > 0.0)\n\t\t\t\t\t\tnei = normalEdgeIndicator(depth, normal);\n\n\t\t\t\t\tfloat Strength = dei > 0.0 ? (1.0 - depthEdgeStrength * dei) : (1.0 + normalEdgeStrength * nei);\n\n\t\t\t\t\tgl_FragColor = texel * Strength;\n\n\t\t\t\t}\n\t\t\t"})}}class Jn extends Nn{constructor(e,t,s,n){super(),this.renderScene=t,this.renderCamera=s,this.selectedObjects=void 0!==n?n:[],this.visibleEdgeColor=new h(1,1,1),this.hiddenEdgeColor=new h(.1,.04,.02),this.edgeGlow=0,this.usePatternTexture=!1,this.edgeThickness=1,this.edgeStrength=3,this.downSampleRatio=2,this.pulsePeriod=0,this._visibilityCache=new Map,this._selectionCache=new Set,this.resolution=void 0!==e?new N(e.x,e.y):new N(256,256);const i=Math.round(this.resolution.x/this.downSampleRatio),r=Math.round(this.resolution.y/this.downSampleRatio);this.renderTargetMaskBuffer=new Be(this.resolution.x,this.resolution.y),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.depthMaterial=new it,this.depthMaterial.side=q,this.depthMaterial.depthPacking=rt,this.depthMaterial.blending=He,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=q,this.prepareMaskMaterial.fragmentShader=function(e,t){const s=t.isPerspectiveCamera?"perspective":"orthographic";return e.replace(/DEPTH_TO_VIEW_Z/g,s+"DepthToViewZ")}(this.prepareMaskMaterial.fragmentShader,this.renderCamera),this.renderTargetDepthBuffer=new Be(this.resolution.x,this.resolution.y,{type:Ue}),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new Be(i,r,{type:Ue}),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetBlurBuffer1=new Be(i,r,{type:Ue}),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.renderTargetBlurBuffer2=new Be(Math.round(i/2),Math.round(r/2),{type:Ue}),this.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",this.renderTargetBlurBuffer2.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new Be(i,r,{type:Ue}),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer2=new Be(Math.round(i/2),Math.round(r/2),{type:Ue}),this.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",this.renderTargetEdgeBuffer2.texture.generateMipmaps=!1;this.separableBlurMaterial1=this.getSeperableBlurMaterial(4),this.separableBlurMaterial1.uniforms.texSize.value.set(i,r),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.separableBlurMaterial2=this.getSeperableBlurMaterial(4),this.separableBlurMaterial2.uniforms.texSize.value.set(Math.round(i/2),Math.round(r/2)),this.separableBlurMaterial2.uniforms.kernelRadius.value=4,this.overlayMaterial=this.getOverlayMaterial();const a=_n;this.copyUniforms=Fe.clone(a.uniforms),this.materialCopy=new ze({uniforms:this.copyUniforms,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,blending:He,depthTest:!1,depthWrite:!1}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new h,this.oldClearAlpha=1,this.fsQuad=new Ln(null),this.tempPulseColor1=new h,this.tempPulseColor2=new h,this.textureMatrix=new P}dispose(){this.renderTargetMaskBuffer.dispose(),this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetBlurBuffer2.dispose(),this.renderTargetEdgeBuffer1.dispose(),this.renderTargetEdgeBuffer2.dispose(),this.depthMaterial.dispose(),this.prepareMaskMaterial.dispose(),this.edgeDetectionMaterial.dispose(),this.separableBlurMaterial1.dispose(),this.separableBlurMaterial2.dispose(),this.overlayMaterial.dispose(),this.materialCopy.dispose(),this.fsQuad.dispose()}setSize(e,t){this.renderTargetMaskBuffer.setSize(e,t),this.renderTargetDepthBuffer.setSize(e,t);let s=Math.round(e/this.downSampleRatio),n=Math.round(t/this.downSampleRatio);this.renderTargetMaskDownSampleBuffer.setSize(s,n),this.renderTargetBlurBuffer1.setSize(s,n),this.renderTargetEdgeBuffer1.setSize(s,n),this.separableBlurMaterial1.uniforms.texSize.value.set(s,n),s=Math.round(s/2),n=Math.round(n/2),this.renderTargetBlurBuffer2.setSize(s,n),this.renderTargetEdgeBuffer2.setSize(s,n),this.separableBlurMaterial2.uniforms.texSize.value.set(s,n)}updateSelectionCache(){const e=this._selectionCache;function t(t){t.isMesh&&e.add(t)}e.clear();for(let s=0;s<this.selectedObjects.length;s++){this.selectedObjects[s].traverse(t)}}changeVisibilityOfSelectedObjects(e){const t=this._visibilityCache;for(const s of this._selectionCache)!0===e?s.visible=t.get(s):(t.set(s,s.visible),s.visible=e)}changeVisibilityOfNonSelectedObjects(e){const t=this._visibilityCache,s=this._selectionCache;this.renderScene.traverse(function(n){if(n.isMesh||n.isSprite){if(!s.has(n)){const s=n.visible;!1!==e&&!0!==t.get(n)||(n.visible=e),t.set(n,s)}}else(n.isPoints||n.isLine)&&(!0===e?n.visible=t.get(n):(t.set(n,n.visible),n.visible=e))})}updateTextureMatrix(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)}render(e,t,s,n,i){if(this.selectedObjects.length>0){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();const t=e.autoClear;e.autoClear=!1,i&&e.state.buffers.stencil.setTest(!1),e.setClearColor(16777215,1),this.updateSelectionCache(),this.changeVisibilityOfSelectedObjects(!1);const n=this.renderScene.background;if(this.renderScene.background=null,this.renderScene.overrideMaterial=this.depthMaterial,e.setRenderTarget(this.renderTargetDepthBuffer),e.clear(),e.render(this.renderScene,this.renderCamera),this.changeVisibilityOfSelectedObjects(!0),this._visibilityCache.clear(),this.updateTextureMatrix(),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value.set(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.setRenderTarget(this.renderTargetMaskBuffer),e.clear(),e.render(this.renderScene,this.renderCamera),this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0),this._visibilityCache.clear(),this._selectionCache.clear(),this.renderScene.background=n,this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.setRenderTarget(this.renderTargetMaskDownSampleBuffer),e.clear(),this.fsQuad.render(e),this.tempPulseColor1.copy(this.visibleEdgeColor),this.tempPulseColor2.copy(this.hiddenEdgeColor),this.pulsePeriod>0){const e=.625+.75*Math.cos(.01*performance.now()/this.pulsePeriod)/2;this.tempPulseColor1.multiplyScalar(e),this.tempPulseColor2.multiplyScalar(e)}this.fsQuad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value.set(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=this.tempPulseColor1,this.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=this.tempPulseColor2,e.setRenderTarget(this.renderTargetEdgeBuffer1),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=Jn.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,e.setRenderTarget(this.renderTargetBlurBuffer1),e.clear(),this.fsQuad.render(e),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=Jn.BlurDirectionY,e.setRenderTarget(this.renderTargetEdgeBuffer1),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.separableBlurMaterial2,this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial2.uniforms.direction.value=Jn.BlurDirectionX,e.setRenderTarget(this.renderTargetBlurBuffer2),e.clear(),this.fsQuad.render(e),this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetBlurBuffer2.texture,this.separableBlurMaterial2.uniforms.direction.value=Jn.BlurDirectionY,e.setRenderTarget(this.renderTargetEdgeBuffer2),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.renderTargetEdgeBuffer2.texture,this.overlayMaterial.uniforms.patternTexture.value=this.patternTexture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,this.overlayMaterial.uniforms.edgeGlow.value=this.edgeGlow,this.overlayMaterial.uniforms.usePatternTexture.value=this.usePatternTexture,i&&e.state.buffers.stencil.setTest(!0),e.setRenderTarget(s),this.fsQuad.render(e),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=t}this.renderToScreen&&(this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=s.texture,e.setRenderTarget(null),this.fsQuad.render(e))}getPrepareMaskMaterial(){return new ze({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new N(.5,.5)},textureMatrix:{value:null}},vertexShader:"#include <morphtarget_pars_vertex>\n\t\t\t\t#include <skinning_pars_vertex>\n\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\t#include <skinbase_vertex>\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <morphtarget_vertex>\n\t\t\t\t\t#include <skinning_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t\tvPosition = mvPosition;\n\n\t\t\t\t\tvec4 worldPosition = vec4( transformed, 1.0 );\n\n\t\t\t\t\t#ifdef USE_INSTANCING\n\n\t\t\t\t\t\tworldPosition = instanceMatrix * worldPosition;\n\n\t\t\t\t\t#endif\n\n\t\t\t\t\tworldPosition = modelMatrix * worldPosition;\n\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\n\t\t\t\t}",fragmentShader:"#include <packing>\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tuniform sampler2D depthTexture;\n\t\t\t\tuniform vec2 cameraNearFar;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\n\t\t\t\t\tfloat viewZ = - DEPTH_TO_VIEW_Z( depth, cameraNearFar.x, cameraNearFar.y );\n\t\t\t\t\tfloat depthTest = (-vPosition.z > viewZ) ? 1.0 : 0.0;\n\t\t\t\t\tgl_FragColor = vec4(0.0, depthTest, 1.0, 1.0);\n\n\t\t\t\t}"})}getEdgeDetectionMaterial(){return new ze({uniforms:{maskTexture:{value:null},texSize:{value:new N(.5,.5)},visibleEdgeColor:{value:new k(1,1,1)},hiddenEdgeColor:{value:new k(1,1,1)}},vertexShader:"varying vec2 vUv;\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\n\t\t\t\tuniform sampler2D maskTexture;\n\t\t\t\tuniform vec2 texSize;\n\t\t\t\tuniform vec3 visibleEdgeColor;\n\t\t\t\tuniform vec3 hiddenEdgeColor;\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\n\t\t\t\t\tvec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\n\t\t\t\t\tvec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);\n\t\t\t\t\tvec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);\n\t\t\t\t\tvec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);\n\t\t\t\t\tvec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);\n\t\t\t\t\tfloat diff1 = (c1.r - c2.r)*0.5;\n\t\t\t\t\tfloat diff2 = (c3.r - c4.r)*0.5;\n\t\t\t\t\tfloat d = length( vec2(diff1, diff2) );\n\t\t\t\t\tfloat a1 = min(c1.g, c2.g);\n\t\t\t\t\tfloat a2 = min(c3.g, c4.g);\n\t\t\t\t\tfloat visibilityFactor = min(a1, a2);\n\t\t\t\t\tvec3 edgeColor = 1.0 - visibilityFactor > 0.001 ? visibleEdgeColor : hiddenEdgeColor;\n\t\t\t\t\tgl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\n\t\t\t\t}"})}getSeperableBlurMaterial(e){return new ze({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new N(.5,.5)},direction:{value:new N(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 texSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float kernelRadius;\n\n\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\n\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\n\t\t\t\t\tfloat sigma = kernelRadius/2.0;\n\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, sigma);\n\t\t\t\t\tvec4 diffuseSum = texture2D( colorTexture, vUv) * weightSum;\n\t\t\t\t\tvec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\n\t\t\t\t\tvec2 uvOffset = delta;\n\t\t\t\t\tfor( int i = 1; i <= MAX_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = kernelRadius * float(i) / float(MAX_RADIUS);\n\t\t\t\t\t\tfloat w = gaussianPdf(x, sigma);\n\t\t\t\t\t\tvec4 sample1 = texture2D( colorTexture, vUv + uvOffset);\n\t\t\t\t\t\tvec4 sample2 = texture2D( colorTexture, vUv - uvOffset);\n\t\t\t\t\t\tdiffuseSum += ((sample1 + sample2) * w);\n\t\t\t\t\t\tweightSum += (2.0 * w);\n\t\t\t\t\t\tuvOffset += delta;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = diffuseSum/weightSum;\n\t\t\t\t}"})}getOverlayMaterial(){return new ze({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},patternTexture:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},usePatternTexture:{value:0}},vertexShader:"varying vec2 vUv;\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\n\t\t\t\tuniform sampler2D maskTexture;\n\t\t\t\tuniform sampler2D edgeTexture1;\n\t\t\t\tuniform sampler2D edgeTexture2;\n\t\t\t\tuniform sampler2D patternTexture;\n\t\t\t\tuniform float edgeStrength;\n\t\t\t\tuniform float edgeGlow;\n\t\t\t\tuniform bool usePatternTexture;\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 edgeValue1 = texture2D(edgeTexture1, vUv);\n\t\t\t\t\tvec4 edgeValue2 = texture2D(edgeTexture2, vUv);\n\t\t\t\t\tvec4 maskColor = texture2D(maskTexture, vUv);\n\t\t\t\t\tvec4 patternColor = texture2D(patternTexture, 6.0 * vUv);\n\t\t\t\t\tfloat visibilityFactor = 1.0 - maskColor.g > 0.0 ? 1.0 : 0.5;\n\t\t\t\t\tvec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;\n\t\t\t\t\tvec4 finalColor = edgeStrength * maskColor.r * edgeValue;\n\t\t\t\t\tif(usePatternTexture)\n\t\t\t\t\t\tfinalColor += + visibilityFactor * (1.0 - maskColor.r) * (1.0 - patternColor.r);\n\t\t\t\t\tgl_FragColor = finalColor;\n\t\t\t\t}",blending:qe,depthTest:!1,depthWrite:!1,transparent:!0})}}Jn.BlurDirectionX=new N(1,0),Jn.BlurDirectionY=new N(0,1);class ei{constructor(e=Math){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(let t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(let t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(e,t,s){return e[0]*t+e[1]*s}dot3(e,t,s,n){return e[0]*t+e[1]*s+e[2]*n}dot4(e,t,s,n,i){return e[0]*t+e[1]*s+e[2]*n+e[3]*i}noise(e,t){let s,n,i;const r=(e+t)*(.5*(Math.sqrt(3)-1)),a=Math.floor(e+r),o=Math.floor(t+r),l=(3-Math.sqrt(3))/6,c=(a+o)*l,h=e-(a-c),d=t-(o-c);let u,p;h>d?(u=1,p=0):(u=0,p=1);const m=h-u+l,g=d-p+l,f=h-1+2*l,v=d-1+2*l,x=255&a,b=255&o,y=this.perm[x+this.perm[b]]%12,w=this.perm[x+u+this.perm[b+p]]%12,S=this.perm[x+1+this.perm[b+1]]%12;let j=.5-h*h-d*d;j<0?s=0:(j*=j,s=j*j*this.dot(this.grad3[y],h,d));let M=.5-m*m-g*g;M<0?n=0:(M*=M,n=M*M*this.dot(this.grad3[w],m,g));let T=.5-f*f-v*v;return T<0?i=0:(T*=T,i=T*T*this.dot(this.grad3[S],f,v)),70*(s+n+i)}noise3d(e,t,s){let n,i,r,a;const o=(e+t+s)*(1/3),l=Math.floor(e+o),c=Math.floor(t+o),h=Math.floor(s+o),d=1/6,u=(l+c+h)*d,p=e-(l-u),m=t-(c-u),g=s-(h-u);let f,v,x,b,y,w;p>=m?m>=g?(f=1,v=0,x=0,b=1,y=1,w=0):p>=g?(f=1,v=0,x=0,b=1,y=0,w=1):(f=0,v=0,x=1,b=1,y=0,w=1):m<g?(f=0,v=0,x=1,b=0,y=1,w=1):p<g?(f=0,v=1,x=0,b=0,y=1,w=1):(f=0,v=1,x=0,b=1,y=1,w=0);const S=p-f+d,j=m-v+d,M=g-x+d,T=p-b+2*d,C=m-y+2*d,A=g-w+2*d,E=p-1+.5,O=m-1+.5,R=g-1+.5,D=255&l,_=255&c,N=255&h,P=this.perm[D+this.perm[_+this.perm[N]]]%12,k=this.perm[D+f+this.perm[_+v+this.perm[N+x]]]%12,L=this.perm[D+b+this.perm[_+y+this.perm[N+w]]]%12,I=this.perm[D+1+this.perm[_+1+this.perm[N+1]]]%12;let z=.6-p*p-m*m-g*g;z<0?n=0:(z*=z,n=z*z*this.dot3(this.grad3[P],p,m,g));let F=.6-S*S-j*j-M*M;F<0?i=0:(F*=F,i=F*F*this.dot3(this.grad3[k],S,j,M));let B=.6-T*T-C*C-A*A;B<0?r=0:(B*=B,r=B*B*this.dot3(this.grad3[L],T,C,A));let U=.6-E*E-O*O-R*R;return U<0?a=0:(U*=U,a=U*U*this.dot3(this.grad3[I],E,O,R)),32*(n+i+r+a)}noise4d(e,t,s,n){const i=this.grad4,r=this.simplex,a=this.perm,o=(Math.sqrt(5)-1)/4,l=(5-Math.sqrt(5))/20;let c,h,d,u,p;const m=(e+t+s+n)*o,g=Math.floor(e+m),f=Math.floor(t+m),v=Math.floor(s+m),x=Math.floor(n+m),b=(g+f+v+x)*l,y=e-(g-b),w=t-(f-b),S=s-(v-b),j=n-(x-b),M=(y>w?32:0)+(y>S?16:0)+(w>S?8:0)+(y>j?4:0)+(w>j?2:0)+(S>j?1:0),T=r[M][0]>=3?1:0,C=r[M][1]>=3?1:0,A=r[M][2]>=3?1:0,E=r[M][3]>=3?1:0,O=r[M][0]>=2?1:0,R=r[M][1]>=2?1:0,D=r[M][2]>=2?1:0,_=r[M][3]>=2?1:0,N=r[M][0]>=1?1:0,P=r[M][1]>=1?1:0,k=r[M][2]>=1?1:0,L=r[M][3]>=1?1:0,I=y-T+l,z=w-C+l,F=S-A+l,B=j-E+l,U=y-O+2*l,H=w-R+2*l,G=S-D+2*l,V=j-_+2*l,K=y-N+3*l,X=w-P+3*l,Q=S-k+3*l,Z=j-L+3*l,W=y-1+4*l,Y=w-1+4*l,q=S-1+4*l,$=j-1+4*l,J=255&g,ee=255&f,te=255&v,se=255&x,ne=a[J+a[ee+a[te+a[se]]]]%32,ie=a[J+T+a[ee+C+a[te+A+a[se+E]]]]%32,re=a[J+O+a[ee+R+a[te+D+a[se+_]]]]%32,ae=a[J+N+a[ee+P+a[te+k+a[se+L]]]]%32,oe=a[J+1+a[ee+1+a[te+1+a[se+1]]]]%32;let le=.6-y*y-w*w-S*S-j*j;le<0?c=0:(le*=le,c=le*le*this.dot4(i[ne],y,w,S,j));let ce=.6-I*I-z*z-F*F-B*B;ce<0?h=0:(ce*=ce,h=ce*ce*this.dot4(i[ie],I,z,F,B));let he=.6-U*U-H*H-G*G-V*V;he<0?d=0:(he*=he,d=he*he*this.dot4(i[re],U,H,G,V));let de=.6-K*K-X*X-Q*Q-Z*Z;de<0?u=0:(de*=de,u=de*de*this.dot4(i[ae],K,X,Q,Z));let ue=.6-W*W-Y*Y-q*q-$*$;return ue<0?p=0:(ue*=ue,p=ue*ue*this.dot4(i[oe],W,Y,q,$)),27*(c+h+d+u+p)}}const ti={name:"SSAOShader",defines:{PERSPECTIVE_CAMERA:1,KERNEL_SIZE:32},uniforms:{tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},kernel:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new N},cameraProjectionMatrix:{value:new P},cameraInverseProjectionMatrix:{value:new P},kernelRadius:{value:8},minDistance:{value:.005},maxDistance:{value:.05}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\t\tuniform highp sampler2D tNormal;\n\t\tuniform highp sampler2D tDepth;\n\t\tuniform sampler2D tNoise;\n\n\t\tuniform vec3 kernel[ KERNEL_SIZE ];\n\n\t\tuniform vec2 resolution;\n\n\t\tuniform float cameraNear;\n\t\tuniform float cameraFar;\n\t\tuniform mat4 cameraProjectionMatrix;\n\t\tuniform mat4 cameraInverseProjectionMatrix;\n\n\t\tuniform float kernelRadius;\n\t\tuniform float minDistance; // avoid artifacts caused by neighbour fragments with minimal depth difference\n\t\tuniform float maxDistance; // avoid the influence of fragments which are too far away\n\n\t\tvarying vec2 vUv;\n\n\t\t#include <packing>\n\n\t\tfloat getDepth( const in vec2 screenPosition ) {\n\n\t\t\treturn texture2D( tDepth, screenPosition ).x;\n\n\t\t}\n\n\t\tfloat getLinearDepth( const in vec2 screenPosition ) {\n\n\t\t\t#if PERSPECTIVE_CAMERA == 1\n\n\t\t\t\tfloat fragCoordZ = texture2D( tDepth, screenPosition ).x;\n\t\t\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n\t\t\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n\n\t\t\t#else\n\n\t\t\t\treturn texture2D( tDepth, screenPosition ).x;\n\n\t\t\t#endif\n\n\t\t}\n\n\t\tfloat getViewZ( const in float depth ) {\n\n\t\t\t#if PERSPECTIVE_CAMERA == 1\n\n\t\t\t\treturn perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n\n\t\t\t#else\n\n\t\t\t\treturn orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n\n\t\t\t#endif\n\n\t\t}\n\n\t\tvec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {\n\n\t\t\tfloat clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n\n\t\t\tvec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );\n\n\t\t\tclipPosition *= clipW; // unprojection.\n\n\t\t\treturn ( cameraInverseProjectionMatrix * clipPosition ).xyz;\n\n\t\t}\n\n\t\tvec3 getViewNormal( const in vec2 screenPosition ) {\n\n\t\t\treturn unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tfloat depth = getDepth( vUv );\n\n\t\t\tif ( depth == 1.0 ) {\n\n\t\t\t\tgl_FragColor = vec4( 1.0 ); // don't influence background\n\t\t\t\t\n\t\t\t} else {\n\n\t\t\t\tfloat viewZ = getViewZ( depth );\n\n\t\t\t\tvec3 viewPosition = getViewPosition( vUv, depth, viewZ );\n\t\t\t\tvec3 viewNormal = getViewNormal( vUv );\n\n\t\t\t\tvec2 noiseScale = vec2( resolution.x / 4.0, resolution.y / 4.0 );\n\t\t\t\tvec3 random = vec3( texture2D( tNoise, vUv * noiseScale ).r );\n\n\t\t\t\t// compute matrix used to reorient a kernel vector\n\n\t\t\t\tvec3 tangent = normalize( random - viewNormal * dot( random, viewNormal ) );\n\t\t\t\tvec3 bitangent = cross( viewNormal, tangent );\n\t\t\t\tmat3 kernelMatrix = mat3( tangent, bitangent, viewNormal );\n\n\t\t\t\tfloat occlusion = 0.0;\n\n\t\t\t\tfor ( int i = 0; i < KERNEL_SIZE; i ++ ) {\n\n\t\t\t\t\tvec3 sampleVector = kernelMatrix * kernel[ i ]; // reorient sample vector in view space\n\t\t\t\t\tvec3 samplePoint = viewPosition + ( sampleVector * kernelRadius ); // calculate sample point\n\n\t\t\t\t\tvec4 samplePointNDC = cameraProjectionMatrix * vec4( samplePoint, 1.0 ); // project point and calculate NDC\n\t\t\t\t\tsamplePointNDC /= samplePointNDC.w;\n\n\t\t\t\t\tvec2 samplePointUv = samplePointNDC.xy * 0.5 + 0.5; // compute uv coordinates\n\n\t\t\t\t\tfloat realDepth = getLinearDepth( samplePointUv ); // get linear depth from depth texture\n\t\t\t\t\tfloat sampleDepth = viewZToOrthographicDepth( samplePoint.z, cameraNear, cameraFar ); // compute linear depth of the sample view Z value\n\t\t\t\t\tfloat delta = sampleDepth - realDepth;\n\n\t\t\t\t\tif ( delta > minDistance && delta < maxDistance ) { // if fragment is before sample point, increase occlusion\n\n\t\t\t\t\t\tocclusion += 1.0;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tocclusion = clamp( occlusion / float( KERNEL_SIZE ), 0.0, 1.0 );\n\n\t\t\t\tgl_FragColor = vec4( vec3( 1.0 - occlusion ), 1.0 );\n\n\t\t\t}\n\n\t\t}"},si={name:"SSAODepthShader",defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:"varying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"uniform sampler2D tDepth;\n\n\t\tuniform float cameraNear;\n\t\tuniform float cameraFar;\n\n\t\tvarying vec2 vUv;\n\n\t\t#include <packing>\n\n\t\tfloat getLinearDepth( const in vec2 screenPosition ) {\n\n\t\t\t#if PERSPECTIVE_CAMERA == 1\n\n\t\t\t\tfloat fragCoordZ = texture2D( tDepth, screenPosition ).x;\n\t\t\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n\t\t\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n\n\t\t\t#else\n\n\t\t\t\treturn texture2D( tDepth, screenPosition ).x;\n\n\t\t\t#endif\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tfloat depth = getLinearDepth( vUv );\n\t\t\tgl_FragColor = vec4( vec3( 1.0 - depth ), 1.0 );\n\n\t\t}"},ni={name:"SSAOBlurShader",uniforms:{tDiffuse:{value:null},resolution:{value:new N}},vertexShader:"varying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"uniform sampler2D tDiffuse;\n\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec2 texelSize = ( 1.0 / resolution );\n\t\t\tfloat result = 0.0;\n\n\t\t\tfor ( int i = - 2; i <= 2; i ++ ) {\n\n\t\t\t\tfor ( int j = - 2; j <= 2; j ++ ) {\n\n\t\t\t\t\tvec2 offset = ( vec2( float( i ), float( j ) ) ) * texelSize;\n\t\t\t\t\tresult += texture2D( tDiffuse, vUv + offset ).r;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tgl_FragColor = vec4( vec3( result / ( 5.0 * 5.0 ) ), 1.0 );\n\n\t\t}"};class ii extends Nn{constructor(e,t,s,n,i=32){super(),this.width=void 0!==s?s:512,this.height=void 0!==n?n:512,this.clear=!0,this.needsSwap=!1,this.camera=t,this.scene=e,this.kernelRadius=8,this.kernel=[],this.noiseTexture=null,this.output=0,this.minDistance=.005,this.maxDistance=.1,this._visibilityCache=new Map,this.generateSampleKernel(i),this.generateRandomKernelRotations();const r=new st;r.format=at,r.type=ot,this.normalRenderTarget=new Be(this.width,this.height,{minFilter:X,magFilter:X,type:Ue,depthTexture:r}),this.ssaoRenderTarget=new Be(this.width,this.height,{type:Ue}),this.blurRenderTarget=this.ssaoRenderTarget.clone(),this.ssaoMaterial=new ze({defines:Object.assign({},ti.defines),uniforms:Fe.clone(ti.uniforms),vertexShader:ti.vertexShader,fragmentShader:ti.fragmentShader,blending:He}),this.ssaoMaterial.defines.KERNEL_SIZE=i,this.ssaoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.ssaoMaterial.uniforms.tDepth.value=this.normalRenderTarget.depthTexture,this.ssaoMaterial.uniforms.tNoise.value=this.noiseTexture,this.ssaoMaterial.uniforms.kernel.value=this.kernel,this.ssaoMaterial.uniforms.cameraNear.value=this.camera.near,this.ssaoMaterial.uniforms.cameraFar.value=this.camera.far,this.ssaoMaterial.uniforms.resolution.value.set(this.width,this.height),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.normalMaterial=new tt,this.normalMaterial.blending=He,this.blurMaterial=new ze({defines:Object.assign({},ni.defines),uniforms:Fe.clone(ni.uniforms),vertexShader:ni.vertexShader,fragmentShader:ni.fragmentShader}),this.blurMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.blurMaterial.uniforms.resolution.value.set(this.width,this.height),this.depthRenderMaterial=new ze({defines:Object.assign({},si.defines),uniforms:Fe.clone(si.uniforms),vertexShader:si.vertexShader,fragmentShader:si.fragmentShader,blending:He}),this.depthRenderMaterial.uniforms.tDepth.value=this.normalRenderTarget.depthTexture,this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new ze({uniforms:Fe.clone(_n.uniforms),vertexShader:_n.vertexShader,fragmentShader:_n.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:lt,blendDst:ct,blendEquation:ht,blendSrcAlpha:dt,blendDstAlpha:ct,blendEquationAlpha:ht}),this.fsQuad=new Ln(null),this.originalClearColor=new h}dispose(){this.normalRenderTarget.dispose(),this.ssaoRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.normalMaterial.dispose(),this.blurMaterial.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this.fsQuad.dispose()}render(e,t,s){switch(this.overrideVisibility(),this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,7829503,1),this.restoreVisibility(),this.ssaoMaterial.uniforms.kernelRadius.value=this.kernelRadius,this.ssaoMaterial.uniforms.minDistance.value=this.minDistance,this.ssaoMaterial.uniforms.maxDistance.value=this.maxDistance,this.renderPass(e,this.ssaoMaterial,this.ssaoRenderTarget),this.renderPass(e,this.blurMaterial,this.blurRenderTarget),this.output){case ii.OUTPUT.SSAO:this.copyMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.copyMaterial.blending=He,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:s);break;case ii.OUTPUT.Blur:this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=He,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:s);break;case ii.OUTPUT.Depth:this.renderPass(e,this.depthRenderMaterial,this.renderToScreen?null:s);break;case ii.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=He,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:s);break;case ii.OUTPUT.Default:this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=ut,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:s)}}renderPass(e,t,s,n,i){e.getClearColor(this.originalClearColor);const r=e.getClearAlpha(),a=e.autoClear;e.setRenderTarget(s),e.autoClear=!1,null!=n&&(e.setClearColor(n),e.setClearAlpha(i||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=a,e.setClearColor(this.originalClearColor),e.setClearAlpha(r)}renderOverride(e,t,s,n,i){e.getClearColor(this.originalClearColor);const r=e.getClearAlpha(),a=e.autoClear;e.setRenderTarget(s),e.autoClear=!1,n=t.clearColor||n,i=t.clearAlpha||i,null!=n&&(e.setClearColor(n),e.setClearAlpha(i||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=a,e.setClearColor(this.originalClearColor),e.setClearAlpha(r)}setSize(e,t){this.width=e,this.height=t,this.ssaoRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.blurRenderTarget.setSize(e,t),this.ssaoMaterial.uniforms.resolution.value.set(e,t),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.blurMaterial.uniforms.resolution.value.set(e,t)}generateSampleKernel(e){const t=this.kernel;for(let s=0;s<e;s++){const n=new k;n.x=2*Math.random()-1,n.y=2*Math.random()-1,n.z=Math.random(),n.normalize();let i=s/e;i=ae.lerp(.1,1,i*i),n.multiplyScalar(i),t.push(n)}}generateRandomKernelRotations(){const e=new ei,t=new Float32Array(16);for(let s=0;s<16;s++){const n=2*Math.random()-1,i=2*Math.random()-1,r=0;t[s]=e.noise3d(n,i,r)}this.noiseTexture=new $e(t,4,4,Je,et),this.noiseTexture.wrapS=K,this.noiseTexture.wrapT=K,this.noiseTexture.needsUpdate=!0}overrideVisibility(){const e=this.scene,t=this._visibilityCache;e.traverse(function(e){t.set(e,e.visible),(e.isPoints||e.isLine)&&(e.visible=!1)})}restoreVisibility(){const e=this.scene,t=this._visibilityCache;e.traverse(function(e){const s=t.get(e);e.visible=s}),t.clear()}}ii.OUTPUT={Default:0,SSAO:1,Blur:2,Depth:3,Normal:4};const ri={name:"FXAAShader",uniforms:{tDiffuse:{value:null},resolution:{value:new N(1/1024,1/512)}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\t// FXAA algorithm from NVIDIA, C# implementation by Jasper Flick, GLSL port by Dave Hoskins\n\t\t// http://developer.download.nvidia.com/assets/gamedev/files/sdk/11/FXAA_WhitePaper.pdf\n\t\t// https://catlikecoding.com/unity/tutorials/advanced-rendering/fxaa/\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec2 resolution;\n\t\tvarying vec2 vUv;\n\n\t\t#define EDGE_STEP_COUNT 6\n\t\t#define EDGE_GUESS 8.0\n\t\t#define EDGE_STEPS 1.0, 1.5, 2.0, 2.0, 2.0, 4.0\n\t\tconst float edgeSteps[EDGE_STEP_COUNT] = float[EDGE_STEP_COUNT]( EDGE_STEPS );\n\n\t\tfloat _ContrastThreshold = 0.0312;\n\t\tfloat _RelativeThreshold = 0.063;\n\t\tfloat _SubpixelBlending = 1.0;\n\n\t\tvec4 Sample( sampler2D  tex2D, vec2 uv ) {\n\n\t\t\treturn texture( tex2D, uv );\n\n\t\t}\n\n\t\tfloat SampleLuminance( sampler2D tex2D, vec2 uv ) {\n\n\t\t\treturn dot( Sample( tex2D, uv ).rgb, vec3( 0.3, 0.59, 0.11 ) );\n\n\t\t}\n\n\t\tfloat SampleLuminance( sampler2D tex2D, vec2 texSize, vec2 uv, float uOffset, float vOffset ) {\n\n\t\t\tuv += texSize * vec2(uOffset, vOffset);\n\t\t\treturn SampleLuminance(tex2D, uv);\n\n\t\t}\n\n\t\tstruct LuminanceData {\n\n\t\t\tfloat m, n, e, s, w;\n\t\t\tfloat ne, nw, se, sw;\n\t\t\tfloat highest, lowest, contrast;\n\n\t\t};\n\n\t\tLuminanceData SampleLuminanceNeighborhood( sampler2D tex2D, vec2 texSize, vec2 uv ) {\n\n\t\t\tLuminanceData l;\n\t\t\tl.m = SampleLuminance( tex2D, uv );\n\t\t\tl.n = SampleLuminance( tex2D, texSize, uv,  0.0,  1.0 );\n\t\t\tl.e = SampleLuminance( tex2D, texSize, uv,  1.0,  0.0 );\n\t\t\tl.s = SampleLuminance( tex2D, texSize, uv,  0.0, -1.0 );\n\t\t\tl.w = SampleLuminance( tex2D, texSize, uv, -1.0,  0.0 );\n\n\t\t\tl.ne = SampleLuminance( tex2D, texSize, uv,  1.0,  1.0 );\n\t\t\tl.nw = SampleLuminance( tex2D, texSize, uv, -1.0,  1.0 );\n\t\t\tl.se = SampleLuminance( tex2D, texSize, uv,  1.0, -1.0 );\n\t\t\tl.sw = SampleLuminance( tex2D, texSize, uv, -1.0, -1.0 );\n\n\t\t\tl.highest = max( max( max( max( l.n, l.e ), l.s ), l.w ), l.m );\n\t\t\tl.lowest = min( min( min( min( l.n, l.e ), l.s ), l.w ), l.m );\n\t\t\tl.contrast = l.highest - l.lowest;\n\t\t\treturn l;\n\n\t\t}\n\n\t\tbool ShouldSkipPixel( LuminanceData l ) {\n\n\t\t\tfloat threshold = max( _ContrastThreshold, _RelativeThreshold * l.highest );\n\t\t\treturn l.contrast < threshold;\n\n\t\t}\n\n\t\tfloat DeterminePixelBlendFactor( LuminanceData l ) {\n\n\t\t\tfloat f = 2.0 * ( l.n + l.e + l.s + l.w );\n\t\t\tf += l.ne + l.nw + l.se + l.sw;\n\t\t\tf *= 1.0 / 12.0;\n\t\t\tf = abs( f - l.m );\n\t\t\tf = clamp( f / l.contrast, 0.0, 1.0 );\n\n\t\t\tfloat blendFactor = smoothstep( 0.0, 1.0, f );\n\t\t\treturn blendFactor * blendFactor * _SubpixelBlending;\n\n\t\t}\n\n\t\tstruct EdgeData {\n\n\t\t\tbool isHorizontal;\n\t\t\tfloat pixelStep;\n\t\t\tfloat oppositeLuminance, gradient;\n\n\t\t};\n\n\t\tEdgeData DetermineEdge( vec2 texSize, LuminanceData l ) {\n\n\t\t\tEdgeData e;\n\t\t\tfloat horizontal =\n\t\t\t\tabs( l.n + l.s - 2.0 * l.m ) * 2.0 +\n\t\t\t\tabs( l.ne + l.se - 2.0 * l.e ) +\n\t\t\t\tabs( l.nw + l.sw - 2.0 * l.w );\n\t\t\tfloat vertical =\n\t\t\t\tabs( l.e + l.w - 2.0 * l.m ) * 2.0 +\n\t\t\t\tabs( l.ne + l.nw - 2.0 * l.n ) +\n\t\t\t\tabs( l.se + l.sw - 2.0 * l.s );\n\t\t\te.isHorizontal = horizontal >= vertical;\n\n\t\t\tfloat pLuminance = e.isHorizontal ? l.n : l.e;\n\t\t\tfloat nLuminance = e.isHorizontal ? l.s : l.w;\n\t\t\tfloat pGradient = abs( pLuminance - l.m );\n\t\t\tfloat nGradient = abs( nLuminance - l.m );\n\n\t\t\te.pixelStep = e.isHorizontal ? texSize.y : texSize.x;\n\t\t\t\n\t\t\tif (pGradient < nGradient) {\n\n\t\t\t\te.pixelStep = -e.pixelStep;\n\t\t\t\te.oppositeLuminance = nLuminance;\n\t\t\t\te.gradient = nGradient;\n\n\t\t\t} else {\n\n\t\t\t\te.oppositeLuminance = pLuminance;\n\t\t\t\te.gradient = pGradient;\n\n\t\t\t}\n\n\t\t\treturn e;\n\n\t\t}\n\n\t\tfloat DetermineEdgeBlendFactor( sampler2D  tex2D, vec2 texSize, LuminanceData l, EdgeData e, vec2 uv ) {\n\n\t\t\tvec2 uvEdge = uv;\n\t\t\tvec2 edgeStep;\n\t\t\tif (e.isHorizontal) {\n\n\t\t\t\tuvEdge.y += e.pixelStep * 0.5;\n\t\t\t\tedgeStep = vec2( texSize.x, 0.0 );\n\n\t\t\t} else {\n\n\t\t\t\tuvEdge.x += e.pixelStep * 0.5;\n\t\t\t\tedgeStep = vec2( 0.0, texSize.y );\n\n\t\t\t}\n\n\t\t\tfloat edgeLuminance = ( l.m + e.oppositeLuminance ) * 0.5;\n\t\t\tfloat gradientThreshold = e.gradient * 0.25;\n\n\t\t\tvec2 puv = uvEdge + edgeStep * edgeSteps[0];\n\t\t\tfloat pLuminanceDelta = SampleLuminance( tex2D, puv ) - edgeLuminance;\n\t\t\tbool pAtEnd = abs( pLuminanceDelta ) >= gradientThreshold;\n\n\t\t\tfor ( int i = 1; i < EDGE_STEP_COUNT && !pAtEnd; i++ ) {\n\n\t\t\t\tpuv += edgeStep * edgeSteps[i];\n\t\t\t\tpLuminanceDelta = SampleLuminance( tex2D, puv ) - edgeLuminance;\n\t\t\t\tpAtEnd = abs( pLuminanceDelta ) >= gradientThreshold;\n\n\t\t\t}\n\n\t\t\tif ( !pAtEnd ) {\n\n\t\t\t\tpuv += edgeStep * EDGE_GUESS;\n\n\t\t\t}\n\n\t\t\tvec2 nuv = uvEdge - edgeStep * edgeSteps[0];\n\t\t\tfloat nLuminanceDelta = SampleLuminance( tex2D, nuv ) - edgeLuminance;\n\t\t\tbool nAtEnd = abs( nLuminanceDelta ) >= gradientThreshold;\n\n\t\t\tfor ( int i = 1; i < EDGE_STEP_COUNT && !nAtEnd; i++ ) {\n\n\t\t\t\tnuv -= edgeStep * edgeSteps[i];\n\t\t\t\tnLuminanceDelta = SampleLuminance( tex2D, nuv ) - edgeLuminance;\n\t\t\t\tnAtEnd = abs( nLuminanceDelta ) >= gradientThreshold;\n\n\t\t\t}\n\n\t\t\tif ( !nAtEnd ) {\n\n\t\t\t\tnuv -= edgeStep * EDGE_GUESS;\n\n\t\t\t}\n\n\t\t\tfloat pDistance, nDistance;\n\t\t\tif ( e.isHorizontal ) {\n\n\t\t\t\tpDistance = puv.x - uv.x;\n\t\t\t\tnDistance = uv.x - nuv.x;\n\n\t\t\t} else {\n\t\t\t\t\n\t\t\t\tpDistance = puv.y - uv.y;\n\t\t\t\tnDistance = uv.y - nuv.y;\n\n\t\t\t}\n\n\t\t\tfloat shortestDistance;\n\t\t\tbool deltaSign;\n\t\t\tif ( pDistance <= nDistance ) {\n\n\t\t\t\tshortestDistance = pDistance;\n\t\t\t\tdeltaSign = pLuminanceDelta >= 0.0;\n\n\t\t\t} else {\n\n\t\t\t\tshortestDistance = nDistance;\n\t\t\t\tdeltaSign = nLuminanceDelta >= 0.0;\n\n\t\t\t}\n\n\t\t\tif ( deltaSign == ( l.m - edgeLuminance >= 0.0 ) ) {\n\n\t\t\t\treturn 0.0;\n\n\t\t\t}\n\n\t\t\treturn 0.5 - shortestDistance / ( pDistance + nDistance );\n\n\t\t}\n\n\t\tvec4 ApplyFXAA( sampler2D  tex2D, vec2 texSize, vec2 uv ) {\n\n\t\t\tLuminanceData luminance = SampleLuminanceNeighborhood( tex2D, texSize, uv );\n\t\t\tif ( ShouldSkipPixel( luminance ) ) {\n\n\t\t\t\treturn Sample( tex2D, uv );\n\n\t\t\t}\n\n\t\t\tfloat pixelBlend = DeterminePixelBlendFactor( luminance );\n\t\t\tEdgeData edge = DetermineEdge( texSize, luminance );\n\t\t\tfloat edgeBlend = DetermineEdgeBlendFactor( tex2D, texSize, luminance, edge, uv );\n\t\t\tfloat finalBlend = max( pixelBlend, edgeBlend );\n\n\t\t\tif (edge.isHorizontal) {\n\n\t\t\t\tuv.y += edge.pixelStep * finalBlend;\n\n\t\t\t} else {\n\n\t\t\t\tuv.x += edge.pixelStep * finalBlend;\n\n\t\t\t}\n\n\t\t\treturn Sample( tex2D, uv );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = ApplyFXAA( tDiffuse, resolution.xy, vUv );\n\t\t\t\n\t\t}"},ai={name:"ColorCorrectionShader",uniforms:{tDiffuse:{value:null},powRGB:{value:new k(2,2,2)},mulRGB:{value:new k(1,1,1)},addRGB:{value:new k(0,0,0)}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec3 powRGB;\n\t\tuniform vec3 mulRGB;\n\t\tuniform vec3 addRGB;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor.rgb = mulRGB * pow( ( gl_FragColor.rgb + addRGB ), powRGB );\n\n\t\t}"},oi={name:"VignetteShader",uniforms:{tDiffuse:{value:null},offset:{value:1},darkness:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float offset;\n\t\tuniform float darkness;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t// Eskil's vignette\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tvec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );\n\t\t\tgl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );\n\n\t\t}"},li={name:"SepiaShader",uniforms:{tDiffuse:{value:null},amount:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float amount;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 color = texture2D( tDiffuse, vUv );\n\t\t\tvec3 c = color.rgb;\n\n\t\t\tcolor.r = dot( c, vec3( 1.0 - 0.607 * amount, 0.769 * amount, 0.189 * amount ) );\n\t\t\tcolor.g = dot( c, vec3( 0.349 * amount, 1.0 - 0.314 * amount, 0.168 * amount ) );\n\t\t\tcolor.b = dot( c, vec3( 0.272 * amount, 0.534 * amount, 1.0 - 0.869 * amount ) );\n\n\t\t\tgl_FragColor = vec4( min( vec3( 1.0 ), color.rgb ), color.a );\n\n\t\t}"},ci={name:"HueSaturationShader",uniforms:{tDiffuse:{value:null},hue:{value:0},saturation:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform float hue;\n\t\tuniform float saturation;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\n\t\t\t// hue\n\t\t\tfloat angle = hue * 3.14159265;\n\t\t\tfloat s = sin(angle), c = cos(angle);\n\t\t\tvec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;\n\t\t\tfloat len = length(gl_FragColor.rgb);\n\t\t\tgl_FragColor.rgb = vec3(\n\t\t\t\tdot(gl_FragColor.rgb, weights.xyz),\n\t\t\t\tdot(gl_FragColor.rgb, weights.zxy),\n\t\t\t\tdot(gl_FragColor.rgb, weights.yzx)\n\t\t\t);\n\n\t\t\t// saturation\n\t\t\tfloat average = (gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0;\n\t\t\tif (saturation > 0.0) {\n\t\t\t\tgl_FragColor.rgb += (average - gl_FragColor.rgb) * (1.0 - 1.0 / (1.001 - saturation));\n\t\t\t} else {\n\t\t\t\tgl_FragColor.rgb += (average - gl_FragColor.rgb) * (-saturation);\n\t\t\t}\n\n\t\t}"},hi={name:"BrightnessContrastShader",uniforms:{tDiffuse:{value:null},brightness:{value:0},contrast:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform float brightness;\n\t\tuniform float contrast;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\n\t\t\tgl_FragColor.rgb += brightness;\n\n\t\t\tif (contrast > 0.0) {\n\t\t\t\tgl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - contrast) + 0.5;\n\t\t\t} else {\n\t\t\t\tgl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + contrast) + 0.5;\n\t\t\t}\n\n\t\t}"};class di{constructor(e,t,s){this.scene=e,this.camera=t,this.renderer=s,this.composer=null,this.renderPass=null,this.outputPass=null,this.activeEffects=new Map,this.effectSettings={bloom:{enabled:!1,strength:1.5,radius:.4,threshold:.85},film:{enabled:!1,noiseIntensity:.5,scanlinesIntensity:.05,scanlinesCount:648,grayscale:!1},fxaa:{enabled:!1},ssao:{enabled:!1,kernelRadius:8,minDistance:.005,maxDistance:.1},outline:{enabled:!1,edgeStrength:3,edgeGlow:0,edgeThickness:1,pulsePeriod:0,visibleEdgeColor:16777215,hiddenEdgeColor:1640965},colorCorrection:{enabled:!1,powRGB:{x:2,y:2,z:2},mulRGB:{x:1,y:1,z:1},addRGB:{x:0,y:0,z:0}},vignette:{enabled:!1,offset:1,darkness:1},sepia:{enabled:!1,amount:1},hueSaturation:{enabled:!1,hue:0,saturation:0},brightnessContrast:{enabled:!1,brightness:0,contrast:0},glitch:{enabled:!1,factor:.1},pixelate:{enabled:!1,pixelSize:6},dotScreen:{enabled:!1,center:{x:.5,y:.5},angle:1.57,scale:1}},this.initializeComposer()}initializeComposer(){this.composer=new Bn(this.renderer),this.renderPass=new Un(this.scene,this.camera),this.composer.addPass(this.renderPass),this.outputPass=new Gn,this.updateComposer()}updateComposer(){this.composer.passes=[this.renderPass],this.activeEffects.clear(),this.addActiveEffects(),this.composer.addPass(this.outputPass)}addActiveEffects(){this.effectSettings.ssao.enabled&&this.addSSAOEffect(),this.effectSettings.bloom.enabled&&this.addBloomEffect(),this.effectSettings.outline.enabled&&this.addOutlineEffect(),this.effectSettings.colorCorrection.enabled&&this.addColorCorrectionEffect(),this.effectSettings.brightnessContrast.enabled&&this.addBrightnessContrastEffect(),this.effectSettings.hueSaturation.enabled&&this.addHueSaturationEffect(),this.effectSettings.sepia.enabled&&this.addSepiaEffect(),this.effectSettings.vignette.enabled&&this.addVignetteEffect(),this.effectSettings.pixelate.enabled&&this.addPixelateEffect(),this.effectSettings.dotScreen.enabled&&this.addDotScreenEffect(),this.effectSettings.glitch.enabled&&this.addGlitchEffect(),this.effectSettings.film.enabled&&this.addFilmEffect(),this.effectSettings.fxaa.enabled&&this.addFXAAEffect()}addBloomEffect(){const e=this.effectSettings.bloom,t=new N(window.innerWidth,window.innerHeight),s=new Kn(t,e.strength,e.radius,e.threshold);this.composer.addPass(s),this.activeEffects.set("bloom",s)}addFilmEffect(){const e=this.effectSettings.film,t=new Qn(e.noiseIntensity,e.scanlinesIntensity,e.scanlinesCount,e.grayscale);this.composer.addPass(t),this.activeEffects.set("film",t)}addFXAAEffect(){const e=new In(ri),t=this.renderer.getPixelRatio();e.material.uniforms.resolution.value.x=1/(window.innerWidth*t),e.material.uniforms.resolution.value.y=1/(window.innerHeight*t),this.composer.addPass(e),this.activeEffects.set("fxaa",e)}addSSAOEffect(){const e=this.effectSettings.ssao,t=new ii(this.scene,this.camera,window.innerWidth,window.innerHeight);t.kernelRadius=e.kernelRadius,t.minDistance=e.minDistance,t.maxDistance=e.maxDistance,this.composer.addPass(t),this.activeEffects.set("ssao",t)}addOutlineEffect(){const e=this.effectSettings.outline,t=new N(window.innerWidth,window.innerHeight),s=new Jn(t,this.scene,this.camera);s.edgeStrength=e.edgeStrength,s.edgeGlow=e.edgeGlow,s.edgeThickness=e.edgeThickness,s.pulsePeriod=e.pulsePeriod,s.visibleEdgeColor.setHex(e.visibleEdgeColor),s.hiddenEdgeColor.setHex(e.hiddenEdgeColor),this.composer.addPass(s),this.activeEffects.set("outline",s)}addColorCorrectionEffect(){const e=this.effectSettings.colorCorrection,t=new In(ai);t.material.uniforms.powRGB.value=new k(e.powRGB.x,e.powRGB.y,e.powRGB.z),t.material.uniforms.mulRGB.value=new k(e.mulRGB.x,e.mulRGB.y,e.mulRGB.z),t.material.uniforms.addRGB.value=new k(e.addRGB.x,e.addRGB.y,e.addRGB.z),this.composer.addPass(t),this.activeEffects.set("colorCorrection",t)}addVignetteEffect(){const e=this.effectSettings.vignette,t=new In(oi);t.material.uniforms.offset.value=e.offset,t.material.uniforms.darkness.value=e.darkness,this.composer.addPass(t),this.activeEffects.set("vignette",t)}addSepiaEffect(){const e=this.effectSettings.sepia,t=new In(li);t.material.uniforms.amount.value=e.amount,this.composer.addPass(t),this.activeEffects.set("sepia",t)}addHueSaturationEffect(){const e=this.effectSettings.hueSaturation,t=new In(ci);t.material.uniforms.hue.value=e.hue,t.material.uniforms.saturation.value=e.saturation,this.composer.addPass(t),this.activeEffects.set("hueSaturation",t)}addBrightnessContrastEffect(){const e=this.effectSettings.brightnessContrast,t=new In(hi);t.material.uniforms.brightness.value=e.brightness,t.material.uniforms.contrast.value=e.contrast,this.composer.addPass(t),this.activeEffects.set("brightnessContrast",t)}addGlitchEffect(){const e=new qn;e.factor=this.effectSettings.glitch.factor,this.composer.addPass(e),this.activeEffects.set("glitch",e)}addPixelateEffect(){const e=this.effectSettings.pixelate,t=new $n(e.pixelSize,this.scene,this.camera);this.composer.addPass(t),this.activeEffects.set("pixelate",t)}addDotScreenEffect(){const e=this.effectSettings.dotScreen,t=new Wn(new N(e.center.x,e.center.y),e.angle,e.scale);this.composer.addPass(t),this.activeEffects.set("dotScreen",t)}setEffectEnabled(e,t){this.effectSettings[e]&&(this.effectSettings[e].enabled=t,this.updateComposer())}updateEffectSettings(e,t){this.effectSettings[e]&&(Object.assign(this.effectSettings[e],t),this.effectSettings[e].enabled&&this.updateComposer())}render(){this.composer.render()}handleResize(e,t){this.composer.setSize(e,t);const s=this.activeEffects.get("fxaa");if(s){const n=this.renderer.getPixelRatio();s.material.uniforms.resolution.value.x=1/(e*n),s.material.uniforms.resolution.value.y=1/(t*n)}}setOutlineSelectedObjects(e){const t=this.activeEffects.get("outline");t&&Array.isArray(e)&&(t.selectedObjects=e)}getSettings(){return JSON.parse(JSON.stringify(this.effectSettings))}loadSettings(e){Object.assign(this.effectSettings,e),this.updateComposer()}dispose(){this.composer&&this.composer.dispose(),this.activeEffects.clear(),this.composer=null,this.renderPass=null,this.outputPass=null}}const ui={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class pi{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new Qi(e)}),this.register(function(e){return new Zi(e)}),this.register(function(e){return new $i(e)}),this.register(function(e){return new Ji(e)}),this.register(function(e){return new er(e)}),this.register(function(e){return new tr(e)}),this.register(function(e){return new Wi(e)}),this.register(function(e){return new Yi(e)}),this.register(function(e){return new qi(e)}),this.register(function(e){return new sr(e)}),this.register(function(e){return new nr(e)}),this.register(function(e){return new ir(e)}),this.register(function(e){return new rr(e)}),this.register(function(e){return new ar(e)})}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,s,n){const i=new Xi,r=[];for(let a=0,o=this.pluginCallbacks.length;a<o;a++)r.push(this.pluginCallbacks[a](i));i.setPlugins(r),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,n).catch(s)}parseAsync(e,t){const s=this;return new Promise(function(n,i){s.parse(e,n,i,t)})}}const mi=0,gi=1,fi=2,vi=3,xi=4,bi=5120,yi=5121,wi=5122,Si=5123,ji=5124,Mi=5125,Ti=5126,Ci=34962,Ai=34963,Ei=9728,Oi=9729,Ri=9984,Di=9985,_i=9986,Ni=9987,Pi=33071,ki=33648,Li=10497,Ii="KHR_mesh_quantization",zi={};zi[X]=Ei,zi[me]=Ri,zi[fe]=_i,zi[G]=Oi,zi[ge]=Di,zi[V]=Ni,zi[ve]=Pi,zi[K]=Li,zi[xe]=ki;const Fi={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},Bi=new h;function Ui(e,t){return e.length===t.length&&e.every(function(e,s){return e===t[s]})}function Hi(e){return 4*Math.ceil(e/4)}function Gi(e,t=0){const s=Hi(e.byteLength);if(s!==e.byteLength){const n=new Uint8Array(s);if(n.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<s;i++)n[i]=t;return n.buffer}return e}function Vi(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function Ki(e,t){if(void 0!==e.toBlob)return new Promise(s=>e.toBlob(s,t));let s;return"image/jpeg"===t?s=.92:"image/webp"===t&&(s=.8),e.convertToBlob({type:t,quality:s})}class Xi{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+pt}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,s={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);const n=this,i=n.buffers,r=n.json;s=n.options;const a=n.extensionsUsed,o=n.extensionsRequired,l=new Blob(i,{type:"application/octet-stream"}),c=Object.keys(a),h=Object.keys(o);if(c.length>0&&(r.extensionsUsed=c),h.length>0&&(r.extensionsRequired=h),r.buffers&&r.buffers.length>0&&(r.buffers[0].byteLength=l.size),!0===s.binary){const e=new FileReader;e.readAsArrayBuffer(l),e.onloadend=function(){const s=Gi(e.result),n=new DataView(new ArrayBuffer(8));n.setUint32(0,s.byteLength,!0),n.setUint32(4,5130562,!0);const i=Gi((a=JSON.stringify(r),(new TextEncoder).encode(a).buffer),32);var a;const o=new DataView(new ArrayBuffer(8));o.setUint32(0,i.byteLength,!0),o.setUint32(4,1313821514,!0);const l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,1179937895,!0),c.setUint32(4,2,!0);const h=12+o.byteLength+i.byteLength+n.byteLength+s.byteLength;c.setUint32(8,h,!0);const d=new Blob([l,o,i,n,s],{type:"application/octet-stream"}),u=new FileReader;u.readAsArrayBuffer(d),u.onloadend=function(){t(u.result)}}}else if(r.buffers&&r.buffers.length>0){const e=new FileReader;e.readAsDataURL(l),e.onloadend=function(){const s=e.result;r.buffers[0].uri=s,t(r)}}else t(r)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const s=this.options,n=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&i.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],n[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(i){}}getUID(e,t=!1){if(!1===this.uids.has(e)){const t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new k;for(let s=0,n=e.count;s<n;s++)if(Math.abs(t.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const s=e.clone(),n=new k;for(let i=0,r=s.count;i<r;i++)n.fromBufferAttribute(s,i),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),s.setXYZ(i,n.x,n.y,n.z);return t.attributesNormalized.set(e,s),s}applyTextureTransform(e,t){let s=!1;const n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),s=!0),0!==t.rotation&&(n.rotation=t.rotation,s=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function s(e){return e.colorSpace===D?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof mt&&(e=await this.decompressTextureAsync(e)),t instanceof mt&&(t=await this.decompressTextureAsync(t));const n=e?e.image:null,i=t?t.image:null,r=Math.max(n?n.width:0,i?i.width:0),a=Math.max(n?n.height:0,i?i.height:0),o=Vi();o.width=r,o.height=a;const l=o.getContext("2d",{willReadFrequently:!0});l.fillStyle="#00ffff",l.fillRect(0,0,r,a);const c=l.getImageData(0,0,r,a);if(n){l.drawImage(n,0,0,r,a);const t=s(e),i=l.getImageData(0,0,r,a).data;for(let e=2;e<i.length;e+=4)c.data[e]=256*t(i[e]/256)}if(i){l.drawImage(i,0,0,r,a);const e=s(t),n=l.getImageData(0,0,r,a).data;for(let t=1;t<n.length;t+=4)c.data[t]=256*e(n[t]/256)}l.putImageData(c,0,0);const h=(e||t).clone();return h.source=new gt(o),h.colorSpace=ft,h.channel=(e||t).channel,e&&t&&(e.channel,t.channel),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw new Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){const t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,t,s,n,i){const r=this.json;let a;switch(r.bufferViews||(r.bufferViews=[]),t){case bi:case yi:a=1;break;case wi:case Si:a=2;break;default:a=4}let o=e.itemSize*a;i===Ci&&(o=4*Math.ceil(o/4));const l=Hi(n*o),c=new DataView(new ArrayBuffer(l));let h=0;for(let u=s;u<s+n;u++){for(let s=0;s<e.itemSize;s++){let n;e.itemSize>4?n=e.array[u*e.itemSize+s]:(0===s?n=e.getX(u):1===s?n=e.getY(u):2===s?n=e.getZ(u):3===s&&(n=e.getW(u)),!0===e.normalized&&(n=ae.normalize(n,e.array))),t===Ti?c.setFloat32(h,n,!0):t===ji?c.setInt32(h,n,!0):t===Mi?c.setUint32(h,n,!0):t===wi?c.setInt16(h,n,!0):t===Si?c.setUint16(h,n,!0):t===bi?c.setInt8(h,n):t===yi&&c.setUint8(h,n),h+=a}h%o!==0&&(h+=o-h%o)}const d={buffer:this.processBuffer(c.buffer),byteOffset:this.byteOffset,byteLength:l};void 0!==i&&(d.target=i),i===Ci&&(d.byteStride=o),this.byteOffset+=l,r.bufferViews.push(d);return{id:r.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise(function(n){const i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){const e=Gi(i.result),r={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,n(s.bufferViews.push(r)-1)}})}processAccessor(e,t,s,n){const i=this.json;let r;if(e.array.constructor===Float32Array)r=Ti;else if(e.array.constructor===Int32Array)r=ji;else if(e.array.constructor===Uint32Array)r=Mi;else if(e.array.constructor===Int16Array)r=wi;else if(e.array.constructor===Uint16Array)r=Si;else if(e.array.constructor===Int8Array)r=bi;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);r=yi}if(void 0===s&&(s=0),void 0!==n&&n!==1/0||(n=e.count),0===n)return null;const a=function(e,t,s){const n={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let i=t;i<t+s;i++)for(let t=0;t<e.itemSize;t++){let s;e.itemSize>4?s=e.array[i*e.itemSize+t]:(0===t?s=e.getX(i):1===t?s=e.getY(i):2===t?s=e.getZ(i):3===t&&(s=e.getW(i)),!0===e.normalized&&(s=ae.normalize(s,e.array))),n.min[t]=Math.min(n.min[t],s),n.max[t]=Math.max(n.max[t],s)}return n}(e,s,n);let o;void 0!==t&&(o=e===t.index?Ai:Ci);const l=this.processBufferView(e,r,s,n,o),c={bufferView:l.id,byteOffset:l.byteOffset,componentType:r,count:n,max:a.max,min:a.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(c.normalized=!0),i.accessors||(i.accessors=[]),i.accessors.push(c)-1}processImage(e,t,s,n="image/png"){if(null!==e){const t=this,i=t.cache,r=t.json,a=t.options,o=t.pending;i.images.has(e)||i.images.set(e,{});const l=i.images.get(e),c=n+":flipY/"+s.toString();if(void 0!==l[c])return l[c];r.images||(r.images=[]);const h={mimeType:n},d=Vi();d.width=Math.min(e.width,a.maxTextureSize),d.height=Math.min(e.height,a.maxTextureSize);const u=d.getContext("2d",{willReadFrequently:!0});if(!0===s&&(u.translate(0,d.height),u.scale(1,-1)),void 0!==e.data){e.width>a.maxTextureSize||(e.height,a.maxTextureSize);const t=new Uint8ClampedArray(e.height*e.width*4);for(let s=0;s<t.length;s+=4)t[s+0]=e.data[s+0],t[s+1]=e.data[s+1],t[s+2]=e.data[s+2],t[s+3]=e.data[s+3];u.putImageData(new ImageData(t,e.width,e.height),0,0)}else{if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas))throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");u.drawImage(e,0,0,d.width,d.height)}!0===a.binary?o.push(Ki(d,n).then(e=>t.processBufferViewImage(e)).then(e=>{h.bufferView=e})):void 0!==d.toDataURL?h.uri=d.toDataURL(n):o.push(Ki(d,n).then(e=>(new FileReader).readAsDataURL(e)).then(e=>{h.uri=e}));const p=r.images.push(h)-1;return l[c]=p,p}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const s={magFilter:zi[e.magFilter],minFilter:zi[e.minFilter],wrapS:zi[e.wrapS],wrapT:zi[e.wrapT]};return t.samplers.push(s)-1}async processTextureAsync(e){const t=this.options,s=this.cache,n=this.json;if(s.textures.has(e))return s.textures.get(e);n.textures||(n.textures=[]),e instanceof mt&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let i=e.userData.mimeType;"image/webp"===i&&(i="image/png");const r={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,i)};e.name&&(r.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,r)});const a=n.textures.push(r)-1;return s.textures.set(e,a),a}async processMaterialAsync(e){const t=this.cache,s=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return null;s.materials||(s.materials=[]);const n={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&e.isMeshBasicMaterial;const i=e.color.toArray().concat([e.opacity]);if(Ui(i,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=0,n.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){const t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),s={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(s,t),n.pbrMetallicRoughness.metallicRoughnessTexture=s}if(e.map){const t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),n.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(n.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),n.emissiveTexture=t}}if(e.normalMap){const t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),n.normalTexture=t}if(e.aoMap){const t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),n.occlusionTexture=t}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),e.side===q&&(n.doubleSided=!0),""!==e.name&&(n.name=e.name),this.serializeUserData(e,n),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,n)});const r=s.materials.push(n)-1;return t.materials.set(e,r),r}async processMeshAsync(e){const t=this.cache,s=this.json,n=[e.geometry.uuid];if(Array.isArray(e.material))for(let b=0,y=e.material.length;b<y;b++)n.push(e.material[b].uuid);else n.push(e.material.uuid);const i=n.join(":");if(t.meshes.has(i))return t.meshes.get(i);const r=e.geometry;let a;a=e.isLineSegments?gi:e.isLineLoop?fi:e.isLine?vi:e.isPoints?mi:e.material.wireframe?gi:xi;const o={},l={},c=[],h=[],d={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},u=r.getAttribute("normal");void 0===u||this.isNormalizedNormalAttribute(u)||r.setAttribute("normal",this.createNormalizedNormalAttribute(u));let p=null;for(let b in r.attributes){if("morph"===b.slice(0,5))continue;const e=r.attributes[b];b=d[b]||b.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(b)||(b="_"+b),t.attributes.has(this.getUID(e))){l[b]=t.attributes.get(this.getUID(e));continue}p=null;const s=e.array;"JOINTS_0"!==b||s instanceof Uint16Array||s instanceof Uint8Array?(s instanceof Uint32Array||s instanceof Int32Array)&&!b.startsWith("_")&&(p=pi.Utils.toFloat32BufferAttribute(e)):p=new U(new Uint16Array(s),e.itemSize,e.normalized);const n=this.processAccessor(p||e,r);null!==n&&(b.startsWith("_")||this.detectMeshQuantization(b,e),l[b]=n,t.attributes.set(this.getUID(e),n))}if(void 0!==u&&r.setAttribute("normal",u),0===Object.keys(l).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const s=[],n=[],i={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let a=0;a<e.morphTargetInfluences.length;++a){const o={};let l=!1;for(const e in r.morphAttributes){if("position"!==e&&"normal"!==e){l||(l=!0);continue}const s=r.morphAttributes[e][a],n=e.toUpperCase(),i=r.attributes[e];if(t.attributes.has(this.getUID(s,!0))){o[n]=t.attributes.get(this.getUID(s,!0));continue}const c=s.clone();if(!r.morphTargetsRelative)for(let e=0,t=s.count;e<t;e++)for(let n=0;n<s.itemSize;n++)0===n&&c.setX(e,s.getX(e)-i.getX(e)),1===n&&c.setY(e,s.getY(e)-i.getY(e)),2===n&&c.setZ(e,s.getZ(e)-i.getZ(e)),3===n&&c.setW(e,s.getW(e)-i.getW(e));o[n]=this.processAccessor(c,r),t.attributes.set(this.getUID(i,!0),o[n])}h.push(o),s.push(e.morphTargetInfluences[a]),void 0!==e.morphTargetDictionary&&n.push(i[a])}o.weights=s,n.length>0&&(o.extras={},o.extras.targetNames=n)}const m=Array.isArray(e.material);if(m&&0===r.groups.length)return null;let g=!1;if(m&&null===r.index){const e=[];for(let t=0,s=r.attributes.position.count;t<s;t++)e[t]=t;r.setIndex(e),g=!0}const f=m?e.material:[e.material],v=m?r.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let b=0,y=v.length;b<y;b++){const e={mode:a,attributes:l};if(this.serializeUserData(r,e),h.length>0&&(e.targets=h),null!==r.index){let s=this.getUID(r.index);void 0===v[b].start&&void 0===v[b].count||(s+=":"+v[b].start+":"+v[b].count),t.attributes.has(s)?e.indices=t.attributes.get(s):(e.indices=this.processAccessor(r.index,r,v[b].start,v[b].count),t.attributes.set(s,e.indices)),null===e.indices&&delete e.indices}const s=await this.processMaterialAsync(f[v[b].materialIndex]);null!==s&&(e.material=s),c.push(e)}!0===g&&r.setIndex(null),o.primitives=c,s.meshes||(s.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,o)});const x=s.meshes.push(o)-1;return t.meshes.set(i,x),x}detectMeshQuantization(e,t){if(this.extensionsUsed[Ii])return;let s;switch(t.array.constructor){case Int8Array:s="byte";break;case Uint8Array:s="unsigned byte";break;case Int16Array:s="short";break;case Uint16Array:s="unsigned short";break;default:return}t.normalized&&(s+=" normalized");const n=e.split("_",1)[0];ui[n]&&ui[n].includes(s)&&(this.extensionsUsed[Ii]=!0,this.extensionsRequired[Ii]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const s=e.isOrthographicCamera,n={type:s?"orthographic":"perspective"};return s?n.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:ae.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(n.name=e.type),t.cameras.push(n)-1}processAnimation(e,t){const s=this.json,n=this.nodeMap;s.animations||(s.animations=[]);const i=(e=pi.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,r=[],a=[];for(let o=0;o<i.length;++o){const e=i[o],s=$.parseTrackName(e.name);let l=$.findNode(t,s.nodeName);const c=Fi[s.propertyName];if("bones"===s.objectName&&(l=!0===l.isSkinnedMesh?l.skeleton.getBoneByName(s.objectIndex):void 0),!l||!c)continue;const h=1;let d,u=e.values.length/e.times.length;c===Fi.morphTargetInfluences&&(u/=l.morphTargetInfluences.length),!0===e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(d="CUBICSPLINE",u/=3):d=e.getInterpolation()===be?"STEP":"LINEAR",a.push({input:this.processAccessor(new U(e.times,h)),output:this.processAccessor(new U(e.values,u)),interpolation:d}),r.push({sampler:a.length-1,target:{node:n.get(l),path:c}})}return s.animations.push({name:e.name||"clip_"+s.animations.length,samplers:a,channels:r}),s.animations.length-1}processSkin(e){const t=this.json,s=this.nodeMap,n=t.nodes[s.get(e)],i=e.skeleton;if(void 0===i)return null;const r=e.skeleton.bones[0];if(void 0===r)return null;const a=[],o=new Float32Array(16*i.bones.length),l=new P;for(let c=0;c<i.bones.length;++c)a.push(s.get(i.bones[c])),l.copy(i.boneInverses[c]),l.multiply(e.bindMatrix).toArray(o,16*c);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new U(o,16)),joints:a,skeleton:s.get(r)});return n.skin=t.skins.length-1}async processNodeAsync(e){const t=this.json,s=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);const i={};if(s.trs){const t=e.quaternion.toArray(),s=e.position.toArray(),n=e.scale.toArray();Ui(t,[0,0,0,1])||(i.rotation=t),Ui(s,[0,0,0])||(i.translation=s),Ui(n,[1,1,1])||(i.scale=n)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===Ui(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){const t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const t=[];for(let n=0,i=e.children.length;n<i;n++){const i=e.children[n];if(i.visible||!1===s.onlyVisible){const e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)});const r=t.nodes.push(i)-1;return n.set(e,r),r}async processSceneAsync(e){const t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);const n={};""!==e.name&&(n.name=e.name),t.scenes.push(n);const i=[];for(let r=0,a=e.children.length;r<a;r++){const t=e.children[r];if(t.visible||!1===s.onlyVisible){const e=await this.processNodeAsync(t);null!==e&&i.push(e)}}i.length>0&&(n.nodes=i),this.serializeUserData(e,n)}async processObjectsAsync(e){const t=new c;t.name="AuxScene";for(let s=0;s<e.length;s++)t.children.push(e[s]);await this.processSceneAsync(t)}async processInputAsync(e){const t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});const s=[];for(let n=0;n<e.length;n++)e[n]instanceof c?await this.processSceneAsync(e[n]):s.push(e[n]);s.length>0&&await this.processObjectsAsync(s);for(let n=0;n<this.skins.length;++n)this.processSkin(this.skins[n]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,s=this.plugins.length;t<s;t++)await e(this.plugins[t])}}class Qi{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return;const s=this.writer,n=s.json,i=s.extensionsUsed,r={};e.name&&(r.name=e.name),r.color=e.color.toArray(),r.intensity=e.intensity,e.isDirectionalLight?r.type="directional":e.isPointLight?(r.type="point",e.distance>0&&(r.range=e.distance)):e.isSpotLight&&(r.type="spot",e.distance>0&&(r.range=e.distance),r.spot={},r.spot.innerConeAngle=(1-e.penumbra)*e.angle,r.spot.outerConeAngle=e.angle),void 0!==e.decay&&e.decay,e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||e.target.position.z),i[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},i[this.name]=!0);const a=n.extensions[this.name].lights;a.push(r),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}}class Zi{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;const s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class Wi{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;const s=this.writer,n=s.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){const t={index:await s.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};s.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const t={index:await s.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};s.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){const t={index:await s.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),s.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class Yi{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;const s=this.writer.extensionsUsed,n={};n.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}}class qi{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;const s=this.writer,n=s.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){const t={index:await s.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};s.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const t={index:await s.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};s.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class $i{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,n=s.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){const t={index:await s.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};s.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class Ji{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,n=s.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){const t={index:await s.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};s.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class er{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;const s=this.writer.extensionsUsed,n={};n.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}}class tr{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(Bi)&&!e.specularIntensityMap&&!e.specularColorMap)return;const s=this.writer,n=s.extensionsUsed,i={};if(e.specularIntensityMap){const t={index:await s.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};s.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){const t={index:await s.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};s.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class sr{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;const s=this.writer,n=s.extensionsUsed,i={};if(e.sheenRoughnessMap){const t={index:await s.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};s.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){const t={index:await s.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};s.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class nr{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;const s=this.writer,n=s.extensionsUsed,i={};if(e.anisotropyMap){const t={index:await s.processTextureAsync(e.anisotropyMap)};s.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class ir{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;const s=this.writer.extensionsUsed,n={};n.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=n,s[this.name]=!0}}class rr{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;const s=this.writer,n=s.extensionsUsed,i={};if(e.bumpMap){const t={index:await s.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};s.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class ar{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;const s=this.writer,n=e,i=new Float32Array(3*n.count),r=new Float32Array(4*n.count),a=new Float32Array(3*n.count),o=new P,l=new k,c=new pe,h=new k;for(let u=0;u<n.count;u++)n.getMatrixAt(u,o),o.decompose(l,c,h),l.toArray(i,3*u),c.toArray(r,4*u),h.toArray(a,3*u);const d={TRANSLATION:s.processAccessor(new U(i,3)),ROTATION:s.processAccessor(new U(r,4)),SCALE:s.processAccessor(new U(a,3))};n.instanceColor&&(d._COLOR_0=s.processAccessor(n.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:d},s.extensionsUsed[this.name]=!0,s.extensionsRequired[this.name]=!0}}pi.Utils={insertKeyframe:function(e,t){const s=.001,n=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),r=new e.ValueBufferType(e.values.length+n),a=e.createInterpolant(new e.ValueBufferType(n));let o;if(0===e.times.length){i[0]=t;for(let e=0;e<n;e++)r[e]=0;o=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<s)return 0;i[0]=t,i.set(e.times,1),r.set(a.evaluate(t),0),r.set(e.values,n),o=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<s)return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),r.set(e.values,0),r.set(a.evaluate(t),e.values.length),o=i.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<s)return l;if(e.times[l]<t&&e.times[l+1]>t){i.set(e.times.slice(0,l+1),0),i[l+1]=t,i.set(e.times.slice(l+1),l+2),r.set(e.values.slice(0,(l+1)*n),0),r.set(a.evaluate(t),(l+1)*n),r.set(e.values.slice((l+1)*n),(l+2)*n),o=l+1;break}}return e.times=i,e.values=r,o},mergeMorphTargetTracks:function(e,t){const s=[],n={},i=e.tracks;for(let r=0;r<i.length;++r){let e=i[r];const a=$.parseTrackName(e.name),o=$.findNode(t,a.nodeName);if("morphTargetInfluences"!==a.propertyName||void 0===a.propertyIndex){s.push(e);continue}if(e.createInterpolant!==e.InterpolantFactoryMethodDiscrete&&e.createInterpolant!==e.InterpolantFactoryMethodLinear){if(e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");e=e.clone(),e.setInterpolation(de)}const l=o.morphTargetInfluences.length,c=o.morphTargetDictionary[a.propertyIndex];if(void 0===c)throw new Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);let h;if(void 0===n[o.uuid]){h=e.clone();const t=new h.ValueBufferType(l*h.times.length);for(let e=0;e<h.times.length;e++)t[e*l+c]=h.values[e];h.name=(a.nodeName||"")+".morphTargetInfluences",h.values=t,n[o.uuid]=h,s.push(h);continue}const d=e.createInterpolant(new e.ValueBufferType(1));h=n[o.uuid];for(let t=0;t<h.times.length;t++)h.values[t*l+c]=d.evaluate(h.times[t]);for(let t=0;t<e.times.length;t++){const s=this.insertKeyframe(h,e.times[t]);h.values[s*l+c]=e.values[t]}}return e.tracks=s,e},toFloat32BufferAttribute:function(e){const t=new U(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let s=0,n=e.count;s<n;s++)for(let i=0;i<e.itemSize;i++)t.setComponent(s,i,e.getComponent(s,i));return t}};class or{constructor(){this.loader=new Kt,this.exporter=new pi,this.thumbnailRenderer=null,this.initThumbnailRenderer()}initThumbnailRenderer(){this.thumbnailRenderer={scene:new c,camera:new d(75,1,.1,1e3),renderer:new u({antialias:!0,alpha:!0,preserveDrawingBuffer:!0})};const{scene:e,camera:t,renderer:s}=this.thumbnailRenderer;s.setSize(128,128),s.setClearColor(2763306,1),this.setupLighting(e)}setupLighting(e){const t=new m(4210752,.6);e.add(t);const s=new g(16777215,.8);s.position.set(1,1,1),e.add(s);const n=new g(16777215,.4);n.position.set(-1,-1,-1),e.add(n)}safeRotationCopy(e,t){if(e&&t)try{void 0!==e.order?t.copy(e):t.set(e.x||0,e.y||0,e.z||0,"XYZ")}catch(s){t.set(0,0,0,"XYZ")}}createSafeClone(e){try{if(!e||"object"!=typeof e)return new z;if("Group"===e.type||e.isGroup){const t=new re;return t.name=e.name||"",Array.isArray(e.children)&&e.children.forEach(e=>{try{const s=this.createSafeClone(e);t.add(s)}catch(s){}}),e.position&&t.position.copy(e.position),e.rotation&&this.safeRotationCopy(e.rotation,t.rotation),e.scale&&t.scale.copy(e.scale),t}if(e.isMesh){const t=e.geometry?e.geometry.clone():null,s=e.material?this.cloneMaterial(e.material):null,n=new x(t,s);return n.name=e.name||"",e.position&&n.position.copy(e.position),e.rotation&&this.safeRotationCopy(e.rotation,n.rotation),e.scale&&n.scale.copy(e.scale),n}const t=new z;return t.name=e.name||"",Array.isArray(e.children)&&e.children.forEach(e=>{try{const s=this.createSafeClone(e);t.add(s)}catch(s){}}),e.position&&t.position.copy(e.position),e.rotation&&this.safeRotationCopy(e.rotation,t.rotation),e.scale&&t.scale.copy(e.scale),t}catch(t){const s=new z;return s.name=e&&e.name||"fallback_object",s}}cloneMaterial(e){return Array.isArray(e)?e.map(e=>e.clone?e.clone():e):e.clone?e.clone():e}async loadLibraryMeshes(){try{const t=[{filename:"111.glb",name:"메쉬 111"},{filename:"222.glb",name:"메쉬 222"},{filename:"SM_MERGED_BP_C_GY_Floor_C_1.glb",name:"바닥 메쉬"},{filename:"SM_MERGED_BP_GY_Ceil_C_1.glb",name:"천장 메쉬"},{filename:"SM_MERGED_BP_GY_Pillar_C_1.glb",name:"기둥 메쉬"},{filename:"SM_MERGED_BP_GY_Wall_C_1.glb",name:"벽 메쉬"},{filename:"SM_MERGED_StaticMeshActor_0.glb",name:"정적 메쉬"}],s=[];for(const n of t){const t=`/library/mesh/${n.filename}`;try{if(!(await fetch(t,{method:"HEAD"})).ok)continue}catch(e){continue}const i={id:`library_${n.filename.replace(".glb","")}`,name:n.name,type:"library",geometry:"LibraryMesh",glbUrl:t,filename:n.filename,thumbnail:null,isLoadingThumbnail:!0};s.push(i)}return s}catch(e){return[]}}async generateThumbnailFromURL(e){return new Promise((t,s)=>{this.loader.load(e,e=>{try{const{scene:s,camera:n,renderer:i}=this.thumbnailRenderer,r=[];s.traverse(e=>{e.isMesh&&r.push(e)}),r.forEach(e=>s.remove(e));const a=e.scene;s.add(a);const o=(new Ce).setFromObject(a),l=o.getCenter(new k),c=o.getSize(new k);a.position.sub(l);const h=Math.max(c.x,c.y,c.z),d=n.fov*(Math.PI/180);let u=Math.abs(h/2/Math.tan(d/2));u*=1.5,n.position.set(.7*u,.5*u,u),n.lookAt(0,0,0),i.render(s,n);const p=i.domElement.toDataURL("image/png");s.remove(a),t(p)}catch(n){s(n)}},e=>{},e=>{s(e)})})}generateThumbnailFromObject(e,t=128){const s=new c,n=new d(75,1,.1,1e3),i=new u({antialias:!0,alpha:!0,preserveDrawingBuffer:!0});i.setSize(t,t),i.setClearColor(2763306,1);const r=document.createElement("div");let a;r.style.position="absolute",r.style.left="-9999px",r.style.top="-9999px",document.body.appendChild(r),r.appendChild(i.domElement),this.setupLighting(s);try{a="function"==typeof e.clone?e.clone():this.createSafeClone(e)}catch(v){a=this.createSafeClone(e)}s.add(a);const o=(new Ce).setFromObject(a),l=o.getCenter(new k),h=o.getSize(new k);a.position.sub(l);const p=Math.max(h.x,h.y,h.z),m=n.fov*(Math.PI/180);let g=Math.abs(p/2/Math.tan(m/2));g*=1.5,n.position.set(.7*g,.5*g,g),n.lookAt(0,0,0),i.render(s,n);const f=i.domElement.toDataURL("image/png");return document.body.removeChild(r),i.dispose(),s.clear(),f}async exportObjectToGLB(e,t={}){const{preserveTransform:s=!1}=t;return new Promise((t,n)=>{let i;try{i="function"==typeof e.clone?e.clone():this.createSafeClone(e)}catch(a){i=this.createSafeClone(e)}if(!i||"object"!=typeof i)return void n(new Error("객체 복제에 실패했습니다."));if(s);else try{i.position&&"function"==typeof i.position.set&&i.position.set(0,0,0),i.rotation&&"function"==typeof i.rotation.set&&i.rotation.set(0,0,0,"XYZ"),i.scale&&"function"==typeof i.scale.set&&i.scale.set(1,1,1)}catch(o){}const r=e=>{if(e&&"object"==typeof e){if(e.material)try{e.material=this.cloneMaterial(e.material)}catch(a){}Array.isArray(e.children)&&e.children.forEach(e=>{try{r(e)}catch(t){}})}};r(i),this.exporter.parse(i,e=>{t(e)},e=>{n(e)},{binary:!0,includeCustomExtensions:!0,embedImages:!0,maxTextureSize:1024,forcePowerOfTwoTextures:!1,truncateDrawRange:!1})})}async addCustomMesh(e,t,s={}){const{preserveTransform:n=!0}=s;try{const s=await this.exportObjectToGLB(e,{preserveTransform:n}),i=this.generateThumbnailFromObject(e),r=Date.now(),a={id:`custom_${r}`,name:t||"커스텀 메쉬",fileName:`custom_${r}.glb`,thumbnail:i,type:"custom",glbData:s,createdAt:r,transform:{position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},scale:{x:e.scale.x,y:e.scale.y,z:e.scale.z}}};return this.saveCustomMesh(a),a}catch(i){throw i}}saveCustomMesh(e){const t=this.getCustomMeshes(),s={...e,glbData:Array.from(new Uint8Array(e.glbData))};t.push(s),localStorage.setItem("customMeshes",JSON.stringify(t))}getCustomMeshes(){const e=localStorage.getItem("customMeshes");return e?JSON.parse(e):[]}deleteCustomMesh(e){const t=this.getCustomMeshes().filter(t=>t.id!==e);return localStorage.setItem("customMeshes",JSON.stringify(t)),t}createBlobURL(e){try{let t;if(e instanceof ArrayBuffer)t=e;else if(e instanceof Uint8Array)t=e.buffer;else if("object"==typeof e&&"Buffer"===e.type)t=new Uint8Array(e.data||e).buffer;else{if(!Array.isArray(e))throw new Error("GLB 데이터를 처리할 수 없습니다.");t=new Uint8Array(e).buffer}const s=new Blob([t],{type:"model/gltf-binary"});return URL.createObjectURL(s)}catch(t){throw t}}async loadGLBModel(e){return new Promise((t,s)=>{this.loader.load(e,e=>{t(e.scene)},e=>{},e=>{s(e)})})}dispose(){this.thumbnailRenderer&&(this.thumbnailRenderer.renderer.dispose(),this.thumbnailRenderer.scene.clear(),this.thumbnailRenderer=null)}}let lr=null;const cr=()=>(lr||(lr=new or),lr);function hr({onEditorControlsReady:t,onPostProcessingReady:s,onContextMenu:n}){const i=e.useRef(null),r=e.useRef(null),a=e.useRef(null),o=e.useRef(null),l=e.useRef(new Map),{objects:w,walls:S,setScene:j,setSelectedObject:M}=Vs();return e.useEffect(()=>{if(!i.current)return;const e=new c;e.background=new h(2763306);const v=new d(75,window.innerWidth/window.innerHeight,.1,1e3);v.position.set(15,20,15),v.lookAt(0,0,0);const w=new u({antialias:!0});w.setSize(window.innerWidth,window.innerHeight),w.shadowMap.enabled=!0,w.shadowMap.type=p,w.sortObjects=!1,w.autoClear=!1,i.current.appendChild(w.domElement);const S=e=>{n&&n(e)};w.domElement.addEventListener("contextmenu",S),o.current=e,j(e,v,w);const T=new Dn(e,v,w,Vs,t=>{j(e,t,w)});r.current=T;const C=new di(e,v,w);a.current=C,t&&t(T),s&&s(C);const A=new m(4210752,.6);e.add(A);const D=new g(16777215,.8);D.position.set(50,50,50),D.castShadow=!0,D.shadow.mapSize.width=1024,D.shadow.mapSize.height=1024,e.add(D);const _=new b(2,2,2),P=new Y({color:16711680}),L=new x(_,P);L.position.set(0,1,0),L.castShadow=!0,L.userData.name="Test Cube",L.userData.id="test_cube",e.add(L);const I=new _e(.5,.5,3),z=new Y({color:9127187}),F=new x(I,z);F.position.set(5,1.5,0),F.castShadow=!0,F.userData.name="Tree Trunk",F.userData.id="tree_trunk",e.add(F);const B=new y(2),U=new Y({color:2263842}),H=new x(B,U);H.position.set(5,4,0),H.castShadow=!0,H.userData.name="Tree Leaves",H.userData.id="tree_leaves",e.add(H),l.current.set("test_cube",L),l.current.set("tree_trunk",F),l.current.set("tree_leaves",H),T.addSelectableObject(L),T.addSelectableObject(F),T.addSelectableObject(H);const G=()=>{requestAnimationFrame(G),L.rotation.y+=.005,r.current&&r.current.updateSelectedOutlines(),w.clear();const t=r.current?r.current.camera:v;a.current?a.current.render():w.render(e,t)};G();const V=w.domElement;V.addEventListener("dragover",e=>{e.preventDefault()}),V.addEventListener("drop",t=>{t.preventDefault();try{const n=t.dataTransfer.getData("text/plain");if(n){const i=JSON.parse(n);if("start_position"===i.type||"directional_light"===i.type||"point_light"===i.type||"spot_light"===i.type||"ambient_light"===i.type||"audio_source"===i.type||"fog"===i.type||"skybox"===i.type||"post_process"===i.type||"camera_helper"===i.type||"grid_helper"===i.type||"axes_helper"===i.type){const s=V.getBoundingClientRect(),n=new N;n.x=(t.clientX-s.left)/s.width*2-1,n.y=-(t.clientY-s.top)/s.height*2+1;const r=new Re;r.setFromCamera(n,v);const a=new xt(new k(0,1,0),0),o=new k;let c;switch(r.ray.intersectPlane(a,o),i.type){case"start_position":const t=new jt(.3,1,8),s=new Y({color:65280});c=new x(t,s),c.position.copy(o);break;case"directional_light":const n=new g(16777215,1);n.position.set(o.x+5,o.y+10,o.z+5),n.target.position.copy(o),n.castShadow=!0,n.shadow.mapSize.width=2048,n.shadow.mapSize.height=2048;const i=new St(n,1);e.add(i),c=n,e.add(n.target);break;case"point_light":const r=new O(16777215,1,10,2);r.position.set(o.x,o.y+3,o.z),r.castShadow=!0;const a=new wt(r,.5);e.add(a),c=r;break;case"spot_light":const l=new E(16777215,1,10,Math.PI/6,.1,2);l.position.set(o.x,o.y+5,o.z),l.target.position.copy(o),l.castShadow=!0;const h=new yt(l);e.add(h),c=l,e.add(l.target);break;case"ambient_light":const d=new m(4210752,.3),u=new y(.5,16,16),p=new R({color:4210752,wireframe:!0,transparent:!0,opacity:.5});c=new x(u,p),c.position.copy(o),e.add(d);break;case"audio_source":const f=new y(.3,16,16),v=new Y({color:16750848});c=new x(f,v),c.position.set(o.x,o.y+1,o.z);break;case"grid_helper":c=new Ie(10,10),c.position.copy(o);break;case"axes_helper":c=new bt(2),c.position.copy(o);break;default:const w=new b(.5,.5,.5),S=new Y({color:8947848});c=new x(w,S),c.position.copy(o)}if(c){c.isMesh&&(c.castShadow=!0,c.receiveShadow=!0);const t=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;c.name=t,c.userData={id:t,name:i.name,type:i.type,originalData:i},e.add(c),T.addSelectableObject(c),l.current.set(t,c);(0,Vs.getState().addObject)({id:t,name:i.name,type:i.type,position:[c.position.x,c.position.y,c.position.z],rotation:[c.rotation.x,c.rotation.y,c.rotation.z],scale:[c.scale.x,c.scale.y,c.scale.z],visible:!0,userData:c.userData}),M(t)}return}if("custom"===i.type||"library"===i.type){const n=V.getBoundingClientRect(),r=new N;r.x=(t.clientX-n.left)/n.width*2-1,r.y=-(t.clientY-n.top)/n.height*2+1;const a=new Re;a.setFromCamera(r,v);const o=new xt(new k(0,1,0),0),c=new k;a.ray.intersectPlane(o,c);const h=new Kt;let d;if("custom"===i.type)try{const e=cr();d=e.createBlobURL(i.glbData)}catch(s){return}else"library"===i.type&&(d=i.glbUrl);return void h.load(d,t=>{const s=t.scene;s.position.copy(c),s.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),e.add(s),T.addSelectableObject(s);const n=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;s.name=n,s.userData={id:n,name:i.name,type:i.type,originalData:i},l.current.set(n,s);(0,Vs.getState().addObject)({id:n,name:i.name,type:"mesh",position:[c.x,c.y,c.z],rotation:[s.rotation.x,s.rotation.y,s.rotation.z],scale:[1,1,1],visible:!0,userData:s.userData}),M(n),"custom"===i.type&&URL.revokeObjectURL(d)},void 0,e=>{"custom"===i.type&&URL.revokeObjectURL(d)})}const r=V.getBoundingClientRect(),a=new N;a.x=(t.clientX-r.left)/r.width*2-1,a.y=-(t.clientY-r.top)/r.height*2+1;const o=new Re;o.setFromCamera(a,v);const c=new xt(new k(0,1,0),0),h=new k;o.ray.intersectPlane(c,h);const d=new Y({color:5025616,roughness:.3,metalness:.1});let u,p;switch(i.geometry){case"BoxGeometry":u=new b(...i.params);break;case"SphereGeometry":u=new y(...i.params);break;case"CylinderGeometry":u=new _e(...i.params);break;case"ConeGeometry":u=new jt(...i.params);break;case"PlaneGeometry":u=new f(...i.params);break;case"TorusGeometry":u=new ke(...i.params);break;case"CustomGeometry":if(i.glbData)try{const t=cr().createBlobURL(i.glbData);return void(new Kt).load(t,s=>{const n=s.scene;n.position.copy(h);const r=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;n.name=r,n.userData={id:r,name:i.name,type:i.type||"custom",originalName:i.name},n.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),e.add(n),T.addSelectableObject(n),l.current.set(r,n);(0,Vs.getState().addObject)({id:r,name:i.name,type:"mesh",position:[h.x,h.y,h.z],rotation:[n.rotation.x,n.rotation.y,n.rotation.z],scale:[1,1,1],visible:!0,userData:n.userData}),M(r),URL.revokeObjectURL(t)},void 0,e=>{URL.revokeObjectURL(t)})}catch(s){return}else u=i.originalObject&&i.originalObject.geometry?i.originalObject.geometry.clone():new b(1,1,1);break;case"LibraryMesh":if(i.glbUrl){return void(new Kt).load(i.glbUrl,t=>{const s=t.scene;s.position.copy(h);const n=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;s.name=n,s.userData={id:n,name:i.name,type:i.type||"library",originalName:i.name},s.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),e.add(s),T.addSelectableObject(s),l.current.set(n,s);(0,Vs.getState().addObject)({id:n,name:i.name,type:"mesh",position:[h.x,h.y,h.z],rotation:[s.rotation.x,s.rotation.y,s.rotation.z],scale:[1,1,1],visible:!0,userData:s.userData}),M(n)},void 0,e=>{})}u=new b(1,1,1);break;default:u=new b(1,1,1)}p=new x(u,d),p.position.copy(h),"PlaneGeometry"===i.geometry&&(p.rotation.x=-Math.PI/2),p.castShadow=!0,p.receiveShadow=!0;const w=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;p.name=w,p.userData={id:w,name:i.name,type:i.type||"basic",originalName:i.name},e.add(p),T.addSelectableObject(p),l.current.set(w,p);(0,Vs.getState().addObject)({id:w,name:i.name,type:"mesh",position:[h.x,h.y,h.z],rotation:[p.rotation.x,p.rotation.y,p.rotation.z],scale:[1,1,1],visible:!0,userData:p.userData}),M(w)}}catch(s){}});const K=()=>{r.current?r.current.onWindowResize():(v.aspect=window.innerWidth/window.innerHeight,v.updateProjectionMatrix(),w.setSize(window.innerWidth,window.innerHeight)),a.current&&a.current.handleResize(window.innerWidth,window.innerHeight)};return window.addEventListener("resize",K),()=>{window.removeEventListener("resize",K),w.domElement&&w.domElement.removeEventListener("contextmenu",S),r.current&&r.current.dispose(),a.current&&a.current.dispose(),i.current&&w.domElement&&i.current.removeChild(w.domElement),w.dispose()}},[j]),e.useEffect(()=>{var e;if(!o.current||!r.current)return;const t=o.current,s=new Kt;w.forEach(e=>{if(!l.current.has(e.id))if("glb"===e.type&&(e.file||e.url)){const n=e.file||e.url;s.load(n,s=>{const n=s.scene,i=(new Ce).setFromObject(n);i.getSize(new k);const a=i.getCenter(new k);n.position.sub(a),n.position.set(e.position.x,e.position.y,e.position.z),n.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),n.scale.set(e.scale.x,e.scale.y,e.scale.z),n.name=e.name,n.userData={id:e.id,type:e.type},n.visible=!1!==e.visible,n.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),t.add(n),r.current.addSelectableObject(n),l.current.set(e.id,n),M(e.id),r.current.selectObject(n)},void 0,s=>{const n=new b(1,1,1),i=new v({color:16739179,transparent:!0,opacity:.7}),a=new x(n,i);a.position.set(e.position.x,e.position.y,e.position.z),a.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),a.scale.set(e.scale.x,e.scale.y,e.scale.z),a.name=`${e.name} (로딩실패)`,a.userData={id:e.id,type:e.type,loadError:!0},a.castShadow=!0,a.receiveShadow=!0,a.visible=!1!==e.visible,t.add(a),r.current.addSelectableObject(a),l.current.set(e.id,a),M(e.id),r.current.selectObject(a)})}else if("glb"===e.type&&e.glbData){let n;if(e.glbData instanceof ArrayBuffer)n=e.glbData;else if(e.glbData instanceof Uint8Array)n=e.glbData.buffer;else if(Array.isArray(e.glbData))n=new Uint8Array(e.glbData).buffer;else{if("object"!=typeof e.glbData||"Buffer"!==e.glbData.type)return;n=new Uint8Array(e.glbData.data||e.glbData).buffer}const i=new Blob([n],{type:"model/gltf-binary"}),a=URL.createObjectURL(i);s.load(a,s=>{const n=s.scene,i=(new Ce).setFromObject(n);i.getSize(new k);const o=i.getCenter(new k);n.position.sub(o),n.position.set(e.position.x,e.position.y,e.position.z),n.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),n.scale.set(e.scale.x,e.scale.y,e.scale.z),n.name=e.name,n.userData={id:e.id,type:e.type},n.visible=!1!==e.visible,n.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),t.add(n),r.current.addSelectableObject(n),l.current.set(e.id,n),M(e.id),r.current.selectObject(n),URL.revokeObjectURL(a)},e=>{},e=>{URL.revokeObjectURL(a)})}else if("cube"===e.type){const s=new b(e.size.x,e.size.y,e.size.z),n=new v({color:e.material.color}),i=new x(s,n);i.position.set(e.position.x,e.position.y,e.position.z),i.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),i.name=e.name,i.userData={id:e.id,type:e.type},i.castShadow=!0,i.receiveShadow=!0,t.add(i),r.current.addSelectableObject(i),l.current.set(e.id,i),M(e.id),r.current.selectObject(i)}else if("basic"===e.type||e.geometry&&e.params){const s=new Y({color:5025616,roughness:.3,metalness:.1});let n;switch(e.geometry){case"BoxGeometry":n=new b(...e.params);break;case"SphereGeometry":n=new y(...e.params);break;case"CylinderGeometry":n=new _e(...e.params);break;case"ConeGeometry":n=new jt(...e.params);break;case"PlaneGeometry":n=new f(...e.params);break;case"TorusGeometry":n=new ke(...e.params);break;default:n=new b(1,1,1)}const i=new x(n,s);i.position.set(e.position.x,e.position.y,e.position.z),i.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),i.scale.set(e.scale.x,e.scale.y,e.scale.z),i.name=e.name,i.userData={id:e.id,type:e.type},i.castShadow=!0,i.receiveShadow=!0,i.visible=!1!==e.visible,"PlaneGeometry"===e.geometry&&(i.rotation.x=-Math.PI/2),t.add(i),r.current.addSelectableObject(i),l.current.set(e.id,i),M(e.id),r.current.selectObject(i)}});const n=new Set(w.map(e=>e.id));for(const[i,a]of l.current)if(!n.has(i)){if(null==(e=a.userData)?void 0:e.isSystemObject)continue;t.remove(a),r.current.removeSelectableObject(a),l.current.delete(i)}},[w,M]),e.useEffect(()=>{o.current&&(w.forEach(e=>{const t=l.current.get(e.id);t&&(t.visible=!1!==e.visible)}),S.forEach(e=>{const t=l.current.get(e.id);t&&(t.visible=!1!==e.visible)}))},[w,S]),Lt.jsx("div",{ref:i,style:{width:"100%",height:"100vh",position:"relative"}})}class dr extends Mt{constructor(e){super(e),this.type=Ue}parse(e){const t=function(e,t){switch(e){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(t||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(t||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(t||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(t||""))}},s=function(e,t,s){t=t||1024;let n=e.pos,i=-1,r=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(n,n+128)));for(;0>(i=o.indexOf("\n"))&&r<t&&n<e.byteLength;)a+=o,r+=o.length,n+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(n,n+128)));return-1<i&&(!1!==s&&(e.pos+=r+i+1),a+o.slice(0,i))},n=function(e,t,s,n){const i=e[t+3],r=Math.pow(2,i-128)/255;s[n+0]=e[t+0]*r,s[n+1]=e[t+1]*r,s[n+2]=e[t+2]*r,s[n+3]=1},i=function(e,t,s,n){const i=e[t+3],r=Math.pow(2,i-128)/255;s[n+0]=Tt.toHalfFloat(Math.min(e[t+0]*r,65504)),s[n+1]=Tt.toHalfFloat(Math.min(e[t+1]*r,65504)),s[n+2]=Tt.toHalfFloat(Math.min(e[t+2]*r,65504)),s[n+3]=Tt.toHalfFloat(1)},r=new Uint8Array(e);r.pos=0;const a=function(e){const n=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,c;for((e.pos>=e.byteLength||!(l=s(e)))&&t(1,"no header found"),(c=l.match(/^#\?(\S+)/))||t(3,"bad initial token"),o.valid|=1,o.programtype=c[1],o.string+=l+"\n";l=s(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((c=l.match(n))&&(o.gamma=parseFloat(c[1])),(c=l.match(i))&&(o.exposure=parseFloat(c[1])),(c=l.match(r))&&(o.valid|=2,o.format=c[1]),(c=l.match(a))&&(o.valid|=4,o.height=parseInt(c[1],10),o.width=parseInt(c[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid||t(3,"missing format specifier"),4&o.valid||t(3,"missing image size specifier"),o}(r),o=a.width,l=a.height,c=function(e,s,n){const i=s;if(i<8||i>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);i!==(e[2]<<8|e[3])&&t(3,"wrong scanline width");const r=new Uint8Array(4*s*n);r.length||t(4,"unable to allocate buffer space");let a=0,o=0;const l=4*i,c=new Uint8Array(4),h=new Uint8Array(l);let d=n;for(;d>0&&o<e.byteLength;){o+4>e.byteLength&&t(1),c[0]=e[o++],c[1]=e[o++],c[2]=e[o++],c[3]=e[o++],2==c[0]&&2==c[1]&&(c[2]<<8|c[3])==i||t(3,"bad rgbe scanline format");let s,n=0;for(;n<l&&o<e.byteLength;){s=e[o++];const i=s>128;if(i&&(s-=128),(0===s||n+s>l)&&t(3,"bad scanline data"),i){const t=e[o++];for(let e=0;e<s;e++)h[n++]=t}else h.set(e.subarray(o,o+s),n),n+=s,o+=s}const u=i;for(let e=0;e<u;e++){let t=0;r[a]=h[e+t],t+=i,r[a+1]=h[e+t],t+=i,r[a+2]=h[e+t],t+=i,r[a+3]=h[e+t],a+=4}d--}return r}(r.subarray(r.pos),o,l);let h,d,u;switch(this.type){case et:u=c.length/4;const e=new Float32Array(4*u);for(let s=0;s<u;s++)n(c,4*s,e,4*s);h=e,d=et;break;case Ue:u=c.length/4;const t=new Uint16Array(4*u);for(let s=0;s<u;s++)i(c,4*s,t,4*s);h=t,d=Ue;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:o,height:l,data:h,header:a.string,gamma:a.gamma,exposure:a.exposure,type:d}}setDataType(e){return this.type=e,this}load(e,t,s,n){return super.load(e,function(e,s){switch(e.type){case et:case Ue:"colorSpace"in e?e.colorSpace="srgb-linear":e.encoding=3e3,e.minFilter=G,e.magFilter=G,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,s)},s,n)}}const ur=e.memo(function({objects:t,walls:s,selectedObject:n,onObjectVisibilityToggle:i,onObjectFreezeToggle:r,onObjectSelect:a,onObjectRemove:o,onObjectFocus:l,onObjectRename:c,onContextMenu:h,editorControls:d}){const[u,p]=e.useState(null),[m,g]=e.useState(""),f=e.useRef(null),v=(null==d?void 0:d.selectedObjects)||[],x=e=>{g(e.target.value)},b=e=>{m.trim()&&m!==e.name&&c(e,m.trim()),p(null),g("")},y=(e,t=!1)=>{const s=(null==n?void 0:n.name)===e.name||(null==n?void 0:n.id)===e.id,c=v.some(t=>{var s;return(null==t?void 0:t.name)===e.name||(null==t?void 0:t.id)===e.id||(null==(s=null==t?void 0:t.userData)?void 0:s.id)===e.id}),y=s||c,w=u===e.id;return Lt.jsxs("div",{className:"object-item "+(y?"selected":""),"data-selected":y?"true":"false",style:{display:"flex",flexDirection:"row",alignItems:"center",gap:"8px",padding:"4px 8px",margin:"2px 0",borderRadius:"3px",backgroundColor:y?"#ff8c00":"#252525",borderLeft:"3px solid "+(y?"#ff6600":"transparent"),border:y?"2px solid #ff6600":"1px solid transparent",transition:"all 0.2s ease",minHeight:"28px",width:"100%",boxSizing:"border-box",boxShadow:y?"0 0 8px rgba(255, 140, 0, 0.8)":"none",transform:y?"scale(1.02)":"scale(1)"},onContextMenu:t=>h&&h(t,e),children:[Lt.jsx("button",{className:"visibility-btn",onClick:()=>i(e),title:!1!==e.visible?"숨기기":"보이기",style:{background:"none",border:"none",color:y?"#ffffff":"#cccccc",cursor:"pointer",padding:"2px",borderRadius:"2px",fontSize:"14px",width:"20px",height:"20px",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,flexGrow:0},children:!1!==e.visible?"👁":"�"}),Lt.jsx("span",{className:"object-icon",style:{fontSize:"16px",flexShrink:0,flexGrow:0,width:"20px",textAlign:"center"},children:t?"🧱":"player"===e.type?"🚶":"📦"}),w?Lt.jsx("input",{ref:f,type:"text",value:m,onChange:x,onBlur:()=>(e=>{b(e)})(e),onKeyDown:t=>((e,t)=>{"Enter"===e.key?b(t):"Escape"===e.key&&(p(null),g(""))})(t,e),className:"object-name-input",onClick:e=>e.stopPropagation()}):Lt.jsx("span",{className:"object-name",onClick:()=>(e=>{if(d){const t=d.findObjectById(e.id);t&&d.selectObject(t)}a(e)})(e),onDoubleClick:()=>(e=>{if(d){const t=d.findObjectById(e.id);t&&(d.selectObject(t),l(e))}else l(e);p(e.id),g(e.name),setTimeout(()=>{f.current&&(f.current.focus(),f.current.select())},50)})(e),style:{flex:"1",flexGrow:1,flexShrink:1,cursor:"pointer",padding:"2px 4px",borderRadius:"3px",fontSize:"12px",color:y?"#ffffff":"#cccccc",userSelect:"none",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",minWidth:0,fontWeight:y?"bold":"normal"},children:e.name}),Lt.jsx("button",{className:"freeze-btn "+(e.frozen?"frozen":""),onClick:()=>r(e),title:e.frozen?"고정 해제":"고정",style:{background:e.frozen?"#ff6b6b":"none",border:"none",color:e.frozen||y?"#ffffff":"#cccccc",cursor:"pointer",padding:"2px",borderRadius:"2px",fontSize:"14px",width:"20px",height:"20px",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,flexGrow:0},children:e.frozen?"🔒":"🔓"}),Lt.jsx("button",{className:"delete-btn",onClick:()=>o(e),title:"삭제",style:{background:"none",border:"none",color:y?"#ffcccc":"#ff6b6b",cursor:"pointer",padding:"2px",borderRadius:"2px",fontSize:"12px",width:"20px",height:"20px",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,flexGrow:0,fontWeight:"bold"},children:"×"})]},e.id)};return Lt.jsxs("div",{className:"scene-hierarchy-panel",children:[Lt.jsx("div",{className:"panel-header",children:Lt.jsx("h3",{children:"씬 계층구조"})}),Lt.jsx("div",{className:"panel-content",children:Lt.jsxs("div",{className:"objects-list",children:[t&&t.length>0&&Lt.jsxs(Lt.Fragment,{children:[Lt.jsx("h4",{children:"오브젝트"}),t.map(e=>y(e,!1))]}),s&&s.length>0&&Lt.jsxs(Lt.Fragment,{children:[Lt.jsx("h4",{children:"벽"}),s.map(e=>y(e,!0))]}),(!t||0===t.length)&&(!s||0===s.length)&&Lt.jsx("div",{className:"empty-state",children:"씬에 오브젝트가 없습니다"})]})})]})});class pr{constructor(e){this.editorControls=e,this.selectedObject=null,this.threeObject=null,this.changeCallbacks=[]}onPropertyChange(e){this.changeCallbacks.push(e)}notifyPropertyChange(e,t,s){this.changeCallbacks.forEach(n=>{n({type:e,property:t,value:s,object:this.selectedObject})})}setSelectedObject(e){if(this.selectedObject=e,this.threeObject=null,e)if(e.isObject3D||e.isMesh||e.isLight||e.isCamera)this.threeObject=e;else if(this.editorControls){const t=e.id||e;this.threeObject=this.editorControls.findObjectById(t),!this.threeObject&&this.editorControls.selectedObjects&&this.editorControls.selectedObjects.length>0&&(this.threeObject=this.editorControls.selectedObjects[0])}}getObjectType(){return this.threeObject?this.threeObject.isLight?"light":this.threeObject.isCamera?"camera":this.threeObject.isHelper?"helper":this.threeObject.isMesh?"mesh":this.threeObject.isGroup?"group":"mesh":"unknown"}setTransformProperty(e,t,s){if(!this.threeObject)return!1;const n=parseFloat(s);if(isNaN(n))return!1;switch(e){case"position":this.threeObject.position[t]=n;break;case"rotation":this.threeObject.rotation[t]=n*Math.PI/180;break;case"scale":this.threeObject.scale[t]=n}return this.notifyPropertyChange("transform",e,{[t]:n}),!0}getTransformProperty(e,t){return this.threeObject?"rotation"===e?(180*this.threeObject[e][t]/Math.PI).toFixed(1):this.threeObject[e][t].toFixed(2):0}setLightProperty(e,t){if(!this.threeObject||!this.threeObject.isLight)return!1;switch(e){case"color":this.threeObject.color.setHex(t.replace("#","0x"));break;case"intensity":this.threeObject.intensity=parseFloat(t);break;case"distance":void 0!==this.threeObject.distance&&(this.threeObject.distance=parseFloat(t));break;case"angle":void 0!==this.threeObject.angle&&(this.threeObject.angle=parseFloat(t));break;case"penumbra":void 0!==this.threeObject.penumbra&&(this.threeObject.penumbra=parseFloat(t));break;case"decay":void 0!==this.threeObject.decay&&(this.threeObject.decay=parseFloat(t))}return this.notifyPropertyChange("light",e,t),!0}getLightProperty(e){if(!this.threeObject||!this.threeObject.isLight)return null;switch(e){case"type":return this.threeObject.type;case"color":return"#"+this.threeObject.color.getHexString();case"intensity":return this.threeObject.intensity;case"distance":return this.threeObject.distance||0;case"angle":return this.threeObject.angle||0;case"penumbra":return this.threeObject.penumbra||0;case"decay":return this.threeObject.decay||1;default:return null}}setCameraProperty(e,t){if(!this.threeObject||!this.threeObject.isCamera)return!1;switch(e){case"fov":this.threeObject.isPerspectiveCamera&&(this.threeObject.fov=parseFloat(t),this.threeObject.updateProjectionMatrix());break;case"near":this.threeObject.near=parseFloat(t),this.threeObject.updateProjectionMatrix();break;case"far":this.threeObject.far=parseFloat(t),this.threeObject.updateProjectionMatrix()}return this.notifyPropertyChange("camera",e,t),!0}getCameraProperty(e){if(!this.threeObject||!this.threeObject.isCamera)return null;switch(e){case"type":return this.threeObject.type;case"fov":return this.threeObject.fov||75;case"near":return this.threeObject.near||.1;case"far":return this.threeObject.far||1e3;default:return null}}setMaterialProperty(e,t){if(!this.threeObject||!this.threeObject.isMesh)return!1;const s=this.threeObject.material;if(!s)return!1;switch(e){case"color":s.color&&s.color.setHex(t.replace("#","0x"));break;case"metalness":void 0!==s.metalness&&(s.metalness=parseFloat(t));break;case"roughness":void 0!==s.roughness&&(s.roughness=parseFloat(t));break;case"emissive":s.emissive&&s.emissive.setHex(t.replace("#","0x"));break;case"emissiveIntensity":void 0!==s.emissiveIntensity&&(s.emissiveIntensity=parseFloat(t));break;case"opacity":s.opacity=parseFloat(t),s.transparent=s.opacity<1}return s.needsUpdate=!0,this.notifyPropertyChange("material",e,t),!0}getMaterialProperty(e){if(!this.threeObject||!this.threeObject.isMesh)return null;const t=this.threeObject.material;if(!t)return null;switch(e){case"color":return t.color?"#"+t.color.getHexString():"#ffffff";case"metalness":return t.metalness||0;case"roughness":return t.roughness||.8;case"emissive":return t.emissive?"#"+t.emissive.getHexString():"#000000";case"emissiveIntensity":return t.emissiveIntensity||0;case"opacity":return t.opacity||1;default:return null}}getObjectInfo(){var e;if(!this.threeObject)return null;return{name:this.threeObject.name||"Unnamed Object",type:this.getObjectType(),id:(null==(e=this.threeObject.userData)?void 0:e.id)||this.threeObject.id,position:{x:this.getTransformProperty("position","x"),y:this.getTransformProperty("position","y"),z:this.getTransformProperty("position","z")},rotation:{x:this.getTransformProperty("rotation","x"),y:this.getTransformProperty("rotation","y"),z:this.getTransformProperty("rotation","z")},scale:{x:this.getTransformProperty("scale","x"),y:this.getTransformProperty("scale","y"),z:this.getTransformProperty("scale","z")}}}dispose(){this.selectedObject=null,this.threeObject=null,this.editorControls=null,this.changeCallbacks=[]}}const mr=e.memo(function({objects:t,walls:s,selectedObject:n,onObjectVisibilityToggle:i,onObjectFreezeToggle:r,onObjectSelect:a,onObjectRemove:o,onObjectFocus:l,onObjectRename:c,onContextMenu:h,editorControls:d,onObjectUpdate:u,onClose:p}){const[m,g]=e.useState("transform"),[f,v]=e.useState(null),[x,b]=e.useState(0),[y,w]=e.useState(0);e.useEffect(()=>{const e=new pr(d);return e.onPropertyChange(e=>{u&&u(e)}),v(e),()=>{e.dispose()}},[d,u]),e.useEffect(()=>{f&&n&&(f.setSelectedObject(n),b(e=>e+1))},[f,n]),e.useEffect(()=>{if(!n||!f)return;const e=setInterval(()=>{if(f.threeObject){const e=Date.now();e-y>100&&(w(e),b(e=>e+1))}},100);return()=>clearInterval(e)},[n,f]);const S=(null==f?void 0:f.getObjectType())||"unknown",j=null==f?void 0:f.getObjectInfo(),M=(()=>{if(!n)return[];const e=[{id:"transform",label:"트랜스폼",icon:"🔄"}];return e.push({id:"object",label:"오브젝트",icon:"📦"}),"mesh"===S&&e.push({id:"material",label:"머티리얼",icon:"🎨"}),"light"===S&&e.push({id:"light",label:"라이트",icon:"💡"}),"camera"===S&&e.push({id:"camera",label:"카메라",icon:"📷"}),e})();e.useEffect(()=>{M.length>0&&!M.some(e=>e.id===m)&&g(M[0].id)},[M,m]);const T=()=>j?Lt.jsxs("div",{className:"transform-properties",children:[Lt.jsxs("div",{className:"transform-row",children:[Lt.jsx("div",{className:"transform-label",children:"Position"}),Lt.jsxs("div",{className:"transform-inputs",children:[Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"X"}),Lt.jsx("input",{type:"number",step:"0.1",value:j.position.x,onChange:e=>null==f?void 0:f.setTransformProperty("position","x",e.target.value)})]}),Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"Y"}),Lt.jsx("input",{type:"number",step:"0.1",value:j.position.y,onChange:e=>null==f?void 0:f.setTransformProperty("position","y",e.target.value)})]}),Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"Z"}),Lt.jsx("input",{type:"number",step:"0.1",value:j.position.z,onChange:e=>null==f?void 0:f.setTransformProperty("position","z",e.target.value)})]})]})]}),Lt.jsxs("div",{className:"transform-row",children:[Lt.jsx("div",{className:"transform-label",children:"Rotation"}),Lt.jsxs("div",{className:"transform-inputs",children:[Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"X"}),Lt.jsx("input",{type:"number",step:"1",value:j.rotation.x,onChange:e=>null==f?void 0:f.setTransformProperty("rotation","x",e.target.value)})]}),Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"Y"}),Lt.jsx("input",{type:"number",step:"1",value:j.rotation.y,onChange:e=>null==f?void 0:f.setTransformProperty("rotation","y",e.target.value)})]}),Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"Z"}),Lt.jsx("input",{type:"number",step:"1",value:j.rotation.z,onChange:e=>null==f?void 0:f.setTransformProperty("rotation","z",e.target.value)})]})]})]}),Lt.jsxs("div",{className:"transform-row",children:[Lt.jsx("div",{className:"transform-label",children:"Scale"}),Lt.jsxs("div",{className:"transform-inputs",children:[Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"X"}),Lt.jsx("input",{type:"number",step:"0.1",min:"0.1",value:j.scale.x,onChange:e=>null==f?void 0:f.setTransformProperty("scale","x",e.target.value)})]}),Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"Y"}),Lt.jsx("input",{type:"number",step:"0.1",min:"0.1",value:j.scale.y,onChange:e=>null==f?void 0:f.setTransformProperty("scale","y",e.target.value)})]}),Lt.jsxs("div",{className:"transform-input-group",children:[Lt.jsx("span",{className:"input-label",children:"Z"}),Lt.jsx("input",{type:"number",step:"0.1",min:"0.1",value:j.scale.z,onChange:e=>null==f?void 0:f.setTransformProperty("scale","z",e.target.value)})]})]})]})]}):Lt.jsx("div",{style:{color:"red",padding:"20px"},children:"objectInfo가 없습니다"});return Lt.jsxs("div",{className:"inspector-panel",children:[Lt.jsxs("div",{className:"inspector-header",children:[Lt.jsx("h3",{children:"인스펙터"}),Lt.jsx("button",{className:"close-btn",onClick:p,children:"×"})]}),Lt.jsxs("div",{className:"inspector-content",children:[Lt.jsxs("div",{className:"hierarchy-section",children:[Lt.jsx("div",{className:"section-header",children:Lt.jsx("h4",{children:"씬 계층구조"})}),Lt.jsx("div",{className:"hierarchy-container",children:Lt.jsx(ur,{objects:t,walls:s,selectedObject:n,onObjectVisibilityToggle:i,onObjectFreezeToggle:r,onObjectSelect:a,onObjectRemove:o,onObjectFocus:l,onObjectRename:c,onContextMenu:h,editorControls:d})})]}),Lt.jsxs("div",{className:"properties-section-wrapper",children:[Lt.jsxs("div",{className:"section-header",children:[Lt.jsx("h4",{children:"속성"}),n&&j&&Lt.jsxs("div",{className:"object-info",children:[Lt.jsx("span",{className:"object-name",children:j.name}),Lt.jsxs("span",{className:"object-type",children:["(",S,")"]})]})]}),n&&M.length>0&&Lt.jsx("div",{className:"properties-tabs",children:M.map(e=>Lt.jsxs("button",{className:"tab-button "+(m===e.id?"active":""),onClick:()=>g(e.id),children:[Lt.jsx("span",{className:"tab-icon",children:e.icon}),Lt.jsx("span",{className:"tab-label",children:e.label})]},e.id))}),Lt.jsx("div",{className:"properties-container",children:(()=>{if(!n)return Lt.jsxs("div",{className:"no-selection",children:[Lt.jsx("div",{className:"no-selection-icon",children:"📦"}),Lt.jsx("div",{className:"no-selection-text",children:"오브젝트를 선택하세요"}),Lt.jsxs("div",{className:"no-selection-hint",children:["씬 계층구조에서 오브젝트를 클릭하거나",Lt.jsx("br",{}),"3D 뷰에서 직접 선택할 수 있습니다"]})]});switch(m){case"transform":default:return T();case"object":return j?Lt.jsxs("div",{className:"object-properties",children:[Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Name"}),Lt.jsx("input",{type:"text",value:j.name,onChange:e=>{(null==f?void 0:f.threeObject)&&(f.threeObject.name=e.target.value,f.notifyPropertyChange("object","name",e.target.value))}})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Type"}),Lt.jsx("span",{className:"readonly-value",children:j.type})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"ID"}),Lt.jsx("span",{className:"readonly-value",children:j.id})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Visible"}),Lt.jsx("input",{type:"checkbox",checked:!1!==(null==(e=null==f?void 0:f.threeObject)?void 0:e.visible),onChange:e=>{(null==f?void 0:f.threeObject)&&(f.threeObject.visible=e.target.checked,f.notifyPropertyChange("object","visible",e.target.checked))}})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Cast Shadow"}),Lt.jsx("input",{type:"checkbox",checked:(null==(t=null==f?void 0:f.threeObject)?void 0:t.castShadow)||!1,onChange:e=>{(null==f?void 0:f.threeObject)&&(f.threeObject.castShadow=e.target.checked,f.notifyPropertyChange("object","castShadow",e.target.checked))}})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Receive Shadow"}),Lt.jsx("input",{type:"checkbox",checked:(null==(s=null==f?void 0:f.threeObject)?void 0:s.receiveShadow)||!1,onChange:e=>{(null==f?void 0:f.threeObject)&&(f.threeObject.receiveShadow=e.target.checked,f.notifyPropertyChange("object","receiveShadow",e.target.checked))}})]})]}):Lt.jsx("div",{style:{color:"red",padding:"20px"},children:"objectInfo가 없습니다"});case"material":return"mesh"!==S?Lt.jsx("div",{className:"not-available",children:"메시 객체가 아닙니다"}):Lt.jsxs("div",{className:"material-properties",children:[Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Color"}),Lt.jsx("input",{type:"color",value:(null==f?void 0:f.getMaterialProperty("color"))||"#ffffff",onChange:e=>null==f?void 0:f.setMaterialProperty("color",e.target.value)})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Metalness"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==f?void 0:f.getMaterialProperty("metalness"))||0,onChange:e=>null==f?void 0:f.setMaterialProperty("metalness",e.target.value)}),Lt.jsx("span",{children:((null==f?void 0:f.getMaterialProperty("metalness"))||0).toFixed(2)})]})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Roughness"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==f?void 0:f.getMaterialProperty("roughness"))||.8,onChange:e=>null==f?void 0:f.setMaterialProperty("roughness",e.target.value)}),Lt.jsx("span",{children:((null==f?void 0:f.getMaterialProperty("roughness"))||.8).toFixed(2)})]})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Emissive"}),Lt.jsx("input",{type:"color",value:(null==f?void 0:f.getMaterialProperty("emissive"))||"#000000",onChange:e=>null==f?void 0:f.setMaterialProperty("emissive",e.target.value)})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Emissive Intensity"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:(null==f?void 0:f.getMaterialProperty("emissiveIntensity"))||0,onChange:e=>null==f?void 0:f.setMaterialProperty("emissiveIntensity",e.target.value)}),Lt.jsx("span",{children:((null==f?void 0:f.getMaterialProperty("emissiveIntensity"))||0).toFixed(2)})]})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Opacity"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==f?void 0:f.getMaterialProperty("opacity"))||1,onChange:e=>null==f?void 0:f.setMaterialProperty("opacity",e.target.value)}),Lt.jsx("span",{children:((null==f?void 0:f.getMaterialProperty("opacity"))||1).toFixed(2)})]})]})]});case"light":return(()=>{if("light"!==S)return Lt.jsx("div",{className:"not-available",children:"라이트 객체가 아닙니다"});const e=null==f?void 0:f.getLightProperty("type");return Lt.jsxs("div",{className:"light-properties",children:[Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Type"}),Lt.jsx("span",{className:"readonly-value",children:e})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Color"}),Lt.jsx("input",{type:"color",value:(null==f?void 0:f.getLightProperty("color"))||"#ffffff",onChange:e=>null==f?void 0:f.setLightProperty("color",e.target.value)})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Intensity"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"0",max:"5",step:"0.1",value:(null==f?void 0:f.getLightProperty("intensity"))||1,onChange:e=>null==f?void 0:f.setLightProperty("intensity",e.target.value)}),Lt.jsx("span",{children:((null==f?void 0:f.getLightProperty("intensity"))||1).toFixed(1)})]})]}),"SpotLight"===e&&Lt.jsxs(Lt.Fragment,{children:[Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Distance"}),Lt.jsx("input",{type:"number",min:"0",step:"1",value:(null==f?void 0:f.getLightProperty("distance"))||0,onChange:e=>null==f?void 0:f.setLightProperty("distance",e.target.value)})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Angle"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"0",max:"1.57",step:"0.01",value:(null==f?void 0:f.getLightProperty("angle"))||0,onChange:e=>null==f?void 0:f.setLightProperty("angle",e.target.value)}),Lt.jsx("span",{children:((null==f?void 0:f.getLightProperty("angle"))||0).toFixed(2)})]})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Penumbra"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==f?void 0:f.getLightProperty("penumbra"))||0,onChange:e=>null==f?void 0:f.setLightProperty("penumbra",e.target.value)}),Lt.jsx("span",{children:((null==f?void 0:f.getLightProperty("penumbra"))||0).toFixed(2)})]})]})]}),("PointLight"===e||"SpotLight"===e)&&Lt.jsxs(Lt.Fragment,{children:["PointLight"===e&&Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Distance"}),Lt.jsx("input",{type:"number",min:"0",step:"1",value:(null==f?void 0:f.getLightProperty("distance"))||0,onChange:e=>null==f?void 0:f.setLightProperty("distance",e.target.value)})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Decay"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"0",max:"3",step:"0.1",value:(null==f?void 0:f.getLightProperty("decay"))||1,onChange:e=>null==f?void 0:f.setLightProperty("decay",e.target.value)}),Lt.jsx("span",{children:((null==f?void 0:f.getLightProperty("decay"))||1).toFixed(1)})]})]})]})]})})();case"camera":return"camera"!==S?Lt.jsx("div",{className:"not-available",children:"카메라 객체가 아닙니다"}):Lt.jsxs("div",{className:"camera-properties",children:[Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Type"}),Lt.jsx("span",{className:"readonly-value",children:null==f?void 0:f.getCameraProperty("type")})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"FOV"}),Lt.jsxs("div",{className:"range-input",children:[Lt.jsx("input",{type:"range",min:"10",max:"120",step:"1",value:(null==f?void 0:f.getCameraProperty("fov"))||75,onChange:e=>null==f?void 0:f.setCameraProperty("fov",e.target.value)}),Lt.jsxs("span",{children:[(null==f?void 0:f.getCameraProperty("fov"))||75,"°"]})]})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Near"}),Lt.jsx("input",{type:"number",min:"0.01",step:"0.01",value:(null==f?void 0:f.getCameraProperty("near"))||.1,onChange:e=>null==f?void 0:f.setCameraProperty("near",e.target.value)})]}),Lt.jsxs("div",{className:"property-group",children:[Lt.jsx("label",{children:"Far"}),Lt.jsx("input",{type:"number",min:"1",step:"1",value:(null==f?void 0:f.getCameraProperty("far"))||1e3,onChange:e=>null==f?void 0:f.setCameraProperty("far",e.target.value)})]})]})}var e,t,s})()})]})]})]})}),gr=({onObjectDrop:t,onClose:s,forceRefresh:n=0})=>{const[i,r]=e.useState(!1),[a,o]=e.useState([]),[l,c]=e.useState([]),h=e.useRef(null),{customMeshes:d,loadCustomMeshes:u}=Vs(),p=e.useRef(cr());e.useEffect(()=>{const e=p.current.getCustomMeshes();u(e)},[u]),e.useEffect(()=>{const e=e=>{const t=p.current.getCustomMeshes();u(t)};return window.addEventListener("customMeshAdded",e),()=>{window.removeEventListener("customMeshAdded",e)}},[u]),e.useEffect(()=>{},[d]),e.useEffect(()=>{(()=>{const e=JSON.parse(localStorage.getItem("customObjects")||"[]");o(e)})()},[n]),e.useEffect(()=>{(async()=>{try{const t=await p.current.loadLibraryMeshes();c(t);for(let s=0;s<t.length;s++){const n=t[s];try{const e=await p.current.generateThumbnailFromURL(n.glbUrl);c(t=>t.map(t=>t.id===n.id?{...t,thumbnail:e,isLoadingThumbnail:!1}:t))}catch(e){c(e=>e.map(e=>e.id===n.id?{...e,isLoadingThumbnail:!1}:e))}}}catch(e){}})()},[]);const m=(e,t)=>{r(!0),h.current=t;let s=t;"custom"===t.type&&(s={...t,type:"custom"});const n=document.createElement("canvas");n.width=50,n.height=50;const i=n.getContext("2d");i.fillStyle="rgba(100, 150, 255, 0.8)",i.fillRect(0,0,50,50),i.fillStyle="white",i.font="12px Arial",i.textAlign="center",i.fillText(t.name,25,30),e.dataTransfer.setDragImage(n,25,25),e.dataTransfer.setData("text/plain",JSON.stringify(s))},g=()=>{r(!1),h.current=null},f=e=>{if(t)if("custom"===e.type)try{const s={...e,type:"custom"};t(s,{x:0,y:0,z:0})}catch(s){alert("커스텀 메쉬를 로드할 수 없습니다. 데이터가 손상되었을 수 있습니다.")}else e.type,t(e,{x:0,y:0,z:0})};return Lt.jsxs("div",{className:"library-panel",children:[Lt.jsxs("div",{className:"library-header",children:[Lt.jsx("h3",{children:"라이브러리"}),Lt.jsx("button",{className:"close-btn",onClick:s,children:Lt.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]}),Lt.jsxs("div",{className:"library-content",children:[Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"기본 도형"}),Lt.jsx("div",{className:"object-grid",children:[{id:"cube",name:"정육면체",type:"basic",geometry:"BoxGeometry",params:[1,1,1]},{id:"sphere",name:"구체",type:"basic",geometry:"SphereGeometry",params:[.5,32,16]},{id:"cylinder",name:"원기둥",type:"basic",geometry:"CylinderGeometry",params:[.5,.5,1,32]},{id:"cone",name:"원뿔",type:"basic",geometry:"ConeGeometry",params:[.5,1,32]},{id:"plane",name:"평면",type:"basic",geometry:"PlaneGeometry",params:[1,1]},{id:"torus",name:"도넛",type:"basic",geometry:"TorusGeometry",params:[.5,.2,16,100]}].map(e=>Lt.jsx("div",{className:"library-item",draggable:!0,onDragStart:t=>m(t,e),onDragEnd:g,onClick:()=>f(e),title:e.name,children:Lt.jsx("div",{className:"library-thumbnail",children:Lt.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:["cube"===e.id&&Lt.jsx("path",{d:"M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L6.04,7.5L12,10.85L17.96,7.5L12,4.15M5,15.91L11,19.29V12.58L5,9.21V15.91M19,15.91V9.21L13,12.58V19.29L19,15.91Z"}),"sphere"===e.id&&Lt.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"}),"cylinder"===e.id&&Lt.jsx("path",{d:"M12,2C8.14,2 5,3.79 5,6V18C5,20.21 8.14,22 12,22C15.86,22 19,20.21 19,18V6C19,3.79 15.86,2 12,2M12,4C14.67,4 17,4.9 17,6C17,7.1 14.67,8 12,8C9.33,8 7,7.1 7,6C7,4.9 9.33,4 12,4M7,9.5C8.21,10.72 9.86,11.26 12,11.26C14.14,11.26 15.79,10.72 17,9.5V18C17,19.1 14.67,20 12,20C9.33,20 7,19.1 7,18V9.5Z"}),"cone"===e.id&&Lt.jsx("path",{d:"M12,2L1,21H23L12,2M12,6L19.53,19H4.47L12,6Z"}),"plane"===e.id&&Lt.jsx("path",{d:"M3,3V21H21V3H3M19,19H5V5H19V19Z"}),"torus"===e.id&&Lt.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"})]})})},e.id))})]}),l.length>0&&Lt.jsx("div",{className:"section-divider"}),l.length>0&&Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"라이브러리 메쉬"}),Lt.jsx("div",{className:"object-grid",children:l.map(e=>Lt.jsx("div",{className:"library-item library-mesh",draggable:!0,onDragStart:t=>m(t,e),onDragEnd:g,onClick:()=>f(e),title:`${e.name} (라이브러리)`,children:Lt.jsx("div",{className:"library-thumbnail",children:e.isLoadingThumbnail?Lt.jsx("div",{className:"thumbnail-loading",children:Lt.jsx("div",{className:"loading-spinner"})}):e.thumbnail?Lt.jsx("img",{src:e.thumbnail,alt:e.name,className:"thumbnail-image"}):Lt.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M12,2L2,7L12,12L22,7L12,2M2,17L12,22L22,17L20.84,16.47L12,21.17L3.16,16.47L2,17Z"})})})},e.id))})]}),Lt.jsx("div",{className:"section-divider"}),Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"커스텀 메쉬"}),Lt.jsx("div",{className:"object-grid",children:d.length>0?d.map(e=>Lt.jsxs("div",{className:"library-item custom-mesh",draggable:!0,onDragStart:t=>m(t,e),onDragEnd:g,onClick:()=>f(e),title:e.name,children:[Lt.jsxs("div",{className:"library-thumbnail",children:[Lt.jsx("img",{src:e.thumbnail,alt:e.name,width:"40",height:"40",onError:e=>{e.target.style.display="none",e.target.nextSibling.style.display="block"}}),Lt.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"currentColor",style:{display:"none"},children:Lt.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})})]}),Lt.jsx("button",{className:"delete-btn",onClick:t=>((e,t)=>{if(t.stopPropagation(),window.confirm(`"${e.name}"을(를) 라이브러리에서 삭제하시겠습니까?`)){p.current.deleteCustomMesh(e.id);const t=p.current.getCustomMeshes();u(t)}})(e,t),title:"삭제",children:Lt.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})})})]},e.id)):Lt.jsx("div",{className:"empty-library"})})]}),a.length>0&&Lt.jsx("div",{className:"section-divider"}),a.length>0&&Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"사용자 정의"}),Lt.jsx("div",{className:"object-grid",children:a.map(e=>Lt.jsxs("div",{className:"library-item custom-object",draggable:!0,onDragStart:t=>m(t,e),onDragEnd:g,onClick:()=>f(e),title:`${e.name} (사용자 정의)`,children:[Lt.jsx("div",{className:"library-thumbnail",children:e.thumbnail?Lt.jsx("img",{src:e.thumbnail,alt:e.name,style:{width:"24px",height:"24px",objectFit:"cover",borderRadius:"2px"}}):Lt.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M12,2L13.09,8.26L22,9L14.74,14.74L17.18,22L12,18.5L6.82,22L9.26,14.74L2,9L10.91,8.26L12,2Z"})})}),Lt.jsx("button",{className:"delete-btn",onClick:t=>((e,t)=>{if(t.stopPropagation(),window.confirm(`"${e.name}"을(를) 라이브러리에서 삭제하시겠습니까?`)){e.glbUrl&&URL.revokeObjectURL(e.glbUrl);const t=JSON.parse(localStorage.getItem("customObjects")||"[]").filter(t=>t.id!==e.id);localStorage.setItem("customObjects",JSON.stringify(t)),o(t)}})(e,t),title:"삭제",children:Lt.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]},e.id))})]})]})]})},fr=({onAssetDrop:e,onClose:t})=>Lt.jsxs("div",{className:"assets-panel",children:[Lt.jsxs("div",{className:"assets-header",children:[Lt.jsx("h3",{children:"기본 에셋"}),Lt.jsx("button",{className:"close-btn",onClick:t,children:Lt.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]}),Lt.jsx("div",{className:"assets-content",children:Lt.jsx("div",{className:"assets-grid",children:[{id:"start_position",name:"스타트 위치",type:"start_position",description:"플레이어 시작 위치 마커"},{id:"point_light",name:"포인트 라이트",type:"point_light",description:"점 조명"},{id:"spot_light",name:"스포트 라이트",type:"spot_light",description:"스포트 조명"},{id:"axes_helper",name:"축 헬퍼",type:"axes_helper",description:"XYZ 축 표시"}].map(t=>Lt.jsx("div",{className:"asset-item",draggable:!0,onDragStart:e=>((e,t)=>{const s=document.createElement("canvas");s.width=50,s.height=50;const n=s.getContext("2d");n.fillStyle="rgba(255, 165, 0, 0.8)",n.fillRect(0,0,50,50),n.fillStyle="white",n.font="12px Arial",n.textAlign="center",n.fillText(t.name.substring(0,6),25,20),n.fillText("Asset",25,35),e.dataTransfer.setDragImage(s,25,25),e.dataTransfer.setData("text/plain",JSON.stringify(t))})(e,t),onClick:()=>(t=>{e&&e(t,{x:0,y:0,z:0})})(t),title:`${t.name}: ${t.description}`,children:Lt.jsx("div",{className:"asset-name",children:t.name})},t.id))})})]}),vr=({postProcessingManager:t,onClose:s})=>{const[n,i]=e.useState({}),[r,a]=e.useState("basic");e.useEffect(()=>{t&&i(t.getSettings())},[t]);const o=e=>{var s;if(!t)return;const r=!(null==(s=n[e])?void 0:s.enabled);t.setEffectEnabled(e,r),i(t=>({...t,[e]:{...t[e],enabled:r}}))},l=(e,s,n)=>{if(!t)return;const r={[s]:n};t.updateEffectSettings(e,r),i(t=>({...t,[e]:{...t[e],[s]:n}}))};return Lt.jsxs("div",{className:"post-processing-panel",children:[Lt.jsxs("div",{className:"panel-header",children:[Lt.jsx("h2",{children:"포스트프로세싱 효과"}),Lt.jsx("button",{className:"close-button",onClick:s,children:"×"})]}),Lt.jsxs("div",{className:"panel-tabs",children:[Lt.jsx("button",{className:"tab-button "+("basic"===r?"active":""),onClick:()=>a("basic"),children:"기본"}),Lt.jsx("button",{className:"tab-button "+("color"===r?"active":""),onClick:()=>a("color"),children:"색상"}),Lt.jsx("button",{className:"tab-button "+("artistic"===r?"active":""),onClick:()=>a("artistic"),children:"아티스틱"})]}),Lt.jsxs("div",{className:"panel-content",children:["basic"===r&&Lt.jsxs("div",{className:"effect-group",children:[Lt.jsx("h3",{children:"기본 효과"}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(c=n.bloom)?void 0:c.enabled)||!1,onChange:()=>o("bloom")}),"Bloom (발광)"]})}),(null==(h=n.bloom)?void 0:h.enabled)&&Lt.jsxs("div",{className:"effect-controls",children:[Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"강도:"}),Lt.jsx("input",{type:"range",min:"0",max:"3",step:"0.1",value:(null==(d=n.bloom)?void 0:d.strength)||1.5,onChange:e=>l("bloom","strength",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(u=n.bloom)?void 0:u.strength)||1.5})]}),Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"반경:"}),Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(p=n.bloom)?void 0:p.radius)||.4,onChange:e=>l("bloom","radius",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(m=n.bloom)?void 0:m.radius)||.4})]}),Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"임계값:"}),Lt.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:(null==(g=n.bloom)?void 0:g.threshold)||.85,onChange:e=>l("bloom","threshold",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(f=n.bloom)?void 0:f.threshold)||.85})]})]})]}),Lt.jsx("div",{className:"effect-item",children:Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(v=n.fxaa)?void 0:v.enabled)||!1,onChange:()=>o("fxaa")}),"FXAA (안티앨리어싱)"]})})}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(x=n.ssao)?void 0:x.enabled)||!1,onChange:()=>o("ssao")}),"SSAO (주변광 차폐)"]})}),(null==(b=n.ssao)?void 0:b.enabled)&&Lt.jsx("div",{className:"effect-controls",children:Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"커널 반경:"}),Lt.jsx("input",{type:"range",min:"1",max:"32",step:"1",value:(null==(y=n.ssao)?void 0:y.kernelRadius)||8,onChange:e=>l("ssao","kernelRadius",parseInt(e.target.value))}),Lt.jsx("span",{children:(null==(w=n.ssao)?void 0:w.kernelRadius)||8})]})})]}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(S=n.outline)?void 0:S.enabled)||!1,onChange:()=>o("outline")}),"Outline (윤곽선)"]})}),(null==(j=n.outline)?void 0:j.enabled)&&Lt.jsxs("div",{className:"effect-controls",children:[Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"강도:"}),Lt.jsx("input",{type:"range",min:"0",max:"10",step:"0.1",value:(null==(M=n.outline)?void 0:M.edgeStrength)||3,onChange:e=>l("outline","edgeStrength",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(T=n.outline)?void 0:T.edgeStrength)||3})]}),Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"두께:"}),Lt.jsx("input",{type:"range",min:"0",max:"4",step:"0.1",value:(null==(C=n.outline)?void 0:C.edgeThickness)||1,onChange:e=>l("outline","edgeThickness",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(A=n.outline)?void 0:A.edgeThickness)||1})]})]})]})]}),"color"===r&&(()=>{var e,t,s,i,r,a,c,h,d,u,p,m,g,f,v,x,b,y,w,S,j,M,T,C,A,E,O,R;return Lt.jsxs("div",{className:"effect-group",children:[Lt.jsx("h3",{children:"색상 효과"}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(e=n.colorCorrection)?void 0:e.enabled)||!1,onChange:()=>o("colorCorrection")}),"Color Correction (색상 보정)"]})}),(null==(t=n.colorCorrection)?void 0:t.enabled)&&Lt.jsx("div",{className:"effect-controls",children:Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"Red Power:"}),Lt.jsx("input",{type:"range",min:"0.1",max:"4",step:"0.1",value:(null==(i=null==(s=n.colorCorrection)?void 0:s.powRGB)?void 0:i.x)||2,onChange:e=>l("colorCorrection","powRGB",{...n.colorCorrection.powRGB,x:parseFloat(e.target.value)})}),Lt.jsx("span",{children:(null==(a=null==(r=n.colorCorrection)?void 0:r.powRGB)?void 0:a.x)||2})]})})]}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(c=n.brightnessContrast)?void 0:c.enabled)||!1,onChange:()=>o("brightnessContrast")}),"Brightness/Contrast (밝기/대비)"]})}),(null==(h=n.brightnessContrast)?void 0:h.enabled)&&Lt.jsxs("div",{className:"effect-controls",children:[Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"밝기:"}),Lt.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:(null==(d=n.brightnessContrast)?void 0:d.brightness)||0,onChange:e=>l("brightnessContrast","brightness",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(u=n.brightnessContrast)?void 0:u.brightness)||0})]}),Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"대비:"}),Lt.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:(null==(p=n.brightnessContrast)?void 0:p.contrast)||0,onChange:e=>l("brightnessContrast","contrast",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(m=n.brightnessContrast)?void 0:m.contrast)||0})]})]})]}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(g=n.hueSaturation)?void 0:g.enabled)||!1,onChange:()=>o("hueSaturation")}),"Hue/Saturation (색조/채도)"]})}),(null==(f=n.hueSaturation)?void 0:f.enabled)&&Lt.jsxs("div",{className:"effect-controls",children:[Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"색조:"}),Lt.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:(null==(v=n.hueSaturation)?void 0:v.hue)||0,onChange:e=>l("hueSaturation","hue",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(x=n.hueSaturation)?void 0:x.hue)||0})]}),Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"채도:"}),Lt.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:(null==(b=n.hueSaturation)?void 0:b.saturation)||0,onChange:e=>l("hueSaturation","saturation",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(y=n.hueSaturation)?void 0:y.saturation)||0})]})]})]}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(w=n.sepia)?void 0:w.enabled)||!1,onChange:()=>o("sepia")}),"Sepia (세피아)"]})}),(null==(S=n.sepia)?void 0:S.enabled)&&Lt.jsx("div",{className:"effect-controls",children:Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"강도:"}),Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(j=n.sepia)?void 0:j.amount)||1,onChange:e=>l("sepia","amount",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(M=n.sepia)?void 0:M.amount)||1})]})})]}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(T=n.vignette)?void 0:T.enabled)||!1,onChange:()=>o("vignette")}),"Vignette (비네트)"]})}),(null==(C=n.vignette)?void 0:C.enabled)&&Lt.jsxs("div",{className:"effect-controls",children:[Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"오프셋:"}),Lt.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:(null==(A=n.vignette)?void 0:A.offset)||1,onChange:e=>l("vignette","offset",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(E=n.vignette)?void 0:E.offset)||1})]}),Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"어둠:"}),Lt.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:(null==(O=n.vignette)?void 0:O.darkness)||1,onChange:e=>l("vignette","darkness",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(R=n.vignette)?void 0:R.darkness)||1})]})]})]})]})})(),"artistic"===r&&(()=>{var e,t,s,i,r,a,c,h,d,u,p,m,g,f,v,x,b,y,w;return Lt.jsxs("div",{className:"effect-group",children:[Lt.jsx("h3",{children:"아티스틱 효과"}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(e=n.film)?void 0:e.enabled)||!1,onChange:()=>o("film")}),"Film (필름 효과)"]})}),(null==(t=n.film)?void 0:t.enabled)&&Lt.jsxs("div",{className:"effect-controls",children:[Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"노이즈:"}),Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(s=n.film)?void 0:s.noiseIntensity)||.5,onChange:e=>l("film","noiseIntensity",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(i=n.film)?void 0:i.noiseIntensity)||.5})]}),Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"스캔라인:"}),Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(r=n.film)?void 0:r.scanlinesIntensity)||.05,onChange:e=>l("film","scanlinesIntensity",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(a=n.film)?void 0:a.scanlinesIntensity)||.05})]}),Lt.jsx("div",{className:"control-row",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(c=n.film)?void 0:c.grayscale)||!1,onChange:e=>l("film","grayscale",e.target.checked)}),"흑백"]})})]})]}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(h=n.pixelate)?void 0:h.enabled)||!1,onChange:()=>o("pixelate")}),"Pixelate (픽셀화)"]})}),(null==(d=n.pixelate)?void 0:d.enabled)&&Lt.jsx("div",{className:"effect-controls",children:Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"픽셀 크기:"}),Lt.jsx("input",{type:"range",min:"2",max:"20",step:"1",value:(null==(u=n.pixelate)?void 0:u.pixelSize)||6,onChange:e=>l("pixelate","pixelSize",parseInt(e.target.value))}),Lt.jsx("span",{children:(null==(p=n.pixelate)?void 0:p.pixelSize)||6})]})})]}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(m=n.dotScreen)?void 0:m.enabled)||!1,onChange:()=>o("dotScreen")}),"Dot Screen (도트 스크린)"]})}),(null==(g=n.dotScreen)?void 0:g.enabled)&&Lt.jsx("div",{className:"effect-controls",children:Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"스케일:"}),Lt.jsx("input",{type:"range",min:"0.1",max:"2",step:"0.1",value:(null==(f=n.dotScreen)?void 0:f.scale)||1,onChange:e=>l("dotScreen","scale",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(v=n.dotScreen)?void 0:v.scale)||1})]})})]}),Lt.jsxs("div",{className:"effect-item",children:[Lt.jsx("div",{className:"effect-header",children:Lt.jsxs("label",{className:"checkbox-label",children:[Lt.jsx("input",{type:"checkbox",checked:(null==(x=n.glitch)?void 0:x.enabled)||!1,onChange:()=>o("glitch")}),"Glitch (글리치)"]})}),(null==(b=n.glitch)?void 0:b.enabled)&&Lt.jsx("div",{className:"effect-controls",children:Lt.jsxs("div",{className:"control-row",children:[Lt.jsx("label",{children:"강도:"}),Lt.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(y=n.glitch)?void 0:y.factor)||.1,onChange:e=>l("glitch","factor",parseFloat(e.target.value))}),Lt.jsx("span",{children:(null==(w=n.glitch)?void 0:w.factor)||.1})]})})]})]})})()]})]});var c,h,d,u,p,m,g,f,v,x,b,y,w,S,j,M,T,C,A};function xr({scene:t,onClose:s}){const n=Vs(e=>e.hdriSettings),i=Vs(e=>e.updateHDRISettings),r=Vs(e=>e.sunLightRef);Vs(e=>e.setSunLightRef);const a=Vs(e=>e.saveHDRISettings),[o,l]=e.useState(!1),[c,d]=e.useState(null),u=e.useRef(null),{currentHDRI:p,hdriIntensity:m,hdriRotation:g,sunLightEnabled:f,sunIntensity:v,timeOfDay:x,sunAzimuth:b,sunElevation:y,sunColor:w}=n,S=(e,t="info")=>{d({message:e,type:t}),setTimeout(()=>d(null),3e3)},j=async(e,s)=>{if(!t)throw new Error("씬이 초기화되지 않았습니다");const n=new Promise((e,t)=>{setTimeout(()=>t(new Error("로드 시간 초과")),3e4)});try{const r=await Promise.race([M(e),n]);r.mapping=Ct,(null==p?void 0:p.texture)&&p.texture.dispose(),t.environment=r,t.background=r,void 0!==t.backgroundIntensity&&(t.backgroundIntensity=m),void 0!==t.environmentIntensity&&(t.environmentIntensity=m),i({currentHDRI:{name:s,texture:r,url:e}})}catch(r){if(e.startsWith("blob:")&&URL.revokeObjectURL(e),r.message.includes("Bad File Format"))try{const n=await T(e);return n.mapping=Ct,(null==p?void 0:p.texture)&&p.texture.dispose(),t.environment=n,t.background=n,void i({currentHDRI:{name:s+" (폴백)",texture:n,url:e}})}catch(a){}throw r}},M=async e=>{const t=new dr;return new Promise((s,n)=>{t.load(e,e=>{e&&e.image?s(e):n(new Error("텍스처 데이터가 유효하지 않습니다"))},void 0,e=>{n(e)})})},T=async e=>{const t=new F;return new Promise((s,n)=>{t.load(e,e=>{e&&e.image?s(e):n(new Error("폴백 텍스처 데이터가 유효하지 않습니다"))},void 0,e=>{n(e)})})},C=(e,t,s)=>{const n=t*Math.PI/180,i=s*Math.PI/180,r=Math.sin(n)*Math.cos(i)*100,a=100*Math.sin(i),o=Math.cos(n)*Math.cos(i)*100;e.position.set(r,a,o),e.lookAt(0,0,0)},A=e=>{i({timeOfDay:e}),r&&(e=>{let t="#ffffff";t=e>=5&&e<7?"#ff6b47":e>=7&&e<10?"#ffaa80":e>=10&&e<16?"#ffffff":e>=16&&e<18?"#ffcc99":e>=18&&e<20?"#ff8c66":"#4a6fa5",i({sunColor:t}),r&&r.color.setHex(t.replace("#","0x"))})(e)};return e.useEffect(()=>()=>{},[t]),e.useEffect(()=>{t&&setTimeout(()=>a(),100)},[n,t,a]),e.useEffect(()=>{t&&p&&p.type&&p.texture&&"none"!==p.type&&(void 0!==t.backgroundIntensity&&(t.backgroundIntensity=m),void 0!==t.environmentIntensity&&(t.environmentIntensity=m),p.texture.rotation=g*Math.PI/180)},[t,p,m,g]),Lt.jsxs("div",{className:"hdri-panel",children:[Lt.jsxs("div",{className:"hdri-header",children:[Lt.jsx("h3",{children:"HDRI 환경"}),Lt.jsxs("div",{className:"header-controls",children:[Lt.jsx("span",{className:"auto-save-indicator",title:"설정이 자동으로 저장됩니다",children:"💾"}),Lt.jsx("button",{className:"close-btn",onClick:s,children:Lt.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]})]}),Lt.jsxs("div",{className:"hdri-content",children:[Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"현재 환경"}),Lt.jsx("div",{className:"current-hdri-display",children:p?Lt.jsx("span",{className:"hdri-name",children:p.name}):Lt.jsx("span",{className:"no-hdri",children:"환경 없음"})})]}),Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"환경맵 업로드"}),Lt.jsx("input",{type:"file",ref:u,onChange:async e=>{const t=e.target.files[0];if(!t)return;const s=[".hdr",".exr",".hdri"],n=[...s,".jpg",".jpeg",".png",".webp",".bmp"],i=t.name.toLowerCase().substring(t.name.lastIndexOf("."));if(!n.includes(i))return void S("지원하는 형식: HDRI(.hdr, .exr, .hdri) 또는 이미지(.jpg, .png, .webp)","error");if(t.size>209715200)return void S("파일 크기가 너무 큽니다 (최대 200MB)","error");if(t.size<100)return void S("파일이 너무 작습니다","error");const r=s.includes(i);if(r)try{const e=await t.slice(0,20).arrayBuffer(),s=new Uint8Array(e),n=String.fromCharCode(...s.slice(0,20));if(".hdr"===i){n.includes("#?RADIANCE")||n.includes("#?RGBE")||n.includes("RADIANCE")||35===s[0]||S("HDR 파일 형식이 표준과 다를 수 있습니다. 일반 이미지로 시도합니다.","info")}}catch(a){}else S("일반 이미지 파일을 환경맵으로 사용합니다","info");l(!0);try{const e=URL.createObjectURL(t);await j(e,t.name),S((r?"HDRI":"이미지")+" 환경이 로드되었습니다","success")}catch(o){let e="파일을 로드할 수 없습니다";o.message.includes("Bad File Format")?e="파일 형식을 읽을 수 없습니다. 다른 파일을 시도해보세요.":o.message.includes("network")?e="네트워크 오류로 파일을 로드할 수 없습니다":o.message.includes("로드 시간 초과")&&(e="파일 로드 시간이 초과되었습니다"),S(e,"error")}finally{l(!1),e.target.value=""}},accept:".hdr,.exr,.hdri,.jpg,.jpeg,.png,.webp,.bmp",style:{display:"none"}}),Lt.jsxs("button",{className:"hdri-upload-btn",onClick:()=>{var e;return null==(e=u.current)?void 0:e.click()},disabled:o,children:[Lt.jsx("div",{className:"upload-icon",children:Lt.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})})}),Lt.jsx("span",{children:o?"로딩중...":"파일 선택"})]}),Lt.jsx("div",{className:"upload-hint",children:".hdr, .exr, .hdri 지원"})]}),Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"기본 환경"}),Lt.jsx("div",{className:"hdri-grid",children:[{name:"컨트리 로드",type:"preset",url:"/hdr/sunny_country_road_2k.hdr",description:"햇살 좋은 시골길"},{name:"기본 스카이박스",type:"gradient",description:"그라디언트 스카이박스"},{name:"기본 배경",type:"none",description:"회색 배경"}].map((e,s)=>Lt.jsxs("div",{className:"hdri-item "+((null==p?void 0:p.name)===e.name?"active":""),onClick:()=>(async(e,s=null)=>{if(t)switch(e){case"preset":if(s&&s.url)try{l(!0),await j(s.url,s.name),S(`${s.name} 환경이 적용되었습니다`,"success")}catch(n){S("프리셋 환경을 로드할 수 없습니다","error")}finally{l(!1)}break;case"gradient":t.background&&t.background.isTexture&&t.background.dispose(),t.background=new h(8900331),t.environment=null,i({currentHDRI:{name:"기본 스카이박스",type:"gradient"}});break;case"none":t.background&&t.background.isTexture&&t.background.dispose(),t.background=new h(2763306),t.environment=null,i({currentHDRI:{name:"기본 배경",type:"none"}})}})(e.type,e),title:e.description,children:[Lt.jsx("div",{className:"hdri-thumbnail",children:Lt.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:["preset"===e.type&&Lt.jsx("path",{d:"M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V10.5L17.5,9L16,10.5L14.5,9L11.5,12L9,9.5L7.5,11L6,9.5L5,10.5V5H19Z"}),"gradient"===e.type&&Lt.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"}),"none"===e.type&&Lt.jsx("path",{d:"M3,4H7V8H3V4M9,5V7H21V5H9M3,10H7V14H3V10M9,11V13H21V11H9M3,16H7V20H3V16M9,17V19H21V17H9"})]})}),Lt.jsx("div",{className:"hdri-label",children:e.name})]},s))})]}),p&&"none"!==p.type&&Lt.jsx("div",{className:"section-divider"}),p&&"none"!==p.type&&Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"환경 설정"}),Lt.jsxs("div",{className:"setting-item",children:[Lt.jsx("label",{children:"강도"}),Lt.jsxs("div",{className:"slider-container",children:[Lt.jsx("input",{type:"range",min:"0",max:"3",step:"0.1",value:m,onChange:e=>{return s=parseFloat(e.target.value),i({hdriIntensity:s}),void(t&&p&&p.texture&&"none"!==p.type&&(t.backgroundIntensity=s,t.environmentIntensity=s));var s},className:"hdri-slider"}),Lt.jsx("span",{className:"slider-value",children:m.toFixed(1)})]})]}),Lt.jsxs("div",{className:"setting-item",children:[Lt.jsx("label",{children:"회전"}),Lt.jsxs("div",{className:"slider-container",children:[Lt.jsx("input",{type:"range",min:"0",max:"360",step:"1",value:g,onChange:e=>{return s=parseFloat(e.target.value),i({hdriRotation:s}),void(t&&p&&p.texture&&"none"!==p.type&&(p.texture.rotation=s*Math.PI/180));var s},className:"hdri-slider"}),Lt.jsxs("span",{className:"slider-value",children:[g,"°"]})]})]})]}),Lt.jsxs("div",{className:"category-section",children:[Lt.jsx("h4",{className:"category-title",children:"태양 조명"}),Lt.jsxs("div",{className:"setting-item",children:[Lt.jsx("label",{children:"활성화"}),Lt.jsx("input",{type:"checkbox",checked:f,onChange:e=>{return t=e.target.checked,void i({sunLightEnabled:t});var t},className:"setting-checkbox"})]}),f&&Lt.jsxs(Lt.Fragment,{children:[Lt.jsxs("div",{className:"setting-item",children:[Lt.jsx("label",{children:"시간"}),Lt.jsxs("div",{className:"slider-container",children:[Lt.jsx("input",{type:"range",min:"0",max:"24",step:"0.5",value:x,onChange:e=>A(Number(e.target.value)),className:"hdri-slider"}),Lt.jsxs("span",{className:"slider-value",children:[x,"시"]})]})]}),Lt.jsxs("div",{className:"setting-item",children:[Lt.jsx("label",{children:"강도"}),Lt.jsxs("div",{className:"slider-container",children:[Lt.jsx("input",{type:"range",min:"0",max:"20",step:"0.1",value:v,onChange:e=>{return t=Number(e.target.value),i({sunIntensity:t}),void(r&&(r.intensity=t));var t},className:"hdri-slider"}),Lt.jsx("span",{className:"slider-value",children:v})]})]}),Lt.jsxs("div",{className:"setting-item",children:[Lt.jsx("label",{children:"방위각"}),Lt.jsxs("div",{className:"slider-container",children:[Lt.jsx("input",{type:"range",min:"0",max:"360",step:"1",value:b,onChange:e=>{return t=Number(e.target.value),i({sunAzimuth:t}),void(r&&C(r,t,y));var t},className:"hdri-slider"}),Lt.jsxs("span",{className:"slider-value",children:[b,"°"]})]})]}),Lt.jsxs("div",{className:"setting-item",children:[Lt.jsx("label",{children:"고도각"}),Lt.jsxs("div",{className:"slider-container",children:[Lt.jsx("input",{type:"range",min:"0",max:"90",step:"1",value:y,onChange:e=>{return t=Number(e.target.value),i({sunElevation:t}),void(r&&C(r,b,t));var t},className:"hdri-slider"}),Lt.jsxs("span",{className:"slider-value",children:[y,"°"]})]})]}),Lt.jsxs("div",{className:"setting-item",children:[Lt.jsx("label",{children:"색상"}),Lt.jsx("div",{className:"color-preview",style:{backgroundColor:w,padding:"4px 8px",borderRadius:"4px",fontSize:"12px",textAlign:"center"},children:x<6||x>20?"밤":x<10?"아침":x<16?"낮":"저녁"})]})]})]})]}),c&&Lt.jsx("div",{className:`hdri-toast hdri-toast-${c.type}`,children:c.message})]})}const br=({x:t,y:s,isVisible:n,onClose:i,selectedObject:r,onAddToLibrary:a})=>{const o=e.useRef(null);if(e.useEffect(()=>{const e=e=>{o.current&&!o.current.contains(e.target)&&i()},t=e=>{"Escape"===e.key&&i()};if(n)return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[n,i]),!n)return null;const l=Math.min(t,window.innerWidth-200),c=Math.min(s,window.innerHeight-150);return Lt.jsxs("div",{ref:o,className:"context-menu",style:{left:l,top:c},children:[Lt.jsx("div",{className:"context-menu-header",children:Lt.jsx("span",{children:"메쉬 옵션"})}),Lt.jsxs("div",{className:"context-menu-items",children:[Lt.jsxs("button",{className:"context-menu-item",onClick:()=>{r&&a&&a(r),i()},children:[Lt.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})}),Lt.jsx("span",{children:"라이브러리에 추가"})]}),Lt.jsxs("button",{className:"context-menu-item disabled",disabled:!0,children:[Lt.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"})}),Lt.jsx("span",{children:"복제 (곧 제공)"})]}),Lt.jsxs("button",{className:"context-menu-item disabled",disabled:!0,children:[Lt.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})}),Lt.jsx("span",{children:"삭제 (곧 제공)"})]})]}),r&&Lt.jsx("div",{className:"context-menu-info",children:Lt.jsx("span",{className:"selected-object-name",children:r.name||"이름 없음"})})]})},yr=({message:t,type:s="info",isVisible:n,onClose:i})=>{if(e.useEffect(()=>{if(n){const e=setTimeout(()=>{i()},3e3);return()=>clearTimeout(e)}},[n,i]),!n)return null;return Lt.jsxs("div",{className:`toast toast-${s} ${n?"toast-visible":""}`,children:[Lt.jsx("div",{className:"toast-icon",children:(()=>{switch(s){case"success":return"✓";case"error":return"✕";case"warning":return"⚠";default:return"ℹ"}})()}),Lt.jsx("div",{className:"toast-message",children:t}),Lt.jsx("button",{className:"toast-close",onClick:i,children:"×"})]})};function wr({editorControls:t,postProcessingManager:s,onAddToLibrary:n,showInspector:i,onToggleInspector:r}){const{selectedObject:a,transformMode:o,objects:l,walls:c,savedObjects:h,setTransformMode:d,addWall:u,addObject:p,removeObject:m,addAsset:g,saveMap:f,loadMap:v,clearMap:x,toggleObjectVisibility:b,toggleObjectFreeze:y,renameObject:w,setSelectedObject:S}=Vs();e.useState(""),e.useState("");const[j,M]=e.useState(!1),[T,C]=e.useState(!1),[A,E]=e.useState(!1),[O,R]=e.useState(!1),[D,_]=e.useState(!1),[N,P]=e.useState({isVisible:!1,x:0,y:0}),[k,L]=e.useState(0),[I,z]=e.useState({message:"",type:"info",isVisible:!1});e.useEffect(()=>{const e=e=>{"f"!==e.key&&"F"!==e.key||(e.preventDefault(),(null==a?void 0:a.id)&&B(a))},t=e=>{(e=>{a&&(e.preventDefault(),P({isVisible:!0,x:e.clientX,y:e.clientY}))})(e.detail.originalEvent)};return window.addEventListener("keydown",e),window.addEventListener("editorContextMenu",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("editorContextMenu",t)}},[a]);const F=e=>{if(!e)return t&&t.deselectAllObjects(),void S(null);if(t){const s=t.findObjectById(e.id);s&&t.selectObject(s)}S(e)},B=e=>{if(F(e),t){const s=t.findObjectById(e.id);s&&t.focusOnObject(s)}};return Lt.jsxs("div",{className:"editor-ui",children:[Lt.jsx("div",{className:"tool-panel",children:Lt.jsxs("div",{className:"tool-section",children:[Lt.jsx("button",{className:"tool-btn assets-btn "+(T?"active":""),onClick:()=>{C(!T),j&&M(!1),D&&_(!1),O&&R(!1)},title:"기본 에셋",children:Lt.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M12,2L13.09,8.26L22,9L14.74,14.74L17.18,22L12,18.5L6.82,22L9.26,14.74L2,9L10.91,8.26L12,2Z"})})}),Lt.jsx("button",{className:"tool-btn library-btn "+(j?"active":""),onClick:()=>{M(!j),T&&C(!1),D&&_(!1),O&&R(!1)},title:"라이브러리",children:Lt.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M4,6H20V8H4V6M4,11H20V13H4V11M4,16H20V18H4V16Z"})})}),Lt.jsx("button",{className:"tool-btn post-processing-btn "+(D?"active":""),onClick:()=>{_(!D),j&&M(!1),T&&C(!1),O&&R(!1)},title:"포스트프로세싱 효과",children:Lt.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M9,12L11,14L15,10L20,15H4L9,12Z"})})}),Lt.jsx("button",{className:"tool-btn hdri-btn "+(O?"active":""),onClick:()=>{R(!O),j&&M(!1),T&&C(!1),D&&_(!1)},title:"HDRI 환경",children:Lt.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:Lt.jsx("path",{d:"M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,6.65C6.9,7.16 6.36,7.78 5.94,8.5C5.5,9.24 5.25,10 5.11,10.79L3.34,7M3.36,17L5.12,13.23C5.26,14 5.53,14.78 5.95,15.5C6.37,16.24 6.91,16.86 7.5,17.37L3.36,17M20.65,7L18.88,10.79C18.74,10 18.47,9.23 18.05,8.5C17.63,7.78 17.1,7.15 16.5,6.64L20.65,7M20.64,17L16.5,17.36C17.09,16.85 17.62,16.22 18.04,15.5C18.46,14.77 18.73,14 18.87,13.21L20.64,17Z"})})}),D&&Lt.jsx(vr,{postProcessingManager:s,onClose:()=>_(!1)})]})}),T&&Lt.jsx(fr,{onAssetDrop:(e,t)=>{let s;switch(e.type){case"start_position":s={id:Date.now(),type:"start_position",name:e.name,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},color:65280,geometry:"marker"};break;case"directional_light":s={id:Date.now(),type:"directional_light",name:e.name,position:t||{x:5,y:10,z:5},rotation:{x:-Math.PI/4,y:Math.PI/4,z:0},scale:{x:1,y:1,z:1},intensity:1,color:16777215,castShadow:!0};break;case"point_light":s={id:Date.now(),type:"point_light",name:e.name,position:t||{x:0,y:3,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},intensity:1,color:16777215,distance:10,decay:2};break;case"spot_light":s={id:Date.now(),type:"spot_light",name:e.name,position:t||{x:0,y:5,z:0},rotation:{x:-Math.PI/2,y:0,z:0},scale:{x:1,y:1,z:1},intensity:1,color:16777215,distance:10,angle:Math.PI/6,penumbra:.1};break;case"ambient_light":s={id:Date.now(),type:"ambient_light",name:e.name,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},intensity:.3,color:4210752};break;case"audio_source":s={id:Date.now(),type:"audio_source",name:e.name,position:t||{x:0,y:1,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},volume:1,loop:!1,autoplay:!1};break;default:s={id:Date.now(),type:e.type,name:e.name,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}}}p(s),setTimeout(()=>{S(s)},100),((e,t="info")=>{z({message:e,type:t,isVisible:!0}),setTimeout(()=>{z(e=>({...e,isVisible:!1}))},3e3)})(`${e.name}이(가) 씬에 추가되었습니다.`,"success")},onClose:()=>C(!1)}),j&&Lt.jsx(gr,{onObjectDrop:(e,t)=>{let s;s="library"===e.type?{id:Date.now(),type:"glb",url:e.glbUrl,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:e.name}:"custom"===e.type?{id:Date.now(),type:"glb",glbData:e.glbData,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:e.name}:{id:Date.now(),type:e.type||"basic",geometry:e.geometry,params:e.params,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:e.name},p(s),setTimeout(()=>{S(s)},100)},onClose:()=>M(!1),forceRefresh:k}),A&&Lt.jsx(vr,{postProcessingManager:s,isVisible:A}),O&&Lt.jsx(xr,{scene:null==t?void 0:t.scene,onClose:()=>R(!1)}),Lt.jsx(yr,{message:I.message,type:I.type,isVisible:I.isVisible,onClose:()=>{z(e=>({...e,isVisible:!1}))}}),Lt.jsx(br,{x:N.x,y:N.y,isVisible:N.isVisible,onClose:()=>{P({isVisible:!1,x:0,y:0})},selectedObject:a,onAddToLibrary:n}),i&&Lt.jsx(mr,{objects:l,walls:c,selectedObject:a,onObjectVisibilityToggle:e=>{b(e)},onObjectFreezeToggle:e=>{y(e)},onObjectSelect:F,onObjectRemove:e=>{if(t&&t.objectSelector){if(t.objectSelector.transformControls)try{t.objectSelector.transformControls.detach()}catch(s){}try{const s=t.findObjectById(e.id);s&&t.objectSelector.removeSelectionOutline(s)}catch(s){}}if(a&&a.id===e.id){if(t)try{t.deselectAllObjects()}catch(s){}S(null)}setTimeout(()=>{try{m(e)}catch(s){}},50)},onObjectFocus:B,onObjectRename:(e,t)=>{if(w(e.id,t),(null==a?void 0:a.id)===e.id){const e={...a,name:t};S(e)}},onContextMenu:(e,t)=>{e.preventDefault(),F(t),P({isVisible:!0,x:e.clientX,y:e.clientY})},editorControls:t,onObjectUpdate:e=>{if(t&&e.id){const s=t.findObjectById(e.id);s&&(e.position&&s.position.set(e.position.x,e.position.y,e.position.z),e.rotation&&s.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),e.scale&&s.scale.set(e.scale.x,e.scale.y,e.scale.z),e.name&&(s.name=e.name))}(null==a?void 0:a.id)===e.id&&S(e)},onClose:()=>r(!1)})]})}const Sr=({onMenuAction:t})=>{const[n,i]=e.useState(null),r=e=>{e.target.closest(".menu-bar")||i(null)};return s.useEffect(()=>(document.addEventListener("click",r),()=>{document.removeEventListener("click",r)}),[]),Lt.jsx("div",{className:"menu-bar",children:Lt.jsx("div",{className:"menu-items",children:[{title:"파일",items:[{label:"새 맵",action:"new-map",shortcut:"Ctrl+N"},{label:"불러오기",action:"load-map",shortcut:"Ctrl+O"},{label:"저장하기",action:"save-map",shortcut:"Ctrl+S"},{type:"separator"},{label:"임포트",action:"import"},{label:"익스포트",action:"export"},{type:"separator"},{label:"나가기",action:"exit",shortcut:"Alt+F4"}]},{title:"에디터",items:[{label:"실행 취소",action:"undo",shortcut:"Ctrl+Z"},{label:"다시 실행",action:"redo",shortcut:"Ctrl+Y"},{type:"separator"},{label:"복사",action:"copy",shortcut:"Ctrl+C"},{label:"붙여넣기",action:"paste",shortcut:"Ctrl+V"},{label:"삭제",action:"delete",shortcut:"Delete"},{type:"separator"},{label:"전체 선택",action:"select-all",shortcut:"Ctrl+A"},{label:"선택 해제",action:"deselect-all",shortcut:"Ctrl+D"}]},{title:"윈도우",items:[{label:"뷰포트 리셋",action:"reset-viewport"},{label:"카메라 리셋",action:"reset-camera"},{type:"separator"},{label:"그리드 토글",action:"toggle-grid"},{label:"통계 표시",action:"toggle-stats"},{type:"separator"},{label:"인스펙터",action:"toggle-inspector",shortcut:"I"},{type:"separator"},{label:"전체화면",action:"fullscreen",shortcut:"F11"}]},{title:"정보",items:[{label:"단축키",action:"show-shortcuts"},{label:"도움말",action:"show-help",shortcut:"F1"},{type:"separator"},{label:"프로그램 정보",action:"about"}]}].map((e,s)=>Lt.jsxs("div",{className:"menu-item "+(n===s?"active":""),onClick:()=>{var e;i(n===(e=s)?null:e)},children:[Lt.jsx("span",{className:"menu-title",children:e.title}),n===s&&Lt.jsx("div",{className:"dropdown-menu",children:e.items.map((e,s)=>"separator"===e.type?Lt.jsx("div",{className:"menu-separator"},s):Lt.jsxs("div",{className:"dropdown-item",onClick:s=>{var n;s.stopPropagation(),n=e.action,i(null),t&&t(n)},children:[Lt.jsx("span",{className:"item-label",children:e.label}),e.shortcut&&Lt.jsx("span",{className:"item-shortcut",children:e.shortcut})]},s))})]},s))})})};function jr({editorControls:e}){const{isWireframe:t,isGridSnap:s,isGridVisible:n,gizmoSpace:i,isMagnetEnabled:r,showMagnetRays:a,toggleWireframe:o,toggleGridSnap:l,toggleGridVisible:c,toggleGizmoSpace:h,toggleMagnet:d,toggleMagnetRays:u}=Vs();return Lt.jsxs("div",{className:"viewport-controls",children:[Lt.jsx("button",{className:"viewport-control-btn "+(t?"active":""),onClick:()=>{o(),e&&e.updateWireframe()},title:"렌더링 모드 (와이어프레임)",children:Lt.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Lt.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),Lt.jsx("path",{d:"M2 17l10 5 10-5"}),Lt.jsx("path",{d:"M2 12l10 5 10-5"})]})}),Lt.jsx("button",{className:"viewport-control-btn "+(s?"active":""),onClick:()=>{l(),e&&e.updateGridSnap()},title:"그리드 스냅",children:Lt.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Lt.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),Lt.jsx("path",{d:"M9 9h6v6H9z"}),Lt.jsx("path",{d:"M3 9h18"}),Lt.jsx("path",{d:"M3 15h18"}),Lt.jsx("path",{d:"M9 3v18"}),Lt.jsx("path",{d:"M15 3v18"})]})}),Lt.jsx("button",{className:"viewport-control-btn "+(n?"active":""),onClick:()=>{c(),e&&e.toggleGrid()},title:"그리드 표시/숨기기",children:Lt.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Lt.jsx("path",{d:"M3 3h18v18H3z"}),Lt.jsx("path",{d:"M8 3v18"}),Lt.jsx("path",{d:"M13 3v18"}),Lt.jsx("path",{d:"M18 3v18"}),Lt.jsx("path",{d:"M3 8h18"}),Lt.jsx("path",{d:"M3 13h18"}),Lt.jsx("path",{d:"M3 18h18"})]})}),Lt.jsx("button",{className:"viewport-control-btn "+("local"===i?"active":""),onClick:()=>{h(),e&&e.updateGizmoSpace()},title:`기즈모 좌표계 (${"world"===i?"월드":"로컬"})`,children:Lt.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:"world"===i?Lt.jsxs(Lt.Fragment,{children:[Lt.jsx("circle",{cx:"12",cy:"12",r:"9"}),Lt.jsx("path",{d:"M12 3v18"}),Lt.jsx("path",{d:"M3 12h18"}),Lt.jsx("path",{d:"M8 8l8 8"}),Lt.jsx("path",{d:"M16 8l-8 8"})]}):Lt.jsxs(Lt.Fragment,{children:[Lt.jsx("rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}),Lt.jsx("path",{d:"M12 4v16"}),Lt.jsx("path",{d:"M4 12h16"}),Lt.jsx("circle",{cx:"12",cy:"12",r:"2"})]})})}),Lt.jsx("button",{className:"viewport-control-btn "+(r?"active":""),onClick:()=>{d(),e&&e.updateMagnet()},title:"자석 모드 (메쉬 표면에 스냅)",children:Lt.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Lt.jsx("path",{d:"M6 15l6-6 6 6"}),Lt.jsx("path",{d:"M6 8h12"}),Lt.jsx("circle",{cx:"12",cy:"17",r:"2"}),Lt.jsx("path",{d:"M8 12L12 8l4 4"})]})}),Lt.jsx("button",{className:"viewport-control-btn "+(a?"active":""),onClick:()=>{u(),e&&e.updateMagnetRays()},title:"자석 레이 표시",children:Lt.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Lt.jsx("circle",{cx:"12",cy:"12",r:"3"}),Lt.jsx("path",{d:"M12 1v6"}),Lt.jsx("path",{d:"M12 17v6"}),Lt.jsx("path",{d:"M4.22 4.22l4.24 4.24"}),Lt.jsx("path",{d:"M15.54 15.54l4.24 4.24"}),Lt.jsx("path",{d:"M1 12h6"}),Lt.jsx("path",{d:"M17 12h6"}),Lt.jsx("path",{d:"M4.22 19.78l4.24-4.24"}),Lt.jsx("path",{d:"M15.54 8.46l4.24-4.24"})]})})]})}const Mr="새 맵을 만들면 현재 작업이 사라집니다. 계속하시겠습니까?",Tr="익스포트 기능은 준비 중입니다.",Cr="에디터를 종료하시겠습니까?",Ar="실행 취소 기능은 준비 중입니다.",Er="다시 실행 기능은 준비 중입니다.",Or="전체 선택 기능은 준비 중입니다.",Rr="선택 해제 기능은 준비 중입니다.",Dr="뷰포트 리셋 기능은 준비 중입니다.",_r="카메라 리셋: 키패드 0번을 누르세요.",Nr="통계 표시 기능은 준비 중입니다.",Pr="단축키 정보:\nW/E/R: 기즈모 모드\nF: 오브젝트 포커스\nESC: 선택 해제\n키패드 0: 카메라 리셋\n키패드 5: 카메라 모드 토글\n키패드 1/3/7/9: 뷰 변경",kr="도움말:\n• 좌클릭: 오브젝트 선택\n• Shift+좌클릭: 다중 선택\n• 중간클릭: 팬 이동\n• Alt+중간클릭: 카메라 회전\n• 마우스 휠: 줌",Lr="ThirdPersonTreeJS Editor\nVersion 1.0.0\n3D 에디터 프로그램";function Ir(){const t=n(),{clearMap:s,saveMap:i,loadMap:r,addObject:a,setSelectedObject:o,addCustomMesh:l,selectedObject:c,toggleGridVisible:d,scene:u,hdriSettings:p,sunLightRef:m,setSunLightRef:f,saveHDRISettings:v,objects:x,copyObject:b,pasteObject:y,deleteSelectedObject:w,hasClipboardData:S}=Vs(),[j,M]=e.useState(null),[T,C]=e.useState(""),[A,E]=e.useState(null),[O,R]=e.useState(!0),D=e.useRef(null),_=e.useRef(null),N=e.useRef(cr());e.useEffect(()=>{u&&p.sunLightEnabled&&!m?P():u&&!p.sunLightEnabled&&m&&k()},[u,p.sunLightEnabled,m]),e.useEffect(()=>{u&&p.currentHDRI&&"none"===p.currentHDRI.type&&(u.background=new h(2763306),u.environment=null)},[u,p.currentHDRI]),e.useEffect(()=>{const e=e=>{var t;if("i"!==e.key&&"I"!==e.key||e.ctrlKey||e.altKey||e.shiftKey||(e.preventDefault(),R(e=>!e)),e.ctrlKey&&("c"===e.key||"C"===e.key))if(e.preventDefault(),c){let e=null;if(D.current){const s=c.id||c;e=D.current.findObjectById(s),!e&&(null==(t=D.current.selectedObjects)?void 0:t.length)>0&&(e=D.current.selectedObjects[0])}e?(b(e),E({message:`"${e.name}"이(가) 복사되었습니다`,type:"success"}),setTimeout(()=>E(null),2e3)):(b(c),E({message:`"${c.name}"이(가) 복사되었습니다`,type:"success"}),setTimeout(()=>E(null),2e3))}else E({message:"복사할 객체를 먼저 선택해주세요",type:"warning"}),setTimeout(()=>E(null),2e3);if(e.ctrlKey&&("v"===e.key||"V"===e.key))if(e.preventDefault(),S()){const e=y();e?(E({message:`"${e.name}"이(가) 붙여넣기되었습니다`,type:"success"}),setTimeout(()=>E(null),2e3)):(E({message:"붙여넣기에 실패했습니다",type:"error"}),setTimeout(()=>E(null),2e3))}else E({message:"붙여넣을 객체가 클립보드에 없습니다",type:"warning"}),setTimeout(()=>E(null),2e3);if("Delete"===e.key)if(e.preventDefault(),c){const e=x.find(e=>e.id===c);if(e){const t=e.name;w(),E({message:`"${t}"이(가) 삭제되었습니다`,type:"success"}),setTimeout(()=>E(null),2e3)}else E({message:"삭제할 객체를 찾을 수 없습니다",type:"error"}),setTimeout(()=>E(null),2e3)}else E({message:"삭제할 객체를 먼저 선택해주세요",type:"warning"}),setTimeout(()=>E(null),2e3)};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[c,x,b,y,w,S,E]);const P=()=>{if(!u)return;const e=new g(p.sunColor,p.sunIntensity),t=p.sunAzimuth*Math.PI/180,s=p.sunElevation*Math.PI/180,n=Math.sin(t)*Math.cos(s)*100,i=100*Math.sin(s),r=Math.cos(t)*Math.cos(s)*100;e.position.set(n,i,r),e.lookAt(0,0,0),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=500,e.shadow.camera.left=-50,e.shadow.camera.right=50,e.shadow.camera.top=50,e.shadow.camera.bottom=-50,e.name="sunLight",f(e),u.add(e)},k=()=>{u&&m&&(u.remove(m),m.dispose&&m.dispose(),f(null))};e.useEffect(()=>{u&&setTimeout(()=>v(),100)},[p,u,v]);const L=()=>{if("save"===j&&T.trim())i(T.trim()),alert(`맵이 "${T.trim()}"으로 저장되었습니다.`);else if("load"===j&&T.trim()){r(T.trim())?alert(`맵 "${T.trim()}"을 불러왔습니다.`):alert(`맵 "${T.trim()}"을 찾을 수 없습니다.`)}M(null),C("")},I=()=>{M(null),C("")};return Lt.jsxs("div",{className:"editor-page",children:[Lt.jsx(Sr,{onMenuAction:e=>{switch(e){case"new-map":confirm(Mr)&&s();break;case"load-map":M("load");break;case"save-map":M("save");break;case"import":(()=>{const e=document.createElement("input");e.type="file",e.accept=".glb,.gltf",e.multiple=!1,e.onchange=e=>{const t=e.target.files[0];if(!t)return;const s=URL.createObjectURL(t),n=t.name.replace(/\.[^/.]+$/,""),i={id:Date.now(),type:"glb",file:s,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:n};a(i),setTimeout(()=>{o(i.id)},100)},e.click()})();break;case"export":alert(Tr);break;case"exit":confirm(Cr)&&t("/");break;case"undo":alert(Ar);break;case"redo":alert(Er);break;case"copy":if(c){const e=x.find(e=>e.id===c);e?(b(e),E({message:`"${e.name}"이(가) 복사되었습니다`,type:"success"}),setTimeout(()=>E(null),2e3)):(E({message:"복사할 객체를 찾을 수 없습니다",type:"error"}),setTimeout(()=>E(null),2e3))}else E({message:"복사할 객체를 먼저 선택해주세요",type:"warning"}),setTimeout(()=>E(null),2e3);break;case"paste":if(S()){const e=y();e?(E({message:`"${e.name}"이(가) 붙여넣기되었습니다`,type:"success"}),setTimeout(()=>E(null),2e3)):(E({message:"붙여넣기에 실패했습니다",type:"error"}),setTimeout(()=>E(null),2e3))}else E({message:"붙여넣을 객체가 클립보드에 없습니다",type:"warning"}),setTimeout(()=>E(null),2e3);break;case"delete":if(c){const e=x.find(e=>e.id===c);if(e){const t=e.name;w(),E({message:`"${t}"이(가) 삭제되었습니다`,type:"success"}),setTimeout(()=>E(null),2e3)}else E({message:"삭제할 객체를 찾을 수 없습니다",type:"error"}),setTimeout(()=>E(null),2e3)}else E({message:"삭제할 객체를 먼저 선택해주세요",type:"warning"}),setTimeout(()=>E(null),2e3);break;case"select-all":alert(Or);break;case"deselect-all":alert(Rr);break;case"reset-viewport":alert(Dr);break;case"reset-camera":alert(_r);break;case"toggle-grid":d();const e=Vs.getState().isGridVisible;D.current&&D.current.toggleGrid(),E({message:`그리드가 ${e?"표시":"숨김"} 되었습니다`,type:"info"}),setTimeout(()=>E(null),2e3);break;case"toggle-stats":alert(Nr);break;case"toggle-inspector":R(e=>!e),E({message:`인스펙터가 ${O?"숨김":"표시"} 되었습니다`,type:"info"}),setTimeout(()=>E(null),2e3);break;case"fullscreen":document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();break;case"show-shortcuts":alert(Pr);break;case"show-help":alert(kr);break;case"about":alert(Lr)}}}),Lt.jsxs("div",{className:"editor-container",children:[Lt.jsx(hr,{onEditorControlsReady:e=>{D.current=e},onPostProcessingReady:e=>{_.current=e},onContextMenu:e=>{const t=new CustomEvent("editorContextMenu",{detail:{originalEvent:e}});window.dispatchEvent(t)}}),Lt.jsx(jr,{editorControls:D.current}),Lt.jsx(wr,{editorControls:D.current,postProcessingManager:_.current,onAddToLibrary:async e=>{try{const t=prompt("메쉬 이름을 입력하세요:",e.name||"커스텀 메쉬");if(!t)return;const s=confirm('현재 객체의 크기, 회전, 위치 변경사항을 GLB에 적용하시겠습니까?\n\n- "확인": 현재 변환 상태가 적용된 메쉬로 저장\n- "취소": 원본 상태로 저장 (변환 값 초기화)');E({message:"라이브러리에 추가 중...",type:"info"});const n=await N.current.addCustomMesh(e,t,{preserveTransform:s});l(n),window.dispatchEvent(new CustomEvent("customMeshAdded",{detail:n}));E({message:`"${t}"이(가) 라이브러리에 추가되었습니다!${s?" (변환 상태 적용됨)":" (원본 상태로 저장됨)"}`,type:"success"}),setTimeout(()=>E(null),5e3)}catch(t){E({message:"라이브러리 추가에 실패했습니다.",type:"error"}),setTimeout(()=>E(null),5e3)}},showInspector:O,onToggleInspector:R})]}),j&&Lt.jsx("div",{className:"dialog-overlay",children:Lt.jsxs("div",{className:"dialog",children:[Lt.jsx("h3",{children:"save"===j?"맵 저장":"맵 불러오기"}),Lt.jsx("input",{type:"text",value:T,onChange:e=>C(e.target.value),placeholder:"맵 이름을 입력하세요",autoFocus:!0,onKeyDown:e=>{"Enter"===e.key&&L(),"Escape"===e.key&&I()}}),Lt.jsxs("div",{className:"dialog-buttons",children:[Lt.jsx("button",{onClick:L,children:"확인"}),Lt.jsx("button",{onClick:I,children:"취소"})]})]})}),A&&Lt.jsx(yr,{message:A.message,type:A.type,onClose:()=>E(null)})]})}function zr(){return Lt.jsx(i,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:Lt.jsx("div",{className:"App",children:Lt.jsxs(r,{children:[Lt.jsx(a,{path:"/",element:Lt.jsx(Ft,{})}),Lt.jsx(a,{path:"/game",element:Lt.jsx(Gt,{})}),Lt.jsx(a,{path:"/editor",element:Lt.jsx(Ir,{})})]})})})}It.createRoot(document.getElementById("root")).render(Lt.jsx(s.StrictMode,{children:Lt.jsx(zr,{})}));
