var e=Object.defineProperty,t=(t,n,r)=>((t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r)(t,"symbol"!=typeof n?n+"":n,r);import{r as n,j as r,a as s,R as i}from"./react-vendor-C18QMWF4.js";import{K as a,G as o,M as l,D as c,a as d,B as u,b as h,V as p,S as m,O as g,P as b,R as f,c as y,d as v,e as x,Q as w,E as j,T as S,f as M,g as O,h as _,i as C,j as D,k as E,C as P,l as z,m as N,n as A,o as k,U as L,F as R,p as I,q as T,N as F,A as G,r as B,s as H,L as U,t as V,u as q,v as W,w as K,H as $,x as Z,y as X,z as Y,I as Q,J,W as ee,X as te,Y as ne,Z as re,_ as se,$ as ie,a0 as ae,a1 as oe,a2 as le,a3 as ce,a4 as de,a5 as ue,a6 as he,a7 as pe,a8 as me,a9 as ge,aa as be,ab as fe,ac as ye,ad as ve,ae as xe,af as we,ag as je,ah as Se}from"./three-CPLCFrMS.js";import{R as Me}from"./three-stdlib-CLJV8NWX.js";import{c as Oe}from"./state-MC_ymbCc.js";function _e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Ce(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})}),n}const De={},Ee=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),n=(null==e?void 0:e.nonce)||(null==e?void 0:e.getAttribute("nonce"));r=Promise.allSettled(t.map(e=>{if((e=function(e){return"/"+e}(e))in De)return;De[e]=!0;const t=e.endsWith(".css"),r=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${r}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script"),s.crossOrigin="",s.href=e,n&&s.setAttribute("nonce",n),document.head.appendChild(s),t?new Promise((t,n)=>{s.addEventListener("load",t),s.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function s(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return r.then(t=>{for(const e of t||[])"rejected"===e.status&&s(e.reason);return e().catch(s)})};let Pe=null,ze=null,Ne=!1;function Ae(e){try{if(!e)return;ze||(ze=(new a).setTranscoderPath("/libs/basis/")),Ne||(ze.detectSupport(e),Ne=!0)}catch{}}function ke(){Pe||(Pe=new c,Pe.setDecoderPath("/libs/draco/")),ze||(ze=(new a).setTranscoderPath("/libs/basis/"));const e=new o;try{e.setDRACOLoader(Pe)}catch{}try{e.setKTX2Loader(ze)}catch{}try{e.setMeshoptDecoder(l)}catch{}return e}var Le={exports:{}};const Re=Ce(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));var Ie,Te,Fe;Te=void 0,Fe=function(e){return Te||(Te=new Promise(function(n,r){var s,i=void 0!==e?e:{},a=i.onAbort;i.onAbort=function(e){r(new Error(e)),a&&a(e)},i.postRun=i.postRun||[],i.postRun.push(function(){n(i)}),Ie=void 0,s||(s=void 0!==i?i:{});var o="object"==typeof window,l="undefined"!=typeof WorkerGlobalScope,c="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node&&"renderer"!=process.type;s.onRuntimeInitialized=function(){function e(e,t){switch(typeof t){case"boolean":Y(e,t?1:0);break;case"number":H(e,t);break;case"string":W(e,t,-1,-1);break;case"object":if(null===t)V(e);else if(null!=t.length){var n=xt(t,vt);Z(e,n,t.length,-1),Ct(n)}else Q(e,"Wrong API use : tried to return a value of an unknown type ("+t+").",-1);break;default:V(e)}}function t(e,t){for(var n=[],r=0;r<e;r+=1){var s=U(t+4*r,"i32"),i=I(s);if(1===i||2===i)s=B(s);else if(3===i)s=F(s);else if(4===i){s=T(i=s),i=G(i);for(var a=new Uint8Array(s),o=0;o<s;o+=1)a[o]=w[i+o];s=a}else s=null;n.push(s)}return n}function n(e,t){this.Qa=e,this.db=t,this.Oa=1,this.lb=[]}function r(e,t){if(this.db=t,t=te(e)+1,this.eb=_t(t),null===this.eb)throw Error("Unable to allocate memory for the SQL string");ne(e,j,this.eb,t),this.kb=this.eb,this.Za=this.pb=null}function i(e){if(this.filename="dbfile_"+(4294967295*Math.random()>>>0),null!=e){var t=this.filename,n="/",r=t;if(n&&(n="string"==typeof n?n:Se(n),r=t?X(n+"/"+t):n),r=function(e,t=438){return He(e,4095&t|32768,0)}(r,t=de(!0,!0)),e){if("string"==typeof e){n=Array(e.length);for(var s=0,i=e.length;s<i;++s)n[s]=e.charCodeAt(s);e=n}Xe(r,146|t),nt(n=Qe(r,577),e,0,e.length,0),Je(n),Xe(r,t)}}this.handleError(l(this.filename,a)),this.db=U(a,"i32"),ee(this.db),this.fb={},this.Sa={}}var a=zt(4),o=s.cwrap,l=o("sqlite3_open","number",["string","number"]),c=o("sqlite3_close_v2","number",["number"]),d=o("sqlite3_exec","number",["number","string","number","number","number"]),u=o("sqlite3_changes","number",["number"]),h=o("sqlite3_prepare_v2","number",["number","string","number","number","number"]),p=o("sqlite3_sql","string",["number"]),m=o("sqlite3_normalized_sql","string",["number"]),g=o("sqlite3_prepare_v2","number",["number","number","number","number","number"]),b=o("sqlite3_bind_text","number",["number","number","number","number","number"]),f=o("sqlite3_bind_blob","number",["number","number","number","number","number"]),y=o("sqlite3_bind_double","number",["number","number","number"]),v=o("sqlite3_bind_int","number",["number","number","number"]),x=o("sqlite3_bind_parameter_index","number",["number","string"]),S=o("sqlite3_step","number",["number"]),M=o("sqlite3_errmsg","string",["number"]),O=o("sqlite3_column_count","number",["number"]),_=o("sqlite3_data_count","number",["number"]),C=o("sqlite3_column_double","number",["number","number"]),D=o("sqlite3_column_text","string",["number","number"]),E=o("sqlite3_column_blob","number",["number","number"]),P=o("sqlite3_column_bytes","number",["number","number"]),z=o("sqlite3_column_type","number",["number","number"]),N=o("sqlite3_column_name","string",["number","number"]),A=o("sqlite3_reset","number",["number"]),k=o("sqlite3_clear_bindings","number",["number"]),L=o("sqlite3_finalize","number",["number"]),R=o("sqlite3_create_function_v2","number","number string number number number number number number number".split(" ")),I=o("sqlite3_value_type","number",["number"]),T=o("sqlite3_value_bytes","number",["number"]),F=o("sqlite3_value_text","string",["number"]),G=o("sqlite3_value_blob","number",["number"]),B=o("sqlite3_value_double","number",["number"]),H=o("sqlite3_result_double","",["number","number"]),V=o("sqlite3_result_null","",["number"]),W=o("sqlite3_result_text","",["number","string","number","number"]),Z=o("sqlite3_result_blob","",["number","number","number","number"]),Y=o("sqlite3_result_int","",["number","number"]),Q=o("sqlite3_result_error","",["number","string","number"]),J=o("sqlite3_aggregate_context","number",["number","number"]),ee=o("RegisterExtensionFunctions","number",["number"]),se=o("sqlite3_update_hook","number",["number","number","number"]);n.prototype.bind=function(e){if(!this.Qa)throw"Statement closed";return this.reset(),Array.isArray(e)?this.Cb(e):null==e||"object"!=typeof e||this.Db(e)},n.prototype.step=function(){if(!this.Qa)throw"Statement closed";this.Oa=1;var e=S(this.Qa);switch(e){case 100:return!0;case 101:return!1;default:throw this.db.handleError(e)}},n.prototype.wb=function(e){return null==e&&(e=this.Oa,this.Oa+=1),C(this.Qa,e)},n.prototype.Gb=function(e){if(null==e&&(e=this.Oa,this.Oa+=1),e=D(this.Qa,e),"function"!=typeof BigInt)throw Error("BigInt is not supported");return BigInt(e)},n.prototype.Hb=function(e){return null==e&&(e=this.Oa,this.Oa+=1),D(this.Qa,e)},n.prototype.getBlob=function(e){null==e&&(e=this.Oa,this.Oa+=1);var t=P(this.Qa,e);e=E(this.Qa,e);for(var n=new Uint8Array(t),r=0;r<t;r+=1)n[r]=w[e+r];return n},n.prototype.get=function(e,t){t=t||{},null!=e&&this.bind(e)&&this.step(),e=[];for(var n=_(this.Qa),r=0;r<n;r+=1)switch(z(this.Qa,r)){case 1:var s=t.useBigInt?this.Gb(r):this.wb(r);e.push(s);break;case 2:e.push(this.wb(r));break;case 3:e.push(this.Hb(r));break;case 4:e.push(this.getBlob(r));break;default:e.push(null)}return e},n.prototype.getColumnNames=function(){for(var e=[],t=O(this.Qa),n=0;n<t;n+=1)e.push(N(this.Qa,n));return e},n.prototype.getAsObject=function(e,t){e=this.get(e,t),t=this.getColumnNames();for(var n={},r=0;r<t.length;r+=1)n[t[r]]=e[r];return n},n.prototype.getSQL=function(){return p(this.Qa)},n.prototype.getNormalizedSQL=function(){return m(this.Qa)},n.prototype.run=function(e){return null!=e&&this.bind(e),this.step(),this.reset()},n.prototype.sb=function(e,t){null==t&&(t=this.Oa,this.Oa+=1),e=re(e);var n=xt(e,vt);this.lb.push(n),this.db.handleError(b(this.Qa,t,n,e.length-1,0))},n.prototype.Bb=function(e,t){null==t&&(t=this.Oa,this.Oa+=1);var n=xt(e,vt);this.lb.push(n),this.db.handleError(f(this.Qa,t,n,e.length,0))},n.prototype.rb=function(e,t){null==t&&(t=this.Oa,this.Oa+=1),this.db.handleError((e===(0|e)?v:y)(this.Qa,t,e))},n.prototype.Eb=function(e){null==e&&(e=this.Oa,this.Oa+=1),f(this.Qa,e,0,0,0)},n.prototype.tb=function(e,t){switch(null==t&&(t=this.Oa,this.Oa+=1),typeof e){case"string":return void this.sb(e,t);case"number":return void this.rb(e,t);case"bigint":return void this.sb(e.toString(),t);case"boolean":return void this.rb(e+0,t);case"object":if(null===e)return void this.Eb(t);if(null!=e.length)return void this.Bb(e,t)}throw"Wrong API use : tried to bind a value of an unknown type ("+e+")."},n.prototype.Db=function(e){var t=this;return Object.keys(e).forEach(function(n){var r=x(t.Qa,n);0!==r&&t.tb(e[n],r)}),!0},n.prototype.Cb=function(e){for(var t=0;t<e.length;t+=1)this.tb(e[t],t+1);return!0},n.prototype.reset=function(){return this.freemem(),0===k(this.Qa)&&0===A(this.Qa)},n.prototype.freemem=function(){for(var e;void 0!==(e=this.lb.pop());)Ct(e)},n.prototype.free=function(){this.freemem();var e=0===L(this.Qa);return delete this.db.fb[this.Qa],this.Qa=0,e},r.prototype.next=function(){if(null===this.eb)return{done:!0};if(null!==this.Za&&(this.Za.free(),this.Za=null),!this.db.db)throw this.mb(),Error("Database closed");var e=Nt(),t=zt(4);q(a),q(t);try{this.db.handleError(g(this.db.db,this.kb,-1,a,t)),this.kb=U(t,"i32");var r=U(a,"i32");return 0===r?(this.mb(),{done:!0}):(this.Za=new n(r,this.db),this.db.fb[r]=this.Za,{value:this.Za,done:!1})}catch(s){throw this.pb=$(this.kb),this.mb(),s}finally{Pt(e)}},r.prototype.mb=function(){Ct(this.eb),this.eb=null},r.prototype.getRemainingSQL=function(){return null!==this.pb?this.pb:$(this.kb)},"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator&&(r.prototype[Symbol.iterator]=function(){return this}),i.prototype.run=function(e,t){if(!this.db)throw"Database closed";if(t){e=this.prepare(e,t);try{e.step()}finally{e.free()}}else this.handleError(d(this.db,e,0,0,a));return this},i.prototype.exec=function(e,t,r){if(!this.db)throw"Database closed";var s=Nt(),i=null;try{var o=yt(e),l=zt(4);for(e=[];0!==U(o,"i8");){q(a),q(l),this.handleError(g(this.db,o,-1,a,l));var c=U(a,"i32");if(o=U(l,"i32"),0!==c){var d=null;for(i=new n(c,this),null!=t&&i.bind(t);i.step();)null===d&&(d={columns:i.getColumnNames(),values:[]},e.push(d)),d.values.push(i.get(null,r));i.free()}}return e}catch(u){throw i&&i.free(),u}finally{Pt(s)}},i.prototype.each=function(e,t,n,r,s){"function"==typeof t&&(r=n,n=t,t=void 0),e=this.prepare(e,t);try{for(;e.step();)n(e.getAsObject(null,s))}finally{e.free()}if("function"==typeof r)return r()},i.prototype.prepare=function(e,t){if(q(a),this.handleError(h(this.db,e,-1,a,0)),0===(e=U(a,"i32")))throw"Nothing to prepare";var r=new n(e,this);return null!=t&&r.bind(t),this.fb[e]=r},i.prototype.iterateStatements=function(e){return new r(e,this)},i.prototype.export=function(){Object.values(this.fb).forEach(function(e){e.free()}),Object.values(this.Sa).forEach(jt),this.Sa={},this.handleError(c(this.db));var e=function(e){var t,n=Qe(e,n||0);e=$e(e).size;var r=new Uint8Array(e);return tt(n,r,0,e,0),t=r,Je(n),t}(this.filename);return this.handleError(l(this.filename,a)),this.db=U(a,"i32"),ee(this.db),e},i.prototype.close=function(){null!==this.db&&(Object.values(this.fb).forEach(function(e){e.free()}),Object.values(this.Sa).forEach(jt),this.Sa={},this.Ya&&(jt(this.Ya),this.Ya=void 0),this.handleError(c(this.db)),Ke("/"+this.filename),this.db=null)},i.prototype.handleError=function(e){if(0===e)return null;throw e=M(this.db),Error(e)},i.prototype.getRowsModified=function(){return u(this.db)},i.prototype.create_function=function(n,r){Object.prototype.hasOwnProperty.call(this.Sa,n)&&(jt(this.Sa[n]),delete this.Sa[n]);var s=St(function(n,s,i){s=t(s,i);try{var a=r.apply(null,s)}catch(o){return void Q(n,o,-1)}e(n,a)},"viii");return this.Sa[n]=s,this.handleError(R(this.db,n,r.length,1,0,s,0,0,0)),this},i.prototype.create_aggregate=function(n,r){var s=r.init||function(){return null},i=r.finalize||function(e){return e},a=r.step;if(!a)throw"An aggregate function must have a step function in "+n;var o={};Object.hasOwnProperty.call(this.Sa,n)&&(jt(this.Sa[n]),delete this.Sa[n]),r=n+"__finalize",Object.hasOwnProperty.call(this.Sa,r)&&(jt(this.Sa[r]),delete this.Sa[r]);var l=St(function(e,n,r){var i=J(e,1);Object.hasOwnProperty.call(o,i)||(o[i]=s()),n=t(n,r),n=[o[i]].concat(n);try{o[i]=a.apply(null,n)}catch(l){delete o[i],Q(e,l,-1)}},"viii"),c=St(function(t){var n=J(t,1);try{var r=i(o[n])}catch(s){return delete o[n],void Q(t,s,-1)}e(t,r),delete o[n]},"vi");return this.Sa[n]=l,this.Sa[r]=c,this.handleError(R(this.db,n,a.length-1,1,0,0,l,c,0)),this},i.prototype.updateHook=function(e){this.Ya&&(se(this.db,0,0),jt(this.Ya),this.Ya=void 0),e&&(this.Ya=St(function(t,n,r,s,i){switch(n){case 18:t="insert";break;case 23:t="update";break;case 9:t="delete";break;default:throw"unknown operationCode in updateHook callback: "+n}if(r=r?K(j,r):"",s=s?K(j,s):"",i>Number.MAX_SAFE_INTEGER)throw"rowId too big to fit inside a Number";e(t,r,s,Number(i))},"viiiij"),se(this.db,this.Ya,0))},s.Database=i};var d,u,h={...s},p="./this.program",m=(e,t)=>{throw t},g="";if(c){var b=Re;g=__dirname+"/",u=e=>(e=z(e)?new URL(e):e,b.readFileSync(e)),d=async e=>(e=z(e)?new URL(e):e,b.readFileSync(e,void 0)),!s.thisProgram&&1<process.argv.length&&(p=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),Ie.exports=s,m=(e,t)=>{throw process.exitCode=e,t}}else(o||l)&&(l?g=self.location.href:"undefined"!=typeof document&&document.currentScript&&(g=document.currentScript.src),g=g.startsWith("blob:")?"":g.slice(0,g.replace(/[?#].*/,"").lastIndexOf("/")+1),l&&(u=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),d=async e=>{if(z(e))return new Promise((t,n)=>{var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=()=>{200==r.status||0==r.status&&r.response?t(r.response):n(r.status)},r.onerror=n,r.send(null)});var t=await fetch(e,{credentials:"same-origin"});if(t.ok)return t.arrayBuffer();throw Error(t.status+" : "+t.url)});var f=s.print||function(){}.bind(),y=s.printErr||function(){}.bind();Object.assign(s,h),h=null,s.thisProgram&&(p=s.thisProgram);var v,x,w,j,S,M,O,_,C,D,E=s.wasmBinary,P=!1,z=e=>e.startsWith("file://");function N(){var e=v.buffer;s.HEAP8=w=new Int8Array(e),s.HEAP16=S=new Int16Array(e),s.HEAPU8=j=new Uint8Array(e),s.HEAPU16=new Uint16Array(e),s.HEAP32=M=new Int32Array(e),s.HEAPU32=O=new Uint32Array(e),s.HEAPF32=_=new Float32Array(e),s.HEAPF64=D=new Float64Array(e),s.HEAP64=C=new BigInt64Array(e),s.HEAPU64=new BigUint64Array(e)}var A,k=0,L=null;function R(e){var t;throw null==(t=s.onAbort)||t.call(s,e),y(e="Aborted("+e+")"),P=!0,new WebAssembly.RuntimeError(e+". Build with -sASSERTIONS for more info.")}async function I(e,t){try{var n=await async function(e){if(!E)try{var t=await d(e);return new Uint8Array(t)}catch{}if(e==A&&E)e=new Uint8Array(E);else{if(!u)throw"both async and sync fetching of the wasm failed";e=u(e)}return e}(e);return await WebAssembly.instantiate(n,t)}catch(r){y(`failed to asynchronously prepare wasm: ${r}`),R(r)}}class T{constructor(e){t(this,"name","ExitStatus"),this.message=`Program terminated with exit(${e})`,this.status=e}}var F=e=>{for(;0<e.length;)e.shift()(s)},G=[],B=[],H=()=>{var e=s.preRun.shift();B.unshift(e)};function U(e,t="i8"){switch(t.endsWith("*")&&(t="*"),t){case"i1":case"i8":return w[e];case"i16":return S[e>>1];case"i32":return M[e>>2];case"i64":return C[e>>3];case"float":return _[e>>2];case"double":return D[e>>3];case"*":return O[e>>2];default:R(`invalid type for getValue: ${t}`)}}var V=s.noExitRuntime||!0;function q(e){var t="i32";switch(t.endsWith("*")&&(t="*"),t){case"i1":case"i8":w[e]=0;break;case"i16":S[e>>1]=0;break;case"i32":M[e>>2]=0;break;case"i64":C[e>>3]=BigInt(0);break;case"float":_[e>>2]=0;break;case"double":D[e>>3]=0;break;case"*":O[e>>2]=0;break;default:R(`invalid type for setValue: ${t}`)}}var W="undefined"!=typeof TextDecoder?new TextDecoder:void 0,K=(e,t=0,n=NaN)=>{var r=t+n;for(n=t;e[n]&&!(n>=r);)++n;if(16<n-t&&e.buffer&&W)return W.decode(e.subarray(t,n));for(r="";t<n;){var s=e[t++];if(128&s){var i=63&e[t++];if(192==(224&s))r+=String.fromCharCode((31&s)<<6|i);else{var a=63&e[t++];65536>(s=224==(240&s)?(15&s)<<12|i<<6|a:(7&s)<<18|i<<12|a<<6|63&e[t++])?r+=String.fromCharCode(s):(s-=65536,r+=String.fromCharCode(55296|s>>10,56320|1023&s))}}else r+=String.fromCharCode(s)}return r},$=(e,t)=>e?K(j,e,t):"",Z=(e,t)=>{for(var n=0,r=e.length-1;0<=r;r--){var s=e[r];"."===s?e.splice(r,1):".."===s?(e.splice(r,1),n++):n&&(e.splice(r,1),n--)}if(t)for(;n;n--)e.unshift("..");return e},X=e=>{var t="/"===e.charAt(0),n="/"===e.slice(-1);return(e=Z(e.split("/").filter(e=>!!e),!t).join("/"))||t||(e="."),e&&n&&(e+="/"),(t?"/":"")+e},Y=e=>{var t=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1);return e=t[0],t=t[1],e||t?(t&&(t=t.slice(0,-1)),e+t):"."},Q=e=>e&&e.match(/([^\/]+|\/)\/*$/)[1],J=e=>{(J=(()=>{if(c){var e=Re;return t=>e.randomFillSync(t)}return e=>crypto.getRandomValues(e)})())(e)},ee=[],te=e=>{for(var t=0,n=0;n<e.length;++n){var r=e.charCodeAt(n);127>=r?t++:2047>=r?t+=2:55296<=r&&57343>=r?(t+=4,++n):t+=3}return t},ne=(e,t,n,r)=>{if(!(0<r))return 0;var s=n;r=n+r-1;for(var i=0;i<e.length;++i){var a=e.charCodeAt(i);if(55296<=a&&57343>=a&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++i)),127>=a){if(n>=r)break;t[n++]=a}else{if(2047>=a){if(n+1>=r)break;t[n++]=192|a>>6}else{if(65535>=a){if(n+2>=r)break;t[n++]=224|a>>12}else{if(n+3>=r)break;t[n++]=240|a>>18,t[n++]=128|a>>12&63}t[n++]=128|a>>6&63}t[n++]=128|63&a}}return t[n]=0,n-s},re=(e,t)=>{var n=Array(te(e)+1);return e=ne(e,n,0,n.length),t&&(n.length=e),n},se=[];function ie(e,t){se[e]={input:[],output:[],cb:t},Ge(e,ae)}var ae={open(e){var t=se[e.node.rdev];if(!t)throw new ve(43);e.tty=t,e.seekable=!1},close(e){e.tty.cb.fsync(e.tty)},fsync(e){e.tty.cb.fsync(e.tty)},read(e,t,n,r){if(!e.tty||!e.tty.cb.xb)throw new ve(60);for(var s=0,i=0;i<r;i++){try{var a=e.tty.cb.xb(e.tty)}catch(o){throw new ve(29)}if(void 0===a&&0===s)throw new ve(6);if(null==a)break;s++,t[n+i]=a}return s&&(e.node.atime=Date.now()),s},write(e,t,n,r){if(!e.tty||!e.tty.cb.qb)throw new ve(60);try{for(var s=0;s<r;s++)e.tty.cb.qb(e.tty,t[n+s])}catch(i){throw new ve(29)}return r&&(e.node.mtime=e.node.ctime=Date.now()),s}},oe={xb(){e:{if(!ee.length){var e=null;if(c){var t=Buffer.alloc(256),n=0,r=process.stdin.fd;try{n=b.readSync(r,t,0,256)}catch(s){if(!s.toString().includes("EOF"))throw s;n=0}0<n&&(e=t.slice(0,n).toString("utf-8"))}else"undefined"!=typeof window&&"function"==typeof window.prompt&&null!==(e=window.prompt("Input: "))&&(e+="\n");if(!e){e=null;break e}ee=re(e,!0)}e=ee.shift()}return e},qb(e,t){null===t||10===t?(f(K(e.output)),e.output=[]):0!=t&&e.output.push(t)},fsync(e){var t;0<(null==(t=e.output)?void 0:t.length)&&(f(K(e.output)),e.output=[])},Tb:()=>({Ob:25856,Qb:5,Nb:191,Pb:35387,Mb:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),Ub:()=>0,Vb:()=>[24,80]},le={qb(e,t){null===t||10===t?(y(K(e.output)),e.output=[]):0!=t&&e.output.push(t)},fsync(e){var t;0<(null==(t=e.output)?void 0:t.length)&&(y(K(e.output)),e.output=[])}},ce={Wa:null,Xa:()=>ce.createNode(null,"/",16895,0),createNode(e,t,n,r){if(24576==(61440&n)||4096==(61440&n))throw new ve(63);return ce.Wa||(ce.Wa={dir:{node:{Ta:ce.La.Ta,Ua:ce.La.Ua,lookup:ce.La.lookup,hb:ce.La.hb,rename:ce.La.rename,unlink:ce.La.unlink,rmdir:ce.La.rmdir,readdir:ce.La.readdir,symlink:ce.La.symlink},stream:{Va:ce.Ma.Va}},file:{node:{Ta:ce.La.Ta,Ua:ce.La.Ua},stream:{Va:ce.Ma.Va,read:ce.Ma.read,write:ce.Ma.write,ib:ce.Ma.ib,jb:ce.Ma.jb}},link:{node:{Ta:ce.La.Ta,Ua:ce.La.Ua,readlink:ce.La.readlink},stream:{}},ub:{node:{Ta:ce.La.Ta,Ua:ce.La.Ua},stream:Fe}}),De((n=Ce(e,t,n,r)).mode)?(n.La=ce.Wa.dir.node,n.Ma=ce.Wa.dir.stream,n.Na={}):32768==(61440&n.mode)?(n.La=ce.Wa.file.node,n.Ma=ce.Wa.file.stream,n.Ra=0,n.Na=null):40960==(61440&n.mode)?(n.La=ce.Wa.link.node,n.Ma=ce.Wa.link.stream):8192==(61440&n.mode)&&(n.La=ce.Wa.ub.node,n.Ma=ce.Wa.ub.stream),n.atime=n.mtime=n.ctime=Date.now(),e&&(e.Na[t]=n,e.atime=e.mtime=e.ctime=n.atime),n},Sb:e=>e.Na?e.Na.subarray?e.Na.subarray(0,e.Ra):new Uint8Array(e.Na):new Uint8Array(0),La:{Ta(e){var t={};return t.dev=8192==(61440&e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,De(e.mode)?t.size=4096:32768==(61440&e.mode)?t.size=e.Ra:40960==(61440&e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.atime),t.mtime=new Date(e.mtime),t.ctime=new Date(e.ctime),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},Ua(e,t){for(var n of["mode","atime","mtime","ctime"])null!=t[n]&&(e[n]=t[n]);void 0!==t.size&&(t=t.size,e.Ra!=t&&(0==t?(e.Na=null,e.Ra=0):(n=e.Na,e.Na=new Uint8Array(t),n&&e.Na.set(n.subarray(0,Math.min(t,e.Ra))),e.Ra=t)))},lookup(){throw ce.vb},hb:(e,t,n,r)=>ce.createNode(e,t,n,r),rename(e,t,n){try{var r=_e(t,n)}catch(i){}if(r){if(De(e.mode))for(var s in r.Na)throw new ve(55);Oe(r)}delete e.parent.Na[e.name],t.Na[n]=e,e.name=n,t.ctime=t.mtime=e.parent.ctime=e.parent.mtime=Date.now()},unlink(e,t){delete e.Na[t],e.ctime=e.mtime=Date.now()},rmdir(e,t){var n,r=_e(e,t);for(n in r.Na)throw new ve(55);delete e.Na[t],e.ctime=e.mtime=Date.now()},readdir:e=>[".","..",...Object.keys(e.Na)],symlink:(e,t,n)=>((e=ce.createNode(e,t,41471,0)).link=n,e),readlink(e){if(40960!=(61440&e.mode))throw new ve(28);return e.link}},Ma:{read(e,t,n,r,s){var i=e.node.Na;if(s>=e.node.Ra)return 0;if(8<(e=Math.min(e.node.Ra-s,r))&&i.subarray)t.set(i.subarray(s,s+e),n);else for(r=0;r<e;r++)t[n+r]=i[s+r];return e},write(e,t,n,r,s,i){if(t.buffer===w.buffer&&(i=!1),!r)return 0;if((e=e.node).mtime=e.ctime=Date.now(),t.subarray&&(!e.Na||e.Na.subarray)){if(i)return e.Na=t.subarray(n,n+r),e.Ra=r;if(0===e.Ra&&0===s)return e.Na=t.slice(n,n+r),e.Ra=r;if(s+r<=e.Ra)return e.Na.set(t.subarray(n,n+r),s),r}i=s+r;var a=e.Na?e.Na.length:0;if(a>=i||(i=Math.max(i,a*(1048576>a?2:1.125)>>>0),0!=a&&(i=Math.max(i,256)),a=e.Na,e.Na=new Uint8Array(i),0<e.Ra&&e.Na.set(a.subarray(0,e.Ra),0)),e.Na.subarray&&t.subarray)e.Na.set(t.subarray(n,n+r),s);else for(i=0;i<r;i++)e.Na[s+i]=t[n+i];return e.Ra=Math.max(e.Ra,s+r),r},Va(e,t,n){if(1===n?t+=e.position:2===n&&32768==(61440&e.node.mode)&&(t+=e.node.Ra),0>t)throw new ve(28);return t},ib(e,t,n,r,s){if(32768!=(61440&e.node.mode))throw new ve(43);if(e=e.node.Na,2&s||!e||e.buffer!==w.buffer){s=!0,r=65536*Math.ceil(t/65536);var i=Dt(65536,r);if(i&&j.fill(0,i,i+r),!(r=i))throw new ve(48);e&&((0<n||n+t<e.length)&&(e=e.subarray?e.subarray(n,n+t):Array.prototype.slice.call(e,n,n+t)),w.set(e,r))}else s=!1,r=e.byteOffset;return{Kb:r,Ab:s}},jb:(e,t,n,r)=>(ce.Ma.write(e,t,0,r,n,!1),0)}},de=(e,t)=>{var n=0;return e&&(n|=365),t&&(n|=146),n},ue=null,he={},pe=[],me=1,ge=null,be=!1,fe=!0,ye={},ve=class{constructor(e){t(this,"name","ErrnoError"),this.Pa=e}},xe=class{constructor(){t(this,"gb",{}),t(this,"node",null)}get flags(){return this.gb.flags}set flags(e){this.gb.flags=e}get position(){return this.gb.position}set position(e){this.gb.position=e}},we=class{constructor(e,n,r,s){t(this,"La",{}),t(this,"Ma",{}),t(this,"ab",null),e||(e=this),this.parent=e,this.Xa=e.Xa,this.id=me++,this.name=n,this.mode=r,this.rdev=s,this.atime=this.mtime=this.ctime=Date.now()}get read(){return!(365&~this.mode)}set read(e){e?this.mode|=365:this.mode&=-366}get write(){return!(146&~this.mode)}set write(e){e?this.mode|=146:this.mode&=-147}};function je(e,t={}){if(!e)throw new ve(44);null!=t.nb||(t.nb=!0),"/"===e.charAt(0)||(e="//"+e);var n=0;e:for(;40>n;n++){e=e.split("/").filter(e=>!!e);for(var r=ue,s="/",i=0;i<e.length;i++){var a=i===e.length-1;if(a&&t.parent)break;if("."!==e[i])if(".."===e[i])s=Y(s),r=r.parent;else{s=X(s+"/"+e[i]);try{r=_e(r,e[i])}catch(o){if(44===(null==o?void 0:o.Pa)&&a&&t.Jb)return{path:s};throw o}if(!r.ab||a&&!t.nb||(r=r.ab.root),40960==(61440&r.mode)&&(!a||t.$a)){if(!r.La.readlink)throw new ve(52);"/"===(r=r.La.readlink(r)).charAt(0)||(r=Y(s)+"/"+r),e=r+"/"+e.slice(i+1).join("/");continue e}}}return{path:s,node:r}}throw new ve(32)}function Se(e){for(var t;;){if(e===e.parent)return e=e.Xa.zb,t?"/"!==e[e.length-1]?`${e}/${t}`:e+t:e;t=t?`${e.name}/${t}`:e.name,e=e.parent}}function Me(e,t){for(var n=0,r=0;r<t.length;r++)n=(n<<5)-n+t.charCodeAt(r)|0;return(e+n>>>0)%ge.length}function Oe(e){var t=Me(e.parent.id,e.name);if(ge[t]===e)ge[t]=e.bb;else for(t=ge[t];t;){if(t.bb===e){t.bb=e.bb;break}t=t.bb}}function _e(e,t){var n=De(e.mode)?(n=Pe(e,"x"))?n:e.La.lookup?0:2:54;if(n)throw new ve(n);for(n=ge[Me(e.id,t)];n;n=n.bb){var r=n.name;if(n.parent.id===e.id&&r===t)return n}return e.La.lookup(e,t)}function Ce(e,t,n,r){return t=Me((e=new we(e,t,n,r)).parent.id,e.name),e.bb=ge[t],ge[t]=e}function De(e){return 16384==(61440&e)}function Ee(e){var t=["r","w","rw"][3&e];return 512&e&&(t+="w"),t}function Pe(e,t){return fe?0:!t.includes("r")||292&e.mode?t.includes("w")&&!(146&e.mode)||t.includes("x")&&!(73&e.mode)?2:0:2}function ze(e,t){if(!De(e.mode))return 54;try{return _e(e,t),20}catch(n){}return Pe(e,"wx")}function Ne(e,t,n){try{var r=_e(e,t)}catch(s){return s.Pa}if(e=Pe(e,"wx"))return e;if(n){if(!De(r.mode))return 54;if(r===r.parent||"/"===Se(r))return 10}else if(De(r.mode))return 31;return 0}function Ae(e){if(!e)throw new ve(63);return e}function ke(e){if(!(e=pe[e]))throw new ve(8);return e}function Le(e,t=-1){if(e=Object.assign(new xe,e),-1==t)e:{for(t=0;4096>=t;t++)if(!pe[t])break e;throw new ve(33)}return e.fd=t,pe[t]=e}function Te(e,t,n){var r=null==e?void 0:e.Ma.Ua;e=r?e:t,null!=r||(r=t.La.Ua),Ae(r),r(e,n)}var Fe={open(e){var t,n;e.Ma=he[e.node.rdev].Ma,null==(n=(t=e.Ma).open)||n.call(t,e)},Va(){throw new ve(70)}};function Ge(e,t){he[e]={Ma:t}}function Be(e,t){var n="/"===t;if(n&&ue)throw new ve(10);if(!n&&t){var r=je(t,{nb:!1});if(t=r.path,(r=r.node).ab)throw new ve(10);if(!De(r.mode))throw new ve(54)}t={type:e,Wb:{},zb:t,Ib:[]},(e=e.Xa(t)).Xa=t,t.root=e,n?ue=e:r&&(r.ab=t,r.Xa&&r.Xa.Ib.push(t))}function He(e,t,n){var r=je(e,{parent:!0}).node;if(!(e=Q(e)))throw new ve(28);if("."===e||".."===e)throw new ve(20);var s=ze(r,e);if(s)throw new ve(s);if(!r.La.hb)throw new ve(63);return r.La.hb(r,e,t,n)}function Ue(e,t=511){return He(e,1023&t|16384,0)}function Ve(e,t,n){void 0===n&&(n=t,t=438),He(e,8192|t,n)}function qe(e,t){if(!((...e)=>{for(var t="",n=!1,r=e.length-1;-1<=r&&!n;r--){if("string"!=typeof(n=0<=r?e[r]:"/"))throw new TypeError("Arguments to path.resolve must be strings");if(!n)return"";t=n+"/"+t,n="/"===n.charAt(0)}return(n?"/":"")+(t=Z(t.split("/").filter(e=>!!e),!n).join("/"))||"."})(e))throw new ve(44);var n=je(t,{parent:!0}).node;if(!n)throw new ve(44);var r=ze(n,t=Q(t));if(r)throw new ve(r);if(!n.La.symlink)throw new ve(63);n.La.symlink(n,t,e)}function We(e){var t=je(e,{parent:!0}).node,n=_e(t,e=Q(e)),r=Ne(t,e,!0);if(r)throw new ve(r);if(!t.La.rmdir)throw new ve(63);if(n.ab)throw new ve(10);t.La.rmdir(t,e),Oe(n)}function Ke(e){var t=je(e,{parent:!0}).node;if(!t)throw new ve(44);var n=_e(t,e=Q(e)),r=Ne(t,e,!1);if(r)throw new ve(r);if(!t.La.unlink)throw new ve(63);if(n.ab)throw new ve(10);t.La.unlink(t,e),Oe(n)}function $e(e,t){return Ae((e=je(e,{$a:!t}).node).La.Ta)(e)}function Ze(e,t,n,r){Te(e,t,{mode:4095&n|-4096&t.mode,ctime:Date.now(),Fb:r})}function Xe(e,t){Ze(null,e="string"==typeof e?je(e,{$a:!0}).node:e,t)}function Ye(e,t,n){if(De(t.mode))throw new ve(31);if(32768!=(61440&t.mode))throw new ve(28);var r=Pe(t,"w");if(r)throw new ve(r);Te(e,t,{size:n,timestamp:Date.now()})}function Qe(e,t,n=438){if(""===e)throw new ve(44);if("string"==typeof t){var r={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090}[t];if(void 0===r)throw Error(`Unknown file open mode: ${t}`);t=r}if(n=64&t?4095&n|32768:0,"object"==typeof e)r=e;else{var i=e.endsWith("/");r=(e=je(e,{$a:!(131072&t),Jb:!0})).node,e=e.path}var a=!1;if(64&t)if(r){if(128&t)throw new ve(20)}else{if(i)throw new ve(31);r=He(e,511|n,0),a=!0}if(!r)throw new ve(44);if(8192==(61440&r.mode)&&(t&=-513),65536&t&&!De(r.mode))throw new ve(54);if(!a&&(i=r?40960==(61440&r.mode)?32:De(r.mode)&&("r"!==Ee(t)||576&t)?31:Pe(r,Ee(t)):44))throw new ve(i);return 512&t&&!a&&Ye(null,i="string"==typeof(i=r)?je(i,{$a:!0}).node:i,0),t&=-131713,(i=Le({node:r,path:Se(r),flags:t,seekable:!0,position:0,Ma:r.Ma,Lb:[],error:!1})).Ma.open&&i.Ma.open(i),a&&Xe(r,511&n),!s.logReadFiles||1&t||e in ye||(ye[e]=1),i}function Je(e){if(null===e.fd)throw new ve(8);e.ob&&(e.ob=null);try{e.Ma.close&&e.Ma.close(e)}catch(t){throw t}finally{pe[e.fd]=null}e.fd=null}function et(e,t,n){if(null===e.fd)throw new ve(8);if(!e.seekable||!e.Ma.Va)throw new ve(70);if(0!=n&&1!=n&&2!=n)throw new ve(28);e.position=e.Ma.Va(e,t,n),e.Lb=[]}function tt(e,t,n,r,s){if(0>r||0>s)throw new ve(28);if(null===e.fd)throw new ve(8);if(1==(2097155&e.flags))throw new ve(8);if(De(e.node.mode))throw new ve(31);if(!e.Ma.read)throw new ve(28);var i=void 0!==s;if(i){if(!e.seekable)throw new ve(70)}else s=e.position;return t=e.Ma.read(e,t,n,r,s),i||(e.position+=t),t}function nt(e,t,n,r,s){if(0>r||0>s)throw new ve(28);if(null===e.fd)throw new ve(8);if(!(2097155&e.flags))throw new ve(8);if(De(e.node.mode))throw new ve(31);if(!e.Ma.write)throw new ve(28);e.seekable&&1024&e.flags&&et(e,0,2);var i=void 0!==s;if(i){if(!e.seekable)throw new ve(70)}else s=e.position;return t=e.Ma.write(e,t,n,r,s,void 0),i||(e.position+=t),t}function rt(e,t,n){e=X("/dev/"+e);var r=de(!!t,!!n);null!=rt.yb||(rt.yb=64);var s=rt.yb++<<8;Ge(s,{open(e){e.seekable=!1},close(){var e;(null==(e=null==n?void 0:n.buffer)?void 0:e.length)&&n(10)},read(e,n,r,s){for(var i=0,a=0;a<s;a++){try{var o=t()}catch(l){throw new ve(29)}if(void 0===o&&0===i)throw new ve(6);if(null==o)break;i++,n[r+a]=o}return i&&(e.node.atime=Date.now()),i},write(e,t,r,s){for(var i=0;i<s;i++)try{n(t[r+i])}catch(a){throw new ve(29)}return s&&(e.node.mtime=e.node.ctime=Date.now()),i}}),Ve(e,r,s)}function st(e,t,n){if("/"===t.charAt(0))return t;if(e=-100===e?"/":ke(e).path,0==t.length){if(!n)throw new ve(44);return e}return e+"/"+t}function it(e,t){M[e>>2]=t.dev,M[e+4>>2]=t.mode,O[e+8>>2]=t.nlink,M[e+12>>2]=t.uid,M[e+16>>2]=t.gid,M[e+20>>2]=t.rdev,C[e+24>>3]=BigInt(t.size),M[e+32>>2]=4096,M[e+36>>2]=t.blocks;var n=t.atime.getTime(),r=t.mtime.getTime(),s=t.ctime.getTime();return C[e+40>>3]=BigInt(Math.floor(n/1e3)),O[e+48>>2]=n%1e3*1e6,C[e+56>>3]=BigInt(Math.floor(r/1e3)),O[e+64>>2]=r%1e3*1e6,C[e+72>>3]=BigInt(Math.floor(s/1e3)),O[e+80>>2]=s%1e3*1e6,C[e+88>>3]=BigInt(t.ino),0}var at,ot,lt,ct=void 0,dt=()=>{var e=M[+ct>>2];return ct+=4,e},ut=0,ht=[0,31,60,91,121,152,182,213,244,274,305,335],pt=[0,31,59,90,120,151,181,212,243,273,304,334],mt={},gt=e=>{var t;x=e,V||0<ut||(null==(t=s.onExit)||t.call(s,e),P=!0),m(e,new T(e))},bt={},ft=()=>{if(!at){var e,t={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:p||"./this.program"};for(e in bt)void 0===bt[e]?delete t[e]:t[e]=bt[e];var n=[];for(e in t)n.push(`${e}=${t[e]}`);at=n}return at},yt=e=>{var t=te(e)+1,n=zt(t);return ne(e,j,n,t),n},vt=0,xt=(e,t)=>(t=1==t?zt(e.length):_t(e.length),e.subarray||e.slice||(e=new Uint8Array(e)),j.set(e,t),t),wt=[],jt=e=>{ot.delete(lt.get(e)),lt.set(e,null),wt.push(e)},St=(e,t)=>{if(!ot){ot=new WeakMap;var n=lt.length;if(ot)for(var r=0;r<0+n;r++){var s=lt.get(r);s&&ot.set(s,r)}}if(n=ot.get(e)||0)return n;if(wt.length)n=wt.pop();else{try{lt.grow(1)}catch(l){if(!(l instanceof RangeError))throw l;throw"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH."}n=lt.length-1}try{lt.set(n,e)}catch(l){if(!(l instanceof TypeError))throw l;if("function"==typeof WebAssembly.Function){var i=WebAssembly.Function;r={i:"i32",j:"i64",f:"f32",d:"f64",e:"externref",p:"i32"},s={parameters:[],results:"v"==t[0]?[]:[r[t[0]]]};for(var a=1;a<t.length;++a)s.parameters.push(r[t[a]]);t=new i(s,e)}else{r=[1],s=t.slice(0,1),t=t.slice(1),a={i:127,p:127,j:126,f:125,d:124,e:111},r.push(96);var o=t.length;for(i of(128>o?r.push(o):r.push(o%128|128,o>>7),t))r.push(a[i]);"v"==s?r.push(0):r.push(1,a[s]),t=[0,97,115,109,1,0,0,0,1],128>(i=r.length)?t.push(i):t.push(i%128|128,i>>7),t.push(...r),t.push(2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0),t=new WebAssembly.Module(new Uint8Array(t)),t=new WebAssembly.Instance(t,{e:{f:e}}).exports.f}lt.set(n,t)}return ot.set(e,n),n};ge=Array(4096),Be(ce,"/"),Ue("/tmp"),Ue("/home"),Ue("/home/web_user"),function(){Ue("/dev"),Ge(259,{read:()=>0,write:(e,t,n,r)=>r,Va:()=>0}),Ve("/dev/null",259),ie(1280,oe),ie(1536,le),Ve("/dev/tty",1280),Ve("/dev/tty1",1536);var e=new Uint8Array(1024),t=0,n=()=>(0===t&&(J(e),t=e.byteLength),e[--t]);rt("random",n),rt("urandom",n),Ue("/dev/shm"),Ue("/dev/shm/tmp")}(),function(){Ue("/proc");var e=Ue("/proc/self");Ue("/proc/self/fd"),Be({Xa(){var t=Ce(e,"fd",16895,73);return t.Ma={Va:ce.Ma.Va},t.La={lookup(e,t){var n=ke(e=+t);return(e={parent:null,Xa:{zb:"fake"},La:{readlink:()=>n.path},id:e+1}).parent=e},readdir:()=>Array.from(pe.entries()).filter(([,e])=>e).map(([e])=>e.toString())},t}},"/proc/self/fd")}(),ce.vb=new ve(44),ce.vb.stack="<generic error, no stack>";var Mt,Ot={a:(e,t,n,r)=>R(`Assertion failed: ${e?K(j,e):""}, at: `+[t?t?K(j,t):"":"unknown filename",n,r?r?K(j,r):"":"unknown function"]),i:function(e,t){try{return Xe(e=e?K(j,e):"",t),0}catch(n){if("ErrnoError"!==n.name)throw n;return-n.Pa}},L:function(e,t,n){try{if(t=st(e,t=t?K(j,t):""),-8&n)return-28;var r=je(t,{$a:!0}).node;return r?(e="",4&n&&(e+="r"),2&n&&(e+="w"),1&n&&(e+="x"),e&&Pe(r,e)?-2:0):-44}catch(s){if("ErrnoError"!==s.name)throw s;return-s.Pa}},j:function(e,t){try{var n=ke(e);return Ze(n,n.node,t,!1),0}catch(r){if("ErrnoError"!==r.name)throw r;return-r.Pa}},h:function(e){try{var t=ke(e);return Te(t,t.node,{timestamp:Date.now(),Fb:!1}),0}catch(n){if("ErrnoError"!==n.name)throw n;return-n.Pa}},b:function(e,t,n){ct=n;try{var r=ke(e);switch(t){case 0:var s=dt();if(0>s)break;for(;pe[s];)s++;return function(e,t=-1){var n,r;return null==(r=null==(n=(e=Le(e,t)).Ma)?void 0:n.Rb)||r.call(n,e),e}(r,s).fd;case 1:case 2:case 13:case 14:return 0;case 3:return r.flags;case 4:return s=dt(),r.flags|=s,0;case 12:return s=dt(),S[s+0>>1]=2,0}return-28}catch(i){if("ErrnoError"!==i.name)throw i;return-i.Pa}},g:function(e,t){try{var n=ke(e),r=n.node,s=n.Ma.Ta;return e=s?n:r,null!=s||(s=r.La.Ta),Ae(s),it(t,s(e))}catch(i){if("ErrnoError"!==i.name)throw i;return-i.Pa}},H:function(e,t){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t);try{if(isNaN(t))return 61;var n=ke(e);if(0>t||!(2097155&n.flags))throw new ve(28);return Ye(n,n.node,t),0}catch(r){if("ErrnoError"!==r.name)throw r;return-r.Pa}},G:function(e,t){try{if(0===t)return-28;var n=te("/")+1;return t<n?-68:(ne("/",j,e,t),n)}catch(r){if("ErrnoError"!==r.name)throw r;return-r.Pa}},K:function(e,t){try{return it(t,$e(e=e?K(j,e):"",!0))}catch(n){if("ErrnoError"!==n.name)throw n;return-n.Pa}},C:function(e,t,n){try{return Ue(t=st(e,t=t?K(j,t):""),n),0}catch(r){if("ErrnoError"!==r.name)throw r;return-r.Pa}},J:function(e,t,n,r){try{t=t?K(j,t):"";var s=256&r;return t=st(e,t,4096&r),it(n,s?$e(t,!0):$e(t))}catch(i){if("ErrnoError"!==i.name)throw i;return-i.Pa}},x:function(e,t,n,r){ct=r;try{return Qe(t=st(e,t=t?K(j,t):""),n,r?dt():0).fd}catch(s){if("ErrnoError"!==s.name)throw s;return-s.Pa}},v:function(e,t,n,r){try{if(t=st(e,t=t?K(j,t):""),0>=r)return-28;var s=je(t).node;if(!s)throw new ve(44);if(!s.La.readlink)throw new ve(28);var i=s.La.readlink(s),a=Math.min(r,te(i)),o=w[n+a];return ne(i,j,n,r+1),w[n+a]=o,a}catch(l){if("ErrnoError"!==l.name)throw l;return-l.Pa}},u:function(e){try{return We(e=e?K(j,e):""),0}catch(t){if("ErrnoError"!==t.name)throw t;return-t.Pa}},f:function(e,t){try{return it(t,$e(e=e?K(j,e):""))}catch(n){if("ErrnoError"!==n.name)throw n;return-n.Pa}},r:function(e,t,n){try{return t=st(e,t=t?K(j,t):""),0===n?Ke(t):512===n?We(t):R("Invalid flags passed to unlinkat"),0}catch(r){if("ErrnoError"!==r.name)throw r;return-r.Pa}},q:function(e,t,n){try{t=st(e,t=t?K(j,t):"",!0);var r,s,i=Date.now();if(n){var a=O[n>>2]+4294967296*M[n+4>>2],o=M[n+8>>2];r=1073741823==o?i:1073741822==o?null:1e3*a+o/1e6,a=O[(n+=16)>>2]+4294967296*M[n+4>>2],s=1073741823==(o=M[n+8>>2])?i:1073741822==o?null:1e3*a+o/1e6}else s=r=i;if(null!==(null!=s?s:r)){e=r;var l=je(t,{$a:!0}).node;Ae(l.La.Ua)(l,{atime:e,mtime:s})}return 0}catch(c){if("ErrnoError"!==c.name)throw c;return-c.Pa}},m:()=>R(""),l:()=>{V=!1,ut=0},A:function(e,t){e=-9007199254740992>e||9007199254740992<e?NaN:Number(e),e=new Date(1e3*e),M[t>>2]=e.getSeconds(),M[t+4>>2]=e.getMinutes(),M[t+8>>2]=e.getHours(),M[t+12>>2]=e.getDate(),M[t+16>>2]=e.getMonth(),M[t+20>>2]=e.getFullYear()-1900,M[t+24>>2]=e.getDay();var n=e.getFullYear();M[t+28>>2]=(0!=n%4||0==n%100&&0!=n%400?pt:ht)[e.getMonth()]+e.getDate()-1|0,M[t+36>>2]=-60*e.getTimezoneOffset(),n=new Date(e.getFullYear(),6,1).getTimezoneOffset();var r=new Date(e.getFullYear(),0,1).getTimezoneOffset();M[t+32>>2]=0|(n!=r&&e.getTimezoneOffset()==Math.min(r,n))},y:function(e,t,n,r,s,i,a){s=-9007199254740992>s||9007199254740992<s?NaN:Number(s);try{if(isNaN(s))return 61;var o=ke(r);if(2&t&&!(2&n)&&2!=(2097155&o.flags))throw new ve(2);if(1==(2097155&o.flags))throw new ve(2);if(!o.Ma.ib)throw new ve(43);if(!e)throw new ve(28);var l=o.Ma.ib(o,e,s,t,n),c=l.Kb;return M[i>>2]=l.Ab,O[a>>2]=c,0}catch(d){if("ErrnoError"!==d.name)throw d;return-d.Pa}},z:function(e,t,n,r,s,i){i=-9007199254740992>i||9007199254740992<i?NaN:Number(i);try{var a=ke(s);if(2&n){if(n=i,32768!=(61440&a.node.mode))throw new ve(43);if(!(2&r)){var o=j.slice(e,e+t);a.Ma.jb&&a.Ma.jb(a,o,n,t,r)}}}catch(l){if("ErrnoError"!==l.name)throw l;return-l.Pa}},n:(e,t)=>{if(mt[e]&&(clearTimeout(mt[e].id),delete mt[e]),!t)return 0;var n=setTimeout(()=>{delete mt[e],(e=>{if(!P)try{if(e(),!(V||0<ut))try{x=e=x,gt(e)}catch(t){t instanceof T||"unwind"==t||m(1,t)}}catch(t){t instanceof T||"unwind"==t||m(1,t)}})(()=>Et(e,performance.now()))},t);return mt[e]={id:n,Xb:t},0},B:(e,t,n,r)=>{var s=(new Date).getFullYear(),i=new Date(s,0,1).getTimezoneOffset();s=new Date(s,6,1).getTimezoneOffset(),O[e>>2]=60*Math.max(i,s),M[t>>2]=Number(i!=s),e=(t=e=>{var t=Math.abs(e);return`UTC${0<=e?"-":"+"}${String(Math.floor(t/60)).padStart(2,"0")}${String(t%60).padStart(2,"0")}`})(i),t=t(s),s<i?(ne(e,j,n,17),ne(t,j,r,17)):(ne(e,j,r,17),ne(t,j,n,17))},d:()=>Date.now(),s:()=>2147483648,c:()=>performance.now(),o:e=>{var t=j.length;if(2147483648<(e>>>=0))return!1;for(var n=1;4>=n;n*=2){var r=t*(1+.2/n);r=Math.min(r,e+100663296);e:{r=(Math.min(2147483648,65536*Math.ceil(Math.max(e,r)/65536))-v.buffer.byteLength+65535)/65536|0;try{v.grow(r),N();var s=1;break e}catch(i){}s=void 0}if(s)return!0}return!1},E:(e,t)=>{var n=0;return ft().forEach((r,s)=>{var i=t+n;for(s=O[e+4*s>>2]=i,i=0;i<r.length;++i)w[s++]=r.charCodeAt(i);w[s]=0,n+=r.length+1}),0},F:(e,t)=>{var n=ft();O[e>>2]=n.length;var r=0;return n.forEach(e=>r+=e.length+1),O[t>>2]=r,0},e:function(e){try{return Je(ke(e)),0}catch(t){if("ErrnoError"!==t.name)throw t;return t.Pa}},p:function(e,t){try{var n=ke(e);return w[t]=n.tty?2:De(n.mode)?3:40960==(61440&n.mode)?7:4,S[t+2>>1]=0,C[t+8>>3]=BigInt(0),C[t+16>>3]=BigInt(0),0}catch(r){if("ErrnoError"!==r.name)throw r;return r.Pa}},w:function(e,t,n,r){try{e:{var s=ke(e);e=t;for(var i,a=t=0;a<n;a++){var o=O[e>>2],l=O[e+4>>2];e+=8;var c=tt(s,w,o,l,i);if(0>c){var d=-1;break e}if(t+=c,c<l)break;void 0!==i&&(i+=c)}d=t}return O[r>>2]=d,0}catch(u){if("ErrnoError"!==u.name)throw u;return u.Pa}},D:function(e,t,n,r){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t);try{if(isNaN(t))return 61;var s=ke(e);return et(s,t,n),C[r>>3]=BigInt(s.position),s.ob&&0===t&&0===n&&(s.ob=null),0}catch(i){if("ErrnoError"!==i.name)throw i;return i.Pa}},I:function(e){var t;try{var n=ke(e);return(null==(t=n.Ma)?void 0:t.fsync)?n.Ma.fsync(n):0}catch(r){if("ErrnoError"!==r.name)throw r;return r.Pa}},t:function(e,t,n,r){try{e:{var s=ke(e);e=t;for(var i,a=t=0;a<n;a++){var o=O[e>>2],l=O[e+4>>2];e+=8;var c=nt(s,w,o,l,i);if(0>c){var d=-1;break e}if(t+=c,c<l)break;void 0!==i&&(i+=c)}d=t}return O[r>>2]=d,0}catch(u){if("ErrnoError"!==u.name)throw u;return u.Pa}},k:gt};!async function(){var e;function t(e){var t;return Mt=e.exports,v=Mt.M,N(),lt=Mt.O,k--,null==(t=s.monitorRunDependencies)||t.call(s,k),0==k&&L&&(e=L,L=null,e()),Mt}k++,null==(e=s.monitorRunDependencies)||e.call(s,k);var n={a:Ot};s.instantiateWasm?new Promise(e=>{s.instantiateWasm(n,(n,r)=>{t(n),e(n.exports)})}):(null!=A||(A=s.locateFile?s.locateFile("sql-wasm.wasm",g):g+"sql-wasm.wasm"),t((await async function(e){var t=A;if(!E&&"function"==typeof WebAssembly.instantiateStreaming&&!z(t)&&!c)try{var n=fetch(t,{credentials:"same-origin"});return await WebAssembly.instantiateStreaming(n,e)}catch(r){y(`wasm streaming compile failed: ${r}`),y("falling back to ArrayBuffer instantiation")}return I(t,e)}(n)).instance))}(),s._sqlite3_free=e=>(s._sqlite3_free=Mt.P)(e),s._sqlite3_value_text=e=>(s._sqlite3_value_text=Mt.Q)(e),s._sqlite3_prepare_v2=(e,t,n,r,i)=>(s._sqlite3_prepare_v2=Mt.R)(e,t,n,r,i),s._sqlite3_step=e=>(s._sqlite3_step=Mt.S)(e),s._sqlite3_reset=e=>(s._sqlite3_reset=Mt.T)(e),s._sqlite3_exec=(e,t,n,r,i)=>(s._sqlite3_exec=Mt.U)(e,t,n,r,i),s._sqlite3_finalize=e=>(s._sqlite3_finalize=Mt.V)(e),s._sqlite3_column_name=(e,t)=>(s._sqlite3_column_name=Mt.W)(e,t),s._sqlite3_column_text=(e,t)=>(s._sqlite3_column_text=Mt.X)(e,t),s._sqlite3_column_type=(e,t)=>(s._sqlite3_column_type=Mt.Y)(e,t),s._sqlite3_errmsg=e=>(s._sqlite3_errmsg=Mt.Z)(e),s._sqlite3_clear_bindings=e=>(s._sqlite3_clear_bindings=Mt._)(e),s._sqlite3_value_blob=e=>(s._sqlite3_value_blob=Mt.$)(e),s._sqlite3_value_bytes=e=>(s._sqlite3_value_bytes=Mt.aa)(e),s._sqlite3_value_double=e=>(s._sqlite3_value_double=Mt.ba)(e),s._sqlite3_value_int=e=>(s._sqlite3_value_int=Mt.ca)(e),s._sqlite3_value_type=e=>(s._sqlite3_value_type=Mt.da)(e),s._sqlite3_result_blob=(e,t,n,r)=>(s._sqlite3_result_blob=Mt.ea)(e,t,n,r),s._sqlite3_result_double=(e,t)=>(s._sqlite3_result_double=Mt.fa)(e,t),s._sqlite3_result_error=(e,t,n)=>(s._sqlite3_result_error=Mt.ga)(e,t,n),s._sqlite3_result_int=(e,t)=>(s._sqlite3_result_int=Mt.ha)(e,t),s._sqlite3_result_int64=(e,t)=>(s._sqlite3_result_int64=Mt.ia)(e,t),s._sqlite3_result_null=e=>(s._sqlite3_result_null=Mt.ja)(e),s._sqlite3_result_text=(e,t,n,r)=>(s._sqlite3_result_text=Mt.ka)(e,t,n,r),s._sqlite3_aggregate_context=(e,t)=>(s._sqlite3_aggregate_context=Mt.la)(e,t),s._sqlite3_column_count=e=>(s._sqlite3_column_count=Mt.ma)(e),s._sqlite3_data_count=e=>(s._sqlite3_data_count=Mt.na)(e),s._sqlite3_column_blob=(e,t)=>(s._sqlite3_column_blob=Mt.oa)(e,t),s._sqlite3_column_bytes=(e,t)=>(s._sqlite3_column_bytes=Mt.pa)(e,t),s._sqlite3_column_double=(e,t)=>(s._sqlite3_column_double=Mt.qa)(e,t),s._sqlite3_bind_blob=(e,t,n,r,i)=>(s._sqlite3_bind_blob=Mt.ra)(e,t,n,r,i),s._sqlite3_bind_double=(e,t,n)=>(s._sqlite3_bind_double=Mt.sa)(e,t,n),s._sqlite3_bind_int=(e,t,n)=>(s._sqlite3_bind_int=Mt.ta)(e,t,n),s._sqlite3_bind_text=(e,t,n,r,i)=>(s._sqlite3_bind_text=Mt.ua)(e,t,n,r,i),s._sqlite3_bind_parameter_index=(e,t)=>(s._sqlite3_bind_parameter_index=Mt.va)(e,t),s._sqlite3_sql=e=>(s._sqlite3_sql=Mt.wa)(e),s._sqlite3_normalized_sql=e=>(s._sqlite3_normalized_sql=Mt.xa)(e),s._sqlite3_changes=e=>(s._sqlite3_changes=Mt.ya)(e),s._sqlite3_close_v2=e=>(s._sqlite3_close_v2=Mt.za)(e),s._sqlite3_create_function_v2=(e,t,n,r,i,a,o,l,c)=>(s._sqlite3_create_function_v2=Mt.Aa)(e,t,n,r,i,a,o,l,c),s._sqlite3_update_hook=(e,t,n)=>(s._sqlite3_update_hook=Mt.Ba)(e,t,n),s._sqlite3_open=(e,t)=>(s._sqlite3_open=Mt.Ca)(e,t);var _t=s._malloc=e=>(_t=s._malloc=Mt.Da)(e),Ct=s._free=e=>(Ct=s._free=Mt.Ea)(e);s._RegisterExtensionFunctions=e=>(s._RegisterExtensionFunctions=Mt.Fa)(e);var Dt=(e,t)=>(Dt=Mt.Ga)(e,t),Et=(e,t)=>(Et=Mt.Ha)(e,t),Pt=e=>(Pt=Mt.Ia)(e),zt=e=>(zt=Mt.Ja)(e),Nt=()=>(Nt=Mt.Ka)();if(s.stackSave=()=>Nt(),s.stackRestore=e=>Pt(e),s.stackAlloc=e=>zt(e),s.cwrap=(e,t,n,r)=>{var i=!n||n.every(e=>"number"===e||"boolean"===e);return"string"!==t&&i&&!r?s["_"+e]:(...r)=>((e,t,n,r)=>{var i={string:e=>{var t=0;return null!=e&&0!==e&&(t=yt(e)),t},array:e=>{var t=zt(e.length);return w.set(e,t),t}};e=s["_"+e];var a,o=[],l=0;if(r)for(var c=0;c<r.length;c++){var d=i[n[c]];d?(0===l&&(l=Nt()),o[c]=d(r[c])):o[c]=r[c]}return n=e(...o),a=n,0!==l&&Pt(l),"string"===t?a?K(j,a):"":"boolean"===t?!!a:a})(e,t,n,r)},s.addFunction=St,s.removeFunction=jt,s.UTF8ToString=$,s.ALLOC_NORMAL=vt,s.allocate=xt,s.allocateUTF8OnStack=yt,s.preInit)for("function"==typeof s.preInit&&(s.preInit=[s.preInit]);0<s.preInit.length;)s.preInit.pop()();return function e(){function t(){var e;if(s.calledRun=!0,!P){var t,n;if(s.noFSInit||be||(be=!0,null!=r||(r=s.stdin),null!=t||(t=s.stdout),null!=n||(n=s.stderr),r?rt("stdin",r):qe("/dev/tty","/dev/stdin"),t?rt("stdout",null,t):qe("/dev/tty","/dev/stdout"),n?rt("stderr",null,n):qe("/dev/tty1","/dev/stderr"),Qe("/dev/stdin",0),Qe("/dev/stdout",1),Qe("/dev/stderr",1)),Mt.N(),fe=!1,null==(e=s.onRuntimeInitialized)||e.call(s),s.postRun)for("function"==typeof s.postRun&&(s.postRun=[s.postRun]);s.postRun.length;){var r=s.postRun.shift();G.unshift(r)}F(G)}}if(0<k)L=e;else{if(s.preRun)for("function"==typeof s.preRun&&(s.preRun=[s.preRun]);s.preRun.length;)H();F(B),0<k?L=e:s.setStatus?(s.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>s.setStatus(""),1),t()},1)):t()}}(),i}))},(Ie=Le).exports=Fe,Ie.exports.default=Fe;const Ge=_e(Le.exports),Be="sqlite_db",He="sqlite";let Ue=null,Ve=null,qe=null;const We="Web3DModelEditorDB",Ke="customMeshes",$e="sqlite_legacy_migrated_v1",Ze="sqlite_maps_migrated_v1";function Xe(e){let t="";for(let n=0;n<e.length;n+=32768){const r=e.subarray(n,Math.min(n+32768,e.length));t+=String.fromCharCode.apply(null,Array.from(r))}return btoa(t)}function Ye(e){return e instanceof Uint8Array?Xe(e):Xe(new Uint8Array(e))}function Qe(e){if(!e)return new Uint8Array(0);const t=atob(e),n=t.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=t.charCodeAt(s);return r}function Je(){return new Promise((e,t)=>{const n=indexedDB.open("Web3DModelEditorSQLite",1);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains(He)||e.createObjectStore(He)},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function et(){const e=await async function(e){try{const t=await Je();return await new Promise((n,r)=>{const s=t.transaction(He,"readonly").objectStore(He).get(e);s.onsuccess=()=>n(s.result||null),s.onerror=()=>r(s.error)})}catch{return null}}(Be);if(e)try{const t=await(e.arrayBuffer?e.arrayBuffer():e);return new Uint8Array(t)}catch{}try{const e=localStorage.getItem(Be);return e?Uint8Array.from(atob(e),e=>e.charCodeAt(0)):null}catch{return null}}async function tt(){try{const e=Ve.export();await async function(e,t){try{const n=await Je();return await new Promise((r,s)=>{const i=n.transaction(He,"readwrite").objectStore(He).put(t,e);i.onsuccess=()=>r(),i.onerror=()=>s(i.error)})}catch(n){}}(Be,new Blob([e],{type:"application/octet-stream"}));try{const t=Ye(e);localStorage.setItem(Be,t)}catch{}}catch(e){}}function nt(e){let t=!1;try{(function(e,t,n){try{const r=e.prepare(`PRAGMA table_info(${t});`);for(;r.step();){const e=r.getAsObject();if(String(e.name)===String(n))return r.free(),!0}r.free()}catch{}return!1})(e,"custom_meshes","thumbnail_str")||(e.exec("ALTER TABLE custom_meshes ADD COLUMN thumbnail_str TEXT;"),t=!0)}catch(n){}return t}async function rt(){if(Ve){try{nt(Ve)&&st()}catch{}return Ve}return qe||(qe=(async()=>{Ue=await Ge({locateFile:e=>e.endsWith("sql-wasm.wasm")?"/assets/sql-wasm-C1U8OeUW.wasm":e});const e=await et();Ve=e?new Ue.Database(e):new Ue.Database,Ve.exec("\nCREATE TABLE IF NOT EXISTS app_settings (\n  key TEXT PRIMARY KEY,\n  value TEXT\n);\nCREATE TABLE IF NOT EXISTS custom_meshes (\n  id TEXT PRIMARY KEY,\n  name TEXT,\n  -- Deprecated: data_b64 / thumbnail_b64 kept for backward-compat; new flow stores blobs in IDB\n  data_b64 TEXT,\n  thumbnail_b64 TEXT,\n  -- Optional lightweight string metadata for thumbnail (e.g. mime or note)\n  thumbnail_str TEXT,\n  created_at INTEGER\n);\nCREATE TABLE IF NOT EXISTS saved_maps (\n  name TEXT PRIMARY KEY,\n  data_json TEXT,\n  version INTEGER,\n  updated_at INTEGER\n);\n");try{nt(Ve)&&st()}catch{}try{localStorage.getItem($e)||(await async function(){if("undefined"==typeof indexedDB)return;const e=await new Promise(e=>{const t=indexedDB.open(We);t.onerror=()=>e(null),t.onsuccess=()=>{const n=t.result;try{if(!n.objectStoreNames||!n.objectStoreNames.contains(Ke))return e([]);const t=n.transaction(Ke,"readonly"),r=t.objectStore(Ke).getAll();r.onsuccess=()=>e(r.result||[]),r.onerror=()=>e(null)}catch(r){e([])}}});if(!e||!Array.isArray(e)||0===e.length)return;for(const t of e)try{await lt({id:t.id,name:t.name,glbData:t.glbData,thumbnail:t.thumbnail})}catch{}}(),localStorage.setItem($e,"1"),st())}catch(t){}try{localStorage.getItem(Ze)||(await async function(){try{const e=Object.keys(localStorage||{}).filter(e=>e.startsWith("map_"));if(0===e.length)return;for(const t of e)try{const e=localStorage.getItem(t);if(!e)continue;const n=JSON.parse(e);if(!n||"object"!=typeof n)continue;"__version"in n||(n.__version=1);const r=t.substring(4);await dt(r,n,n.__version||1)}catch{}}catch{}}(),localStorage.setItem(Ze,"1"),st())}catch(t){}return Ve})()),qe}function st(){Ve&&tt()}async function it(e,t){const n=await rt(),r=JSON.stringify(null!=t?t:null),s=n.prepare("INSERT INTO app_settings(key, value) VALUES(?, ?)\nON CONFLICT(key) DO UPDATE SET value=excluded.value");s.run([e,r]),s.free(),st()}async function at(e){const t=(await rt()).prepare("SELECT value FROM app_settings WHERE key = ?");let n=null;if(t.step())try{n=JSON.parse(t.getAsObject().value)}catch{n=null}return t.free(),n}async function ot(){const e=await rt(),t=[];let n;try{n=e.prepare("SELECT id, name, data_b64, thumbnail_b64, thumbnail_str, created_at FROM custom_meshes ORDER BY created_at ASC")}catch{n=e.prepare("SELECT id, name, data_b64, thumbnail_b64, created_at FROM custom_meshes ORDER BY created_at ASC")}for(;n.step();){const e=n.getAsObject();t.push({id:e.id,name:e.name,glbData:e.data_b64?Qe(e.data_b64).buffer:null,thumbnail:e.thumbnail_b64||e.thumbnail_str||null,createdAt:e.created_at})}return n.free(),t}async function lt(e){const t=await rt(),{id:n,name:r,data:s,glbData:i,thumbnail:a,thumbnailStr:o}=e,l=s||i||null,c=l?Ye(l instanceof Uint8Array?l:new Uint8Array(l)):null,d="string"==typeof a?a:null,u="string"==typeof o?o:null,h=Date.now();let p;try{p=t.prepare("INSERT INTO custom_meshes(id, name, data_b64, thumbnail_b64, thumbnail_str, created_at) VALUES(?, ?, ?, ?, ?, ?)\nON CONFLICT(id) DO UPDATE SET name=excluded.name, data_b64=excluded.data_b64, thumbnail_b64=excluded.thumbnail_b64, thumbnail_str=excluded.thumbnail_str"),p.run([n,null!=r?r:"",c,d,u,h]),p.free()}catch{p=t.prepare("INSERT INTO custom_meshes(id, name, data_b64, thumbnail_b64, created_at) VALUES(?, ?, ?, ?, ?)\nON CONFLICT(id) DO UPDATE SET name=excluded.name, data_b64=excluded.data_b64, thumbnail_b64=excluded.thumbnail_b64"),p.run([n,null!=r?r:"",c,d,h]),p.free()}st()}async function ct(e){const t=(await rt()).prepare("DELETE FROM custom_meshes WHERE id = ?");t.run([e]),t.free(),st()}async function dt(e,t,n=1){const r=await rt(),s=Date.now();let i=null;try{i=JSON.stringify(null!=t?t:{})}catch{i="{}"}const a=r.prepare("INSERT INTO saved_maps(name, data_json, version, updated_at) VALUES(?, ?, ?, ?)\nON CONFLICT(name) DO UPDATE SET data_json=excluded.data_json, version=excluded.version, updated_at=excluded.updated_at");a.run([String(e||""),i,Number.isFinite(n)?n:1,s]),a.free(),st()}const ut=Object.freeze(Object.defineProperty({__proto__:null,customMeshesDelete:ct,customMeshesGetAll:ot,customMeshesUpsert:lt,getDB:rt,mapsDelete:async function(e){const t=(await rt()).prepare("DELETE FROM saved_maps WHERE name = ?");t.run([String(e||"")]),t.free(),st()},mapsGet:async function(e){const t=(await rt()).prepare("SELECT data_json, version, updated_at FROM saved_maps WHERE name = ?");let n=null;if(t.step()){const e=t.getAsObject();try{n=JSON.parse(e.data_json||"{}")}catch{n=null}n&&"object"==typeof n&&!("__version"in n)&&(n.__version=Number.isFinite(e.version)?e.version:1)}return t.free(),n},mapsList:async function(){const e=(await rt()).prepare("SELECT name, version, updated_at FROM saved_maps ORDER BY updated_at DESC"),t=[];for(;e.step();)t.push(e.getAsObject());return e.free(),t},mapsUpsert:dt,persist:st,settingsGet:at,settingsSet:it},Symbol.toStringTag,{value:"Module"})),ht="web3dEditor.settings.v1",pt=(e,t)=>{return{...e,...(n=t,"[object Object]"===Object.prototype.toString.call(n)?t:{})};var n};const mt={isWireframe:!1,isGridSnap:!1,isGridVisible:!0,gizmoSpace:"world",gizmoSize:.5,snapMove:1,snapRotateDeg:5,snapScale:.01,cameraPanSpeed:10,cameraOrbitSpeed:10,cameraZoomSpeed:.5,isPostProcessingEnabled:!1},gt={showLibrary:!1,showAssets:!0,isPostProcessingPanelOpen:!1,showHDRI:!1,isViewGizmoSettingsOpen:!1,dragUseSelectionForDnD:!1},bt={},ft={},yt={hdriSettings:{currentHDRI:{name:"기본 배경",type:"none"},hdriIntensity:1,hdriRotation:0,sunLightEnabled:!0,sunIntensity:1,timeOfDay:12,sunAzimuth:0,sunElevation:45,sunColor:"#ffffff"},postProcessing:{enabled:!1,preset:"default"},toneMapping:{enabled:!0,mapping:"ACESFilmic",exposure:1},safeMode:{enabled:!1,pixelRatio:1},rendererAA:"msaa",renderMode:"continuous"},vt={__version:1,viewGizmo:{...mt},ui:{...gt},editor:{...bt},game:{...ft},environment:{...yt}};function xt(e){const t=pt(vt,e);return t.viewGizmo=pt(mt,t.viewGizmo),t.ui=pt(gt,t.ui),t.editor=pt(bt,t.editor),t.game=pt(ft,t.game),t.environment=pt(yt,t.environment),t}function wt(e){const t=e||{},n=t.currentHDRI||null,r=n?{name:n.name,type:n.type,url:n.url||void 0}:null;return{hdriIntensity:Number.isFinite(t.hdriIntensity)?t.hdriIntensity:yt.hdriSettings.hdriIntensity,hdriRotation:Number.isFinite(t.hdriRotation)?t.hdriRotation:yt.hdriSettings.hdriRotation,sunLightEnabled:!!t.sunLightEnabled,sunIntensity:Number.isFinite(t.sunIntensity)?t.sunIntensity:yt.hdriSettings.sunIntensity,timeOfDay:Number.isFinite(t.timeOfDay)?t.timeOfDay:yt.hdriSettings.timeOfDay,sunAzimuth:Number.isFinite(t.sunAzimuth)?t.sunAzimuth:yt.hdriSettings.sunAzimuth,sunElevation:Number.isFinite(t.sunElevation)?t.sunElevation:yt.hdriSettings.sunElevation,sunColor:"string"==typeof t.sunColor?t.sunColor:yt.hdriSettings.sunColor,currentHDRI:r}}async function jt(){try{const e=await at();if(e&&"object"==typeof e)return xt(e)}catch{}return{...vt}}async function St(e){const t=xt(e||{});try{await it(ht,t)}catch{}return!0}async function Mt(e){const t=await jt();return null==t?void 0:t[e]}async function Ot(e,t){const n=await jt();return St({...n,[e]:pt((null==n?void 0:n[e])||{},t||{})})}function _t(e,t,n,r=150){if(!e||"function"!=typeof e.getState||"function"!=typeof e.subscribe)return()=>{};if("function"!=typeof n)return()=>{};let s=n(e.getState());const i=function(e,t=200){let n=null;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}}(e=>{try{Ot(t,e)}catch{}},r);return e.subscribe(e=>{try{const t=n(e);((e,t)=>{if(e===t)return!0;if(!e||!t)return!1;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const s of n)if(e[s]!==t[s])return!1;return!0})(t,s)||(s=t,i(t))}catch{}})}function Ct(e){return _t(e,"viewGizmo",e=>({isWireframe:!!e.isWireframe,isGridSnap:!!e.isGridSnap,isGridVisible:!!e.isGridVisible,gizmoSpace:e.gizmoSpace||"world",gizmoSize:Number.isFinite(e.gizmoSize)?e.gizmoSize:1,snapMove:Number.isFinite(e.snapMove)?e.snapMove:1,snapRotateDeg:Number.isFinite(e.snapRotateDeg)?e.snapRotateDeg:15,snapScale:Number.isFinite(e.snapScale)?e.snapScale:.1,isPostProcessingEnabled:!!e.isPostProcessingEnabled,cameraPanSpeed:Number.isFinite(e.cameraPanSpeed)?e.cameraPanSpeed:50,cameraOrbitSpeed:Number.isFinite(e.cameraOrbitSpeed)?e.cameraOrbitSpeed:100,cameraZoomSpeed:Number.isFinite(e.cameraZoomSpeed)?e.cameraZoomSpeed:.3}),150)}async function Dt(){const e=await Mt("viewGizmo");return pt(mt,e||{})}async function Et(){const e=await Mt("environment");return pt(yt,e||{})}async function Pt(e){return Ot("environment",e)}function zt(e){return _t(e,"environment",e=>{var t,n,r;return{hdriSettings:wt(e.hdriSettings),postProcessing:{enabled:!!e.isPostProcessingEnabled,preset:e.postProcessingPreset||"default"},safeMode:{enabled:!!(null==(t=e.safeMode)?void 0:t.enabled),pixelRatio:Number(null!=(r=null==(n=e.safeMode)?void 0:n.pixelRatio)?r:1)}}},200)}const Nt=Object.freeze(Object.defineProperty({__proto__:null,defaultAppSettings:vt,defaultEditorSettings:bt,defaultEnvironmentSettings:yt,defaultGameSettings:ft,defaultUISettings:gt,defaultViewGizmoConfig:mt,getAppSettingsAsync:jt,loadEnvironmentSettingsAsync:Et,loadSettingsSectionAsync:Mt,loadViewGizmoConfigAsync:Dt,sanitizeHDRISettings:wt,saveAppSettingsAsync:St,saveEnvironmentSettingsAsync:Pt,saveSettingsSectionAsync:Ot,startEnvironmentAutoPersist:zt,startSettingsAutoPersist:_t,startViewGizmoConfigAutoPersist:Ct},Symbol.toStringTag,{value:"Module"})),At="glb",kt="thumb",Lt="blobstores_migrated_v1";function Rt(){return new Promise((e,t)=>{const n=indexedDB.open("Web3DModelEditorBlobs",1);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains(At)||e.createObjectStore(At),e.objectStoreNames.contains(kt)||e.createObjectStore(kt)},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function It(e,t,n){const r=await Rt();return await new Promise((s,i)=>{const a=r.transaction(e,"readwrite").objectStore(e).put(n,t);a.onsuccess=()=>s(),a.onerror=()=>i(a.error)})}async function Tt(e,t){const n=await Rt();return await new Promise((r,s)=>{const i=n.transaction(e,"readonly").objectStore(e).get(t);i.onsuccess=()=>{var e;return r(null!=(e=i.result)?e:null)},i.onerror=()=>s(i.error)})}async function Ft(e,t){const n=await Rt();return await new Promise((r,s)=>{const i=n.transaction(e,"readwrite").objectStore(e).delete(t);i.onsuccess=()=>r(),i.onerror=()=>s(i.error)})}const Gt=async()=>{var e;try{await async function(){try{if(localStorage.getItem(Lt))return;const e=await ot();for(const t of e)if(t.glbData&&t.glbData.byteLength||"string"==typeof t.thumbnail&&t.thumbnail.startsWith("data:")){if(t.glbData&&await It(At,t.id,new Blob([t.glbData],{type:"model/gltf-binary"})),"string"==typeof t.thumbnail&&t.thumbnail.startsWith("data:")){const e=await(await fetch(t.thumbnail)).blob();await It(kt,t.id,e)}await lt({id:t.id,name:t.name,thumbnailStr:null})}localStorage.setItem(Lt,"1")}catch(e){}}();const t=await ot(),n=[];for(const r of t){const t=await Tt(At,r.id),s=await Tt(kt,r.id);n.push({id:r.id,name:r.name,glbData:t?await t.arrayBuffer():null!=(e=r.glbData)?e:null,thumbnail:s||r.thumbnail||null,createdAt:r.createdAt})}return n}catch(t){return[]}},Bt=async e=>{if(await lt({id:e.id,name:e.name,thumbnailStr:null}),e.glbData){const t=e.glbData instanceof Uint8Array?e.glbData:new Uint8Array(e.glbData);await It(At,e.id,new Blob([t],{type:"model/gltf-binary"}))}if(e.thumbnail)if(e.thumbnail instanceof Blob)await It(kt,e.id,e.thumbnail);else if("string"==typeof e.thumbnail)try{const t=await(await fetch(e.thumbnail)).blob();await It(kt,e.id,t)}catch(t){}},Ht=async e=>{await ct(e),await Ft(At,e),await Ft(kt,e)},Ut=async()=>{try{const e=localStorage.getItem("customMeshes");if(!e)return!1;const t=JSON.parse(e);if(!Array.isArray(t)||0===t.length)return localStorage.removeItem("customMeshes"),!1;for(const n of t)await Bt(n);return localStorage.removeItem("customMeshes"),!0}catch(e){return!1}},Vt=Object.freeze(Object.defineProperty({__proto__:null,idbAddCustomMesh:Bt,idbDeleteCustomMesh:Ht,idbGetAllCustomMeshes:Gt,idbGetCustomMesh:async e=>{var t,n,r,s;try{const i=(await ot()||[]).find(t=>t.id===e)||null;let a=await Tt(At,e),o=await Tt(kt,e);if(!a&&!(null==i?void 0:i.glbData)){const t=await async function(e){try{const t=(await ot()||[]).find(t=>t.id===e);if(!t)return!1;let n=!1;if(t.glbData){const r=t.glbData instanceof Uint8Array?t.glbData:new Uint8Array(t.glbData);await It(At,e,new Blob([r],{type:"model/gltf-binary"})),n=!0}if("string"==typeof t.thumbnail&&t.thumbnail.startsWith("data:"))try{const r=await(await fetch(t.thumbnail)).blob();await It(kt,e,r),n=!0}catch{}return n}catch(t){return!1}}(e);t&&(a=await Tt(At,e),o=await Tt(kt,e))}if(!a)try{const{migrateLocalStorageCustomMeshesToIDB:t}=await Ee(async()=>{const{migrateLocalStorageCustomMeshesToIDB:e}=await Promise.resolve().then(()=>Vt);return{migrateLocalStorageCustomMeshesToIDB:e}},void 0);await t()&&(a=await Tt(At,e),o||(o=await Tt(kt,e)))}catch{}return i||a?{id:e,name:null!=(t=null==i?void 0:i.name)?t:"",glbData:a||(null!=(n=null==i?void 0:i.glbData)?n:null),thumbnail:o||(null!=(r=null==i?void 0:i.thumbnail)?r:null),createdAt:null!=(s=null==i?void 0:i.createdAt)?s:Date.now()}:null}catch(i){return null}},migrateLocalStorageCustomMeshesToIDB:Ut},Symbol.toStringTag,{value:"Module"})),qt={...(null==yt?void 0:yt.hdriSettings)||{}},Wt=(e,t={x:0,y:0,z:0})=>{if(!e&&0!==e)return{...t};if(Array.isArray(e)){const[n=t.x,r=t.y,s=t.z]=e;return{x:n,y:r,z:s}}if("object"==typeof e){return{x:Number.isFinite(e.x)?e.x:t.x,y:Number.isFinite(e.y)?e.y:t.y,z:Number.isFinite(e.z)?e.z:t.z}}return{...t}},Kt=e=>{if(!e||"object"!=typeof e)return e;const t={...e};return t.position=Wt(e.position,{x:0,y:0,z:0}),t.rotation=Wt(e.rotation,{x:0,y:0,z:0}),t.scale=Wt(e.scale,{x:1,y:1,z:1}),t},$t=Oe((e,t)=>{var n,r;const s={...mt},i={...gt};return(async()=>{try{const t=await Promise.allSettled([Dt(),Mt("ui"),Et()]);try{if("fulfilled"===t[0].status&&t[0].value){const n=t[0].value;e(e=>({isWireframe:!!n.isWireframe,isGridSnap:!!n.isGridSnap,isGridVisible:!!n.isGridVisible,gizmoSpace:n.gizmoSpace||"world",gizmoSize:Number.isFinite(n.gizmoSize)?n.gizmoSize:e.gizmoSize,snapMove:Number.isFinite(n.snapMove)?n.snapMove:e.snapMove,snapRotateDeg:Number.isFinite(n.snapRotateDeg)?n.snapRotateDeg:e.snapRotateDeg,snapScale:Number.isFinite(n.snapScale)?n.snapScale:e.snapScale,cameraPanSpeed:Number.isFinite(n.cameraPanSpeed)?n.cameraPanSpeed:e.cameraPanSpeed,cameraOrbitSpeed:Number.isFinite(n.cameraOrbitSpeed)?n.cameraOrbitSpeed:e.cameraOrbitSpeed,cameraZoomSpeed:Number.isFinite(n.cameraZoomSpeed)?n.cameraZoomSpeed:e.cameraZoomSpeed,isPostProcessingEnabled:!!n.isPostProcessingEnabled}))}}finally{try{e({viewReady:!0})}catch{}}try{if("fulfilled"===t[1].status&&t[1].value){const n=t[1].value;e({showLibrary:!!n.showLibrary,showAssets:!!n.showAssets,isPostProcessingPanelOpen:!!n.isPostProcessingPanelOpen,showHDRI:!!n.showHDRI,isViewGizmoSettingsOpen:!!n.isViewGizmoSettingsOpen,dragUseSelectionForDnD:!!n.dragUseSelectionForDnD})}}finally{try{e({uiReady:!0})}catch{}}try{if("fulfilled"===t[2].status&&t[2].value){const n=t[2].value;e(e=>{var t,r,s;return{isPostProcessingEnabled:!!(null!=(r=null==(t=n.postProcessing)?void 0:t.enabled)?r:e.isPostProcessingEnabled),postProcessingPreset:(null==(s=n.postProcessing)?void 0:s.preset)||e.postProcessingPreset,safeMode:{...e.safeMode,...n.safeMode||{}},rendererAA:n.rendererAA||e.rendererAA,renderMode:n.renderMode||e.renderMode,hdriSettings:n.hdriSettings?{...e.hdriSettings,...n.hdriSettings}:e.hdriSettings}})}}finally{try{e({envReady:!0})}catch{}}}catch{try{e({viewReady:!0,uiReady:!0,envReady:!0})}catch{}}})(),{scene:null,camera:null,renderer:null,_historyPast:[],_historyFuture:[],_batchActive:!1,_batchBuffer:[],canUndo:!1,canRedo:!1,selectedObject:null,selectedIds:[],transformMode:"translate",isWireframe:!!s.isWireframe,isGridSnap:!!s.isGridSnap,isGridVisible:!!s.isGridVisible,gridSize:1,gizmoSpace:s.gizmoSpace||"world",gizmoSize:Number.isFinite(s.gizmoSize)?s.gizmoSize:.5,snapMove:Number.isFinite(s.snapMove)?s.snapMove:1,snapRotateDeg:Number.isFinite(s.snapRotateDeg)?s.snapRotateDeg:5,snapScale:Number.isFinite(s.snapScale)?s.snapScale:.01,cameraPanSpeed:Number.isFinite(s.cameraPanSpeed)?s.cameraPanSpeed:10,cameraOrbitSpeed:Number.isFinite(s.cameraOrbitSpeed)?s.cameraOrbitSpeed:10,cameraZoomSpeed:Number.isFinite(s.cameraZoomSpeed)?s.cameraZoomSpeed:.5,hdriSettings:{currentHDRI:{name:"기본 배경",type:"none"},hdriIntensity:1,hdriRotation:0,sunLightEnabled:!0,sunIntensity:1,timeOfDay:12,sunAzimuth:0,sunElevation:45,sunColor:"#ffffff",...qt},sunLightRef:null,dropIndicator:{easing:"easeInOutQuad",inMs:200,outMs:220,maxOpacity:.6},postProcessingManager:null,viewReady:!1,uiReady:!1,envReady:!1,isPostProcessingEnabled:!!(null==(n=null==yt?void 0:yt.postProcessing)?void 0:n.enabled),postProcessingPreset:(null==(r=null==yt?void 0:yt.postProcessing)?void 0:r.preset)||"default",safeMode:{enabled:!1,pixelRatio:1,notes:"Disables FXAA/SSAO and forces pixelRatio to 1.0 to reduce VRAM."},vramEstimateMB:0,stats:{fps:0,objects:0,vertices:0,triangles:0},rendererAA:(null==yt?void 0:yt.rendererAA)||"msaa",renderMode:(null==yt?void 0:yt.renderMode)||"continuous",savedObjects:new Map,customMeshes:[],objects:[],walls:[],annotations:[],clipboard:null,showLibrary:!!i.showLibrary,showAssets:!!i.showAssets,isPostProcessingPanelOpen:!!i.isPostProcessingPanelOpen,showHDRI:!!i.showHDRI,isViewGizmoSettingsOpen:!!i.isViewGizmoSettingsOpen,dragUseSelectionForDnD:!!i.dragUseSelectionForDnD,setShowLibrary:t=>e({showLibrary:!!t}),setShowAssets:t=>e({showAssets:!!t}),setIsPostProcessingPanelOpen:t=>e({isPostProcessingPanelOpen:!!t}),setShowHDRI:t=>e({showHDRI:!!t}),setIsViewGizmoSettingsOpen:t=>e({isViewGizmoSettingsOpen:!!t}),setDragUseSelectionForDnD:t=>e({dragUseSelectionForDnD:!!t}),setSelectedObject:t=>e({selectedObject:t}),setSelectedIds:t=>e({selectedIds:Array.isArray(t)?Array.from(new Set(t)):[]}),setTransformMode:t=>e({transformMode:t}),toggleWireframe:()=>e(e=>({isWireframe:!e.isWireframe})),toggleGridSnap:()=>e(e=>({isGridSnap:!e.isGridSnap})),toggleGridVisible:()=>e(e=>({isGridVisible:!e.isGridVisible})),setGridSize:t=>e({gridSize:t}),toggleGizmoSpace:()=>e(e=>({gizmoSpace:"world"===e.gizmoSpace?"local":"world"})),setGizmoSize:t=>e({gizmoSize:Math.max(.1,Math.min(5,Number(t)||1))}),setSnapMove:t=>e({snapMove:Math.max(.001,Math.min(1e3,Number(t)||1))}),setSnapRotateDeg:t=>e({snapRotateDeg:Math.max(.1,Math.min(360,Number(t)||15))}),setSnapScale:t=>e({snapScale:Math.max(.001,Math.min(100,Number(t)||.1))}),setCameraPanSpeed:t=>e({cameraPanSpeed:Math.max(1,Math.min(500,Number(t)||50))}),setCameraOrbitSpeed:t=>e({cameraOrbitSpeed:Math.max(1,Math.min(1e3,Number(t)||100))}),setCameraZoomSpeed:t=>e({cameraZoomSpeed:Math.max(.01,Math.min(5,Number(t)||.3))}),rehydrateViewGizmoConfig:async()=>{try{const t=await Dt();e({isWireframe:!!t.isWireframe,isGridSnap:!!t.isGridSnap,isGridVisible:!!t.isGridVisible,gizmoSpace:t.gizmoSpace||"world",gizmoSize:Number.isFinite(t.gizmoSize)?t.gizmoSize:.5,snapMove:Number.isFinite(t.snapMove)?t.snapMove:1,snapRotateDeg:Number.isFinite(t.snapRotateDeg)?t.snapRotateDeg:5,snapScale:Number.isFinite(t.snapScale)?t.snapScale:.01,isPostProcessingEnabled:!!t.isPostProcessingEnabled,cameraPanSpeed:Number.isFinite(t.cameraPanSpeed)?t.cameraPanSpeed:10,cameraOrbitSpeed:Number.isFinite(t.cameraOrbitSpeed)?t.cameraOrbitSpeed:10,cameraZoomSpeed:Number.isFinite(t.cameraZoomSpeed)?t.cameraZoomSpeed:.5})}catch{}},useBlenderControls:!0,setUseBlenderControls:t=>e({useBlenderControls:!!t}),updateHDRISettings:t=>e(e=>({hdriSettings:{...e.hdriSettings,...t}})),setSunLightRef:t=>e({sunLightRef:t}),updateDropIndicator:t=>e(e=>({dropIndicator:{...e.dropIndicator,...t}})),setPostProcessingManager:t=>e({postProcessingManager:t}),setRendererAA:n=>{var r;const s=["msaa","fxaa","none"].includes(n)?n:"msaa";e({rendererAA:s});try{Pt({rendererAA:s})}catch{}try{const e=t().postProcessingManager;e&&e.setEffectEnabled("fxaa","fxaa"===s&&!(null==(r=t().safeMode)?void 0:r.enabled))}catch{}},setRenderMode:t=>{const n=["continuous","on-demand"].includes(t)?t:"continuous";e({renderMode:n});try{Pt({renderMode:n})}catch{}},togglePostProcessingEnabled:()=>e(e=>({isPostProcessingEnabled:!e.isPostProcessingEnabled})),setPostProcessingPreset:t=>e({postProcessingPreset:t||"default"}),setStats:t=>e(e=>({stats:{...e.stats,...t}})),toggleSafeMode:n=>{const r=void 0!==n?!!n:!t().safeMode.enabled,s={...t().safeMode,enabled:r};e({safeMode:s});try{const e=t().postProcessingManager;e&&(e.setEffectEnabled("fxaa",!r),e.setEffectEnabled("ssao",!r),e.handleResize(window.innerWidth,window.innerHeight))}catch{}try{const e=t().renderer;if(e){const n=r?t().safeMode.pixelRatio||1:Math.min(2,window.devicePixelRatio||1);e.setPixelRatio(n)}}catch{}try{t().estimateVRAMUsage()}catch{}try{Pt({safeMode:{enabled:t().safeMode.enabled,pixelRatio:t().safeMode.pixelRatio}})}catch{}},setSafeModePixelRatio:n=>{const r=Math.max(.5,Math.min(2,Number(n)||1)),s={...t().safeMode,pixelRatio:r};e({safeMode:s});try{const e=t().renderer;e&&t().safeMode.enabled&&e.setPixelRatio(r)}catch{}try{const e=t().postProcessingManager;e&&e.handleResize(window.innerWidth,window.innerHeight)}catch{}try{t().estimateVRAMUsage()}catch{}try{Pt({safeMode:{enabled:t().safeMode.enabled,pixelRatio:r}})}catch{}},estimateVRAMUsage:(n={})=>{var r,s,i,a,o;const l=n.width||window.innerWidth,c=n.height||window.innerHeight;let d=1;try{d=(null==(s=null==(r=t().renderer)?void 0:r.getPixelRatio)?void 0:s.call(r))||window.devicePixelRatio||1}catch{}const u=Math.max(1,Math.floor(l*d)),h=Math.max(1,Math.floor(c*d));let p=u*h*8;try{const e=t().postProcessingManager,n=t().isPostProcessingEnabled;if(e&&n){p+=u*h*8;const t=(null==(i=e.getSettings)?void 0:i.call(e))||{};(null==(a=t.ssao)?void 0:a.enabled)&&(p+=u*h*2*4),(null==(o=t.fxaa)?void 0:o.enabled)&&(p+=u*h*4)}}catch{}const m=Math.round(p/1048576);return e({vramEstimateMB:m}),m},initializeHDRISettings:()=>!1,saveHDRISettings:async()=>{const{hdriSettings:e}=t();try{const{sanitizeHDRISettings:t}=await Ee(async()=>{const{sanitizeHDRISettings:e}=await Promise.resolve().then(()=>Nt);return{sanitizeHDRISettings:e}},void 0),n=t(e);await Pt({hdriSettings:n})}catch{}},addAsset:(t,n)=>e(e=>{const r=new Map(e.savedObjects);return r.set(t,n),{savedObjects:r}}),addCustomMesh:async t=>{try{await Bt(t),e(e=>({customMeshes:[...e.customMeshes,t]}))}catch(n){try{window.dispatchEvent(new CustomEvent("appToast",{detail:{message:"저장에 실패했습니다 (IndexedDB).",type:"error",duration:3e3}}))}catch{}}},deleteCustomMesh:async t=>{try{await Ht(t),e(e=>({customMeshes:e.customMeshes.filter(e=>e.id!==t)}))}catch(n){try{window.dispatchEvent(new CustomEvent("appToast",{detail:{message:"삭제에 실패했습니다 (IndexedDB).",type:"error",duration:3e3}}))}catch{}}},loadCustomMeshes:t=>e(()=>({customMeshes:(Array.isArray(t)?t:[]).map(e=>({...e,type:"custom"}))})),updateObjectTransform:(n,r)=>e(e=>{const s=Kt(r),i=e.objects.find(e=>e.id===n),a=i?{...i,...s}:null,o=e.objects.map(e=>e.id===n?{...e,...s}:e);if(i){const e={type:"transform",id:n,before:Xt(i),after:Xt(a)},{_pushHistory:r}=t();r(e)}return{objects:o}}),addObject:n=>e(e=>{var r;const s=Kt(n),i=Object.prototype.hasOwnProperty.call(s,"parentId")&&null!=(r=s.parentId)?r:null;let a=s.order;if(!Number.isFinite(a)){a=e.objects.filter(e=>{var t;return(null!=(t=e.parentId)?t:null)===i}).reduce((e,t)=>Number.isFinite(t.order)?Math.max(e,t.order):e,-1)+1}const o={...s,parentId:i,order:a},l=[...e.objects,o],c={type:"add",object:Zt(o)},{_pushHistory:d}=t();return d(c),{objects:l}}),removeObject:n=>e(e=>{if(n.isSystemObject)return e;const r=e.objects.filter(e=>e!==n),s={type:"remove",object:Zt(n)},{_pushHistory:i}=t();return i(s),{objects:r,selectedObject:e.selectedObject===n?null:e.selectedObject}}),removeObjectById:n=>e(e=>{var r,s;const i=e.objects.find(e=>e.id===n);if(!i)return{};if(i.isSystemObject)return{};const{_pushHistory:a}=t(),o=e.objects.filter(e=>e.parentId===n);let l=e.objects;for(const t of o){const e=null!=(r=t.parentId)?r:null,n=null!=(s=i.parentId)?s:null;e!==n&&(a({type:"reparent",id:t.id,before:{parentId:e},after:{parentId:n}}),l=l.map(e=>e.id===t.id?{...e,parentId:n}:e))}a({type:"remove",object:Zt(i)});return{objects:l.filter(e=>e.id!==n),annotations:(e.annotations||[]).filter(e=>e.ownerId!==n),selectedObject:e.selectedObject&&("object"==typeof e.selectedObject?e.selectedObject.id:e.selectedObject)===n?null:e.selectedObject}}),setParent:(n,r)=>e(e=>{var s;const i=e.objects.find(e=>e.id===n);if(!i)return{};const a=null!=(s=i.parentId)?s:null,o=null!=r?r:null;if(a===o)return{};const l={type:"reparent",id:n,before:{parentId:a},after:{parentId:o}},{_pushHistory:c}=t();c(l);const d=e.objects.filter(e=>{var t;return(null!=(t=e.parentId)?t:null)===o&&e.id!==n}).reduce((e,t)=>Number.isFinite(t.order)?Math.max(e,t.order):e,-1)+1;return{objects:e.objects.map(e=>e.id===n?{...e,parentId:o,order:d}:e)}}),reorderSiblings:(t,n)=>e(e=>{if(!Array.isArray(n))return{};const r=new Map(n.map((e,t)=>[e,t]));return{objects:e.objects.map(e=>{var n;return(null!=(n=e.parentId)?n:null)!==(null!=t?t:null)?e:r.has(e.id)?{...e,order:r.get(e.id)}:e})}}),addWall:t=>e(e=>({walls:[...e.walls,t]})),removeWall:t=>e(e=>({walls:e.walls.filter(e=>e.id!==t)})),updateObject:(n,r)=>e(e=>{const s=e.objects.find(e=>e.id===n),i=Kt(r),a=e.objects.map(e=>e.id===n?{...e,...i}:e);if(s){const e={type:"update",id:n,before:Yt(s,i),after:i},{_pushHistory:r}=t();r(e)}return{objects:a}}),copyObject:n=>{var r,s,i,a,o;if(!n)return;if(n.isObject3D){t();const l=null==(r=n.userData)?void 0:r.id;if(l){const{updateObjectTransform:e}=t();e(l,{position:{x:n.position.x,y:n.position.y,z:n.position.z},rotation:{x:n.rotation.x,y:n.rotation.y,z:n.rotation.z},scale:{x:n.scale.x,y:n.scale.y,z:n.scale.z}})}const c=t().objects.find(e=>e.id===l),d={name:`${n.name}_copy`,type:(null==c?void 0:c.type)||(null==(s=n.userData)?void 0:s.type)||"basic",geometry:(null==c?void 0:c.geometry)||(null==(i=n.userData)?void 0:i.geometry)||"BoxGeometry",params:(null==c?void 0:c.params)||(null==(a=n.userData)?void 0:a.params)||[1,1,1],uuid:n.uuid,..."glb"===(null==c?void 0:c.type)&&{url:c.url,customMeshId:c.customMeshId,file:void 0},position:{x:n.position.x,y:n.position.y,z:n.position.z},rotation:{x:n.rotation.x,y:n.rotation.y,z:n.rotation.z},scale:{x:n.scale.x,y:n.scale.y,z:n.scale.z},visible:n.visible,material:(null==c?void 0:c.material)||(null==(o=n.userData)?void 0:o.material)||{type:"MeshStandardMaterial",color:16711680},originalObject:n};return void e({clipboard:d})}if(n.isSystemObject)return;const l={...n,id:void 0,name:`${n.name}_copy`};e({clipboard:l})},pasteObject:()=>{var n,r,s,i,a,o,l,c,d;const u=t();if(!u.clipboard)return null;const h={...u.clipboard,id:Date.now(),position:{x:(null==(n=u.clipboard.position)?void 0:n.x)||0,y:(null==(r=u.clipboard.position)?void 0:r.y)||0,z:(null==(s=u.clipboard.position)?void 0:s.z)||0},rotation:{x:(null==(i=u.clipboard.rotation)?void 0:i.x)||0,y:(null==(a=u.clipboard.rotation)?void 0:a.y)||0,z:(null==(o=u.clipboard.rotation)?void 0:o.z)||0},scale:{x:(null==(l=u.clipboard.scale)?void 0:l.x)||1,y:(null==(c=u.clipboard.scale)?void 0:c.y)||1,z:(null==(d=u.clipboard.scale)?void 0:d.z)||1}},p=[...u.objects,h];return e({objects:p,selectedObject:h.id}),h},hasClipboardData:()=>null!==t().clipboard,clearClipboard:()=>e({clipboard:null}),deleteSelectedObject:()=>{const n=t();if(!n.selectedObject)return;const r="object"==typeof n.selectedObject?n.selectedObject.id:n.selectedObject;if(!r)return;const s=n.objects.find(e=>e.id===r);if(!s)return;if(s.isSystemObject)return;const i=n.objects.filter(e=>e.id!==r),a={type:"remove",object:Zt(s)},{_pushHistory:o}=t();o(a);const l=(n.annotations||[]).filter(e=>e.ownerId!==r);e({objects:i,annotations:l,selectedObject:null})},updateWall:(t,n)=>e(e=>({walls:e.walls.map(e=>e.id===t?{...e,...n}:e)})),toggleObjectVisibility:n=>e(e=>{const r=!1===n.visible,s=e.objects.map(e=>e.id===n.id?{...e,visible:r}:e),i={type:"update",id:n.id,before:{visible:n.visible},after:{visible:r}},{_pushHistory:a}=t();a(i);return{objects:s,walls:e.walls.map(e=>e.id===n.id?{...e,visible:r}:e)}}),toggleObjectFreeze:n=>e(e=>{const r=!0!==n.frozen,s=e.objects.map(e=>e.id===n.id?{...e,frozen:r}:e),i={type:"update",id:n.id,before:{frozen:n.frozen},after:{frozen:r}},{_pushHistory:a}=t();a(i);return{objects:s,walls:e.walls.map(e=>e.id===n.id?{...e,frozen:r}:e)}}),renameObject:(n,r)=>e(e=>{const s=e.objects.find(e=>e.id===n),i=e.objects.map(e=>e.id===n?{...e,name:r}:e);if(s){const e={type:"update",id:n,before:{name:s.name},after:{name:r}},{_pushHistory:i}=t();i(e)}return{objects:i,walls:e.walls.map(e=>e.id===n?{...e,name:r}:e)}}),syncSceneToState:()=>{const n=t(),r=n.scene;if(!r)return!1;const s=new Map;try{r.traverse(e=>{var t;const n=null==(t=null==e?void 0:e.userData)?void 0:t.id;n&&s.set(n,e)})}catch{}const i=n.objects.map(e=>{const t=Kt(e),n=s.get(e.id);if(!n||!n.isObject3D)return t;const r={...t,position:{x:n.position.x,y:n.position.y,z:n.position.z},rotation:{x:n.rotation.x,y:n.rotation.y,z:n.rotation.z},scale:{x:n.scale.x,y:n.scale.y,z:n.scale.z}};try{const t=e.type,s="light"===t?e.lightType:"directional_light"===t?"directional":"point_light"===t?"point":"spot_light"===t?"spot":null;n.isLight&&s&&("number"==typeof n.intensity&&(r.intensity=n.intensity),n.color&&"function"==typeof n.color.getHex&&(r.color=n.color.getHex()),r.castShadow=!!n.castShadow,"point"!==s&&"spot"!==s||("number"==typeof n.distance&&(r.distance=n.distance),"number"==typeof n.decay&&(r.decay=n.decay)),"spot"===s&&("number"==typeof n.angle&&(r.angle=n.angle),"number"==typeof n.penumbra&&(r.penumbra=n.penumbra)))}catch{}return r});return e({objects:i}),!0},saveMap:async(e,n)=>{var r;const s=t();try{null==(r=s.syncSceneToState)||r.call(s)}catch{}const i=s.objects.map(e=>{if("glb"===(null==e?void 0:e.type)){const{glbData:t,...n}=e||{};return{...n}}return e});let a=n;try{if(!a){const e=s.camera;a=e?{camera:{type:e.type,position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},zoom:"number"==typeof e.zoom?e.zoom:void 0},viewport:{isWireframe:!!s.isWireframe,isGridSnap:!!s.isGridSnap,isGridVisible:!!s.isGridVisible,gizmoSpace:s.gizmoSpace,gizmoSize:s.gizmoSize,snapMove:s.snapMove,snapRotateDeg:s.snapRotateDeg,snapScale:s.snapScale,rendererAA:s.rendererAA,renderMode:s.renderMode,isPostProcessingEnabled:!!s.isPostProcessingEnabled,postProcessingPreset:s.postProcessingPreset,safeMode:{...s.safeMode},hdriSettings:{...s.hdriSettings}}}:void 0}}catch{}const o={__version:1,walls:s.walls,objects:i,annotations:Array.isArray(s.annotations)?s.annotations:[],viewState:a||void 0};let l=!1;try{const{mapsUpsert:t}=await Ee(async()=>{const{mapsUpsert:e}=await Promise.resolve().then(()=>ut);return{mapsUpsert:e}},void 0);await t(String(e||""),o,o.__version),l=!0}catch(c){}try{localStorage.setItem(`map_${e}`,JSON.stringify(o))}catch{}},getMapData:async e=>{try{const{mapsGet:t}=await Ee(async()=>{const{mapsGet:e}=await Promise.resolve().then(()=>ut);return{mapsGet:e}},void 0),n=await t(String(e||""));if(n)return n}catch{}try{const t=localStorage.getItem(`map_${e}`);if(!t)return null;const n=JSON.parse(t);return n&&!("__version"in n)&&(n.__version=1),n}catch{return null}},listMaps:async()=>{const e=[];try{const{mapsList:t}=await Ee(async()=>{const{mapsList:e}=await Promise.resolve().then(()=>ut);return{mapsList:e}},void 0),n=await t();Array.isArray(n)&&e.push(...n)}catch{}try{const t=Object.keys(localStorage||{}).filter(e=>e.startsWith("map_")),n=new Set(e.map(e=>String(e.name)));for(const r of t){const t=r.substring(4);n.has(t)||e.push({name:t,version:1,updated_at:null})}}catch{}return e.sort((e,t)=>(t.updated_at||0)-(e.updated_at||0)),e},deleteMap:async e=>{const t=String(e||"");try{const{mapsDelete:e}=await Ee(async()=>{const{mapsDelete:e}=await Promise.resolve().then(()=>ut);return{mapsDelete:e}},void 0);await e(t);try{localStorage.removeItem(`map_${t}`)}catch{}return!0}catch{try{localStorage.removeItem(`map_${t}`)}catch{}return!1}},loadMap:async n=>{let r=null;try{const{mapsGet:e}=await Ee(async()=>{const{mapsGet:e}=await Promise.resolve().then(()=>ut);return{mapsGet:e}},void 0);r=await e(String(n||""))}catch{}if(!r){const e=localStorage.getItem(`map_${n}`);if(e)try{r=JSON.parse(e)}catch{r=null}}if(r){"__version"in r||(r.__version=1);const n=(r.objects||[]).map(e=>{var t,n,r,s,i,a,o,l,c,d;const u=Kt(e);if("glb"===(null==u?void 0:u.type)&&(!u.glbData||"object"!=typeof u.glbData||Array.isArray(u.glbData)||u.glbData instanceof ArrayBuffer||u.glbData instanceof Uint8Array||delete u.glbData),(null==u?void 0:u.type)||(u.url||u.file?u.type="glb":u.geometry&&u.params?u.type="basic":u.size&&u.material&&(u.type="cube")),"glb"!==(null==u?void 0:u.type)||u.url||u.file||u.customMeshId||u.glbData||((null==(n=null==(t=u.userData)?void 0:t.originalData)?void 0:n.id)&&(u.customMeshId=u.userData.originalData.id),!u.customMeshId&&(null==(r=u.userData)?void 0:r.customMeshId)&&(u.customMeshId=u.userData.customMeshId),!u.customMeshId&&(null==(s=u.userData)?void 0:s.url)&&(u.url=u.userData.url)),"mesh"===(null==u?void 0:u.type)&&!u.geometry&&!u.params&&("basic"===(null==(i=u.userData)?void 0:i.type)||(null==(a=u.userData)?void 0:a.geometry))){const e=(null==(o=u.userData)?void 0:o.originalName)||u.name||"",t=String(e).toLowerCase();let n=null==(l=u.userData)?void 0:l.geometry,r=null==(c=u.userData)?void 0:c.params;n||(t.includes("정육면체")||t.includes("box")?(n="BoxGeometry",r=[1,1,1]):t.includes("구체")||t.includes("sphere")?(n="SphereGeometry",r=[.5,32,16]):t.includes("원기둥")||t.includes("cylinder")?(n="CylinderGeometry",r=[.5,.5,1,32]):t.includes("원뿔")||t.includes("cone")?(n="ConeGeometry",r=[.5,1,32]):t.includes("평면")||t.includes("plane")?(n="PlaneGeometry",r=[1,1]):(t.includes("도넛")||t.includes("torus"))&&(n="TorusGeometry",r=[.5,.2,16,100])),n&&(u.type="basic",u.geometry=n,u.params=r||[])}const h=Object.prototype.hasOwnProperty.call(u,"parentId")&&null!=(d=u.parentId)?d:null;let p=u.order;return Number.isFinite(p)||(p=0),{...u,parentId:h,order:p}}),s=(r.walls||[]).map(Kt),i=Array.isArray(r.annotations)?r.annotations.map(e=>{var t;return{id:(null==e?void 0:e.id)||`ann_${Date.now()}_${Math.random().toString(36).slice(2,7)}`,ownerId:null!=(t=null==e?void 0:e.ownerId)?t:null,text:"string"==typeof(null==e?void 0:e.text)?e.text:"",local:Wt(null==e?void 0:e.local,{x:0,y:0,z:0})}}):[];e(()=>({walls:s,objects:n,annotations:i}));try{requestAnimationFrame(()=>{var e,n;try{null==(n=(e=t()).pruneOrphanSceneObjects)||n.call(e)}catch{}})}catch{}try{const n=r.viewState;if(n){const r={};if(n.viewport){const e=n.viewport;r.isWireframe=!!e.isWireframe,r.isGridSnap=!!e.isGridSnap,r.isGridVisible=!!e.isGridVisible,r.gizmoSpace=e.gizmoSpace||t().gizmoSpace,Number.isFinite(e.gizmoSize)&&(r.gizmoSize=e.gizmoSize),Number.isFinite(e.snapMove)&&(r.snapMove=e.snapMove),Number.isFinite(e.snapRotateDeg)&&(r.snapRotateDeg=e.snapRotateDeg),Number.isFinite(e.snapScale)&&(r.snapScale=e.snapScale),e.rendererAA&&(r.rendererAA=e.rendererAA),e.renderMode&&(r.renderMode=e.renderMode),r.isPostProcessingEnabled=!!e.isPostProcessingEnabled,e.postProcessingPreset&&(r.postProcessingPreset=e.postProcessingPreset),e.safeMode&&(r.safeMode={...t().safeMode,...e.safeMode}),e.hdriSettings&&(r.hdriSettings={...t().hdriSettings,...e.hdriSettings})}Object.keys(r).length>0&&e(r)}}catch{}return!0}return!1},clearMap:()=>{const n=t();e({objects:(n.objects||[]).filter(e=>e.isSystemObject),walls:[],annotations:[],selectedObject:null,selectedIds:[]});try{const e=t().scene;if(e){const n=new Set((t().objects||[]).map(e=>e.id)),r=[];e.traverse(e=>{var t,s,i;if(null==(t=null==e?void 0:e.userData)?void 0:t.isSystemObject)return;if(null==(s=null==e?void 0:e.userData)?void 0:s.isSelectionOutline)return;const a=null==(i=null==e?void 0:e.userData)?void 0:i.id;a&&n.has(a)||r.push(e)}),r.forEach(t=>{try{t.parent?t.parent.remove(t):e.remove(t)}catch{}})}}catch{}try{requestAnimationFrame(()=>{var e,n;try{null==(n=(e=t()).pruneOrphanSceneObjects)||n.call(e)}catch{}})}catch{}try{window.dispatchEvent(new CustomEvent("annotationsCleared"))}catch{}},addAnnotation:t=>e(e=>{var n;const r=(null==t?void 0:t.id)||`ann_${Date.now()}_${Math.random().toString(36).slice(2,7)}`,s=null!=(n=null==t?void 0:t.ownerId)?n:null,i="string"==typeof(null==t?void 0:t.text)?t.text:"",a=Wt(null==t?void 0:t.local,{x:0,y:0,z:0});return{annotations:[...e.annotations||[],{id:r,ownerId:s,text:i,local:a}]}}),removeAnnotation:t=>e(e=>({annotations:(e.annotations||[]).filter(e=>e.id!==t)})),setAnnotations:t=>e({annotations:Array.isArray(t)?t.map(e=>{var t;return{id:(null==e?void 0:e.id)||`ann_${Date.now()}_${Math.random().toString(36).slice(2,7)}`,ownerId:null!=(t=null==e?void 0:e.ownerId)?t:null,text:"string"==typeof(null==e?void 0:e.text)?e.text:"",local:Wt(null==e?void 0:e.local,{x:0,y:0,z:0})}}):[]}),pruneOrphanSceneObjects:()=>{try{const e=t().scene;if(!e)return;const n=new Set((t().objects||[]).map(e=>e.id)),r=[];e.traverse(e=>{var t,s,i;if(null==(t=null==e?void 0:e.userData)?void 0:t.isSystemObject)return;if(null==(s=null==e?void 0:e.userData)?void 0:s.isSelectionOutline)return;const a=null==(i=null==e?void 0:e.userData)?void 0:i.id;if(!a||!n.has(a)){const t=(e.name||"").toLowerCase();if(t.includes("transformcontrols")||t.includes("gizmo")||t.includes("helper"))return;r.push(e)}}),r.forEach(t=>{try{t.parent?t.parent.remove(t):e.remove(t)}catch{}})}catch{}},setScene:(t,n,r)=>e({scene:t,camera:n,renderer:r}),_pushHistory:n=>{const{_batchActive:r,_historyPast:s}=t();if(r)return void e(e=>({_batchBuffer:[...e._batchBuffer,n]}));const i=[...s,n];e({_historyPast:i,_historyFuture:[],canUndo:i.length>0,canRedo:!1})},beginBatch:()=>e({_batchActive:!0,_batchBuffer:[]}),endBatch:()=>e(e=>{if(!e._batchActive)return{};const t=e._batchBuffer;if(0===t.length)return{_batchActive:!1,_batchBuffer:[]};const n={type:"batch",entries:t},r=[...e._historyPast,n];return{_batchActive:!1,_batchBuffer:[],_historyPast:r,_historyFuture:[],canUndo:r.length>0,canRedo:!1}}),undo:()=>{const n=t(),r=[...n._historyPast];if(0===r.length)return!1;try{n.setSelectedObject&&n.setSelectedObject(null),n.setSelectedIds&&n.setSelectedIds([])}catch{}const s=r.pop();Qt(s,e,t);const i=[...n._historyFuture,s];return e({_historyPast:r,_historyFuture:i,canUndo:r.length>0,canRedo:i.length>0}),!0},redo:()=>{const n=t(),r=[...n._historyFuture];if(0===r.length)return!1;try{n.setSelectedObject&&n.setSelectedObject(null),n.setSelectedIds&&n.setSelectedIds([])}catch{}const s=r.pop();Jt(s,e,t);const i=[...n._historyPast,s];return e({_historyFuture:r,_historyPast:i,canUndo:i.length>0,canRedo:r.length>0}),!0}}});try{Ct($t)}catch{}try{zt($t)}catch{}try{_t($t,"ui",e=>({showLibrary:!!e.showLibrary,showAssets:!!e.showAssets,isPostProcessingPanelOpen:!!e.isPostProcessingPanelOpen,showHDRI:!!e.showHDRI,isViewGizmoSettingsOpen:!!e.isViewGizmoSettingsOpen,dragUseSelectionForDnD:!!e.dragUseSelectionForDnD}),120)}catch{}function Zt(e){if(!e||"object"!=typeof e)return e;const t={...e};return"glbData"in t&&delete t.glbData,"file"in t&&delete t.file,t}function Xt(e){return{position:Wt(e.position,{x:0,y:0,z:0}),rotation:Wt(e.rotation,{x:0,y:0,z:0}),scale:Wt(e.scale,{x:1,y:1,z:1})}}function Yt(e,t){const n={},r=["name","visible","frozen","parentId","position","rotation","scale"];for(const s of r)s in t&&(n[s]="position"===s||"rotation"===s||"scale"===s?Wt(e[s],"scale"===s?{x:1,y:1,z:1}:{x:0,y:0,z:0}):e[s]);return n}function Qt(e,t,n){var r;if(e)switch(e.type){case"part-transform":{const t=n().scene;if(!t)break;const r=Array.isArray(e.parts)&&e.parts.length>0?e.parts:e.part&&e.before&&e.after?[{uuid:e.part.uuid,before:e.before}]:[];for(const n of r){const r=n.uuid,s=n.before||e.before;if(!r||!s)continue;let i=null;if(t.traverse(e=>{i||e.uuid!==r||(i=e)}),i&&i.isObject3D)try{i.position.set(s.position.x,s.position.y,s.position.z),i.rotation.set(s.rotation.x,s.rotation.y,s.rotation.z),i.scale.set(s.scale.x,s.scale.y,s.scale.z),i.updateMatrix(),i.updateMatrixWorld(!0)}catch{}}break}case"batch":for(let r=e.entries.length-1;r>=0;r--)Qt(e.entries[r],t,n);break;case"reparent":{const r=n(),s=e.id,i=e.before;if(!s||!i)break;t({objects:r.objects.map(e=>{var t;return e.id===s?{...e,parentId:null!=(t=i.parentId)?t:null}:e})});break}case"add":{const s=null==(r=e.object)?void 0:r.id;if(!s)break;t({objects:n().objects.filter(e=>e.id!==s)});break}case"remove":{const r=n(),s=e.object;if(!s)break;t({objects:[...r.objects,Kt(s)]});break}case"update":case"transform":{const r=n(),s=e.id,i=e.before;if(!s||!i)break;t({objects:r.objects.map(e=>e.id===s?{...e,...Kt(i)}:e)});break}}}function Jt(e,t,n){var r;if(e)switch(e.type){case"part-transform":{const t=n().scene;if(!t)break;const r=Array.isArray(e.parts)&&e.parts.length>0?e.parts:e.part&&e.before&&e.after?[{uuid:e.part.uuid,after:e.after}]:[];for(const n of r){const r=n.uuid,s=n.after||e.after;if(!r||!s)continue;let i=null;if(t.traverse(e=>{i||e.uuid!==r||(i=e)}),i&&i.isObject3D)try{i.position.set(s.position.x,s.position.y,s.position.z),i.rotation.set(s.rotation.x,s.rotation.y,s.rotation.z),i.scale.set(s.scale.x,s.scale.y,s.scale.z),i.updateMatrix(),i.updateMatrixWorld(!0)}catch{}}break}case"batch":for(let r=0;r<e.entries.length;r++)Jt(e.entries[r],t,n);break;case"reparent":{const r=n(),s=e.id,i=e.after;if(!s||!i)break;t({objects:r.objects.map(e=>{var t;return e.id===s?{...e,parentId:null!=(t=i.parentId)?t:null}:e})});break}case"add":{const r=n(),s=e.object;if(!s)break;t({objects:[...r.objects,Kt(s)]});break}case"remove":{const s=null==(r=e.object)?void 0:r.id;if(!s)break;t({objects:n().objects.filter(e=>e.id!==s)});break}case"update":case"transform":{const r=n(),s=e.id,i=e.after;if(!s||!i)break;t({objects:r.objects.map(e=>e.id===s?{...e,...Kt(i)}:e)});break}}}class en{constructor(e,t,n=null){this.camera=e,this.renderer=t,this.onCameraChange=n,this.initialPosition=e.position.clone(),this.initialTarget=new p(0,0,0),this.cameraTarget=new p(0,0,0),this.spherical=new m,this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget)),this._tempVector1=new p,this._tempVector2=new p,this._tempVector3=new p,this._panSpeed=50,this._orbitSpeed=100,this._zoomSpeed=.3}resetCamera(){this.camera.position.copy(this.initialPosition),this.cameraTarget.copy(this.initialTarget),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}toggleProjection(){const e=this.camera,t=e.position.clone(),n=this.cameraTarget.clone();if(e.isPerspectiveCamera){const e=t.distanceTo(n),r=window.innerWidth/window.innerHeight,s=.5*e,i=new g(s*r/-2,s*r/2,s/2,s/-2,.1,1e3);i.position.copy(t),i.lookAt(n),i.updateMatrixWorld(),this.camera=i}else{const e=new b(75,window.innerWidth/window.innerHeight,.1,1e3);e.position.copy(t),e.lookAt(n),e.updateMatrixWorld(),this.camera=e}return this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget)),this.onCameraChange&&this.onCameraChange(this.camera),this.camera}setView(e){const t=this.camera.position.distanceTo(this.cameraTarget),n=this.cameraTarget.clone();let r=new p;switch(e){case"front":r.set(n.x,n.y,n.z+t);break;case"side":r.set(n.x+t,n.y,n.z);break;case"top":r.set(n.x,n.y+t,n.z);break;case"bottom":r.set(n.x,n.y-t,n.z);break;default:return}this.camera.position.copy(r),this.camera.lookAt(n),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}pan(e,t){const n=this._panSpeed,r=new p,s=new p;r.setFromMatrixColumn(this.camera.matrix,0),s.setFromMatrixColumn(this.camera.matrix,1);const i=n*(this.camera.position.distanceTo(this.cameraTarget)/50),a=new p;a.add(r.clone().multiplyScalar(-e*i)),a.add(s.clone().multiplyScalar(-t*i)),this.camera.position.add(a),this.cameraTarget.add(a),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}updateRotationCenterAfterPan(e,t=[]){const n=new f,r=new y(0,0);n.setFromCamera(r,this.camera);const s=n.intersectObjects(t,!0);if(s.length>0){const e=s[0].point;this.cameraTarget.copy(e)}else{const e=new p;e.setFromMatrixColumn(this.camera.matrix,2).negate();const t=this.camera.position.clone().add(e.multiplyScalar(50));this.cameraTarget.copy(t)}this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}orbit(e,t){const n=this._orbitSpeed;this.spherical.theta-=e*n*.01,this.spherical.phi+=t*n*.01,this.spherical.phi=Math.max(.1,Math.min(Math.PI-.1,this.spherical.phi));const r=new p;r.setFromSpherical(this.spherical),r.add(this.cameraTarget),this.camera.position.copy(r),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld()}zoom(e){const t=Math.max(.01,this._zoomSpeed),n=e>0?1+t:1/(1+t);if(this.camera.isPerspectiveCamera){this.spherical.radius*=n,this.spherical.radius=Math.max(1,Math.min(1e3,this.spherical.radius));const e=new p;e.setFromSpherical(this.spherical),e.add(this.cameraTarget),this.camera.position.copy(e),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld()}else if(this.camera.isOrthographicCamera){const e=(this.camera.right-this.camera.left)*n,t=(this.camera.top-this.camera.bottom)*n,r=2e3,s=.1,i=Math.max(s,Math.min(r,e)),a=Math.max(s,Math.min(r,t));this.camera.left=-i/2,this.camera.right=i/2,this.camera.top=a/2,this.camera.bottom=-a/2,this.camera.updateProjectionMatrix()}}setSpeeds({pan:e,orbit:t,zoom:n}={}){Number.isFinite(e)&&(this._panSpeed=e),Number.isFinite(t)&&(this._orbitSpeed=t),Number.isFinite(n)&&(this._zoomSpeed=n)}focusOnObject(e){if(!e)return;const t=(new v).setFromObject(e),n=t.getCenter(new p),r=t.getSize(new p),s=Math.max(r.x,r.y,r.z);let i;if(this.camera.isPerspectiveCamera){const e=this.camera.fov*(Math.PI/180);i=1.5*Math.abs(s/Math.sin(e/2))}else i=2*s;this.cameraTarget.copy(n);const a=new p;a.subVectors(this.camera.position,this.cameraTarget).normalize(),this.camera.position.copy(n).add(a.multiplyScalar(i)),this.camera.lookAt(this.cameraTarget),this.camera.updateMatrixWorld(),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}handleResize(){if(this.camera.isPerspectiveCamera)this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix();else if(this.camera.isOrthographicCamera){const e=window.innerWidth/window.innerHeight,t=(this.camera.top-this.camera.bottom)*e;this.camera.left=-t/2,this.camera.right=t/2,this.camera.updateProjectionMatrix()}}setTarget(e){this.cameraTarget.copy(e),this.spherical.setFromVector3(this.camera.position.clone().sub(this.cameraTarget))}getCamera(){return this.camera}getTarget(){return this.cameraTarget.clone()}}class tn{constructor(e,t,n,r){this.scene=e,this.camera=t,this.renderer=n,this.editorStore=r,this.gizmoScene=null,this.selectedObjects=[],this.lastSelectedObject=null,this.selectableObjects=[],this.raycaster=new f,this.selectionBox=null,this.createSelectionBox(),this.transformControls=null,this.gizmoMode="translate",this.isDragging=!1,this.snapEnabled=!1,this.gridSize=1,this.tempGroup=null,this.tempGroupCenter=new p,this.initialTransformStates=new Map,this.initializeTransformControls(),this._pendingTransformUpdates=new Map,this._rafScheduled=!1,this.postProcessingManager=null}_requestRender(){try{"undefined"!=typeof window&&"function"==typeof window.__requestRender&&window.__requestRender()}catch{}}_shouldUseFallbackOutline(){return!0}forceHideGizmoLines(){var e,t,n;try{const r=null==(t=null==(e=this.transformControls)?void 0:e.getHelper)?void 0:t.call(e);if(!r||!r.isObject3D)return;const s=this.gizmoScene||this.scene;r.parent!==s&&(r.parent&&r.parent.remove(r),s.add(r));const i=[];null==(n=r.traverse)||n.call(r,e=>{if(!e)return;const t="Line"===e.type||"Line2"===e.type||"LineSegments"===e.type||"LineSegments2"===e.type||e.isLine,n=e.material&&(e.material.isLineBasicMaterial||e.material.isLineDashedMaterial);(t||n)&&i.push(e)}),i.forEach(e=>{var t;try{e.parent&&e.parent.remove(e),(null==(t=e.geometry)?void 0:t.dispose)&&e.geometry.dispose();const n=e.material;Array.isArray(n)?n.forEach(e=>(null==e?void 0:e.dispose)&&e.dispose()):(null==n?void 0:n.dispose)&&n.dispose()}catch{}})}catch{}}setGizmoScene(e){var t,n,r,s;this.gizmoScene=e;try{const i=null==(n=null==(t=this.transformControls)?void 0:t.getHelper)?void 0:n.call(t);if(i&&i.isObject3D&&e){try{const e=null==(s=null==(r=i.children)?void 0:r.find)?void 0:s.call(r,e=>"helper"===e.name);e&&(e.visible=!1);const t=e=>{var t;const n=[];null==(t=e.traverse)||t.call(e,e=>{if(!e)return;const t="Line"===e.type||"Line2"===e.type||"LineSegments"===e.type||"LineSegments2"===e.type||e.isLine,r=e.material&&(e.material.isLineBasicMaterial||e.material.isLineDashedMaterial);(t||r)&&n.push(e)}),n.forEach(e=>{var t;try{e.parent&&e.parent.remove(e),(null==(t=e.geometry)?void 0:t.dispose)&&e.geometry.dispose();const n=e.material;Array.isArray(n)?n.forEach(e=>(null==e?void 0:e.dispose)&&e.dispose()):(null==n?void 0:n.dispose)&&n.dispose()}catch{}})};t(i),i.onBeforeRender=()=>{try{e&&(e.visible=!1),t(i)}catch{}}}catch{}i.parent&&i.parent.remove(i),e.add(i)}}catch{}}setPostProcessingManager(e){this.postProcessingManager=e}_syncOutlineWithSelection(){if(!this.postProcessingManager)return;const e=this.selectedObjects&&this.selectedObjects.length>0?[...this.selectedObjects]:[];try{this.postProcessingManager.setOutlineSelectedObjects(e);const t=this.lastSelectedObject&&e.includes(this.lastSelectedObject)?[this.lastSelectedObject]:e.length?[e[e.length-1]]:[];this.postProcessingManager.setOutlineActiveObjects(t)}catch{}}isInSceneGraph(e){if(!e)return!1;let t=e;for(;t;){if(t===this.scene||t===this.gizmoScene)return!0;t=t.parent}return!1}validateTransformAttachment(){if(!this.transformControls||!this.transformControls.object)return;if(this.isDragging)return;const e=this.transformControls.object;if(!this.isInSceneGraph(e)){try{this.transformControls.detach()}catch{}this.editorStore.getState().setSelectedObject(null)}}createTempGroup(){if(this.selectedObjects.length<=1)return this.clearTempGroup(),null;this.clearTempGroup(),this.tempGroup=new x,this.tempGroup.name="TempSelectionGroup",this.tempGroup.userData.isTempGroup=!0,this.calculateGroupCenter(),this.tempGroup.position.copy(this.tempGroupCenter);const e=this.gizmoScene||this.scene;try{e.add(this.tempGroup)}catch{}return this.tempGroup}calculateGroupCenter(){if(0===this.selectedObjects.length)return void this.tempGroupCenter.set(0,0,0);const e=new v;this.selectedObjects.forEach(t=>{if(t){const n=(new v).setFromObject(t);e.union(n)}}),e.getCenter(this.tempGroupCenter)}clearTempGroup(){if(this.tempGroup){try{this.tempGroup.parent&&this.tempGroup.parent.remove(this.tempGroup)}catch{}this.tempGroup=null}}saveInitialTransformStates(){this.initialTransformStates.clear();for(const e of this.selectedObjects)e&&e.position&&e.rotation&&e.scale&&this.initialTransformStates.set(e,{position:e.position.clone(),rotation:e.rotation.clone(),scale:e.scale.clone()});this.tempGroup&&this.selectedObjects.length>1&&this.initialTransformStates.set(this.tempGroup,{position:this.tempGroup.position.clone(),rotation:this.tempGroup.rotation.clone(),scale:this.tempGroup.scale.clone()})}applyTransformToSelectedObjects(){if(!this.tempGroup||!this.transformControls.object||this.selectedObjects.length<=1)return;const e={position:this.tempGroup.position.clone(),rotation:this.tempGroup.rotation.clone(),scale:this.tempGroup.scale.clone()},t=this.initialTransformStates.get(this.tempGroup);if(t)for(const n of this.selectedObjects)if(n){const r=this.initialTransformStates.get(n);r&&this.applyRelativeTransformFromGroup(n,e,t,r)}}applyRelativeTransformFromGroup(e,t,n,r){switch(this.transformControls.getMode()){case"translate":const s=(new p).subVectors(t.position,n.position);e.position.copy(r.position).add(s);break;case"rotate":const i=(new w).setFromEuler(new j(n.rotation.x,n.rotation.y,n.rotation.z)),a=(new w).setFromEuler(new j(t.rotation.x,t.rotation.y,t.rotation.z)),o=(new w).multiplyQuaternions(a,i.invert()),l=(new p).subVectors(r.position,n.position);l.applyQuaternion(o),e.position.copy(t.position).add(l);const c=(new w).setFromEuler(new j(r.rotation.x,r.rotation.y,r.rotation.z));e.quaternion.multiplyQuaternions(o,c);break;case"scale":const d=new p(t.scale.x/n.scale.x,t.scale.y/n.scale.y,t.scale.z/n.scale.z),u=(new p).subVectors(r.position,n.position);u.multiply(d),e.position.copy(t.position).add(u),e.scale.copy(r.scale).multiply(d)}}applyRelativeTransform(e,t,n,r){switch(this.transformControls.getMode()){case"translate":const s=(new p).subVectors(t.position,n.position);e.position.copy(r.position).add(s);break;case"rotate":const i=new j(t.rotation.x-n.rotation.x,t.rotation.y-n.rotation.y,t.rotation.z-n.rotation.z);e.rotation.copy(r.rotation),e.rotation.x+=i.x,e.rotation.y+=i.y,e.rotation.z+=i.z;break;case"scale":const a=new p(t.scale.x/n.scale.x,t.scale.y/n.scale.y,t.scale.z/n.scale.z);e.scale.copy(r.scale).multiply(a)}}initializeTransformControls(){var e,t;try{this.transformControls=new S(this.camera,this.renderer.domElement);try{const e=this.editorStore.getState();Number.isFinite(null==e?void 0:e.gizmoSize)&&this.transformControls.setSize(e.gizmoSize);const t=!!(null==e?void 0:e.isGridSnap),n=Number.isFinite(null==e?void 0:e.gridSize)?e.gridSize:1,r=Number.isFinite(null==e?void 0:e.snapMove)?e.snapMove:n,s=Number.isFinite(null==e?void 0:e.snapRotateDeg)?M.degToRad(e.snapRotateDeg):M.degToRad(15),i=Number.isFinite(null==e?void 0:e.snapScale)?e.snapScale:.1;t?(this.transformControls.setTranslationSnap(r||n||1),this.transformControls.setRotationSnap(s),this.transformControls.setScaleSnap(i)):(this.transformControls.setTranslationSnap(null),this.transformControls.setRotationSnap(null),this.transformControls.setScaleSnap(null))}catch{}this.transformControls.addEventListener("dragging-changed",e=>{var t,n,r,s,i,a;if(this.isDragging=e.value,e.value){this.saveInitialTransformStates();try{const e=null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:n.call(t);(null==e?void 0:e.beginBatch)&&e.beginBatch()}catch{}}else{try{null==(r=this.flushPendingTransformUpdates)||r.call(this)}catch{}this.initialTransformStates.clear();try{const e=null==(i=null==(s=this.editorStore)?void 0:s.getState)?void 0:i.call(s),t=null==e?void 0:e.updateObjectTransform;if(t){const e=this.selectedObjects&&this.selectedObjects.length>0?this.selectedObjects:this.lastSelectedObject?[this.lastSelectedObject]:[];for(const n of e){const e=null==(a=null==n?void 0:n.userData)?void 0:a.id;e&&t(e,{position:{x:n.position.x,y:n.position.y,z:n.position.z},rotation:{x:n.rotation.x,y:n.rotation.y,z:n.rotation.z},scale:{x:n.scale.x,y:n.scale.y,z:n.scale.z}})}}(null==e?void 0:e.endBatch)&&e.endBatch()}catch{}}}),this.transformControls.addEventListener("change",()=>{var e,t;this.applyTransformToSelectedObjects();try{const n=this.selectedObjects&&this.selectedObjects.length>0?this.selectedObjects:this.lastSelectedObject?[this.lastSelectedObject]:[];try{"rotate"===(null==(t=(e=this.transformControls).getMode)?void 0:t.call(e))&&n.forEach(e=>{var t;if(e&&e.isLight&&(e.isSpotLight||e.isDirectionalLight)&&e.target)try{const n=new p,r=new p;e.getWorldPosition(n),e.getWorldDirection(r);let s=0;try{s=e.target.getWorldPosition(new p).distanceTo(n)}catch{}(!Number.isFinite(s)||s<.001)&&(s=10);const i=n.clone().add(r.multiplyScalar(s));e.target.position.copy(i),e.target.updateMatrixWorld(!0),(null==(t=e.userData)?void 0:t.lightHelper)&&"function"==typeof e.userData.lightHelper.update&&e.userData.lightHelper.update()}catch{}})}catch{}n.forEach(e=>this.scheduleTransformUpdate(e))}catch{}}),this.transformControls.setSize(1);const n=this.transformControls.getHelper();if(n instanceof O){try{const r=null==(t=null==(e=n.children)?void 0:e.find)?void 0:t.call(e,e=>"helper"===e.name);r&&(r.visible=!1);const s=e=>{var t;const n=[];null==(t=e.traverse)||t.call(e,e=>{if(!e)return;const t="Line"===e.type||"Line2"===e.type||"LineSegments"===e.type||"LineSegments2"===e.type||e.isLine,r=e.material&&(e.material.isLineBasicMaterial||e.material.isLineDashedMaterial);(t||r)&&n.push(e)}),n.forEach(e=>{var t;try{e.parent&&e.parent.remove(e),(null==(t=e.geometry)?void 0:t.dispose)&&e.geometry.dispose();const n=e.material;Array.isArray(n)?n.forEach(e=>(null==e?void 0:e.dispose)&&e.dispose()):(null==n?void 0:n.dispose)&&n.dispose()}catch{}})};s(n),n.onBeforeRender=()=>{try{r&&(r.visible=!1),s(n)}catch{}}}catch{}n.renderOrder=999;(this.gizmoScene||this.scene).add(n);try{const e=()=>{var e,t,r;try{const s=null==(t=null==(e=n.children)?void 0:e.find)?void 0:t.call(e,e=>"helper"===e.name);s&&(s.visible=!1);const i=[];null==(r=n.traverse)||r.call(n,e=>{const t="Line"===e.type||"Line2"===e.type||"LineSegments"===e.type||"LineSegments2"===e.type||e.isLine,n=e.material&&(e.material.isLineBasicMaterial||e.material.isLineDashedMaterial);(t||n)&&i.push(e)}),i.forEach(e=>{var t;try{e.parent&&e.parent.remove(e),(null==(t=e.geometry)?void 0:t.dispose)&&e.geometry.dispose();const n=e.material;Array.isArray(n)?n.forEach(e=>(null==e?void 0:e.dispose)&&e.dispose()):(null==n?void 0:n.dispose)&&n.dispose()}catch{}})}catch{}};this.transformControls.addEventListener("change",e),this.transformControls.addEventListener("dragging-changed",e),this.transformControls.addEventListener("mouseDown",e),this.transformControls.addEventListener("mouseUp",e),this.transformControls.addEventListener("objectChange",e)}catch{}}}catch(n){this.transformControls=null}}scheduleTransformUpdate(e){var t,n,r,s,i,a,o,l,c;if(!e)return;const d=null==(t=e.userData)?void 0:t.id;if(d){try{if(e.isLight&&(null==(n=e.userData)?void 0:n.lightHelper)){const t=e.userData.lightHelper;try{e.updateMatrixWorld(!0)}catch{}try{null==(s=null==(r=e.target)?void 0:r.updateMatrixWorld)||s.call(r,!0)}catch{}"function"==typeof t.update&&t.update()}else if(null==(i=e.userData)?void 0:i.isLightTarget){let t=null;try{const n=null==(a=e.userData)?void 0:a.ownerId;n?this.scene.traverse(e=>{var r;!t&&(null==e?void 0:e.isLight)&&(null==(r=e.userData)?void 0:r.id)===n&&(t=e)}):this.scene.traverse(n=>{!t&&(null==n?void 0:n.isLight)&&n.target===e&&(t=n)})}catch{}if((null==(o=null==t?void 0:t.userData)?void 0:o.lightHelper)&&"function"==typeof t.userData.lightHelper.update){try{t.updateMatrixWorld(!0)}catch{}try{null==(c=null==(l=t.target)?void 0:l.updateMatrixWorld)||c.call(l,!0)}catch{}t.userData.lightHelper.update()}}}catch{}this._pendingTransformUpdates.set(d,{position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},scale:{x:e.scale.x,y:e.scale.y,z:e.scale.z}}),this._rafScheduled||(this._rafScheduled=!0,requestAnimationFrame(()=>this.flushPendingTransformUpdates()))}}flushPendingTransformUpdates(){var e,t,n,r;if(this._rafScheduled=!1,this._pendingTransformUpdates&&0!==this._pendingTransformUpdates.size){try{const n=null==(t=null==(e=this.editorStore)?void 0:e.getState)?void 0:t.call(e),r=null==n?void 0:n.updateObjectTransform;if(r)for(const[e,t]of this._pendingTransformUpdates.entries())r(e,t)}catch{}try{null==(r=null==(n=this.selectedObjects)?void 0:n.forEach)||r.call(n,e=>{var t;(null==e?void 0:e.isLight)&&(null==(t=e.userData)?void 0:t.lightHelper)&&"function"==typeof e.userData.lightHelper.update&&e.userData.lightHelper.update()})}catch{}this._pendingTransformUpdates.clear()}}createSelectionBox(){this.selectionBox=document.createElement("div"),this.selectionBox.style.position="absolute",this.selectionBox.style.border="2px dashed #007acc",this.selectionBox.style.backgroundColor="rgba(0, 122, 204, 0.1)",this.selectionBox.style.pointerEvents="none",this.selectionBox.style.display="none",this.selectionBox.style.zIndex="1000",document.body.appendChild(this.selectionBox)}isObjectValidForSelection(e){var t,n,r;if(!e||!e.visible||!e.isObject3D)return!1;const s=this.editorStore.getState(),i=null!=(r=null==(t=e.userData)?void 0:t.id)?r:null==(n=e.userData)?void 0:n.ownerId,a=s.objects.find(e=>e.id===i)||s.walls.find(e=>e.id===i);return!a||!a.frozen}_promoteToCanonical(e){if(!e||!e.userData)return e;const t=!!e.userData.id,n=e.userData.ownerId;if(!t&&null!=n){let t=e;for(;t;){if(t.userData&&t.userData.id===n)return t;t=t.parent}}return e}selectSingleObject(e){var t,n,r;if((e=this._promoteToCanonical(e))&&this.isObjectValidForSelection(e)){this.cleanupSelectedObjects(),this.deselectAllObjects(),this.selectedObjects=[e],this.lastSelectedObject=e,this.editorStore.getState().setSelectedObject(e);try{const s=this.editorStore.getState(),i=null!=(r=null==(t=null==e?void 0:e.userData)?void 0:t.id)?r:null==(n=null==e?void 0:e.userData)?void 0:n.ownerId;(null==s?void 0:s.setSelectedIds)&&s.setSelectedIds(null!=i?[i]:[])}catch{}if(this.clearTempGroup(),this.transformControls&&e.parent){let t=!1,n=e;for(;n.parent;)if(n=n.parent,n===this.scene){t=!0;break}t&&(this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}this._syncOutlineWithSelection();try{this.addSelectionOutline(e),this.updateSelectionOutline(e)}catch{}this._requestRender()}}selectMultipleObjects(e,t=!1){if(e&&Array.isArray(e)){t||this.deselectAllObjects();for(let t of e)if(t=this._promoteToCanonical(t),t&&!this.selectedObjects.includes(t)){this.selectedObjects.push(t),this.lastSelectedObject=t;try{this.addSelectionOutline(t),this.updateSelectionOutline(t)}catch{}}if(this.selectedObjects.length>1){const e=this.createTempGroup();if(e&&this.transformControls){e.parent===(this.gizmoScene||this.scene)&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}}else if(1===this.selectedObjects.length){this.clearTempGroup();const e=this.selectedObjects[0];e&&this.transformControls&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}try{const e=this.editorStore.getState(),t=this.selectedObjects.map(e=>{var t,n,r;return null!=(r=null==(t=null==e?void 0:e.userData)?void 0:t.id)?r:null==(n=null==e?void 0:e.userData)?void 0:n.ownerId}).filter(e=>null!=e);(null==e?void 0:e.setSelectedIds)&&e.setSelectedIds(t)}catch{}this._syncOutlineWithSelection(),this._requestRender()}}toggleObjectSelection(e){if(!e)return;e=this._promoteToCanonical(e);const t=this.selectedObjects.indexOf(e);if(t>-1)if(this.selectedObjects.splice(t,1),this.removeSelectionOutline(e),this.lastSelectedObject===e&&(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null),this.selectedObjects.length>1){const e=this.createTempGroup();e&&this.transformControls&&e.parent===this.scene&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}else if(1===this.selectedObjects.length){this.clearTempGroup();const e=this.selectedObjects[0];e&&this.transformControls&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}else this.clearTempGroup(),this.editorStore.getState().setSelectedObject(null),this.lastSelectedObject=null,this.transformControls&&this.transformControls.detach();else{this.selectedObjects.push(e),this.lastSelectedObject=e;try{this.addSelectionOutline(e),this.updateSelectionOutline(e)}catch{}if(this.selectedObjects.length>1){const e=this.createTempGroup();if(e&&this.transformControls){e.parent===(this.gizmoScene||this.scene)&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}}else this.clearTempGroup(),this.transformControls&&(this.editorStore.getState().setSelectedObject(e),this.transformControls.attach(e),this.setGizmoMode(this.gizmoMode))}try{const e=this.editorStore.getState(),t=this.selectedObjects.map(e=>{var t,n,r;return null!=(r=null==(t=null==e?void 0:e.userData)?void 0:t.id)?r:null==(n=null==e?void 0:e.userData)?void 0:n.ownerId}).filter(e=>null!=e);(null==e?void 0:e.setSelectedIds)&&e.setSelectedIds(t)}catch{}this._syncOutlineWithSelection(),this._requestRender()}deselectAllObjects(){if(this.transformControls)try{this.transformControls.detach()}catch(e){}this.clearTempGroup(),this.cleanupSelectedObjects();for(const t of this.selectedObjects)if(t)try{this.removeSelectionOutline(t)}catch(e){}this.selectedObjects=[],this.lastSelectedObject=null,this.editorStore.getState().setSelectedObject(null);try{const e=this.editorStore.getState();(null==e?void 0:e.setSelectedIds)&&e.setSelectedIds([])}catch{}this._syncOutlineWithSelection(),this._requestRender()}cleanupSelectedObjects(){this.isDragging||(this.selectedObjects.length,this.selectedObjects=this.selectedObjects.filter(e=>this.isObjectValidForSelection(e)&&this.isInSceneGraph(e)),!this.lastSelectedObject||this.isObjectValidForSelection(this.lastSelectedObject)&&this.isInSceneGraph(this.lastSelectedObject)||(this.lastSelectedObject=this.selectedObjects.length>0?this.selectedObjects[this.selectedObjects.length-1]:null),this.validateTransformAttachment())}handleObjectSelection(e,t=!1){if(this.isDragging)return;this.raycaster.setFromCamera(e,this.camera);let n=[];try{n=this.raycaster.intersectObjects(this.selectableObjects,!0)}catch{n=[]}if((!n||0===n.length)&&this.scene)try{const e=this.raycaster.intersectObjects(this.scene.children,!0),t=e=>{let t=e;for(;t;){if(this.selectableObjects.includes(t))return t;t=t.parent}return null};for(const r of e){const e=t(r.object);if(e){n=[{object:e}];break}}}catch{}if(n&&n.length>0){let e=n[0].object;for(;e&&e.parent&&!this.selectableObjects.includes(e);)e=e.parent;if(!e||!this.selectableObjects.includes(e)||!this.isObjectValidForSelection(e))return void(t||this.isDragging||this.deselectAllObjects());t?this.toggleObjectSelection(e):this.selectSingleObject(e)}else t||this.isDragging||this.deselectAllObjects()}getObjectsInArea(e,t){const n=[],r=Math.min(e.x,t.x),s=Math.max(e.x,t.x),i=Math.min(e.y,t.y),a=Math.max(e.y,t.y);for(const o of this.selectableObjects){if(!this.isObjectValidForSelection(o))continue;const e=new p;o.getWorldPosition(e),e.project(this.camera),e.x>=r&&e.x<=s&&e.y>=i&&e.y<=a&&n.push(o)}return n}addSelectionOutline(e){var t;e&&((null==(t=e.userData)?void 0:t.isSelectionOutline)||this._shouldUseFallbackOutline()&&(e.isGroup||e.children&&e.children.length>0?this.addSelectionOutlineToGroup(e):this.addSelectionOutlineToSingleMesh(e)))}addSelectionOutlineToGroup(e){e&&e.traverse&&e.traverse(t=>{var n;t&&t.isMesh&&t!==e&&!(null==(n=t.userData)?void 0:n.isSelectionOutline)&&this.addSelectionOutlineToSingleMesh(t)})}addSelectionOutlineToSingleMesh(e){var t,n,r;try{if(!e||!e.isMesh)return;if(null==(t=e.userData)?void 0:t.isSelectionOutline)return;if(!this._shouldUseFallbackOutline())return;if(e.userData||(e.userData={}),e.userData.outlineObject){try{const t=e.userData.outlineObject;t&&t.parent!==e&&(t.parent&&t.parent.remove(t),e.add(t))}catch{}return}const s=(null==(r=null==(n=e.geometry)?void 0:n.clone)?void 0:r.call(n))||null;if(!s)return;try{s.attributes&&s.attributes.normal||s.computeVertexNormals()}catch{}const i=this.lastSelectedObject===e||1===this.selectedObjects.length&&this.selectedObjects[0]===e,a=new _({color:i?16765952:16742912,side:C,transparent:!1,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});try{s.computeBoundingSphere()}catch{}const o=s.boundingSphere?s.boundingSphere.radius:1,l=Math.max(.002,.005*o);a.onBeforeCompile=e=>{e.uniforms.uOutlineThickness={value:l},e.vertexShader=e.vertexShader.replace("#include <common>","#include <common>\nuniform float uOutlineThickness;").replace("#include <begin_vertex>","#include <begin_vertex>\n  vec3 worldNormal = normalize(mat3(modelMatrix) * normal);\n  transformed += worldNormal * uOutlineThickness;"),a.userData.shader=e};const c=new h(s,a);c.name="SelectionOutline",c.userData=c.userData||{},c.userData.isSelectionOutline=!0,c.userData.isSystemObject=!0;try{c.layers.mask=e.layers.mask}catch{}try{c.renderOrder=(e.renderOrder||0)+.001}catch{}e.add(c),e.userData.outlineObject=c}catch{}}removeSelectionOutline(e){e&&(e.isGroup||e.children&&e.children.length>0?this.removeSelectionOutlineFromGroup(e):this.removeSelectionOutlineFromMesh(e))}removeSelectionOutlineFromGroup(e){if(e&&e.traverse){try{e.traverse(t=>{var n;t&&t.isMesh&&t!==e&&!(null==(n=t.userData)?void 0:n.isSelectionOutline)&&this.removeSelectionOutlineFromMesh(t)})}catch(t){}e.userData&&delete e.userData.outlineChildren}}removeSelectionOutlineFromMesh(e){if(e&&e.userData&&!e.userData.isSelectionOutline){if(e.userData.outlineObject){if(e.userData.outlineObject.parent&&e.userData.outlineObject.parent.remove(e.userData.outlineObject),e.userData.outlineObject.geometry){if(this.isDragging)return;e.userData.outlineObject.geometry.dispose()}e.userData.outlineObject.material&&e.userData.outlineObject.material.dispose(),delete e.userData.outlineObject}e.material&&void 0!==e.userData.originalEmissive&&(e.material.emissive.copy(e.userData.originalEmissive),e.material.emissiveIntensity=e.userData.originalEmissiveIntensity,delete e.userData.originalEmissive,delete e.userData.originalEmissiveIntensity)}}updateSelectionOutline(e){var t;(null==(t=e.userData)?void 0:t.isSelectionOutline)||this._shouldUseFallbackOutline()&&(e.isGroup||e.children&&e.children.length>0?this.updateSelectionOutlineForGroup(e):this.updateSelectionOutlineForMesh(e))}updateSelectionOutlineForGroup(e){e&&e.traverse&&e.traverse(t=>{var n;t&&t.isMesh&&t!==e&&!(null==(n=t.userData)?void 0:n.isSelectionOutline)&&this.updateSelectionOutlineForMesh(t)})}updateSelectionOutlineForMesh(e){var t,n;if(!e||!e.isMesh)return;if(null==(t=e.userData)?void 0:t.isSelectionOutline)return;if(!this._shouldUseFallbackOutline())return;const r=null==(n=e.userData)?void 0:n.outlineObject;if(r)try{const t=this.lastSelectedObject===e||1===this.selectedObjects.length&&this.selectedObjects[0]===e?16765952:16742912;r.material&&r.material.color&&r.material.color.setHex(t)}catch{}}updateAllSelectionOutlines(){this.isDragging||this.cleanupSelectedObjects(),this._syncOutlineWithSelection();if(this._shouldUseFallbackOutline()){for(const e of this.selectedObjects)if(e){try{this.addSelectionOutline(e)}catch{}try{this.updateSelectionOutline(e)}catch{}}}else for(const e of this.selectedObjects)if(e)try{this.removeSelectionOutline(e)}catch{}}setGizmoMode(e){if(!this.transformControls)return;this.gizmoMode=e,this.transformControls.setMode(e);const t=this.editorStore.getState();t.setTransformMode&&t.setTransformMode(e);const n=this.editorStore.getState().selectedObject;n&&!this.transformControls.object&&this.transformControls.attach(n)}setGridSnap(e,t=1){if(this.transformControls)if(e){const e=this.editorStore.getState(),n=Number.isFinite(null==e?void 0:e.snapMove)?e.snapMove:t,r=Number.isFinite(null==e?void 0:e.snapRotateDeg)?M.degToRad(e.snapRotateDeg):M.degToRad(15),s=Number.isFinite(null==e?void 0:e.snapScale)?e.snapScale:.1;this.transformControls.setTranslationSnap(n||t),this.transformControls.setRotationSnap(r),this.transformControls.setScaleSnap(s)}else this.transformControls.setTranslationSnap(null),this.transformControls.setRotationSnap(null),this.transformControls.setScaleSnap(null)}updateGizmoSize(){var e;try{const t=null==(e=this.editorStore.getState())?void 0:e.gizmoSize;this.transformControls&&Number.isFinite(t)&&this.transformControls.setSize(t)}catch{}}updateGridSnap(){const e=this.editorStore.getState();this.setGridSnap(e.isGridSnap,e.gridSize)}updateGizmoSpace(){const e=this.editorStore.getState();this.transformControls&&this.transformControls.setSpace(e.gizmoSpace)}isChildOf(e,t){let n=e.parent;for(;n;){if(n===t)return!0;n=n.parent}return!1}updateCamera(e){this.camera=e,this.transformControls&&(this.transformControls.camera=e)}addSelectableObject(e){this.selectableObjects.includes(e)||this.selectableObjects.push(e)}removeSelectableObject(e){const t=this.selectableObjects.indexOf(e);t>-1&&this.selectableObjects.splice(t,1)}updateSelectableObjects(e){this.selectableObjects=[...e]}showSelectionBox(e,t,n,r){this.selectionBox.style.display="block",this.selectionBox.style.left=e+"px",this.selectionBox.style.top=t+"px",this.selectionBox.style.width=n+"px",this.selectionBox.style.height=r+"px"}hideSelectionBox(){this.selectionBox.style.display="none"}getSelectedObjects(){return[...this.selectedObjects]}getSelectableObjects(){return[...this.selectableObjects]}getTransformControls(){return this.transformControls}isDraggingGizmo(){return this.isDragging}dispose(){var e,t;if(this.clearTempGroup(),this.transformControls){try{const n=null==(t=(e=this.transformControls).getHelper)?void 0:t.call(e);n&&n.parent&&n.parent.remove(n)}catch{}this.transformControls.dispose()}this.selectionBox&&this.selectionBox.parentNode&&this.selectionBox.parentNode.removeChild(this.selectionBox)}}class nn{constructor(e,t,n){this.objectSelector=e,this.editorStore=t,this.keyboardController=n,this.state={mode:"translate",space:"world",snapEnabled:!1,gridSize:1},this.registerKeyboardActions(),this.applyInitialSettings()}registerKeyboardActions(){this.keyboardController&&(this.keyboardController.registerTransformActions({setMode:e=>this.setTransformMode(e),toggleSpace:()=>this.toggleSpace(),toggleSnap:()=>this.toggleGridSnap()}),this.keyboardController.registerRotationActions({rotateX:e=>this.rotateSelectedX(e),rotateY:e=>this.rotateSelectedY(e),rotateZ:e=>this.rotateSelectedZ(e),resetRotation:()=>this.resetSelectedRotation()}),this.keyboardController.registerSelectionActions({deselectAll:()=>this.deselectAll(),selectAll:()=>this.selectAll()}),this.keyboardController.registerObjectActions({deleteSelected:()=>this.deleteSelected(),duplicateSelected:()=>this.duplicateSelected(),groupSelected:()=>this.groupSelected(),ungroupSelected:()=>this.ungroupSelected()}),this.keyboardController.registerSystemActions({undo:()=>this.undo(),redo:()=>this.redo()}))}setTransformMode(e){var t;return!(!this.isValidMode(e)||!this.objectSelector)&&(this.state.mode,this.state.mode=e,this.objectSelector.setGizmoMode(e),"rotate"===e&&this.setupQuaternionRotation(),(null==(t=this.editorStore)?void 0:t.getState().setTransformMode)&&this.editorStore.getState().setTransformMode(e),!0)}toggleSpace(){var e;return!!(null==(e=this.objectSelector)?void 0:e.transformControls)&&(this.state.space,this.state.space="world"===this.state.space?"local":"world",this.objectSelector.transformControls.setSpace(this.state.space),!0)}toggleGridSnap(){return!!this.objectSelector&&(this.state.snapEnabled=!this.state.snapEnabled,this.objectSelector.setGridSnap(this.state.snapEnabled,this.state.gridSize),!0)}setGridSize(e){return!(!this.objectSelector||!this.isValidGridSize(e))&&(this.state.gridSize,this.state.gridSize=e,this.state.snapEnabled&&this.objectSelector.setGridSnap(this.state.snapEnabled,this.state.gridSize),!0)}deselectAll(){var e;return!!this.objectSelector&&(null==(e=this.objectSelector.selectedObjects)||e.length,this.objectSelector.deselectAllObjects(),!0)}selectAll(){if(!this.objectSelector)return!1;const e=this.objectSelector.getSelectableObjects();return!!(e&&e.length>0)&&(this.objectSelector.selectMultipleObjects(e),!0)}deleteSelected(){var e,t,n,r,s,i,a,o,l,c;if(!this.objectSelector||!this.hasSelectedObjects())return!1;const d=[...this.objectSelector.selectedObjects];try{null==(r=null==(t=null==(e=this.editorStore)?void 0:e.getState)?void 0:(n=t.call(e)).beginBatch)||r.call(n)}catch{}d.map(e=>{var t,n,r;return null!=(r=null==(t=null==e?void 0:e.userData)?void 0:t.id)?r:null==(n=null==e?void 0:e.userData)?void 0:n.ownerId}).filter(Boolean);const u=null==(i=null==(s=this.editorStore)?void 0:s.getState)?void 0:i.call(s);this.deselectAll(),d.forEach(e=>{var t,n,r;this.removeObjectFromScene(e);const s=null!=(r=null==(t=null==e?void 0:e.userData)?void 0:t.id)?r:null==(n=null==e?void 0:e.userData)?void 0:n.ownerId;s&&(null==u?void 0:u.removeObjectById)&&u.removeObjectById(s)});try{null==(c=null==(o=null==(a=this.editorStore)?void 0:a.getState)?void 0:(l=o.call(a)).endBatch)||c.call(l)}catch{}return!0}duplicateSelected(){var e,t,n,r,s,i,a,o,l,c;if(!this.objectSelector||!this.hasSelectedObjects())return!1;const d=[...this.objectSelector.selectedObjects],u=[];try{null==(r=null==(t=null==(e=this.editorStore)?void 0:e.getState)?void 0:(n=t.call(e)).beginBatch)||r.call(n)}catch{}const h=null==(i=null==(s=this.editorStore)?void 0:s.getState)?void 0:i.call(s);d.forEach(e=>{var t,n,r,s,i,a;const o=this.cloneObject(e);if(o){u.push(o);const l=null==(t=o.userData)?void 0:t.id;l&&(null==h?void 0:h.addObject)&&h.addObject({id:l,name:o.name||`Object_${l}`,type:(null==(n=null==e?void 0:e.userData)?void 0:n.type)||"basic",parentId:(null==(r=null==e?void 0:e.userData)?void 0:r.id)&&null!=(a=null==(i=null==(s=e.parent)?void 0:s.userData)?void 0:i.id)?a:null,position:{x:o.position.x,y:o.position.y,z:o.position.z},rotation:{x:o.rotation.x,y:o.rotation.y,z:o.rotation.z},scale:{x:o.scale.x,y:o.scale.y,z:o.scale.z},visible:!1!==o.visible})}}),u.length>0&&this.selectObjects(u);try{null==(c=null==(o=null==(a=this.editorStore)?void 0:a.getState)?void 0:(l=o.call(a)).endBatch)||c.call(l)}catch{}return u}groupSelected(){var e,t,n,r,s,i,a,o,l,c,d,u,h;if(!this.objectSelector||(null==(e=this.objectSelector.selectedObjects)?void 0:e.length)<2)return!1;const p=[...this.objectSelector.selectedObjects];try{null==(s=null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:(r=n.call(t)).beginBatch)||s.call(r)}catch{}const m=this.createGroup(p);if(m){this.selectObjects([m]);try{null==(l=null==(a=null==(i=this.editorStore)?void 0:i.getState)?void 0:(o=a.call(i)).endBatch)||l.call(o)}catch{}return m}try{null==(h=null==(d=null==(c=this.editorStore)?void 0:c.getState)?void 0:(u=d.call(c)).endBatch)||h.call(u)}catch{}return!1}ungroupSelected(){var e,t,n,r,s,i,a,o,l,c,d,u,h;if(!this.objectSelector||1!==(null==(e=this.objectSelector.selectedObjects)?void 0:e.length))return!1;const p=this.objectSelector.selectedObjects[0];if(!this.isGroup(p))return!1;try{null==(s=null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:(r=n.call(t)).beginBatch)||s.call(r)}catch{}const m=this.ungroupObject(p);if(m.length>0){this.selectObjects(m);try{null==(l=null==(a=null==(i=this.editorStore)?void 0:i.getState)?void 0:(o=a.call(i)).endBatch)||l.call(o)}catch{}return m}try{null==(h=null==(d=null==(c=this.editorStore)?void 0:c.getState)?void 0:(u=d.call(c)).endBatch)||h.call(u)}catch{}return!1}applyInitialSettings(){this.objectSelector&&(this.objectSelector.setGizmoMode(this.state.mode),this.objectSelector.setGridSnap(this.state.snapEnabled,this.state.gridSize),this.objectSelector.isMagnetEnabled=this.state.magnetEnabled,this.objectSelector.showMagnetRays=this.state.magnetRaysVisible,this.objectSelector.transformControls&&(this.objectSelector.transformControls.setSpace(this.state.space),this.setupQuaternionRotation()))}setupQuaternionRotation(){var e;if(!(null==(e=this.objectSelector)?void 0:e.transformControls))return;const t=this.objectSelector.transformControls;"rotate"===this.state.mode&&(t.rotationSnap=Math.PI/12,this.setupRotationEventListeners())}setupRotationEventListeners(){var e;if(!(null==(e=this.objectSelector)?void 0:e.transformControls))return;const t=this.objectSelector.transformControls;t.addEventListener("objectChange",()=>{"rotate"===t.getMode()&&this.hasSelectedObjects()&&this.onQuaternionRotationChange()})}onQuaternionRotationChange(){const e=this.objectSelector.selectedObjects;e.forEach((e,t)=>{e.quaternion.normalize(),e.updateMatrix(),e.updateMatrixWorld()}),e.length>0&&this.getSelectedObjectRotation(e[0])}updateObjectSelector(e){this.objectSelector=e,this.applyInitialSettings()}getState(){var e,t;return{...this.state,selectedObjectsCount:(null==(t=null==(e=this.objectSelector)?void 0:e.selectedObjects)?void 0:t.length)||0,hasSelection:this.hasSelectedObjects()}}applySettings(e){e.mode&&e.mode!==this.state.mode&&this.setTransformMode(e.mode),e.space&&e.space!==this.state.space&&this.toggleSpace(),void 0!==e.snapEnabled&&e.snapEnabled!==this.state.snapEnabled&&this.toggleGridSnap(),e.gridSize&&e.gridSize!==this.state.gridSize&&this.setGridSize(e.gridSize)}rotateSelectedObjects(e){if(!this.hasSelectedObjects())return!1;return this.objectSelector.selectedObjects.forEach(t=>{this.applyQuaternionRotation(t,e)}),!0}applyQuaternionRotation(e,t){e&&(e.quaternion.multiplyQuaternions(t,e.quaternion),e.updateMatrix())}rotateSelectedX(e){const t=M.degToRad(e),n=(new w).setFromAxisAngle(new p(1,0,0),t);return this.rotateSelectedObjects(n)}rotateSelectedY(e){const t=M.degToRad(e),n=(new w).setFromAxisAngle(new p(0,1,0),t);return this.rotateSelectedObjects(n)}rotateSelectedZ(e){const t=M.degToRad(e),n=(new w).setFromAxisAngle(new p(0,0,1),t);return this.rotateSelectedObjects(n)}rotateSelectedAroundAxis(e,t){if(!e||0===e.length())return!1;const n=e.clone().normalize(),r=M.degToRad(t),s=(new w).setFromAxisAngle(n,r);return this.rotateSelectedObjects(s)}rotateSelectedByEuler(e,t,n,r="XYZ"){const s=new j(M.degToRad(e),M.degToRad(t),M.degToRad(n),r),i=(new w).setFromEuler(s);return this.rotateSelectedObjects(i)}rotateSelectedToLookAt(e){if(!this.hasSelectedObjects()||!e)return!1;return this.objectSelector.selectedObjects.forEach(t=>{(new p).subVectors(e,t.position).normalize();const n=new D;n.lookAt(t.position,e,new p(0,1,0));const r=(new w).setFromRotationMatrix(n);t.quaternion.copy(r),t.updateMatrix()}),!0}resetSelectedRotation(){if(!this.hasSelectedObjects())return!1;return this.objectSelector.selectedObjects.forEach(e=>{e.quaternion.set(0,0,0,1),e.updateMatrix()}),!0}getSelectedObjectRotation(e=null){const t=e||this.objectSelector.selectedObjects[0];if(!t)return null;const n=(new j).setFromQuaternion(t.quaternion,"XYZ");return{x:M.radToDeg(n.x),y:M.radToDeg(n.y),z:M.radToDeg(n.z),quaternion:t.quaternion.clone()}}rotateSelectedInWorldSpace(e){if(!this.hasSelectedObjects())return!1;return this.objectSelector.selectedObjects.forEach(t=>{const n=new w;if(t.getWorldQuaternion(n),n.premultiply(e),t.parent){const e=new w;t.parent.getWorldQuaternion(e),e.invert(),t.quaternion.multiplyQuaternions(e,n)}else t.quaternion.copy(n);t.updateMatrix()}),!0}rotateSelectedAroundPoint(e,t){if(!this.hasSelectedObjects()||!e)return!1;return this.objectSelector.selectedObjects.forEach(n=>{const r=n.position.clone().sub(e);r.applyQuaternion(t),n.position.copy(e).add(r),n.quaternion.multiplyQuaternions(t,n.quaternion),n.updateMatrix()}),!0}isValidMode(e){return["translate","rotate","scale"].includes(e)}isValidGridSize(e){return"number"==typeof e&&e>0&&e<=100}hasSelectedObjects(){var e,t;return(null==(t=null==(e=this.objectSelector)?void 0:e.selectedObjects)?void 0:t.length)>0}isGroup(e){var t;return!0===(null==(t=null==e?void 0:e.userData)?void 0:t.isGroup)||"Group"===(null==e?void 0:e.type)}removeObjectFromScene(e){e&&e.parent&&(e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))}cloneObject(e){if(!e)return null;const t=e.clone();return t.position.x+=1,t.position.z+=1,t.userData={...e.userData,id:`${e.userData.id}_copy_${Date.now()}`},e.parent.add(t),this.objectSelector.addSelectableObject&&this.objectSelector.addSelectableObject(t),t}createGroup(e){var t,n,r;if(!e||e.length<2)return null;const s=new x;s.name=`Group_${Date.now()}`,s.userData={id:`group_${Date.now()}`,type:"group",isGroup:!0};e[0].parent.add(s),e.forEach(e=>{if(e&&e.parent){const t=e.matrixWorld.clone();s.add(e),e.matrix.copy(t),e.matrix.premultiply(s.matrixWorld.clone().invert()),e.matrix.decompose(e.position,e.quaternion,e.scale)}}),this.objectSelector.addSelectableObject&&this.objectSelector.addSelectableObject(s);try{const i=null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:n.call(t);if((null==i?void 0:i.addObject)&&i.addObject({id:s.userData.id,name:s.name,type:"group",position:{x:s.position.x,y:s.position.y,z:s.position.z},rotation:{x:s.rotation.x,y:s.rotation.y,z:s.rotation.z},scale:{x:s.scale.x,y:s.scale.y,z:s.scale.z},visible:!0}),null==i?void 0:i.setParent)for(const t of e){const e=null==(r=null==t?void 0:t.userData)?void 0:r.id;e&&i.setParent(e,s.userData.id)}}catch{}return s}ungroupObject(e){var t,n,r,s,i,a,o,l;if(!this.isGroup(e))return[];const c=[...e.children],d=e.parent;c.forEach(e=>{if(e){const t=e.matrixWorld.clone();d.add(e),e.matrix.copy(t),e.matrix.premultiply(d.matrixWorld.clone().invert()),e.matrix.decompose(e.position,e.quaternion,e.scale),this.objectSelector.addSelectableObject&&this.objectSelector.addSelectableObject(e)}});try{const e=null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:n.call(t);if(null==e?void 0:e.setParent){const t=null!=(s=null==(r=null==d?void 0:d.userData)?void 0:r.id)?s:null;for(const n of c){const r=null==(i=null==n?void 0:n.userData)?void 0:i.id;r&&(e.setParent(r,t),e.updateObjectTransform&&e.updateObjectTransform(r,{position:{x:n.position.x,y:n.position.y,z:n.position.z},rotation:{x:n.rotation.x,y:n.rotation.y,z:n.rotation.z},scale:{x:n.scale.x,y:n.scale.y,z:n.scale.z}}))}}}catch{}this.objectSelector.removeSelectableObject&&this.objectSelector.removeSelectableObject(e),d.remove(e);try{const t=null==(o=null==(a=this.editorStore)?void 0:a.getState)?void 0:o.call(a),n=null==(l=null==e?void 0:e.userData)?void 0:l.id;n&&(null==t?void 0:t.removeObjectById)&&t.removeObjectById(n)}catch{}return c}selectObjects(e){this.objectSelector&&e&&0!==e.length&&(this.objectSelector.deselectAllObjects(),1===e.length?this.objectSelector.selectSingleObject(e[0]):this.objectSelector.selectMultipleObjects(e))}logStateChange(e,t,n){}undo(){var e;try{const t=null==(e=this.editorStore)?void 0:e.getState();(null==t?void 0:t.undo)&&t.undo()}catch(t){}}redo(){var e;try{const t=null==(e=this.editorStore)?void 0:e.getState();(null==t?void 0:t.redo)&&t.redo()}catch(t){}}dispose(){this.objectSelector=null,this.editorStore=null,this.keyboardController=null}}class rn{constructor(){this.isEnabled=!0,this.pressedKeys=new Set,this.mouseState={isDown:!1,button:-1,position:{x:0,y:0},previousPosition:{x:0,y:0},dragStart:{x:0,y:0}},this.handlers={keyboard:new Map,mouse:new Map,wheel:null,contextMenu:null,resize:null},this.modifierKeys={ctrl:!1,shift:!1,alt:!1,meta:!1},this.boundHandlers={keyDown:this.handleKeyDown.bind(this),keyUp:this.handleKeyUp.bind(this),mouseDown:this.handleMouseDown.bind(this),mouseMove:this._scheduleMouseMove.bind(this),mouseUp:this.handleMouseUp.bind(this),wheel:this.handleWheel.bind(this),contextMenu:this.handleContextMenu.bind(this),resize:this.handleResize.bind(this)},this._mouseMoveScheduled=!1,this._lastMouseMoveEvent=null,this.setupEventListeners()}setupEventListeners(){document.addEventListener("keydown",this.boundHandlers.keyDown),document.addEventListener("keyup",this.boundHandlers.keyUp),window.addEventListener("resize",this.boundHandlers.resize)}setupMouseEvents(e){this.canvas=e,e.addEventListener("mousedown",this.boundHandlers.mouseDown),document.addEventListener("mousemove",this.boundHandlers.mouseMove),document.addEventListener("mouseup",this.boundHandlers.mouseUp),e.addEventListener("wheel",this.boundHandlers.wheel,{passive:!1}),e.addEventListener("contextmenu",this.boundHandlers.contextMenu)}handleKeyDown(e){if(!this.isEnabled||this.isInputFieldActive(e.target))return;this.updateModifierKeys(e),this.pressedKeys.add(e.code);const t={code:e.code,key:e.key,ctrl:this.modifierKeys.ctrl,shift:this.modifierKeys.shift,alt:this.modifierKeys.alt,meta:this.modifierKeys.meta,originalEvent:e};this.modifierKeys.ctrl||this.modifierKeys.meta?this.executeHandler("keyboard","ctrl",t):this.executeHandler("keyboard",e.code,t)}handleKeyUp(e){if(!this.isEnabled)return;this.updateModifierKeys(e),this.pressedKeys.delete(e.code);const t={code:e.code,key:e.key,ctrl:this.modifierKeys.ctrl,shift:this.modifierKeys.shift,alt:this.modifierKeys.alt,meta:this.modifierKeys.meta,originalEvent:e};this.executeHandler("keyboard","keyup",t)}handleMouseDown(e){if(!this.isEnabled)return;this.mouseState.isDown=!0,this.mouseState.button=e.button,this.updateMousePosition(e),this.mouseState.previousPosition={...this.mouseState.position},this.mouseState.dragStart={...this.mouseState.position};const t={button:e.button,position:{...this.mouseState.position},ctrl:e.ctrlKey,shift:e.shiftKey,alt:e.altKey,meta:e.metaKey,originalEvent:e};this.executeHandler("mouse","mousedown",t)}handleMouseMove(e){if(!this.isEnabled)return;this.mouseState.previousPosition={...this.mouseState.position},this.updateMousePosition(e);const t={position:{...this.mouseState.position},previousPosition:{...this.mouseState.previousPosition},dragStart:{...this.mouseState.dragStart},isDown:this.mouseState.isDown,button:this.mouseState.button,delta:{x:this.mouseState.position.x-this.mouseState.previousPosition.x,y:this.mouseState.position.y-this.mouseState.previousPosition.y},originalEvent:e};this.executeHandler("mouse","mousemove",t)}_scheduleMouseMove(e){if(this._lastMouseMoveEvent=e,this._mouseMoveScheduled)return;this._mouseMoveScheduled=!0;const t=()=>{this._mouseMoveScheduled=!1;const e=this._lastMouseMoveEvent;if(this._lastMouseMoveEvent=null,e)try{this.handleMouseMove(e)}catch(t){}};"undefined"!=typeof window&&"function"==typeof window.requestAnimationFrame?window.requestAnimationFrame(t):setTimeout(t,0)}handleMouseUp(e){if(!this.isEnabled)return;const t={button:e.button,position:{...this.mouseState.position},dragStart:{...this.mouseState.dragStart},ctrl:e.ctrlKey,shift:e.shiftKey,alt:e.altKey,meta:e.metaKey,originalEvent:e};this.executeHandler("mouse","mouseup",t),this.mouseState.isDown=!1,this.mouseState.button=-1}handleWheel(e){if(!this.isEnabled)return;e.preventDefault();const t={delta:e.deltaY,position:{...this.mouseState.position},ctrl:e.ctrlKey,shift:e.shiftKey,alt:e.altKey,originalEvent:e};this.handlers.wheel&&this.handlers.wheel(t)}handleContextMenu(e){e.preventDefault(),this.handlers.contextMenu&&this.handlers.contextMenu(e)}handleResize(e){this.handlers.resize&&this.handlers.resize(e)}updateMousePosition(e){if(!this.canvas)return;const t=this.canvas.getBoundingClientRect();this.mouseState.position={x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,screenX:e.clientX,screenY:e.clientY}}updateModifierKeys(e){this.modifierKeys.ctrl=e.ctrlKey,this.modifierKeys.shift=e.shiftKey,this.modifierKeys.alt=e.altKey,this.modifierKeys.meta=e.metaKey}executeHandler(e,t,n){var r;if("keyboard"===e){const e=this.handlers.keyboard.get("default");if(e)try{e(n)}catch(s){}}else{const i=null==(r=this.handlers[e])?void 0:r.get(t);if(i)try{i(n)}catch(s){}}}isInputFieldActive(e){return["INPUT","TEXTAREA","SELECT"].includes(e.tagName)||"true"===e.contentEditable}registerKeyHandler(e,t){this.handlers.keyboard.has(e)||this.handlers.keyboard.set(e,t)}registerMouseHandler(e,t){this.handlers.mouse.has(e)||this.handlers.mouse.set(e,t)}registerWheelHandler(e){this.handlers.wheel=e}registerContextMenuHandler(e){this.handlers.contextMenu=e}registerResizeHandler(e){this.handlers.resize=e}unregisterHandler(e,t){var n;"wheel"===e?this.handlers.wheel=null:"contextMenu"===e?this.handlers.contextMenu=null:null==(n=this.handlers[e])||n.delete(t)}clearAllHandlers(){this.handlers.keyboard.clear(),this.handlers.mouse.clear(),this.handlers.wheel=null,this.handlers.contextMenu=null}setEnabled(e){this.isEnabled=e}isKeyPressed(e){return this.pressedKeys.has(e)}getModifierKeys(){return{...this.modifierKeys}}getMouseState(){return{...this.mouseState}}getInputState(){return{enabled:this.isEnabled,pressedKeys:Array.from(this.pressedKeys),modifierKeys:this.getModifierKeys(),mouseState:this.getMouseState()}}dispose(){document.removeEventListener("keydown",this.boundHandlers.keyDown),document.removeEventListener("keyup",this.boundHandlers.keyUp),this.canvas&&(this.canvas.removeEventListener("mousedown",this.boundHandlers.mouseDown),this.canvas.removeEventListener("wheel",this.boundHandlers.wheel),this.canvas.removeEventListener("contextmenu",this.boundHandlers.contextMenu)),document.removeEventListener("mousemove",this.boundHandlers.mouseMove),document.removeEventListener("mouseup",this.boundHandlers.mouseUp),window.removeEventListener("resize",this.boundHandlers.resize),this.clearAllHandlers(),this.canvas=null,this.boundHandlers=null,this.pressedKeys.clear()}}class sn{constructor(e){this.inputManager=e,this.comboLocks=new Set,this.actions={transform:new Map,rotation:new Map,selection:new Map,viewport:new Map,object:new Map,system:new Map},this.setupDefaultKeyMappings(),this.registerInputHandlers()}setupDefaultKeyMappings(){this.actions.transform.set("KeyW",{name:"Move Mode",description:"이동 모드",action:null,allowRepeat:!1,category:"transform"}),this.actions.transform.set("KeyE",{name:"Rotate Mode",description:"회전 모드",action:null,allowRepeat:!1,category:"transform"}),this.actions.transform.set("KeyR",{name:"Scale Mode",description:"크기 모드",action:null,allowRepeat:!1,category:"transform"}),this.actions.transform.set("KeyQ",{name:"Toggle Space",description:"좌표계 전환",action:null,allowRepeat:!1,category:"transform"}),this.actions.transform.set("KeyX",{name:"Toggle Snap",description:"그리드 스냅 토글",action:null,allowRepeat:!1,category:"transform"}),this.actions.rotation.set("KeyJ",{name:"Rotate X+",description:"X축 양의 방향 15도 회전",action:null,allowRepeat:!0,category:"rotation"}),this.actions.rotation.set("KeyL",{name:"Rotate X-",description:"X축 음의 방향 15도 회전",action:null,allowRepeat:!0,category:"rotation"}),this.actions.rotation.set("KeyI",{name:"Rotate Y+",description:"Y축 양의 방향 15도 회전",action:null,allowRepeat:!0,category:"rotation"}),this.actions.rotation.set("KeyK",{name:"Rotate Y-",description:"Y축 음의 방향 15도 회전",action:null,allowRepeat:!0,category:"rotation"}),this.actions.rotation.set("KeyU",{name:"Rotate Z+",description:"Z축 양의 방향 15도 회전",action:null,allowRepeat:!0,category:"rotation"}),this.actions.rotation.set("KeyO",{name:"Rotate Z-",description:"Z축 음의 방향 15도 회전",action:null,allowRepeat:!0,category:"rotation"}),this.actions.rotation.set("KeyP",{name:"Reset Rotation",description:"회전 초기화",action:null,allowRepeat:!1,category:"rotation"}),this.actions.selection.set("Escape",{name:"Deselect All",description:"모든 선택 해제",action:null,allowRepeat:!1,category:"selection"}),this.actions.selection.set("KeyA",{name:"Select All",description:"전체 선택",action:null,allowRepeat:!1,category:"selection",requiresCtrl:!0}),this.actions.object.set("Delete",{name:"Delete Objects",description:"선택된 오브젝트 삭제",action:null,allowRepeat:!1,category:"object"}),this.actions.object.set("Backspace",{name:"Delete Objects",description:"선택된 오브젝트 삭제",action:null,allowRepeat:!1,category:"object"}),this.actions.object.set("KeyD",{name:"Duplicate Objects",description:"오브젝트 복제",action:null,allowRepeat:!1,category:"object",requiresCtrl:!0}),this.actions.object.set("KeyG",{name:"Group Objects",description:"오브젝트 그룹화",action:null,allowRepeat:!1,category:"object",requiresCtrl:!0}),this.actions.viewport.set("KeyF",{name:"Focus on Object",description:"선택된 오브젝트로 포커스",action:null,allowRepeat:!1,category:"viewport"}),this.actions.viewport.set("Numpad5",{name:"Toggle Projection",description:"투영 모드 전환",action:null,allowRepeat:!1,category:"viewport"}),this.actions.viewport.set("Numpad1",{name:"Front View",description:"정면 뷰",action:null,allowRepeat:!1,category:"viewport"}),this.actions.viewport.set("Numpad3",{name:"Side View",description:"측면 뷰",action:null,allowRepeat:!1,category:"viewport"}),this.actions.viewport.set("Numpad7",{name:"Top View",description:"상단 뷰",action:null,allowRepeat:!1,category:"viewport"}),this.actions.viewport.set("Numpad0",{name:"Reset Camera",description:"카메라 리셋",action:null,allowRepeat:!1,category:"viewport"}),this.actions.system.set("KeyZ",{name:"Undo",description:"실행 취소",action:null,allowRepeat:!1,category:"system",requiresCtrl:!0}),this.actions.system.set("KeyY",{name:"Redo",description:"다시 실행",action:null,allowRepeat:!1,category:"system",requiresCtrl:!0}),this.actions.system.set("KeyS",{name:"Save",description:"저장",action:null,allowRepeat:!1,category:"system",requiresCtrl:!0})}registerInputHandlers(){this.inputManager.registerKeyHandler("default",this.handleKeyInput.bind(this))}handleKeyInput(e){const{code:t,ctrl:n,shift:r,originalEvent:s}=e;"keyup"!==(null==s?void 0:s.type)?n?this.handleCtrlKeyPress(e):this.handleKeyPress(e):this.releaseComboLocksForKey(t)}handleKeyPress(e){const{code:t,ctrl:n,shift:r,originalEvent:s}=e;if(n)return;const i=this.findAction(t);if(i&&i.action&&!i.requiresCtrl){if((null==s?void 0:s.repeat)&&!i.allowRepeat)return;s.preventDefault(),this.executeAction(i,e)}}handleCtrlKeyPress(e){const{code:t,shift:n,originalEvent:r}=e,s="KeyZ"===t||"KeyY"===t,i=this.buildComboSignature(t,{ctrl:!0,shift:n});if(s&&this.comboLocks.has(i))return;const a=this.findAction(t);if(a&&a.action&&a.requiresCtrl){if((null==r?void 0:r.repeat)&&!a.allowRepeat)return;if(r.preventDefault(),n&&"KeyG"===t)this.executeSpecialAction("ungroupObjects",e);else if(n&&"KeyZ"===t){if(null==r?void 0:r.repeat)return;s&&this.comboLocks.add(i),this.executeSpecialAction("redo",e)}else s&&this.comboLocks.add(i),this.executeAction(a,e)}}buildComboSignature(e,{ctrl:t=!1,shift:n=!1}={}){const r=[];return t&&r.push("Ctrl"),n&&r.push("Shift"),r.push(e),r.join("+")}releaseComboLocksForKey(e){const t=[];for(const n of this.comboLocks)n.endsWith(`+${e}`)&&t.push(n);for(const n of t)this.comboLocks.delete(n)}findAction(e){for(const[t,n]of Object.entries(this.actions))if(n.has(e))return n.get(e);return null}executeAction(e,t){if("function"==typeof e.action)try{e.action(t)}catch(n){}}executeSpecialAction(e,t){var n,r;const s={ungroupObjects:null==(n=this.actions.object.get("KeyG"))?void 0:n.ungroupAction,redo:null==(r=this.actions.system.get("KeyZ"))?void 0:r.redoAction}[e];if("function"==typeof s)try{s(t)}catch(i){}}registerTransformActions(e){e.setMode&&(this.actions.transform.get("KeyW").action=()=>e.setMode("translate"),this.actions.transform.get("KeyE").action=()=>e.setMode("rotate"),this.actions.transform.get("KeyR").action=()=>e.setMode("scale")),e.toggleSpace&&(this.actions.transform.get("KeyQ").action=e.toggleSpace),e.toggleSnap&&(this.actions.transform.get("KeyX").action=e.toggleSnap)}registerRotationActions(e){e.rotateX&&(this.actions.rotation.get("KeyJ").action=()=>e.rotateX(15),this.actions.rotation.get("KeyL").action=()=>e.rotateX(-15)),e.rotateY&&(this.actions.rotation.get("KeyI").action=()=>e.rotateY(15),this.actions.rotation.get("KeyK").action=()=>e.rotateY(-15)),e.rotateZ&&(this.actions.rotation.get("KeyU").action=()=>e.rotateZ(15),this.actions.rotation.get("KeyO").action=()=>e.rotateZ(-15)),e.resetRotation&&(this.actions.rotation.get("KeyP").action=e.resetRotation)}registerSelectionActions(e){e.deselectAll&&(this.actions.selection.get("Escape").action=e.deselectAll),e.selectAll&&(this.actions.selection.get("KeyA").action=e.selectAll)}registerObjectActions(e){e.deleteSelected&&(this.actions.object.get("Delete").action=e.deleteSelected,this.actions.object.get("Backspace").action=e.deleteSelected),e.duplicateSelected&&(this.actions.object.get("KeyD").action=e.duplicateSelected),e.groupSelected&&(this.actions.object.get("KeyG").action=e.groupSelected),e.ungroupSelected&&(this.actions.object.get("KeyG").ungroupAction=e.ungroupSelected)}registerViewportActions(e){e.focusOnSelected&&(this.actions.viewport.get("KeyF").action=e.focusOnSelected),e.toggleProjection&&(this.actions.viewport.get("Numpad5").action=e.toggleProjection),e.setView&&(this.actions.viewport.get("Numpad1").action=()=>e.setView("front"),this.actions.viewport.get("Numpad3").action=()=>e.setView("side"),this.actions.viewport.get("Numpad7").action=()=>e.setView("top")),e.resetCamera&&(this.actions.viewport.get("Numpad0").action=e.resetCamera)}registerSystemActions(e){e.undo&&(this.actions.system.get("KeyZ").action=e.undo),e.redo&&(this.actions.system.get("KeyZ").redoAction=e.redo,this.actions.system.has("KeyY")&&(this.actions.system.get("KeyY").action=e.redo)),e.save&&(this.actions.system.get("KeyS").action=e.save)}registerCustomKey(e,t,n,r,s="custom",i=!1){this.actions[s]||(this.actions[s]=new Map),this.actions[s].set(e,{name:t,description:n,action:r,category:s,requiresCtrl:i,allowRepeat:!1})}unregisterKey(e,t=null){if(t&&this.actions[t])this.actions[t].delete(e);else for(const n of Object.values(this.actions))if(n.has(e)){n.delete(e);break}}getKeyMappings(){const e={};for(const[t,n]of Object.entries(this.actions)){e[t]={};for(const[r,s]of n.entries())e[t][r]={name:s.name,description:s.description,requiresCtrl:s.requiresCtrl||!1}}return e}checkKeyConflicts(){const e=new Map,t=[];for(const[n,r]of Object.entries(this.actions))for(const[s,i]of r.entries()){const r=`${s}${i.requiresCtrl?"+Ctrl":""}`;e.has(r)?t.push({key:r,conflicting:[e.get(r),`${n}:${i.name}`]}):e.set(r,`${n}:${i.name}`)}return t.length,t}generateHelpText(){let e="Keyboard Shortcuts:\n\n";for(const[t,n]of Object.entries(this.actions))if(0!==n.size){e+=`${t.toUpperCase()}:\n`;for(const[t,r]of n.entries()){e+=`  ${this.formatKeyName(t,r.requiresCtrl).padEnd(20)} - ${r.description}\n`}e+="\n"}return e}formatKeyName(e,t=!1){const n={KeyW:"W",KeyE:"E",KeyR:"R",KeyQ:"Q",KeyX:"X",KeyV:"V",KeyC:"C",KeyA:"A",KeyD:"D",KeyG:"G",KeyF:"F",KeyZ:"Z",KeyS:"S",Escape:"ESC",Delete:"DEL",Backspace:"BACKSPACE",Numpad1:"NUM1",Numpad3:"NUM3",Numpad5:"NUM5",Numpad7:"NUM7",Numpad0:"NUM0"}[e]||e;return t?`Ctrl+${n}`:n}setEnabled(e){this.inputManager.setEnabled(e)}dispose(){for(const e of Object.values(this.actions))e.clear()}}class an{constructor(e){this.inputManager=e,this.transformControls=null,this.objectSelector=null,this.state={isDragging:!1,dragButton:-1,dragThreshold:5,isSelecting:!1,isPanning:!1,isOrbiting:!1,isGizmoInteracting:!1},this.handlers={leftClick:null,rightClick:null,middleClick:null,leftDrag:null,rightDrag:null,middleDrag:null,dragSelect:null,wheel:null,hover:null},this.selectionBox={element:null,startX:0,startY:0,isVisible:!1},this.registerInputHandlers()}registerInputHandlers(){this.inputManager.registerMouseHandler("mousedown",this.handleMouseDown.bind(this)),this.inputManager.registerMouseHandler("mousemove",this.handleMouseMove.bind(this)),this.inputManager.registerMouseHandler("mouseup",this.handleMouseUp.bind(this)),this.inputManager.registerWheelHandler(this.handleWheel.bind(this))}setTransformControls(e){this.transformControls=e,this.setupGizmoEventListeners()}setObjectSelector(e){this.objectSelector=e,e&&e.transformControls&&this.setTransformControls(e.transformControls)}setupGizmoEventListeners(){this.transformControls&&this.transformControls.addEventListener("dragging-changed",e=>{this.state.isGizmoInteracting=e.value})}isGizmoInteracting(){return this.state.isGizmoInteracting||this.transformControls&&this.transformControls.dragging}handleMouseDown(e){const{button:t,position:n,ctrl:r,shift:s,alt:i,originalEvent:a}=e;if(!this.isGizmoInteracting())switch(this.state.dragButton=t,t){case 0:this.handleLeftMouseDown(e);break;case 1:this.handleMiddleMouseDown(e);break;case 2:this.handleRightMouseDown(e)}}handleLeftMouseDown(e){const{position:t,ctrl:n,shift:r}=e;if(this.isGizmoInteracting&&this.isGizmoInteracting())return;const s=n||r;this.state.isSelecting=!0,this.selectionBox.startX=t.screenX,this.selectionBox.startY=t.screenY,this.handlers.leftClick&&this.handlers.leftClick({position:t,isMultiSelect:s,originalEvent:e.originalEvent})}handleMiddleMouseDown(e){const{alt:t,originalEvent:n}=e;n.preventDefault(),t?this.state.isOrbiting=!0:this.state.isPanning=!0,this.handlers.middleClick&&this.handlers.middleClick({isOrbiting:this.state.isOrbiting,isPanning:this.state.isPanning,originalEvent:n})}handleRightMouseDown(e){this.handlers.rightClick&&this.handlers.rightClick(e)}handleMouseMove(e){const{position:t,isDown:n,button:r,delta:s}=e;if((!this.isGizmoInteracting()||!n)&&(!n&&this.handlers.hover&&this.handlers.hover({position:t}),n)){if(!this.state.isDragging){this.calculateDragDistance(e)>this.state.dragThreshold&&(this.state.isDragging=!0,this.onDragStart(e))}this.state.isDragging&&this.handleDragMove(e),this.state.isSelecting&&0===r&&this.updateSelectionBox(e)}}onDragStart(e){const{button:t}=e}handleDragMove(e){const{button:t,delta:n}=e;switch(t){case 0:this.handlers.leftDrag&&this.handlers.leftDrag({delta:n,mouseInfo:e});break;case 1:this.state.isPanning&&this.handlers.middleDrag?this.handlers.middleDrag({type:"pan",delta:n,mouseInfo:e}):this.state.isOrbiting&&this.handlers.middleDrag&&this.handlers.middleDrag({type:"orbit",delta:n,mouseInfo:e});break;case 2:this.handlers.rightDrag&&this.handlers.rightDrag({delta:n,mouseInfo:e})}}handleMouseUp(e){const{button:t,position:n}=e;this.isGizmoInteracting()||(this.state.isSelecting&&0===t&&this.finishDragSelection(e),this.state.isDragging?this.handleDragEnd(e):this.handleClick(e)),this.resetMouseState()}handleClick(e){}handleDragEnd(e){this.state.isPanning&&this.handlers.dragEnd&&this.handlers.dragEnd({type:"pan",mouseInfo:e})}handleWheel(e){this.handlers.wheel&&this.handlers.wheel(e)}calculateDragDistance(e){const{position:t,dragStart:n}=e,r=t.screenX-n.screenX,s=t.screenY-n.screenY;return Math.sqrt(r*r+s*s)}updateSelectionBox(e){var t;const{position:n}=e,r=n.screenX,s=n.screenY,i=null==(t=this.inputManager)?void 0:t.canvas,a=i?i.getBoundingClientRect():null,o=(e,t,n)=>Math.min(Math.max(e,t),n),l=this.selectionBox.startX,c=this.selectionBox.startY,d=a?o(l,a.left,a.right):l,u=a?o(c,a.top,a.bottom):c,h=a?o(r,a.left,a.right):r,p=a?o(s,a.top,a.bottom):s,m=Math.min(d,h),g=Math.min(u,p),b=Math.abs(h-d),f=Math.abs(p-u);(b>this.state.dragThreshold||f>this.state.dragThreshold)&&(b>0&&f>0?this.showSelectionBox(m,g,b,f):this.hideSelectionBox(),this.handlers.dragSelect&&this.handlers.dragSelect({startX:d,startY:u,currentX:h,currentY:p,left:m,top:g,width:b,height:f}))}finishDragSelection(e){var t;const{position:n,ctrl:r,shift:s}=e,i=this.calculateDragDistance(e),a=r||s;if(this.hideSelectionBox(),i<this.state.dragThreshold)return;const o=null==(t=this.inputManager)?void 0:t.canvas,l=o?o.getBoundingClientRect():null,c=(e,t,n)=>Math.min(Math.max(e,t),n),d=l?c(this.selectionBox.startX,l.left,l.right):this.selectionBox.startX,u=l?c(this.selectionBox.startY,l.top,l.bottom):this.selectionBox.startY,h=l?c(n.screenX,l.left,l.right):n.screenX,p=l?c(n.screenY,l.top,l.bottom):n.screenY;l&&Math.abs(h-d)<=this.state.dragThreshold&&Math.abs(p-u)<=this.state.dragThreshold||this.handlers.dragSelectEnd&&this.handlers.dragSelectEnd({startX:d,startY:u,endX:h,endY:p,isMultiSelect:a})}showSelectionBox(e,t,n,r){this.selectionBox.element||this.createSelectionBoxElement();const s=this.selectionBox.element;s.style.left=`${e}px`,s.style.top=`${t}px`,s.style.width=`${n}px`,s.style.height=`${r}px`,s.style.display="block",this.selectionBox.isVisible=!0}hideSelectionBox(){this.selectionBox.element&&(this.selectionBox.element.style.display="none"),this.selectionBox.isVisible=!1}createSelectionBoxElement(){const e=document.createElement("div");e.style.position="fixed",e.style.border="1px dashed #007acc",e.style.backgroundColor="rgba(0, 122, 204, 0.1)",e.style.pointerEvents="none",e.style.zIndex="10000",e.style.display="none",document.body.appendChild(e),this.selectionBox.element=e}resetMouseState(){this.state.isDragging=!1,this.state.dragButton=-1,this.state.isSelecting=!1,this.state.isPanning=!1,this.state.isOrbiting=!1}onLeftClick(e){this.handlers.leftClick=e}onRightClick(e){this.handlers.rightClick=e}onMiddleClick(e){this.handlers.middleClick=e}onLeftDrag(e){this.handlers.leftDrag=e}onMiddleDrag(e){this.handlers.middleDrag=e}onRightDrag(e){this.handlers.rightDrag=e}onDragSelect(e){this.handlers.dragSelect=e}onDragSelectEnd(e){this.handlers.dragSelectEnd=e}onWheel(e){this.handlers.wheel=e}onHover(e){this.handlers.hover=e}onDragEnd(e){this.handlers.dragEnd=e}setDragThreshold(e){this.state.dragThreshold=Math.max(1,e)}getMouseState(){return{...this.state}}getSelectionBoxState(){return{...this.selectionBox}}removeHandler(e){this.handlers.hasOwnProperty(e)&&(this.handlers[e]=null)}removeAllHandlers(){for(const e in this.handlers)this.handlers[e]=null}dispose(){this.selectionBox.element&&(document.body.removeChild(this.selectionBox.element),this.selectionBox.element=null),this.removeAllHandlers(),this.resetMouseState(),this.transformControls=null,this.objectSelector=null}}class on{constructor(e,t,n,r,s=null){var i,a,o,l,c;this.scene=e,this.renderer=n,this.editorStore=r,this.gizmoScene=null,this.inputManager=new rn,this.keyboardController=new sn(this.inputManager),this.mouseController=new an(this.inputManager),this.cameraController=new en(t,n,s);try{const e=this.editorStore.getState();null==(a=(i=this.cameraController).setSpeeds)||a.call(i,{pan:e.cameraPanSpeed,orbit:e.cameraOrbitSpeed,zoom:e.cameraZoomSpeed}),this._unsubCamSpeeds=this.editorStore.subscribe((e,t)=>{var n,r;e.cameraPanSpeed===t.cameraPanSpeed&&e.cameraOrbitSpeed===t.cameraOrbitSpeed&&e.cameraZoomSpeed===t.cameraZoomSpeed||null==(r=(n=this.cameraController).setSpeeds)||r.call(n,{pan:e.cameraPanSpeed,orbit:e.cameraOrbitSpeed,zoom:e.cameraZoomSpeed})})}catch{}this.objectSelector=new tn(e,t,n,r),null==(l=(o=this.objectSelector).setGizmoScene)||l.call(o,null),this._gizmoPointerDown=!1,this._gizmoPointerDownAt=0;try{const e=null==(c=this.objectSelector)?void 0:c.transformControls;e&&(e.addEventListener("mouseDown",()=>{this._gizmoPointerDown=!0,this._gizmoPointerDownAt="undefined"!=typeof performance?performance.now():Date.now()}),e.addEventListener("mouseUp",()=>{this._gizmoPointerDown=!1,this._gizmoPointerDownAt=0}),e.addEventListener("dragging-changed",e=>{(null==e?void 0:e.value)&&(this._gizmoPointerDown=!0)}))}catch{}this.mouseController.setObjectSelector(this.objectSelector),this.transformManager=new nn(this.objectSelector,r,this.keyboardController),this._wrapSceneAddForWireframe(e),this.initializeGrid(),this.inputManager.setupMouseEvents(n.domElement),this.inputManager.registerResizeHandler(this.onWindowResize.bind(this)),this.setupMouseHandlers(),this.setupViewportActions(),this.isMouseDown=!1,this.isPanning=!1,this.isOrbiting=!1,this.isDragSelecting=!1,this.mousePosition=new y,this.previousMousePosition=new y,this.dragStartPosition=new y,this.partInspector={enabled:!1,selectedPart:null,selectedParts:new Set,solo:!1,clipping:!1,savedVisibility:new Map,clippingPlanes:[],group:null,groupPivot:"center",groupEnabled:!1},this._partRaycaster=new f,this._partTransformControls=null,this._initPartTransformControls(t,n)}_wrapSceneAddForWireframe(e){try{if(!e||!e.add||e.__addWrapped)return;const t=e.add.bind(e),n=this.editorStore;e.add=(...e)=>{var r;const s=t(...e);try{const t=!!n.getState().isWireframe;for(const n of e)null==(r=null==n?void 0:n.traverse)||r.call(n,e=>{e&&e.isMesh&&e.material&&(Array.isArray(e.material)?e.material.forEach(e=>{e&&(e.wireframe=t)}):e.material.wireframe=t)})}catch{}return s},e.__addWrapped=!0}catch{}}setupMouseHandlers(){this.mouseController.onLeftClick(e=>{var t;const{position:n,isMultiSelect:r}=e;this.updateMousePosition(n);const s="undefined"!=typeof performance?performance.now():Date.now(),i=this._gizmoPointerDown||this._gizmoPointerDownAt&&s-this._gizmoPointerDownAt<300;if(!this.objectSelector.isDraggingGizmo()&&!i){if(this.partInspector.enabled){const e=this.raycastMeshAtNDC(this.mousePosition);return void(r?(null==(t=null==e?void 0:e.object)?void 0:t.isMesh)&&(this.partInspector.selectedParts.has(e.object)?this.partInspector.selectedParts.delete(e.object):(this.partInspector.selectedParts.add(e.object),this.partInspector.selectedPart=e.object),this._updatePartOutline()):this.selectPart((null==e?void 0:e.object)||null,(null==e?void 0:e.point)||null))}this.objectSelector.handleObjectSelection(this.mousePosition,r)}}),this.mouseController.onMiddleClick(e=>{var t,n;try{if(null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:n.call(t).useBlenderControls)return}catch{}const{isOrbiting:r,isPanning:s}=e;this.isOrbiting=r,this.isPanning=s}),this.mouseController.onMiddleDrag(e=>{var t,n;try{if(null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:n.call(t).useBlenderControls)return}catch{}const{type:r,delta:s}=e;"pan"===r?this.cameraController.pan(s.x,s.y):"orbit"===r&&this.cameraController.orbit(s.x,s.y)}),this.mouseController.onDragSelect(e=>{const{left:t,top:n,width:r,height:s}=e;this.objectSelector.showSelectionBox(t,n,r,s)}),this.mouseController.onDragSelectEnd(e=>{const{startX:t,startY:n,endX:r,endY:s,isMultiSelect:i}=e;this.partInspector.enabled?this.selectPartsInRect(t,n,r,s,i):this.finishDragSelection(t,n,r,s,i)}),this.mouseController.onWheel(e=>{var t,n;try{if(null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:n.call(t).useBlenderControls)return}catch{}if(this.objectSelector.isDraggingGizmo())return;const r=e.delta>0?1:-1;this.cameraController.zoom(.3*r)}),this.mouseController.onDragEnd(e=>{var t,n;try{if(null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:n.call(t).useBlenderControls)return}catch{}"pan"===e.type&&this.cameraController.updateRotationCenterAfterPan(this.scene,this.objectSelector.getSelectableObjects()),this.isMouseDown=!1,this.isPanning=!1,this.isOrbiting=!1,this.isDragSelecting=!1,this.objectSelector.hideSelectionBox()})}_initPartTransformControls(e,t){var n,r;try{this._partTransformControls=new S(e,t.domElement),this._partTransformControls.visible=!1,this._partTransformControls.enabled=!1,this._partTransformControls.setSize(.9);try{const e=null==(r=(n=this._partTransformControls).getHelper)?void 0:r.call(n);if(e&&e.isObject3D){const t=()=>{var t,n,r;try{const s=null==(n=null==(t=e.children)?void 0:t.find)?void 0:n.call(t,e=>"helper"===e.name);s&&(s.visible=!1);const i=[];null==(r=e.traverse)||r.call(e,e=>{const t="Line"===e.type||"Line2"===e.type||"LineSegments"===e.type||"LineSegments2"===e.type||e.isLine,n=e.material&&(e.material.isLineBasicMaterial||e.material.isLineDashedMaterial);(t||n)&&i.push(e)}),i.forEach(e=>{var t;try{e.parent&&e.parent.remove(e),(null==(t=e.geometry)?void 0:t.dispose)&&e.geometry.dispose();const n=e.material;Array.isArray(n)?n.forEach(e=>(null==e?void 0:e.dispose)&&e.dispose()):(null==n?void 0:n.dispose)&&n.dispose()}catch{}})}catch{}};t(),e.onBeforeRender=()=>{try{t()}catch{}},e.renderOrder=999;(this.gizmoScene||this.scene).add(e),this._partTransformControls.addEventListener("change",t),this._partTransformControls.addEventListener("dragging-changed",t),this._partTransformControls.addEventListener("mouseDown",t),this._partTransformControls.addEventListener("mouseUp",t),this._partTransformControls.addEventListener("objectChange",t)}}catch{}this._partGizmoInitial=null,this._partTransformControls.addEventListener("dragging-changed",e=>{var t,n;const r=e.value,s=this.getActivePartSet();if(0!==s.length)if(r)this._partGizmoInitial=s.map(e=>{var t,n,r;return{uuid:e.uuid,position:e.position.clone(),rotation:e.rotation.clone(),scale:e.scale.clone(),parentId:null!=(r=null==(n=null==(t=e.parent)?void 0:t.userData)?void 0:n.id)?r:null}});else{if(!this._partGizmoInitial)return;const e=s.map(e=>{var t,n,r;return{uuid:e.uuid,parentId:null!=(r=null==(n=null==(t=e.parent)?void 0:t.userData)?void 0:n.id)?r:null,after:{position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},scale:{x:e.scale.x,y:e.scale.y,z:e.scale.z}}}}),r=new Map(this._partGizmoInitial.map(e=>[e.uuid,e])),i=[];for(const t of e){const e=r.get(t.uuid);if(!e)continue;const n={position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},scale:{x:e.scale.x,y:e.scale.y,z:e.scale.z}},s=t.after;(n.position.x!==s.position.x||n.position.y!==s.position.y||n.position.z!==s.position.z||n.rotation.x!==s.rotation.x||n.rotation.y!==s.rotation.y||n.rotation.z!==s.rotation.z||n.scale.x!==s.scale.x||n.scale.y!==s.scale.y||n.scale.z!==s.scale.z)&&i.push({uuid:t.uuid,parentId:t.parentId,before:n,after:s})}if(i.length>0)try{const e=null==(n=null==(t=this.editorStore)?void 0:t.getState)?void 0:n.call(t);(null==e?void 0:e._pushHistory)&&e._pushHistory({type:"part-transform",parts:i})}catch{}this._partGizmoInitial=null}})}catch(s){this._partTransformControls=null}}isPartGizmoEnabled(){var e;return!!(null==(e=this.partInspector)?void 0:e.gizmo)}setPartGizmoEnabled(e){var t,n,r,s,i,a,o,l,c,d;const u=this.partInspector.selectedPart;if(!this._partTransformControls)return!1;if(!e){this.partInspector.gizmo=!1;try{this._partTransformControls.detach()}catch{}return this._partTransformControls.visible=!1,this._partTransformControls.enabled=!1,!0}if(!u&&!this.partInspector.groupEnabled)return!1;try{null==(r=null==(n=null==(t=this.objectSelector)?void 0:t.transformControls)?void 0:n.detach)||r.call(n)}catch{}this.partInspector.groupEnabled?(this._ensurePartGroup(),this.partInspector.group&&this._partTransformControls.attach(this.partInspector.group)):this._partTransformControls.attach(u);try{const e=(null==(i=null==(s=this.transformManager)?void 0:s.getState)?void 0:i.call(s).mode)||(null==(l=null==(o=null==(a=this.objectSelector)?void 0:a.transformControls)?void 0:o.getMode)?void 0:l.call(o))||"translate",t=(null==(d=null==(c=this.editorStore)?void 0:c.getState)?void 0:d.call(c).gizmoSpace)||"world";this._partTransformControls.setMode(e),this._partTransformControls.setSpace(t)}catch{}return this._partTransformControls.visible=!0,this._partTransformControls.enabled=!0,this.partInspector.gizmo=!0,!0}setPartGizmoMode(e){return!!this._partTransformControls&&(!!["translate","rotate","scale"].includes(e)&&(this._partTransformControls.setMode(e),!0))}detachPartGizmo(){if(this._partTransformControls){try{this._partTransformControls.detach()}catch{}this._partTransformControls.visible=!1,this._partTransformControls.enabled=!1,this.partInspector.gizmo=!1}}setPostProcessingManager(e){var t,n;this.postProcessingManager=e;try{null==(n=null==(t=this.objectSelector)?void 0:t.setPostProcessingManager)||n.call(t,e)}catch{}}_updatePartOutline(){}setupViewportActions(){this.keyboardController.registerViewportActions({focusOnSelected:()=>{var e,t,n,r;const s=(null==(t=(e=this.objectSelector).getSelectedObjects)?void 0:t.call(e))||[],i=e=>this.resolveToThreeObject(e),a=s.map(e=>(null==e?void 0:e.isObject3D)?e:i((null==e?void 0:e.id)||e)).filter(Boolean);if(0===a.length){const e=this.editorStore.getState().selectedObject,t=this.resolveToThreeObject(e);t&&a.push(t)}if(0!==a.length){try{if((null==(r=null==(n=this.editorStore)?void 0:n.getState)?void 0:r.call(n).useBlenderControls)&&"undefined"!=typeof window&&window.__blenderControls)return void(1===a.length?window.__blenderControls.focusOnObject(a[0]):window.__blenderControls.focusOnObjects(a))}catch{}if(1===a.length)this.cameraController.focusOnObject(a[0]);else{const e=new v;a.forEach(t=>{try{e.expandByObject(t)}catch{}});const t=e.getCenter(new p),n=e.getSize(new p),r=Math.max(n.x,n.y,n.z)||1;let s;const i=this.cameraController.getCamera();if(i.isPerspectiveCamera){const e=i.fov*(Math.PI/180);s=1.5*Math.abs(r/Math.sin(e/2))}else s=2*r;const o=(new p).subVectors(i.position,t).normalize();this.cameraController.setTarget(t),i.position.copy(t).add(o.multiplyScalar(s)),i.lookAt(t),i.updateMatrixWorld()}}},toggleProjection:()=>{const e=this.cameraController.toggleProjection();return this.objectSelector.updateCamera(e),e},setView:e=>{this.cameraController.setView(e)},resetCamera:()=>{this.cameraController.resetCamera()}})}updateMousePosition(e){void 0!==e.x&&void 0!==e.y&&(this.mousePosition.x=e.x,this.mousePosition.y=e.y)}finishDragSelection(e,t,n,r,s){const i=this.renderer.domElement.getBoundingClientRect(),a={x:(e-i.left)/i.width*2-1,y:-(t-i.top)/i.height*2+1},o={x:(n-i.left)/i.width*2-1,y:-(r-i.top)/i.height*2+1},l=this.objectSelector.getObjectsInArea(a,o);if(l.length>0)this.objectSelector.selectMultipleObjects(l,s);else if(!s){const s=Math.abs(n-e),i=Math.abs(r-t);Math.hypot(s,i)>=12&&this.objectSelector.deselectAllObjects()}this.objectSelector.hideSelectionBox()}get camera(){return this.cameraController.getCamera()}set camera(e){this.cameraController.camera=e,this.objectSelector.updateCamera(e)}onWindowResize(){this.cameraController.handleResize(),this.renderer.setSize(window.innerWidth,window.innerHeight)}addSelectableObject(e){this.objectSelector.addSelectableObject(e)}removeSelectableObject(e){this.objectSelector.removeSelectableObject(e)}updateSelectableObjects(e){this.objectSelector.updateSelectableObjects(e)}getSelectedObjects(){return this.objectSelector.getSelectedObjects()}getSelectableObjects(){return this.objectSelector.getSelectableObjects()}selectObject(e){this.objectSelector.selectSingleObject(e)}findObjectById(e){if(null==e)return null;let t=null,n=null;if(this.scene.traverse(n=>{t||n&&n.userData&&n.userData.id===e&&(t=n)}),t)return t;if(this.scene.traverse(t=>{n||t&&t.userData&&t.userData.ownerId===e&&(n=t)}),!n)return null;let r=n;for(;r;){if(r.userData&&r.userData.id===e)return r;r=r.parent}return n}deselectAllObjects(){this.objectSelector.deselectAllObjects()}setGizmoMode(e){this.objectSelector.setGizmoMode(e)}getTransformState(){return this.transformManager.getState()}setTransformMode(e){return this.transformManager.setTransformMode(e)}toggleTransformSpace(){return this.transformManager.toggleSpace()}toggleGridSnap(){return this.transformManager.toggleGridSnap()}setGridSize(e){return this.transformManager.setGridSize(e)}duplicateSelectedObjects(){return this.transformManager.duplicateSelected()}deleteSelectedObjects(){return this.transformManager.deleteSelected()}groupSelectedObjects(){return this.transformManager.groupSelected()}ungroupSelectedObjects(){return this.transformManager.ungroupSelected()}focusOnObject(e){const t=this.resolveToThreeObject(e);t&&this.cameraController.focusOnObject(t)}updateSelectedOutlines(){this.objectSelector.updateAllSelectionOutlines()}setCameraView(e){this.cameraController.setView(e)}toggleCameraProjection(){const e=this.cameraController.toggleProjection();return this.objectSelector.updateCamera(e),e}getCameraTarget(){return this.cameraController.getTarget()}setCameraTarget(e){this.cameraController.setTarget(e)}resetCamera(){this.cameraController.resetCamera()}get transformControls(){return this.objectSelector.getTransformControls()}get selectedObjects(){return this.objectSelector.getSelectedObjects()}get isDragging(){return this.objectSelector.isDraggingGizmo()}dispose(){this.inputManager.dispose(),this.keyboardController.dispose(),this.mouseController.dispose(),this.objectSelector.dispose(),this.transformManager.dispose(),this.gridHelper&&(this.scene.remove(this.gridHelper),this.gridHelper.dispose(),this.gridHelper=null)}resolveToThreeObject(e){var t,n,r;if(!e)return null;if(e.isObject3D)return e;const s="object"==typeof e&&null!=(r=null!=(n=e.id)?n:null==(t=e.userData)?void 0:t.id)?r:e;return this.findObjectById(s)}updateGridSnap(){this.objectSelector.updateGridSnap()}updateWireframe(){const e=this.editorStore.getState();e.scene&&e.scene.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach(t=>{t.wireframe=e.isWireframe}):t.material.wireframe=e.isWireframe)})}updateGizmoSpace(){this.objectSelector.updateGizmoSpace()}applyInitialViewState(){var e,t,n,r,s,i;try{null==(e=this.updateWireframe)||e.call(this)}catch{}try{null==(t=this.updateGridSnap)||t.call(this)}catch{}try{null==(n=this.updateGizmoSpace)||n.call(this)}catch{}try{null==(s=null==(r=this.objectSelector)?void 0:r.updateGizmoSize)||s.call(r)}catch{}try{null==(i=this.toggleGrid)||i.call(this)}catch{}}initializeGrid(){this.gridHelper=new E(20,20,8947848,4473924),this.gridHelper.name="EditorGrid",this.gridHelper.position.y=0,this.gridHelper.userData=this.gridHelper.userData||{},this.gridHelper.userData.isSystemObject=!0,this.gridHelper.material.opacity=.8,this.gridHelper.material.transparent=!0,this.gridHelper.material.depthWrite=!1;const e=this.editorStore.getState().isGridVisible;this.gridHelper.visible=e,this.scene.add(this.gridHelper)}toggleGrid(){if(!this.gridHelper)return!1;const e=this.editorStore.getState().isGridVisible;return this.gridHelper.visible=e,this.gridHelper.updateMatrixWorld(!0),e}isGridShown(){return this.editorStore.getState().isGridVisible}setGridSize(e,t=20){if(!this.gridHelper)return;this.scene.remove(this.gridHelper),this.gridHelper.dispose();const n=this.editorStore.getState().isGridVisible;this.gridHelper=new E(e,t,8947848,4473924),this.gridHelper.name="EditorGrid",this.gridHelper.position.y=0,this.gridHelper.visible=n,this.gridHelper.userData=this.gridHelper.userData||{},this.gridHelper.userData.isSystemObject=!0,this.gridHelper.material.opacity=.8,this.gridHelper.material.transparent=!0,this.gridHelper.material.depthWrite=!1,this.scene.add(this.gridHelper)}enablePartInspect(e){e!==this.partInspector.enabled&&(this.partInspector.enabled=!!e,e||(this.clearPartSelection(),this.setPartSolo(!1),this.setPartClipping(!1),this.detachPartGizmo()))}getSelectedPart(){return this.partInspector.selectedPart}getSelectedPartInfo(){var e,t,n,r,s,i,a,o,l,c,d,u;const h=this.partInspector.selectedPart;if(!h||!h.isMesh||!h.geometry)return null;const m=h.geometry,g=Array.isArray(h.material)?h.material[0]:h.material;m.boundingBox||m.computeBoundingBox(),m.boundingSphere||m.computeBoundingSphere();const b=null==(e=m.attributes)?void 0:e.position,f=m.index,y=null==(t=m.attributes)?void 0:t.uv,x=null==(n=m.attributes)?void 0:n.uv2,w=(new v).setFromObject(h),j=w.getSize(new p),S=w.getCenter(new p),M=f?Math.floor(f.count/3):b?Math.floor(b.count/3):0,O=b?b.count:0;return{name:h.name||"(unnamed mesh)",uuid:h.uuid,drawMode:h.drawMode,geometry:{type:m.type,hasIndex:!!f,attributes:Object.keys(m.attributes||{}),vertices:O,triangles:M,bbox:{min:(null==(i=null==(s=null==(r=m.boundingBox)?void 0:r.min)?void 0:s.toArray)?void 0:i.call(s))||null,max:(null==(l=null==(o=null==(a=m.boundingBox)?void 0:a.max)?void 0:o.toArray)?void 0:l.call(o))||null},world:{size:j.toArray(),center:S.toArray()},uv:y?{count:y.count,itemSize:y.itemSize}:null,uv2:x?{count:x.count,itemSize:x.itemSize}:null},material:g?{type:g.type,name:g.name,color:g.color?`#${g.color.getHexString()}`:null,opacity:null!=(c=g.opacity)?c:1,transparent:!!g.transparent,metalness:null!=(d=g.metalness)?d:null,roughness:null!=(u=g.roughness)?u:null,maps:{map:!!g.map,normalMap:!!g.normalMap,aoMap:!!g.aoMap,roughnessMap:!!g.roughnessMap,metalnessMap:!!g.metalnessMap,emissiveMap:!!g.emissiveMap,alphaMap:!!g.alphaMap}}:null}}raycastMeshAtNDC(e){const t=this.cameraController.getCamera();this._partRaycaster.setFromCamera(e,t);const n=[];this.scene.traverse(e=>{e.isMesh&&e.visible&&n.push(e)});const r=this._partRaycaster.intersectObjects(n,!0);if(!r||0===r.length)return null;return r.find(e=>{var t,n;return(null==(t=e.object)?void 0:t.isMesh)&&!(null==(n=e.object.userData)?void 0:n.isRayHelper)})||r[0]}selectPartsInRect(e,t,n,r,s){const i=this.renderer.domElement.getBoundingClientRect(),a=Math.min(e,n),o=Math.min(t,r),l=Math.max(e,n),c=Math.max(t,r),d=this.cameraController.getCamera(),u=new f,h=[];this.scene.traverse(e=>{e.isMesh&&e.visible&&h.push(e)});const p=new Set;for(let m=0;m<6;m++)for(let e=0;e<6;e++){const t=o+(e+.5)/6*(c-o),n=new y((a+(m+.5)/6*(l-a)-i.left)/i.width*2-1,-(t-i.top)/i.height*2+1);u.setFromCamera(n,d);const r=u.intersectObjects(h,!0);if(r&&r.length){const e=r[0].object;(null==e?void 0:e.isMesh)&&p.add(e)}}s||this.partInspector.selectedParts.clear(),p.forEach(e=>this.partInspector.selectedParts.add(e)),this.partInspector.selectedPart=this.partInspector.selectedParts.values().next().value||null,this._updatePartOutline()}selectPart(e,t=null){var n;if(this._restorePartHighlight(),this.partInspector.selectedPart=e&&e.isMesh?e:null,this.partInspector.selectedPart&&this.partInspector.selectedParts.add(this.partInspector.selectedPart),this.partInspector.selectedPart){const e=this.partInspector.selectedPart.material,t=Array.isArray(e)?e[0]:e;t&&"emissive"in t&&(t.userData||(t.userData={}),t.userData._origEmissive=t.emissive.clone(),t.userData._origEmissiveIntensity=null!=(n=t.emissiveIntensity)?n:1,t.emissive=new P(65535),t.emissiveIntensity=.6,t.needsUpdate=!0),this.partInspector.clipping&&this.setPartClipping(!0),this.partInspector.solo&&this.setPartSolo(!0),this.partInspector.gizmo&&this.setPartGizmoEnabled(!0)}else this.setPartSolo(!1),this.setPartClipping(!1),this.detachPartGizmo(),this.partInspector.selectedParts.clear();this._updatePartOutline()}clearPartSelection(){this._restorePartHighlight(),this.partInspector.selectedPart=null,this.partInspector.selectedParts.clear()}_restorePartHighlight(){var e;const t=this.partInspector.selectedPart;if(!t)return;const n=Array.isArray(t.material)?t.material[0]:t.material;n&&n.userData&&n.userData._origEmissive&&(n.emissive.copy(n.userData._origEmissive),n.emissiveIntensity=null!=(e=n.userData._origEmissiveIntensity)?e:1,delete n.userData._origEmissive,delete n.userData._origEmissiveIntensity,n.needsUpdate=!0)}getActivePartSet(){return this.partInspector.groupEnabled&&this.partInspector.selectedParts.size>0?Array.from(this.partInspector.selectedParts):this.partInspector.selectedPart?[this.partInspector.selectedPart]:[]}selectAllChildParts(){const e=this.partInspector.selectedPart;if(!e)return 0;const t=this.partInspector.selectedParts,n=[];return(e.parent||e).traverse(e=>{e.isMesh&&(t.add(e),n.push(e))}),this._updatePartOutline(),n.length}clearAllPartSelections(){this.partInspector.selectedParts.clear(),this._updatePartOutline()}isPartGroupGizmoEnabled(){return!!this.partInspector.groupEnabled}setPartGroupGizmoEnabled(e){this.partInspector.groupEnabled=!!e,e?(this._ensurePartGroup(),this.setPartGizmoEnabled(!0)):(this._detachPartGroup(),this.partInspector.selectedPart&&this.setPartGizmoEnabled(!0)),this._updatePartOutline()}getPartGroupPivot(){return this.partInspector.groupPivot}setPartGroupPivot(e){["center","first","last"].includes(e)&&(this.partInspector.groupPivot=e,this.partInspector.groupEnabled&&this._ensurePartGroup(!0))}_ensurePartGroup(e=!1){const t=this.getActivePartSet();if(0===t.length)return;this.partInspector.group||(this.partInspector.group=new x,this.partInspector.group.name="PartGroupPivot",this.partInspector.group.userData.isSystemObject=!0,this.scene.add(this.partInspector.group));const n=this.partInspector.group;let r=new p;if("first"===this.partInspector.groupPivot)r.copy(t[0].getWorldPosition(new p));else if("last"===this.partInspector.groupPivot)r.copy(t[t.length-1].getWorldPosition(new p));else{const e=new v;for(const n of t)e.expandByObject(n);e.getCenter(r)}n.position.copy(r)}_detachPartGroup(){var e,t;if(this.partInspector.group){try{null==(t=null==(e=this._partTransformControls)?void 0:e.detach)||t.call(e)}catch{}try{this.scene.remove(this.partInspector.group)}catch{}this.partInspector.group=null}}setPartSolo(e){const t=this.partInspector;if(!e)return t.savedVisibility.forEach((e,t)=>{t.visible=e}),t.savedVisibility.clear(),void(t.solo=!1);const n=t.selectedPart;n&&(t.savedVisibility.clear(),this.scene.traverse(e=>{var r;e.isObject3D&&((null==(r=e.userData)?void 0:r.isSystemObject)||e===this.gridHelper||(t.savedVisibility.set(e,e.visible),e.visible=e===n||e.isBone||this._isAncestorOf(e,n)||this._isAncestorOf(n,e)))}),t.solo=!0)}_isAncestorOf(e,t){let n=null==t?void 0:t.parent;for(;n;){if(n===e)return!0;n=n.parent}return!1}setPartClipping(e,t=.01){const n=this.renderer,r=this.partInspector;if(!e)return n.clippingPlanes=[],n.localClippingEnabled=!1,r.clippingPlanes=[],void(r.clipping=!1);const s=r.selectedPart;if(!s)return;const i=(new v).setFromObject(s);i.expandByScalar(t);const a=i.min,o=i.max,l=[new z(new p(1,0,0),-o.x),new z(new p(-1,0,0),a.x),new z(new p(0,1,0),-o.y),new z(new p(0,-1,0),a.y),new z(new p(0,0,1),-o.z),new z(new p(0,0,-1),a.z)];n.clippingPlanes=l,n.localClippingEnabled=!0,r.clippingPlanes=l,r.clipping=!0}}class ln{constructor(e,t){if(!e||!t)throw new Error("BlenderControls requires camera and domElement");this.camera=e,this.domElement=t,this.enabled=!0,this.target=new p(0,0,0),this.rotateSpeed=1,this.panSpeed=1,this.zoomSpeed=1,this.minDistance=.1,this.maxDistance=1/0,this.minPolarAngle=1e-4,this.maxPolarAngle=Math.PI-1e-4,this.enableDamping=!0,this.dampingFactor=.15,this._spherical=new m,this._sphericalDelta=new m(0,0,0),this._panOffset=new p,this._zoomScale=1,this._state="none",this._isAltDown=!1,this._isShiftDown=!1,this._isCtrlDown=!1,this._pointer=new y,this._pointerPrev=new y,this._lastPointerForPick=new y,this._raycaster=new f,this._scene=null,this._onContextMenu=this._onContextMenu.bind(this),this._onMouseDown=this._onMouseDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),this._onPointerMovePassive=e=>{this._lastPointerForPick.set(e.clientX,e.clientY)},this._onMouseUp=this._onMouseUp.bind(this),this._onWheel=this._onWheel.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._updateSphericalFromCamera(),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("mousedown",this._onMouseDown),this.domElement.addEventListener("wheel",this._onWheel,{passive:!1}),this.domElement.addEventListener("mousemove",this._onPointerMovePassive),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)}setSpeeds({rotate:e,pan:t,zoom:n}={}){Number.isFinite(e)&&(this.rotateSpeed=e),Number.isFinite(t)&&(this.panSpeed=t),Number.isFinite(n)&&(this.zoomSpeed=n)}setCamera(e){e&&(this.camera=e,this._updateSphericalFromCamera())}setScene(e){this._scene=e}focusOnObject(e){if(!e)return!1;const t=(new v).setFromObject(e),n=t.getCenter(new p),r=t.getSize(new p),s=Math.max(r.x,r.y,r.z)||1;let i;if(this.camera.isPerspectiveCamera){const e=(this.camera.fov||75)*Math.PI/180;i=1.2*Math.abs(s/Math.sin(e/2))}else i=2*s;const a=(new p).subVectors(this.camera.position,this.target).normalize();this.target.copy(n),this.camera.position.copy(n).add(a.multiplyScalar(i)),this._updateSphericalFromCamera();{const e=(new D).lookAt(this.camera.position,this.target,this.camera.up);this.camera.quaternion.setFromRotationMatrix(e),this.camera.updateMatrixWorld()}return!0}focusOnObjects(e){const t=Array.isArray(e)?e.filter(Boolean):[e];if(!t||0===t.length)return!1;const n=new v;for(const l of t)try{n.expandByObject(l)}catch{}if(!isFinite(n.min.x)||!isFinite(n.max.x))return!1;const r=n.getCenter(new p),s=n.getSize(new p),i=Math.max(s.x,s.y,s.z)||1;let a;if(this.camera.isPerspectiveCamera){const e=(this.camera.fov||75)*Math.PI/180;a=1.2*Math.abs(i/Math.sin(e/2))}else a=2*i;const o=(new p).subVectors(this.camera.position,this.target).normalize();this.target.copy(r),this.camera.position.copy(r).add(o.multiplyScalar(a)),this._updateSphericalFromCamera();{const e=(new D).lookAt(this.camera.position,this.target,this.camera.up);this.camera.quaternion.setFromRotationMatrix(e),this.camera.updateMatrixWorld()}return!0}update(){if(!this.enabled)return!1;const e=new p;e.copy(this.camera.position).sub(this.target),this._spherical.setFromVector3(e),this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi,this._spherical.radius*=this._zoomScale,this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.theta>Math.PI&&(this._spherical.theta-=2*Math.PI),this._spherical.theta<-Math.PI&&(this._spherical.theta+=2*Math.PI),this._spherical.radius=Math.max(this.minDistance,Math.min(this.maxDistance,this._spherical.radius)),this.target.add(this._panOffset);const t=(new p).setFromSpherical(this._spherical).add(this.target);this.camera.position.copy(t);{const e=(new D).lookAt(this.camera.position,this.target,this.camera.up);this.camera.quaternion.setFromRotationMatrix(e),this.camera.updateMatrixWorld()}if(this.enableDamping){this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor),Math.abs(this._sphericalDelta.theta)<1e-6&&(this._sphericalDelta.theta=0),Math.abs(this._sphericalDelta.phi)<1e-6&&(this._sphericalDelta.phi=0),this._panOffset.lengthSq()<1e-10&&this._panOffset.set(0,0,0);const e=Math.pow(1-this.dampingFactor,2);this._zoomScale=1+(this._zoomScale-1)*e,Math.abs(this._zoomScale-1)<1e-4&&(this._zoomScale=1)}else this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0),this._zoomScale=1;return!0}dispose(){this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.removeEventListener("mousedown",this._onMouseDown),this.domElement.removeEventListener("wheel",this._onWheel),this.domElement.removeEventListener("mousemove",this._onPointerMovePassive),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}_onContextMenu(e){e.preventDefault()}_onKeyDown(e){("Alt"===e.key||e.altKey)&&(this._isAltDown=!0),("Shift"===e.key||e.shiftKey)&&(this._isShiftDown=!0),("Control"===e.key||e.ctrlKey)&&(this._isCtrlDown=!0)}_onKeyUp(e){e.altKey||(this._isAltDown=!1),e.shiftKey||(this._isShiftDown=!1),e.ctrlKey||(this._isCtrlDown=!1)}_onMouseDown(e){this.enabled&&1===e.button&&(e.preventDefault(),document.addEventListener("mousemove",this._onMouseMove),document.addEventListener("mouseup",this._onMouseUp),this._pointerPrev.set(e.clientX,e.clientY),this._state=this._isAltDown?"rotate":"pan")}_onMouseMove(e){if(!this.enabled||"none"===this._state)return;e.preventDefault(),this._pointer.set(e.clientX,e.clientY),this._lastPointerForPick.set(e.clientX,e.clientY);const t=this._pointer.x-this._pointerPrev.x,n=this._pointer.y-this._pointerPrev.y;this._pointerPrev.copy(this._pointer),"rotate"===this._state?this._handleRotate(t,n):"pan"===this._state&&this._handlePan(t,n)}_onMouseUp(){document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._state="none"}_onWheel(e){if(!this.enabled)return;e.preventDefault();const t=e.deltaY,n=Math.pow(.95,this.zoomSpeed);t<0?this._dollyIn(n):t>0&&this._dollyOut(n)}_updateSphericalFromCamera(){const e=(new p).copy(this.camera.position).sub(this.target);this._spherical.setFromVector3(e)}_handleRotate(e,t){const{clientWidth:n,clientHeight:r}=this.domElement,s=2*Math.PI*e/Math.max(1,n)*this.rotateSpeed,i=2*Math.PI*t/Math.max(1,r)*this.rotateSpeed;this._sphericalDelta.theta-=s,this._sphericalDelta.phi-=i}_handlePan(e,t){const n=this.domElement;if(this._isShiftDown&&(t=0),this._isCtrlDown&&(e=0),this.camera.isPerspectiveCamera){const r=(new p).copy(this.camera.position).sub(this.target).length(),s=(this.camera.fov||75)*Math.PI/180,i=r*Math.tan(s/2),a=i*(n.clientWidth/Math.max(1,n.clientHeight)),o=e*this.panSpeed*(2*a)/Math.max(1,n.clientWidth),l=t*this.panSpeed*(2*i)/Math.max(1,n.clientHeight);this._panLeft(o),this._panUp(l)}else if(this.camera.isOrthographicCamera){const r=(this.camera.right-this.camera.left)/Math.max(1,n.clientWidth),s=(this.camera.top-this.camera.bottom)/Math.max(1,n.clientHeight);this._panLeft(e*this.panSpeed*r),this._panUp(t*this.panSpeed*s)}else{const n=.002*e*this.panSpeed,r=.002*t*this.panSpeed;this._panLeft(n),this._panUp(r)}}_panLeft(e){const t=new p;t.setFromMatrixColumn(this.camera.matrix,0),t.multiplyScalar(-e),this._panOffset.add(t)}_panUp(e){const t=new p;t.setFromMatrixColumn(this.camera.matrix,1),t.multiplyScalar(e),this._panOffset.add(t)}_dollyIn(e){this._zoomScale*=Math.max(1e-6,e)}_dollyOut(e){this._zoomScale/=Math.max(1e-6,e)}}class cn{constructor(e,t,n){this.scene=e,this.camera=t,this.renderer=n,this.composer=null,this.renderPass=null,this.outputPass=null,this.activeEffects=new Map,this.effectSettings={bloom:{enabled:!1,strength:1.5,radius:.4,threshold:.85},film:{enabled:!1,noiseIntensity:.5,scanlinesIntensity:.05,scanlinesCount:648,grayscale:!1},fxaa:{enabled:!1},ssao:{enabled:!1,kernelRadius:8,minDistance:.005,maxDistance:.1},toneMapping:{enabled:!0,mapping:"ACESFilmic",exposure:1},colorCorrection:{enabled:!1,powRGB:{x:2,y:2,z:2},mulRGB:{x:1,y:1,z:1},addRGB:{x:0,y:0,z:0}},vignette:{enabled:!1,offset:1,darkness:1},sepia:{enabled:!1,amount:1},hueSaturation:{enabled:!1,hue:0,saturation:0},brightnessContrast:{enabled:!1,brightness:0,contrast:0},glitch:{enabled:!1,factor:.1},pixelate:{enabled:!1,pixelSize:6},dotScreen:{enabled:!1,center:{x:.5,y:.5},angle:1.57,scale:1}},this.initializeComposer()}initializeComposer(){if(this.composer)try{for(const e of this.composer.passes||[])try{e.dispose&&e.dispose()}catch{}this.composer.dispose()}catch{}this.composer=new N(this.renderer),this.renderPass=new A(this.scene,this.camera),this.composer.addPass(this.renderPass),this.outputPass=new k,this.updateComposer()}setCamera(e){e&&(this.camera=e,this.renderPass&&(this.renderPass.camera=e),this.updateComposer())}updateComposer(){try{const e=(this.composer.passes||[]).filter(e=>e!==this.renderPass);for(const t of e)try{t.dispose&&t.dispose()}catch{}}catch{}this.composer.passes=[this.renderPass],this.activeEffects.clear(),this.addActiveEffects(),this.composer.addPass(this.outputPass)}addActiveEffects(){this.effectSettings.ssao.enabled&&this.addSSAOEffect(),this.effectSettings.bloom.enabled&&this.addBloomEffect(),this.effectSettings.colorCorrection.enabled&&this.addColorCorrectionEffect(),this.effectSettings.brightnessContrast.enabled&&this.addBrightnessContrastEffect(),this.effectSettings.hueSaturation.enabled&&this.addHueSaturationEffect(),this.effectSettings.sepia.enabled&&this.addSepiaEffect(),this.effectSettings.vignette.enabled&&this.addVignetteEffect(),this.effectSettings.pixelate.enabled&&this.addPixelateEffect(),this.effectSettings.dotScreen.enabled&&this.addDotScreenEffect(),this.effectSettings.glitch.enabled&&this.addGlitchEffect(),this.effectSettings.film.enabled&&this.addFilmEffect(),this.effectSettings.fxaa.enabled&&this.addFXAAEffect(),this.applyToneMapping()}addBloomEffect(){const e=this.effectSettings.bloom,t=new y(window.innerWidth,window.innerHeight),n=new L(t,e.strength,e.radius,e.threshold);this.composer.addPass(n),this.activeEffects.set("bloom",n)}addFilmEffect(){const e=this.effectSettings.film,t=new R(e.noiseIntensity,e.scanlinesIntensity,e.scanlinesCount,e.grayscale);this.composer.addPass(t),this.activeEffects.set("film",t)}addFXAAEffect(){{const e=this.renderer.getPixelRatio(),t=new I(Math.max(1,Math.floor(window.innerWidth*e)),Math.max(1,Math.floor(window.innerHeight*e)));return this.composer.addPass(t),void this.activeEffects.set("fxaa",t)}}addSSAOEffect(){var e,t;const n=this.effectSettings.ssao,r=Math.max(1,(null==(t=(e=this.renderer).getPixelRatio)?void 0:t.call(e))||window.devicePixelRatio||1),s=new T(this.scene,this.camera,Math.max(1,Math.floor(window.innerWidth*r)),Math.max(1,Math.floor(window.innerHeight*r)));s.kernelRadius=n.kernelRadius,s.minDistance=n.minDistance,s.maxDistance=n.maxDistance,this.composer.addPass(s),this.activeEffects.set("ssao",s)}applyToneMapping(){var e;const t=this.effectSettings.toneMapping||{enabled:!0,mapping:"ACESFilmic",exposure:1},n=this._resolveToneMappingConst(t.mapping);try{this.renderer.toneMapping=t.enabled?n:F,this.renderer.toneMappingExposure=null!=(e=t.exposure)?e:1}catch{}}_resolveToneMappingConst(e){switch((e||"").toLowerCase()){case"none":return F;case"linear":return U;case"reinhard":return H;case"cineon":return B;default:return G}}addColorCorrectionEffect(){const e=this.effectSettings.colorCorrection,t=new V(q);t.material.uniforms.powRGB.value=new p(e.powRGB.x,e.powRGB.y,e.powRGB.z),t.material.uniforms.mulRGB.value=new p(e.mulRGB.x,e.mulRGB.y,e.mulRGB.z),t.material.uniforms.addRGB.value=new p(e.addRGB.x,e.addRGB.y,e.addRGB.z),this.composer.addPass(t),this.activeEffects.set("colorCorrection",t)}addVignetteEffect(){const e=this.effectSettings.vignette,t=new V(W);t.material.uniforms.offset.value=e.offset,t.material.uniforms.darkness.value=e.darkness,this.composer.addPass(t),this.activeEffects.set("vignette",t)}addSepiaEffect(){const e=this.effectSettings.sepia,t=new V(K);t.material.uniforms.amount.value=e.amount,this.composer.addPass(t),this.activeEffects.set("sepia",t)}addHueSaturationEffect(){const e=this.effectSettings.hueSaturation,t=new V($);t.material.uniforms.hue.value=e.hue,t.material.uniforms.saturation.value=e.saturation,this.composer.addPass(t),this.activeEffects.set("hueSaturation",t)}addBrightnessContrastEffect(){const e=this.effectSettings.brightnessContrast,t=new V(Z);t.material.uniforms.brightness.value=e.brightness,t.material.uniforms.contrast.value=e.contrast,this.composer.addPass(t),this.activeEffects.set("brightnessContrast",t)}addGlitchEffect(){const e=new X;e.factor=this.effectSettings.glitch.factor,this.composer.addPass(e),this.activeEffects.set("glitch",e)}addPixelateEffect(){const e=this.effectSettings.pixelate,t=new Y(e.pixelSize,this.scene,this.camera);this.composer.addPass(t),this.activeEffects.set("pixelate",t)}addDotScreenEffect(){const e=this.effectSettings.dotScreen,t=new Q(new y(e.center.x,e.center.y),e.angle,e.scale);this.composer.addPass(t),this.activeEffects.set("dotScreen",t)}setEffectEnabled(e,t){if(e in this.effectSettings&&(this.effectSettings[e].enabled=t,this.updateComposer(),"toneMapping"===e))try{Pt({toneMapping:{...this.effectSettings.toneMapping}})}catch{}}updateEffectSettings(e,t){if(this.effectSettings[e]&&(Object.assign(this.effectSettings[e],t),this.effectSettings[e].enabled&&this.updateComposer(),"toneMapping"===e))try{Pt({toneMapping:{...this.effectSettings.toneMapping}})}catch{}}render(){this.composer.render()}handleResize(e,t){var n,r,s,i;const a=Math.max(1,(null==(r=(n=this.renderer).getPixelRatio)?void 0:r.call(n))||window.devicePixelRatio||1);"function"==typeof this.composer.setPixelRatio&&this.composer.setPixelRatio(a),this.composer.setSize(e,t);const o=this.activeEffects.get("fxaa");if(o){const n=this.renderer.getPixelRatio();"function"==typeof o.setSize?o.setSize(Math.max(1,Math.floor(e*n)),Math.max(1,Math.floor(t*n))):(null==(i=null==(s=o.material)?void 0:s.uniforms)?void 0:i.resolution)&&(o.material.uniforms.resolution.value.x=1/(e*n),o.material.uniforms.resolution.value.y=1/(t*n))}}setOutlineSelectedObjects(){}setOutlineActiveObjects(){}getSettings(){return JSON.parse(JSON.stringify(this.effectSettings))}loadSettings(e){Object.assign(this.effectSettings,e),this.updateComposer()}applyPreset(e="default"){var t,n,r,s,i;const a=String(e||"default").toLowerCase(),o={...this.effectSettings};switch(o.fxaa.enabled=!0,o.ssao.enabled=!1,o.bloom.enabled=!1,a){case"high":o.ssao.enabled=!0,o.bloom.enabled=!0,o.bloom.strength=null!=(t=o.bloom.strength)?t:1.5,o.bloom.radius=null!=(n=o.bloom.radius)?n:.4,o.bloom.threshold=null!=(r=o.bloom.threshold)?r:.85,o.ssao.kernelRadius=null!=(s=o.ssao.kernelRadius)?s:12;break;case"medium":o.ssao.enabled=!0,o.ssao.kernelRadius=null!=(i=o.ssao.kernelRadius)?i:8}this.effectSettings=o,this.updateComposer();try{Pt({postProcessing:{preset:e}})}catch{}}dispose(){try{for(const e of this.activeEffects.values())try{e.dispose&&e.dispose()}catch{}if(this.activeEffects.clear(),this.composer){for(const e of this.composer.passes||[])try{e.dispose&&e.dispose()}catch{}this.composer.dispose()}}catch{}this.composer=null,this.renderPass=null,this.outputPass=null}}let dn=null,un=1;const hn=new Map;function pn(){try{return"undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas}catch{return!1}}function mn(e,t,n=[]){const r="mw_"+un++,s=dn||(dn=new Worker(new URL("/assets/meshWorker-Db2p0Myb.js",import.meta.url),{type:"module"}),dn.onmessage=e=>{const t=e.data||{},{id:n}=t;if(!n||!hn.has(n))return;const{resolve:r,reject:s}=hn.get(n);hn.delete(n),"thumbnailFromGLBResult"!==t.type&&"thumbnailFromObjectJSONResult"!==t.type?"exportGLBFromObjectJSONResult"!==t.type?"error"!==t.type?r(t):s(new Error(t.error||"worker error")):t.ok?r(t):s(new Error(t.error||"export failed")):t.ok?r(t):s(new Error(t.error||"thumbnail failed"))},dn.onerror=e=>{for(const[,t]of hn.entries())t.reject((null==e?void 0:e.error)||new Error("Worker error"));hn.clear()},dn),i={type:e,id:r,...t};return new Promise((e,t)=>{hn.set(r,{resolve:e,reject:t}),s.postMessage(i,n)})}async function gn(e,t=128,n=!0){const r=n?[e]:[];return await mn("thumbnailFromGLB",{glbBuffer:e,size:t},r)}function bn(e,t="image/png",n){try{if("undefined"!=typeof OffscreenCanvas){const r=new OffscreenCanvas(e.width,e.height);return r.getContext("2d").drawImage(e,0,0),r.convertToBlob({type:t,quality:n}).then(e=>new Promise((t,n)=>{const r=new FileReader;r.onload=()=>t("string"==typeof r.result?r.result:""),r.onerror=()=>n(r.error||new Error("FileReader error")),r.readAsDataURL(e)}))}}catch{}const r=document.createElement("canvas");r.width=e.width,r.height=e.height;return r.getContext("2d").drawImage(e,0,0),Promise.resolve(r.toDataURL(t,n))}class fn{constructor(){this.loader=ke(),this.exporter=new J,this.thumbnailRenderer=null,this._thumbUrlCache=new Map,this._thumbDataUrlCache=new Map,this.initThumbnailRenderer(),Ut()}_hasRenderableMesh(e){var t;let n=!1;return!!e&&(null==(t=e.traverse)||t.call(e,e=>{n||(null==e?void 0:e.isMesh)&&e.geometry&&e.geometry.isBufferGeometry&&e.geometry.getAttribute("position")&&(n=!0)}),n)}async importGLBFile(e){if(!e)throw new Error("NO_FILE");const t=await e.arrayBuffer(),n=(e.name||"imported").replace(/\.(glb|gltf)$/i,"");return this.importGLBBuffer(t,n)}async importGLBBuffer(e,t="Imported Mesh"){try{let r=null;if(pn())try{const{bitmap:t}=await gn(e,128,!1);r=await bn(t)}catch(n){}if(!r){const t=new Blob([e],{type:"model/gltf-binary"}),n=URL.createObjectURL(t);try{r=await this.generateThumbnailFromURL(n)}finally{try{URL.revokeObjectURL(n)}catch{}}}const s=Date.now(),i={id:`custom_${s}`,name:t||`custom_${s}`,thumbnail:r,type:"custom",glbData:e,createdAt:s};await this.saveCustomMesh(i);try{window.dispatchEvent(new CustomEvent("customMeshAdded"))}catch{}return i}catch(n){throw n}}downloadCustomMesh(e){if(e&&e.glbData)try{const t=new Blob([e.glbData],{type:"model/gltf-binary"}),n=URL.createObjectURL(t),r=document.createElement("a"),s=(e.name||e.id||"mesh").replace(/[^a-zA-Z0-9_-]/g,"_");r.href=n,r.download=`${s}.glb`,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>{try{URL.revokeObjectURL(n)}catch{}},0)}catch(t){}}initThumbnailRenderer(){if(this.thumbnailRenderer&&this.thumbnailRenderer.renderer)try{this.thumbnailRenderer.renderer.dispose()}catch{}this.thumbnailRenderer={scene:new te,camera:new b(75,1,.1,1e3),renderer:new ee({antialias:!0,alpha:!0,preserveDrawingBuffer:!0,powerPreference:"low-power"})};const{scene:e,camera:t,renderer:n}=this.thumbnailRenderer;n.setSize(128,128),n.setClearColor(2763306,1),this.setupLighting(e);try{Ae(n)}catch{}}setupLighting(e){const t=new ne(4210752,.6);e.add(t);const n=new re(16777215,.8);n.position.set(1,1,1),e.add(n);const r=new re(16777215,.4);r.position.set(-1,-1,-1),e.add(r)}safeRotationCopy(e,t){if(e&&t)try{void 0!==e.order?t.copy(e):t.set(e.x||0,e.y||0,e.z||0,"XYZ")}catch(n){t.set(0,0,0,"XYZ")}}createSafeClone(e){try{if(!e||"object"!=typeof e)return new O;if("Group"===e.type||e.isGroup){const t=new x;return t.name=e.name||"",Array.isArray(e.children)&&e.children.forEach(e=>{try{const n=this.createSafeClone(e);t.add(n)}catch(n){}}),e.position&&t.position.copy(e.position),e.rotation&&this.safeRotationCopy(e.rotation,t.rotation),e.scale&&t.scale.copy(e.scale),t}if(e.isMesh){const t=e.geometry?e.geometry.clone():null,n=e.material?this.cloneMaterial(e.material):null,r=new h(t,n);return r.name=e.name||"",e.position&&r.position.copy(e.position),e.rotation&&this.safeRotationCopy(e.rotation,r.rotation),e.scale&&r.scale.copy(e.scale),r}const t=new O;return t.name=e.name||"",Array.isArray(e.children)&&e.children.forEach(e=>{try{const n=this.createSafeClone(e);t.add(n)}catch(n){}}),e.position&&t.position.copy(e.position),e.rotation&&this.safeRotationCopy(e.rotation,t.rotation),e.scale&&t.scale.copy(e.scale),t}catch(t){const n=new O;return n.name=e&&e.name||"fallback_object",n}}cloneMaterial(e){return Array.isArray(e)?e.map(e=>e.clone?e.clone():e):e.clone?e.clone():e}async loadLibraryMeshes(){if(!("undefined"!=typeof window&&!0===window.__ENABLE_LIBRARY_MANIFEST))return[];try{const e="/library/mesh/manifest.json",t=await fetch(e,{method:"GET",cache:"no-store"});if(!t.ok)return[];const n=await t.json();return Array.isArray(n)?n.map(e=>({id:`library_${String(e.filename||"").replace(/\.glb$/i,"")}`,name:e.name||e.filename,type:"library",geometry:"LibraryMesh",glbUrl:`/library/mesh/${e.filename}`,filename:e.filename,thumbnail:null,isLoadingThumbnail:!0})):[]}catch(e){return[]}}async generateThumbnailFromURL(e){if(pn())try{const t=await fetch(e,{cache:"no-store"}),n=await t.arrayBuffer(),{bitmap:r}=await gn(n,128);return await bn(r)}catch(t){}return new Promise((t,n)=>{this.loader.load(e,e=>{try{const{scene:n,camera:r,renderer:s}=this.thumbnailRenderer,i=[];n.traverse(e=>{e.isMesh&&i.push(e)}),i.forEach(e=>n.remove(e));const a=e.scene;n.add(a);const o=(new v).setFromObject(a).getSize(new p),l=Math.max(o.x,o.y,o.z),c=r.fov*(Math.PI/180);let d=Math.abs(l/2/Math.tan(c/2));d*=1.5,r.position.set(.7*d,.5*d,d),r.lookAt(0,0,0),s.render(n,r);const u=s.domElement.toDataURL("image/png");n.remove(a),t(u)}catch(r){n(r)}},void 0,e=>n(e))})}generateThumbnailFromObject(e,t=128){const{scene:n,camera:r,renderer:s}=this.thumbnailRenderer;for(s.setSize(t,t),s.setClearColor(2763306,1);n.children.length;)n.remove(n.children[0]);let i;this.setupLighting(n);try{i="function"==typeof e.clone?e.clone():this.createSafeClone(e)}catch(h){i=this.createSafeClone(e)}n.add(i);const a=(new v).setFromObject(i);a.getCenter(new p);const o=a.getSize(new p),l=Math.max(o.x,o.y,o.z),c=r.fov*(Math.PI/180);let d=Math.abs(l/2/Math.tan(c/2));d*=1.5,r.position.set(.7*d,.5*d,d),r.lookAt(0,0,0),s.render(n,r);const u=s.domElement.toDataURL("image/png");return n.clear(),u}_buildSingleMesh(e,{preserveTransform:t=!0}={}){try{if(!e)return null;const t="function"==typeof e.clone?e.clone(!0):this.createSafeClone(e);t.updateMatrixWorld(!0);const n=new D;n.copy(t.matrixWorld).invert();const r=[],s=[],i=e=>{if(e.isSkinnedMesh||e.isInstancedMesh)return!1;if(Array.isArray(e.material))return!1;const t=e.geometry;if(!t||!t.isBufferGeometry)return!1;const i=t.clone(),a=new D;a.copy(e.matrixWorld),a.premultiply(n),i.applyMatrix4(a);try{i.clearGroups()}catch{}return r.push(i),s.push(e.material),!0};let a=!0;if(t.traverse(e=>{if(!a)return;const t=e.userData||{},n=!!(t.isSystemObject||t.isRayHelper||t.isLightHelper||t.isLightTarget||t.isLightTargetHandle||t.isHelper);e.isMesh&&!n&&(a=i(e))}),!a||0===r.length)return null;const o=se(r,!0);if(!o||!o.groups||o.groups.length!==s.length)return null;const l=new h(o,s);return l.name=e.name||"MergedMesh",l.position.set(0,0,0),l.rotation.set(0,0,0),l.scale.set(1,1,1),l}catch(n){return null}}async exportObjectToGLB(e,t={}){const{preserveTransform:n=!1}=t;if(pn())try{const t=(null==e?void 0:e.toJSON)?e.toJSON():(new O).toJSON(),{glb:r}=await async function(e,t={}){return await mn("exportGLBFromObjectJSON",{objectJSON:e,options:t})}(t,{preserveTransform:n,compressToSingleMesh:!0});if(r&&(r.byteLength||r.buffer&&r.buffer.byteLength))return r}catch(r){}return new Promise((t,r)=>{var s,i,a,o,l,c;let d;try{d="function"==typeof e.clone?e.clone():this.createSafeClone(e)}catch(u){d=this.createSafeClone(e)}if(d&&"object"==typeof d){if(n){try{null==(s=d.updateMatrixWorld)||s.call(d,!0);const e=(new D).copy(d.matrixWorld).invert();null==(i=d.traverse)||i.call(d,t=>{if(!(t&&t.isMesh&&t.geometry&&t.geometry.isBufferGeometry))return;const n=(new D).copy(t.matrixWorld).premultiply(e);try{const e=t.geometry.clone();e.applyMatrix4(n),t.geometry=e}catch{}}),null==(a=d.traverse)||a.call(d,e=>{var t,n;try{e.position&&"function"==typeof e.position.set&&e.position.set(0,0,0),e.rotation&&"function"==typeof e.rotation.set&&e.rotation.set(0,0,0,"XYZ"),e.scale&&"function"==typeof e.scale.set&&e.scale.set(1,1,1),null==(t=e.updateMatrix)||t.call(e),null==(n=e.updateMatrixWorld)||n.call(e,!1)}catch{}})}catch{}try{null==(o=d.position)||o.set(0,0,0),null==(l=d.rotation)||l.set(0,0,0,"XYZ"),null==(c=d.scale)||c.set(1,1,1)}catch{}}else try{d.position&&"function"==typeof d.position.set&&d.position.set(0,0,0),d.rotation&&"function"==typeof d.rotation.set&&d.rotation.set(0,0,0,"XYZ"),d.scale&&"function"==typeof d.scale.set&&d.scale.set(1,1,1)}catch(h){}this.exporter.parse(d,e=>{t(e)},e=>{r(e)},{binary:!0,includeCustomExtensions:!0,embedImages:!0,maxTextureSize:1024,forcePowerOfTwoTextures:!1,truncateDrawRange:!1})}else r(new Error("객체 복제에 실패했습니다."))})}async addCustomMesh(e,t,n={}){const{preserveTransform:r=!0,compressToSingleMesh:s=!0}=n;try{let n=e;if(s&&!pn()){const t=this._buildSingleMesh(e,{preserveTransform:r});t&&(n=t)}if(!this._hasRenderableMesh(n))throw new Error("NO_MESH_FOUND");const i=await this.exportObjectToGLB(n,{preserveTransform:r});let a=null;if(pn())try{const t=(null==e?void 0:e.toJSON)?e.toJSON():(new O).toJSON(),{bitmap:n}=await async function(e,t=128){return await mn("thumbnailFromObjectJSON",{objectJSON:e,size:t})}(t,128);a=await bn(n)}catch{}a||(a=this.generateThumbnailFromObject(e));const o=Date.now(),l={id:`custom_${o}`,name:t||"커스텀 메쉬",fileName:`custom_${o}.glb`,thumbnail:a,type:"custom",glbData:i,createdAt:o,transform:e&&e.position&&e.rotation&&e.scale?{position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},scale:{x:e.scale.x,y:e.scale.y,z:e.scale.z}}:void 0};return await this.saveCustomMesh(l),l}catch(i){throw new Error("ADD_CUSTOM_MESH_FAILED")}}async saveCustomMesh(e){try{await Bt(e)}catch(t){throw new Error("IDB_SAVE_FAILED")}}async getCustomMeshes(){const e=await Gt();return await Promise.all(e.map(async e=>{const t={...e};if(t.type||(t.type="custom"),e&&e.thumbnail&&"object"==typeof e.thumbnail&&"size"in e.thumbnail)try{const n=this._thumbDataUrlCache.get(e.id);n?t.thumbnail=n:(t.thumbnail=await new Promise((t,n)=>{try{const r=new FileReader;r.onload=()=>t("string"==typeof r.result?r.result:""),r.onerror=()=>n(r.error||new Error("FileReader error")),r.readAsDataURL(e.thumbnail)}catch(r){n(r)}}),this._thumbDataUrlCache.set(e.id,t.thumbnail))}catch{}return t}))}async getCustomMeshById(e){try{const{idbGetCustomMesh:t}=await Ee(async()=>{const{idbGetCustomMesh:e}=await Promise.resolve().then(()=>Vt);return{idbGetCustomMesh:e}},void 0),n=await t(e);if(n)return n}catch{}try{return(await this.getCustomMeshes()||[]).find(t=>t.id===e)||null}catch{return null}}async deleteCustomMesh(e){try{await Ht(e);try{const t=this._thumbUrlCache.get(e);t&&(URL.revokeObjectURL(t),this._thumbUrlCache.delete(e))}catch{}try{this._thumbDataUrlCache.delete(e)}catch{}}catch(t){throw new Error("IDB_DELETE_FAILED")}return await Gt()}createBlobURL(e){try{let t;if(e instanceof ArrayBuffer)t=e;else if(e instanceof Uint8Array)t=e.buffer;else if("object"==typeof e&&"Buffer"===e.type)t=new Uint8Array(e.data||e).buffer;else{if(!Array.isArray(e))throw new Error("GLB 데이터를 처리할 수 없습니다.");t=new Uint8Array(e).buffer}const n=new Blob([t],{type:"model/gltf-binary"});return URL.createObjectURL(n)}catch(t){throw t}}async loadGLBModel(e){return new Promise((t,n)=>{this.loader.load(e,e=>{t(e.scene)},e=>{},e=>{n(e)})})}dispose(){this.thumbnailRenderer&&(this.thumbnailRenderer.renderer.dispose(),this.thumbnailRenderer.scene.clear(),this.thumbnailRenderer=null)}}let yn=null;const vn=()=>(yn||(yn=new fn),yn),xn=Object.freeze(Object.defineProperty({__proto__:null,GLBMeshManager:fn,disposeGLBMeshManager:()=>{yn&&(yn.dispose(),yn=null)},getGLBMeshManager:vn},Symbol.toStringTag,{value:"Module"}));function wn({onEditorControlsReady:e,onPostProcessingReady:t,onContextMenu:s}){const i=n.useRef(null),a=n.useRef(null),o=n.useRef(null),l=n.useRef(null),c=n.useRef(null),[m,g]=n.useState(!1),x=n.useRef(new Map),j=n.useRef(new Set),S=n.useRef({lastT:0,frames:0,fps:0,lastPush:0,vert:0,tri:0,obj:0}),M=n.useRef(!1),O=n.useRef(null),C=n.useRef({animId:null,t:0,target:0,start:0,startTime:0,duration:220,easing:"easeInOutQuad",maxOpacity:.6}),{objects:D,walls:N,setScene:A,setSelectedObject:k}=$t(),L=n.useRef($t.getState().isPostProcessingEnabled);return n.useEffect(()=>{const e=$t.subscribe((e,t)=>{e.isPostProcessingEnabled!==t.isPostProcessingEnabled&&(L.current=e.isPostProcessingEnabled)});return()=>{try{null==e||e()}catch{}}},[]),n.useEffect(()=>{var n,r,m,v,j,D,N,R;if(!i.current)return;const I=new te,T=new te;I.background=new P(2763306);const F=new b(75,window.innerWidth/window.innerHeight,.1,1e3);F.position.set(15,20,15),F.lookAt(0,0,0);const G=(()=>{try{return $t.getState().rendererAA||"msaa"}catch{return"msaa"}})(),B=new ee({antialias:"msaa"===G,powerPreference:"high-performance"});try{const e=$t.getState(),t=(null==(n=e.safeMode)?void 0:n.enabled)?e.safeMode.pixelRatio||1:Math.min(2,window.devicePixelRatio||1);B.setPixelRatio(t)}catch{B.setPixelRatio(Math.min(2,window.devicePixelRatio||1))}B.setSize(window.innerWidth,window.innerHeight),B.shadowMap.enabled=!0,B.shadowMap.type=ie,B.sortObjects=!1,B.autoClear=!1,i.current.appendChild(B.domElement);try{Ae(B)}catch{}const H=e=>{e.preventDefault()},U=()=>{try{B.setSize(window.innerWidth,window.innerHeight),l.current&&(l.current.initializeComposer(),l.current.handleResize(window.innerWidth,window.innerHeight))}catch{}};B.domElement.addEventListener("webglcontextlost",H,!1),B.domElement.addEventListener("webglcontextrestored",U,!1);const V=e=>{s&&s(e)};B.domElement.addEventListener("contextmenu",V),c.current=I,A(I,F,B);const q=new on(I,F,B,$t,e=>{var t,n,r,s;A(I,e,B);try{null==(n=null==(t=l.current)?void 0:t.setCamera)||n.call(t,e)}catch{}try{null==(s=null==(r=o.current)?void 0:r.setCamera)||s.call(r,e)}catch{}});q.gizmoScene=T,a.current=q;try{window.__editorControls=q}catch{}window.runSmokeTest=()=>function(e,t){var n,r;try{if(!e||!t)return!1;const i=t.getState();try{null==(n=e.applyInitialViewState)||n.call(e)}catch(s){return null==s||s.message,!1}i.isWireframe,t.getState().toggleWireframe();try{null==(r=e.updateWireframe)||r.call(e)}catch{}t.getState().isWireframe;const a=new d,o=new u(1,1,1),l=new h(o,a);try{e.scene.add(l),l.material.wireframe}catch(s){return null==s||s.message,!1}finally{try{e.scene.remove(l),o.dispose(),a.dispose()}catch{}}return!0}catch(s){return null==s||s.message,!1}}(q,$t);try{null==(r=q.applyInitialViewState)||r.call(q)}catch{}try{if(!!$t.getState().useBlenderControls){const e=new ln(q.camera,B.domElement);e.setScene(I);const t=$t.getState();e.setSpeeds({rotate:.01*t.cameraOrbitSpeed,pan:.02*t.cameraPanSpeed,zoom:t.cameraZoomSpeed}),o.current=e;try{window.__blenderControls=e}catch{}try{const t=$t.subscribe((t,n)=>{t.cameraPanSpeed===n.cameraPanSpeed&&t.cameraOrbitSpeed===n.cameraOrbitSpeed&&t.cameraZoomSpeed===n.cameraZoomSpeed||e.setSpeeds({rotate:.01*t.cameraOrbitSpeed,pan:.02*t.cameraPanSpeed,zoom:t.cameraZoomSpeed})}),n=null==(m=q.dispose)?void 0:m.bind(q);q.dispose=()=>{try{null==t||t()}catch{}null==n||n()}}catch{}}}catch{}const W=new cn(I,F,B);l.current=W;try{g(!0)}catch{}try{W.setCamera(F)}catch{}try{const e=null==loadEnvironmentSettings?void 0:loadEnvironmentSettings();e&&(e.toneMapping&&(W.updateEffectSettings("toneMapping",{...e.toneMapping}),W.setEffectEnabled("toneMapping",!1!==e.toneMapping.enabled)),(null==(v=e.postProcessing)?void 0:v.preset)&&(null==(j=W.applyPreset)||j.call(W,e.postProcessing.preset)))}catch{}try{q.setPostProcessingManager(W)}catch{}try{$t.getState().setPostProcessingManager(W)}catch{}try{const e=$t.getState(),t="fxaa"===e.rendererAA&&!(null==(D=e.safeMode)?void 0:D.enabled);W.setEffectEnabled("fxaa",!!t)}catch{}try{$t.getState().estimateVRAMUsage()}catch{}e&&e(q),t&&t(W),null==(R=(N=q.objectSelector).setGizmoScene)||R.call(N,T);const K=new ne(4210752,.6);K.userData.isSystemObject=!0,I.add(K);const $=new re(16777215,.8);$.position.set(50,50,50),$.castShadow=!0,$.shadow.mapSize.width=1024,$.shadow.mapSize.height=1024,$.userData.isSystemObject=!0,I.add($);const Z=new ae(16755336,1,100);Z.position.set(0,6,6),Z.userData.isSystemObject=!0,I.add(Z);const X=new u(2,2,2),Y=new d({color:16711680}),Q=new h(X,Y);Q.position.set(0,1,0),Q.castShadow=!0,Q.userData.name="Test Cube",Q.userData.id="test_cube",I.add(Q);const J=new oe(.5,.5,3),se=new d({color:9127187}),ve=new h(J,se);ve.position.set(5,1.5,0),ve.castShadow=!0,ve.userData.name="Tree Trunk",ve.userData.id="tree_trunk",I.add(ve);const xe=new le(2),we=new d({color:2263842}),je=new h(xe,we);je.position.set(5,4,0),je.castShadow=!0,je.userData.name="Tree Leaves",je.userData.id="tree_leaves",I.add(je),x.current.set("test_cube",Q),x.current.set("tree_trunk",ve),x.current.set("tree_leaves",je),q.addSelectableObject(Q),q.addSelectableObject(ve),q.addSelectableObject(je);let Se=!0;const Me=()=>{Se=!0};try{window.__requestRender=Me}catch{}const Oe=()=>{var e,t,n,r,s,i,c,d;const u=(()=>{try{return $t.getState().renderMode||"continuous"}catch{return"continuous"}})();requestAnimationFrame(Oe),Q.rotation.y+=.005;const h=(()=>{var e,t;try{return null==(t=null==(e=o.current)?void 0:e.update)?void 0:t.call(e)}catch{return!1}})();if(h&&(Se=!0),O.current){const e=O.current,t=C.current;if(t&&t.duration>0&&(t.t<1||e.material.opacity!==t.target)){const n=performance.now(),r=Math.min(1,(n-t.startTime)/t.duration);let s;switch(t.easing){case"linear":s=r;break;case"easeOutCubic":s=1-Math.pow(1-r,3);break;case"easeInCubic":s=Math.pow(r,3);break;default:s=r<.5?2*r*r:(4-2*r)*r-1}const i=t.start+(t.target-t.start)*s;e.material&&(e.material.opacity=Math.max(0,Math.min(1,i))),t.t=r,r>=1&&0===t.target&&e.visible&&(e.visible=!1)}}if("on-demand"===u&&!Se&&!h)return;if(a.current&&("on-demand"!==u||Se)){try{a.current.updateSelectedOutlines()}catch{}try{((null==(t=(e=a.current).getSelectedObjects)?void 0:t.call(e))||[]).forEach(e=>{var t,n,r,s,i,a,o;if((null==e?void 0:e.isLight)&&(null==(n=null==(t=e.userData)?void 0:t.lightHelper)?void 0:n.update))e.userData.lightHelper.update();else if((null==(r=null==e?void 0:e.userData)?void 0:r.isLightTarget)||(null==(s=null==e?void 0:e.userData)?void 0:s.ownerId)){const t=e.userData.ownerId;let n=null;t&&(null==(i=x.current)?void 0:i.has(t))&&(n=x.current.get(t)),(null==(o=null==(a=null==n?void 0:n.userData)?void 0:a.lightHelper)?void 0:o.update)&&n.userData.lightHelper.update()}})}catch{}}try{const e=performance.now(),t=S.current;t.lastT||(t.lastT=e),t.frames+=1;const n=e-t.lastT;if(n>=500&&(t.fps=Math.round(1e3*t.frames/n),t.frames=0,t.lastT=e),(!t.lastPush||e-t.lastPush>=2e3)&&!M.current){t.lastPush=e,M.current=!0;(e=>{const t="undefined"!=typeof window&&window.requestIdleCallback;t?t(()=>e()):setTimeout(e,0)})(()=>{let e=0,n=0,r=0;try{I.traverse(t=>{var s,i,a;if(!t.visible)return;if((null==(s=t.userData)?void 0:s.isSystemObject)||(null==(i=t.userData)?void 0:i.isSelectionOutline))return;const o=(t.name||"").toLowerCase();if(!(o.includes("transformcontrols")||o.includes("gizmo")||o.includes("helper"))&&(t.isGroup&&(e+=1),t.isMesh&&t.geometry)){e+=1;const s=t.geometry,i=null==(a=s.attributes)?void 0:a.position,o=s.index,l=i?i.count:0,c=o?Math.floor(o.count/3):i?Math.floor(i.count/3):0;n+=l,r+=c}}),t.obj=e,t.vert=n,t.tri=r;try{$t.getState().setStats({fps:t.fps,objects:e,vertices:n,triangles:r})}catch{}}finally{M.current=!1}})}}catch{}Se=!1,B.clear();const p=a.current?a.current.camera:F;if(L.current&&!!l.current){try{l.current.setCamera(p)}catch{}l.current.render()}else B.render(I,p);try{null==(s=null==(r=null==(n=a.current)?void 0:n.objectSelector)?void 0:r.forceHideGizmoLines)||s.call(r)}catch{}B.clearDepth(),B.render(T,p);try{null==(d=null==(c=null==(i=a.current)?void 0:i.objectSelector)?void 0:c.forceHideGizmoLines)||d.call(c)}catch{}};Oe();const _e=B.domElement,Ce=(e,t=220)=>{var n,r,s,i,a;const o=O.current;if(!o)return;const l=C.current;l.start=null!=(r=null==(n=o.material)?void 0:n.opacity)?r:0;const{dropIndicator:c}=$t.getState();l.target=Math.min(e,null!=(s=null==c?void 0:c.maxOpacity)?s:.6),l.t=0,l.duration=t,l.easing=null!=(i=null==c?void 0:c.easing)?i:"easeInOutQuad",l.maxOpacity=null!=(a=null==c?void 0:c.maxOpacity)?a:.6,l.startTime=performance.now(),e>0&&(o.visible=!0)};_e.addEventListener("dragover",e=>{var t,n,r,s;e.preventDefault();try{const i=_e.getBoundingClientRect(),o=new y;o.x=(e.clientX-i.left)/i.width*2-1,o.y=-(e.clientY-i.top)/i.height*2+1;const l=new f,c=a.current?a.current.camera:F;l.setFromCamera(o,c);const d=[];I.traverse(e=>{e.isMesh&&e.visible&&d.push(e)});const u=l.intersectObjects(d,!0);if(u&&u.length>0){const e=u[0],r=e.point,s=e.face&&e.face.normal?e.face.normal.clone():new p(0,1,0);if(e.object&&e.object.isMesh&&e.object.normalMatrix&&s.applyMatrix3(e.object.normalMatrix).normalize(),O.current){const e=O.current;e.position.copy(r);const t=new p(0,1,0),n=(new w).setFromUnitVectors(t,s.clone().normalize());e.quaternion.copy(n),e.visible=!0}else{const e=new ce(.6,.75,48),t=new _({color:43775,transparent:!0,opacity:0,side:de}),n=new h(e,t);n.position.copy(r);const i=new p(0,1,0),a=(new w).setFromUnitVectors(i,s.clone().normalize());n.quaternion.copy(a),n.userData.isSystemObject=!0,I.add(n),O.current=n}const i=c.position.distanceTo(r),a=Math.max(.5,Math.min(4,.06*i));O.current.scale.setScalar(a);const o=$t.getState().dropIndicator;Ce(null!=(t=null==o?void 0:o.maxOpacity)?t:.6,null!=(n=null==o?void 0:o.inMs)?n:200)}else{const e=new z(new p(0,1,0),0),t=new p;if(l.ray.intersectPlane(e,t)){if(O.current)O.current.position.copy(t),O.current.rotation.set(-Math.PI/2,0,0),O.current.visible=!0;else{const e=new ce(.6,.75,48),n=new _({color:43775,transparent:!0,opacity:0,side:de}),r=new h(e,n);r.rotation.x=-Math.PI/2,r.position.copy(t),r.userData.isSystemObject=!0,I.add(r),O.current=r}const e=c.position.distanceTo(t),n=Math.max(.5,Math.min(4,.06*e));O.current.scale.setScalar(n);const i=$t.getState().dropIndicator;Ce(null!=(r=null==i?void 0:i.maxOpacity)?r:.6,null!=(s=null==i?void 0:i.inMs)?s:200)}}}catch{}}),_e.addEventListener("drop",e=>{var t,n,r;if(e.preventDefault(),O.current){const e=$t.getState().dropIndicator;Ce(0,null!=(t=null==e?void 0:e.outMs)?t:180)}try{const t=e.dataTransfer.getData("text/plain");if(t){const i=JSON.parse(t);if("start_position"===i.type||"directional_light"===i.type||"point_light"===i.type||"spot_light"===i.type||"ambient_light"===i.type||"audio_source"===i.type||"fog"===i.type||"skybox"===i.type||"post_process"===i.type||"camera_helper"===i.type||"grid_helper"===i.type||"axes_helper"===i.type){const t=_e.getBoundingClientRect(),s=new y;s.x=(e.clientX-t.left)/t.width*2-1,s.y=-(e.clientY-t.top)/t.height*2+1;const a=new f;a.setFromCamera(s,F);const o=new z(new p(0,1,0),0),l=new p;let c;switch(a.ray.intersectPlane(o,l),i.type){case"start_position":c=null;break;case"directional_light":const e=new re(16777215,1);e.position.set(l.x+5,l.y+10,l.z+5),e.target.position.copy(l),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048;const t=new ge(e,1);e.userData=e.userData||{},e.userData.lightHelper=t,I.add(t);try{t.update()}catch{}try{const t=new le(.18,12,12),n=new _({color:6750156,transparent:!0,opacity:.95}),r=new h(t,n);r.name="DirectionalTargetHandle",r.userData.isSystemObject=!0,r.userData.isLightTargetHandle=!0,r.raycast=h.prototype.raycast,e.target.userData=e.target.userData||{},e.target.userData.isLightTarget=!0,e.target.add(r)}catch{}try{const t=new le(.25,12,12),n=new _({color:16777062,transparent:!0,opacity:.9}),r=new h(t,n);r.name="DirectionalLightHandle",r.userData.isSystemObject=!0,r.userData.isLightHelper=!0,r.raycast=h.prototype.raycast,e.add(r)}catch{}c=e,I.add(e.target);try{q.addSelectableObject(e.target)}catch{}break;case"point_light":const n=new ae(16777215,1,10,2);n.position.set(l.x,l.y+3,l.z),n.castShadow=!0;const r=new me(n,.5);n.userData=n.userData||{},n.userData.lightHelper=r,I.add(r);try{r.update()}catch{}try{const e=new le(.2,12,12),t=new _({color:16777062,transparent:!0,opacity:.95}),r=new h(e,t);r.name="PointLightHandle",r.userData.isSystemObject=!0,r.userData.isLightHelper=!0,r.raycast=h.prototype.raycast,n.add(r)}catch{}c=n;break;case"spot_light":const s=new he(16777215,1,10,Math.PI/6,.1,2);s.position.set(l.x,l.y+5,l.z),s.target.position.copy(l),s.castShadow=!0;const i=new pe(s);s.userData=s.userData||{},s.userData.lightHelper=i,I.add(i);try{i.update()}catch{}try{const e=new le(.22,12,12),t=new _({color:16777062,transparent:!0,opacity:.9}),n=new h(e,t);n.name="SpotLightHandle",n.userData.isSystemObject=!0,n.userData.isLightHelper=!0,n.raycast=h.prototype.raycast,s.add(n)}catch{}c=s,I.add(s.target);try{const e=new le(.18,12,12),t=new _({color:6750156,transparent:!0,opacity:.95}),n=new h(e,t);n.name="SpotTargetHandle",n.userData.isSystemObject=!0,n.userData.isLightTargetHandle=!0,n.raycast=h.prototype.raycast,s.target.userData=s.target.userData||{},s.target.userData.isLightTarget=!0,s.target.add(n)}catch{}try{q.addSelectableObject(s.target)}catch{}break;case"ambient_light":const a=new ne(4210752,.3),o=new le(.5,16,16),p=new _({color:4210752,wireframe:!0,transparent:!0,opacity:.5});c=new h(o,p),c.position.copy(l),I.add(a);break;case"audio_source":const m=new le(.3,16,16),g=new d({color:16750848});c=new h(m,g),c.position.set(l.x,l.y+1,l.z);break;case"grid_helper":c=new E(10,10),c.position.copy(l);break;case"axes_helper":c=new ue(2),c.position.copy(l);try{const e=new le(.2,12,12),t=new _({color:6737151,transparent:!0,opacity:.9}),n=new h(e,t);n.name="AxesHelperHandle",n.userData.isSystemObject=!0,n.userData.isHelperHandle=!0,n.raycast=h.prototype.raycast,c.add(n)}catch{}break;default:const b=new u(.5,.5,.5),f=new d({color:8947848});c=new h(b,f),c.position.copy(l)}if(c){c.isMesh&&(c.castShadow=!0,c.receiveShadow=!0);const e=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;c.name=e,c.userData=Object.assign(c.userData||{},{id:e,name:i.name,type:i.type,originalData:i}),I.add(c),q.addSelectableObject(c),x.current.set(e,c);const t=$t.getState().addObject,s=["directional_light","point_light","spot_light"].includes(i.type),a="directional_light"===i.type?"directional":"point_light"===i.type?"point":"spot_light"===i.type?"spot":void 0;t({id:e,name:i.name,type:s?"light":i.type,lightType:s?a:void 0,position:{x:c.position.x,y:c.position.y,z:c.position.z},rotation:{x:c.rotation.x,y:c.rotation.y,z:c.rotation.z},scale:{x:c.scale.x,y:c.scale.y,z:c.scale.z},visible:!0,userData:c.userData});try{if(c.isLight&&c.target&&c.target.isObject3D){c.target.userData=c.target.userData||{},c.target.userData.ownerId=e;const t=null==(r=null==(n=c.target.children)?void 0:n.find)?void 0:r.call(n,e=>{var t;return null==(t=e.userData)?void 0:t.isLightTargetHandle});t&&(t.userData.ownerId=e)}}catch{}k(e)}return}if("custom"===i.type||"library"===i.type){let t=function(){c.load(d,e=>{const t=e.scene;t.position.copy(l),t.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)});const n=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;t.name=n,t.userData={id:n,name:i.name,type:i.type,originalData:i,..."custom"===i.type?{customMeshId:i.id}:{}};try{t.traverse(e=>{e.userData=e.userData||{},e.userData.ownerId||(e.userData.ownerId=n)})}catch{}I.add(t),q.addSelectableObject(t),x.current.set(n,t);(0,$t.getState().addObject)({id:n,name:i.name,type:"glb",..."custom"===i.type?{customMeshId:i.id}:{url:i.glbUrl},position:{x:l.x,y:l.y,z:l.z},rotation:{x:t.rotation.x,y:t.rotation.y,z:t.rotation.z},scale:{x:1,y:1,z:1},visible:!0,userData:t.userData}),k(n),"custom"===i.type&&URL.revokeObjectURL(d)},void 0,e=>{"custom"===i.type&&URL.revokeObjectURL(d)})};const n=_e.getBoundingClientRect(),r=new y;r.x=(e.clientX-n.left)/n.width*2-1,r.y=-(e.clientY-n.top)/n.height*2+1;const a=new f;a.setFromCamera(r,F);const o=new z(new p(0,1,0),0),l=new p;a.ray.intersectPlane(o,l);const c=ke();let d,u=null;if("custom"===i.type)try{const e=vn(),n=n=>{u=n,d=e.createBlobURL(u),t()},r=e=>{};return!i.glbData&&i.id?void e.getCustomMeshes().then(e=>{const t=e.find(e=>e.id===i.id);if(!t)throw new Error("NOT_FOUND");n(t.glbData)}).catch(r):void n(i.glbData)}catch(s){return}else if("library"===i.type)return d=i.glbUrl,void t();return}const a=_e.getBoundingClientRect(),o=new y;o.x=(e.clientX-a.left)/a.width*2-1,o.y=-(e.clientY-a.top)/a.height*2+1;const l=new f;l.setFromCamera(o,F);const c=new z(new p(0,1,0),0),m=new p;l.ray.intersectPlane(c,m);const g=new d({color:5025616,roughness:.3,metalness:.1});let b,v;switch(i.geometry){case"BoxGeometry":b=new u(...i.params);break;case"SphereGeometry":b=new le(...i.params);break;case"CylinderGeometry":b=new oe(...i.params);break;case"ConeGeometry":b=new ye(...i.params);break;case"PlaneGeometry":b=new fe(...i.params);break;case"TorusGeometry":b=new be(...i.params);break;case"CustomGeometry":if(i.glbData)try{const e=vn().createBlobURL(i.glbData);return void ke().load(e,t=>{const n=t.scene;n.position.copy(m);const r=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;n.name=r,n.userData={id:r,name:i.name,type:i.type||"custom",originalName:i.name},n.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),I.add(n),q.addSelectableObject(n),x.current.set(r,n);(0,$t.getState().addObject)({id:r,name:i.name,type:"mesh",position:{x:m.x,y:m.y,z:m.z},rotation:{x:n.rotation.x,y:n.rotation.y,z:n.rotation.z},scale:{x:1,y:1,z:1},visible:!0,userData:n.userData}),k(r),URL.revokeObjectURL(e)},void 0,t=>{URL.revokeObjectURL(e)})}catch(s){return}else b=i.originalObject&&i.originalObject.geometry?i.originalObject.geometry.clone():new u(1,1,1);break;case"LibraryMesh":if(i.glbUrl){return void ke().load(i.glbUrl,e=>{const t=e.scene;t.position.copy(m);const n=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;t.name=n,t.userData={id:n,name:i.name,type:i.type||"library",originalName:i.name},t.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),I.add(t),q.addSelectableObject(t),x.current.set(n,t);(0,$t.getState().addObject)({id:n,name:i.name,type:"mesh",position:{x:m.x,y:m.y,z:m.z},rotation:{x:t.rotation.x,y:t.rotation.y,z:t.rotation.z},scale:{x:1,y:1,z:1},visible:!0,userData:t.userData}),k(n)},void 0,e=>{})}b=new u(1,1,1);break;default:b=new u(1,1,1)}v=new h(b,g),v.position.copy(m),"PlaneGeometry"===i.geometry&&(v.rotation.x=-Math.PI/2),v.castShadow=!0,v.receiveShadow=!0;const w=`${i.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;v.name=w,v.userData={id:w,name:i.name,type:i.type||"basic",originalName:i.name,geometry:i.geometry,params:i.params,ownerId:w},I.add(v),q.addSelectableObject(v),x.current.set(w,v);(0,$t.getState().addObject)({id:w,name:i.name,type:"basic",geometry:i.geometry,params:i.params,position:{x:m.x,y:m.y,z:m.z},rotation:{x:v.rotation.x,y:v.rotation.y,z:v.rotation.z},scale:{x:1,y:1,z:1},visible:!0,userData:v.userData}),k(w)}}catch(s){}}),_e.addEventListener("dragleave",()=>{var e;if(O.current){const t=$t.getState().dropIndicator;Ce(0,null!=(e=null==t?void 0:t.outMs)?e:220)}});const De=["mousedown","mouseup","mousemove","wheel","keydown","keyup","resize"],Ee=()=>{var e;try{"on-demand"===($t.getState().renderMode||"continuous")&&(null==(e=window.__requestRender)||e.call(window))}catch{}};De.forEach(e=>window.addEventListener(e,Ee,{passive:!0})),_e.addEventListener("dragover",Ee,{passive:!0}),_e.addEventListener("drop",Ee,{passive:!0});const Pe=()=>{var e;try{const t=$t.getState(),n=(null==(e=t.safeMode)?void 0:e.enabled)?t.safeMode.pixelRatio||1:Math.min(2,window.devicePixelRatio||1);B.setPixelRatio(n)}catch{}a.current?a.current.onWindowResize():(F.aspect=window.innerWidth/window.innerHeight,F.updateProjectionMatrix(),B.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),B.setSize(window.innerWidth,window.innerHeight)),l.current&&l.current.handleResize(window.innerWidth,window.innerHeight);try{$t.getState().estimateVRAMUsage()}catch{}};return window.addEventListener("resize",Pe),()=>{try{De.forEach(e=>window.removeEventListener(e,Ee))}catch{}try{_e.removeEventListener("dragover",Ee),_e.removeEventListener("drop",Ee)}catch{}if(window.removeEventListener("resize",Pe),B.domElement&&(B.domElement.removeEventListener("contextmenu",V),B.domElement.removeEventListener("webglcontextlost",H),B.domElement.removeEventListener("webglcontextrestored",U)),a.current&&a.current.dispose(),o.current)try{o.current.dispose()}catch{}l.current&&l.current.dispose(),i.current&&B.domElement&&i.current.removeChild(B.domElement),B.dispose()}},[A]),n.useEffect(()=>{var e;if(!m)return;if(!c.current||!a.current)return;const t=c.current,n=ke();D.forEach(e=>{var r,s,i,o,l,c,m,g,b,f,y,w,S,M,O,C,D,P,z,N,A,L,R,I,T,F,G,B,H;if(!x.current.has(e.id))if("glb"===e.type&&(e.file||e.url)){if(j.current.has(e.id)||x.current.has(e.id))return;j.current.add(e.id);const r=e.file||e.url,s="string"==typeof r&&r.startsWith("blob:");n.load(r,n=>{var i,o,l,c,d,u,h,m,g,b,f,y;if(x.current.has(e.id)){try{j.current.delete(e.id)}catch{}return}const w=n.scene,S=(new v).setFromObject(w);S.getSize(new p),S.getCenter(new p),w.position.set(e.position.x,e.position.y,e.position.z),w.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),w.scale.set(e.scale.x,e.scale.y,e.scale.z),w.name=e.name,w.userData={...w.userData||{},id:e.id,type:e.type,customMeshId:e.customMeshId||(null==(i=e.userData)?void 0:i.customMeshId)||(null==(l=null==(o=e.userData)?void 0:o.originalData)?void 0:l.id),originalData:(null==(c=e.userData)?void 0:c.originalData)||(e.customMeshId?{id:e.customMeshId}:void 0)};try{w.traverse(t=>{t.userData||(t.userData={}),t.userData.ownerId||(t.userData.ownerId=e.id)})}catch{}w.visible=!1!==e.visible,w.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)});try{const e=!!$t.getState().isWireframe;w.traverse(t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material.forEach(t=>t.wireframe=e):t.material.wireframe=e)})}catch{}t.add(w),a.current.addSelectableObject(w),x.current.set(e.id,w);try{j.current.delete(e.id)}catch{}if(k(e.id),s)try{URL.revokeObjectURL(r)}catch{}try{null==(u=(d=a.current).updateWireframe)||u.call(d)}catch{}try{null==(m=(h=a.current).updateGridSnap)||m.call(h)}catch{}try{null==(b=(g=a.current).updateGizmoSpace)||b.call(g)}catch{}try{null==(y=null==(f=a.current.objectSelector)?void 0:f.updateGizmoSize)||y.call(f)}catch{}a.current.selectObject(w)},void 0,n=>{if(s)try{URL.revokeObjectURL(r)}catch{}const i=new u(1,1,1),o=new ve({color:16739179,transparent:!0,opacity:.7}),l=new h(i,o);l.position.set(e.position.x,e.position.y,e.position.z),l.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),l.scale.set(e.scale.x,e.scale.y,e.scale.z),l.name=`${e.name} (로딩실패)`,l.userData={id:e.id,type:e.type,loadError:!0},l.castShadow=!0,l.receiveShadow=!0,l.visible=!1!==e.visible,t.add(l),a.current.addSelectableObject(l),x.current.set(e.id,l);try{j.current.delete(e.id)}catch{}k(e.id),a.current.selectObject(l)})}else if("glb"===e.type&&(e.customMeshId||(null==(r=e.userData)?void 0:r.customMeshId)||(null==(i=null==(s=e.userData)?void 0:s.originalData)?void 0:i.id)||e.glbData)){const r=vn();if(j.current.has(e.id)||x.current.has(e.id))return;j.current.add(e.id);const s=e.customMeshId||(null==(o=e.userData)?void 0:o.customMeshId)||(null==(c=null==(l=e.userData)?void 0:l.originalData)?void 0:c.id),i=(null==(g=null==(m=e.userData)?void 0:m.originalData)?void 0:g.glbUrl)||(null==(b=e.userData)?void 0:b.glbUrl)||e.glbUrl||null,d=e=>!!e&&(e instanceof ArrayBuffer||(e instanceof Uint8Array||(!!Array.isArray(e)||!("object"!=typeof e||"Buffer"!==e.type||!Array.isArray(e.data))))),f=r=>{n.load(r,n=>{var s,i,o,l;if(x.current.has(e.id)){try{URL.revokeObjectURL(r)}catch{}try{j.current.delete(e.id)}catch{}return}const c=n.scene,d=(new v).setFromObject(c);d.getSize(new p),d.getCenter(new p),c.position.set(e.position.x,e.position.y,e.position.z),c.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),c.scale.set(e.scale.x,e.scale.y,e.scale.z),c.name=e.name,c.userData={...c.userData||{},id:e.id,type:e.type,customMeshId:e.customMeshId||(null==(s=e.userData)?void 0:s.customMeshId)||(null==(o=null==(i=e.userData)?void 0:i.originalData)?void 0:o.id),originalData:(null==(l=e.userData)?void 0:l.originalData)||(e.customMeshId?{id:e.customMeshId}:void 0)};try{c.traverse(t=>{t.userData||(t.userData={}),t.userData.ownerId||(t.userData.ownerId=e.id)})}catch{}c.visible=!1!==e.visible,c.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)}),t.add(c),a.current.addSelectableObject(c),x.current.set(e.id,c),k(e.id),a.current.selectObject(c);try{URL.revokeObjectURL(r)}catch{}try{j.current.delete(e.id)}catch{}},void 0,()=>{try{URL.revokeObjectURL(r)}catch{}try{j.current.delete(e.id)}catch{}})};if(!e.glbData&&i)try{f(i)}catch(U){try{j.current.delete(e.id)}catch{}}else if(s)(async()=>{try{const{idbGetCustomMesh:e}=await Ee(async()=>{const{idbGetCustomMesh:e}=await Promise.resolve().then(()=>Vt);return{idbGetCustomMesh:e}},void 0),t=await e(s);if(!t)throw new Error("CUSTOM_MESH_NOT_FOUND");let n=t.glbData;if(n&&"object"==typeof n&&"size"in n){const e=URL.createObjectURL(n);f(e)}else{if(!n)throw new Error("CUSTOM_MESH_NOT_FOUND");{const e=r.createBlobURL(n);f(e)}}}catch(U){try{const e=(await r.getCustomMeshes()||[]).find(e=>e.id===s);if(!(null==e?void 0:e.glbData))throw new Error("CUSTOM_MESH_NOT_FOUND");{const t=r.createBlobURL(e.glbData);f(t)}}catch(n){try{const n=new u(1,1,1),r=new ve({color:16739179,transparent:!0,opacity:.7}),i=new h(n,r);i.position.set(e.position.x,e.position.y,e.position.z),i.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),i.scale.set(e.scale.x,e.scale.y,e.scale.z),i.name=`${e.name||s} (누락)`,i.userData={id:e.id,type:e.type,customMeshId:s,loadError:!0,missingCustomMesh:!0},i.castShadow=!0,i.receiveShadow=!0,i.visible=!1!==e.visible,t.add(i),a.current.addSelectableObject(i),x.current.set(e.id,i),k(e.id),a.current.selectObject(i);try{window.dispatchEvent(new CustomEvent("mapLoadWarning",{detail:{type:"customMeshMissing",id:s,objectId:e.id,objectName:e.name||""}}))}catch{}}catch{}try{j.current.delete(e.id)}catch{}}}})();else if(e.glbData&&d(e.glbData))try{const t=r.createBlobURL(e.glbData);f(t)}catch(U){try{j.current.delete(e.id)}catch{}}else try{j.current.delete(e.id)}catch{}}else if("light"===e.type||["directional_light","point_light","spot_light","ambient_light","grid_helper","axes_helper","audio_source"].includes(e.type)){let n=null;switch("light"===e.type?e.lightType:"directional_light"===e.type?"directional":"point_light"===e.type?"point":"spot_light"===e.type?"spot":e.type){case"directional":{const r=new re(16777215,null!=(f=e.intensity)?f:1);r.position.set(e.position.x,e.position.y,e.position.z);const s=(null!=(w=null==(y=e.position)?void 0:y.y)?w:0)-1;r.target.position.set(e.position.x,s,e.position.z),r.castShadow=!!e.castShadow,t.add(r.target);try{r.target.userData={...r.target.userData||{},isLightTarget:!0,ownerId:e.id}}catch{}n=r;try{a.current.addSelectableObject(r.target)}catch{}try{const e=new ge(r,1);r.userData=r.userData||{},r.userData.lightHelper=e,t.add(e),null==(S=e.update)||S.call(e)}catch{}break}case"point":{const r=new ae(16777215,null!=(M=e.intensity)?M:1,null!=(O=e.distance)?O:10,null!=(C=e.decay)?C:2);r.position.set(e.position.x,e.position.y,e.position.z),r.castShadow=!!e.castShadow,n=r;try{const e=new me(r,.5);r.userData=r.userData||{},r.userData.lightHelper=e,t.add(e),null==(D=e.update)||D.call(e)}catch{}break}case"spot":{const r=new he(16777215,null!=(P=e.intensity)?P:1,null!=(z=e.distance)?z:10,null!=(N=e.angle)?N:Math.PI/6,null!=(A=e.penumbra)?A:.1,null!=(L=e.decay)?L:2);r.position.set(e.position.x,e.position.y,e.position.z);const s=(null!=(I=null==(R=e.position)?void 0:R.y)?I:0)-1;r.target.position.set(e.position.x,s,e.position.z),r.castShadow=!!e.castShadow,t.add(r.target);try{r.target.userData={...r.target.userData||{},isLightTarget:!0,ownerId:e.id}}catch{}n=r;try{a.current.addSelectableObject(r.target)}catch{}try{const e=new pe(r);r.userData=r.userData||{},r.userData.lightHelper=e,t.add(e),null==(T=e.update)||T.call(e)}catch{}break}case"ambient_light":{const r=new ne(null!=(F=e.color)?F:4210752,null!=(G=e.intensity)?G:.3);t.add(r);const s=new h(new le(.5,16,16),new _({color:4210752,wireframe:!0,transparent:!0,opacity:.5}));s.position.set(e.position.x,e.position.y,e.position.z),n=s;break}case"grid_helper":{const t=new E(10,10);t.position.set(e.position.x,e.position.y,e.position.z),n=t;break}case"axes_helper":{const t=new ue(2);t.position.set(e.position.x,e.position.y,e.position.z),n=t;break}case"audio_source":{const t=new h(new le(.3,16,16),new d({color:16750848}));t.position.set(e.position.x,e.position.y,e.position.z),n=t;break}}if(n){n.name=e.name,n.userData={...n.userData||{},id:e.id,type:e.type};try{null==(B=n.traverse)||B.call(n,t=>{t.userData=t.userData||{},t.userData.ownerId||(t.userData.ownerId=e.id)})}catch{}n.visible=!1!==e.visible,t.add(n);try{a.current.addSelectableObject(n)}catch{}x.current.set(e.id,n),k(e.id);try{a.current.selectObject(n)}catch{}}}else if("cube"===e.type){const n=new u(e.size.x,e.size.y,e.size.z),r=new ve({color:e.material.color}),s=new h(n,r);s.position.set(e.position.x,e.position.y,e.position.z),s.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),s.name=e.name,s.userData={id:e.id,type:e.type};try{null==(H=s.traverse)||H.call(s,t=>{t.userData=t.userData||{},t.userData.ownerId||(t.userData.ownerId=e.id)})}catch{}s.castShadow=!0,s.receiveShadow=!0,t.add(s),a.current.addSelectableObject(s),x.current.set(e.id,s),k(e.id),a.current.selectObject(s)}else if("basic"===e.type||e.geometry&&e.params){const n=new d({color:5025616,roughness:.3,metalness:.1});let r;switch(e.geometry){case"BoxGeometry":r=new u(...e.params);break;case"SphereGeometry":r=new le(...e.params);break;case"CylinderGeometry":r=new oe(...e.params);break;case"ConeGeometry":r=new ye(...e.params);break;case"PlaneGeometry":r=new fe(...e.params);break;case"TorusGeometry":r=new be(...e.params);break;default:r=new u(1,1,1)}const s=new h(r,n);s.position.set(e.position.x,e.position.y,e.position.z),s.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),s.scale.set(e.scale.x,e.scale.y,e.scale.z),s.name=e.name,s.userData={id:e.id,type:e.type};try{s.traverse(t=>{t.userData=t.userData||{},t.userData.ownerId||(t.userData.ownerId=e.id)})}catch{}s.castShadow=!0,s.receiveShadow=!0,s.visible=!1!==e.visible,"PlaneGeometry"===e.geometry&&(s.rotation.x=-Math.PI/2),t.add(s),a.current.addSelectableObject(s),x.current.set(e.id,s),k(e.id),a.current.selectObject(s)}});const r=new Set(D.map(e=>e.id));for(const[s,i]of x.current)if(!r.has(s)){if(null==(e=i.userData)?void 0:e.isSystemObject)continue;t.remove(i),a.current.removeSelectableObject(i),x.current.delete(s)}try{const e=[],n=e=>{var n,s;let i=e;for(;i&&i!==t;){const e=null==(n=i.userData)?void 0:n.id,t=null==(s=i.userData)?void 0:s.ownerId;if(e&&r.has(e)||t&&r.has(t))return!0;i=i.parent}return!1};t.traverse(r=>{var s,i;if(!r||r===t)return;if(null==(s=r.userData)?void 0:s.isSystemObject)return;if(null==(i=r.userData)?void 0:i.isSelectionOutline)return;const a=(r.name||"").toLowerCase();a.includes("transformcontrols")||a.includes("gizmo")||a.includes("helper")||n(r)||e.push(r)}),e.forEach(e=>{var n,r;try{null==(r=null==(n=a.current)?void 0:n.removeSelectableObject)||r.call(n,e)}catch{}try{e.parent?e.parent.remove(e):t.remove(e)}catch{}})}catch{}},[D,k,m]),n.useEffect(()=>{c.current&&(D.forEach(e=>{const t=x.current.get(e.id);t&&(t.visible=!1!==e.visible)}),N.forEach(e=>{const t=x.current.get(e.id);t&&(t.visible=!1!==e.visible)}))},[D,N]),r.jsx("div",{ref:i,style:{width:"100%",height:"100vh",position:"relative"}})}function jn(e,t,n=!0){if(!e||!e.isObject3D)return!1;if(t&&!t.isObject3D)return!1;if(e===t)return!1;if(t&&function(e,t){if(!(e&&t&&e.isObject3D&&t.isObject3D))return!1;let n=t.parent;for(;n;){if(n===e)return!0;n=n.parent}return!1}(e,t))return!1;let r=null;if(n&&(e.updateMatrixWorld(!0),r=e.matrixWorld.clone()),e.parent)try{e.parent.remove(e)}catch{}if(t)try{t.add(e)}catch{}if(n&&r){const t=e.parent&&e.parent.matrixWorld?e.parent.matrixWorld:new D,n=(new D).copy(t).invert(),s=(new D).copy(n).multiply(r),i=new p,a=new w,o=new p;s.decompose(i,a,o),e.position.copy(i),e.quaternion.copy(a),e.scale.copy(o),e.updateMatrix(),e.updateMatrixWorld(!0)}return!0}class Sn{constructor(e){this.editorControls=e,this.selectedObject=null,this.threeObject=null,this.changeCallbacks=[]}onPropertyChange(e){this.changeCallbacks.push(e)}notifyPropertyChange(e,t,n){this.changeCallbacks.forEach(r=>{r({type:e,property:t,value:n,object:this.selectedObject})})}setSelectedObject(e){if(this.selectedObject=e,this.threeObject=null,e)if(e.isObject3D||e.isMesh||e.isLight||e.isCamera)this.threeObject=e;else if(this.editorControls){const t=e.id||e;this.threeObject=this.editorControls.findObjectById(t),!this.threeObject&&this.editorControls.selectedObjects&&this.editorControls.selectedObjects.length>0&&(this.threeObject=this.editorControls.selectedObjects[0])}}getObjectType(){return this.threeObject?this.threeObject.isLight?"light":this.threeObject.isCamera?"camera":this.threeObject.isHelper?"helper":this.threeObject.isMesh?"mesh":this.threeObject.isGroup?"group":"mesh":"unknown"}setTransformProperty(e,t,n){if(!this.threeObject)return!1;const r=parseFloat(n);if(isNaN(r))return!1;switch(e){case"position":this.threeObject.position[t]=r;break;case"rotation":this.threeObject.rotation[t]=r*Math.PI/180;break;case"scale":this.threeObject.scale[t]=r}return this.notifyPropertyChange("transform",e,{[t]:r}),!0}getTransformProperty(e,t){return this.threeObject?"rotation"===e?(180*this.threeObject[e][t]/Math.PI).toFixed(1):this.threeObject[e][t].toFixed(2):0}setLightProperty(e,t){if(!this.threeObject||!this.threeObject.isLight)return!1;switch(e){case"color":this.threeObject.color.setHex(t.replace("#","0x"));break;case"intensity":this.threeObject.intensity=parseFloat(t);break;case"distance":void 0!==this.threeObject.distance&&(this.threeObject.distance=parseFloat(t));break;case"angle":void 0!==this.threeObject.angle&&(this.threeObject.angle=parseFloat(t));break;case"penumbra":void 0!==this.threeObject.penumbra&&(this.threeObject.penumbra=parseFloat(t));break;case"decay":void 0!==this.threeObject.decay&&(this.threeObject.decay=parseFloat(t))}return this.notifyPropertyChange("light",e,t),!0}getLightProperty(e){if(!this.threeObject||!this.threeObject.isLight)return null;switch(e){case"type":return this.threeObject.type;case"color":return"#"+this.threeObject.color.getHexString();case"intensity":return this.threeObject.intensity;case"distance":return this.threeObject.distance||0;case"angle":return this.threeObject.angle||0;case"penumbra":return this.threeObject.penumbra||0;case"decay":return this.threeObject.decay||1;default:return null}}setCameraProperty(e,t){if(!this.threeObject||!this.threeObject.isCamera)return!1;switch(e){case"fov":this.threeObject.isPerspectiveCamera&&(this.threeObject.fov=parseFloat(t),this.threeObject.updateProjectionMatrix());break;case"near":this.threeObject.near=parseFloat(t),this.threeObject.updateProjectionMatrix();break;case"far":this.threeObject.far=parseFloat(t),this.threeObject.updateProjectionMatrix()}return this.notifyPropertyChange("camera",e,t),!0}getCameraProperty(e){if(!this.threeObject||!this.threeObject.isCamera)return null;switch(e){case"type":return this.threeObject.type;case"fov":return this.threeObject.fov||75;case"near":return this.threeObject.near||.1;case"far":return this.threeObject.far||1e3;default:return null}}setMaterialProperty(e,t){if(!this.threeObject||!this.threeObject.isMesh)return!1;const n=this.threeObject.material;if(!n)return!1;switch(e){case"color":n.color&&n.color.setHex(t.replace("#","0x"));break;case"metalness":void 0!==n.metalness&&(n.metalness=parseFloat(t));break;case"roughness":void 0!==n.roughness&&(n.roughness=parseFloat(t));break;case"emissive":n.emissive&&n.emissive.setHex(t.replace("#","0x"));break;case"emissiveIntensity":void 0!==n.emissiveIntensity&&(n.emissiveIntensity=parseFloat(t));break;case"opacity":n.opacity=parseFloat(t),n.transparent=n.opacity<1}return n.needsUpdate=!0,this.notifyPropertyChange("material",e,t),!0}getMaterialProperty(e){if(!this.threeObject||!this.threeObject.isMesh)return null;const t=this.threeObject.material;if(!t)return null;switch(e){case"color":return t.color?"#"+t.color.getHexString():"#ffffff";case"metalness":return t.metalness||0;case"roughness":return t.roughness||.8;case"emissive":return t.emissive?"#"+t.emissive.getHexString():"#000000";case"emissiveIntensity":return t.emissiveIntensity||0;case"opacity":return t.opacity||1;default:return null}}getObjectInfo(){var e;if(!this.threeObject)return null;return{name:this.threeObject.name||"Unnamed Object",type:this.getObjectType(),id:(null==(e=this.threeObject.userData)?void 0:e.id)||this.threeObject.id,position:{x:this.getTransformProperty("position","x"),y:this.getTransformProperty("position","y"),z:this.getTransformProperty("position","z")},rotation:{x:this.getTransformProperty("rotation","x"),y:this.getTransformProperty("rotation","y"),z:this.getTransformProperty("rotation","z")},scale:{x:this.getTransformProperty("scale","x"),y:this.getTransformProperty("scale","y"),z:this.getTransformProperty("scale","z")}}}dispose(){this.selectedObject=null,this.threeObject=null,this.editorControls=null,this.changeCallbacks=[]}}function Mn({objects:e,selectedIds:t=[],selectedObjectId:s,dragUseSelectionForDnD:i=!1,onSelect:a,onReparent:o,onReorder:l,onBatchStart:c,onBatchEnd:d,onToggleVisibility:u,onToggleFreeze:h}){const p=n.useRef({draggingId:null}),[m,g]=n.useState(null),[b,f]=n.useState(null),[y,v]=n.useState(()=>new Set),x=n.useMemo(()=>new Map((e||[]).map(e=>[e.id,e])),[e]),w=n.useMemo(()=>{const t=new Map;(e||[]).forEach(e=>{var n;const r=null!=(n=e.parentId)?n:null;t.has(r)||t.set(r,[]),t.get(r).push(e)});for(const e of t.values())e.sort((e,t)=>{var n,r;return(null!=(n=e.order)?n:0)-(null!=(r=t.order)?r:0)});return t},[e]),j=w.get(null)||[],S=n.useMemo(()=>{try{const e=Array.isArray(t)?t.slice():[];return null!=s&&e.push(s),new Set(e.map(e=>String(e)))}catch{return new Set}},[t,s]),M=n.useCallback((e,t)=>{var n;if(null==e||null==t)return!1;let r=x.get(t);const s=new Set;for(;r&&!s.has(r.id);){if(s.add(r.id),r.id===e)return!0;const t=null!=(n=r.parentId)?n:null;r=null!=t?x.get(t):null}return!1},[x]),O=(e,t)=>{p.current.draggingId=t;const n=S,r=String(t);let s=(i||n.has(r))&&n.size>0?Array.from(n):[r];const a=new Set(s);s=s.filter(e=>!(e=>{var t;let n=x.get(e);const r=new Set;for(;n&&!r.has(n.id);){r.add(n.id);const e=null!=(t=n.parentId)?t:null;if(null==e)return!1;if(a.has(e))return!0;n=x.get(e)}return!1})(e));try{const t=JSON.stringify({ids:s});e.dataTransfer.setData("application/json",t),e.dataTransfer.setData("text/plain",t),e.dataTransfer.effectAllowed="move"}catch{}},_=(t,n)=>{var r;t.preventDefault();let s=null;try{const e=t.dataTransfer.getData("application/json")||t.dataTransfer.getData("text/plain")||"";e&&(s=JSON.parse(e))}catch{}const i=Array.isArray(null==s?void 0:s.ids)&&s.ids.length?s.ids:p.current.draggingId?[p.current.draggingId]:[];if(g(null),f(null),!i.length)return;const u=x.get(n);if(!u)return;const h=b||"inside";if("inside"===h)i.length>1&&(null==c||c()),i.forEach(e=>{e!==n&&(M(e,n)||null==o||o(e,n))}),i.length>1&&(null==d||d());else{const t=null!=(r=u.parentId)?r:null;i.length>1&&(null==c||c());const s=i.filter(e=>{if(e===n)return!1;return null==t||!M(e,t)});s.forEach(e=>null==o?void 0:o(e,t)),s.length&&((t,n,r,s)=>{const i=(e||[]).filter(e=>{var n;return(null!=(n=e.parentId)?n:null)===(null!=t?t:null)}),a=new Set(n),o=i.map(e=>e.id).filter(e=>!a.has(e)),c=o.indexOf(r),d="above"===s?Math.max(0,c):Math.min(o.length,c+1),u=[...o.slice(0,d),...n,...o.slice(d)];null==l||l(null!=t?t:null,u)})(t,s,n,h),i.length>1&&(null==d||d())}const m=i[0];null!=m&&(null==a||a(m))},C=(e,t=0)=>{const n=S.has(String(e.id)),s=w.get(e.id)||[],i=y.has(e.id),l=m===e.id,c=l?b||"inside":null,d=12*Math.max(0,t),p=!1!==e.visible,x=!0===e.frozen,j="camera"===e.type?"📷":"light"===e.type?"💡":"🔶";return r.jsxs("div",{className:"tree-node "+(n?"selected":""),draggable:!0,onDragStart:t=>O(t,e.id),onDragOver:t=>((e,t)=>{e.preventDefault(),g(null!=t?t:null);try{const t=e.currentTarget.getBoundingClientRect(),n=e.clientY-t.top,r=t.height||1;f(n<.25*r?"above":n>.75*r?"below":"inside")}catch{f("inside")}e.dataTransfer.dropEffect="move"})(t,e.id),onDragLeave:t=>{return n=e.id,g(e=>e===n?null:e),void f(e=>m===n?null:e);var n},onDrop:t=>_(t,e.id),onClick:()=>null==a?void 0:a(e.id),style:{margin:"2px 0",borderRadius:3,background:n?"#ff8c00":l&&"inside"===c?"#2d2d2d":"transparent",outline:n?"2px solid #ff6600":"none",borderLeft:n?"3px solid #ff6600":"3px solid transparent",borderTop:l&&"above"===c?"2px solid #00b894":void 0,borderBottom:l&&"below"===c?"2px solid #00b894":void 0,boxShadow:n?"0 0 8px rgba(255,140,0,0.6)":"none",paddingLeft:8+d,transition:"all .15s ease"},children:[r.jsxs("div",{className:"tree-row",style:{display:"flex",alignItems:"center",gap:6,padding:"4px 6px"},children:[r.jsx("button",{title:i?"펼치기":"접기",onClick:t=>{var n;t.stopPropagation(),n=e.id,v(e=>{const t=new Set(e);return t.has(n)?t.delete(n):t.add(n),t})},style:{width:16,height:20,background:"none",border:"none",color:"#aaa",cursor:"pointer"},children:s.length>0?i?"▸":"▾":"·"}),r.jsx("span",{className:"tree-type",style:{opacity:.8},children:j}),r.jsx("span",{className:"tree-name",style:{color:n?"#fff":"#ccc",fontWeight:n?"bold":"normal",userSelect:"none",flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.name}),r.jsxs("div",{className:"tree-actions",style:{display:"flex",alignItems:"center",gap:4},children:[null!=e.parentId&&r.jsx("button",{className:"icon-btn unparent",title:"부모 해제 (루트로 이동)",onClick:t=>{t.stopPropagation(),null==o||o(e.id,null)},style:{width:22,height:20,background:"none",border:"none",cursor:"pointer",color:"#ddd"},children:"⏏"}),r.jsx("button",{className:"icon-btn eye "+(p?"on":"off"),title:p?"숨기기":"보이기",onClick:t=>{t.stopPropagation(),null==u||u(e)},style:{width:22,height:20,background:"none",border:"none",cursor:"pointer",color:p?"#ddd":"#666"},children:p?"👁":"🙈"}),r.jsx("button",{className:"icon-btn lock "+(x?"on":"off"),title:x?"잠금 해제":"잠금",onClick:t=>{t.stopPropagation(),null==h||h(e)},style:{width:22,height:20,background:"none",border:"none",cursor:"pointer",color:x?"#ddd":"#666"},children:x?"🔒":"🔓"})]})]}),s.length>0&&!i&&r.jsx("div",{className:"tree-children",children:s.map(e=>C(e,t+1))})]},e.id)};return r.jsxs("div",{className:"scene-hierarchy-panel",children:[r.jsx("div",{className:"panel-header",children:r.jsx("h3",{children:"계층"})}),r.jsx("div",{className:"panel-content",children:(j||[]).map(e=>C(e,0))})]})}const On=n.memo(function({objects:e,walls:t,selectedIds:s,setSelectedIds:i,setParent:a,reorderSiblings:o,selectedObject:l,onObjectVisibilityToggle:c,onObjectFreezeToggle:d,onObjectSelect:u,onObjectRemove:h,onObjectFocus:p,onObjectRename:m,onContextMenu:g,editorControls:b,postProcessingManager:f,onObjectUpdate:y,onClose:v}){var x,w,j,S,M,O;const _=()=>{var e,t,n,s;const i=$t(e=>e.stats);return r.jsx("div",{style:{marginTop:10,padding:"10px 12px",background:"rgba(255,255,255,0.04)",borderRadius:6,fontSize:13,lineHeight:1.6},children:r.jsxs("div",{style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:"6px 12px"},children:[r.jsx("div",{children:"FPS"}),r.jsx("div",{children:null!=(e=null==i?void 0:i.fps)?e:0}),r.jsx("div",{children:"오브젝트"}),r.jsx("div",{children:null!=(t=null==i?void 0:i.objects)?t:0}),r.jsx("div",{children:"버텍스"}),r.jsx("div",{children:null!=(n=null==i?void 0:i.vertices)?n:0}),r.jsx("div",{children:"폴리곤(트라이)"}),r.jsx("div",{children:null!=(s=null==i?void 0:i.triangles)?s:0})]})})},C=$t(e=>e.viewReady),D=$t(e=>e.uiReady),E=$t(e=>e.envReady),[P,z]=n.useState({transform:!1,object:!1,material:!1,light:!1,camera:!1,part:!1}),[N,A]=n.useState(null),[k,L]=n.useState(0),R=n.useRef(null),I=n.useRef(0),T=n.useRef(0),F=n.useRef(!1);n.useEffect(()=>{const e=new Sn(b);return e.onPropertyChange(e=>{try{y&&y(e)}catch{}const t=Date.now();t-(I.current||0)>=50&&(I.current=t,L(e=>e+1))}),A(e),()=>{e.dispose()}},[b,y]),n.useEffect(()=>{var e,t;if(!N)return;const n=l||(null!=(t=null==(e=null==b?void 0:b.selectedObjects)?void 0:e[0])?t:null);N.setSelectedObject(n),L(e=>e+1)},[N,l,b]),n.useEffect(()=>{var e,t,n,r,s;if(!l||!N||!b)return;const i=1e-4,a=()=>{const e=N.threeObject;return e?{p:[e.position.x,e.position.y,e.position.z],r:[e.rotation.x,e.rotation.y,e.rotation.z],s:[e.scale.x,e.scale.y,e.scale.z]}:null},o=()=>{try{T.current&&cancelAnimationFrame(T.current)}catch{}R.current=a(),L(e=>e+1);const e=()=>{if(!F.current)return void(T.current=0);const t=a(),n=Date.now();t&&((e,t)=>{if(!e||!t)return!0;for(let n=0;n<3;n++){if(Math.abs(e.p[n]-t.p[n])>i)return!0;if(Math.abs(e.r[n]-t.r[n])>i)return!0;if(Math.abs(e.s[n]-t.s[n])>i)return!0}return!1})(t,R.current)&&n-(I.current||0)>=80&&(R.current=t,I.current=n,L(e=>e+1)),T.current=requestAnimationFrame(e)};T.current=requestAnimationFrame(e)},c=null==(e=null==b?void 0:b.objectSelector)?void 0:e.transformControls,d=null==b?void 0:b._partTransformControls,u=e=>{F.current=!!(null==e?void 0:e.value),F.current?o():(T.current&&cancelAnimationFrame(T.current),T.current=0,L(e=>e+1))},h=()=>{F.current||(()=>{const e=Date.now();e-(I.current||0)>=100&&(I.current=e,L(e=>e+1))})()};return null==(t=null==c?void 0:c.addEventListener)||t.call(c,"dragging-changed",u),null==(n=null==c?void 0:c.addEventListener)||n.call(c,"objectChange",h),null==(r=null==d?void 0:d.addEventListener)||r.call(d,"dragging-changed",u),null==(s=null==d?void 0:d.addEventListener)||s.call(d,"objectChange",h),()=>{var e,t,n,r;try{null==(e=null==c?void 0:c.removeEventListener)||e.call(c,"dragging-changed",u)}catch{}try{null==(t=null==c?void 0:c.removeEventListener)||t.call(c,"objectChange",h)}catch{}try{null==(n=null==d?void 0:d.removeEventListener)||n.call(d,"dragging-changed",u)}catch{}try{null==(r=null==d?void 0:d.removeEventListener)||r.call(d,"objectChange",h)}catch{}T.current&&cancelAnimationFrame(T.current),T.current=0,F.current=!1}},[l,N,b]);const G=(null==N?void 0:N.getObjectType())||"unknown",B=null==N?void 0:N.getObjectInfo(),H=n.useRef(null);n.useEffect(()=>{var e,t;if(!N)return;const n=!(!(null==b?void 0:b._gizmoPointerDown)&&!(null==(t=null==(e=null==b?void 0:b.objectSelector)?void 0:e.transformControls)?void 0:t.dragging));if(N.getObjectInfo())H.current=N.threeObject||H.current;else if(n&&H.current){try{N.setSelectedObject(H.current)}catch{}L(e=>e+1)}},[N,b]);const U=(null==(x=null==b?void 0:b.getSelectedPartInfo)?void 0:x.call(b))||null,V=e=>z(t=>({...t,[e]:!t[e]}));return r.jsxs("div",{className:"inspector-panel",children:[r.jsxs("div",{className:"inspector-header",children:[r.jsx("h3",{children:"인스펙터"}),r.jsx("button",{className:"close-btn",onClick:v,children:"×"})]}),r.jsxs("div",{className:"inspector-content",children:[r.jsxs("div",{className:"hierarchy-section",children:[r.jsx("div",{className:"section-header",children:r.jsx("h4",{children:"씬 계층구조"})}),r.jsx("div",{className:"hierarchy-container",children:r.jsx(Mn,{objects:e,selectedIds:s||[],selectedObjectId:null!=(w=null==l?void 0:l.id)?w:l,dragUseSelectionForDnD:(()=>{try{return $t.getState().dragUseSelectionForDnD}catch{return!1}})(),onBatchStart:()=>{var e,t;try{null==(t=(e=$t.getState()).beginBatch)||t.call(e)}catch{}},onBatchEnd:()=>{var e,t;try{null==(t=(e=$t.getState()).endBatch)||t.call(e)}catch{}},onSelect:t=>{var n,r;null==i||i([t]);const s=null==(n=null==b?void 0:b.findObjectById)?void 0:n.call(b,t);s&&(null==(r=null==b?void 0:b.selectObject)||r.call(b,s));try{const n=(e||[]).find(e=>e.id===t)||{id:t};null==u||u(n)}catch{}},onReparent:(e,t)=>{var n,r;null==a||a(e,t);try{const s=null==(n=null==b?void 0:b.findObjectById)?void 0:n.call(b,e);if(s)if(null==t)!function(e,t,n=!0){!(!e||!e.isObject3D)&&jn(e,t&&t.isScene?t:null,n)}(s,null==b?void 0:b.scene,!0);else{const e=null==(r=null==b?void 0:b.findObjectById)?void 0:r.call(b,t);e&&s!==e&&jn(s,e,!0)}}catch{}try{clearTimeout(window.__reparentOutlineT)}catch{}try{window.__reparentOutlineT=setTimeout(()=>{var e,t;null==(t=null==(e=null==b?void 0:b.objectSelector)?void 0:e.updateAllSelectionOutlines)||t.call(e),window.__reparentOutlineT=null},0)}catch{}},onReorder:(e,t)=>{null==o||o(e,t)},onToggleVisibility:e=>null==c?void 0:c(e),onToggleFreeze:e=>null==d?void 0:d(e)})})]}),r.jsxs("div",{className:"properties-section-wrapper",children:[r.jsxs("div",{className:"section-header",children:[r.jsx("h4",{children:"속성"}),r.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center",marginLeft:"auto"},children:[r.jsxs("span",{title:"뷰 설정",style:{padding:"2px 6px",borderRadius:4,fontSize:11,background:C?"rgba(40,167,69,0.15)":"rgba(255,193,7,0.12)",color:C?"#7CDA9B":"#FFD666",border:"1px solid "+(C?"rgba(40,167,69,0.45)":"rgba(255,193,7,0.35)")},children:["View ",C?"✓":"…"]}),r.jsxs("span",{title:"UI 설정",style:{padding:"2px 6px",borderRadius:4,fontSize:11,background:D?"rgba(40,167,69,0.15)":"rgba(255,193,7,0.12)",color:D?"#7CDA9B":"#FFD666",border:"1px solid "+(D?"rgba(40,167,69,0.45)":"rgba(255,193,7,0.35)")},children:["UI ",D?"✓":"…"]}),r.jsxs("span",{title:"환경 설정",style:{padding:"2px 6px",borderRadius:4,fontSize:11,background:E?"rgba(40,167,69,0.15)":"rgba(255,193,7,0.12)",color:E?"#7CDA9B":"#FFD666",border:"1px solid "+(E?"rgba(40,167,69,0.45)":"rgba(255,193,7,0.35)")},children:["Env ",E?"✓":"…"]})]}),B&&r.jsxs("div",{className:"object-info",children:[r.jsx("span",{className:"object-name",children:B.name}),r.jsxs("span",{className:"object-type",children:["(",G,")"]}),((null==(S=null==(j=null==b?void 0:b.objectSelector)?void 0:j.transformControls)?void 0:S.dragging)||(null==b?void 0:b._gizmoPointerDown))&&r.jsx("span",{className:"editing-badge",title:"기즈모 편집 중 - 값만 실시간 갱신됩니다",children:"편집 중"})]})]}),r.jsxs("div",{className:"properties-container "+((null==(O=null==(M=null==b?void 0:b.objectSelector)?void 0:M.transformControls)?void 0:O.dragging)||(null==b?void 0:b._gizmoPointerDown)?"editing":""),children:[!l&&r.jsxs("div",{className:"no-selection",children:[r.jsx("div",{className:"no-selection-icon",children:"ℹ️"}),r.jsx("div",{className:"no-selection-text",children:"뷰 정보"}),r.jsx("div",{className:"no-selection-hint",children:"선택된 객체가 없을 때 현재 시스템 상태를 보여줍니다."}),r.jsx(_,{})]}),B&&r.jsxs("div",{className:"accordion",children:[r.jsxs("div",{className:"accordion-section",children:[r.jsxs("button",{className:"accordion-header",onClick:()=>V("transform"),children:[r.jsx("span",{className:"chevron "+(P.transform?"":"open"),children:"▾"}),r.jsx("span",{className:"title",children:"Transform"})]}),!P.transform&&r.jsx("div",{className:"accordion-body transform-properties",children:B?r.jsxs("div",{className:"transform-properties",children:[r.jsxs("div",{className:"transform-row",children:[r.jsx("div",{className:"transform-label",children:"Position"}),r.jsxs("div",{className:"transform-inputs",children:[r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"X"}),r.jsx("input",{type:"number",step:"0.1",value:B.position.x,onChange:e=>null==N?void 0:N.setTransformProperty("position","x",e.target.value)})]}),r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"Y"}),r.jsx("input",{type:"number",step:"0.1",value:B.position.y,onChange:e=>null==N?void 0:N.setTransformProperty("position","y",e.target.value)})]}),r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"Z"}),r.jsx("input",{type:"number",step:"0.1",value:B.position.z,onChange:e=>null==N?void 0:N.setTransformProperty("position","z",e.target.value)})]})]})]}),r.jsxs("div",{className:"transform-row",children:[r.jsx("div",{className:"transform-label",children:"Rotation"}),r.jsxs("div",{className:"transform-inputs",children:[r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"X"}),r.jsx("input",{type:"number",step:"1",value:B.rotation.x,onChange:e=>null==N?void 0:N.setTransformProperty("rotation","x",e.target.value)})]}),r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"Y"}),r.jsx("input",{type:"number",step:"1",value:B.rotation.y,onChange:e=>null==N?void 0:N.setTransformProperty("rotation","y",e.target.value)})]}),r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"Z"}),r.jsx("input",{type:"number",step:"1",value:B.rotation.z,onChange:e=>null==N?void 0:N.setTransformProperty("rotation","z",e.target.value)})]})]})]}),r.jsxs("div",{className:"transform-row",children:[r.jsx("div",{className:"transform-label",children:"Scale"}),r.jsxs("div",{className:"transform-inputs",children:[r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"X"}),r.jsx("input",{type:"number",step:"0.1",min:"0.1",value:B.scale.x,onChange:e=>null==N?void 0:N.setTransformProperty("scale","x",e.target.value)})]}),r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"Y"}),r.jsx("input",{type:"number",step:"0.1",min:"0.1",value:B.scale.y,onChange:e=>null==N?void 0:N.setTransformProperty("scale","y",e.target.value)})]}),r.jsxs("div",{className:"transform-input-group",children:[r.jsx("span",{className:"input-label",children:"Z"}),r.jsx("input",{type:"number",step:"0.1",min:"0.1",value:B.scale.z,onChange:e=>null==N?void 0:N.setTransformProperty("scale","z",e.target.value)})]})]})]})]}):r.jsx("div",{style:{color:"red",padding:"20px"},children:"objectInfo가 없습니다"})})]}),r.jsxs("div",{className:"accordion-section",children:[r.jsxs("button",{className:"accordion-header",onClick:()=>V("object"),children:[r.jsx("span",{className:"chevron "+(P.object?"":"open"),children:"▾"}),r.jsx("span",{className:"title",children:"Object"})]}),!P.object&&r.jsx("div",{className:"accordion-body object-properties",children:B?r.jsxs("div",{className:"object-properties",children:[r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Name"}),r.jsx("input",{type:"text",value:B.name,onChange:e=>{(null==N?void 0:N.threeObject)&&(N.threeObject.name=e.target.value,N.notifyPropertyChange("object","name",e.target.value))}})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Type"}),r.jsx("span",{className:"readonly-value",children:B.type})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"ID"}),r.jsx("span",{className:"readonly-value",children:B.id})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Visible"}),r.jsx("input",{type:"checkbox",checked:!1!==(null==(q=null==N?void 0:N.threeObject)?void 0:q.visible),onChange:e=>{(null==N?void 0:N.threeObject)&&(N.threeObject.visible=e.target.checked,N.notifyPropertyChange("object","visible",e.target.checked))}})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Cast Shadow"}),r.jsx("input",{type:"checkbox",checked:(null==(W=null==N?void 0:N.threeObject)?void 0:W.castShadow)||!1,onChange:e=>{(null==N?void 0:N.threeObject)&&(N.threeObject.castShadow=e.target.checked,N.notifyPropertyChange("object","castShadow",e.target.checked))}})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Receive Shadow"}),r.jsx("input",{type:"checkbox",checked:(null==(K=null==N?void 0:N.threeObject)?void 0:K.receiveShadow)||!1,onChange:e=>{(null==N?void 0:N.threeObject)&&(N.threeObject.receiveShadow=e.target.checked,N.notifyPropertyChange("object","receiveShadow",e.target.checked))}})]})]}):r.jsx("div",{style:{color:"red",padding:"20px"},children:"objectInfo가 없습니다"})})]}),"mesh"===G&&r.jsxs("div",{className:"accordion-section",children:[r.jsxs("button",{className:"accordion-header",onClick:()=>V("material"),children:[r.jsx("span",{className:"chevron "+(P.material?"":"open"),children:"▾"}),r.jsx("span",{className:"title",children:"Material"})]}),!P.material&&r.jsx("div",{className:"accordion-body material-properties",children:"mesh"!==G?r.jsx("div",{className:"not-available",children:"메시 객체가 아닙니다"}):r.jsxs("div",{className:"material-properties",children:[r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Color"}),r.jsx("input",{type:"color",value:(null==N?void 0:N.getMaterialProperty("color"))||"#ffffff",onChange:e=>null==N?void 0:N.setMaterialProperty("color",e.target.value)})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Metalness"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==N?void 0:N.getMaterialProperty("metalness"))||0,onChange:e=>null==N?void 0:N.setMaterialProperty("metalness",e.target.value)}),r.jsx("span",{children:((null==N?void 0:N.getMaterialProperty("metalness"))||0).toFixed(2)})]})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Roughness"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==N?void 0:N.getMaterialProperty("roughness"))||.8,onChange:e=>null==N?void 0:N.setMaterialProperty("roughness",e.target.value)}),r.jsx("span",{children:((null==N?void 0:N.getMaterialProperty("roughness"))||.8).toFixed(2)})]})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Emissive"}),r.jsx("input",{type:"color",value:(null==N?void 0:N.getMaterialProperty("emissive"))||"#000000",onChange:e=>null==N?void 0:N.setMaterialProperty("emissive",e.target.value)})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Emissive Intensity"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:(null==N?void 0:N.getMaterialProperty("emissiveIntensity"))||0,onChange:e=>null==N?void 0:N.setMaterialProperty("emissiveIntensity",e.target.value)}),r.jsx("span",{children:((null==N?void 0:N.getMaterialProperty("emissiveIntensity"))||0).toFixed(2)})]})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Opacity"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==N?void 0:N.getMaterialProperty("opacity"))||1,onChange:e=>null==N?void 0:N.setMaterialProperty("opacity",e.target.value)}),r.jsx("span",{children:((null==N?void 0:N.getMaterialProperty("opacity"))||1).toFixed(2)})]})]})]})})]}),"light"===G&&r.jsxs("div",{className:"accordion-section",children:[r.jsxs("button",{className:"accordion-header",onClick:()=>V("light"),children:[r.jsx("span",{className:"chevron "+(P.light?"":"open"),children:"▾"}),r.jsx("span",{className:"title",children:"Light"})]}),!P.light&&r.jsx("div",{className:"accordion-body light-properties",children:(()=>{if("light"!==G)return r.jsx("div",{className:"not-available",children:"라이트 객체가 아닙니다"});const e=null==N?void 0:N.getLightProperty("type");return r.jsxs("div",{className:"light-properties",children:[r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Type"}),r.jsx("span",{className:"readonly-value",children:e})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Color"}),r.jsx("input",{type:"color",value:(null==N?void 0:N.getLightProperty("color"))||"#ffffff",onChange:e=>null==N?void 0:N.setLightProperty("color",e.target.value)})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Intensity"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"0",max:"5",step:"0.1",value:(null==N?void 0:N.getLightProperty("intensity"))||1,onChange:e=>null==N?void 0:N.setLightProperty("intensity",e.target.value)}),r.jsx("span",{children:((null==N?void 0:N.getLightProperty("intensity"))||1).toFixed(1)})]})]}),"SpotLight"===e&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Distance"}),r.jsx("input",{type:"number",min:"0",step:"1",value:(null==N?void 0:N.getLightProperty("distance"))||0,onChange:e=>null==N?void 0:N.setLightProperty("distance",e.target.value)})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Angle"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"0",max:"1.57",step:"0.01",value:(null==N?void 0:N.getLightProperty("angle"))||0,onChange:e=>null==N?void 0:N.setLightProperty("angle",e.target.value)}),r.jsx("span",{children:((null==N?void 0:N.getLightProperty("angle"))||0).toFixed(2)})]})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Penumbra"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==N?void 0:N.getLightProperty("penumbra"))||0,onChange:e=>null==N?void 0:N.setLightProperty("penumbra",e.target.value)}),r.jsx("span",{children:((null==N?void 0:N.getLightProperty("penumbra"))||0).toFixed(2)})]})]})]}),("PointLight"===e||"SpotLight"===e)&&r.jsxs(r.Fragment,{children:["PointLight"===e&&r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Distance"}),r.jsx("input",{type:"number",min:"0",step:"1",value:(null==N?void 0:N.getLightProperty("distance"))||0,onChange:e=>null==N?void 0:N.setLightProperty("distance",e.target.value)})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Decay"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"0",max:"3",step:"0.1",value:(null==N?void 0:N.getLightProperty("decay"))||1,onChange:e=>null==N?void 0:N.setLightProperty("decay",e.target.value)}),r.jsx("span",{children:((null==N?void 0:N.getLightProperty("decay"))||1).toFixed(1)})]})]})]})]})})()})]}),"camera"===G&&r.jsxs("div",{className:"accordion-section",children:[r.jsxs("button",{className:"accordion-header",onClick:()=>V("camera"),children:[r.jsx("span",{className:"chevron "+(P.camera?"":"open"),children:"▾"}),r.jsx("span",{className:"title",children:"Camera"})]}),!P.camera&&r.jsx("div",{className:"accordion-body camera-properties",children:"camera"!==G?r.jsx("div",{className:"not-available",children:"카메라 객체가 아닙니다"}):r.jsxs("div",{className:"camera-properties",children:[r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Type"}),r.jsx("span",{className:"readonly-value",children:null==N?void 0:N.getCameraProperty("type")})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"FOV"}),r.jsxs("div",{className:"range-input",children:[r.jsx("input",{type:"range",min:"10",max:"120",step:"1",value:(null==N?void 0:N.getCameraProperty("fov"))||75,onChange:e=>null==N?void 0:N.setCameraProperty("fov",e.target.value)}),r.jsxs("span",{children:[(null==N?void 0:N.getCameraProperty("fov"))||75,"°"]})]})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Near"}),r.jsx("input",{type:"number",min:"0.01",step:"0.01",value:(null==N?void 0:N.getCameraProperty("near"))||.1,onChange:e=>null==N?void 0:N.setCameraProperty("near",e.target.value)})]}),r.jsxs("div",{className:"property-group",children:[r.jsx("label",{children:"Far"}),r.jsx("input",{type:"number",min:"1",step:"1",value:(null==N?void 0:N.getCameraProperty("far"))||1e3,onChange:e=>null==N?void 0:N.setCameraProperty("far",e.target.value)})]})]})})]}),"mesh"===G&&r.jsxs("div",{className:"accordion-section",children:[r.jsxs("button",{className:"accordion-header",onClick:()=>V("part"),children:[r.jsx("span",{className:"chevron "+(P.part?"":"open"),children:"▾"}),r.jsx("span",{className:"title",children:"Part"})]}),!P.part&&r.jsx("div",{className:"accordion-body part-properties",children:(()=>{var e,t,n,s,i,a,o,l,c,d,u,h,p,m,g,y,v,x,w,j,S,M,O,_;if("mesh"!==G)return r.jsx("div",{className:"not-available",children:"메시 객체가 아닙니다"});const C=!!(null==(e=null==b?void 0:b.partInspector)?void 0:e.enabled),D=!!(null==(t=null==b?void 0:b.partInspector)?void 0:t.solo),E=!!(null==(n=null==b?void 0:b.partInspector)?void 0:n.clipping),P=!!(null==(s=null==b?void 0:b.partInspector)?void 0:s.gizmo),z=U;return r.jsxs("div",{className:"part-properties",children:[r.jsxs("div",{className:"property-group",style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[r.jsx("label",{children:"파트 인스펙션"}),r.jsxs("label",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[r.jsx("input",{type:"checkbox",checked:C,onChange:e=>{var t;return null==(t=null==b?void 0:b.enablePartInspect)?void 0:t.call(b,e.target.checked)}})," 사용"]}),r.jsxs("label",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[r.jsx("input",{type:"checkbox",checked:D,onChange:e=>{var t;return null==(t=null==b?void 0:b.setPartSolo)?void 0:t.call(b,e.target.checked)},disabled:!C})," 솔로 뷰"]}),r.jsxs("label",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[r.jsx("input",{type:"checkbox",checked:E,onChange:e=>{var t;return null==(t=null==b?void 0:b.setPartClipping)?void 0:t.call(b,e.target.checked)},disabled:!C})," 클리핑"]}),r.jsx("button",{onClick:()=>{var e;return null==(e=null==b?void 0:b.clearPartSelection)?void 0:e.call(b)},disabled:!C,children:"파트 선택 해제"})]}),C&&r.jsxs("div",{className:"property-group",style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[r.jsx("label",{children:"파트 기즈모"}),r.jsxs("label",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[r.jsx("input",{type:"checkbox",checked:P,onChange:e=>{var t;return null==(t=null==b?void 0:b.setPartGizmoEnabled)?void 0:t.call(b,e.target.checked)},disabled:!(null==(i=null==b?void 0:b.getSelectedPart)?void 0:i.call(b))})," 활성화"]}),r.jsxs("div",{style:{display:"inline-flex",gap:6},children:[r.jsx("button",{onClick:()=>{var e;return null==(e=null==b?void 0:b.setPartGizmoMode)?void 0:e.call(b,"translate")},disabled:!P,children:"이동"}),r.jsx("button",{onClick:()=>{var e;return null==(e=null==b?void 0:b.setPartGizmoMode)?void 0:e.call(b,"rotate")},disabled:!P,children:"회전"}),r.jsx("button",{onClick:()=>{var e;return null==(e=null==b?void 0:b.setPartGizmoMode)?void 0:e.call(b,"scale")},disabled:!P,children:"스케일"})]})]}),r.jsxs("div",{className:"property-group",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:"8px 12px"},children:[r.jsx("div",{style:{gridColumn:"1 / span 2",fontWeight:600},children:"포스트프로세싱"}),r.jsx("label",{children:"Bloom"}),r.jsx("input",{type:"checkbox",checked:!!(null==(o=null==(a=null==f?void 0:f.effectSettings)?void 0:a.bloom)?void 0:o.enabled),onChange:e=>{var t;try{null==(t=null==f?void 0:f.setEffectEnabled)||t.call(f,"bloom",e.target.checked)}catch{}}}),r.jsx("label",{children:"AA (SMAA)"}),r.jsx("input",{type:"checkbox",checked:!!(null==(c=null==(l=null==f?void 0:f.effectSettings)?void 0:l.fxaa)?void 0:c.enabled),onChange:e=>{var t;try{null==(t=null==f?void 0:f.setEffectEnabled)||t.call(f,"fxaa",e.target.checked)}catch{}}}),r.jsx("label",{children:"SSAO"}),r.jsx("input",{type:"checkbox",checked:!!(null==(u=null==(d=null==f?void 0:f.effectSettings)?void 0:d.ssao)?void 0:u.enabled),onChange:e=>{var t;try{null==(t=null==f?void 0:f.setEffectEnabled)||t.call(f,"ssao",e.target.checked)}catch{}}}),r.jsx("label",{children:"Tone Mapping"}),r.jsx("input",{type:"checkbox",checked:!1!==(null==(p=null==(h=null==f?void 0:f.effectSettings)?void 0:h.toneMapping)?void 0:p.enabled),onChange:e=>{var t;try{null==(t=null==f?void 0:f.setEffectEnabled)||t.call(f,"toneMapping",e.target.checked)}catch{}}})]}),r.jsxs("div",{className:"property-group",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:"8px 12px"},children:[r.jsx("div",{style:{gridColumn:"1 / span 2",fontWeight:600},children:"톤 매핑"}),r.jsx("label",{children:"모드"}),r.jsxs("select",{value:(null==(g=null==(m=null==f?void 0:f.effectSettings)?void 0:m.toneMapping)?void 0:g.mapping)||"ACESFilmic",onChange:e=>{var t;try{null==(t=null==f?void 0:f.updateEffectSettings)||t.call(f,"toneMapping",{mapping:e.target.value})}catch{}},children:[r.jsx("option",{value:"None",children:"None"}),r.jsx("option",{value:"Linear",children:"Linear"}),r.jsx("option",{value:"Reinhard",children:"Reinhard"}),r.jsx("option",{value:"Cineon",children:"Cineon"}),r.jsx("option",{value:"ACESFilmic",children:"ACESFilmic"})]}),r.jsx("label",{children:"노출"}),r.jsx("input",{type:"range",min:"0.1",max:"4",step:"0.05",value:null!=(x=null==(v=null==(y=null==f?void 0:f.effectSettings)?void 0:y.toneMapping)?void 0:v.exposure)?x:1,onChange:e=>{var t;const n=parseFloat(e.target.value);try{null==(t=null==f?void 0:f.updateEffectSettings)||t.call(f,"toneMapping",{exposure:n})}catch{}}})]}),C&&r.jsxs("div",{className:"property-group",children:[r.jsx("div",{style:{fontSize:12,color:"#aaa",marginBottom:6},children:"서브메시를 클릭해 선택하세요."}),z?r.jsxs("div",{className:"mesh-info",style:{display:"grid",gridTemplateColumns:"120px 1fr",gap:"6px 12px"},children:[r.jsx("div",{children:"이름"}),r.jsx("div",{children:z.name}),r.jsx("div",{children:"UUID"}),r.jsx("div",{style:{wordBreak:"break-all"},children:z.uuid}),r.jsx("div",{children:"지오메트리"}),r.jsxs("div",{children:[z.geometry.type," ",z.geometry.hasIndex?"(Indexed)":""]}),r.jsx("div",{children:"버텍스/트라이"}),r.jsxs("div",{children:[z.geometry.vertices," / ",z.geometry.triangles]}),r.jsx("div",{children:"속성"}),r.jsx("div",{children:z.geometry.attributes.join(", ")}),r.jsx("div",{children:"월드 크기"}),r.jsx("div",{children:z.geometry.world.size.map(e=>e.toFixed(3)).join(", ")}),r.jsx("div",{children:"월드 중심"}),r.jsx("div",{children:z.geometry.world.center.map(e=>e.toFixed(3)).join(", ")}),r.jsx("div",{children:"UV"}),r.jsx("div",{children:z.geometry.uv?`${z.geometry.uv.count}x${z.geometry.uv.itemSize}`:"없음"}),r.jsx("div",{children:"UV2"}),r.jsx("div",{children:z.geometry.uv2?`${z.geometry.uv2.count}x${z.geometry.uv2.itemSize}`:"없음"}),z.material&&r.jsxs(r.Fragment,{children:[r.jsx("div",{children:"머티리얼"}),r.jsxs("div",{children:[z.material.type," ",z.material.name?`(${z.material.name})`:""]}),r.jsx("div",{children:"색상/불투명"}),r.jsxs("div",{children:[z.material.color||"-"," / ",z.material.opacity]}),r.jsx("div",{children:"Metal/Rough"}),r.jsxs("div",{children:[null!=(w=z.material.metalness)?w:"-"," / ",null!=(j=z.material.roughness)?j:"-"]}),r.jsx("div",{children:"맵들"}),r.jsx("div",{children:Object.entries(z.material.maps).filter(([,e])=>e).map(([e])=>e).join(", ")||"없음"})]})]}):r.jsx("div",{style:{color:"#aaa"},children:"선택된 파트가 없습니다."}),r.jsxs("div",{style:{marginTop:10,display:"flex",gap:8,flexWrap:"wrap"},children:[r.jsx("button",{onClick:()=>{var e;return null==(e=null==b?void 0:b.selectAllChildParts)?void 0:e.call(b)},disabled:!(null==(S=null==b?void 0:b.getSelectedPart)?void 0:S.call(b)),children:"자식 파트 전체 선택"}),r.jsx("button",{onClick:()=>{var e;return null==(e=null==b?void 0:b.clearAllPartSelections)?void 0:e.call(b)},disabled:!(null==(M=null==b?void 0:b.getSelectedPart)?void 0:M.call(b)),children:"모든 파트 선택 해제"}),r.jsxs("label",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[r.jsx("input",{type:"checkbox",checked:!!(null==(O=null==b?void 0:b.isPartGroupGizmoEnabled)?void 0:O.call(b)),onChange:e=>{var t;return null==(t=null==b?void 0:b.setPartGroupGizmoEnabled)?void 0:t.call(b,e.target.checked)}})," 그룹 기즈모(일괄 변형)"]}),r.jsxs("label",{style:{display:"inline-flex",alignItems:"center",gap:6},children:["피벗",r.jsxs("select",{value:(null==(_=null==b?void 0:b.getPartGroupPivot)?void 0:_.call(b))||"center",onChange:e=>{var t;return null==(t=null==b?void 0:b.setPartGroupPivot)?void 0:t.call(b,e.target.value)},children:[r.jsx("option",{value:"center",children:"선택 중심"}),r.jsx("option",{value:"first",children:"첫 파트"}),r.jsx("option",{value:"last",children:"마지막 파트"})]})]})]})]})]})})()})]})]})]})]})]})]});var q,W,K}),_n=({onObjectDrop:e,onClose:t,forceRefresh:i=0})=>{const[a,o]=n.useState(!1),[l,c]=n.useState([]),[d,u]=n.useState([]),h=n.useRef(null),{customMeshes:p,loadCustomMeshes:m}=$t(),g=n.useRef(vn()),b=n.useRef(new Set),f=n.useRef(null),[y,v]=n.useState(!1),[x,w]=n.useState({open:!1,x:0,y:0,mesh:null}),j=n.useRef(null);n.useEffect(()=>{if(!x.open)return;const e=()=>w({open:!1,x:0,y:0,mesh:null}),t=t=>{"Escape"===t.key&&e()},n=t=>{try{const e=j.current;if(e&&e.contains(t.target))return}catch{}e()};return window.addEventListener("click",n),window.addEventListener("keydown",t),()=>{window.removeEventListener("click",n),window.removeEventListener("keydown",t)}},[x.open]);n.useEffect(()=>((async()=>{const e=await g.current.getCustomMeshes();m(e)})(),()=>{const e=b.current;for(const t of e)try{URL.revokeObjectURL(t)}catch{}e.clear()}),[m]),n.useEffect(()=>{const e=async()=>{const e=await g.current.getCustomMeshes();m(e)};return window.addEventListener("customMeshAdded",e),()=>{window.removeEventListener("customMeshAdded",e)}},[m]),n.useEffect(()=>{const e=b.current,t=new Set((p||[]).map(e=>"string"==typeof e.thumbnail&&e.thumbnail.startsWith("blob:")?e.thumbnail:null).filter(Boolean));for(const n of e)if(!t.has(n))try{URL.revokeObjectURL(n)}catch{}b.current=t},[p]),n.useEffect(()=>{(()=>{const e=JSON.parse(localStorage.getItem("customObjects")||"[]");c(e)})()},[i]),n.useEffect(()=>{(async()=>{try{const t=await g.current.loadLibraryMeshes();u(t);for(let n=0;n<t.length;n++){const r=t[n];try{const e=await g.current.generateThumbnailFromURL(r.glbUrl);u(t=>t.map(t=>t.id===r.id?{...t,thumbnail:e,isLoadingThumbnail:!1}:t))}catch(e){u(e=>e.map(e=>e.id===r.id?{...e,isLoadingThumbnail:!1}:e))}}}catch(e){}})()},[]);const S=(e,t)=>{o(!0),h.current=t;let n=t;"custom"===t.type&&(n={type:"custom",id:t.id,name:t.name});const r=document.createElement("canvas");r.width=50,r.height=50;const s=r.getContext("2d");s.fillStyle="rgba(100, 150, 255, 0.8)",s.fillRect(0,0,50,50),s.fillStyle="white",s.font="12px Arial",s.textAlign="center",s.fillText(t.name,25,30),e.dataTransfer.setDragImage(r,25,25),e.dataTransfer.setData("text/plain",JSON.stringify(n))},M=()=>{o(!1),h.current=null},O=t=>{e&&("custom"===t.type?e({type:"custom",id:t.id,name:t.name},{x:0,y:0,z:0}):(t.type,e(t,{x:0,y:0,z:0})))},_=async(e,t)=>{if(t.stopPropagation(),window.confirm(`"${e.name}"을(를) 라이브러리에서 삭제하시겠습니까?`))try{await g.current.deleteCustomMesh(e.id);const t=await g.current.getCustomMeshes();m(t),window.dispatchEvent(new CustomEvent("appToast",{detail:{message:"삭제되었습니다.",type:"success",duration:2e3}}))}catch(n){window.dispatchEvent(new CustomEvent("appToast",{detail:{message:"삭제에 실패했습니다 (IndexedDB).",type:"error",duration:3e3}}))}},C=async e=>{try{const e=await g.current.getCustomMeshes();m(e)}catch{}};return r.jsxs("div",{className:"library-panel",children:[r.jsxs("div",{className:"library-header",children:[r.jsx("h3",{children:"라이브러리"}),r.jsx("button",{className:"close-btn",onClick:t,children:r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]}),r.jsxs("div",{className:"library-content",children:[r.jsx("div",{className:"category-section",style:{marginTop:0},children:r.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[r.jsx("button",{className:"upload-btn",onClick:()=>{var e;null==(e=f.current)||e.click()},disabled:y,title:"GLB 파일 임포트",children:y?"임포트 중…":"GLB 임포트"}),r.jsx("input",{ref:f,type:"file",accept:".glb,model/gltf-binary",multiple:!0,style:{display:"none"},onChange:async e=>{const t=Array.from(e.target.files||[]);if(t.length){v(!0);try{for(const r of t)try{await g.current.importGLBFile(r)}catch(n){window.dispatchEvent(new CustomEvent("appToast",{detail:{message:`${r.name} 임포트 실패`,type:"error",duration:3e3}}))}const e=await g.current.getCustomMeshes();m(e),window.dispatchEvent(new CustomEvent("appToast",{detail:{message:"임포트 완료",type:"success",duration:2e3}}))}finally{v(!1),f.current&&(f.current.value="")}}}})]})}),r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"기본 도형"}),r.jsx("div",{className:"object-grid",children:[{id:"cube",name:"정육면체",type:"basic",geometry:"BoxGeometry",params:[1,1,1]},{id:"sphere",name:"구체",type:"basic",geometry:"SphereGeometry",params:[.5,32,16]},{id:"cylinder",name:"원기둥",type:"basic",geometry:"CylinderGeometry",params:[.5,.5,1,32]},{id:"cone",name:"원뿔",type:"basic",geometry:"ConeGeometry",params:[.5,1,32]},{id:"plane",name:"평면",type:"basic",geometry:"PlaneGeometry",params:[1,1]},{id:"torus",name:"도넛",type:"basic",geometry:"TorusGeometry",params:[.5,.2,16,100]}].map(e=>r.jsx("div",{className:"library-item",draggable:!0,onDragStart:t=>S(t,e),onDragEnd:M,onClick:()=>O(e),title:e.name,children:r.jsx("div",{className:"object-grid",children:r.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:["cube"===e.id&&r.jsx("path",{d:"M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L6.04,7.5L12,10.85L17.96,7.5L12,4.15M5,15.91L11,19.29V12.58L5,9.21V15.91M19,15.91V9.21L13,12.58V19.29L19,15.91Z"}),"sphere"===e.id&&r.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"}),"cylinder"===e.id&&r.jsx("path",{d:"M12,2C8.14,2 5,3.79 5,6V18C5,20.21 8.14,22 12,22C15.86,22 19,20.21 19,18V6C19,3.79 15.86,2 12,2M12,4C14.67,4 17,4.9 17,6C17,7.1 14.67,8 12,8C9.33,8 7,7.1 7,6C7,4.9 9.33,4 12,4M7,9.5C8.21,10.72 9.86,11.26 12,11.26C14.14,11.26 15.79,10.72 17,9.5V18C17,19.1 14.67,20 12,20C9.33,20 7,19.1 7,18V9.5Z"}),"cone"===e.id&&r.jsx("path",{d:"M12,2L1,21H23L12,2M12,6L19.53,19H4.47L12,6Z"}),"plane"===e.id&&r.jsx("path",{d:"M3,3V21H21V3H3M19,19H5V5H19V19Z"}),"torus"===e.id&&r.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"})]})})},e.id))})]}),d.length>0&&r.jsx("div",{className:"section-divider"}),d.length>0&&r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"라이브러리 메쉬"}),r.jsxs("div",{style:{display:"flex",gap:6,position:"absolute",top:6,right:6},children:[r.jsx("button",{className:"delete-btn",onClick:e=>_(mesh,e),title:"삭제",children:r.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})})}),r.jsx("button",{className:"delete-btn",onClick:e=>{e.stopPropagation(),g.current.downloadCustomMesh(mesh)},title:"내보내기",children:r.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M5,20H19V18H5M14,10V3H10V10H7L12,15L17,10H14Z"})})})]}),r.jsx("div",{className:"object-grid",children:d.map(e=>r.jsx("div",{className:"library-item library-mesh",draggable:!0,onDragStart:t=>S(t,e),onDragEnd:M,onClick:()=>O(e),title:`${e.name} (라이브러리)`,children:r.jsx("div",{className:"library-thumbnail",children:e.isLoadingThumbnail?r.jsx("div",{className:"thumbnail-loading",children:r.jsx("div",{className:"loading-spinner"})}):e.thumbnail?r.jsx("img",{src:e.thumbnail,alt:e.name,className:"thumbnail-image",onError:()=>C(e.id)}):r.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M12,2L2,7L12,12L22,7L12,2M2,17L12,22L22,17L20.84,16.47L12,21.17L3.16,16.47L2,17Z"})})})},e.id))})]}),r.jsx("div",{className:"section-divider"}),r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"커스텀 메쉬"}),r.jsx("div",{className:"object-grid",children:p.length>0?p.map(e=>r.jsxs("div",{className:"library-item custom-mesh",draggable:!0,onDragStart:t=>S(t,e),onDragEnd:M,onClick:()=>O(e),onContextMenu:t=>((e,t)=>{e.preventDefault(),e.stopPropagation(),w({open:!0,x:e.clientX,y:e.clientY,mesh:t})})(t,e),title:e.name,children:[r.jsxs("div",{className:"library-thumbnail",children:[r.jsx("img",{src:e.thumbnail,alt:e.name,width:"40",height:"40",onError:t=>{t.target.style.display="none",t.target.nextSibling.style.display="block",C(e.id)}}),r.jsx("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"currentColor",style:{display:"none"},children:r.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})})]}),r.jsx("button",{className:"delete-btn",onClick:t=>_(e,t),title:"삭제",children:r.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})})})]},e.id)):r.jsx("div",{className:"empty-library"})})]}),l.length>0&&r.jsx("div",{className:"section-divider"}),l.length>0&&r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"사용자 정의"}),r.jsx("div",{className:"object-grid",children:l.map(e=>r.jsxs("div",{className:"library-item custom-object",draggable:!0,onDragStart:t=>S(t,e),onDragEnd:M,onClick:()=>O(e),title:`${e.name} (사용자 정의)`,children:[r.jsx("div",{className:"library-thumbnail",children:e.thumbnail?r.jsx("img",{src:e.thumbnail,alt:e.name,style:{width:"24px",height:"24px",objectFit:"cover",borderRadius:"2px"}}):r.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M12,2L13.09,8.26L22,9L14.74,14.74L17.18,22L12,18.5L6.82,22L9.26,14.74L2,9L10.91,8.26L12,2Z"})})}),r.jsx("button",{className:"delete-btn",onClick:t=>((e,t)=>{if(t.stopPropagation(),window.confirm(`"${e.name}"을(를) 라이브러리에서 삭제하시겠습니까?`)){e.glbUrl&&URL.revokeObjectURL(e.glbUrl);const t=JSON.parse(localStorage.getItem("customObjects")||"[]").filter(t=>t.id!==e.id);localStorage.setItem("customObjects",JSON.stringify(t)),c(t)}})(e,t),title:"삭제",children:r.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]},e.id))})]})]}),x.open&&s.createPortal(r.jsx("div",{ref:j,className:"lib-context-menu",style:{left:x.x,top:x.y},children:r.jsx("button",{className:"ctx-item",onClick:async()=>{if(x.mesh)try{let e=x.mesh;if(!e.glbData&&e.id){const t=(await g.current.getCustomMeshes()).find(t=>t.id===e.id);t&&(e=t)}g.current.downloadCustomMesh(e);try{window.dispatchEvent(new CustomEvent("appToast",{detail:{message:"다운로드 시작",type:"success",duration:1500}}))}catch{}}catch(e){window.dispatchEvent(new CustomEvent("appToast",{detail:{message:"내보내기 실패",type:"error",duration:2500}}))}finally{w({open:!1,x:0,y:0,mesh:null})}},children:"GLB 내보내기"})}),document.body)]})},Cn=({onAssetDrop:e,onClose:t})=>r.jsxs("div",{className:"assets-panel",children:[r.jsxs("div",{className:"assets-header",children:[r.jsx("h3",{children:"기본 에셋"}),r.jsx("button",{className:"close-btn",onClick:t,children:r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]}),r.jsx("div",{className:"assets-content",children:r.jsx("div",{className:"assets-grid",children:[{id:"point_light",name:"포인트 라이트",type:"point_light",description:"점 조명"},{id:"spot_light",name:"스포트 라이트",type:"spot_light",description:"스포트 조명"},{id:"axes_helper",name:"축 헬퍼",type:"axes_helper",description:"XYZ 축 표시"}].map(t=>r.jsx("div",{className:"asset-item",draggable:!0,onDragStart:e=>((e,t)=>{const n=document.createElement("canvas");n.width=50,n.height=50;const r=n.getContext("2d");r.fillStyle="rgba(255, 165, 0, 0.8)",r.fillRect(0,0,50,50),r.fillStyle="white",r.font="12px Arial",r.textAlign="center",r.fillText(t.name.substring(0,6),25,20),r.fillText("Asset",25,35),e.dataTransfer.setDragImage(n,25,25),e.dataTransfer.setData("text/plain",JSON.stringify(t))})(e,t),onClick:()=>(t=>{e&&e(t,{x:0,y:0,z:0})})(t),title:`${t.name}: ${t.description}`,children:r.jsx("div",{className:"asset-name",children:t.name})},t.id))})})]}),Dn=({postProcessingManager:e,onClose:t})=>{const[s,i]=n.useState({}),[a,o]=n.useState("basic"),l=$t(e=>e.isPostProcessingEnabled),c=$t(e=>e.togglePostProcessingEnabled),d=$t(e=>e.postProcessingPreset),u=$t(e=>e.setPostProcessingPreset);n.useEffect(()=>{e&&i(e.getSettings())},[e]);const h=t=>{var n;if(!e)return;const r=!(null==(n=s[t])?void 0:n.enabled);e.setEffectEnabled(t,r),i(e=>({...e,[t]:{...e[t],enabled:r}}))},p=(t,n,r)=>{if(!e)return;const s={[n]:r};e.updateEffectSettings(t,s),i(e=>({...e,[t]:{...e[t],[n]:r}}))};return r.jsxs("div",{className:"post-processing-panel",children:[r.jsxs("div",{className:"panel-header",children:[r.jsx("h2",{children:"포스트프로세싱 효과"}),r.jsxs("label",{className:"checkbox-label",style:{marginLeft:"auto",marginRight:8},children:[r.jsx("input",{type:"checkbox",checked:l,onChange:c})," 전체 사용"]}),r.jsx("button",{className:"close-button",onClick:t,children:"×"})]}),!l&&r.jsx("div",{style:{background:"rgba(255, 194, 61, 0.12)",border:"1px solid rgba(255, 194, 61, 0.35)",color:"#b78200",padding:"8px 10px",borderRadius:6,margin:"8px 12px"},children:'포스트프로세싱이 꺼져 있어 효과가 화면에 보이지 않습니다. 상단의 "전체 사용"을 켜세요.'}),r.jsxs("div",{className:"panel-tabs",children:[r.jsx("button",{className:"tab-button "+("basic"===a?"active":""),onClick:()=>o("basic"),children:"기본"}),r.jsx("button",{className:"tab-button "+("color"===a?"active":""),onClick:()=>o("color"),children:"색상"}),r.jsx("button",{className:"tab-button "+("artistic"===a?"active":""),onClick:()=>o("artistic"),children:"아티스틱"})]}),r.jsxs("div",{className:"panel-content",children:["basic"===a&&r.jsxs("div",{className:"effect-group",children:[r.jsx("h3",{children:"기본 효과"}),r.jsx("div",{className:"effect-item",children:r.jsxs("div",{className:"effect-header",children:[r.jsx("label",{style:{color:"#ccc",fontSize:12,marginRight:8},children:"프리셋"}),r.jsxs("select",{value:d,onChange:t=>{var n;const r=t.target.value;u(r);try{null==(n=null==e?void 0:e.applyPreset)||n.call(e,r)}catch{}},children:[r.jsx("option",{value:"default",children:"Default"}),r.jsx("option",{value:"low",children:"Low"}),r.jsx("option",{value:"medium",children:"Medium"}),r.jsx("option",{value:"high",children:"High"})]})]})}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(m=s.bloom)?void 0:m.enabled)||!1,onChange:()=>h("bloom")}),"Bloom (발광)"]})}),(null==(g=s.bloom)?void 0:g.enabled)&&r.jsxs("div",{className:"effect-controls",children:[r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"강도:"}),r.jsx("input",{type:"range",min:"0",max:"3",step:"0.1",value:(null==(b=s.bloom)?void 0:b.strength)||1.5,onChange:e=>p("bloom","strength",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(f=s.bloom)?void 0:f.strength)||1.5})]}),r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"반경:"}),r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(y=s.bloom)?void 0:y.radius)||.4,onChange:e=>p("bloom","radius",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(v=s.bloom)?void 0:v.radius)||.4})]}),r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"임계값:"}),r.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:(null==(x=s.bloom)?void 0:x.threshold)||.85,onChange:e=>p("bloom","threshold",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(w=s.bloom)?void 0:w.threshold)||.85})]})]})]}),r.jsx("div",{className:"effect-item",children:r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(j=s.fxaa)?void 0:j.enabled)||!1,onChange:()=>h("fxaa")}),"FXAA (안티앨리어싱)"]})})}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(S=s.ssao)?void 0:S.enabled)||!1,onChange:()=>h("ssao")}),"SSAO (주변광 차폐)"]})}),(null==(M=s.ssao)?void 0:M.enabled)&&r.jsx("div",{className:"effect-controls",children:r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"커널 반경:"}),r.jsx("input",{type:"range",min:"1",max:"32",step:"1",value:(null==(O=s.ssao)?void 0:O.kernelRadius)||8,onChange:e=>p("ssao","kernelRadius",parseInt(e.target.value))}),r.jsx("span",{children:(null==(_=s.ssao)?void 0:_.kernelRadius)||8})]})})]}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:null==(D=null==(C=s.toneMapping)?void 0:C.enabled)||D,onChange:()=>h("toneMapping")}),"Tone Mapping (톤 매핑)"]})}),!1!==(null==(E=s.toneMapping)?void 0:E.enabled)&&r.jsxs("div",{className:"effect-controls",children:[r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"모드:"}),r.jsxs("select",{value:(null==(P=s.toneMapping)?void 0:P.mapping)||"ACESFilmic",onChange:e=>p("toneMapping","mapping",e.target.value),children:[r.jsx("option",{value:"None",children:"None"}),r.jsx("option",{value:"Linear",children:"Linear"}),r.jsx("option",{value:"Reinhard",children:"Reinhard"}),r.jsx("option",{value:"Cineon",children:"Cineon"}),r.jsx("option",{value:"ACESFilmic",children:"ACESFilmic"})]})]}),r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"노출:"}),r.jsx("input",{type:"range",min:"0.1",max:"4",step:"0.05",value:null!=(N=null==(z=s.toneMapping)?void 0:z.exposure)?N:1,onChange:e=>p("toneMapping","exposure",parseFloat(e.target.value))}),r.jsx("span",{children:null!=(k=null==(A=s.toneMapping)?void 0:A.exposure)?k:1})]})]})]})]}),"color"===a&&(()=>{var e,t,n,i,a,o,l,c,d,u,m,g,b,f,y,v,x,w,j,S,M,O,_,C,D,E,P,z;return r.jsxs("div",{className:"effect-group",children:[r.jsx("h3",{children:"색상 효과"}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(e=s.colorCorrection)?void 0:e.enabled)||!1,onChange:()=>h("colorCorrection")}),"Color Correction (색상 보정)"]})}),(null==(t=s.colorCorrection)?void 0:t.enabled)&&r.jsx("div",{className:"effect-controls",children:r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"Red Power:"}),r.jsx("input",{type:"range",min:"0.1",max:"4",step:"0.1",value:(null==(i=null==(n=s.colorCorrection)?void 0:n.powRGB)?void 0:i.x)||2,onChange:e=>p("colorCorrection","powRGB",{...s.colorCorrection.powRGB,x:parseFloat(e.target.value)})}),r.jsx("span",{children:(null==(o=null==(a=s.colorCorrection)?void 0:a.powRGB)?void 0:o.x)||2})]})})]}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(l=s.brightnessContrast)?void 0:l.enabled)||!1,onChange:()=>h("brightnessContrast")}),"Brightness/Contrast (밝기/대비)"]})}),(null==(c=s.brightnessContrast)?void 0:c.enabled)&&r.jsxs("div",{className:"effect-controls",children:[r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"밝기:"}),r.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:(null==(d=s.brightnessContrast)?void 0:d.brightness)||0,onChange:e=>p("brightnessContrast","brightness",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(u=s.brightnessContrast)?void 0:u.brightness)||0})]}),r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"대비:"}),r.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:(null==(m=s.brightnessContrast)?void 0:m.contrast)||0,onChange:e=>p("brightnessContrast","contrast",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(g=s.brightnessContrast)?void 0:g.contrast)||0})]})]})]}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(b=s.hueSaturation)?void 0:b.enabled)||!1,onChange:()=>h("hueSaturation")}),"Hue/Saturation (색조/채도)"]})}),(null==(f=s.hueSaturation)?void 0:f.enabled)&&r.jsxs("div",{className:"effect-controls",children:[r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"색조:"}),r.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:(null==(y=s.hueSaturation)?void 0:y.hue)||0,onChange:e=>p("hueSaturation","hue",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(v=s.hueSaturation)?void 0:v.hue)||0})]}),r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"채도:"}),r.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:(null==(x=s.hueSaturation)?void 0:x.saturation)||0,onChange:e=>p("hueSaturation","saturation",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(w=s.hueSaturation)?void 0:w.saturation)||0})]})]})]}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(j=s.sepia)?void 0:j.enabled)||!1,onChange:()=>h("sepia")}),"Sepia (세피아)"]})}),(null==(S=s.sepia)?void 0:S.enabled)&&r.jsx("div",{className:"effect-controls",children:r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"강도:"}),r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(M=s.sepia)?void 0:M.amount)||1,onChange:e=>p("sepia","amount",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(O=s.sepia)?void 0:O.amount)||1})]})})]}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(_=s.vignette)?void 0:_.enabled)||!1,onChange:()=>h("vignette")}),"Vignette (비네트)"]})}),(null==(C=s.vignette)?void 0:C.enabled)&&r.jsxs("div",{className:"effect-controls",children:[r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"오프셋:"}),r.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:(null==(D=s.vignette)?void 0:D.offset)||1,onChange:e=>p("vignette","offset",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(E=s.vignette)?void 0:E.offset)||1})]}),r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"어둠:"}),r.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:(null==(P=s.vignette)?void 0:P.darkness)||1,onChange:e=>p("vignette","darkness",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(z=s.vignette)?void 0:z.darkness)||1})]})]})]})]})})(),"artistic"===a&&(()=>{var e,t,n,i,a,o,l,c,d,u,m,g,b,f,y,v,x,w,j;return r.jsxs("div",{className:"effect-group",children:[r.jsx("h3",{children:"아티스틱 효과"}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(e=s.film)?void 0:e.enabled)||!1,onChange:()=>h("film")}),"Film (필름 효과)"]})}),(null==(t=s.film)?void 0:t.enabled)&&r.jsxs("div",{className:"effect-controls",children:[r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"노이즈:"}),r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(n=s.film)?void 0:n.noiseIntensity)||.5,onChange:e=>p("film","noiseIntensity",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(i=s.film)?void 0:i.noiseIntensity)||.5})]}),r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"스캔라인:"}),r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(a=s.film)?void 0:a.scanlinesIntensity)||.05,onChange:e=>p("film","scanlinesIntensity",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(o=s.film)?void 0:o.scanlinesIntensity)||.05})]}),r.jsx("div",{className:"control-row",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(l=s.film)?void 0:l.grayscale)||!1,onChange:e=>p("film","grayscale",e.target.checked)}),"흑백"]})})]})]}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(c=s.pixelate)?void 0:c.enabled)||!1,onChange:()=>h("pixelate")}),"Pixelate (픽셀화)"]})}),(null==(d=s.pixelate)?void 0:d.enabled)&&r.jsx("div",{className:"effect-controls",children:r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"픽셀 크기:"}),r.jsx("input",{type:"range",min:"2",max:"20",step:"1",value:(null==(u=s.pixelate)?void 0:u.pixelSize)||6,onChange:e=>p("pixelate","pixelSize",parseInt(e.target.value))}),r.jsx("span",{children:(null==(m=s.pixelate)?void 0:m.pixelSize)||6})]})})]}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(g=s.dotScreen)?void 0:g.enabled)||!1,onChange:()=>h("dotScreen")}),"Dot Screen (도트 스크린)"]})}),(null==(b=s.dotScreen)?void 0:b.enabled)&&r.jsx("div",{className:"effect-controls",children:r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"스케일:"}),r.jsx("input",{type:"range",min:"0.1",max:"2",step:"0.1",value:(null==(f=s.dotScreen)?void 0:f.scale)||1,onChange:e=>p("dotScreen","scale",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(y=s.dotScreen)?void 0:y.scale)||1})]})})]}),r.jsxs("div",{className:"effect-item",children:[r.jsx("div",{className:"effect-header",children:r.jsxs("label",{className:"checkbox-label",children:[r.jsx("input",{type:"checkbox",checked:(null==(v=s.glitch)?void 0:v.enabled)||!1,onChange:()=>h("glitch")}),"Glitch (글리치)"]})}),(null==(x=s.glitch)?void 0:x.enabled)&&r.jsx("div",{className:"effect-controls",children:r.jsxs("div",{className:"control-row",children:[r.jsx("label",{children:"강도:"}),r.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:(null==(w=s.glitch)?void 0:w.factor)||.1,onChange:e=>p("glitch","factor",parseFloat(e.target.value))}),r.jsx("span",{children:(null==(j=s.glitch)?void 0:j.factor)||.1})]})})]})]})})()]})]});var m,g,b,f,y,v,x,w,j,S,M,O,_,C,D,E,P,z,N,A,k};function En({scene:e,onClose:t}){const s=$t(e=>e.hdriSettings),i=$t(e=>e.updateHDRISettings),a=$t(e=>e.sunLightRef);$t(e=>e.setSunLightRef);const o=$t(e=>e.saveHDRISettings),l=$t(e=>e.renderer),[c,d]=n.useState(!1),[u,h]=n.useState(null),p=n.useRef(null),{currentHDRI:m,hdriIntensity:g,hdriRotation:b,sunLightEnabled:f,sunIntensity:y,timeOfDay:v,sunAzimuth:x,sunElevation:w,sunColor:j}=s,S=(e,t="info")=>{h({message:e,type:t}),setTimeout(()=>h(null),3e3)},M=async(t,n)=>{var r,s,a,o,c,d;if(!e)throw new Error("씬이 초기화되지 않았습니다");const u=new Promise((e,t)=>{setTimeout(()=>t(new Error("로드 시간 초과")),3e4)});try{const o=await Promise.race([O(t),u]);o.mapping=we,o.magFilter=je,o.minFilter=je,o.generateMipmaps=!1,o.matrixAutoUpdate=!0,null==(s=null==(r=o.center)?void 0:r.set)||s.call(r,.5,.5),o.needsUpdate=!0;try{(null==(a=null==m?void 0:m.envRT)?void 0:a.dispose)&&m.envRT.dispose()}catch{}try{(null==m?void 0:m.texture)&&m.texture!==o&&m.texture.dispose()}catch{}e.background=o;let c=null;if(l){const t=new xe(l);t.compileEquirectangularShader(),c=t.fromEquirectangular(o),t.dispose(),e.environment=c.texture}else e.environment=o;void 0!==e.backgroundIntensity&&(e.backgroundIntensity=g),void 0!==e.environmentIntensity&&(e.environmentIntensity=g),i({currentHDRI:{name:n,type:"hdr",url:t}})}catch(h){if(t.startsWith("blob:")&&URL.revokeObjectURL(t),h.message.includes("Bad File Format"))try{const r=await _(t);r.mapping=we,r.magFilter=je,r.minFilter=je,r.generateMipmaps=!1,r.matrixAutoUpdate=!0,null==(c=null==(o=r.center)?void 0:o.set)||c.call(o,.5,.5),r.needsUpdate=!0;try{(null==(d=null==m?void 0:m.envRT)?void 0:d.dispose)&&m.envRT.dispose()}catch{}try{(null==m?void 0:m.texture)&&m.texture.dispose()}catch{}e.background=r;let s=null;if(l){const t=new xe(l);t.compileEquirectangularShader(),s=t.fromEquirectangular(r),t.dispose(),e.environment=s.texture}else e.environment=r;return void i({currentHDRI:{name:n+" (폴백)",type:"hdr",url:t}})}catch(p){}throw h}},O=async e=>{const t=new Me;return new Promise((n,r)=>{t.load(e,e=>{e&&e.image?n(e):r(new Error("텍스처 데이터가 유효하지 않습니다"))},void 0,e=>{r(e)})})},_=async e=>{const t=new Se;return new Promise((n,r)=>{t.load(e,e=>{e&&e.image?n(e):r(new Error("폴백 텍스처 데이터가 유효하지 않습니다"))},void 0,e=>{r(e)})})},C=(e,t,n)=>{const r=t*Math.PI/180,s=n*Math.PI/180,i=Math.sin(r)*Math.cos(s)*100,a=100*Math.sin(s),o=Math.cos(r)*Math.cos(s)*100;e.position.set(i,a,o),e.lookAt(0,0,0)},D=e=>{i({timeOfDay:e}),a&&(e=>{let t="#ffffff";t=e>=5&&e<7?"#ff6b47":e>=7&&e<10?"#ffaa80":e>=10&&e<16?"#ffffff":e>=16&&e<18?"#ffcc99":e>=18&&e<20?"#ff8c66":"#4a6fa5",i({sunColor:t}),a&&a.color.setHex(t.replace("#","0x"))})(e)};return n.useEffect(()=>()=>{},[e]),n.useEffect(()=>{e&&setTimeout(()=>o(),100)},[s,e,o]),n.useEffect(()=>{var t,n;if(e&&m&&m.type&&m.texture&&"none"!==m.type){void 0!==e.backgroundIntensity&&(e.backgroundIntensity=g),void 0!==e.environmentIntensity&&(e.environmentIntensity=g);try{null==(n=null==(t=m.texture.center)?void 0:t.set)||n.call(t,.5,.5)}catch{}if(m.texture.rotation=b*Math.PI/180,m.texture.needsUpdate=!0,l)try{if(!m.envRT){const t=new xe(l);t.compileEquirectangularShader();const n=t.fromEquirectangular(m.texture);t.dispose(),e.environment=n.texture,i({currentHDRI:{...m,envRT:n}})}}catch{}}},[e,m,g,b,l]),r.jsxs("div",{className:"hdri-panel",children:[r.jsxs("div",{className:"hdri-header",children:[r.jsx("h3",{children:"HDRI 환경"}),r.jsxs("div",{className:"header-controls",children:[r.jsx("span",{className:"auto-save-indicator",title:"설정이 자동으로 저장됩니다",children:"💾"}),r.jsx("button",{className:"close-btn",onClick:t,children:r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"})})})]})]}),r.jsxs("div",{className:"hdri-content",children:[r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"현재 환경"}),r.jsx("div",{className:"current-hdri-display",children:m?r.jsx("span",{className:"hdri-name",children:m.name}):r.jsx("span",{className:"no-hdri",children:"환경 없음"})})]}),r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"환경맵 업로드"}),r.jsx("input",{type:"file",ref:p,onChange:async e=>{const t=e.target.files[0];if(!t)return;const n=[".hdr",".exr",".hdri"],r=[...n,".jpg",".jpeg",".png",".webp",".bmp"],s=t.name.toLowerCase().substring(t.name.lastIndexOf("."));if(!r.includes(s))return void S("지원하는 형식: HDRI(.hdr, .exr, .hdri) 또는 이미지(.jpg, .png, .webp)","error");if(t.size>209715200)return void S("파일 크기가 너무 큽니다 (최대 200MB)","error");if(t.size<100)return void S("파일이 너무 작습니다","error");const i=n.includes(s);if(i)try{const e=await t.slice(0,20).arrayBuffer(),n=new Uint8Array(e),r=String.fromCharCode(...n.slice(0,20));if(".hdr"===s){r.includes("#?RADIANCE")||r.includes("#?RGBE")||r.includes("RADIANCE")||35===n[0]||S("HDR 파일 형식이 표준과 다를 수 있습니다. 일반 이미지로 시도합니다.","info")}}catch(a){}else S("일반 이미지 파일을 환경맵으로 사용합니다","info");d(!0);try{const e=URL.createObjectURL(t);await M(e,t.name),S((i?"HDRI":"이미지")+" 환경이 로드되었습니다","success")}catch(o){let e="파일을 로드할 수 없습니다";o.message.includes("Bad File Format")?e="파일 형식을 읽을 수 없습니다. 다른 파일을 시도해보세요.":o.message.includes("network")?e="네트워크 오류로 파일을 로드할 수 없습니다":o.message.includes("로드 시간 초과")&&(e="파일 로드 시간이 초과되었습니다"),S(e,"error")}finally{d(!1),e.target.value=""}},accept:".hdr,.exr,.hdri,.jpg,.jpeg,.png,.webp,.bmp",style:{display:"none"}}),r.jsxs("button",{className:"hdri-upload-btn",onClick:()=>{var e;return null==(e=p.current)?void 0:e.click()},disabled:c,children:[r.jsx("div",{className:"upload-icon",children:r.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})})}),r.jsx("span",{children:c?"로딩중...":"파일 선택"})]}),r.jsx("div",{className:"upload-hint",children:".hdr, .exr, .hdri 지원"})]}),r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"기본 환경"}),r.jsx("div",{className:"hdri-grid",children:[{name:"컨트리 로드",type:"preset",url:"/hdr/sunny_country_road_2k.hdr",description:"햇살 좋은 시골길"},{name:"기본 스카이박스",type:"gradient",description:"그라디언트 스카이박스"},{name:"기본 배경",type:"none",description:"회색 배경"}].map((t,n)=>r.jsxs("div",{className:"hdri-item "+((null==m?void 0:m.name)===t.name?"active":""),onClick:()=>(async(t,n=null)=>{var r,s;if(e)switch(t){case"preset":if(n&&n.url)try{d(!0),await M(n.url,n.name),S(`${n.name} 환경이 적용되었습니다`,"success")}catch(a){S("프리셋 환경을 로드할 수 없습니다","error")}finally{d(!1)}break;case"gradient":e.background&&e.background.isTexture&&e.background.dispose();try{(null==(r=null==m?void 0:m.envRT)?void 0:r.dispose)&&m.envRT.dispose()}catch{}e.background=new P(8900331),e.environment=null,i({currentHDRI:{name:"기본 스카이박스",type:"gradient"}});break;case"none":e.background&&e.background.isTexture&&e.background.dispose();try{(null==(s=null==m?void 0:m.envRT)?void 0:s.dispose)&&m.envRT.dispose()}catch{}e.background=new P(2763306),e.environment=null,i({currentHDRI:{name:"기본 배경",type:"none"}})}})(t.type,t),title:t.description,children:[r.jsx("div",{className:"hdri-thumbnail",children:r.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:["preset"===t.type&&r.jsx("path",{d:"M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V10.5L17.5,9L16,10.5L14.5,9L11.5,12L9,9.5L7.5,11L6,9.5L5,10.5V5H19Z"}),"gradient"===t.type&&r.jsx("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"}),"none"===t.type&&r.jsx("path",{d:"M3,4H7V8H3V4M9,5V7H21V5H9M3,10H7V14H3V10M9,11V13H21V11H9M3,16H7V20H3V16M9,17V19H21V17H9"})]})}),r.jsx("div",{className:"hdri-label",children:t.name})]},n))})]}),m&&"none"!==m.type&&r.jsx("div",{className:"section-divider"}),m&&"none"!==m.type&&r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"환경 설정"}),r.jsxs("div",{className:"setting-item",children:[r.jsx("label",{children:"강도"}),r.jsxs("div",{className:"slider-container",children:[r.jsx("input",{type:"range",min:"0",max:"3",step:"0.1",value:g,onChange:t=>{return n=parseFloat(t.target.value),i({hdriIntensity:n}),void(e&&m&&m.texture&&"none"!==m.type&&(e.backgroundIntensity=n,e.environmentIntensity=n));var n},className:"hdri-slider"}),r.jsx("span",{className:"slider-value",children:g.toFixed(1)})]})]}),r.jsxs("div",{className:"setting-item",children:[r.jsx("label",{children:"회전"}),r.jsxs("div",{className:"slider-container",children:[r.jsx("input",{type:"range",min:"0",max:"360",step:"1",value:b,onChange:t=>(n=>{var r,s,a;if(i({hdriRotation:n}),e&&m&&m.texture&&"none"!==m.type){const o=n*Math.PI/180;try{null==(s=null==(r=m.texture.center)?void 0:r.set)||s.call(r,.5,.5)}catch{}if(m.texture.rotation=o,m.texture.needsUpdate=!0,l){try{(null==(a=m.envRT)?void 0:a.dispose)&&m.envRT.dispose()}catch{}try{const t=new xe(l);t.compileEquirectangularShader();const n=t.fromEquirectangular(m.texture);t.dispose(),e.environment=n.texture,i({currentHDRI:{...m,envRT:n}})}catch(t){e.environment=m.texture,i({currentHDRI:{...m,envRT:null}})}}else e.environment=m.texture}})(parseFloat(t.target.value)),className:"hdri-slider"}),r.jsxs("span",{className:"slider-value",children:[b,"°"]})]})]})]}),r.jsxs("div",{className:"category-section",children:[r.jsx("h4",{className:"category-title",children:"태양 조명"}),r.jsxs("div",{className:"setting-item",children:[r.jsx("label",{children:"활성화"}),r.jsx("input",{type:"checkbox",checked:f,onChange:e=>{return t=e.target.checked,void i({sunLightEnabled:t});var t},className:"setting-checkbox"})]}),f&&r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"setting-item",children:[r.jsx("label",{children:"시간"}),r.jsxs("div",{className:"slider-container",children:[r.jsx("input",{type:"range",min:"0",max:"24",step:"0.5",value:v,onChange:e=>D(Number(e.target.value)),className:"hdri-slider"}),r.jsxs("span",{className:"slider-value",children:[v,"시"]})]})]}),r.jsxs("div",{className:"setting-item",children:[r.jsx("label",{children:"강도"}),r.jsxs("div",{className:"slider-container",children:[r.jsx("input",{type:"range",min:"0",max:"20",step:"0.1",value:y,onChange:e=>{return t=Number(e.target.value),i({sunIntensity:t}),void(a&&(a.intensity=t));var t},className:"hdri-slider"}),r.jsx("span",{className:"slider-value",children:y})]})]}),r.jsxs("div",{className:"setting-item",children:[r.jsx("label",{children:"방위각"}),r.jsxs("div",{className:"slider-container",children:[r.jsx("input",{type:"range",min:"0",max:"360",step:"1",value:x,onChange:e=>{return t=Number(e.target.value),i({sunAzimuth:t}),void(a&&C(a,t,w));var t},className:"hdri-slider"}),r.jsxs("span",{className:"slider-value",children:[x,"°"]})]})]}),r.jsxs("div",{className:"setting-item",children:[r.jsx("label",{children:"고도각"}),r.jsxs("div",{className:"slider-container",children:[r.jsx("input",{type:"range",min:"0",max:"90",step:"1",value:w,onChange:e=>{return t=Number(e.target.value),i({sunElevation:t}),void(a&&C(a,x,t));var t},className:"hdri-slider"}),r.jsxs("span",{className:"slider-value",children:[w,"°"]})]})]}),r.jsxs("div",{className:"setting-item",children:[r.jsx("label",{children:"색상"}),r.jsx("div",{className:"color-preview",style:{backgroundColor:j,padding:"4px 8px",borderRadius:"4px",fontSize:"12px",textAlign:"center"},children:v<6||v>20?"밤":v<10?"아침":v<16?"낮":"저녁"})]})]})]})]}),u&&r.jsx("div",{className:`hdri-toast hdri-toast-${u.type}`,children:u.message})]})}const Pn=({x:e,y:t,isVisible:s,onClose:i,selectedObject:a,onAddToLibrary:o,onAddComment:l,hitInfo:c})=>{const d=n.useRef(null);if(n.useEffect(()=>{const e=e=>{d.current&&!d.current.contains(e.target)&&i()},t=e=>{"Escape"===e.key&&i()};if(s)return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[s,i]),!s)return null;const u=Math.min(e,window.innerWidth-200),h=Math.min(t,window.innerHeight-150);return r.jsxs("div",{ref:d,className:"context-menu",style:{left:u,top:h},children:[r.jsx("div",{className:"context-menu-header",children:r.jsx("span",{children:"메쉬 옵션"})}),r.jsxs("div",{className:"context-menu-items",children:[r.jsxs("button",{className:"context-menu-item "+(c?"":"disabled"),disabled:!c,onClick:()=>{c&&l&&l(c),i()},children:[r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M9,22V19H5A2,2 0 0,1 3,17V5A2,2 0 0,1 5,3H19A2,2 0 0,1 21,5V17A2,2 0 0,1 19,19H13L9,22M7,7V9H17V7H7M7,11V13H14V11H7Z"})}),r.jsx("span",{children:"코멘트"})]}),r.jsxs("button",{className:"context-menu-item",onClick:()=>{a&&o&&o(a),i()},children:[r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})}),r.jsx("span",{children:"라이브러리에 추가"})]}),r.jsxs("button",{className:"context-menu-item disabled",disabled:!0,children:[r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"})}),r.jsx("span",{children:"복제 (곧 제공)"})]}),r.jsxs("button",{className:"context-menu-item disabled",disabled:!0,children:[r.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})}),r.jsx("span",{children:"삭제 (곧 제공)"})]})]}),a&&r.jsx("div",{className:"context-menu-info",children:r.jsx("span",{className:"selected-object-name",children:a.name||"이름 없음"})})]})},zn=({message:e,type:t="info",isVisible:s,onClose:i})=>{if(n.useEffect(()=>{if(s){const e=setTimeout(()=>{i()},3e3);return()=>clearTimeout(e)}},[s,i]),!s)return null;return r.jsxs("div",{className:`toast toast-${t} ${s?"toast-visible":""}`,children:[r.jsx("div",{className:"toast-icon",children:(()=>{switch(t){case"success":return"✓";case"error":return"✕";case"warning":return"⚠";default:return"ℹ"}})()}),r.jsx("div",{className:"toast-message",children:e}),r.jsx("button",{className:"toast-close",onClick:i,children:"×"})]})};function Nn({editorControls:e,postProcessingManager:t,onAddToLibrary:s,showInspector:i,onToggleInspector:a}){const{selectedObject:o,transformMode:l,objects:c,walls:d,savedObjects:u,selectedIds:h,setSelectedIds:m,setParent:g,reorderSiblings:b,setTransformMode:f,addWall:v,addObject:x,removeObject:w,removeObjectById:j,addAsset:S,saveMap:M,loadMap:O,clearMap:_,toggleObjectVisibility:C,toggleObjectFreeze:D,renameObject:E,setSelectedObject:P,annotations:z,addAnnotation:N,removeAnnotation:A}=$t();$t(e=>e.viewReady),$t(e=>e.uiReady),$t(e=>e.envReady);const[k,L]=n.useState(""),[R,I]=n.useState(""),T=$t(e=>e.showLibrary),F=$t(e=>e.showAssets),G=$t(e=>e.showHDRI),B=$t(e=>e.isPostProcessingPanelOpen),H=$t(e=>e.setShowLibrary),U=$t(e=>e.setShowAssets),V=$t(e=>e.setShowHDRI),q=$t(e=>e.setIsPostProcessingPanelOpen),[W,K]=n.useState({isVisible:!1,x:0,y:0,hit:null}),[$,Z]=n.useState(0),[X,Y]=n.useState({message:"",type:"info",isVisible:!1});n.useEffect(()=>{const t=t=>{(t=>{var n,r,s;t.preventDefault();let i=null;try{if(e&&e.raycastMeshAtNDC){const a=null==(s=null==(r=null==(n=e.renderer)?void 0:n.domElement)?void 0:r.getBoundingClientRect)?void 0:s.call(r);if(a){const n=new y((t.clientX-a.left)/a.width*2-1,-(t.clientY-a.top)/a.height*2+1),r=e.raycastMeshAtNDC(n);r&&r.point&&(i={point:r.point.clone(),object:r.object})}}}catch{}K({isVisible:!0,x:t.clientX,y:t.clientY,hit:i})})(t.detail.originalEvent)};return window.addEventListener("editorContextMenu",t),()=>{window.removeEventListener("editorContextMenu",t)}},[o]);const Q=t=>{var n;if(!t)return e&&e.deselectAllObjects(),void P(null);if(e){const n=e.findObjectById(t.id);n&&e.selectObject(n)}P(null!=(n=null==t?void 0:t.id)?n:t)},J=n.useRef([]),ee=n.useRef(null),te=()=>{let e=document.querySelector(".annotation-layer");if(e||(e=document.createElement("div"),e.className="annotation-layer",Object.assign(e.style,{position:"fixed",left:0,top:0,width:"100vw",height:"100vh",pointerEvents:"none",zIndex:30}),document.body.appendChild(e)),!ee.current){let e=document.querySelector(".annotation-line-layer");e||(e=document.createElement("canvas"),e.className="annotation-line-layer",Object.assign(e.style,{position:"fixed",left:0,top:0,width:"100vw",height:"100vh",pointerEvents:"none",zIndex:29}),document.body.appendChild(e)),ee.current=e}return{layer:e,lineCanvas:ee.current}},ne=t=>{var n,r;const s=null==(r=null==(n=null==e?void 0:e.cameraController)?void 0:n.getCamera)?void 0:r.call(n),i=null==e?void 0:e.renderer;if(!s||!i)return null;const a=i.domElement.getBoundingClientRect(),o=t.clone().project(s);return{x:a.left+.5*(o.x+1)*a.width,y:a.top+(1-.5*(o.y+1))*a.height,z:o.z}},re=()=>{var t,n,r,s,i;const{lineCanvas:a}=te();if(!(null==(n=null==(t=null==e?void 0:e.cameraController)?void 0:t.getCamera)?void 0:n.call(t))||!(null==e?void 0:e.renderer))return;const o=a.getContext("2d"),l=a.width=window.innerWidth,c=a.height=window.innerHeight;o.clearRect(0,0,l,c),o.strokeStyle="rgba(255,255,255,0.9)",o.lineWidth=1.25,o.beginPath();const d=null==e?void 0:e.scene,u=[];for(const h of J.current){if((!h.targetObject||!h.targetObject.parent)&&h.ownerId&&(null==e?void 0:e.findObjectById))try{h.targetObject=e.findObjectById(h.ownerId)}catch{}let t=!1,n=h.targetObject;for(;n;){if(n===d){t=!0;break}n=n.parent}if(!h.targetObject||!t){try{(null==(r=h.el)?void 0:r.style)&&(h.el.style.display="none")}catch{}u.push(h);continue}try{null==(i=(s=h.targetObject).updateMatrixWorld)||i.call(s,!0)}catch{}const a=h.localPoint.clone();h.targetObject.localToWorld(a);const l=ne(a);if(!l){u.push(h);continue}const c=h.el,p=20,m=-20;c.style.left=`${Math.round(l.x+p)}px`,c.style.top=`${Math.round(l.y+m)}px`;try{c.style.display="block"}catch{}const g=c.getBoundingClientRect();o.moveTo(l.x,l.y),o.lineTo(g.left,g.top),u.push(h)}o.stroke(),J.current=u};n.useEffect(()=>{let e;const t=()=>{re(),e=requestAnimationFrame(t)};return e=requestAnimationFrame(t),()=>cancelAnimationFrame(e)},[e]);return n.useEffect(()=>{var t,n,r,s;const i=Array.isArray(z)?z:[],a=new Map(J.current.map(e=>[e.id,e])),o=new Set,{layer:l}=te();for(const d of i)if(o.add(d.id),a.has(d.id))try{a.get(d.id).el.querySelector(".annotation-text").textContent=String(d.text||"")}catch{}else{const i=document.createElement("div");i.className="annotation-box",i.innerHTML='<div class="annotation-text"></div><button class="annotation-close">✕</button>';i.querySelector(".annotation-text").textContent=String(d.text||""),Object.assign(i.style,{position:"fixed",minWidth:"180px",maxWidth:"260px",padding:"8px 10px",background:"rgba(0,0,0,0.66)",color:"#fff",border:"1px solid rgba(255,255,255,0.2)",borderRadius:"6px",boxShadow:"0 2px 8px rgba(0,0,0,0.35)",fontSize:"12px",lineHeight:"1.4",pointerEvents:"auto",display:"none"});const a=i.querySelector(".annotation-close");Object.assign(a.style,{position:"absolute",top:"4px",right:"6px",border:"none",background:"transparent",color:"#fff",cursor:"pointer"}),l.appendChild(i);const o=d.ownerId&&(null==e?void 0:e.findObjectById)?e.findObjectById(d.ownerId):null,c={id:d.id,ownerId:null!=(t=d.ownerId)?t:null,targetObject:o||null,localPoint:new p((null==(n=d.local)?void 0:n.x)||0,(null==(r=d.local)?void 0:r.y)||0,(null==(s=d.local)?void 0:s.z)||0),el:i},u=()=>{try{i.remove()}catch{}J.current=J.current.filter(e=>e.id!==d.id);try{null==A||A(d.id)}catch{}re()};a.addEventListener("click",u),J.current.push(c)}const c=[];for(const e of J.current)if(o.has(e.id))c.push(e);else try{e.el.remove()}catch{}J.current=c,re()},[z,e]),r.jsxs("div",{className:"editor-ui",children:[r.jsx("div",{className:"tool-panel",children:r.jsxs("div",{className:"tool-section",children:[r.jsx("button",{className:"tool-btn assets-btn "+(F?"active":""),onClick:()=>{const e=!F;U(e),e&&(T&&H(!1),B&&q(!1),G&&V(!1))},title:"기본 에셋",children:r.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M12,2L13.09,8.26L22,9L14.74,14.74L17.18,22L12,18.5L6.82,22L9.26,14.74L2,9L10.91,8.26L12,2Z"})})}),r.jsx("button",{className:"tool-btn library-btn "+(T?"active":""),onClick:()=>{const e=!T;H(e),e&&(F&&U(!1),B&&q(!1),G&&V(!1))},title:"라이브러리",children:r.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M4,6H20V8H4V6M4,11H20V13H4V11M4,16H20V18H4V16Z"})})}),r.jsx("button",{className:"tool-btn post-processing-btn "+(B?"active":""),onClick:()=>{const e=!B;q(e),e&&(T&&H(!1),F&&U(!1),G&&V(!1))},title:"포스트프로세싱 효과",children:r.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M9,12L11,14L15,10L20,15H4L9,12Z"})})}),r.jsx("button",{className:"tool-btn hdri-btn "+(G?"active":""),onClick:()=>{const e=!G;V(e),e&&(T&&H(!1),F&&U(!1),B&&q(!1))},title:"HDRI 환경",children:r.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2L14.39,5.42C13.65,5.15 12.84,5 12,5C11.16,5 10.35,5.15 9.61,5.42L12,2M3.34,7L7.5,6.65C6.9,7.16 6.36,7.78 5.94,8.5C5.5,9.24 5.25,10 5.11,10.79L3.34,7M3.36,17L5.12,13.23C5.26,14 5.53,14.78 5.95,15.5C6.37,16.24 6.91,16.86 7.5,17.37L3.36,17M20.65,7L18.88,10.79C18.74,10 18.47,9.23 18.05,8.5C17.63,7.78 17.1,7.15 16.5,6.64L20.65,7M20.64,17L16.5,17.36C17.09,16.85 17.62,16.22 18.04,15.5C18.46,14.77 18.73,14 18.87,13.21L20.64,17Z"})})}),B&&r.jsx(Dn,{postProcessingManager:t,onClose:()=>q(!1)})]})}),F&&r.jsx(Cn,{onAssetDrop:(e,t)=>{const n=e=>`${e||"obj"}_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;let r;switch(e.type){case"start_position":r={id:n(e.name||e.type),type:"start_position",name:e.name,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}};break;case"directional_light":r={id:n(e.name||e.type),type:"directional_light",name:e.name,position:t||{x:5,y:10,z:5},rotation:{x:-Math.PI/4,y:Math.PI/4,z:0},scale:{x:1,y:1,z:1},intensity:1,color:16777215,castShadow:!0};break;case"point_light":r={id:n(e.name||e.type),type:"point_light",name:e.name,position:t||{x:0,y:3,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},intensity:1,color:16777215,distance:10,decay:2};break;case"spot_light":r={id:n(e.name||e.type),type:"spot_light",name:e.name,position:t||{x:0,y:5,z:0},rotation:{x:-Math.PI/2,y:0,z:0},scale:{x:1,y:1,z:1},intensity:1,color:16777215,distance:10,angle:Math.PI/6,penumbra:.1};break;case"ambient_light":r={id:n(e.name||e.type),type:"ambient_light",name:e.name,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},intensity:.3,color:4210752};break;case"audio_source":r={id:n(e.name||e.type),type:"audio_source",name:e.name,position:t||{x:0,y:1,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},volume:1,loop:!1,autoplay:!1};break;default:r={id:n(e.name||e.type),type:e.type,name:e.name,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}}}x(r),setTimeout(()=>{P(r.id)},100)},onClose:()=>U(!1)}),T&&r.jsx(_n,{onObjectDrop:async(e,t)=>{const n=e=>`${e||"obj"}_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;let r;r="library"===e.type?{id:n(e.name||e.id||"library"),type:"glb",url:e.glbUrl,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:e.name}:"custom"===e.type?{id:n(e.name||e.id||"custom"),type:"glb",customMeshId:e.id,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:e.name||"Custom Mesh"}:{id:n(e.name||e.type),type:e.type||"basic",geometry:e.geometry,params:e.params,position:t||{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},name:e.name},x(r),setTimeout(()=>{P(r.id)},100)},onClose:()=>H(!1),forceRefresh:$}),G&&r.jsx(En,{scene:null==e?void 0:e.scene,onClose:()=>V(!1)}),r.jsx(Pn,{x:W.x,y:W.y,isVisible:W.isVisible,onClose:()=>{K({isVisible:!1,x:0,y:0,hit:null})},selectedObject:o,onAddToLibrary:s,onAddComment:t=>{const n=prompt("코멘트를 입력하세요:");if(!n)return;if(!(null==t?void 0:t.object)||!(null==t?void 0:t.point))return;const{rootId:r,rootObj:s}=(t=>{var n,r,s;let i=null,a=t;for(;a;){if(null==(n=a.userData)?void 0:n.id){i=a.userData.id;break}a=a.parent}i||(i=null!=(s=null==(r=t.userData)?void 0:r.ownerId)?s:null);return{rootId:i,rootObj:i&&(null==e?void 0:e.findObjectById)?e.findObjectById(i):null}})(t.object);if(!r||!s)return;const i=t.point.clone();try{s.worldToLocal(i)}catch{}const a=`ann_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;try{null==N||N({id:a,ownerId:r,text:n,local:{x:i.x,y:i.y,z:i.z}})}catch{}const{layer:o}=te(),l=document.createElement("div");l.className="annotation-box",l.innerHTML='<div class="annotation-text"></div><button class="annotation-close">✕</button>';l.querySelector(".annotation-text").textContent=n,Object.assign(l.style,{position:"fixed",minWidth:"180px",maxWidth:"260px",padding:"8px 10px",background:"rgba(0,0,0,0.66)",color:"#fff",border:"1px solid rgba(255,255,255,0.2)",borderRadius:"6px",boxShadow:"0 2px 8px rgba(0,0,0,0.35)",fontSize:"12px",lineHeight:"1.4",pointerEvents:"auto"});const c=l.querySelector(".annotation-close");Object.assign(c.style,{position:"absolute",top:"4px",right:"6px",border:"none",background:"transparent",color:"#fff",cursor:"pointer"}),o.appendChild(l),J.current.push({id:a,ownerId:r,targetObject:s,localPoint:i.clone(),el:l});c.addEventListener("click",()=>{try{l.remove()}catch{}J.current=J.current.filter(e=>e.id!==a);try{null==A||A(a)}catch{}re()}),re()},hitInfo:W.hit}),i&&r.jsx(On,{objects:c,walls:d,selectedIds:h,setSelectedIds:m,setParent:g,reorderSiblings:b,selectedObject:o,onObjectVisibilityToggle:e=>{C(e)},onObjectFreezeToggle:e=>{D(e)},onObjectSelect:Q,onObjectRemove:t=>{if(e&&e.objectSelector){if(e.objectSelector.transformControls)try{e.objectSelector.transformControls.detach()}catch(n){}try{const n=e.findObjectById(t.id);n&&e.objectSelector.removeSelectionOutline(n)}catch(n){}}if(o&&o.id===t.id){if(e)try{e.deselectAllObjects()}catch(n){}P(null)}setTimeout(()=>{try{null==j||j(null==t?void 0:t.id)}catch(n){}},50)},onObjectFocus:t=>{if(Q(t),e){const n=e.findObjectById(t.id);n&&e.focusOnObject(n)}},onObjectRename:(e,t)=>{if(E(e.id,t),(null==o?void 0:o.id)===e.id){const e={...o,name:t};P(e)}},onContextMenu:(e,t)=>{e.preventDefault(),Q(t),K({isVisible:!0,x:e.clientX,y:e.clientY})},editorControls:e,postProcessingManager:t,onObjectUpdate:t=>{if(e&&t.id){const n=e.findObjectById(t.id);n&&(t.position&&n.position.set(t.position.x,t.position.y,t.position.z),t.rotation&&n.rotation.set(t.rotation.x,t.rotation.y,t.rotation.z),t.scale&&n.scale.set(t.scale.x,t.scale.y,t.scale.z),t.name&&(n.name=t.name))}(null==o?void 0:o.id)===t.id&&P(t)},onClose:()=>a(!1)})]})}const An=({onMenuAction:e})=>{const[t,s]=n.useState(null),a=e=>{e.target.closest(".menu-bar")||s(null)};return i.useEffect(()=>(document.addEventListener("click",a),()=>{document.removeEventListener("click",a)}),[]),r.jsx("div",{className:"menu-bar",children:r.jsx("div",{className:"menu-items",children:[{title:"파일",items:[{label:"새 맵",action:"new-map",shortcut:"Ctrl+N"},{label:"불러오기",action:"load-map",shortcut:"Ctrl+O"},{label:"저장하기",action:"save-map",shortcut:"Ctrl+S"},{type:"separator"},{label:"임포트",action:"import"},{label:"익스포트",action:"export"},{type:"separator"},{label:"나가기",action:"exit",shortcut:"Alt+F4"}]},{title:"에디터",items:[{label:"실행 취소",action:"undo",shortcut:"Ctrl+Z"},{label:"다시 실행",action:"redo",shortcut:"Ctrl+Y"},{type:"separator"},{label:"복사",action:"copy",shortcut:"Ctrl+C"},{label:"붙여넣기",action:"paste",shortcut:"Ctrl+V"},{label:"삭제",action:"delete",shortcut:"Delete"},{type:"separator"},{label:"전체 선택",action:"select-all",shortcut:"Ctrl+A"},{label:"선택 해제",action:"deselect-all",shortcut:"Ctrl+D"}]},{title:"윈도우",items:[{label:"뷰포트 리셋",action:"reset-viewport"},{label:"카메라 리셋",action:"reset-camera"},{type:"separator"},{label:"그리드 토글",action:"toggle-grid"},{label:"통계 표시",action:"toggle-stats"},{type:"separator"},{label:"인스펙터",action:"toggle-inspector",shortcut:"I"},{type:"separator"},{label:"전체화면",action:"fullscreen",shortcut:"F11"}]},{title:"정보",items:[{label:"단축키",action:"show-shortcuts"},{label:"도움말",action:"show-help",shortcut:"F1"},{type:"separator"},{label:"프로그램 정보",action:"about"}]}].map((n,i)=>r.jsxs("div",{className:"menu-item "+(t===i?"active":""),onClick:()=>{var e;s(t===(e=i)?null:e)},children:[r.jsx("span",{className:"menu-title",children:n.title}),t===i&&r.jsx("div",{className:"dropdown-menu",children:n.items.map((t,n)=>"separator"===t.type?r.jsx("div",{className:"menu-separator"},n):r.jsxs("div",{className:"dropdown-item",onClick:n=>{var r;n.stopPropagation(),r=t.action,s(null),e&&e(r)},children:[r.jsx("span",{className:"item-label",children:t.label}),t.shortcut&&r.jsx("span",{className:"item-shortcut",children:t.shortcut})]},n))})]},i))})})};function kn({editorControls:e}){var t;const{isWireframe:s,isGridSnap:i,isGridVisible:a,gizmoSpace:o,gizmoSize:l,snapMove:c,snapRotateDeg:d,snapScale:u,cameraPanSpeed:h,cameraOrbitSpeed:p,cameraZoomSpeed:m,toggleWireframe:g,toggleGridSnap:b,toggleGridVisible:f,toggleGizmoSpace:y,setGizmoSize:v,setSnapMove:x,setSnapRotateDeg:w,setSnapScale:j,setCameraPanSpeed:S,setCameraOrbitSpeed:M,setCameraZoomSpeed:O}=$t(),_=$t(e=>e.isViewGizmoSettingsOpen),C=$t(e=>e.setIsViewGizmoSettingsOpen),D=$t(e=>e.isPostProcessingEnabled),E=$t(e=>e.togglePostProcessingEnabled),P=$t(e=>e.safeMode),z=$t(e=>e.toggleSafeMode),N=$t(e=>e.setSafeModePixelRatio),A=(e,t=80)=>{let n;return(...r)=>{n&&clearTimeout(n),n=setTimeout(()=>e(...r),t)}},k=n.useMemo(()=>A(()=>{var t;try{null==(t=null==e?void 0:e.updateWireframe)||t.call(e)}catch{}},80),[e]),L=n.useMemo(()=>A(()=>{var t;try{null==(t=null==e?void 0:e.updateGridSnap)||t.call(e)}catch{}},80),[e]),R=n.useMemo(()=>A(()=>{var t,n;try{null==(n=null==(t=null==e?void 0:e.objectSelector)?void 0:t.updateGizmoSize)||n.call(t)}catch{}},80),[e]),I=_;return n.useEffect(()=>{R()},[R,l]),n.useEffect(()=>{L()},[L,c,d,u,i]),n.useEffect(()=>{var t,n,r,s,i;if(e){try{null==(t=e.updateWireframe)||t.call(e)}catch{}try{null==(n=e.updateGridSnap)||n.call(e)}catch{}try{null==(r=e.updateGizmoSpace)||r.call(e)}catch{}try{null==(i=null==(s=e.objectSelector)?void 0:s.updateGizmoSize)||i.call(s)}catch{}}},[e]),r.jsxs("div",{className:"viewport-controls",children:[r.jsx("button",{className:"viewport-control-btn "+(a?"active":""),onClick:()=>{var t;f();try{null==(t=null==e?void 0:e.toggleGrid)||t.call(e)}catch{}},title:"그리드 표시/숨기기",children:r.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M3 3h18v18H3z"}),r.jsx("path",{d:"M8 3v18"}),r.jsx("path",{d:"M13 3v18"}),r.jsx("path",{d:"M18 3v18"}),r.jsx("path",{d:"M3 8h18"}),r.jsx("path",{d:"M3 13h18"}),r.jsx("path",{d:"M3 18h18"})]})}),r.jsx("button",{className:"viewport-control-btn "+("local"===o?"active":""),onClick:()=>{var t;y();try{null==(t=null==e?void 0:e.updateGizmoSpace)||t.call(e)}catch{}},title:`기즈모 좌표계 (${"world"===o?"월드":"로컬"})`,children:r.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:"world"===o?r.jsxs(r.Fragment,{children:[r.jsx("circle",{cx:"12",cy:"12",r:"9"}),r.jsx("path",{d:"M12 3v18"}),r.jsx("path",{d:"M3 12h18"}),r.jsx("path",{d:"M8 8l8 8"}),r.jsx("path",{d:"M16 8l-8 8"})]}):r.jsxs(r.Fragment,{children:[r.jsx("rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}),r.jsx("path",{d:"M12 4v16"}),r.jsx("path",{d:"M4 12h16"}),r.jsx("circle",{cx:"12",cy:"12",r:"2"})]})})}),r.jsx("button",{className:"viewport-control-btn "+(I?"active":""),onClick:()=>C(!_),title:"뷰/기즈모 설정",children:r.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M12 1v22"}),r.jsx("path",{d:"M5 5h14"}),r.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}),I&&r.jsxs("div",{className:"viewport-settings-pop",children:[r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"포스트프로세싱"}),r.jsx("input",{type:"checkbox",checked:D,onChange:E})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"안전모드"}),r.jsx("input",{type:"checkbox",checked:!!(null==P?void 0:P.enabled),onChange:()=>z()})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"픽셀 비율"}),r.jsx("input",{type:"number",min:"0.5",max:"2",step:"0.05",value:Number(null!=(t=null==P?void 0:P.pixelRatio)?t:1).toFixed(2),disabled:!(null==P?void 0:P.enabled),onChange:e=>N(parseFloat(e.target.value))})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"와이어프레임"}),r.jsx("input",{type:"checkbox",checked:s,onChange:()=>{g(),k()}})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"그리드 스냅"}),r.jsx("input",{type:"checkbox",checked:i,onChange:()=>{b(),L()}})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"기즈모 크기"}),r.jsx("input",{type:"range",min:"0.1",max:"3",step:"0.1",value:l,onChange:e=>v(e.target.value)}),r.jsx("span",{children:Number(l).toFixed(1)})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"이동 스냅"}),r.jsx("input",{type:"number",step:"0.1",value:c,onChange:e=>x(e.target.value)})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"회전 스냅(도)"}),r.jsx("input",{type:"number",step:"1",value:d,onChange:e=>w(e.target.value)})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{children:"크기 스냅"}),r.jsx("input",{type:"number",step:"0.01",value:u,onChange:e=>j(e.target.value)})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{style:{opacity:.8},children:"카메라 Pan"}),r.jsx("input",{type:"number",step:"1",value:h,onChange:e=>S(e.target.value)})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{style:{opacity:.8},children:"카메라 Orbit"}),r.jsx("input",{type:"number",step:"1",value:p,onChange:e=>M(e.target.value)})]}),r.jsxs("div",{className:"row",children:[r.jsx("label",{style:{opacity:.8},children:"카메라 Zoom"}),r.jsx("input",{type:"number",step:"0.05",value:m,onChange:e=>O(e.target.value)})]}),r.jsx("div",{className:"hint",children:"스냅은 그리드 스냅이 활성화되어야 적용됩니다."})]})]})}export{Nn as E,xn as G,An as M,wn as P,zn as T,kn as V,Ee as _,_e as g,Bt as i,$t as u};
